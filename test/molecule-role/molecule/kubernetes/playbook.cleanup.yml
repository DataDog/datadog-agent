---
- name: Prepare Connection
  hosts: localhost
  connection: local
  gather_facts: true
  tasks:
    - include_tasks: ../common/prepare/keypair.yml

- name: Cleanup EKS cluster
  hosts: kubernetes-cluster-agent
  ignore_errors: true
  ignore_unreachable: true
  gather_facts: false
  tasks:
    - name: Delete namespace '{{namespace}}'
      ignore_errors: true
      shell: "kubectl delete ns {{ namespace }}"
      environment:
        KUBECONFIG: /home/ubuntu/deployment/aws-eks/tf-cluster/kubeconfig

    - name: Delete namespace test-global-lock
      ignore_errors: true
      shell: "kubectl delete ns test-global-lock --force"
      environment:
        KUBECONFIG: /home/ubuntu/deployment/aws-eks/tf-cluster/kubeconfig

    - name: Delete manifests for stackstate node agent and cluster agent
      command: kubectl delete -k overlays
      args:
        chdir: /home/ubuntu/deployment/agents
      environment:
        KUBECONFIG: /home/ubuntu/deployment/aws-eks/tf-cluster/kubeconfig
