---
- name: Cleanup EKS cluster
  hosts: kubernetes-cluster-agent
  ignore_errors: true
  ignore_unreachable: true
  gather_facts: false
  tasks:
    - name: Delete namespace '{{namespace}}' and global lock if we took it
      shell: "if kubectl delete ns {{ namespace }}; then kubectl delete ns test-global-lock; fi"
      environment:
        KUBECONFIG: /home/ubuntu/deployment/aws-eks/tf-cluster/kubeconfig
    - name: Delete manifests for stackstate node agent and cluster agent
      command: kubectl delete -k overlays
      args:
        chdir: /home/ubuntu/deployment/agents
      environment:
        KUBECONFIG: /home/ubuntu/deployment/aws-eks/tf-cluster/kubeconfig
