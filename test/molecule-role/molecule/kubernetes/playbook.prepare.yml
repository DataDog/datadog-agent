---
- name: Prepare Connection
  hosts: localhost
  connection: local
  gather_facts: true
  tasks:
    - include_tasks: ../common/prepare/keypair.yml

- name: Prepare Receiver and EKS cluster
  hosts: kubernetes-cluster-agent
  gather_facts: true
  tasks:
    - include_tasks: ../common/prepare/ubuntu18-automatic-updates.yml
    - include_tasks: ../common/prepare/install-provisioning-dependencies.yml
    - include_tasks: ../common/prepare/configure-aws-credentials.yml
    - include_tasks: ../common/prepare/docker-login.yml
    - include_tasks: ../common/prepare/copy-terraform-files-and-manifests.yml
    - include_tasks: ../common/prepare/copy-receiver-files.yml
    - include_tasks: ../common/prepare/copy-receiver-verify-and-create-script-file.yml
    - include_tasks: ../common/prepare/generate-env-token.yml

    - name: Delete namespace '{{namespace}}' and global lock if we took it
      ignore_errors: yes
      shell: kubectl delete ns test-global-lock
      environment:
        KUBECONFIG: /home/ubuntu/deployment/aws-eks/tf-cluster/kubeconfig

    - name: Delete manifests for stackstate node agent and cluster agent
      ignore_errors: yes
      command: kubectl delete -k overlays
      args:
        chdir: /home/ubuntu/deployment/agents
      environment:
        KUBECONFIG: /home/ubuntu/deployment/aws-eks/tf-cluster/kubeconfig

    - name: Kustomization template
      template:
        src: files/template/kustomization.yaml
        dest: /home/ubuntu/deployment/agents/overlays

    - name: Kustomization original template
      template:
        src: files/template/kustomization.yaml
        dest: /home/ubuntu/overlays-original

    - name: Configure .env file used by docker-compose
      copy:
        content: |
          STACKSTATE_BRANCH={{ stackstate_branch }}
          CLUSTER_NAME={{ cluster_name }}
        dest: /home/ubuntu/receiver/.env

    - include_tasks: ../common/prepare/docker-compose-pull-receiver.yml
