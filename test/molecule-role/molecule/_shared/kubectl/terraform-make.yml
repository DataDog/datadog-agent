---
- name: Run make plan
  make:
    chdir: /home/ubuntu/deployment/aws-eks/tf-cluster
    target: plan
  environment:
    AWS_ACCESS_KEY_ID: '{{lookup("env", "AWS_ACCESS_KEY_ID")}}'
    AWS_SECRET_ACCESS_KEY: '{{lookup("env", "AWS_SECRET_ACCESS_KEY")}}'
    TF_VAR_AWS_SECRET_ACCESS_KEY: '{{lookup("env", "AWS_SECRET_ACCESS_KEY")}}'
    TF_VAR_AWS_ACCESS_KEY_ID: '{{lookup("env", "AWS_ACCESS_KEY_ID")}}'
    TF_VAR_SCALING_DESIRED_CAPACITY: 2
    TF_VAR_AWS_REGION: eu-west-1
    TF_VAR_CLUSTER_NAME: "{{ cluster_name }}"

- name: Run make apply
  make:
    chdir: /home/ubuntu/deployment/aws-eks/tf-cluster
    target: apply

- name: Run make kubeconfig
  make:
    chdir: /home/ubuntu/deployment/aws-eks/tf-cluster
    target: kubeconfig

- name: Run make config-map-aws-auth
  make:
    chdir: /home/ubuntu/deployment/aws-eks/tf-cluster
    target: config-map-aws-auth
  environment:
    KUBECONFIG: /home/ubuntu/deployment/aws-eks/tf-cluster/kubeconfig
