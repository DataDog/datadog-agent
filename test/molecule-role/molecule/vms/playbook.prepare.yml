---
- name: Prepare Connection
  hosts: localhost
  connection: local
  gather_facts: true
  tasks:
    - include_tasks: ../common/prepare/keypair.yml
    - include_tasks: ../common/create/wait-for-boot-process-to-finish.yml

- name: Prepare Linux Agents (pre)
  hosts: agent_linux_vm
  gather_facts: false
  tasks:
    - include_tasks: ../common/create/wait-for-boot-process-to-finish.yml

- name: Prepare Network Connection Namespaces VM (pre)
  hosts: agent-connection-namespaces
  gather_facts: false
  tasks:
    - include_tasks: ../common/create/wait-for-boot-process-to-finish.yml

- name: Prepare Windows Agent (pre)
  hosts: agent_win_vm
  gather_facts: false
  tasks:
    - include_tasks: ../common/create/wait-for-boot-process-to-finish.yml

- name: Prepare Ubuntu Agent listening before start
  hosts: agent-ubuntu
  gather_facts: false
  tasks:
    - include_tasks: ../common/create/wait-for-boot-process-to-finish.yml

- name: Prepare Fedora Agent connecting before start
  hosts: agent-fedora
  gather_facts: false
  tasks:
    - include_tasks: ../common/create/wait-for-boot-process-to-finish.yml

- name: Prepare Windows Agent connecting before start
  hosts: agent-win
  gather_facts: false
  tasks:
    - include_tasks: ../common/create/wait-for-boot-process-to-finish.yml

- name: Prepare Receiver
  hosts: receiver_vm
  gather_facts: false
  tasks:
    - include_tasks: ../common/prepare/ubuntu18-automatic-updates.yml
    - include_tasks: ../common/prepare/install-provisioning-dependencies.yml
    - include_tasks: ../common/prepare/configure-aws-credentials.yml
    - include_tasks: ../common/prepare/docker-login.yml

    - name: Copy Receiver files
      copy:
        src: "files/receiver/"
        dest: "/home/ubuntu/"

    - name: Copy Verify and Create Script file
      copy:
        src: ./../verify-or-create-topics.sh
        dest: /home/ubuntu
        mode: u+x

    - name: Configure .env file used by docker-compose
      copy:
        content: |
          STACKSTATE_BRANCH={{ stackstate_branch }}
        dest: /home/ubuntu/.env
    - include_tasks: ../common/create/wait-for-boot-process-to-finish.yml

- name: Prepare Connection
  hosts: localhost
  connection: local
  gather_facts: true
  tasks:
    - include_tasks: ../common/prepare/encrypt-key.yml
