---
- name: Prepare Connection
  hosts: localhost
  connection: local
  gather_facts: true
  tasks:
    - include_tasks: ../common/prepare/keypair.yml
    - include_tasks: ../common/create/wait-for-boot-process-to-finish.yml

- name: Prepare Linux Agents
  hosts: agent_linux_vm
  gather_facts: false
  tasks:
    - include_tasks: ../common/prepare/gather-facts.yml

    - name: Install stackstate-agent
      shell: "curl -o- {{ agent_repo_url }}/install.sh | bash"
      register: agent_install_result
      until: agent_install_result is not failed
      retries: 5
      delay: 60
      environment:
        STS_API_KEY: "API_KEY"
        STS_URL: "https://test-stackstate-agent.sts/stsAgent"
        STS_HOSTNAME: "{{ inventory_hostname }}"
        CODE_NAME: "{{ agent_current_branch }}"
        SKIP_SSL_VALIDATION: "true"

    - name: Install secret backend provider
      template:
        src: templates/dummy_secret_feeder.sh.j2
        dest: /etc/stackstate-agent/dummy_secret_feeder.sh
        mode: "u=rwx,g=,o="
        owner: "stackstate-agent"
        group: "root"
      become: yes

    - name: Apply secrets backend file
      lineinfile:
        dest: /etc/stackstate-agent/stackstate.yaml
        regexp: '^api_key:(.*)$'
        line: 'api_key: "ENC[api_key]"'
        insertbefore: BOF
      become: yes

    - name: Apply secrets backend file
      lineinfile:
        dest: /etc/stackstate-agent/stackstate.yaml
        regexp: '^secret_backend_command: (.*)$'
        line: 'secret_backend_command: /etc/stackstate-agent/dummy_secret_feeder.sh'
        insertbefore: BOF
      become: yes

    - name: Template secret check
      template:
        src: templates/dummy_check.py.j2
        dest: /etc/stackstate-agent/checks.d/dummy_check.py
        mode: "u=rwx,g=,o="
        owner: "stackstate-agent"
        group: "root"
      become: yes

    - name: Template secret check config
      template:
        src: templates/dummy_check.yml.j2
        dest: /etc/stackstate-agent/conf.d/dummy_check.yml
        mode: "u=rwx,g=,o="
        owner: "stackstate-agent"
        group: "root"
      become: yes

    - name: Perform stackstate-agent restart
      service: name="stackstate-agent" state="restarted"
      become: yes

    - name: Perform stackstate-agent restart
      service: name="stackstate-agent-process" state="restarted"
      become: yes

    - name: Perform stackstate-agent restart
      service: name="stackstate-agent-trace" state="restarted"
      become: yes

- name: Prepare Connection
  hosts: localhost
  connection: local
  gather_facts: true
  tasks:
    - include_tasks: ../common/prepare/encrypt-key.yml
