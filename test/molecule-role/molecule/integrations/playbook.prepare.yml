---
- name: Prepare Connection
  hosts: localhost
  connection: local
  gather_facts: true
  tasks:
    - include_tasks: ../common/prepare/keypair.yml

- name: Prepare Integrations and Dependencies
  hosts: agent-integrations
  gather_facts: false
  tasks:
    - include_tasks: ../common/prepare/install-provisioning-dependencies.yml
    - include_tasks: ../common/prepare/docker-login.yml
    - include_tasks: ../common/prepare/copy-docker-compose-file.yml
    - include_tasks: ../common/prepare/copy-verify-and-create-script-file.yml

    - name: Copy nagios files
      copy:
        src: files/nagios/{{item}}
        dest: /home/ubuntu/nagios/
        mode: preserve
      with_items:
        - Dockerfile
        - mysql.cfg
        - nagios.cfg

    - name: Copy nagios config files
      copy:
        src: files/agent/nagios.d/conf.yaml
        dest: /home/ubuntu/agent/nagios.d/
        mode: preserve


    - name: Copy agent integration config files
      copy:
        src: files/agent/agent_integration_sample.d/conf.yaml
        dest: /home/ubuntu/agent/agent_integration_sample.d/
        mode: preserve

    - name: Gather facts (we need the docker network interface ip)
      setup:

    - name: Configure .env file used by docker-compose
      copy:
        content: |
          AGENT_DOCKER_REPO={{ agent_docker_repo }}
          AGENT_VERSION={{ agent_current_branch }}
          STACKSTATE_BRANCH={{ stackstate_branch }}
        dest: /home/ubuntu/.env

- name: Prepare Connection
  hosts: localhost
  connection: local
  gather_facts: true
  tasks:
    - include_tasks: ../common/prepare/encrypt-key.yml
