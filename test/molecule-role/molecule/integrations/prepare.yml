---
- name: Prepare Integrations and Dependencies
  hosts: agent-integrations-mysql
  gather_facts: false
  vars_files:
    - common_vars.yml
  tasks:
    - name: Install provisioning dependencies (1/2)
      apt:
        name:
          python3-pip
        state: present
      become: yes
      register: pip3_res
      retries: 15
      delay: 5
      until: pip3_res is success
    - name: Install provisioning dependencies (2/2)
      shell: pip3 install docker
      become: yes
    - name: Docker login
      docker_login:
        registry: quay.io
        username: "{{ quay_user }}"
        password: "{{ quay_password }}"
        reauthorize: yes
    - name: Copy docker compose file
      copy:
        src: files/docker-compose.yml
        dest: /home/ubuntu/
        mode: preserve
    - name: Copy nagios files
      copy:
        src: files/nagios/{{item}}
        dest: /home/ubuntu/nagios/
        mode: preserve
      with_items:
        - Dockerfile
        - mysql.cfg
        - nagios.cfg
    - name: Copy nagios config files
      copy:
        src: files/agent/nagios.d/conf.yaml
        dest: /home/ubuntu/agent/nagios.d/
        mode: preserve
    - name: Copy agent integration config files
      copy:
        src: files/agent/agent_integration_sample.d/conf.yaml
        dest: /home/ubuntu/agent/agent_integration_sample.d/
        mode: preserve
    - name: Gather facts (we need the docker network interface ip)
      setup:
    - name: Run Docker compose
      command: docker-compose up -d
      args:
        chdir: /home/ubuntu/
      environment:
        AGENT_VERSION: "{{ agent_current_branch }}"
        DOCKER_HOST_IP: "{{ ansible_docker0['ipv4']['address'] }}"
        STACKSTATE_BRANCH: "{{ stackstate_branch }}"
