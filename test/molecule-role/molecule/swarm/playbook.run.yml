---
- name: Prepare Connection
  hosts: localhost
  connection: local
  gather_facts: true
  tasks:
    - include_tasks: ../common/prepare/keypair.yml
    - include_tasks: ../common/create/wait-for-boot-process-to-finish.yml

- name: Create global service on Master
  hosts: swarm_master_vm
  gather_facts: true
  tasks:
    - name: Create StacSktate Agent Service on Master
      command: docker stack deploy -c docker-compose.yml --with-registry-auth agent
      args:
        chdir: /home/ubuntu/
      environment:
        AGENT_VERSION: "{{ agent_current_branch }}"
        STACKSTATE_BRANCH: "{{ stackstate_branch }}"
      register: output

    - debug: var=output

    - include_tasks: ../common/prepare/wait-for-receiver.yml

    - name: Wait for agent to be healthy (swarm stack)
      shell: docker stack ps agent | grep 'stackstate-agent' | grep Running
      register: agent_healthy
      until: agent_healthy.rc == 0
      retries: 20
      delay: 5
      changed_when: false

# - name: Prepare Connection
#   hosts: localhost
#   connection: local
#   gather_facts: true
#   tasks:
#     - include_tasks: ../common/prepare/encrypt-key.yml
