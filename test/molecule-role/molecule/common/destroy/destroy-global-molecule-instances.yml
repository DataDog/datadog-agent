---
- name: "Gather existing EC2 instances for the branch '{{ agent_current_branch }}'"
  ec2_instance_info:
    minimum_uptime: 60
    filters:
      instance-state-name: [ "running" ]
      "tag:ci_sts_major_python_version": "{{ ci_sts_major_python_version }}"
      "tag:molecule_scenario_name": "{{ molecule_scenario_name }}"
  register: global_instances

- name: Destroy molecule instance(s)
  ec2_instance:
    state: absent
    instance_ids: "{{ item.instance_id }}"
  register: global_instances_server
  with_items: "{{ global_instances.instances }}"
  async: 7200
  poll: 0

- name: Wait for instance(s) deletion to complete
  async_status:
    jid: "{{ item.ansible_job_id }}"
  register: ec2_jobs
  until: ec2_jobs.finished
  retries: 300
  with_items: "{{ global_instances_server.results }}"
