---
- name: "Gather existing EC2 instances for the branch '{{ agent_current_branch }}'"
  ec2_instance_info:
    filters:
      instance-state-name: [ "running" ]
      "tag:ci_sts_major_python_version": "{{ ci_sts_major_python_version }}"
      "tag:agent_current_branch": "{{ agent_current_branch }}"
      "tag:molecule_scenario_name": "{{ molecule_scenario_name }}"
      "tag:molecule_run_id": "{{ molecule_run_id }}"
  register: own_instances

- name: Destroy molecule instance(s)
  ec2_instance:
    state: absent
    instance_ids: "{{ item.instance_id }}"
  register: own_instances_server
  with_items: "{{ own_instances.instances }}"
  async: 7200
  poll: 0

- name: Wait for instance(s) deletion to complete
  async_status:
    jid: "{{ item.ansible_job_id }}"
  register: ec2_jobs
  until: ec2_jobs.finished
  retries: 300
  with_items: "{{ own_instances_server.results }}"
