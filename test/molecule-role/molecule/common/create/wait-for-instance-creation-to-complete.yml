---
- name: Wait for instance(s) creation to complete
  async_status:
    jid: "{{ item.ansible_job_id }}"
  register: "ec2_jobs"
  until: "ec2_jobs.finished"
  retries: 300
  with_items: "{{ server.results }}"

- name: Populate instance config dict
  set_fact:
    instance_conf_dict: {
      'instance': "{{ item.instances[0].tags.instance }}",
      'address': "{{ item.instances[0].public_ip_address }}",
      'private_address': "{{ item.instances[0].private_ip_address }}",
      'user': "{{ item.item.item.ssh_user }}",
      'port': "{{ ssh_port }}",
      'identity_file': "{{ keypair_path }}",
      'instance_ids': "{{ item.instance_ids }}", }
  with_items: "{{ ec2_jobs.results }}"
  register: "instance_config_dict"
  when: server.changed | bool

- name: Convert instance config dict to a list
  set_fact:
    instance_conf: "{{ instance_config_dict.results | map(attribute='ansible_facts.instance_conf_dict') | list }}"
  when: server.changed | bool

- name: Dump instance config
  copy:
    content: "{{ instance_conf | to_json | from_json | molecule_to_yaml | molecule_header }}"
    dest: "{{ molecule_instance_config }}"
  when: server.changed | bool
