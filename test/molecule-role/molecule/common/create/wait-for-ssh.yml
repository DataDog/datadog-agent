---
- name: "Gather existing EC2 instances for the branch '{{ agent_current_branch }}' and user '{{ user_id }}'"
  ec2_instance_info:
    filters:
      instance-state-name: [ "running" ]
      "tag:molecule_run_id": "{{ molecule_run_id }}"
      "tag:agent_current_branch": "{{ agent_current_branch }}"
      "tag:user_id": "{{ user_id }}"
      "tag:molecule_scenario_name": "{{ molecule_scenario_name }}"
  when: molecule_run_id is defined and molecule_run_id != "" and molecule_scenario_name is defined and molecule_scenario_name != "" and agent_current_branch is defined and agent_current_branch != "" and user_id is defined and user_id != ""
  register: ec2_molecule_instances

- name: Wait for SSH
  when: (ec2_molecule_instances.instances | length) > 0
  wait_for:
    port: "{{ ssh_port }}"
    host: "{{ item.public_ip_address }}"
    search_regex: SSH
    delay: 10
    timeout: 320
  with_items: "{{ ec2_molecule_instances.instances }}"
