---
- name: Test for presence of local keypair
  stat:
    path: "{{ keypair_path }}"
  register: keypair_local

- name: Delete remote keypair
  ec2_key:
    name: "{{ keypair_name }}"
    state: absent
  when: not keypair_local.stat.exists

- name: Create keypair
  ec2_key:
    name: "{{ keypair_name }}"
  register: keypair

- name: Persist the keypair
  copy:
    dest: "{{ keypair_path }}"
    content: "{{ keypair.key.private_key }}"
    mode: 0600
  when: keypair.changed

# - name: Persist the keypair in a temporary storage
#   copy:
#     dest: ".molecule/{{ molecule_scenario_name }}/ssh_key"
#     content: "{{ keypair.key.private_key }}"
#     mode: 0600
#   when: keypair.changed

- name: (CI) Dump the ssh private key in the artifactory directory
  when: keypair.changed and (ci_project_dir is defined and ci_project_dir != "")
  copy:
    dest: "{{ci_project_dir}}/.molecule/{{ molecule_scenario_name }}/ssh_key"
    content: "{{ keypair.key.private_key }}"
    mode: 0600

# - name: Encrypt data for artifact
#   shell: |
#     echo "{{ ci_job_token }}" > password
#     ansible-vault encrypt --vault-id test@password "{{ci_project_dir}}/.molecule/{{ molecule_scenario_name }}/ssh_key"
#     rm password
