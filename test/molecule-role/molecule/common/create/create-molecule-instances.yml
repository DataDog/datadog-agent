---
- name: Create molecule instance(s)
  ec2_instance:
    key_name: "{{ keypair_name }}"
    image_id: "{{ item.image }}"
    instance_type: "{{ item.instance_type }}"
    vpc_subnet_id: "{{ item.vpc_subnet_id }}"
    security_group: "{{ security_group_name }}"
    tags:
      Name: "{{ item.name }}"
      instance: "{{ item.name }}"
      molecule_run_id: "{{ molecule_run_id }}"
      molecule: yes
    wait: true
    network:
      assign_public_ip: true
    filters:
      tag:Name: "{{ item.name }}"
      instance-state-name: pending
  register: server
  with_items: "{{ molecule_yml.platforms }}"
  async: 7200
  poll: 0
