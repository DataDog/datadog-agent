---
- name: Create molecule instance(s)
  when: molecule_scenario_name is defined and molecule_scenario_name != "" and agent_current_branch is defined and agent_current_branch != ""
  ec2_instance:
    key_name: "{{ keypair_name }}"
    image_id: "{{ item.image }}"
    instance_type: "{{ item.instance_type }}"
    vpc_subnet_id: "{{ item.vpc_subnet_id }}"
    security_group: "{{ security_group_name }}"
    tags:
      Name: "{{ item.name }}-{{ ci_sts_version }}"
      instance: "{{ item.name }}"
      molecule_run_id: "{{ molecule_run_id }}"
      agent_current_branch: "{{ agent_current_branch }}"
      molecule_scenario_name: "{{ molecule_scenario_name }}"
      ci_sts_major_python_version: "{{ ci_sts_major_python_version }}"
      molecule: yes
    wait: true
    network:
      assign_public_ip: true
    filters:
      tag:Name: "{{ item.name }}"
      instance-state-name: pending
  register: server
  with_items: "{{ molecule_yml.platforms }}"
  async: 7200
  poll: 0
