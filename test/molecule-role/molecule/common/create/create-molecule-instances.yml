---
- name: Check if no instances exists before creating more
  ec2_instance_info:
    filters:
      instance-state-name: [ "running" ]
      "tag:ci_sts_major_python_version": "{{ ci_sts_major_python_version }}"
      "tag:agent_current_branch": "{{ agent_current_branch }}"
      "tag:molecule_scenario_name": "{{ molecule_scenario_name }}"
      "tag:molecule_run_id": "{{ molecule_run_id }}"
      "tag:dev": "{{ dev_mode }}"
      "tag:usage": "molecule-build"
  register: find_instances

- name: Create molecule instance(s)
  when: find_instances is undefined or find_instances|length == 0
  ec2_instance:
    key_name: "{{ keypair_name }}"
    image_id: "{{ item.image }}"
    instance_type: "{{ item.instance_type }}"
    vpc_subnet_id: "{{ item.vpc_subnet_id }}"
    security_group: "{{ security_group_name }}"
    instance_initiated_shutdown_behavior: "terminate"
    tags:
      Name: "{{ item.name }}"
      instance: "{{ item.name }}"
      molecule_run_id: "{{ molecule_run_id }}"
      agent_current_branch: "{{ agent_current_branch }}"
      molecule_scenario_name: "{{ molecule_scenario_name }}"
      ci_sts_major_python_version: "{{ ci_sts_major_python_version }}"
      usage: "molecule-build"
      dev: "{{ dev_mode }}"
      molecule: yes
      VantaOwner: "stackstate@stackstate.com"
      VantaNonProd: true
      VantaDescription: "Machines used by CI pipeline"
      VantaContainsUserData: false
      VantaUserDataStored: "NA"
      VantaNoAlert: "This is for test isn't part of our production systems."
    wait: true
    network:
      assign_public_ip: true
    filters:
      tag:Name: "{{ item.name }}"
      instance-state-name: pending
  register: server
  with_items: "{{ molecule_yml.platforms }}"
  async: 7200
  poll: 0
