---
- name: Prepare Trace Java
  hosts: trace-java-demo
  gather_facts: true
  tasks:
    - name: Ubuntu18 automatic updates (wait for lock) (1/2)
      shell: "while fuser /var/lib/dpkg/lock >/dev/null 2>&1; do sleep 10; done;"
      become: yes

    - name: Ubuntu18 automatic updates (wait for lock) (2/2)
      shell: "sleep 15; while fuser /var/lib/dpkg/lock >/dev/null 2>&1; do sleep 10; done;"
      become: yes

    - name: Install provisioning dependencies (1/2)
      apt:
        name:
          python3-pip
        state: present
      become: yes
      register: pip3_res
      retries: 15
      delay: 5
      until: pip3_res is success

    - name: Install provisioning dependencies (2/2)
      shell: pip3 install docker
      become: yes

    - name: Docker login
      docker_login:
        registry: quay.io
        username: "{{ quay_user }}"
        password: "{{ quay_password }}"
        reauthorize: yes
    - name: Copy Configuration files
      copy:
        src: "files/"
        dest: "/home/ubuntu"
        mode: preserve
    - name: Gather facts (we need the docker network interface ip)
      setup:
    - name: Configure .env file used by docker-compose
      copy:
        content: |
          AGENT_DOCKER_REPO={{ agent_docker_repo }}
          AGENT_VERSION={{ agent_current_branch }}
          DOCKER_HOST_IP={{ ansible_docker0['ipv4']['address'] }}
          STACKSTATE_BRANCH={{ stackstate_branch }}
        dest: /home/ubuntu/.env
    - name: Run Docker compose
      command: docker-compose up -d
      args:
        chdir: /home/ubuntu/

    - import_tasks: ../wait-for-receiver.yml
    - import_tasks: ../wait-for-agent.yml
