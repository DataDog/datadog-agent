---
- name: Create
  hosts: localhost
  connection: local
  gather_facts: true
  vars:
    ssh_port: 22
    security_group_name: molecule_compose
    security_group_description: Agent v2 Molecule testing running on docker compose
    security_group_rules:
      - proto: tcp
        from_port: "{{ ssh_port }}"
        to_port: "{{ ssh_port }}"
        cidr_ip: '0.0.0.0/0'
      - proto: tcp
        from_port: 7070  # StackState Topic API port
        to_port: 7070
        cidr_ip: '0.0.0.0/0'
      - proto: icmp
        from_port: 8
        to_port: -1
        cidr_ip: '0.0.0.0/0'
    security_group_rules_egress:
      - proto: -1
        from_port: 0
        to_port: 0
        cidr_ip: '0.0.0.0/0'
  tasks:
    - include_tasks: ../common/create/create-security-group.yml
    - include_tasks: ../common/create/test-for-presence-of-local-keypair.yml
    - include_tasks: ../common/create/delete-remote-keypair.yml
    - include_tasks: ../common/create/create-keypair.yml
    - include_tasks: ../common/create/dump-ssh-key.yml
    - include_tasks: ../common/create/persist-the-keypair.yml
    - include_tasks: ../common/create/create-molecule-instances-sda-volume.yml
    - include_tasks: ../common/create/wait-for-instance-creation-to-complete.yml
    - include_tasks: ../common/create/populate-instance-config-dict.yml
    - include_tasks: ../common/create/convert-instance-config-dict-to-a-list.yml
    - include_tasks: ../common/create/dump-instance-config.yml
    - include_tasks: ../common/create/wait-for-ssh.yml
