---
driver:
  name: vagrant
  provider: virtualbox

  
  # Hyper-V doesn't support synced folders
  synced_folders:
  - ["C:/dev/datadog-agent/tools/windows/DatadogAgentInstaller/WixSetup", "/datadog-agent"]
  

provisioner:
  name: chef_solo
  product_name: chef
  install_strategy: always
  # Use the same product_version as the CI kitchen test in Azure.
  product_version: 14.12.9
  # the following settings make it possible to do a reboot during setup
  # (necessary for FIPS tests which reboot to enable FIPS mode)
  max_retries: 3
  wait_for_retry: 90
  client_rb:
    client_fork: false

platforms:

  - name: win2022
    attributes:
      dd-agent-rspec:
        enable_cws: 
    driver:
      box: cdaf/WindowsServer2022
      # Always use linked_clone when possible, it's so much faster
      linked_clone: true
      
      gui: true
      
      
# uncomment below to locally inspect junit tarballs used for CI visibility
#    verifier:
#      downloads:
#        "/tmp/junit.tar.gz": kitchen-junit-win2022.tar.gz
#        "/tmp/testjson.tar.gz": testjson/win2022/testjson.tar.gz


suites:
  - name: win-repair
    run_list:
      - "recipe[dd-agent-install::_install_windows_base]"
      - "recipe[dd-agent-install::_stop_windows_agent]"
      - "recipe[dd-agent-install::_damage_windows_install]"
      - "recipe[dd-agent-install::_repair_windows_install]"
    attributes:
      datadog:
        
        agent_major_version: ""
        
        api_key: "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
        
        application_key: "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
        
        url: "https://app.datad0g.com"
        
        aptrepo: "[signed-by=/usr/share/keyrings/datadog-archive-keyring.gpg] http://apttesting.datad0g.com/"
        
        aptrepo_dist: "pipeline-"
        
        yumrepo: "http://yumtesting.datad0g.com/testing/pipeline-//x86_64/"
        
        yumrepo_suse: "http://yumtesting.datad0g.com/suse/testing/pipeline-//x86_64/"
        
        windows_agent_url: "file://C:/datadog-agent"
        
      dd-agent-install:
        
        windows_agent_url: file://C:/datadog-agent
        
        windows_agent_filename: "datadog-agent-ng-7.99.0-1-x86_64"
        
      dd-agent-rspec:
        skip_windows_signing_test: &skip_windows_signing_test true

  - name: win-upgrade-rollback
    run_list:
      - "recipe[dd-agent-install]"
      - "recipe[dd-agent-upgrade]"
    attributes:
      datadog:
        agent_version: 7.40.0
        api_key: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
      dd-agent-upgrade:
        
        agent_major_version: ""
        
        api_key: "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
        
        application_key: "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
        
        url: "https://app.datad0g.com"
        
        aptrepo: "[signed-by=/usr/share/keyrings/datadog-archive-keyring.gpg] http://apttesting.datad0g.com/"
        
        aptrepo_dist: "pipeline-"
        
        yumrepo: "http://yumtesting.datad0g.com/testing/pipeline-//x86_64/"
        
        yumrepo_suse: "http://yumtesting.datad0g.com/suse/testing/pipeline-//x86_64/"
        
        windows_agent_url: "file://C:/datadog-agent"
        
        
        
        windows_agent_filename: "datadog-agent-ng-7.99.0-1-x86_64"
        
        agent_install_options: >
          APIKEY=aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
          WIXFAILWHENDEFERRED=1
      dd-agent-upgrade-rspec:
        # Used by the rspec test to know the version to which the agent should be upgraded
        agent_expected_version: "7.40.0"
      dd-agent-rspec:
        skip_windows_signing_test: &skip_windows_signing_test true

  - name: win-installopts
    run_list:
      - "recipe[dd-agent-install::_install_windows_base]"
    attributes:
      datadog:
        
        agent_major_version: ""
        
        api_key: "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
        
        application_key: "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
        
        url: "https://app.datad0g.com"
        
        aptrepo: "[signed-by=/usr/share/keyrings/datadog-archive-keyring.gpg] http://apttesting.datad0g.com/"
        
        aptrepo_dist: "pipeline-"
        
        yumrepo: "http://yumtesting.datad0g.com/testing/pipeline-//x86_64/"
        
        yumrepo_suse: "http://yumtesting.datad0g.com/suse/testing/pipeline-//x86_64/"
        
        windows_agent_url: "file://C:/datadog-agent"
        
      dd-agent-install:
        
        windows_agent_url: file://C:/datadog-agent
        
        windows_agent_filename: "datadog-agent-ng-7.99.0-1-x86_64"
        
        agent_install_options: >
          APIKEY=aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
          TAGS=k1:v1,k2:v2
          HOSTNAME=win-installopts
          CMD_PORT=4999
          PROXY_HOST=proxy.foo.com
          PROXY_PORT=1234
          PROXY_USER=puser
          PROXY_PASSWORD=ppass
          SITE=eu
          DD_URL=https://someurl.datadoghq.com
          LOGS_DD_URL=https://logs.someurl.datadoghq.com
          PROCESS_DD_URL=https://process.someurl.datadoghq.com
          TRACE_DD_URL=https://trace.someurl.datadoghq.com
      dd-agent-rspec:
        skip_windows_signing_test: &skip_windows_signing_test true

  - name: win-all-subservices
    run_list:
      - "recipe[dd-agent-install::_install_windows_base]"
    attributes:
      datadog:
        
        agent_major_version: ""
        
        api_key: "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
        
        application_key: "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
        
        url: "https://app.datad0g.com"
        
        aptrepo: "[signed-by=/usr/share/keyrings/datadog-archive-keyring.gpg] http://apttesting.datad0g.com/"
        
        aptrepo_dist: "pipeline-"
        
        yumrepo: "http://yumtesting.datad0g.com/testing/pipeline-//x86_64/"
        
        yumrepo_suse: "http://yumtesting.datad0g.com/suse/testing/pipeline-//x86_64/"
        
        windows_agent_url: "file://C:/datadog-agent"
        
      dd-agent-install:
        windows_agent_url: file://C:/datadog-agent
        
        windows_agent_url: file://C:/datadog-agent
        
        windows_agent_filename: "datadog-agent-ng-7.99.0-1-x86_64"
        
        agent_install_options: >
          APIKEY=aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
          LOGS_ENABLED=true
          PROCESS_ENABLED=true
          APM_ENABLED=true
      dd-agent-rspec:
        skip_windows_signing_test: &skip_windows_signing_test true

  - name: win-no-subservices
    run_list:
      - "recipe[dd-agent-install::_install_windows_base]"
    attributes:
      datadog:
        
        agent_major_version: ""
        
        api_key: "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
        
        application_key: "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
        
        url: "https://app.datad0g.com"
        
        aptrepo: "[signed-by=/usr/share/keyrings/datadog-archive-keyring.gpg] http://apttesting.datad0g.com/"
        
        aptrepo_dist: "pipeline-"
        
        yumrepo: "http://yumtesting.datad0g.com/testing/pipeline-//x86_64/"
        
        yumrepo_suse: "http://yumtesting.datad0g.com/suse/testing/pipeline-//x86_64/"
        
        windows_agent_url: "file://C:/datadog-agent"
        
      dd-agent-install:
        windows_agent_url: file://C:/datadog-agent
        
        windows_agent_url: file://C:/datadog-agent
        
        windows_agent_filename: "datadog-agent-ng-7.99.0-1-x86_64"
        
        agent_install_options: >
          APIKEY=aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
          LOGS_ENABLED=false
          PROCESS_ENABLED=false
          PROCESS_DISCOVERY_ENABLED=false
          APM_ENABLED=false
      dd-agent-rspec:
        skip_windows_signing_test: &skip_windows_signing_test true

  - name: win-user
    run_list:
      - "recipe[dd-agent-install::_install_windows_base]"
    attributes:
      datadog:
        
        agent_major_version: ""
        
        api_key: "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
        
        application_key: "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
        
        url: "https://app.datad0g.com"
        
        aptrepo: "[signed-by=/usr/share/keyrings/datadog-archive-keyring.gpg] http://apttesting.datad0g.com/"
        
        aptrepo_dist: "pipeline-"
        
        yumrepo: "http://yumtesting.datad0g.com/testing/pipeline-//x86_64/"
        
        yumrepo_suse: "http://yumtesting.datad0g.com/suse/testing/pipeline-//x86_64/"
        
        windows_agent_url: "file://C:/datadog-agent"
        
      dd-agent-install:
        
        windows_agent_url: file://C:/datadog-agent
        
        windows_agent_filename: "datadog-agent-ng-7.99.0-1-x86_64"
        
        agent_install_options: >
          APIKEY=aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
          LOGS_ENABLED=false
          PROCESS_ENABLED=true
          APM_ENABLED=true
      dd-agent-rspec:
        skip_windows_signing_test: &skip_windows_signing_test true

  - name: win-install-fail
    run_list:
        - "recipe[dd-agent-install::_install_windows_base]"
    attributes:
      datadog:
        
        agent_major_version: ""
        
        api_key: "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
        
        application_key: "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
        
        url: "https://app.datad0g.com"
        
        aptrepo: "[signed-by=/usr/share/keyrings/datadog-archive-keyring.gpg] http://apttesting.datad0g.com/"
        
        aptrepo_dist: "pipeline-"
        
        yumrepo: "http://yumtesting.datad0g.com/testing/pipeline-//x86_64/"
        
        yumrepo_suse: "http://yumtesting.datad0g.com/suse/testing/pipeline-//x86_64/"
        
        windows_agent_url: "file://C:/datadog-agent"
        
      dd-agent-install:
        
        windows_agent_url: file://C:/datadog-agent
        
        windows_agent_filename: "datadog-agent-ng-7.99.0-1-x86_64"
        
        agent_install_options: >
          APIKEY=aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
          LOGS_ENABLED=false
          PROCESS_ENABLED=true
          APM_ENABLED=true
          WIXFAILWHENDEFERRED=1
      dd-agent-rspec:
        skip_windows_signing_test: &skip_windows_signing_test true

  - name: win-alt-dir
    run_list:
        - "recipe[dd-agent-install::_install_windows_base]"
    attributes:
      datadog:
        
        agent_major_version: ""
        
        api_key: "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
        
        application_key: "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
        
        url: "https://app.datad0g.com"
        
        aptrepo: "[signed-by=/usr/share/keyrings/datadog-archive-keyring.gpg] http://apttesting.datad0g.com/"
        
        aptrepo_dist: "pipeline-"
        
        yumrepo: "http://yumtesting.datad0g.com/testing/pipeline-//x86_64/"
        
        yumrepo_suse: "http://yumtesting.datad0g.com/suse/testing/pipeline-//x86_64/"
        
        windows_agent_url: "file://C:/datadog-agent"
        
      dd-agent-install:
        
        windows_agent_url: file://C:/datadog-agent
        
        windows_agent_filename: "datadog-agent-ng-7.99.0-1-x86_64"
        
        agent_install_options: >
          APIKEY=aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
          APPLICATIONDATADIRECTORY=c:\altconfroot
          PROJECTLOCATION=c:\ddagent

      dd-agent-rspec:
        skip_windows_signing_test: &skip_windows_signing_test true
        APPLICATIONDATADIRECTORY: c:\altconfroot
        PROJECTLOCATION: c:\ddagent

