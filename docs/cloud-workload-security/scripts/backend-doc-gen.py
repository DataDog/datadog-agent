import argparse
import json
from dataclasses import dataclass
import jinja2
import os

@dataclass
class SchemaParameter:
    name: str
    type: str
    description: str

@dataclass
class DefinitionReference:
    name: str
    anchor: str

@dataclass
class SchemaDefinition:
    name: str
    schema: str
    references: list[DefinitionReference]



def remove_schema_props(node):
    if type(node) is dict:
        return {key: remove_schema_props(item) for key, item in node.items() if key != "$schema"}
    else:
        return node


def fill_template(event_schema, parameters, definitions, template_name):
    env = jinja2.Environment(
        loader=jinja2.FileSystemLoader(os.path.join(os.path.dirname(__file__), "templates")),
        autoescape=jinja2.select_autoescape(),
        trim_blocks=True,
    )
    templ = env.get_template(template_name)
    return templ.render(event_schema=event_schema, parameters=parameters, definitions=definitions)

def presentable_top_node(top_node):
    without_defs = {key: item for key, item in top_node.items() if key not in ["definitions"]}
    return json.dumps(without_defs, indent=4)

def extract_ref_name_and_anchor(ref):
    prefix = "#/definitions/"
    if ref.startswith(prefix):
        name = ref[len(prefix):]
    return name, name.lower()

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Generate Backend JSON documentation")
    parser.add_argument("--input", type=str, help="input json file generated by the json schema generator")
    parser.add_argument("--output", type=str, help="output file")
    args = parser.parse_args()

    json_schema_file = open(args.input)
    json_top_node = json.load(json_schema_file)
    json_schema_file.close()

    json_top_node = remove_schema_props(json_top_node)

    parameters = []
    for name, prop in json_top_node["properties"].items():
        if "$ref" in prop:
            ref_name, ref_anchor = extract_ref_name_and_anchor(prop["$ref"])
            parameters.append(SchemaParameter(name, "$ref", f"Please see [{ref_name}](#{ref_anchor})"))
        else:
            parameters.append(SchemaParameter(name, prop["type"], ""))

    definitions = []
    definitions.sort(key=lambda d:d.name)

    for name, definition in json_top_node["definitions"].items():
        references = []
        for prop_name, prop in definition["properties"].items():
            if "$ref" in prop:
                ref_name, ref_anchor = extract_ref_name_and_anchor(prop["$ref"])
                references.append(DefinitionReference(ref_name, ref_anchor))
        definitions.append(SchemaDefinition(name, presentable_top_node(definition), references))

    presentable_json = presentable_top_node(json_top_node)

    output_file = open(args.output, "w")
    print(fill_template(presentable_json, parameters, definitions, "backend.md"), file=output_file)
    output_file.close()
