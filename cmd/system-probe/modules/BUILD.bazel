load("@rules_go//go:def.bzl", "go_library", "go_test")

go_library(
    name = "modules",
    srcs = [
        "compliance.go",
        "crashdetect_windows.go",
        "discovery_linux.go",
        "dynamic_instrumentation_unsupported.go",
        "eventmonitor.go",
        "eventmonitor_linux.go",
        "eventmonitor_windows.go",
        "gpu_unsupported.go",
        "language_detection.go",
        "modules.go",
        "network_tracer.go",
        "network_tracer_windows.go",
        "ping.go",
        "process.go",
        "software_inventory_windows.go",
        "traceroute.go",
        "traceroute_darwin.go",
        "traceroute_linux.go",
        "traceroute_windows.go",
        "usm_endpoints_common.go",
        "usm_endpoints_windows.go",
    ],
    importpath = "github.com/DataDog/datadog-agent/cmd/system-probe/modules",
    visibility = ["//visibility:public"],
    deps = [
        "//pkg/networkpath/payload",
        "//pkg/networkpath/traceroute/config",
        "//pkg/networkpath/traceroute/runner",
        "//pkg/system-probe/api/module",
        "//pkg/system-probe/config",
        "//pkg/system-probe/config/types",
        "//pkg/util/log",
        "@com_github_gorilla_mux//:mux",
        "@org_golang_google_grpc//:grpc",
    ] + select({
        "@rules_go//go/platform:android": [
            "//pkg/collector/corechecks/servicediscovery/module",
            "//pkg/compliance/dbconfig",
            "//pkg/eventmonitor",
            "//pkg/eventmonitor/config",
            "//pkg/eventmonitor/consumers",
            "//pkg/gpu/config",
            "//pkg/languagedetection/languagemodels",
            "//pkg/languagedetection/privileged",
            "//pkg/network/config",
            "//pkg/network/events",
            "//pkg/network/usm/config",
            "//pkg/network/usm/state",
            "//pkg/networkdevice/pinger",
            "//pkg/process/encoding",
            "//pkg/process/encoding/request",
            "//pkg/process/events/consumer",
            "//pkg/process/monitor",
            "//pkg/process/procutil",
            "//pkg/proto/pbgo/languagedetection",
            "//pkg/security/config",
            "//pkg/security/module",
            "//pkg/system-probe/utils",
            "@org_golang_google_protobuf//proto",
        ],
        "@rules_go//go/platform:linux": [
            "//pkg/collector/corechecks/servicediscovery/module",
            "//pkg/compliance/dbconfig",
            "//pkg/eventmonitor",
            "//pkg/eventmonitor/config",
            "//pkg/eventmonitor/consumers",
            "//pkg/gpu/config",
            "//pkg/languagedetection/languagemodels",
            "//pkg/languagedetection/privileged",
            "//pkg/network/config",
            "//pkg/network/events",
            "//pkg/network/usm/config",
            "//pkg/network/usm/state",
            "//pkg/networkdevice/pinger",
            "//pkg/process/encoding",
            "//pkg/process/encoding/request",
            "//pkg/process/events/consumer",
            "//pkg/process/monitor",
            "//pkg/process/procutil",
            "//pkg/proto/pbgo/languagedetection",
            "//pkg/security/config",
            "//pkg/security/module",
            "//pkg/system-probe/utils",
            "@org_golang_google_protobuf//proto",
        ],
        "@rules_go//go/platform:windows": [
            "//pkg/collector/corechecks/system/wincrashdetect/probe",
            "//pkg/collector/corechecks/system/winsoftware",
            "//pkg/config/setup",
            "//pkg/eventmonitor",
            "//pkg/eventmonitor/config",
            "//pkg/gpu/config",
            "//pkg/network",
            "//pkg/network/config",
            "//pkg/network/encoding/marshal",
            "//pkg/network/events",
            "//pkg/network/protocols/http/debugging",
            "//pkg/network/protocols/telemetry",
            "//pkg/network/tracer",
            "//pkg/process/events/consumer",
            "//pkg/security/config",
            "//pkg/security/module",
            "//pkg/system-probe/utils",
            "//pkg/util/winutil",
            "//pkg/util/winutil/messagestrings",
        ],
        "//conditions:default": [],
    }),
)

go_test(
    name = "modules_test",
    srcs = [
        "compliance_test.go",
        "language_detection_test.go",
        "network_tracer_test.go",
        "process_test.go",
        "traceroute_test.go",
    ],
    embed = [":modules"],
    deps = select({
        "@rules_go//go/platform:android": [
            "//pkg/compliance/dbconfig",
            "//pkg/languagedetection/languagemodels",
            "//pkg/languagedetection/privileged",
            "//pkg/networkpath/traceroute/config",
            "//pkg/process/encoding",
            "//pkg/process/encoding/request",
            "//pkg/process/procutil",
            "//pkg/process/procutil/mocks",
            "//pkg/proto/pbgo/languagedetection",
            "//pkg/proto/pbgo/process",
            "@com_github_datadog_agent_payload_v5//process",
            "@com_github_davecgh_go_spew//spew",
            "@com_github_gorilla_mux//:mux",
            "@com_github_stretchr_testify//assert",
            "@com_github_stretchr_testify//mock",
            "@com_github_stretchr_testify//require",
            "@org_golang_google_protobuf//proto",
        ],
        "@rules_go//go/platform:linux": [
            "//pkg/compliance/dbconfig",
            "//pkg/languagedetection/languagemodels",
            "//pkg/languagedetection/privileged",
            "//pkg/networkpath/traceroute/config",
            "//pkg/process/encoding",
            "//pkg/process/encoding/request",
            "//pkg/process/procutil",
            "//pkg/process/procutil/mocks",
            "//pkg/proto/pbgo/languagedetection",
            "//pkg/proto/pbgo/process",
            "@com_github_datadog_agent_payload_v5//process",
            "@com_github_davecgh_go_spew//spew",
            "@com_github_gorilla_mux//:mux",
            "@com_github_stretchr_testify//assert",
            "@com_github_stretchr_testify//mock",
            "@com_github_stretchr_testify//require",
            "@org_golang_google_protobuf//proto",
        ],
        "@rules_go//go/platform:windows": [
            "//pkg/network",
            "//pkg/network/encoding/marshal",
            "//pkg/networkpath/traceroute/config",
            "//pkg/process/encoding",
            "//pkg/process/util",
            "@com_github_gorilla_mux//:mux",
            "@com_github_stretchr_testify//assert",
            "@com_github_stretchr_testify//require",
        ],
        "//conditions:default": [],
    }),
)
