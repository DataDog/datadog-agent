load("@rules_go//go:def.bzl", "go_library", "go_test")

go_library(
    name = "modules",
    srcs = [
        "all_linux.go",
        "all_linux_arm64.go",
        "all_unsupported.go",
        "all_windows.go",
        "compliance.go",
        "crashdetect_windows.go",
        "dynamic_instrumentation.go",
        "ebpf.go",
        "eventmonitor.go",
        "eventmonitor_linux.go",
        "eventmonitor_windows.go",
        "language_detection.go",
        "network_tracer.go",
        "network_tracer_linux.go",
        "network_tracer_windows.go",
        "oom_kill_probe.go",
        "ping.go",
        "process.go",
        "tcp_queue_tracer.go",
        "traceroute.go",
        "traceroute_linux.go",
        "traceroute_windows.go",
    ],
    importpath = "github.com/DataDog/datadog-agent/cmd/system-probe/modules",
    visibility = ["//visibility:public"],
    deps = select({
        "@rules_go//go/platform:android": [
            "//cmd/system-probe/config",
            "//cmd/system-probe/config/types",
            "//cmd/system-probe/utils",
            "//comp/core/workloadmeta",
            "//pkg/collector/corechecks/ebpf/probe/ebpfcheck",
            "//pkg/collector/corechecks/ebpf/probe/oomkill",
            "//pkg/collector/corechecks/ebpf/probe/tcpqueuelength",
            "//pkg/compliance/dbconfig",
            "//pkg/config",
            "//pkg/config/setup",
            "//pkg/dynamicinstrumentation",
            "//pkg/ebpf",
            "//pkg/eventmonitor",
            "//pkg/eventmonitor/config",
            "//pkg/languagedetection/languagemodels",
            "//pkg/languagedetection/privileged",
            "//pkg/network",
            "//pkg/network/config",
            "//pkg/network/encoding/marshal",
            "//pkg/network/events",
            "//pkg/network/protocols/http/debugging",
            "//pkg/network/protocols/kafka/debugging",
            "//pkg/network/protocols/postgres/debugging",
            "//pkg/network/protocols/telemetry",
            "//pkg/network/tracer",
            "//pkg/network/usm/utils",
            "//pkg/networkdevice/pinger",
            "//pkg/networkpath/traceroute",
            "//pkg/process/encoding",
            "//pkg/process/encoding/request",
            "//pkg/process/events/consumer",
            "//pkg/process/procutil",
            "//pkg/process/statsd",
            "//pkg/proto/pbgo/languagedetection",
            "//pkg/security/config",
            "//pkg/security/module",
            "//pkg/util/log",
            "//pkg/util/optional",
            "@com_github_gorilla_mux//:mux",
            "@org_golang_google_grpc//:go_default_library",
            "@org_golang_google_protobuf//proto",
            "@org_uber_go_atomic//:atomic",
        ],
        "@rules_go//go/platform:linux": [
            "//cmd/system-probe/config",
            "//cmd/system-probe/config/types",
            "//cmd/system-probe/utils",
            "//comp/core/workloadmeta",
            "//pkg/collector/corechecks/ebpf/probe/ebpfcheck",
            "//pkg/collector/corechecks/ebpf/probe/oomkill",
            "//pkg/collector/corechecks/ebpf/probe/tcpqueuelength",
            "//pkg/compliance/dbconfig",
            "//pkg/config",
            "//pkg/config/setup",
            "//pkg/dynamicinstrumentation",
            "//pkg/ebpf",
            "//pkg/eventmonitor",
            "//pkg/eventmonitor/config",
            "//pkg/languagedetection/languagemodels",
            "//pkg/languagedetection/privileged",
            "//pkg/network",
            "//pkg/network/config",
            "//pkg/network/encoding/marshal",
            "//pkg/network/events",
            "//pkg/network/protocols/http/debugging",
            "//pkg/network/protocols/kafka/debugging",
            "//pkg/network/protocols/postgres/debugging",
            "//pkg/network/protocols/telemetry",
            "//pkg/network/tracer",
            "//pkg/network/usm/utils",
            "//pkg/networkdevice/pinger",
            "//pkg/networkpath/traceroute",
            "//pkg/process/encoding",
            "//pkg/process/encoding/request",
            "//pkg/process/events/consumer",
            "//pkg/process/procutil",
            "//pkg/process/statsd",
            "//pkg/proto/pbgo/languagedetection",
            "//pkg/security/config",
            "//pkg/security/module",
            "//pkg/util/log",
            "//pkg/util/optional",
            "@com_github_gorilla_mux//:mux",
            "@org_golang_google_grpc//:go_default_library",
            "@org_golang_google_protobuf//proto",
            "@org_uber_go_atomic//:atomic",
        ],
        "@rules_go//go/platform:windows": [
            "//cmd/system-probe/config",
            "//cmd/system-probe/config/types",
            "//cmd/system-probe/utils",
            "//comp/core/workloadmeta",
            "//pkg/collector/corechecks/system/wincrashdetect/probe",
            "//pkg/config/setup",
            "//pkg/eventmonitor",
            "//pkg/eventmonitor/config",
            "//pkg/network",
            "//pkg/network/config",
            "//pkg/network/encoding/marshal",
            "//pkg/network/events",
            "//pkg/network/protocols/http/debugging",
            "//pkg/network/protocols/kafka/debugging",
            "//pkg/network/protocols/postgres/debugging",
            "//pkg/network/protocols/telemetry",
            "//pkg/network/tracer",
            "//pkg/network/usm/utils",
            "//pkg/networkpath/traceroute",
            "//pkg/process/events/consumer",
            "//pkg/process/statsd",
            "//pkg/security/config",
            "//pkg/security/module",
            "//pkg/util/log",
            "//pkg/util/optional",
            "//pkg/util/winutil",
            "//pkg/util/winutil/messagestrings",
            "@com_github_gorilla_mux//:mux",
            "@org_golang_google_grpc//:go_default_library",
            "@org_uber_go_atomic//:atomic",
        ],
        "//conditions:default": [],
    }) + select({
        "@rules_go//go/platform:aix_ppc64": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:android_386": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:android_amd64": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:android_arm": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:android_arm64": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:darwin_386": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:darwin_amd64": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:darwin_arm": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:darwin_arm64": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:dragonfly_amd64": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:freebsd_386": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:freebsd_amd64": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:freebsd_arm": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:freebsd_arm64": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:illumos_amd64": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:ios_amd64": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:ios_arm64": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:js_wasm": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:linux_386": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:linux_amd64": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:linux_arm": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:linux_arm64": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:linux_mips": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:linux_mips64": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:linux_mips64le": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:linux_mipsle": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:linux_ppc64": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:linux_ppc64le": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:linux_riscv64": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:linux_s390x": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:netbsd_386": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:netbsd_amd64": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:netbsd_arm": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:netbsd_arm64": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:openbsd_386": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:openbsd_amd64": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:openbsd_arm": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:openbsd_arm64": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:plan9_386": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:plan9_amd64": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:plan9_arm": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:solaris_amd64": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:windows_386": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:windows_amd64": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:windows_arm": [
            "//cmd/system-probe/api/module",
        ],
        "@rules_go//go/platform:windows_arm64": [
            "//cmd/system-probe/api/module",
        ],
        "//conditions:default": [],
    }),
)

go_test(
    name = "modules_test",
    srcs = [
        "compliance_test.go",
        "language_detection_test.go",
        "network_tracer_test.go",
        "traceroute_test.go",
    ],
    embed = [":modules"],
    deps = select({
        "@rules_go//go/platform:android": [
            "//pkg/compliance/dbconfig",
            "//pkg/languagedetection/languagemodels",
            "//pkg/languagedetection/privileged",
            "//pkg/network",
            "//pkg/network/encoding/marshal",
            "//pkg/networkpath/traceroute",
            "//pkg/process/encoding",
            "//pkg/process/util",
            "//pkg/proto/pbgo/languagedetection",
            "@com_github_davecgh_go_spew//spew",
            "@com_github_gorilla_mux//:mux",
            "@com_github_stretchr_testify//assert",
            "@com_github_stretchr_testify//mock",
            "@com_github_stretchr_testify//require",
            "@org_golang_google_protobuf//proto",
        ],
        "@rules_go//go/platform:linux": [
            "//pkg/compliance/dbconfig",
            "//pkg/languagedetection/languagemodels",
            "//pkg/languagedetection/privileged",
            "//pkg/network",
            "//pkg/network/encoding/marshal",
            "//pkg/networkpath/traceroute",
            "//pkg/process/encoding",
            "//pkg/process/util",
            "//pkg/proto/pbgo/languagedetection",
            "@com_github_davecgh_go_spew//spew",
            "@com_github_gorilla_mux//:mux",
            "@com_github_stretchr_testify//assert",
            "@com_github_stretchr_testify//mock",
            "@com_github_stretchr_testify//require",
            "@org_golang_google_protobuf//proto",
        ],
        "@rules_go//go/platform:windows": [
            "//pkg/network",
            "//pkg/network/encoding/marshal",
            "//pkg/networkpath/traceroute",
            "//pkg/process/encoding",
            "//pkg/process/util",
            "@com_github_gorilla_mux//:mux",
            "@com_github_stretchr_testify//assert",
            "@com_github_stretchr_testify//require",
        ],
        "//conditions:default": [],
    }),
)
