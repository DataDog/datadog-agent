// Unless explicitly stated otherwise all files in this repository are licensed
// under the Apache License Version 2.0.
// This product includes software developed at Datadog (https://www.datadoghq.com/).
// Copyright 2023-present Datadog, Inc.

package main

import (
	"bufio"
	"context"
	"os/exec"
	"strings"

	"github.com/DataDog/datadog-agent/pkg/util/log"
)

func launchScannerMalware(ctx context.Context, opts scannerOptions) (scanMalwareResult, error) {
	return runYara(ctx, opts.Scan, "/tmp/rules.yar", opts.Root)
}

type yaraResult struct {
	File string `json:"file,omitempty"`
	Info string `json:"info,omitempty"`
	Rule string `json:"rule,omitempty"`
}

func runYara(ctx context.Context, scan *scanTask, rules, dir string) (scanMalwareResult, error) {
	args := []string{"-r", "-w", "-N", rules, dir}

	cmd := exec.CommandContext(ctx, "/opt/datadog-agent/embedded/bin/yara", args...)
	cmd.Dir = dir

	log.Debugf("%s: running %s\n", scan, cmd.String())

	stdout, err := cmd.StdoutPipe()
	if err != nil {
		return scanMalwareResult{}, err
	}

	stderr, err := cmd.StderrPipe()
	if err != nil {
		return scanMalwareResult{}, err
	}

	if err := cmd.Start(); err != nil {
		return scanMalwareResult{}, err
	}
	defer func() {
		if err := cmd.Wait(); err != nil {
			log.Debugf("%s: yara process exited with status: %v", scan, err)
		}
	}()

	var findings []*scanFinding
	scannerErr := bufio.NewScanner(stderr)

	go func() {
		for scannerErr.Scan() {
			log.Warnf("%s: yara: %s", scan, scannerErr.Text())
		}
	}()

	scannerOut := bufio.NewScanner(stdout)

	for scannerOut.Scan() {
		log.Debugf("%s: yara: %s", scan, scannerOut.Text())
		s := strings.Split(scannerOut.Text(), " ")
		switch len(s) {
		case 2:
			result := yaraResult{
				Rule: s[0],
				File: strings.TrimPrefix(s[1], dir),
			}
			findings = append(findings, &scanFinding{
				RuleID:       "malware",
				RuleVersion:  0,
				FrameworkID:  "cis-ubuntu2204",
				Evaluator:    "malware",
				Result:       "failed",
				ResourceType: "host",
				ResourceID:   scan.Hostname,
				Data: map[string]interface{}{
					"results": result,
				},
			})
		case 3:
			result := yaraResult{
				Rule: s[0],
				Info: s[1],
				File: strings.TrimPrefix(s[2], dir),
			}
			findings = append(findings, &scanFinding{
				RuleID:       "malware",
				RuleVersion:  0,
				FrameworkID:  "cis-ubuntu2204",
				Evaluator:    "malware",
				Result:       "failed",
				ResourceType: "host",
				ResourceID:   scan.Hostname,
				Data: map[string]interface{}{
					"results": result,
				},
			})
		default:
			log.Warnf("%s: invalid yara output: %s", scan, scannerOut.Text())
		}
	}

	return scanMalwareResult{findings}, nil
}
