load("@rules_go//go:def.bzl", "go_library", "go_test")

go_library(
    name = "run",
    srcs = [
        "command.go",
        "command_notwin.go",
        "command_windows.go",
        "dependent_services.go",
        "dependent_services_nix.go",
        "dependent_services_windows.go",
    ],
    importpath = "github.com/DataDog/datadog-agent/cmd/agent/subcommands/run",
    visibility = ["//visibility:public"],
    deps = [
        "//cmd/agent/command",
        "//cmd/agent/common",
        "//cmd/agent/common/misconfig",
        "//cmd/agent/common/signals",
        "//cmd/agent/subcommands/run/internal/clcrunnerapi",
        "//cmd/agent/subcommands/run/internal/settings",
        "//comp/agent",
        "//comp/agent/autoexit",
        "//comp/agent/cloudfoundrycontainer",
        "//comp/agent/expvarserver",
        "//comp/agent/jmxlogger",
        "//comp/agent/jmxlogger/jmxloggerimpl",
        "//comp/aggregator/demultiplexer",
        "//comp/aggregator/demultiplexer/demultiplexerimpl",
        "//comp/aggregator/demultiplexerendpoint/fx",
        "//comp/api/api/apiimpl",
        "//comp/api/api/def",
        "//comp/api/authtoken/createandfetchimpl",
        "//comp/api/commonendpoints/fx",
        "//comp/collector/collector",
        "//comp/collector/collector/collectorimpl",
        "//comp/core",
        "//comp/core/agenttelemetry/def",
        "//comp/core/agenttelemetry/fx",
        "//comp/core/autodiscovery",
        "//comp/core/autodiscovery/autodiscoveryimpl",
        "//comp/core/autodiscovery/providers",
        "//comp/core/config",
        "//comp/core/flare",
        "//comp/core/gui",
        "//comp/core/gui/guiimpl",
        "//comp/core/healthprobe/def",
        "//comp/core/healthprobe/fx",
        "//comp/core/log/def",
        "//comp/core/lsof/fx",
        "//comp/core/pid",
        "//comp/core/pid/pidimpl",
        "//comp/core/profiler/fx",
        "//comp/core/remoteagentregistry/fx",
        "//comp/core/secrets",
        "//comp/core/settings",
        "//comp/core/settings/settingsimpl",
        "//comp/core/status",
        "//comp/core/status/statusimpl",
        "//comp/core/sysprobeconfig",
        "//comp/core/sysprobeconfig/sysprobeconfigimpl",
        "//comp/core/tagger/def",
        "//comp/core/tagger/fx-dual",
        "//comp/core/telemetry",
        "//comp/core/workloadmeta/collectors/catalog-core",
        "//comp/core/workloadmeta/def",
        "//comp/core/workloadmeta/defaults",
        "//comp/core/workloadmeta/fx",
        "//comp/dogstatsd",
        "//comp/dogstatsd/replay/def",
        "//comp/dogstatsd/server",
        "//comp/dogstatsd/serverDebug",
        "//comp/dogstatsd/statsd",
        "//comp/dogstatsd/status/statusimpl",
        "//comp/forwarder",
        "//comp/forwarder/defaultforwarder",
        "//comp/forwarder/eventplatform/eventplatformimpl",
        "//comp/forwarder/eventplatformreceiver/eventplatformreceiverimpl",
        "//comp/forwarder/orchestrator/orchestratorimpl",
        "//comp/haagent/fx",
        "//comp/languagedetection/client",
        "//comp/languagedetection/client/clientimpl",
        "//comp/logs",
        "//comp/logs/adscheduler/adschedulerimpl",
        "//comp/logs/agent",
        "//comp/logs/integrations/def",
        "//comp/metadata",
        "//comp/metadata/haagent/def",
        "//comp/metadata/host",
        "//comp/metadata/inventoryagent",
        "//comp/metadata/inventorychecks",
        "//comp/metadata/inventoryhost",
        "//comp/metadata/inventoryotel",
        "//comp/metadata/packagesigning",
        "//comp/metadata/runner",
        "//comp/metadata/securityagent/def",
        "//comp/metadata/systemprobe/def",
        "//comp/ndmtmp",
        "//comp/netflow",
        "//comp/netflow/server",
        "//comp/networkpath",
        "//comp/otelcol",
        "//comp/otelcol/collector/def",
        "//comp/otelcol/logsagentpipeline",
        "//comp/otelcol/status/fx",
        "//comp/process",
        "//comp/process/agent",
        "//comp/process/status/statusimpl",
        "//comp/rdnsquerier/fx",
        "//comp/remote-config",
        "//comp/remote-config/rcclient",
        "//comp/remote-config/rcservice/rcserviceimpl",
        "//comp/remote-config/rcservicemrf/rcservicemrfimpl",
        "//comp/remote-config/rctelemetryreporter/rctelemetryreporterimpl",
        "//comp/serializer/metricscompression/fx",
        "//comp/snmptraps",
        "//comp/snmptraps/server",
        "//comp/trace/status/statusimpl",
        "//pkg/aggregator",
        "//pkg/collector",
        "//pkg/collector/check",
        "//pkg/collector/corechecks/net",
        "//pkg/collector/corechecks/snmp/status",
        "//pkg/collector/python",
        "//pkg/commonchecks",
        "//pkg/config/remote/data",
        "//pkg/config/settings",
        "//pkg/config/setup",
        "//pkg/jmxfetch",
        "//pkg/process/util/containers",
        "//pkg/runtime",
        "//pkg/serializer",
        "//pkg/status/clusteragent",
        "//pkg/status/endpoints",
        "//pkg/status/health",
        "//pkg/status/httpproxy",
        "//pkg/status/jmx",
        "//pkg/status/systemprobe",
        "//pkg/telemetry",
        "//pkg/util/common",
        "//pkg/util/coredump",
        "//pkg/util/defaultpaths",
        "//pkg/util/flavor",
        "//pkg/util/fxutil",
        "//pkg/util/fxutil/logging",
        "//pkg/util/hostname",
        "//pkg/util/installinfo",
        "//pkg/util/kubernetes/apiserver/leaderelection",
        "//pkg/util/log",
        "//pkg/util/option",
        "//pkg/version",
        "@com_github_datadog_datadog_go_v5//statsd",
        "@com_github_spf13_cobra//:cobra",
        "@in_gopkg_datadog_dd_trace_go_v1//profiler",
        "@org_uber_go_fx//:fx",
    ] + select({
        "@rules_go//go/platform:aix": [
            "//pkg/config/model",
        ],
        "@rules_go//go/platform:android": [
            "//pkg/config/model",
        ],
        "@rules_go//go/platform:darwin": [
            "//pkg/config/model",
        ],
        "@rules_go//go/platform:dragonfly": [
            "//pkg/config/model",
        ],
        "@rules_go//go/platform:freebsd": [
            "//pkg/config/model",
        ],
        "@rules_go//go/platform:illumos": [
            "//pkg/config/model",
        ],
        "@rules_go//go/platform:ios": [
            "//pkg/config/model",
        ],
        "@rules_go//go/platform:js": [
            "//pkg/config/model",
        ],
        "@rules_go//go/platform:linux": [
            "//pkg/config/model",
        ],
        "@rules_go//go/platform:netbsd": [
            "//pkg/config/model",
        ],
        "@rules_go//go/platform:openbsd": [
            "//pkg/config/model",
        ],
        "@rules_go//go/platform:osx": [
            "//pkg/config/model",
        ],
        "@rules_go//go/platform:plan9": [
            "//pkg/config/model",
        ],
        "@rules_go//go/platform:qnx": [
            "//pkg/config/model",
        ],
        "@rules_go//go/platform:solaris": [
            "//pkg/config/model",
        ],
        "@rules_go//go/platform:windows": [
            "//comp/checks/agentcrashdetect",
            "//comp/checks/agentcrashdetect/agentcrashdetectimpl",
            "//comp/checks/windowseventlog",
            "//comp/checks/windowseventlog/windowseventlogimpl",
            "//comp/checks/winregistry",
            "//comp/checks/winregistry/impl",
            "//comp/etw/impl",
            "//comp/trace/config",
            "//comp/trace/etwtracer",
            "//comp/trace/etwtracer/etwtracerimpl",
            "//pkg/config/model",
            "//pkg/util/winutil",
            "@org_golang_x_sys//windows",
            "@org_golang_x_sys//windows/svc/mgr",
        ],
        "//conditions:default": [],
    }),
)

go_test(
    name = "run_test",
    srcs = [
        "command_test.go",
        "command_windows_test.go",
    ],
    embed = [":run"],
    deps = [
        "//cmd/agent/command",
        "//comp/core",
        "//comp/core/pid/pidimpl",
        "//comp/core/secrets",
        "//pkg/util/fxutil",
        "@com_github_stretchr_testify//require",
    ],
)
