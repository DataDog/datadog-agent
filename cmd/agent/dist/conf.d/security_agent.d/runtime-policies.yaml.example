- rule:
    id: credential_modified
    description: credential files modified using unknown tool
    expression: >-
      (open.filename == "/etc/shadow" || open.filename == "/etc/gshadow") &&
      process.name not in ["vipw", "vigr"]
    tags:
      mitre: T1003
#- rule:
#    id: credential_read
#    description: credential files modified using unknown tool
#    expression: >-
#      open.filename == "/etc/passwd" && process.name != "vipw"
#    tags:
#      mitre: T1087
- rule:
    id: memory_dump
    description: memory dump
    expression: >-
      open.filename =~ "/proc/*" && open.basename in ["maps", "mem"]
    tags:
      mitre: T1003
- rule:
    id: logs_removed
    description: log entries removed
    expression: >-
      (open.filename =~ "/var/log/*" && open.flags ^ O_TRUNC > 0) ||
      unlink.filename =~ "/var/log/*"
    tags:
      mitre: T1070
- rule:
  id: permissions_changed
  description: permissions change on sensible files
  expression: >-
    chmod.filename =~ "/etc/*" || chmod.filename =~ "/etc/*" ||
    chmod.filename =~ "/sbin/*" || chmod.filename =~ "/usr/sbin/*" ||
    chmod.filename =~ "/usr/local/sbin*" || chmod.filename =~ "/usr/bin/local/*" ||
    chmod.filename =~ "/var/log/*" || chmod.filename =~ "/usr/lib/*"
  tags:
    mitre: T1099
- rule:
    id: times_changed
    description: time change on sensible files
    expression: >-
      utimes.filename =~ "/etc/*" || utimes.filename =~ "/etc/*" ||
      utimes.filename =~ "/sbin/*" || chattr.filename =~ "/usr/sbin/*" ||
      utimes.filename =~ "/usr/local/sbin*" || utimes.filename =~ "/usr/bin/local/*" ||
      utimes.filename =~ "/usr/lib/*"
   tags:
      mitre: T1099
- rule:
    id: file_created
    description: file creation/modification in sensible location
    expression: >-
      (open.filename =~ "/etc/*" || open.filename =~ "/etc/*" ||
      open.filename =~ "/sbin/*" || open.filename =~ "/usr/sbin/*" ||
      open.filename =~ "/usr/local/sbin*" || open.filename =~ "/usr/bin/local/*" ||
      open.filename =~ "/var/log/*" || open.filename =~ "/usr/lib/*") && open.flags ^ O_RDONLY > 0
    tags:
      mitre: T1099
# - rule:
  #  id: bash_history
  #  description: command line history read by another user
  #  expression: >-
  #    open.basename in [".bash_history", ".zsh_history"] &&
  #    (open.uid != process.uid || open.gid != process.gid)
  # tags:
  #    mitre: T1139
# - rule:
  #  id: aws_config
  #  description: aws config file read by another user
  #  expression: >-
  #    open.filename =~ /root/.aws/* &&
  #    (open.uid != process.uid || open.gid != process.gid)
  # tags:
  #    mitre: T1139
# - rule:
  #  id: ssh_keys
  #  description: ssh private key read by another user
  #  expression: >-
  #    open.filename =~ "/root/.ssh/*" &&
  #    (open.uid != process.uid || open.gid != process.gid)
  # tags:
  #    mitre: T1139
- rule:
    id: hidden_file
    description: hidden file creation
    expression: >-
      open.basename =~ ".*" && open.flags & O_CREAT > 0
    tags:
      mitre: T1158
- rule:
    id: setuid_setgid_bits
    description: setuid, setgid binary creation
    expression: >-
      (open.flags & S_ISUID > 0 || open.flags & S_ISGID > 0) &&
      open.flags & O_CREAT > 0
    tags:
      mitre: T1166
- rule:
    id: cron_updated
    description: new cron entry
    expression: >-
      (open.filename =~ "/etc/crontab/*" || open.filename =~ "/etc/cron.d/*") &&
      open.flags ^ O_RDONLY > 0
    tags:
      mitre: T1168
- rule:
    id: kernel_module
    description: new file in kernel module location
    expression: >-
      open.filename =~ "/lib/modules/*" && open.flags & O_CREAT > 0
    tags:
      mitre: T1215
- rule:
    id: systemd_updated
    description: new file in common systemd location
    expression: >-
      (open.filename =~ "/etc/systemd/system/*" || open.filename =~ "/usr/lib/systemd/system/*") &&
      open.flags ^ O_RDONLY > 0
    tags:
      mitre: T1501
# - rule:
  #  id: binary_modified
  #  description: a process is trying to modify its binary
  #  expression: >-
  #    open.inode == process.inode && open.flags & O_CREAT > 0
  # tags:
  #    mitre: T1036
- rule:
    id: remote_copy
    description: remote copy
    expression: >-
      (open.filename =~ "/var/*" || open.filename =~ "/etc/*") &&
      process.name in ["scp", "ftp", "rsync", "sftp", "curl", "wget", "nc"]
    tags:
      mitre: T1105
  - rule:
  id: timestamp_tampering
  description: timestamp tampering attempt
  expression: >-
    utimes.basename =~ "/etc/*"
  tags:
    mitre: T1099
# - rule:
  #  id: container_binary_exec
  #  description: a binary that was not part of the original container image was executed
  #  expression: >-
  #    event.type == "exec" && process.filename =~ "*/diff/*" && process.ns.mount == "dedicated"
# - rule:
  #  id: container_lib_loaded
  #  description: a library that was not part of the original container image was loaded
  #  expression: >-
  #    open.filename =~ "*/diff/*/usr/lib/*" && process.ns.mount == "dedicated"
- rule:
    id: datadog_config
    description: datadog agent configuration modified
    expression: >-
      open.filename =~ "/opt/datadog-agent/*"
