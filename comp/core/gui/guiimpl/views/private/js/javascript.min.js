function sendMessage(e,s,t,n,a){$.ajax({url:window.location.origin+"/"+e.replace(/^\//,""),type:t,data:s,success:function(e,s,t){$("#error").hide(),$("#logged_out").hide(),$("#agent_status").html("Connected<br>to Agent"),$("#agent_status").removeClass("disconnected"),$("#agent_status").addClass("connected");try{n(e,s,t)}catch(e){console.log(e)}},error:function(e,s,t){try{a(e,s,t)}catch(s){console.log(s)}$("#agent_status").html("Not connected<br>to Agent"),$("#agent_status").removeClass("connected"),$("#agent_status").addClass("disconnected"),setError(e.status,e.responseText)}})}function setError(e,s){0==e?s="Unable to contact the Datadog Agent. Please ensure it is running.":401==e&&(s="Not logged in. Please ensure that your GUI session has not expired. (Agent replied with: "+DOMPurify.sanitize(s.trim())+")"),$("#error_content").html("<h3>Error</h3> "+s),401==e&&$("#logged_out").css("display","block"),$("#error").css("display","block")}function attachEditor(e,s){var t=CodeMirror(document.getElementById(e),{lineWrapping:!0,lineNumbers:!0,value:s,mode:"yaml"});return t.setOption("extraKeys",{Tab:function(e){var s=Array(e.getOption("indentUnit")+1).join(" ");e.replaceSelection(s)}}),t}function setupHomePage(){$("#restart_status").hide(),loadStatus("general"),sendMessage("agent/version","","post",(function(e,s,t){$("#version").append(e.Major+"."+e.Minor+"."+e.Patch)})),sendMessage("agent/hostname","","post",(function(e,s,t){$("#hostname").append(JSON.stringify(e))})),setInterval(checkStatus,2e3)}function checkStatus(){void 0===checkStatus.uptime&&(checkStatus.uptime=0),sendMessage("agent/ping","","post",(function(e,s,t){last_ts=parseInt(e),checkStatus.uptime>last_ts&&$("#restart_status").hide(),checkStatus.uptime=last_ts}))}function loadStatus(e){$(".page").css("display","none"),$("#"+e+"_status").css("display","block"),$("#"+e+"_status").html('<i class="fa fa-spinner fa-pulse fa-3x fa-fw center"></i>'),sendMessage("agent/status/"+e,"","post",(function(s,t,n){$("#"+e+"_status").html(DOMPurify.sanitize(s))}))}function loadLog(){$(".page").css("display","none"),$("#logs").css("display","block"),$("#logs").html('<i class="fa fa-spinner fa-pulse fa-3x fa-fw center"></i>'),sendMessage("agent/log/true","","post",(function(e,s,t){"<br>"==e.substring(0,4)&&(e=e.substring(4,e.length)),e=trimData(e),$("#logs").html('<div class="log_title">Agent.log</div><div class="dropdown"><select id="log_view_type"><option value="recent_first" selected>Most recent first</option><option value="old_first">Oldest first</option></select></div><div class="log_data">'+DOMPurify.sanitize(e)+" </div>"),$("#log_view_type").change(changeLogView)}))}function changeLogView(){sendMessage("agent/log/"+("old_first"==$("#log_view_type").val()?"false":"true"),"","post",(function(e,s,t){"<br>"==e.substring(0,4)&&(e=e.substring(4,e.length)),e=trimData(e),$(".log_data").html(e)}))}var extraDataGlobal;function trimData(e){for(var s=200,t=-1;s>0&&t<e.length&&!((t=e.indexOf("<br>",t))<0);)s--,t++;return t>0&&(extraDataGlobal=e.substring(t+3,e.length),e=e.substring(0,t-1),e+="<br><a href='javascript:void(0)' onclick='loadMore()' class='load_more'> Load more </a>"),e}function loadMore(){var e=$(".log_data").html(),s=e.lastIndexOf("<a href=");e=e.substring(0,s),$(".log_data").html(DOMPurify.sanitize(e+trimData(extraDataGlobal)))}function loadSettings(){$(".page").css("display","none"),$("#settings").css("display","block"),$("#settings").html('<div id="settings_input"><div id="submit_settings">Save</div></div>'),sendMessage("agent/getConfig","","post",(function(e,s,t){var n=attachEditor("settings_input",e);$("#submit_settings").click((function(){submitSettings(n)}))}))}function submitSettings(e){var s=e.getValue();sendMessage("agent/setConfig",JSON.stringify({config:s}),"post",(function(e,s,t){$(".success, .unsuccessful, .msg").remove(),"Success"==e?($("#submit_settings").append('<i class="fa fa-check fa-lg success"></i><div class="msg">Restart agent <br> to see changes</div>'),$("#restart_status").show()):$("#submit_settings").append('<i class="fa fa-times fa-lg unsuccessful"></i><div class="msg">'+e+"</div>"),$(".success, .unsuccessful, .msg").delay(5e3).fadeOut("slow")}))}function loadManageChecks(){$(".page").css("display","none"),$("#manage_checks").css("display","block"),checkDropdown()}function loadCheckConfigFiles(){var e=$("<div></div>");sendMessage("checks/listConfigs","","post",(function(s,t,n){if("string"==typeof s)return $("#checks_description").html(DOMPurify.sanitize(s));$("#checks_description").html("Select a check to configure."),s.sort(),s.forEach((function(s){s.endsWith(".example")||s.endsWith(".disabled")||s.endsWith("metrics.yaml")||s.endsWith("auto_conf.yaml")||(s=DOMPurify.sanitize(s),e.append('<a href="javascript:void(0)" onclick="showCheckConfig(\''+s+'\')" class="check">'+s+"</a>"))})),$(".list").html(e.html()),$(".check").click((function(){$(".active_check").removeClass("active_check"),$(this).addClass("active_check")}))}))}function loadNewChecks(){var e=$("<div></div>"),s=[];sendMessage("checks/listConfigs","","post",(function(t,n,a){"string"!=typeof t&&(t.sort(),t.forEach((function(e){if(!(e.endsWith(".example")||e.endsWith(".disabled")||e.endsWith("metrics.yaml")||e.endsWith("auto_conf.yaml"))){var t=e.substr(0,e.indexOf("."));s.push(t)}})),sendMessage("checks/listChecks","","post",(function(t,n,a){if("string"==typeof t)return $("#checks_description").html(DOMPurify.sanitize(t));$("#checks_description").html("Select a check to add."),t.sort(),t.forEach((function(t){var n;n=".py"==t.substr(t.length-3)?t.substr(0,t.length-3):t,-1==s.indexOf(n)&&e.append('<a href="javascript:void(0)" onclick="addCheck(\''+DOMPurify.sanitize(n)+'\')" class="check">'+DOMPurify.sanitize(t)+"</a>")})),$(".list").html(e.html()),$(".check").click((function(){$(".active_check").removeClass("active_check"),$(this).addClass("active_check")}))})))}))}function checkDropdown(){var e=$("#checks_dropdown").val();$(".right").html(""),"enabled"==e?loadCheckConfigFiles():"add"==e&&loadNewChecks()}function showCheckConfig(e){-1!=e.indexOf(".default")?$("#checks_description").html("Changing a default configuration file creates a new, non-default configuration file."):$("#checks_description").html("Edit the configuration file, then save and reload."),sendMessage("checks/getConfig/"+e,"","post",(function(s,t,n){$(".right").html('<div id="check_input"><div id="save_check">Save</div><div id="disable_check">Disable</div></div>'),$("#check_input").data("file_name",e);var a=attachEditor("check_input",s);$("#save_check").click((function(){saveCheckSettings(a)})),$("#disable_check").click((function(){disableCheckSettings(a)}))}))}function saveCheckSettings(e){var s=e.getValue(),t=$("#check_input").data("file_name");".default"==t.substr(t.length-8)&&(t=t.substr(0,t.length-8)),sendMessage("checks/setConfig/"+t,JSON.stringify({config:s}),"post",(function(e,s,n){$(".success, .unsuccessful").remove(),"Success"==e?($("#save_check").append('<i class="fa fa-check fa-lg success"></i>'),$(".success").delay(3e3).fadeOut("slow"),$("#checks_description").html("Restart agent to apply changes."),$("#check_input").data("file_name",t),$(".active_check").html(t),$("#restart_status").show()):($("#save_check").append('<i class="fa fa-times fa-lg unsuccessful"></i>'),$(".unsuccessful").delay(3e3).fadeOut("slow"),$("#checks_description").html(DOMPurify.sanitize(e)))}))}function disableCheckSettings(e){var s=e.getValue(),t=$("#check_input").data("file_name");sendMessage("checks/setConfig/"+t,JSON.stringify({config:s}),"delete",(function(e,s,n){$(".success, .unsuccessful").remove(),"Success"==e?($("#disable_check").append('<i class="fa fa-check fa-lg success"></i><div class="msg">Restart agent <br> to make change effective</div>'),$("#restart_status").show(),$(".success").delay(3e3).fadeOut("slow"),$("#checks_description").html("Disable check."),$("#save_check").addClass("inactive"),$("#disable_check").addClass("inactive"),$("#check_input").data("file_name",t),$(".active_check").html(t),loadCheckConfigFiles()):($("#disable_check").append('<i class="fa fa-times fa-lg unsuccessful"></i>'),$(".unsuccessful").delay(3e3).fadeOut("slow"),$("#checks_description").html(DOMPurify.sanitize(e)))}))}function addCheck(e){sendMessage("checks/listConfigs","","post",(function(s,t,n){var a="",i="";"string"!=typeof s&&s.forEach((function(s){var t=s.substr(0,s.indexOf("."));".example"==s.substr(s.length-8)&&e==t&&(a=s),".disabled"==s.substr(s.length-9)&&e==t&&(i=s)})),""!=i?sendMessage("checks/getConfig/"+i,"","post",(function(s,t,n){createNewConfigFile(e,s)})):""!=a?sendMessage("checks/getConfig/"+a,"","post",(function(s,t,n){createNewConfigFile(e,s)})):createNewConfigFile(e,"# Add your configuration here")}))}function createNewConfigFile(e,s){$("#checks_description").html("Please create a new configuration file for this check below."),$(".right").html('<div id="new_config_input"><div id="add_check">Add Check</div></div>');var t=attachEditor("new_config_input",s);$("#add_check").click((function(){$("#add_check").css("pointer-events","none");var s=t.getValue();sendMessage("checks/setConfig/"+e+".d/conf.yaml",JSON.stringify({config:s}),"post",(function(e,s,t){if("Success"!=e)return $("#checks_description").html(DOMPurify.sanitize(e)),$("#add_check").append('<i class="fa fa-times fa-lg unsuccessful"></i>'),$(".unsuccessful").delay(3e3).fadeOut("slow"),void $("#add_check").css("pointer-events","auto");$("#restart_status").show(),checkDropdown()}))}))}function seeRunningChecks(){$(".page").css("display","none"),$("#running_checks").css("display","block"),sendMessage("checks/running","","post",(function(e,s,t){$("#running_checks").html(DOMPurify.sanitize(e))}))}function loadFlare(){$(".page").css("display","none"),$("#flare, .flare_input").css("display","block"),$("#flare_description").html("Your logs and configuration files will be collected and sent to Datadog Support.")}function submitFlare(){var e=$("#ticket_num").val();""==e&&(e="0");var s=$("#email").val();/\S+@\S+\.\S+/.test(s)?sendMessage("agent/flare",JSON.stringify({email:s,caseID:e}),"post",(function(e,s,t){$("#ticket_num").val(""),$("#email").val(""),$(".flare_input").css("display","none"),$("#flare_description").html(DOMPurify.sanitize(e))})):$("#flare_description").html("Please enter a valid email address.")}function restartAgent(){$(".page").css("display","none"),$(".active").removeClass("active"),$("#main").append('<i class="fa fa-spinner fa-pulse fa-3x fa-fw center loading_spinner"></i>'),$("#agent_status").html("Not connected<br>to Agent"),$("#agent_status").removeClass("connected"),$("#agent_status").addClass("disconnected"),$("#restart_button").css("pointer-events","none"),sendMessage("agent/restart","","post",(function(e,s,t){setTimeout((function(){$(".loading_spinner").remove(),$("#restart_button").css("pointer-events","auto"),"Success"!=e?($("#general_status").css("display","block"),$("#general_status").html("<span class='center'>Error restarting agent: "+DOMPurify.sanitize(e)+"</span>")):($("#restart_status").hide(),loadStatus("general"))}),1e4)}),(function(e,s,t){$(".loading_spinner").remove(),$("#general_status").css("display","block"),$("#restart_button").css("pointer-events","auto")}))}String.prototype.endsWith||(String.prototype.endsWith=function(e,s){return(void 0===s||s>this.length)&&(s=this.length),this.substring(s-e.length,s)===e}),$(document).ready((function(){$(".nav_item").click((function(){$(this).hasClass("multi")||$(this).hasClass("no-active")||($(".active").removeClass("active"),$(this).addClass("active"))})),$(".side_menu_item").click((function(){$(".active").removeClass("active"),$(this).closest(".nav_item").addClass("active")})),$("#settings_button").click(loadSettings),$("#flare_button").click(loadFlare),$("#checks_dropdown").change(checkDropdown),$("#submit_flare").click(submitFlare),$("#log_button").click(loadLog),$("#restart_button").click(restartAgent),setupHomePage()}));