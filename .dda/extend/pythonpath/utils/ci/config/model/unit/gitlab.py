from __future__ import annotations

from typing import Annotated, Literal

from msgspec import Meta, Struct, field

from utils.ci.config.model.unit.common import CIUnitProviderConfig, default_settings


class GitLabPipeline(Struct, tag_field="source", **default_settings): ...


class StaticGitLabPipeline(GitLabPipeline, tag="file", **default_settings):
    """
    A static pipeline is defined in a file.
    """

    path: Annotated[
        str,
        Meta(
            min_length=1,
            # Enforce relative paths by making sure that the path does not start with
            # a slash nor a dot followed by a slash.
            pattern=r"^(?!/|\.\/).+$",
            description="The path to the pipeline YAML file relative to the repository root",
        ),
    ]


class DynamicGitLabPipeline(GitLabPipeline, tag="command", **default_settings):
    """
    A dynamic pipeline is generated by a command.
    """

    command: Annotated[
        str,
        Meta(
            min_length=1,
            description="The command that outputs the pipeline YAML file contents e.g. `cat pipeline.yml`",
        ),
    ]


class ConstrainedWorkflowRule(Struct, **default_settings):
    """
    A constrained [workflow rule](https://docs.gitlab.com/ci/yaml/#workflowrules) for a unit's pipeline.
    """

    when: Annotated[
        Literal["always", "never"],
        Meta(description="Whether the unit should run when the rule is met"),
    ] = "always"
    if_: Annotated[
        str,
        Meta(
            min_length=1,
            description="A condition that must be met for the rule to apply e.g. `$CI_COMMIT_BRANCH == \"main\"`",
        ),
    ] = field(name="if", default="")


class GitLabUnitProviderConfig(CIUnitProviderConfig, tag="gitlab", **default_settings):
    """
    GitLab provider configuration for a unit.
    """

    pipeline: Annotated[
        StaticGitLabPipeline | DynamicGitLabPipeline,
        Meta(description="The pipeline configuration, whose schema depends on the `source` field e.g. file or command"),
    ]
    rules: Annotated[
        list[ConstrainedWorkflowRule],
        Meta(description="Constrained workflow rules that determine when the unit will run"),
    ] = []
