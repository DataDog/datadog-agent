# Do not edit this file without a review from @DataDog/agent-build

# ADMS config ----------------------------------------------------------------------------------------------------------
# Ensure access to DataDog internal artifact repositories in CI
import %workspace%/.adms/adms.bazelrc

# Use --config=adms to use adms for upstream dependency caching.
# TOOD: rename dd-internal in the .adms tree to adms-internal. That
# will be easier to understand.
common:adms --config=dd-internal

# Startup options ------------------------------------------------------------------------------------------------------
startup --max_idle_secs=28800 # Keep the server alive for at most 8 hours of inactivity

# Common options -------------------------------------------------------------------------------------------------------
common --@rules_python//python/config_settings:bootstrap_impl=script # https://github.com/bazel-contrib/rules_python/blob/main/BZLMOD_SUPPORT.md
common --check_direct_dependencies=error # Escalate any bypassed `bazel_dep` to a resolution failure
common --enable_platform_specific_config # Supported OS identifiers are linux, macos, windows, freebsd, and openbsd
common --experimental_ui_max_stdouterr_bytes=1073741819 # why?
common --http_timeout_scaling=3.0 # At least one attempt reaches 30s (3,6,12,24,30,30,30,30) instead of only 10s (1,2,4,8,10,10,10,10)
common --incompatible_strict_action_env # Do not leak local environment variables into the build context
common --test_output=errors # Print test errors to console output instead of only capturing them in buried test.log
common --verbose_failures

# Linux config ---------------------------------------------------------------------------------------------------------
common:linux --strategy=sandboxed
common:linux --remote_local_fallback_strategy=sandboxed

# macOS config ---------------------------------------------------------------------------------------------------------
common:macos --features=-macos_default_link_flags # https://github.com/bazelbuild/bazel/issues/23312
common:macos --macos_minimum_os=11.0 # Keep in sync with https://docs.datadoghq.com/agent/supported_platforms/?tab=macos
common:macos --strategy=sandboxed
common:macos --remote_local_fallback_strategy=sandboxed

# Windows config -------------------------------------------------------------------------------------------------------
common:windows --strategy=standalone # Valid values are: [dynamic_worker, standalone, dynamic, remote, worker, local]
# For whatever reason if convenience symlinks are present, the build fails on Windows.
common:windows --noexperimental_convenience_symlinks
# Neither repo_env nor shell_executable affect action keys. It can be both an advantage and a disadvantage.
# For instance, if we need to have some special behavior in bash we can add it, however, in some cases
# it may lead to cache poisoning.
common:windows --repo_env=BAZEL_SH=C:/tools/msys64/usr/bin/bash.exe # for https://github.com/bazelbuild/bazel/pull/26927
common:windows --shell_executable=C:/tools/msys64/usr/bin/bash.exe

# Remote cache config --------------------------------------------------------------------------------------------------
# datadog-agent virtually isolates caching instance from its parent (which is remote-caching).
# If entry isn't found in datadog-agent, it will be searched in remote-caching.
# Fallback doesn't work for --remote_cache, therefore, setting --remote_executor and --strategy to sandboxed
# to use cache capabilities in combination with sandboxing.
common:cache --remote_executor=grpcs://buildbarn-frontend.us1.ddbuild.io:443
common:cache --remote_instance_name=ci/datadog-agent
common:cache --remote_local_fallback # best-effort on transient connection errors (no such host)
common:cache --remote_retries=1
common:cache --remote_timeout=60

# CI config ------------------------------------------------------------------------------------------------------------
common:ci --config=adms
common:ci --config=cache
common:ci --noexperimental_convenience_symlinks # not CI-suitable: "These symlinks are only for the user's convenience"

# For Rust targets, enable clippy and rustfmt checks during the build
build:ci --aspects=@rules_rust//rust:defs.bzl%rust_clippy_aspect
build:ci --output_groups=+clippy_checks
build:ci --aspects=@rules_rust//rust:defs.bzl%rustfmt_aspect
build:ci --output_groups=+rustfmt_checks

# Project configs --------------------------------------------------------------------------------------
import %workspace%/bazel/configs/sdagent.bazelrc
import %workspace%/bazel/configs/procmgrd.bazelrc

# Local development options --------------------------------------------------------------------------------------------
try-import %workspace%/user.bazelrc
