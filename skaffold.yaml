apiVersion: skaffold/v4beta11
kind: Config
metadata:
  name: datadog-agent
build:
  platforms: [ "linux/arm64" ]
  tagPolicy:
    gitCommit: {
        variant: "AbbrevCommitSha"
    }
  local:
    push: false
    concurrency: 0
deploy:
  helm:
    releases:
      - name: datadog-agent
        remoteChart: datadog/datadog
        version: 3.141.0
        # valuesFiles: ["your/custom/datadog-agent/values.yaml"]
        setValueTemplates:
          datadog:
            apiKey: "{{cmd \"bash\" \"-c\" \"echo $DD_API_KEY\"}}"
            appKey: "{{cmd \"bash\" \"-c\" \"echo $DD_APP_KEY\"}}"
            kubelet:
              tlsVerify: false
          agents.image:
            repository: "{{.IMAGE_REPO_agent}}"
            tag: "{{.IMAGE_TAG_agent}}@{{.IMAGE_DIGEST_agent}}"
            doNotCheckTag: true
          clusterAgent:
            image:
              repository: "{{.IMAGE_REPO_clusteragent}}"
              tag: "{{.IMAGE_TAG_clusteragent}}"
              doNotCheckTag: true
          clusterCheckRunner.image:
            repository: "{{.IMAGE_REPO_agent}}"
            tag: "{{.IMAGE_TAG_agent}}"
            doNotCheckTag: true
profiles:
  - name: devcontainer
    activation:
      - kubeContext: kind
        command: dev
        env: "SKAFFOLD_KIND_BUILD_TYPE=devcontainer"
    requiresAllActivations: true
    build:
      artifacts:
        - image: agent
          custom:
            buildCommand: "docker exec -t $DEVENV_CONTAINER_NAME /bin/bash -c \"
              export DOCKER_DEFAULT_PLATFORM=$DOCKER_DEFAULT_PLATFORM &&
              cd go/src/github.com/DataDog/datadog-agent &&
              dda inv agent.hacky-dev-image-build --target-image=$IMAGE_REPO:$IMAGE_TAG\""
        - image: clusteragent
          custom:
            buildCommand: "docker exec -t $DEVENV_CONTAINER_NAME /bin/bash -c \"
              export DOCKER_DEFAULT_PLATFORM=$DOCKER_DEFAULT_PLATFORM &&
              cd go/src/github.com/DataDog/datadog-agent &&
              dda inv cluster-agent.hacky-dev-image-build --target-image=$IMAGE_REPO:$IMAGE_TAG\""
  - name: kind
    activation:
    - kubeContext: kind
      command: dev
      env: "SKAFFOLD_KIND_BUILD_TYPE=local"
    requiresAllActivations: true
    build:
      artifacts:
      - image: agent
        custom:
          buildCommand: "dda inv agent.hacky-dev-image-build --target-image=$IMAGE"
      - image: clusteragent
        custom:
          buildCommand: "dda inv cluster-agent.hacky-dev-image-build --target-image=$IMAGE"
  - name: minikube
    activation:
    - kubeContext: minikube
      command: dev
    build:
      artifacts:
      - image: agent
        custom:
          buildCommand: "docker exec datadog-agent-devcontainer bash -c \"
            dda inv agent.hacky-dev-image-build --target-image=$IMAGE\""
      - image: clusteragent
        custom:
          buildCommand: "docker exec datadog-agent-devcontainer bash -c \"
            dda inv cluster-agent.hacky-dev-image-build --target-image=$IMAGE\""
