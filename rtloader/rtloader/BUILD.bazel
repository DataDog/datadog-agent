load("@rules_cc//cc:cc_library.bzl", "cc_library")
load("@rules_cc//cc:cc_shared_library.bzl", "cc_shared_library")
load("//bazel/rules:dd_agent_expand_template.bzl", "dd_agent_expand_template")
load("//bazel/rules:so_symlink.bzl", "so_symlink")
load("//rtloader:defs.bzl", "COMMON_CXXOPTS", "COMMON_COPTS", "COMMON_DEFINES")

package(default_visibility = ["//rtloader:__pkg__"])

VERSION = "0.1.0"

dd_agent_expand_template(
    name = "pc_gen",
    out = "datadog-agent-rtloader.pc",
    substitutions = {
        "@CMAKE_INSTALL_PREFIX@": "{install_dir}/embedded",
        "@CMAKE_INSTALL_LIBDIR@": "lib",
        "@CMAKE_INSTALL_INCLUDEDIR@": "include",
        "@PROJECT_NAME@": "datadog-agent-rtloader",
        "@PROJECT_VERSION@": "0.1.0",
        "@PROJECT_DESCRIPTION@": "CPython backend for the Datadog Agent",
    },
    template = "datadog-agent-rtloader.pc.in",
)

cc_library(
    name = "rtloader",
    srcs = [
        "api.cpp",
        "rtloader.cpp",
        "//rtloader/common:rtloader_mem.c",
    ],
    cxxopts = COMMON_CXXOPTS,
    copts = COMMON_COPTS,
    hdrs = [
        "//rtloader/include",
    ],
    includes = ["."],
    linkopts = [
        # Make up for the fact that we may be using gcc and not g++
        "-lstdc++",
    ],
    local_defines = COMMON_DEFINES + select({
        "@platforms//os:windows": [
            "_hypot=hypot",
        ],
        "@platforms//os:linux": [
            # backtrace / execinfo.h is provided by glibc 2.1+ so we know it to be available
            "HAS_BACKTRACE_LIB",
        ],
        "@platforms//os:macos": [
            # backtrace / execinfo.h is provided by the macOS libc since Mac OS X 10.5
            # https://manp.gs/mac/3/backtrace#HISTORY
            "HAS_BACKTRACE_LIB",
        ],
        "//conditions:default": [],
    }),
    visibility = ["//rtloader:__subpackages__"],
    deps = [
        "//rtloader/common:headers",
        "//rtloader/include",
    ],
)

cc_shared_library(
    name = "datadog-agent-rtloader",
    deps = [":rtloader"],
    visibility = ["//rtloader:__subpackages__"],
)

so_symlink(
    name = "lib_files",
    src = ":datadog-agent-rtloader",
    libname = "libdatadog-agent-rtloader",
    prefix = "embedded",
    version = VERSION,
)

# buildifier: disable=no-effect
"""
Remaining work:

# https://cmake.org/cmake/help/latest/module/FindBacktrace.html
find_package(Backtrace)
if(Backtrace_FOUND)
    if(NOT TARGET Backtrace::Backtrace)
        # for pre-3.30 CMake versions
        add_library(Backtrace::Backtrace INTERFACE IMPORTED)
        set_target_properties(Backtrace::Backtrace PROPERTIES
            INTERFACE_LINK_LIBRARIES "${Backtrace_LIBRARIES}"
            INTERFACE_INCLUDE_DIRECTORIES "${Backtrace_INCLUDE_DIRS}"
        )
    endif()
    target_link_libraries(datadog-agent-rtloader PRIVATE Backtrace::Backtrace)
    target_compile_definitions(datadog-agent-rtloader PRIVATE HAS_BACKTRACE_LIB)
endif()
endif()

install(TARGETS datadog-agent-rtloader
    RUNTIME DESTINATION bin
    LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
    PUBLIC_HEADER DESTINATION include
    ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}
)

# Windows builder assumes libdatadog-agent-rtloader.a is located in rtloader/rtloader folder.
if (WIN32)
ADD_CUSTOM_COMMAND(
    TARGET datadog-agent-rtloader
    POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E copy ${PROJECT_BINARY_DIR}/libdatadog-agent-rtloader.a ${PROJECT_SOURCE_DIR}/libdatadog-agent-rtloader.a
)
endif()
"""
