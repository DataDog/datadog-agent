cc_binary(
    name = "datadog-agent-three",
    srcs = [
        "three/three.cpp",
        "three/three.h",
        "three/three_mem.cpp",
        "common/cgo_free.h",
        "common/cgo_free.c",
        "common/log.c",
        "common/log.h",
        "common/rtloader_mem.c",
        "common/rtloader_mem.h",
        "common/stringutils.c",
        "common/stringutils.h",
        "common/builtins/_util.c",
        "common/builtins/_util.h",
        "common/builtins/aggregator.c",
        "common/builtins/aggregator.h",
        "common/builtins/containers.c",
        "common/builtins/containers.h",
        "common/builtins/datadog_agent.c",
        "common/builtins/datadog_agent.h",
        "common/builtins/kubeutil.c",
        "common/builtins/kubeutil.h",
        "common/builtins/tagger.c",
        "common/builtins/tagger.h",
        "common/builtins/util.c",
        "common/builtins/util.h",
        "rtloader/rtloader.cpp",
        "include/rtloader_types.h",
        "include/rtloader.h",
    ],
    local_defines = [
        'DATADOG_AGENT_THREE',
    ],
    deps = [
        "//deps/python3",
        ":constants_header",
    ],
    copts = [
        "-Irtloader/include",
        "-Irtloader/common",
        "-Irtloader/common/builtins",
    ],
    linkshared = True,
    visibility = ["//visibility:public"],
)

genrule(
    name = "constants_h",
    srcs = ["three/constants.h.in"],
    outs = ["constants.h"],
    cmd_bash = """
    sed -E 's/@Python3_STDLIB@/../g' $< > $@
    """,
)

cc_library(
    name = "constants_header",
    hdrs = [":constants_h"],
    includes = ["."],
)

cc_library(
    name = "rtloader",
    srcs = [
        "rtloader/api.cpp",
        "rtloader/rtloader.cpp",
        "include/datadog_agent_rtloader.h",
        "include/rtloader.h",
        "include/rtloader_types.h",
        "common/rtloader_mem.c",
        "common/rtloader_mem.h",
    ],
    hdrs = [
        "include/datadog_agent_rtloader.h",
        "include/rtloader.h",
        "include/rtloader_types.h",
        "common/rtloader_mem.h",
    ],
    includes = [
        "include",
        "common",
    ],
    copts = [
        "-Irtloader/common",
    ],
    visibility = ["//visibility:public"],
)
