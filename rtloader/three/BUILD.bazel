load("@pythons_hub//:versions.bzl", "DEFAULT_PYTHON_VERSION")
load("@rules_cc//cc:cc_library.bzl", "cc_library")
load("@rules_pkg//pkg:mappings.bzl", "pkg_files")
load("//bazel/rules:dd_agent_expand_template.bzl", "dd_agent_expand_template")
load("//rtloader:defs.bzl", "COMMON_DEFINES")

# opts and defines come from omnibus/config/software/datadog-agent.rb, in
# the rtloader section. E.g.
#   dda inv -- -e rtloader.make --install-prefix /opt/datadog-agent/embedded \
#     --cmake-options '-DCMAKE_CXX_FLAGS:="-D_GLIBCXX_USE_CXX11_ABI=0" \
#     -DCMAKE_INSTALL_LIBDIR=lib -DCMAKE_FIND_FRAMEWORK:STRING=NEVER

# TODO: Figure out what to do with this.
# project(datadog-agent-three VERSION 0.1.0 DESCRIPTION "CPython backend for the Datadog Agent")

dd_agent_expand_template(
    name = "constants_gen",
    out = "constants.h",
    substitutions = {
        "@Python3_STDLIB@": "{install_dir}/embedded/lib/python%s" % DEFAULT_PYTHON_VERSION,
    },
    template = "constants.h.in",
)

cc_library(
    name = "three",
    srcs = [
        "three.cpp",
        "three_mem.cpp",
        ":constants.h",
        "//rtloader/common:builtins/_util.c",
        "//rtloader/common:builtins/_util.h",
        "//rtloader/common:builtins/aggregator.c",
        "//rtloader/common:builtins/aggregator.h",
        "//rtloader/common:builtins/containers.c",
        "//rtloader/common:builtins/containers.h",
        "//rtloader/common:builtins/datadog_agent.c",
        "//rtloader/common:builtins/datadog_agent.h",
        "//rtloader/common:builtins/kubeutil.c",
        "//rtloader/common:builtins/kubeutil.h",
        "//rtloader/common:builtins/tagger.c",
        "//rtloader/common:builtins/tagger.h",
        "//rtloader/common:builtins/util.c",
        "//rtloader/common:builtins/util.h",
        "//rtloader/common:cgo_free.c",
        "//rtloader/common:cgo_free.h",
        "//rtloader/common:log.c",
        "//rtloader/common:log.h",
        "//rtloader/common:rtloader_mem.h",
        "//rtloader/common:stringutils.c",
        "//rtloader/common:stringutils.h",
    ],
    hdrs = [
        "three.h",
    ],
    copts = [
        "-Wno-unused-function",
        "-I.",
        "-O2",
    ] + select({
        "@platforms//os:linux": [
            "-Wsign-compare",
        ],
        "@platforms//os:macos": [
            "-Wno-implicit-function-declaration",
            "-Wno-int-conversion",
        ],
        "@platforms//os:windows": [
            # TODO: only set if MSVC
            "/MT",
        ],
    }),
    includes = [
        ".",
        "/rtloader/common",
        "/rtloader/include",
    ],
    local_defines = COMMON_DEFINES + select({
        "@platforms//os:windows": [
            # TODO: only set if not MSVC. But it might be OK do to anyway.
            "_hypot=hypot",
            "DATADOG_AGENT_THREE",
        ],
        "//conditions:default": [
            "DATADOG_AGENT_THREE",
        ],
    }),
    visibility = ["//rtloader:__subpackages__"],
    deps = [
        "//rtloader/common:headers",
        "//rtloader/include",
        "@rules_python//python/cc:current_py_cc_headers",
    ],
)

# TODO: We comment this out for now so we can test with bazel build ...
#cc_shared_library(
#    name = "datadog-agent-three",
#    deps = [
#        ":three",
#    ],
#    dynamic_deps = [
#        # TODO: point to embedded/libpython
#    ],
#    visibility = ["//rtloader:__subpackages__"],
#)

pkg_files(
    name = "lib_files",
    srcs = [
        # TODO: replace with shared lib
        ":three",
    ],
    prefix = "embedded/lib",
    visibility = ["//rtloader:__subpackages__"],
)

# buildifier: disable=no-effect
"""

Remaining  work:

if(WIN32)
  install(TARGETS datadog-agent-three
      RUNTIME DESTINATION ${CMAKE_INSTALL_LIBDIR}
  )
else()
  target_compile_options(datadog-agent-three PRIVATE "-Wno-deprecated-register")
  install(TARGETS datadog-agent-three
      LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
  )
endif()

if(WIN32)
  set_target_properties(datadog-agent-three PROPERTIES LINK_FLAGS -static)
elseif(APPLE)
  set_target_properties(datadog-agent-three PROPERTIES INSTALL_RPATH_USE_LINK_PATH TRUE)
endif()

add_compile_definitions(DATADOG_AGENT_THREE)
target_include_directories(datadog-agent-three PRIVATE .)
target_include_directories(datadog-agent-three PUBLIC
    ${CMAKE_SOURCE_DIR}/include
    ${CMAKE_SOURCE_DIR}/common
    ${CMAKE_SOURCE_DIR}/common/builtins
    ${Python3_INCLUDE_DIRS}
)
target_link_libraries(datadog-agent-three ${Python3_LIBRARIES} datadog-agent-rtloader)
"""
