.agent_build_common_deb:
  artifacts:
    expire_in: 2 weeks
    paths:
    - $OMNIBUS_PACKAGE_DIR
  script:
  - echo "About to build for $RELEASE_VERSION"
  - rm -rf $OMNIBUS_PACKAGE_DIR/*
  - $S3_CP_CMD $S3_ARTIFACTS_URI/system-probe.${PACKAGE_ARCH} /tmp/system-probe
  - chmod 755 /tmp/system-probe
  - $S3_CP_CMD $S3_ARTIFACTS_URI/libbcc-${PACKAGE_ARCH}.tar.xz /tmp/libbcc.tar.xz
  - inv -e agent.omnibus-build --release-version "$RELEASE_VERSION" --major-version
    "$AGENT_MAJOR_VERSION" --python-runtimes "$PYTHON_RUNTIMES" --base-dir $OMNIBUS_BASE_DIR
    ${USE_S3_CACHING} --skip-deps --system-probe-bin=/tmp/system-probe --libbcc-tarball=/tmp/libbcc.tar.xz
  - $S3_CP_CMD $OMNIBUS_BASE_DIR/pkg/datadog-agent_*_${PACKAGE_ARCH}.deb $S3_ARTIFACTS_URI/$DESTINATION_DEB
  - $S3_CP_CMD $OMNIBUS_BASE_DIR/pkg/datadog-agent-dbg_*_${PACKAGE_ARCH}.deb $S3_ARTIFACTS_URI/$DESTINATION_DBG_DEB
  - mkdir -p $OMNIBUS_PACKAGE_DIR && cp $OMNIBUS_BASE_DIR/pkg/datadog-agent*_${PACKAGE_ARCH}.deb{,.metadata.json}
    $OMNIBUS_PACKAGE_DIR
.agent_build_common_rpm:
  artifacts:
    expire_in: 2 weeks
    paths:
    - $OMNIBUS_PACKAGE_DIR
  script:
  - echo "About to build for $RELEASE_VERSION"
  - rm -rf $OMNIBUS_PACKAGE_DIR/*
  - set +x
  - RPM_GPG_KEY=$(aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.rpm_signing_private_key_e09422b3
    --with-decryption --query "Parameter.Value" --out text)
  - printf -- "$RPM_GPG_KEY" | gpg --import --batch
  - export RPM_SIGNING_PASSPHRASE=$(aws ssm get-parameter --region us-east-1 --name
    ci.datadog-agent.rpm_signing_key_passphrase_e09422b3 --with-decryption --query
    "Parameter.Value" --out text)
  - set -x
  - $S3_CP_CMD $S3_ARTIFACTS_URI/system-probe.${PACKAGE_ARCH} /tmp/system-probe
  - chmod 755 /tmp/system-probe
  - $S3_CP_CMD $S3_ARTIFACTS_URI/libbcc-${PACKAGE_ARCH}.tar.xz /tmp/libbcc.tar.xz
  - inv -e agent.omnibus-build --release-version "$RELEASE_VERSION" --major-version
    "$AGENT_MAJOR_VERSION" --python-runtimes "$PYTHON_RUNTIMES" --base-dir $OMNIBUS_BASE_DIR  ${USE_S3_CACHING}
    --skip-deps --system-probe-bin=/tmp/system-probe --libbcc-tarball=/tmp/libbcc.tar.xz
  - find $OMNIBUS_BASE_DIR/pkg -type f -name '*.rpm' ! -name '*dbg*.rpm' -print0 |
    xargs -0 -I '{}' rpm -i '{}'
  - find $OMNIBUS_BASE_DIR/pkg -type f -name '*dbg*.rpm' -print0 | xargs -0 -I '{}'
    rpm -i '{}'
  - mkdir -p $OMNIBUS_PACKAGE_DIR && cp $OMNIBUS_BASE_DIR/pkg/*.{rpm,metadata.json}
    $OMNIBUS_PACKAGE_DIR
.agent_build_common_suse_rpm:
  artifacts:
    expire_in: 2 weeks
    paths:
    - $OMNIBUS_PACKAGE_DIR_SUSE
  script:
  - echo "About to build for $RELEASE_VERSION"
  - rm -rf $OMNIBUS_PACKAGE_DIR_SUSE/*
  - set +x
  - RPM_GPG_KEY=$(aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.rpm_signing_private_key_e09422b3
    --with-decryption --query "Parameter.Value" --out text)
  - printf -- "$RPM_GPG_KEY" | gpg --import --batch
  - export RPM_SIGNING_PASSPHRASE=$(aws ssm get-parameter --region us-east-1 --name
    ci.datadog-agent.rpm_signing_key_passphrase_e09422b3 --with-decryption --query
    "Parameter.Value" --out text)
  - set -x
  - $S3_CP_CMD $S3_ARTIFACTS_URI/system-probe.${PACKAGE_ARCH} /tmp/system-probe
  - chmod 755 /tmp/system-probe
  - $S3_CP_CMD $S3_ARTIFACTS_URI/libbcc-${PACKAGE_ARCH}.tar.xz /tmp/libbcc.tar.xz
  - inv -e agent.omnibus-build --release-version "$RELEASE_VERSION" --major-version
    "$AGENT_MAJOR_VERSION" --python-runtimes "$PYTHON_RUNTIMES" --base-dir $OMNIBUS_BASE_DIR_SUSE
    ${USE_S3_CACHING} --skip-deps --system-probe-bin=/tmp/system-probe --libbcc-tarball=/tmp/libbcc.tar.xz
  - find $OMNIBUS_BASE_DIR_SUSE/pkg -type f -name '*.rpm' ! -name '*dbg*.rpm' -print0
    | xargs -0 -I '{}' zypper in '{}'
  - find $OMNIBUS_BASE_DIR_SUSE/pkg -type f -name '*dbg*.rpm' -print0 | xargs -0 -I
    '{}' zypper in '{}'
  - mkdir -p $OMNIBUS_PACKAGE_DIR_SUSE && cp $OMNIBUS_BASE_DIR_SUSE/pkg/*.{rpm,metadata.json}
    $OMNIBUS_PACKAGE_DIR_SUSE
.build_libbcc_common:
  needs:
  - fail_on_non_triggered_tag
  script:
  - git clone -b "$BCC_VERSION" --depth=1 https://github.com/iovisor/bcc.git /tmp/bcc
  - mkdir /tmp/bcc/build
  - cd /tmp/bcc/build
  - cmake .. -DCMAKE_INSTALL_PREFIX=/opt/libbcc -DCMAKE_EXE_LINKER_FLAGS='-Wl,-rpath,/opt/datadog-agent/embedded/lib'
    -DCMAKE_SHARED_LINKER_FLAGS='-Wl,-rpath,/opt/datadog-agent/embedded/lib'
  - make -j 4
  - make install
  - cd /opt/libbcc
  - chmod go-rwx lib/libbcc*
  - rm share/bcc/introspection/bps
  - cp $(ldd lib/libbcc.so | awk '$1 ~ /^libtinfo/ {system("dirname " $3)}')/libtinfo*
    lib
  - tar cvaf /tmp/libbcc.tar.xz .
  - $S3_CP_CMD /tmp/libbcc.tar.xz $S3_ARTIFACTS_URI/libbcc-$ARCH.tar.xz
  stage: deps_build
.cluster_agent-build_common:
  needs:
  - run_go_tidy_check
  script:
  - inv -e cluster-agent.build
  - $S3_CP_CMD $SRC_PATH/$CLUSTER_AGENT_BINARIES_DIR/datadog-cluster-agent $S3_ARTIFACTS_URI/datadog-cluster-agent.$ARCH
  - $S3_CP_CMD $SRC_PATH/Dockerfiles/cluster-agent/datadog-cluster.yaml $S3_ARTIFACTS_URI/datadog-cluster.yaml
  stage: binary_build
.delete_docker_tag:
  before_script:
  - DOCKER_REGISTRY_LOGIN=$(aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.$DOCKER_REGISTRY_LOGIN_SSM_KEY
    --with-decryption --query "Parameter.Value" --out text)
  - PASS=$(aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.$DOCKER_REGISTRY_PWD_SSM_KEY
    --with-decryption --query "Parameter.Value" --out text)
  - pip install -r requirements.txt
  - 'export DOCKER_TOKEN=`curl -s -H "Content-Type: application/json" -X POST -d ''{"username":
    "''$DOCKER_REGISTRY_LOGIN''", "password": "''$PASS''"}'' https://hub.docker.com/v2/users/login/
    | python -c ''import sys, json; print(json.load(sys.stdin)["token"].strip())''`

    '
  dependencies: []
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/docker-notary:0.6.1
  script:
  - if [[ -z "$IMAGE" ]]; then echo "Need an image"; exit 1; fi
  - if [[ -z "$TAG" ]]; then echo "Need a tag to delete"; exit 1; fi
  - inv -e docker.delete ${ORGANIZATION} ${IMAGE} ${TAG} ${DOCKER_TOKEN} &>/dev/null
  stage: source_test
  tags:
  - runner:docker
  - size:large
  variables:
    DELEGATION_KEY_SSM_KEY: docker_hub_signing_key
    DELEGATION_PASS_SSM_KEY: docker_hub_signing_pass
    DOCKER_REGISTRY_LOGIN_SSM_KEY: docker_hub_login
    DOCKER_REGISTRY_PWD_SSM_KEY: docker_hub_pwd
    DOCKER_REGISTRY_URL: docker.io
    IMAGE: ''
    ORGANIZATION: datadog
    SRC_AGENT: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent/agent
    SRC_DCA: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent/cluster-agent
    SRC_DSD: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent/dogstatsd
    TAG: ''
  when: manual
.deploy_cloudfront_invalidate:
  dependencies: []
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/deploy:$DATADOG_AGENT_BUILDERS
  only: &id007
  - triggers
  script:
  - cd /deploy_scripts/cloudfront-invalidation
  - REPO=apt PATTERN_SUBSTRING=/$DEB_RPM_BUCKET_BRANCH/ ./invalidate.sh
  - REPO=yum PATTERN_SUBSTRING=/$DEB_RPM_BUCKET_BRANCH/ ./invalidate.sh
  stage: deploy_invalidate
  tags:
  - runner:main
  - size:large
.docker_build_job_definition:
  script:
  - aws s3 sync --only-show-errors $S3_ARTIFACTS_URI $BUILD_CONTEXT
  - TAG_SUFFIX=${TAG_SUFFIX:-}
  - BUILD_ARG=${BUILD_ARG:-}
  - TARGET_TAG=$IMAGE:v$CI_PIPELINE_ID-${CI_COMMIT_SHA:0:7}$TAG_SUFFIX-$ARCH
  - pip install -r requirements.txt
  - inv -e docker.pull-base-images --signed-pull $BUILD_CONTEXT/$ARCH/Dockerfile
  - test "$TESTING_ARG" && docker build --file $BUILD_CONTEXT/$ARCH/Dockerfile $TESTING_ARG
    $BUILD_CONTEXT
  - docker build $BUILD_ARG --file $BUILD_CONTEXT/$ARCH/Dockerfile --pull --tag $TARGET_TAG
    $BUILD_CONTEXT
  - docker push $TARGET_TAG
  stage: image_build
.docker_build_job_definition_amd64:
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/docker:v1907756-26d65dc-18.09.6
  tags:
  - runner:docker
  - size:large
  variables:
    ARCH: amd64
.docker_build_job_definition_arm64:
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/docker:v1903032-53399bc-18.09.6-arm64
  tags:
  - runner:docker-arm
  - platform:arm64
  variables:
    ARCH: arm64
.docker_hub_variables:
  DELEGATION_KEY_SSM_KEY: docker_hub_signing_key
  DELEGATION_PASS_SSM_KEY: docker_hub_signing_pass
  DOCKER_REGISTRY_LOGIN_SSM_KEY: docker_hub_login
  DOCKER_REGISTRY_PWD_SSM_KEY: docker_hub_pwd
  DOCKER_REGISTRY_URL: docker.io
  SRC_AGENT: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent/agent
  SRC_DCA: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent/cluster-agent
  SRC_DSD: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent/dogstatsd
.docker_tag_job_definition:
  before_script: &id005
  - export SRC_TAG=v$CI_PIPELINE_ID-${CI_COMMIT_SHA:0:7}
  - DOCKER_REGISTRY_LOGIN=$(aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.$DOCKER_REGISTRY_LOGIN_SSM_KEY
    --with-decryption --query "Parameter.Value" --out text)
  - aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.$DOCKER_REGISTRY_PWD_SSM_KEY
    --with-decryption --query "Parameter.Value" --out text | docker login --username
    "$DOCKER_REGISTRY_LOGIN" --password-stdin "$DOCKER_REGISTRY_URL"
  - pip install -r requirements.txt
  - if [[ -z "$DELEGATION_PASS_SSM_KEY" ]]; then echo "No signing key set"; exit 0;
    fi
  - echo "Importing delegation signing key"
  - export DOCKER_CONTENT_TRUST_REPOSITORY_PASSPHRASE=$(aws ssm get-parameter --region
    us-east-1 --name ci.datadog-agent.$DELEGATION_PASS_SSM_KEY --with-decryption --query
    "Parameter.Value" --out text)
  - export NOTARY_AUTH=$(echo "$DOCKER_REGISTRY_LOGIN:$(aws ssm get-parameter --region
    us-east-1 --name ci.datadog-agent.$DOCKER_REGISTRY_PWD_SSM_KEY --with-decryption
    --query "Parameter.Value" --out text)" | base64)
  - export NOTARY_DELEGATION_PASSPHRASE="$DOCKER_CONTENT_TRUST_REPOSITORY_PASSPHRASE"
  - aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.$DELEGATION_KEY_SSM_KEY
    --with-decryption --query "Parameter.Value" --out text > /tmp/docker.key
  - notary -d ~/.docker/trust key import /tmp/docker.key; rm /tmp/docker.key
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/docker-notary:v1912023-8c8dc1c-0.6.1
  stage: image_deploy
  tags: &id006
  - runner:docker
  - size:large
  variables:
    DELEGATION_KEY_SSM_KEY: docker_hub_signing_key
    DELEGATION_PASS_SSM_KEY: docker_hub_signing_pass
    DOCKER_REGISTRY_LOGIN_SSM_KEY: docker_hub_login
    DOCKER_REGISTRY_PWD_SSM_KEY: docker_hub_pwd
    DOCKER_REGISTRY_URL: docker.io
    SRC_AGENT: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent/agent
    SRC_DCA: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent/cluster-agent
    SRC_DSD: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent/dogstatsd
.docker_tag_windows_job_definition:
  after_script:
  - cat ci-scripts/docker-publish.ps1
  - docker run --rm -w C:\mnt -e IS_AWS_CONTAINER=true -e SIGN_WINDOWS=true -v "$(Get-Location):C:\mnt"
    -v \\.\pipe\docker_engine:\\.\pipe\docker_engine 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/windows_${Env:VARIANT}_x64:${Env:DATADOG_AGENT_WINBUILDERS}
    powershell -C C:\mnt\ci-scripts\docker-publish.ps1
  before_script:
  - $SHORT_CI_COMMIT_SHA = ${CI_COMMIT_SHA}.Substring(0,7)
  - $SRC_TAG = "v${CI_PIPELINE_ID}-${SHORT_CI_COMMIT_SHA}"
  - mkdir ci-scripts
  - '@"

    Set-PSDebug -Trace 1

    `$ErrorActionPreference = "Stop"

    # ECR Login

    `$AWS_ECR_PASSWORD = aws ecr get-login-password --region us-east-1

    docker login --username AWS --password "`${AWS_ECR_PASSWORD}" 486234852809.dkr.ecr.us-east-1.amazonaws.com

    # DockerHub login

    `$DOCKER_REGISTRY_LOGIN = aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.${DOCKER_REGISTRY_LOGIN_SSM_KEY}
    --with-decryption --query "Parameter.Value" --out text

    `$DOCKER_REGISTRY_PWD = aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.${DOCKER_REGISTRY_PWD_SSM_KEY}
    --with-decryption --query "Parameter.Value" --out text

    docker login --username "`${DOCKER_REGISTRY_LOGIN}" --password "`${DOCKER_REGISTRY_PWD}"
    "${DOCKER_REGISTRY_URL}"

    # DockerHub image signing

    `$Env:DOCKER_CONTENT_TRUST_REPOSITORY_PASSPHRASE = aws ssm get-parameter --region
    us-east-1 --name ci.datadog-agent.${DELEGATION_PASS_SSM_KEY} --with-decryption
    --query "Parameter.Value" --out text

    `$Env:NOTARY_DELEGATION_PASSPHRASE = `$Env:DOCKER_CONTENT_TRUST_REPOSITORY_PASSPHRASE

    `$Env:NOTARY_AUTH = "`${DOCKER_REGISTRY_LOGIN}:`${DOCKER_REGISTRY_PWD}"

    `$bytes = [System.Text.Encoding]::Unicode.GetBytes(`$Env:NOTARY_AUTH)

    `$Env:NOTARY_AUTH = [Convert]::ToBase64String(`$bytes)

    aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.${DELEGATION_KEY_SSM_KEY}
    --with-decryption --query "Parameter.Value" --out text | Set-Content -Encoding
    ASCII docker.key

    docker trust key load `$PWD\docker.key

    Remove-Item `$PWD\docker.key

    "@ | out-file ci-scripts/docker-publish.ps1

    '
  stage: image_deploy
  variables:
    DELEGATION_KEY_SSM_KEY: docker_hub_signing_key
    DELEGATION_PASS_SSM_KEY: docker_hub_signing_pass
    DOCKER_REGISTRY_LOGIN_SSM_KEY: docker_hub_login
    DOCKER_REGISTRY_PWD_SSM_KEY: docker_hub_pwd
    DOCKER_REGISTRY_URL: docker.io
    SRC_AGENT: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent/agent
    SRC_DCA: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent/cluster-agent
    SRC_DSD: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent/dogstatsd
.kitchen_agent_a6:
  artifacts: &id001
    expire_in: 2 weeks
    paths:
    - $CI_PROJECT_DIR/kitchen_logs
    when: always
  except: &id004
    variables:
    - $RELEASE_VERSION_6 == ""
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS
  only: &id002
  - master
  - tags
  - triggers
  - web
  retry: 1
  stage: testkitchen_testing
  tags: &id003
  - runner:main
  - size:large
  variables:
    AGENT_MAJOR_VERSION: 6
    DD_PIPELINE_ID: $CI_PIPELINE_ID-a6
.kitchen_agent_a7:
  artifacts: *id001
  except: &id008
    variables:
    - $RELEASE_VERSION_7 == ""
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS
  only: *id002
  retry: 1
  stage: testkitchen_testing
  tags: *id003
  variables:
    AGENT_MAJOR_VERSION: 7
    DD_PIPELINE_ID: $CI_PIPELINE_ID-a7
.kitchen_azure_location_central_us:
  variables:
    AZURE_LOCATION: Central US
.kitchen_azure_location_north_central_us:
  variables:
    AZURE_LOCATION: North Central US
.kitchen_azure_location_south_central_us:
  variables:
    AZURE_LOCATION: South Central US
.kitchen_azure_location_west_central_us:
  variables:
    AZURE_LOCATION: West Central US
.kitchen_cleanup_azure_common:
  allow_failure: true
  before_script:
  - rsync -azr --delete ./ $SRC_PATH
  dependencies: []
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS
  only: *id002
  script:
  - cd $DD_AGENT_TESTING_DIR
  - bash -l tasks/clean.sh
  stage: testkitchen_cleanup
  tags:
  - runner:main
  - size:large
  when: always
.kitchen_cleanup_s3_common:
  allow_failure: true
  except: *id004
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/deploy:$DATADOG_AGENT_BUILDERS
  only: *id002
  script:
  - aws s3 rm s3://$DEB_TESTING_S3_BUCKET/dists/pipeline-$DD_PIPELINE_ID --recursive
  - aws s3 rm s3://$RPM_TESTING_S3_BUCKET/pipeline-$DD_PIPELINE_ID --recursive
  - aws s3 rm s3://$RPM_TESTING_S3_BUCKET/suse/pipeline-$DD_PIPELINE_ID --recursive
  - if [ $AGENT_MAJOR_VERSION == "7" ]; then export WINDOWS_TESTING_S3_BUCKET=$WINDOWS_TESTING_S3_BUCKET_A7;
    else export WINDOWS_TESTING_S3_BUCKET=$WINDOWS_TESTING_S3_BUCKET_A6; fi
  - aws s3 rm s3://$WIN_S3_BUCKET/$WINDOWS_TESTING_S3_BUCKET --recursive
  - cd $OMNIBUS_PACKAGE_DIR
  - for deb in $(ls *amd64.deb); do aws s3 rm s3://$DEB_TESTING_S3_BUCKET/pool/d/da/$deb
    --recursive; done
  stage: testkitchen_cleanup
  tags:
  - runner:main
  - size:large
  when: always
.kitchen_common:
  artifacts: *id001
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/dd-agent-testing:$DATADOG_AGENT_BUILDERS
  only: *id002
  retry: 1
  stage: testkitchen_testing
  tags: *id003
.kitchen_datadog_agent_flavor:
  variables:
    AGENT_FLAVOR: datadog-agent
.kitchen_datadog_iot_agent_flavor:
  variables:
    AGENT_FLAVOR: datadog-iot-agent
.kitchen_os_centos:
  before_script:
  - rsync -azr --delete ./ $SRC_PATH
  - export TEST_PLATFORMS="centos-69,urn,OpenLogic:CentOS:6.9:6.9.20180530"
  - export TEST_PLATFORMS="$TEST_PLATFORMS|centos-77,urn,OpenLogic:CentOS:7.7:7.7.201912090"
  - export TEST_PLATFORMS="$TEST_PLATFORMS|rhel-81,urn,RedHat:RHEL:8.1:8.1.2020020415"
  - cd $DD_AGENT_TESTING_DIR
  - bash -l tasks/kitchen_setup.sh
.kitchen_os_debian:
  before_script:
  - rsync -azr --delete ./ $SRC_PATH
  - export TEST_PLATFORMS="debian-8,urn,credativ:Debian:8:8.20190313.0"
  - export TEST_PLATFORMS="$TEST_PLATFORMS|debian-9,urn,credativ:Debian:9:9.20190515.0"
  - export TEST_PLATFORMS="$TEST_PLATFORMS|debian-10,urn,Debian:debian-10:10:0.20190709.401"
  - cd $DD_AGENT_TESTING_DIR
  - bash -l tasks/kitchen_setup.sh
.kitchen_os_suse:
  before_script:
  - rsync -azr --delete ./ $SRC_PATH
  - export TEST_PLATFORMS="sles-12,urn,SUSE:SLES-BYOS:12-SP4:2019.11.13"
  - export TEST_PLATFORMS="$TEST_PLATFORMS|sles-15,urn,SUSE:SLES-BYOS:15:2019.11.15"
  - cd $DD_AGENT_TESTING_DIR
  - bash -l tasks/kitchen_setup.sh
.kitchen_os_ubuntu:
  before_script:
  - rsync -azr --delete ./ $SRC_PATH
  - export TEST_PLATFORMS="ubuntu-14-04,urn,Canonical:UbuntuServer:14.04.5-LTS:14.04.201905140"
  - export TEST_PLATFORMS="$TEST_PLATFORMS|ubuntu-16-04,urn,Canonical:UbuntuServer:16.04.0-LTS:16.04.201906170"
  - export TEST_PLATFORMS="$TEST_PLATFORMS|ubuntu-18-04,urn,Canonical:UbuntuServer:18.04-LTS:18.04.201906040"
  - export TEST_PLATFORMS="$TEST_PLATFORMS|ubuntu-20-04,urn,Canonical:0001-com-ubuntu-server-focal:20_04-lts:20.04.202004230"
  - cd $DD_AGENT_TESTING_DIR
  - bash -l tasks/kitchen_setup.sh
.kitchen_os_windows:
  before_script:
  - if [ $AGENT_MAJOR_VERSION == "7" ]; then export WINDOWS_TESTING_S3_BUCKET=$WINDOWS_TESTING_S3_BUCKET_A7;
    else export WINDOWS_TESTING_S3_BUCKET=$WINDOWS_TESTING_S3_BUCKET_A6; fi
  - rsync -azr --delete ./ $SRC_PATH
  - export TEST_PLATFORMS="win2008r2,id,/subscriptions/8c56d827-5f07-45ce-8f2b-6c5001db5c6f/resourceGroups/kitchen-test-images/providers/Microsoft.Compute/galleries/kitchenimages/images/Windows2008-R2-SP1/versions/1.0.0"
  - export TEST_PLATFORMS="$TEST_PLATFORMS|win2012,urn,MicrosoftWindowsServer:WindowsServer:2012-Datacenter:3.127.20190410"
  - export TEST_PLATFORMS="$TEST_PLATFORMS|win2012r2,urn,MicrosoftWindowsServer:WindowsServer:2012-R2-Datacenter:4.127.20190416"
  - export TEST_PLATFORMS="$TEST_PLATFORMS|win2016,urn,MicrosoftWindowsServer:WindowsServer:2016-Datacenter-Server-Core:2016.127.20190603"
  - export TEST_PLATFORMS="$TEST_PLATFORMS|win2019,urn,MicrosoftWindowsServer:WindowsServer:2019-Datacenter-Core:2019.0.20190603"
  - cd $DD_AGENT_TESTING_DIR
  - bash -l tasks/kitchen_setup.sh
.kitchen_scenario_centos_a6:
  extends:
  - .kitchen_os_centos
  - .kitchen_agent_a6
  needs:
  - deploy_rpm_testing-a6
.kitchen_scenario_centos_a7:
  extends:
  - .kitchen_os_centos
  - .kitchen_agent_a7
  needs:
  - deploy_rpm_testing-a7
.kitchen_scenario_debian_a6:
  extends:
  - .kitchen_os_debian
  - .kitchen_agent_a6
  needs:
  - deploy_deb_testing-a6
.kitchen_scenario_debian_a7:
  extends:
  - .kitchen_os_debian
  - .kitchen_agent_a7
  needs:
  - deploy_deb_testing-a7
.kitchen_scenario_suse_a6:
  extends:
  - .kitchen_os_suse
  - .kitchen_agent_a6
  needs:
  - deploy_suse_rpm_testing-a6
.kitchen_scenario_suse_a7:
  extends:
  - .kitchen_os_suse
  - .kitchen_agent_a7
  needs:
  - deploy_suse_rpm_testing-a7
.kitchen_scenario_ubuntu_a6:
  extends:
  - .kitchen_os_ubuntu
  - .kitchen_agent_a6
  needs:
  - deploy_deb_testing-a6
.kitchen_scenario_ubuntu_a7:
  extends:
  - .kitchen_os_ubuntu
  - .kitchen_agent_a7
  needs:
  - deploy_deb_testing-a7
.kitchen_scenario_windows_a6:
  extends:
  - .kitchen_os_windows
  - .kitchen_agent_a6
  needs:
  - deploy_windows_testing-a6
.kitchen_scenario_windows_a7:
  extends:
  - .kitchen_os_windows
  - .kitchen_agent_a7
  needs:
  - deploy_windows_testing-a7
.kitchen_test_chef:
  script:
  - bash -l tasks/run-test-kitchen.sh chef-test $AGENT_MAJOR_VERSION
.kitchen_test_chef_agent:
  extends:
  - .kitchen_test_chef
  - .kitchen_datadog_agent_flavor
  - .kitchen_azure_location_north_central_us
.kitchen_test_install_script:
  script:
  - bash -l tasks/run-test-kitchen.sh install-script-test $AGENT_MAJOR_VERSION
.kitchen_test_install_script_agent:
  extends:
  - .kitchen_test_install_script
  - .kitchen_datadog_agent_flavor
  - .kitchen_azure_location_south_central_us
.kitchen_test_install_script_iot_agent:
  extends:
  - .kitchen_test_install_script
  - .kitchen_datadog_iot_agent_flavor
  - .kitchen_azure_location_west_central_us
.kitchen_test_step_by_step:
  script:
  - bash -l tasks/run-test-kitchen.sh step-by-step-test $AGENT_MAJOR_VERSION
.kitchen_test_step_by_step_agent:
  extends:
  - .kitchen_test_step_by_step
  - .kitchen_datadog_agent_flavor
  - .kitchen_azure_location_central_us
.kitchen_test_upgrade5:
  script:
  - bash -l tasks/run-test-kitchen.sh upgrade5-test $AGENT_MAJOR_VERSION
.kitchen_test_upgrade5_agent:
  extends:
  - .kitchen_test_upgrade5
  - .kitchen_datadog_agent_flavor
  - .kitchen_azure_location_central_us
.kitchen_test_upgrade6:
  script:
  - bash -l tasks/run-test-kitchen.sh upgrade6-test $AGENT_MAJOR_VERSION
.kitchen_test_upgrade6_agent:
  extends:
  - .kitchen_test_upgrade6
  - .kitchen_datadog_agent_flavor
  - .kitchen_azure_location_south_central_us
.kitchen_test_upgrade7:
  script:
  - bash -l tasks/run-test-kitchen.sh upgrade7-test $AGENT_MAJOR_VERSION
.kitchen_test_upgrade7_agent:
  extends:
  - .kitchen_test_upgrade7
  - .kitchen_datadog_agent_flavor
  - .kitchen_azure_location_north_central_us
.kitchen_test_windows_installer:
  before_script:
  - if [ $AGENT_MAJOR_VERSION == "7" ]; then export WINDOWS_TESTING_S3_BUCKET=$WINDOWS_TESTING_S3_BUCKET_A7;
    else export WINDOWS_TESTING_S3_BUCKET=$WINDOWS_TESTING_S3_BUCKET_A6; fi
  - rsync -azr --delete ./ $SRC_PATH
  - export TEST_PLATFORMS="win2012,urn,MicrosoftWindowsServer:WindowsServer:2012-Datacenter:3.127.20190410"
  - cd $DD_AGENT_TESTING_DIR
  - bash -l tasks/kitchen_setup.sh
  script:
  - bash -l tasks/run-test-kitchen.sh windows-install-test $AGENT_MAJOR_VERSION
.kitchen_test_windows_installer_agent:
  extends:
  - .kitchen_test_windows_installer
  - .kitchen_datadog_agent_flavor
  - .kitchen_azure_location_north_central_us
.latest_revert_to_previous_release_6:
  before_script: *id005
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/docker-notary:v1912023-8c8dc1c-0.6.1
  script:
  - if [[ -z "$RELEASE" ]]; then echo "Need release version to revert to"; exit 1;
    fi
  - inv -e docker.publish-manifest --signed-push --name datadog/agent --tag latest-py2
    --image datadog/agent-amd64:${RELEASE},linux/amd64 --image datadog/agent-arm64:${RELEASE},linux/arm64
  - inv -e docker.publish-manifest --signed-push --name datadog/agent --tag latest-py2-jmx
    --image datadog/agent-amd64:${RELEASE}-jmx,linux/amd64 --image datadog/agent-arm64:${RELEASE}-jmx,linux/arm64
  stage: source_test
  tags: *id006
  variables:
    DELEGATION_KEY_SSM_KEY: docker_hub_signing_key
    DELEGATION_PASS_SSM_KEY: docker_hub_signing_pass
    DOCKER_REGISTRY_LOGIN_SSM_KEY: docker_hub_login
    DOCKER_REGISTRY_PWD_SSM_KEY: docker_hub_pwd
    DOCKER_REGISTRY_URL: docker.io
    RELEASE: ''
    SRC_AGENT: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent/agent
    SRC_DCA: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent/cluster-agent
    SRC_DSD: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent/dogstatsd
  when: manual
.latest_revert_to_previous_release_7:
  before_script: *id005
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/docker-notary:v1912023-8c8dc1c-0.6.1
  script:
  - if [[ -z "$RELEASE" ]]; then echo "Need release version to revert to"; exit 1;
    fi
  - inv -e docker.publish-manifest --signed-push --name datadog/agent --tag latest
    --image datadog/agent-amd64:${RELEASE},linux/amd64 --image datadog/agent-arm64:${RELEASE},linux/arm64
  - inv -e docker.publish-manifest --signed-push --name datadog/agent --tag latest-jmx
    --image datadog/agent-amd64:${RELEASE}-jmx,linux/amd64 --image datadog/agent-arm64:${RELEASE}-jmx,linux/arm64
  - inv -e docker.publish --signed-pull --signed-push datadog/dogstatsd:${RELEASE}
    datadog/dogstatsd:latest
  stage: source_test
  tags: *id006
  variables:
    DELEGATION_KEY_SSM_KEY: docker_hub_signing_key
    DELEGATION_PASS_SSM_KEY: docker_hub_signing_pass
    DOCKER_REGISTRY_LOGIN_SSM_KEY: docker_hub_login
    DOCKER_REGISTRY_PWD_SSM_KEY: docker_hub_pwd
    DOCKER_REGISTRY_URL: docker.io
    RELEASE: ''
    SRC_AGENT: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent/agent
    SRC_DCA: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent/cluster-agent
    SRC_DSD: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent/dogstatsd
  when: manual
.pupernetes_template:
  before_script:
  - cd $SRC_PATH
  - pip install --upgrade --ignore-installed pip setuptools
  - pip install -r requirements.txt
  dependencies: []
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/deploy:$DATADOG_AGENT_BUILDERS
  script:
  - inv -e e2e-tests --image=datadog/agent-dev:${CI_COMMIT_REF_SLUG}-py2
  - inv -e e2e-tests --image=datadog/agent-dev:${CI_COMMIT_REF_SLUG}-py3
  stage: e2e
  tags:
  - runner:main
  - size:large
.quay_variables:
  DELEGATION_KEY_SSM_KEY: docker_hub_signing_key
  DELEGATION_PASS_SSM_KEY: docker_hub_signing_pass
  DOCKER_REGISTRY_LOGIN_SSM_KEY: quay_login
  DOCKER_REGISTRY_PWD_SSM_KEY: quay_pwd
  DOCKER_REGISTRY_URL: quay.io
  SRC_AGENT: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent/agent
  SRC_DCA: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent/cluster-agent
  SRC_DSD: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent/dogstatsd
.run_old_tests_windows_base:
  needs:
  - fail_on_non_triggered_tag
  script:
  - docker run --rm -m 8192M -v "$(Get-Location):c:\mnt" -e IS_AWS_CONTAINER=true
    -e SIGN_WINDOWS=true -e PY_RUNTIMES="$PYTHON_RUNTIMES" -e NEW_BUILDER="$NEW_BUILDER"
    486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/windows_1809_${ARCH}:${Env:DATADOG_AGENT_WINBUILDERS}
    c:\mnt\tasks\winbuildscripts\unittests.bat
  stage: source_test
  tags:
  - runner:windows-docker
  - windowsversion:1809
  variables:
    NEW_BUILDER: 'false'
.run_only_when_testkitchen_triggered:
  only: *id002
.run_only_when_triggered:
  only: *id007
.run_only_when_triggered_on_nightly:
  only:
    refs:
    - triggers
    variables:
    - $RELEASE_VERSION_6 == "nightly"
    - $RELEASE_VERSION_7 == "nightly-a7"
.run_only_when_triggered_on_tag_6:
  except:
    variables:
    - $RELEASE_VERSION_6 == "nightly"
    - $RELEASE_VERSION_6 == ""
  only:
    refs:
    - triggers
.run_only_when_triggered_on_tag_7:
  except:
    variables:
    - $RELEASE_VERSION_7 == "nightly-a7"
    - $RELEASE_VERSION_7 == ""
  only:
    refs:
    - triggers
.run_tests_preparation:
  before_script:
  - source /root/.bashrc && conda activate $CONDA_ENV
  - pip install wheel
  - pip install -r requirements.txt
  - GO111MODULE=off go get gopkg.in/yaml.v2
  - GO111MODULE=off go get github.com/stretchr/testify
  - inv -e rtloader.make --install-prefix=$SRC_PATH/dev --python-runtimes "$PYTHON_RUNTIMES"
  - inv -e rtloader.install
  - inv -e rtloader.format --raise-if-changed
  - inv -e rtloader.test
  - inv -e deps --verbose --dep-vendor-only
  needs:
  - fail_on_non_triggered_tag
.run_tests_windows_base:
  needs:
  - fail_on_non_triggered_tag
  script:
  - docker run --rm -m 8192M -v "$(Get-Location):c:\mnt" -e AWS_NETWORKING=true -e
    SIGN_WINDOWS=true -e PY_RUNTIMES="$PYTHON_RUNTIMES" -e NEW_BUILDER="$NEW_BUILDER"
    486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/windows_1809_${ARCH}:$Env:DATADOG_AGENT_WINBUILDIMAGES
    c:\mnt\tasks\winbuildscripts\unittests.bat
  stage: source_test
  tags:
  - runner:windows-docker
  - windowsversion:1809
  variables:
    NEW_BUILDER: 'true'
.skip_when_triggered:
  except: &id009
    refs:
    - triggers
.skip_when_unwanted_on_6:
  except: *id004
.skip_when_unwanted_on_7:
  except: *id008
.system-probe_build_common:
  before_script:
  - mkdir -p $GOPATH/src/github.com/DataDog
  - '[[ "$ARCH" == arm64 ]] && cp -R $GOPATH/src/github.com/*/*/DataDog/datadog-agent
    $GOPATH/src/github.com/DataDog'
  - cd $SRC_PATH
  - inv -e deps --no-checks --verbose --dep-vendor-only
  - $S3_CP_CMD $S3_ARTIFACTS_URI/libbcc-$ARCH.tar.xz /tmp/libbcc.tar.xz
  - mkdir -p /opt/datadog-agent/embedded
  - tar -xvf /tmp/libbcc.tar.xz -C /opt/datadog-agent/embedded
  script:
  - CGO_CFLAGS='-I/opt/datadog-agent/embedded/include' CGO_LDFLAGS='-Wl,-rpath,/opt/datadog-agent/embedded/lib
    -L/opt/datadog-agent/embedded/lib' inv -e system-probe.build --go-version=$SYSTEM_PROBE_GO_VERSION
  - CGO_CFLAGS='-I/opt/datadog-agent/embedded/include' CGO_LDFLAGS='-Wl,-rpath,/opt/datadog-agent/embedded/lib
    -L/opt/datadog-agent/embedded/lib' inv -e system-probe.test --only-check-bpf-bytes
  - $S3_CP_CMD $SRC_PATH/$SYSTEM_PROBE_BINARIES_DIR/system-probe $S3_ARTIFACTS_URI/system-probe.$ARCH
.windows_main_agent_base:
  extends: .windows_msi_base
  variables:
    OMNIBUS_TARGET: main
.windows_msi_base:
  artifacts:
    expire_in: 2 weeks
    paths:
    - .omnibus/pkg
  needs:
  - run_go_tidy_check
  script:
  - if (Test-Path .omnibus) { remove-item -recurse -force .omnibus }
  - if (Test-Path build-out) { remove-item -recurse -force build-out }
  - mkdir .omnibus\pkg
  - docker run --rm -m 4096M -v "$(Get-Location):c:\mnt" -e CI_JOB_ID=${CI_JOB_ID}
    -e OMNIBUS_TARGET=${OMNIBUS_TARGET} -e WINDOWS_BUILDER=true -e RELEASE_VERSION="$RELEASE_VERSION"
    -e MAJOR_VERSION="$AGENT_MAJOR_VERSION" -e PY_RUNTIMES="$PYTHON_RUNTIMES" -e AWS_NETWORKING=true
    -e SIGN_WINDOWS=true -e TARGET_ARCH="$ARCH" -e NEW_BUILDER=true 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/windows_1809_${ARCH}:${Env:DATADOG_AGENT_WINBUILDIMAGES}
    c:\mnt\tasks\winbuildscripts\buildwin.bat
  - copy build-out\${CI_JOB_ID}\*.msi .omnibus\pkg
  - if (Test-Path build-out\${CI_JOB_ID}\*.zip) { copy build-out\${CI_JOB_ID}\*.zip
    .omnibus\pkg }
  - remove-item -recurse -force build-out\${CI_JOB_ID}
  - get-childitem build-out
  - get-childitem .omnibus\pkg
  stage: package_build
  tags:
  - runner:windows-docker
  - windowsversion:1809
.windows_old_main_agent_base:
  extends: .windows_old_msi_base
  variables:
    OMNIBUS_TARGET: main
.windows_old_msi_base:
  allow_failure: true
  artifacts:
    expire_in: 2 weeks
    paths:
    - .omnibus/pkg
  except: *id009
  needs:
  - run_go_tidy_check
  script:
  - if (Test-Path .omnibus) { remove-item -recurse -force .omnibus }
  - if (Test-Path build-out) { remove-item -recurse -force build-out }
  - mkdir .omnibus\pkg
  - docker run --rm -m 4096M -v "$(Get-Location):c:\mnt" -e CI_JOB_ID=${CI_JOB_ID}
    -e OMNIBUS_TARGET=${OMNIBUS_TARGET} -e WINDOWS_BUILDER=true -e RELEASE_VERSION="$RELEASE_VERSION"
    -e MAJOR_VERSION="$AGENT_MAJOR_VERSION" -e PY_RUNTIMES="$PYTHON_RUNTIMES" -e IS_AWS_CONTAINER=true
    -e SIGN_WINDOWS=true -e TARGET_ARCH="$ARCH" -e NEW_BUILDER=false 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/windows_1809_${ARCH}:${Env:DATADOG_AGENT_WINBUILDERS}
    c:\mnt\tasks\winbuildscripts\oldbuildwin.bat
  - copy build-out\${CI_JOB_ID}\*.msi .omnibus\pkg
  - if (Test-Path build-out\${CI_JOB_ID}\*.zip) { copy build-out\${CI_JOB_ID}\*.zip
    .omnibus\pkg }
  - remove-item -recurse -force build-out\${CI_JOB_ID}
  - get-childitem build-out
  - get-childitem .omnibus\pkg
  stage: package_build
  tags:
  - runner:windows-docker
  - windowsversion:1809
default:
  retry:
    max: 2
    when:
    - runner_system_failure
    - stuck_or_timeout_failure
    - unknown_failure
    - api_failure
include: https://gitlab-templates.ddbuild.io/slack-notifier/v1/template.yml
iot_agent_deb-arm64:
  artifacts:
    expire_in: 2 weeks
    paths:
    - $OMNIBUS_PACKAGE_DIR
  before_script:
  - source /root/.bashrc
  - inv -e deps --verbose --dep-vendor-only
  except: *id008
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/deb_arm64:$DATADOG_AGENT_ARMBUILDIMAGES
  script:
  - rm -rf $OMNIBUS_PACKAGE_DIR/*
  - inv -e agent.omnibus-build --iot --log-level debug --release-version "$RELEASE_VERSION_7"
    --major-version 7 --base-dir $OMNIBUS_BASE_DIR --skip-deps
  - find $OMNIBUS_BASE_DIR/pkg
  - find $OMNIBUS_BASE_DIR/pkg -name "datadog-iot-agent*_arm64.deb" -exec dpkg -c
    {} \;
  - $S3_CP_CMD $OMNIBUS_BASE_DIR/pkg/datadog-iot-agent*_arm64.deb $S3_ARTIFACTS_URI/datadog-iot-agent_arm64.deb
  - mkdir -p $OMNIBUS_PACKAGE_DIR && cp $OMNIBUS_BASE_DIR/pkg/datadog-iot-agent*_arm64.deb{,.metadata.json}
    $OMNIBUS_PACKAGE_DIR
  stage: package_build
  tags:
  - runner:docker-arm
  - platform:arm64
iot_agent_deb-armhf:
  artifacts:
    expire_in: 2 weeks
    paths:
    - $OMNIBUS_PACKAGE_DIR
  before_script:
  - source /root/.bashrc
  - inv -e deps --verbose --dep-vendor-only
  except: *id008
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/deb_armhf:$DATADOG_AGENT_ARMBUILDIMAGES
  script:
  - rm -rf $OMNIBUS_PACKAGE_DIR/*
  - inv -e agent.omnibus-build --iot --log-level debug --release-version "$RELEASE_VERSION_7"
    --major-version 7 --base-dir $OMNIBUS_BASE_DIR --skip-deps
  - find $OMNIBUS_BASE_DIR/pkg
  - find $OMNIBUS_BASE_DIR/pkg -name "datadog-iot-agent*_armhf.deb" -exec dpkg -c
    {} \;
  - $S3_CP_CMD $OMNIBUS_BASE_DIR/pkg/datadog-iot-agent*_armhf.deb $S3_ARTIFACTS_URI/datadog-iot-agent_armhf.deb
  - mkdir -p $OMNIBUS_PACKAGE_DIR && cp $OMNIBUS_BASE_DIR/pkg/datadog-iot-agent*_armhf.deb{,.metadata.json}
    $OMNIBUS_PACKAGE_DIR
  stage: package_build
  tags:
  - runner:docker-arm
  - platform:arm64
iot_agent_rpm-arm64:
  artifacts:
    expire_in: 2 weeks
    paths:
    - $OMNIBUS_PACKAGE_DIR
  before_script:
  - inv -e deps --verbose --dep-vendor-only
  except: *id008
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/rpm_arm64:$DATADOG_AGENT_ARMBUILDIMAGES
  script:
  - echo "About to build iot agent for $RELEASE_VERSION"
  - echo "Detected host architecture $(uname -m)"
  - echo "Target architecture $TARGET_ARCH"
  - rm -rf $OMNIBUS_PACKAGE_DIR/*
  - set +x
  - RPM_GPG_KEY=$(aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.rpm_signing_private_key_e09422b3
    --with-decryption --query "Parameter.Value" --out text)
  - printf -- "$RPM_GPG_KEY" | gpg --import --batch
  - export RPM_SIGNING_PASSPHRASE=$(aws ssm get-parameter --region us-east-1 --name
    ci.datadog-agent.rpm_signing_key_passphrase_e09422b3 --with-decryption --query
    "Parameter.Value" --out text)
  - set -x
  - inv -e agent.omnibus-build --iot --log-level debug --release-version "$RELEASE_VERSION_7"
    --major-version 7 --base-dir $OMNIBUS_BASE_DIR --skip-deps
  - ls $OMNIBUS_BASE_DIR/pkg/
  - mkdir -p $OMNIBUS_PACKAGE_DIR && cp $OMNIBUS_BASE_DIR/pkg/*.{rpm,metadata.json}
    $OMNIBUS_PACKAGE_DIR
  stage: package_build
  tags:
  - runner:docker-arm
  - platform:arm64
iot_agent_rpm-armhf:
  artifacts:
    expire_in: 2 weeks
    paths:
    - $OMNIBUS_PACKAGE_DIR
  before_script:
  # Yup, we're doing this...
  - echo "echo \"armv7l\"" > /bin/uname
  - inv -e deps --verbose --dep-vendor-only
  except: *id008
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/rpm_armhf:$DATADOG_AGENT_ARMBUILDIMAGES
  script:
  - echo "About to build iot agent for $RELEASE_VERSION"
  - echo "Detected host architecture $(uname -m)"
  - echo "Target architecture $TARGET_ARCH"
  - echo "armhfp" > /etc/yum/vars/basearch
  - echo "armv7hl" > /etc/yum/vars/arch
  - echo "armv7hl-redhat-linux-gnu" > /etc/rpm/platform
  - rm -rf $OMNIBUS_PACKAGE_DIR/*
  - set +x
  - RPM_GPG_KEY=$(aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.rpm_signing_private_key_e09422b3
    --with-decryption --query "Parameter.Value" --out text)
  - printf -- "$RPM_GPG_KEY" | gpg --import --batch
  - export RPM_SIGNING_PASSPHRASE=$(aws ssm get-parameter --region us-east-1 --name
    ci.datadog-agent.rpm_signing_key_passphrase_e09422b3 --with-decryption --query
    "Parameter.Value" --out text)
  - set -x
  - linux32 inv -e agent.omnibus-build --iot --log-level debug --release-version "$RELEASE_VERSION_7"
    --major-version 7 --base-dir $OMNIBUS_BASE_DIR --skip-deps
  - ls $OMNIBUS_BASE_DIR/pkg/
  - mkdir -p $OMNIBUS_PACKAGE_DIR && cp $OMNIBUS_BASE_DIR/pkg/*.{rpm,metadata.json}
    $OMNIBUS_PACKAGE_DIR
  stage: package_build
  tags:
  - runner:docker-arm
  - platform:arm64
stages:
- deps_build
- source_test
- binary_build
- package_build
- testkitchen_testing
- testkitchen_cleanup
- image_build
- image_deploy
- deploy_invalidate
- e2e
variables:
  AGENT_BINARIES_DIR: bin/agent
  ANDROID_BUILDS_S3_BUCKET: $ANDROID_S3_BUCKET/builds
  ANDROID_S3_BUCKET: dd-agent-androidtesting
  BCC_VERSION: v0.12.0
  CLUSTER_AGENT_BINARIES_DIR: bin/datadog-cluster-agent
  CLUSTER_AGENT_CLOUDFOUNDRY_BINARIES_DIR: bin/datadog-cluster-agent-cloudfoundry
  DATADOG_AGENT_ARMBUILDIMAGES: v2604819-e58f0ef
  DATADOG_AGENT_BUILDERS: v2448672-5304c3c
  DATADOG_AGENT_BUILDIMAGES: v2424505-0439a40
  DATADOG_AGENT_SYSPROBE_BUILDIMAGES: v2424505-0439a40
  DATADOG_AGENT_WINBUILDERS: v2348149-ba6640d
  DATADOG_AGENT_WINBUILDIMAGES: v2468030-cbaf3fe
  DD_AGENT_TESTING_DIR: $CI_PROJECT_DIR/test/kitchen
  DD_REPO_BRANCH_NAME: $CI_COMMIT_REF_NAME
  DEB_RPM_BUCKET_BRANCH: nightly
  DEB_RPM_TESTING_BUCKET_BRANCH: testing
  DEB_S3_BUCKET: apt.datad0g.com
  DEB_TESTING_S3_BUCKET: apttesting.datad0g.com
  DOGSTATSD_BINARIES_DIR: bin/dogstatsd
  OMNIBUS_BASE_DIR: /.omnibus
  OMNIBUS_BASE_DIR_SUSE: /.omnibus/suse
  OMNIBUS_BASE_DIR_WIN: c:\omni-base\$CI_RUNNER_ID
  OMNIBUS_BASE_DIR_WIN_OMNIBUS: c:/omni-base/$CI_RUNNER_ID
  OMNIBUS_PACKAGE_DIR: $CI_PROJECT_DIR/.omnibus/pkg/
  OMNIBUS_PACKAGE_DIR_SUSE: $CI_PROJECT_DIR/.omnibus/suse/pkg
  PROCESS_S3_BUCKET: datad0g-process-agent
  RELEASE_VERSION_6: nightly
  RELEASE_VERSION_7: nightly-a7
  RPM_S3_BUCKET: yum.datad0g.com
  RPM_TESTING_S3_BUCKET: yumtesting.datad0g.com
  S3_ARTIFACTS_URI: s3://dd-ci-artefacts-build-stable/$CI_PROJECT_NAME/$CI_PIPELINE_ID
  S3_CP_CMD: aws s3 cp $S3_CP_OPTIONS
  S3_CP_OPTIONS: --only-show-errors --region us-east-1 --sse AES256
  S3_DSD6_URI: s3://dsd6-staging
  S3_OMNIBUS_CACHE_BUCKET: dd-ci-datadog-agent-omnibus-cache-build-stable
  SRC_PATH: /go/src/github.com/DataDog/datadog-agent
  STATIC_BINARIES_DIR: bin/static
  SYSTEM_PROBE_BINARIES_DIR: bin/system-probe
  SYSTEM_PROBE_GO_VERSION: 1.13.8
  USE_S3_CACHING: --omnibus-s3-cache
  WINDOWS_BUILDS_S3_BUCKET: $WIN_S3_BUCKET/builds
  WINDOWS_TESTING_S3_BUCKET_A6: pipelines/A6/$CI_PIPELINE_ID
  WINDOWS_TESTING_S3_BUCKET_A7: pipelines/A7/$CI_PIPELINE_ID
  WIN_S3_BUCKET: dd-agent-mstesting
