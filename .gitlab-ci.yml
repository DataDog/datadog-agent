stages:
  - source_test
  - binary_build
  - integration_test
  - package_build
  - deploy

variables:
  SRC_PATH: /src/github.com/DataDog/datadog-agent
  AGENT_OMNIBUS_BASE_DIR: $CI_PROJECT_DIR/.omnibus/
  AGENT_OMNIBUS_PACKAGE_DIR: $CI_PROJECT_DIR/.omnibus/pkg/
  STATIC_BINARIES_DIR: bin/static
  DEB_S3_BUCKET_DEPRECATED: apt-agent6.datad0g.com
  DEB_S3_BUCKET: apt.datad0g.com
  RPM_S3_BUCKET: yum.datad0g.com
  DEB_RPM_BUCKET_BRANCH: nightly  # branch of the DEB_S3_BUCKET and RPM_S3_BUCKET repos to release to, 'nightly' or 'beta'
  DD_REPO_BRANCH_NAME: $CI_COMMIT_REF_NAME



#
# package_build
#
# build windows 
build_windows_msi_x64:
  before_script:
    - if exist c:\omnibus-ruby\pkg del /q c:\omnibus-ruby\pkg
    - if exist c:\dev\go\src\github.com\DataDog\datadog-agent rd /s/q c:\dev\go\src\github.com\DataDog\datadog-agent
    - mkdir c:\dev\go\src\github.com\DataDog\datadog-agent
    - xcopy /h/e/s * c:\dev\go\src\github.com\DataDog\datadog-agent
    - cd c:\dev\go\src\github.com\DataDog\datadog-agent
    - inv -e deps
  stage: package_build
  tags: ["runner:windows"]
  script:
    - cd c:\dev\go\src\github.com\DataDog\datadog-agent
    - inv agent.omnibus-build
  after_script:
    - cd
    - mkdir artifacts
    - copy c:\omnibus-ruby\pkg\*.msi artifacts
    - copy c:\omnibus-ruby\pkg\*.exe artifacts
  artifacts:
    expire_in: 2 weeks
    paths:
    - artifacts/
