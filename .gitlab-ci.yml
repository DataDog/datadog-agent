spec:
  inputs:
    units:
      description: A comma-separated list of units to run, or `all` to run all units
      type: string
      default: agent
      regex: ^(all|agent(,agent)*)$

---

variables:
  # TODO: Make the value a string when we update GitLab CI to a version that supports inputs on
  # the manual trigger page. See https://docs.gitlab.com/ci/pipelines/#run-a-pipeline-manually
  TRIGGER_UNITS:
    description: A comma-separated list of units to run, or `all` to run all units
    value: $[[ inputs.units ]]
  # Reduce configuration size by allowing for direct referencing of common conditions
  IS_UNIT_SELECTION: $CI_PIPELINE_SOURCE =~ /^(pipeline|schedule|trigger|web)$/

stages:
- unit-generate
- unit-trigger

include:
- local: .ci/units/gitlab/*.yml
- local: ci/templates/*.yml

validate-units:
  extends:
  - .runner:linux:arm64
  - .image:build:linux
  stage: .pre
  script:
  - echo "DDCI_REQUEST_ID is $DDCI_REQUEST_ID"
  - echo "GIT_BASE_BRANCH is $GIT_BASE_BRANCH"
  - curl https://cimetadataserver.us1.ddbuild.io/internal/ddci/metadata/$DDCI_REQUEST_ID
  - dda check ci units
