# Parent pipeline â€“ test if child job can depend on parent job
# See: child-pipeline.yml for the child pipeline

stages:
  - prepare
  - trigger

# Job in the PARENT pipeline
parent_job:
  stage: prepare
  tags: ["arch:amd64", "specific:true"]
  script:
    - echo "Running in parent pipeline"
    - echo "Parent job finished"

# Runs in parallel with trigger_child (same stage). Child pipeline will try to need this job.
# Produces a dummy artifact that the child job will try to download.
parent_job_parallel:
  stage: trigger
  tags: ["arch:amd64", "specific:true"]
  needs:
    - parent_job
  script:
    - echo "Parent job running in parallel with trigger_child"
    - echo "artifact from parent_job_parallel" > artifact-from-parent.txt
  artifacts:
    paths:
      - artifact-from-parent.txt
  resource_group: test-$CI_COMMIT_SHA

# Trigger the child pipeline only after parent_job succeeds
trigger_child:
  stage: trigger
  needs:
    - parent_job
  trigger:
    include: child-pipeline.yml
  variables:
    PARENT_PIPELINE_ID: $CI_PIPELINE_ID
