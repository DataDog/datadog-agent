schema:
  version: 1.0.0
name: CIS Docker Generic
framework: cis-docker
version: 1.2.0
regos:
  - id: cis-docker-rego
    description: 'Docker rego check'
    scope:
      - docker
    inputs:
      - tag: kubelet_processes
        process:
          name: kubelet
      - tag: kubelet_config_files
        file:
          path: process.flag("kubelet", "--config")
    module: |
      package tls

      import data.datadog as dd

      findings[f] {
        p := input.kubelet_processes[_]
        valid_process[p]
        f := dd.passed_finding(
          "docker_daemon",
          dd.docker_daemon_resource_id,
          dd.process_data(p)
        )
      }

      findings[f] {
        p := input.kubelet_processes[_]
        not valid_process[p]
        f := dd.failing_finding(
          "docker_daemon",
          dd.docker_daemon_resource_id,
          dd.process_data(p)
        )
      }

      valid_process[p] {
        p := input.kubelet_processes[_]
        p.flags["--tls-cert-file"] != ""
        p.flags["--tls-private-key-file"] != ""
      }

      valid_process[p] {
        p := input.kubelet_processes[_]
        f := input.kubelet_config_files[_]
        p.flags["--config"] == f.path
        f.content.tlsCertFile != ""
        f.content.tlsPrivateKeyFile != ""
      }

      valid_process[p] {
        p := input.kubelet_processes[_]
        f := input.kubelet_config_files[_]
        p.flags["--config"] == f.path
        f.content.serverTLSBootstrap != ""
        f.content.featureGates.RotateKubeletServerCertificate != ""
      }

    findings: data.tls.findings
