---
include:
  - .gitlab/common/macos.yml

.lint_macos_gitlab:
  stage: lint
  extends: .macos_gitlab
  needs: ["go_deps", "go_tools_deps"]
  script:
    - !reference [.retrieve_linux_go_deps]
    - !reference [.retrieve_linux_go_tools_deps]
    - dda inv -- -e linter.go --cpus 12 --debug --timeout 60

lint_macos_gitlab_amd64:
  extends: .lint_macos_gitlab
  tags: ["macos:ventura-amd64", "specific:true"]
  rules:
    - !reference [.except_mergequeue]
    - when: on_success

lint_macos_gitlab_arm64:
  extends: .lint_macos_gitlab
  allow_failure: true
  rules:
    - !reference [.on_main]
    - !reference [.manual]
  tags: ["macos:ventura-arm64", "specific:true"]

celian:
  tags: ["macos:ventura-amd64", "specific:true"]
  stage: lint
  needs: []
  parallel: 8
  script:
    - !reference [.vault_login]
    - !reference [.aws_retry_config]
    # Selecting the current Python version
    - !reference [.select_python_env_commands]
    - !reference [.install_python_dependencies]
    - DD_API_KEY="$("$CI_PROJECT_DIR"/tools/ci/fetch_secret.sh "$AGENT_API_KEY_ORG2" token)" || exit $?; export DD_API_KEY
    # Remove inactive versions
    - |
      echo Trying to remove inactive versions
      dda inv -- -e macos.list-ci-active-versions -l python -t "$PYTHON_VERSION"
      dda inv -- -e macos.list-ci-active-versions -l go -t "$PYTHON_VERSION"
    - echo ok
