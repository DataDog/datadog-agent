do-not-merge:
  stage: .pre
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/deb_x64$DATADOG_AGENT_BUILDIMAGES_SUFFIX:$DATADOG_AGENT_BUILDIMAGES
  tags: ["arch:amd64"]
  rules: # this should only run on dev branches
  - if: $CI_PIPELINE_SOURCE =~ /^schedule.*$/
    when: never
  - if: $CI_COMMIT_TAG
    when: never
  - !reference [.except_main_or_release_branch]
  - when: always
  script:
      - |
          if [ ! -z "$DATADOG_AGENT_BUILDIMAGES_SUFFIX" ] ||
             [ ! -z "$DATADOG_AGENT_WINBUILDIMAGES_SUFFIX" ] ||
             [ ! -z "$DATADOG_AGENT_ARMBUILDIMAGES_SUFFIX" ] ||
             [ ! -z "$DATADOG_AGENT_SYSPROBE_BUILDIMAGES_SUFFIX" ] ||
             [ ! -z "$DATADOG_AGENT_KERNEL_MATRIX_TESTING_BUILDIMAGES_SUFFIX" ] ||
             [ ! -z "$DATADOG_AGENT_NIKOS_BUILDIMAGES_SUFFIX" ] ||
             [ ! -z "$DATADOG_AGENT_BTF_GEN_BUILDIMAGES_SUFFIX" ] ||
             [ ! -z "$TEST_INFRA_DEFINITIONS_BUILDIMAGES_SUFFIX" ]; then
            echo "Pull request uses non-empty BUILDIMAGES_SUFFIX variable"
            echo "This workflow fails so that the pull request cannot be merged"
            exit 1
          fi
      - test "$(inv -e release.get-release-json-value --key=nightly::OMNIBUS_RUBY_VERSION)" = "datadog-5.5.0" || exit 1
      - test "$(inv -e release.get-release-json-value --key=nightly::OMNIBUS_SOFTWARE_VERSION)" = "master" || exit 1
      - test "$(inv -e release.get-release-json-value --key=nightly-a7::OMNIBUS_RUBY_VERSION)" = "datadog-5.5.0" || exit 1
      - test "$(inv -e release.get-release-json-value --key=nightly-a7::OMNIBUS_SOFTWARE_VERSION)" = "master" || exit 1
      - exit 0
