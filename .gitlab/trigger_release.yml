---
# trigger_release stage
# Contains jobs which trigger release pipelines in the datadog/agent-release-management repository.

# The trigger jobs are always run (even on failing pipelines)
# because there's no way to retry a trigger job once it gets skipped
# because of a pipeline failure, even when retrying the pipeline.
trigger_release_6:
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/deb_x64:$DATADOG_AGENT_BUILDIMAGES
  tags: ["runner:main", "size:2xlarge"]
  rules:
    !reference [.on_deploy_stable_or_beta_repo_branch_a6_always]
  stage: trigger_release
  script:
    - export RELEASE_VERSION=$(inv -e agent.version --major-version 6 --url-safe)
    - python3 -m pip install -r requirements.txt
    - inv pipeline.trigger-child-pipeline --repo-name "DataDog/agent-release-management" --ref "master" --variables "RELEASE_VERSION"

trigger_release_7:
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/deb_x64:$DATADOG_AGENT_BUILDIMAGES
  tags: ["runner:main", "size:2xlarge"]
  rules:
    !reference [.on_deploy_stable_or_beta_repo_branch_a7_always]
  stage: trigger_release
  script:
    - export RELEASE_VERSION=$(inv -e agent.version --major-version 7 --url-safe)
    - python3 -m pip install -r requirements.txt
    - inv pipeline.trigger-child-pipeline --repo-name "DataDog/agent-release-management" --ref "master" --variables "RELEASE_VERSION"
