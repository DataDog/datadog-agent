---
# rc_kubernetes_deploy stage
# Contains jobs to trigger a pipeline in our k8s-datadog-agent-ops repo to deploy release candidate build

rc_kubernetes_deploy_experimental:
  stage: rc_kubernetes_deploy
  # rules:
  # - if: $RC_STAGING_DEPLOYMENTS == "true"
  #   when: always
  # - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH =~ /7\.\d{2}\.x/' TODO - uncomment when done with testing
  #   when: always
  # - !reference [.on_deploy_a7]
  # needs:
  # - job: docker_trigger_internal
  #   artifacts: false
  # - job: docker_trigger_cluster_agent_internal
  #   artifacts: false
  # - job: k8s-e2e-main # Currently only require container Argo workflow
  #   artifacts: false
  #   optional: true
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/deb_x64$DATADOG_AGENT_BUILDIMAGES_SUFFIX:$DATADOG_AGENT_BUILDIMAGES
  tags: ["arch:amd64"]
  variables:
    OPTION_AUTOMATIC_ROLLOUT: "true"
    OPTION_PRE_SCRIPT: "patch-cluster-images-operator.sh env=all-staging 7.50.0-rc.2-jmx-d99ab6ec 7.50.0-rc.2-d99ab6ec"
    SKIP_PLAN_CHECK: "true"
    EXPLICIT_WORKFLOWS: "//workflows:deploy_rc.agents_rc"
  script:
    - source /root/.bashrc
    - export GITLAB_TOKEN=$(aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.gitlab_pipelines_scheduler_token --with-decryption --query "Parameter.Value" --out text)
    - inv pipeline.trigger-child-pipeline --project-name "DataDog/k8s-datadog-agent-ops" --git-ref "kacper-murzyn/rc-automatic-deployments" --variables "OPTION_AUTOMATIC_ROLLOUT,EXPLICIT_WORKFLOWS,OPTION_PRE_SCRIPT,SKIP_PLAN_CHECK" --no-follow
    