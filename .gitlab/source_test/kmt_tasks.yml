# This file contain jobs that tests the KMT tasks code. This doesn't launch any KMT tests themselves,
# that's done in .gitlab/kernel_matrix_testing

.test_kmt_local_setup:
  stage: source_test
  needs: []
  rules:
    - !reference [.on_invoke_tasks_changes]
  script:
    - git config --global url."https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.ddbuild.io/DataDog/".insteadOf "git@github.com:"
    # Avoid rate limits when running kmt.init (pulumi queries the Github API to get the releases of plugins)
    - export GITHUB_TOKEN=$(dda inv github.get-token-from-app)
    - export KMT_TEST_INFRA_DEFINITIONS_PATH="$(go env GOPATH)"/src/github.com/DataDog/test-infra-definitions
    - dda inv -- kmt.init --remote-setup-only --skip-ssh-setup --exclude-requirements $KMT_EXCLUDE_REQUIREMENTS --images ""
    - export PATH=$PATH:$HOME/.pulumi/bin  # Simulate a shell restart, required for the check
    - dda inv -- kmt.selfcheck --remote-setup-only --exclude-requirements $KMT_EXCLUDE_REQUIREMENTS --show-flare-for-failures

test_kmt_local_setup_linux:
  image: registry.ddbuild.io/ci/datadog-agent-buildimages/linux$CI_IMAGE_LINUX_SUFFIX:$CI_IMAGE_LINUX
  tags: ["arch:arm64"]
  extends: .test_kmt_local_setup
  before_script:
    - !reference [.setup_agent_github_app]
  variables:
    # Some requirements cannot be tested in the CI yet:
    # - Docker,Compiler,UserInDockerGroup: no docker-in-docker support in these jobs yet
    # - AWSConfig: no AWS config in the CI yet
    KMT_EXCLUDE_REQUIREMENTS: "Docker,Compiler,UserInDockerGroup,AWSConfig"

test_kmt_local_setup_macos:
  extends: .test_kmt_local_setup
  before_script:
    - !reference [.macos_gitlab, before_script]
  tags: ["macos:ventura-amd64", "specific:true"]
  variables:
     # Some requirements cannot be tested in the CI yet:
    # - Docker,Compiler,UserInDockerGroup: no docker-in-docker support in these jobs yet
    # - AWSConfig: no AWS config in the CI yet
    # - PulumiPlugins: no github tokens in the macos runner and the plugins download fails with rate limits sometimes
    # - MacBasePackages: brew fails to update in the CI
    KMT_EXCLUDE_REQUIREMENTS: "Docker,Compiler,UserInDockerGroup,AWSConfig,PulumiPlugins,MacBasePackages"
