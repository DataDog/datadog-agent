---
include:
  - .gitlab/common/container_publish_job_templates.yml

dev_branch-a6:
  extends: .docker_publish_job_definition
  stage: dev_container_deploy
  rules: !reference [.manual]
  needs:
    - docker_build_agent6
    - docker_build_agent6_jmx
    - docker_build_agent6_py2py3_jmx
  variables:
    IMG_REGISTRIES: dev
  parallel:
    matrix:
      - IMG_SOURCES: ${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-6-amd64
        IMG_DESTINATIONS: agent-dev:${CI_COMMIT_REF_SLUG},agent-dev:${CI_COMMIT_REF_SLUG}-py2
      - IMG_SOURCES: ${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-6-jmx-amd64
        IMG_DESTINATIONS: agent-dev:${CI_COMMIT_REF_SLUG}-jmx,agent-dev:${CI_COMMIT_REF_SLUG}-py2-jmx
      - IMG_SOURCES: ${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-6-py2py3-jmx-amd64
        IMG_DESTINATIONS: agent-dev:${CI_COMMIT_REF_SLUG}-py2py3-jmx

dev_branch-dogstatsd:
  extends: .docker_publish_job_definition
  stage: dev_container_deploy
  rules: !reference [.manual]
  needs:
    - docker_build_dogstatsd_amd64
    - docker_build_dogstatsd_arm64
  variables:
    IMG_REGISTRIES: dev
    IMG_SOURCES: ${SRC_DSD}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-amd64,${SRC_DSD}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-arm64
    IMG_DESTINATIONS: dogstatsd-dev:${CI_COMMIT_REF_SLUG}

dev_branch_multiarch-a6:
  extends: .docker_publish_job_definition
  stage: dev_container_deploy
  rules: !reference [.on_all_builds_manual]
  needs:
    - docker_build_agent6
    - docker_build_agent6_arm64
    - docker_build_agent6_jmx
    - docker_build_agent6_jmx_arm64
    - docker_build_agent6_py2py3_jmx
  variables:
    IMG_REGISTRIES: dev
  parallel:
    matrix:
      - IMG_SOURCES: ${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-6-amd64,${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-6-arm64
        IMG_DESTINATIONS: agent-dev:${CI_COMMIT_REF_SLUG},agent-dev:${CI_COMMIT_REF_SLUG}-py2
      - IMG_SOURCES: ${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-6-jmx-amd64,${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-6-jmx-arm64
        IMG_DESTINATIONS: agent-dev:${CI_COMMIT_REF_SLUG}-jmx,agent-dev:${CI_COMMIT_REF_SLUG}-py2-jmx
      - IMG_SOURCES: ${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-6-py2py3-jmx-amd64
        IMG_DESTINATIONS: agent-dev:${CI_COMMIT_REF_SLUG}-py2py3-jmx

dev_branch_multiarch-a7:
  extends: .docker_publish_job_definition
  stage: dev_container_deploy
  rules: !reference [.manual]
  needs:
    - docker_build_agent7
    - docker_build_agent7_arm64
    - docker_build_agent7_jmx
    - docker_build_agent7_jmx_arm64
  variables:
    IMG_REGISTRIES: dev
  parallel:
    matrix:
      - IMG_SOURCES: ${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-amd64,${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-arm64
        IMG_DESTINATIONS: agent-dev:${CI_COMMIT_REF_SLUG}-py3
      - IMG_SOURCES: ${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-jmx-amd64,${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-jmx-arm64
        IMG_DESTINATIONS: agent-dev:${CI_COMMIT_REF_SLUG}-py3-jmx

dev_branch_multiarch-dogstatsd:
  extends: .docker_publish_job_definition
  stage: dev_container_deploy
  rules: !reference [.manual]
  needs:
    - docker_build_dogstatsd_amd64
    - docker_build_dogstatsd_arm64
  variables:
    IMG_REGISTRIES: dev
    IMG_SOURCES: ${SRC_DSD}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-amd64,${SRC_DSD}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-arm64
    IMG_DESTINATIONS: dogstatsd-dev:${CI_COMMIT_REF_SLUG}

dev_master-a6:
  extends: .docker_publish_job_definition
  stage: dev_container_deploy
  rules: !reference [.on_main]
  needs:
    - docker_build_agent6
    - docker_build_agent6_arm64
    - docker_build_agent6_jmx
    - docker_build_agent6_jmx_arm64
    - docker_build_agent6_py2py3_jmx
  variables:
    IMG_REGISTRIES: dev
  parallel:
    matrix:
      - IMG_SOURCES: ${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-6-amd64,${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-6-arm64
        IMG_DESTINATIONS: agent-dev:master,agent-dev:master-py2
      - IMG_SOURCES: ${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-6-jmx-amd64,${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-6-jmx-arm64
        IMG_DESTINATIONS: agent-dev:master-jmx,agent-dev:master-py2-jmx

dev_master-a7:
  extends: .docker_publish_job_definition
  stage: dev_container_deploy
  rules: !reference [.on_main]
  needs:
    - docker_build_agent7
    - docker_build_agent7_arm64
    - docker_build_agent7_jmx
    - docker_build_agent7_jmx_arm64
  variables:
    IMG_REGISTRIES: dev
  parallel:
    matrix:
      - IMG_SOURCES: ${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-amd64,${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-arm64
        IMG_DESTINATIONS: agent-dev:master-py3
      - IMG_SOURCES: ${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-jmx-amd64,${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-jmx-arm64
        IMG_DESTINATIONS: agent-dev:master-py3-jmx

dev_master-dogstatsd:
  extends: .docker_publish_job_definition
  stage: dev_container_deploy
  rules: !reference [.on_main]
  needs:
    - docker_build_dogstatsd_amd64
    - docker_build_dogstatsd_arm64
  variables:
    IMG_REGISTRIES: dev
    IMG_SOURCES: ${SRC_DSD}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-amd64,${SRC_DSD}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-arm64
    IMG_DESTINATIONS: dogstatsd-dev:master

dca_dev_branch:
  extends: .docker_publish_job_definition
  stage: dev_container_deploy
  rules: !reference [.manual]
  needs:
    - docker_build_cluster_agent_amd64
  variables:
    IMG_REGISTRIES: dev
    IMG_SOURCES: ${SRC_DCA}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-amd64
    IMG_DESTINATIONS: cluster-agent-dev:${CI_COMMIT_REF_SLUG}

dca_dev_branch_multiarch:
  extends: .docker_publish_job_definition
  stage: dev_container_deploy
  rules: !reference [.on_all_builds_manual]
  needs:
    - docker_build_cluster_agent_amd64
    - docker_build_cluster_agent_arm64
  variables:
    IMG_REGISTRIES: dev
    IMG_SOURCES: ${SRC_DCA}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-amd64,${SRC_DCA}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-arm64
    IMG_DESTINATIONS: cluster-agent-dev:${CI_COMMIT_REF_SLUG}

dca_dev_master:
  extends: .docker_publish_job_definition
  stage: dev_container_deploy
  rules: !reference [.on_main]
  needs:
    - docker_build_cluster_agent_amd64
  variables:
    IMG_REGISTRIES: dev
    IMG_SOURCES: ${SRC_DCA}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-amd64
    IMG_DESTINATIONS: cluster-agent-dev:master

cws_instrumentation_dev_branch_multiarch:
  extends: .docker_publish_job_definition
  stage: dev_container_deploy
  rules: !reference [.on_all_builds_manual]
  needs:
    - docker_build_cws_instrumentation_amd64
    - docker_build_cws_instrumentation_arm64
  variables:
    IMG_REGISTRIES: dev
    IMG_SOURCES: ${SRC_CWS_INSTRUMENTATION}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-amd64,${SRC_CWS_INSTRUMENTATION}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-arm64
    IMG_DESTINATIONS: cws-instrumentation-dev:${CI_COMMIT_REF_SLUG}

# deploys nightlies to agent-dev
dev_nightly_docker_hub-a6:
  extends: .docker_publish_job_definition
  stage: dev_container_deploy
  rules: !reference [.on_deploy_nightly_repo_branch]
  needs:
    - docker_build_agent6
    - docker_build_agent6_arm64
    - docker_build_agent6_jmx
    - docker_build_agent6_jmx_arm64
    - docker_build_agent6_py2py3_jmx
  variables:
    IMG_REGISTRIES: dev
  parallel:
    matrix:
      - IMG_SOURCES: ${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-6-amd64,${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-6-arm64
        IMG_DESTINATIONS: agent-dev:nightly-${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA},agent-dev:nightly-${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}-py2,agent-dev:nightly-${CI_COMMIT_REF_SLUG}-py2
      - IMG_SOURCES: ${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-6-jmx-amd64,${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-6-jmx-arm64
        IMG_DESTINATIONS: agent-dev:nightly-${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}-jmx,agent-dev:nightly-${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}-py2-jmx,agent-dev:nightly-${CI_COMMIT_REF_SLUG}-py2-jmx

# deploys nightlies to agent-dev
dev_nightly-a7:
  extends: .docker_publish_job_definition
  stage: dev_container_deploy
  rules: !reference [.on_deploy_nightly_repo_branch]
  needs:
    - docker_build_agent7
    - docker_build_agent7_arm64
    - docker_build_agent7_jmx
    - docker_build_agent7_jmx_arm64
  variables:
    IMG_REGISTRIES: dev
  parallel:
    matrix:
      - IMG_SOURCES: ${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-amd64,${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-arm64
        IMG_DESTINATIONS: agent-dev:nightly-${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}-py3,agent-dev:nightly-${CI_COMMIT_REF_SLUG}-py3
      - IMG_SOURCES: ${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-jmx-amd64,${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-jmx-arm64
        IMG_DESTINATIONS: agent-dev:nightly-${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}-py3-jmx,agent-dev:nightly-${CI_COMMIT_REF_SLUG}-py3-jmx

# deploy nightly build to single-machine-performance
single_machine_performance-nightly-amd64-a7:
  extends: .docker_publish_job_definition
  stage: dev_container_deploy
  rules: !reference [.on_scheduled_main]
  needs:
    - docker_build_agent7
  variables:
    IMG_REGISTRIES: internal-aws-smp
    IMG_SOURCES: ${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-amd64
    IMG_DESTINATIONS: 08450328-agent:nightly-${CI_COMMIT_BRANCH}-${CI_COMMIT_SHA}-7-amd64

# deploys nightlies to agent-dev
dev_nightly-dogstatsd:
  extends: .docker_publish_job_definition
  stage: dev_container_deploy
  rules: !reference [.on_deploy_nightly_repo_branch]
  needs:
    - docker_build_dogstatsd_amd64
    - docker_build_dogstatsd_arm64
  variables:
    IMG_REGISTRIES: dev
    IMG_SOURCES: ${SRC_DSD}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-amd64,${SRC_DSD}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-arm64
    IMG_DESTINATIONS: dogstatsd-dev:nightly-${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA},dogstatsd-dev:nightly-${CI_COMMIT_REF_SLUG}

# push images to `datadog-agent-qa` ECR for the end-to-end tests defined in `e2e.yml`
qa_agent:
  extends: .docker_publish_job_definition
  stage: dev_container_deploy
  rules:
    - !reference [.on_aml_or_e2e_changes]
    - !reference [.on_apm_or_e2e_changes]
    - !reference [.on_container_or_e2e_changes]
    - !reference [.on_npm_or_e2e_changes]
    - !reference [.on_process_or_e2e_changes]
    - !reference [.manual]
  needs:
    - docker_build_agent7
    - docker_build_agent7_arm64
    - docker_build_agent7_windows1809
    - docker_build_agent7_windows2022
  variables:
    IMG_REGISTRIES: agent-qa
    IMG_SOURCES: ${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-amd64,${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-arm64,${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-win1809-amd64,${SRC_AGENT}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-7-winltsc2022-amd64
    IMG_DESTINATIONS: agent:${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}

qa_dca:
  extends: .docker_publish_job_definition
  stage: dev_container_deploy
  rules:
    - !reference [.on_container_or_e2e_changes]
    - !reference [.on_process_or_e2e_changes]
    - !reference [.manual]
  needs:
    - docker_build_cluster_agent_amd64
    - docker_build_cluster_agent_arm64
  variables:
    IMG_REGISTRIES: agent-qa
    IMG_SOURCES: ${SRC_DCA}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-amd64,${SRC_DCA}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-arm64
    IMG_DESTINATIONS: cluster-agent:${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}

qa_dogstatsd:
  extends: .docker_publish_job_definition
  stage: dev_container_deploy
  rules:
    - !reference [.on_container_or_e2e_changes]
    - !reference [.manual]
  needs:
    - docker_build_dogstatsd_amd64
    - docker_build_dogstatsd_arm64
  variables:
    IMG_REGISTRIES: agent-qa
    IMG_SOURCES: ${SRC_DSD}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-amd64,${SRC_DSD}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-arm64
    IMG_DESTINATIONS: dogstatsd:${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}

.qa_cws_instrumentation:
  extends: .docker_publish_job_definition
  stage: dev_container_deploy
  needs:
    - docker_build_cws_instrumentation_amd64
    - docker_build_cws_instrumentation_arm64
  variables:
    IMG_REGISTRIES: agent-qa
    IMG_SOURCES: ${SRC_CWS_INSTRUMENTATION}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-amd64,${SRC_CWS_INSTRUMENTATION}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}-arm64
    IMG_DESTINATIONS: cws-instrumentation:${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}

qa_cws_instrumentation:
  extends: .qa_cws_instrumentation
  rules:
    - !reference [.on_cws_or_e2e_changes]
    - !reference [.manual]

