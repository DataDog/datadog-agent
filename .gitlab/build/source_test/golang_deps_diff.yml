---
# golang_deps_diff stage
# Contains the step to generate diff of go imports for each binary/build
golang_deps_diff:
  stage: source_test
  image: registry.ddbuild.io/ci/datadog-agent-buildimages/linux$CI_IMAGE_LINUX_SUFFIX:$CI_IMAGE_LINUX
  tags: ["arch:amd64", "specific:true"]
  rules:
    - !reference [.on_dev_branches]
    - when: on_success
  needs: ["go_deps"]
  variables:
    KUBERNETES_CPU_REQUEST: 8
    OVERRIDE_GIT_STRATEGY: "clone" # needed because this job uses `git merge-base`
    KUBERNETES_MEMORY_REQUEST: "16Gi"
    KUBERNETES_MEMORY_LIMIT: "16Gi"
  before_script:
    - !reference [.retrieve_linux_go_deps]
  script:
    # Get API key to send metrics
    - DD_API_KEY=$($CI_PROJECT_DIR/tools/ci/fetch_secret.sh $AGENT_API_KEY_ORG2 token) || exit $?; export DD_API_KEY
    - dda inv -- -e go-deps.diff --report-file=deps-report.md --report-metrics --git-ref "${CI_COMMIT_REF_NAME}"
  artifacts:
    paths:
      - deps-report.md
    expire_in: 2 weeks

golang_deps_commenter:
  stage: source_test
  image: registry.ddbuild.io/ci/datadog-agent-buildimages/linux$CI_IMAGE_LINUX_SUFFIX:$CI_IMAGE_LINUX
  tags: ["arch:amd64", "specific:true"]
  rules:
    - !reference [.on_dev_branches]
    - when: on_success
  needs: ["golang_deps_diff"]
  script:
    - GITHUB_KEY_B64=$($CI_PROJECT_DIR/tools/ci/fetch_secret.sh $AGENT_GITHUB_APP key_b64) || exit $?; export GITHUB_KEY_B64
    - GITHUB_APP_ID=$($CI_PROJECT_DIR/tools/ci/fetch_secret.sh $AGENT_GITHUB_APP app_id) || exit $?; export GITHUB_APP_ID
    - if [ ! -s deps-report.md ]; then
        dda inv -- -e github.pr-commenter --title="Go Package Import Differences" --force-delete ;
      else
        dda inv -- -e github.pr-commenter --title="Go Package Import Differences" --body-file=deps-report.md ;
      fi

golang_deps_send_count_metrics:
  stage: source_test
  image: registry.ddbuild.io/ci/datadog-agent-buildimages/linux$CI_IMAGE_LINUX_SUFFIX:$CI_IMAGE_LINUX
  tags: ["arch:amd64", "specific:true"]
  needs: ["go_deps"]
  before_script:
    - !reference [.retrieve_linux_go_deps]
  script:
    # Get API key to send metrics
    - DD_API_KEY=$($CI_PROJECT_DIR/tools/ci/fetch_secret.sh $AGENT_API_KEY_ORG2 token) || exit $?; export DD_API_KEY
    - dda inv -- -e go-deps.send-count-metrics --git-sha "${CI_COMMIT_SHA}" --git-ref "${CI_COMMIT_REF_NAME}"
