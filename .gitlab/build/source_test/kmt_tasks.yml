# This file contain jobs that tests the KMT tasks code. This doesn't launch any KMT tests themselves,
# that's done in .gitlab/test/kernel_matrix_testing

.test_kmt_local_setup:
  stage: source_test
  needs: []
  rules:
    - !reference [.on_invoke_tasks_changes]
    - !reference [.except_mergequeue]
    - changes:
        paths:
          - .gitlab/build/source_test/kmt_tasks.yml
        compare_to: $COMPARE_TO_BRANCH
  script:
    # Avoid rate limits when running kmt.init (pulumi queries the Github API to get the releases of plugins)
    - export GITHUB_TOKEN=$(dda inv github.get-token-from-app)
    - dda inv -- kmt.init --remote-setup-only --skip-ssh-setup --exclude-requirements $KMT_EXCLUDE_REQUIREMENTS --images ""
    - export PATH=$PATH:$HOME/.pulumi/bin  # Simulate a shell restart, required for the check
    - dda inv -- kmt.selfcheck --remote-setup-only --exclude-requirements $KMT_EXCLUDE_REQUIREMENTS --show-flare-for-failures

test_kmt_local_setup_linux:
  image: registry.ddbuild.io/ci/datadog-agent-buildimages/linux$CI_IMAGE_LINUX_SUFFIX:$CI_IMAGE_LINUX
  tags: ["arch:arm64"]
  extends: .test_kmt_local_setup
  before_script:
    - !reference [.setup_agent_github_app]
    # ADMS diagnostic: verify that GOPROXY/GOTOOLCHAIN are correctly set on the arm64 runner.
    # The go_deps diagnostic confirmed GOPROXY works on amd64 specific:true runners, but
    # test-kmt-local-setup-linux runs on standard arm64 runners with a different Docker image.
    - echo "Shell GOPROXY=${GOPROXY}"
    - go env GOPROXY GONOSUMDB GOTOOLCHAIN GOENV
    - cat "$(go env GOENV)" 2>/dev/null || echo "(no GOENV file)"
  variables:
    # Some requirements cannot be tested in the CI yet:
    # - Docker,Compiler,UserInDockerGroup: no docker-in-docker support in these jobs yet
    # - AWSConfig: no AWS config in the CI yet
    KMT_EXCLUDE_REQUIREMENTS: "Docker,Compiler,UserInDockerGroup,AWSConfig"

test_kmt_local_setup_macos:
  extends: .test_kmt_local_setup
  before_script:
    - !reference [.vault_login]
    - !reference [.aws_retry_config]
    - !reference [.setup_agent_github_app]
    # Selecting the current Go version
    - |
      eval $(gimme $(cat .go-version))
      export GOPATH=$GOROOT
    - !reference [.install_python_dependencies]
    # See there is no virtualization, we need to clean the environment regularly
    - !reference [.macos_runner_maintenance]
  tags: ["macos:sonoma-arm64", "specific:true"]
  variables:
     # Some requirements cannot be tested in the CI yet:
    # - Docker,Compiler,UserInDockerGroup: no docker-in-docker support in these jobs yet
    # - AWSConfig: no AWS config in the CI yet
    # - PulumiPlugins: no github tokens in the macos runner and the plugins download fails with rate limits sometimes
    # - MacBasePackages: brew fails to update in the CI
    KMT_EXCLUDE_REQUIREMENTS: "Docker,Compiler,UserInDockerGroup,AWSConfig,PulumiPlugins,MacBasePackages"
  id_tokens:
    CI_IDENTITIES_GITLAB_ID_TOKEN:
      aud: ci-identities
