---
.lint_script:
  - dda inv -- -e rtloader.make --install-prefix=$CI_PROJECT_DIR/dev
  - dda inv -- -e rtloader.install
  - dda inv -- -e linter.go --cpus $KUBERNETES_CPU_REQUEST --debug $FLAVORS $EXTRA_OPTS

.linux_lint:
  stage: lint
  needs: ["go_deps", "go_tools_deps"]
  variables:
    FLAVORS: '--flavor base'
    KUBERNETES_CPU_REQUEST: 16
    KUBERNETES_MEMORY_REQUEST: 32Gi
    KUBERNETES_MEMORY_LIMIT: 32Gi
  before_script:
    - !reference [.retrieve_linux_go_deps]
    - !reference [.retrieve_linux_go_tools_deps]
  script:
    - !reference [.lint_script]

.linux_x64:
  image: registry.ddbuild.io/ci/datadog-agent-buildimages/linux$CI_IMAGE_LINUX_SUFFIX:$CI_IMAGE_LINUX
  tags: ["arch:amd64-cidc"]

.linux_arm64:
  image: registry.ddbuild.io/ci/datadog-agent-buildimages/linux$CI_IMAGE_LINUX_SUFFIX:$CI_IMAGE_LINUX
  tags: ["arch:arm64-cidc"]

lint_linux-x64:
  extends:
    - .linux_lint
    - .linux_x64

lint_linux-arm64:
  extends:
    - .linux_lint
    - .linux_arm64
  needs: ["go_deps", "go_tools_deps_arm64"]
  before_script:
    - !reference [.retrieve_linux_go_deps]
    - !reference [.retrieve_linux_go_tools_deps_arm64]

lint_flavor_iot_linux-x64:
  extends:
    - .linux_lint
    - .linux_x64
  variables:
    FLAVORS: '--flavor iot'

lint_flavor_dogstatsd_linux-x64:
  extends:
    - .linux_lint
    - .linux_x64
  variables:
    FLAVORS: '--flavor dogstatsd'

lint_flavor_heroku_linux-x64:
  extends:
    - .linux_lint
    - .linux_x64
  variables:
    FLAVORS: '--flavor heroku'
