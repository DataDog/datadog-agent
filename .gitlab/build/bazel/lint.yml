.bazel:lint:
  stage: lint
  after_script:
    - |-
      if [ $CI_JOB_STATUS = failed ]; then
        echo >&2 "ðŸ’¡ To fix the above problem, please consider running the following command:"
        echo >&2 "$FIX_COMMAND"
      fi

bazel:mod-deps:
  extends: [ .bazel:lint, .bazel:runner:linux-amd64 ]
  script:
    # Why not `bazel mod deps --lockfile_mode=error`:
    # 1. `bazel` servers on persistent runners cache non-local repository rules, causing stale checks (#incident-46079),
    # 2. `--lockfile_mode=error` doesn't print discrepancies exhaustively, especially on rules_* lock files.
    #
    # Instead:
    # 1. use `--lockfile_mode=refresh` to forcibly re-evaluate non-local repository rules,
    # 2. use `--repo_env=REPIN=1` to regenerate rules_* lock files:
    #    - rules_jvm_external: implies RULES_JVM_EXTERNAL_REPIN=1 for maven_install.json,
    #    - rules_rust: implies CARGO_BAZEL_REPIN=1 for Cargo.Bazel.lock,
    # 3. use `git diff --exit-code` to still fail on any discrepancies while printing them exhaustively.
    - bazel mod deps --lockfile_mode=refresh --repo_env=REPIN=1
    - git diff --exit-code
  variables:
    FIX_COMMAND: "bazel mod deps --repo_env=REPIN=1"

bazel:mod-tidy:
  extends: [ .bazel:lint, .bazel:runner:linux-amd64 ]
  script:
    - bazel mod tidy --lockfile_mode=off
    - git diff --exit-code
  variables:
    FIX_COMMAND: "bazel mod tidy"

bazel:run-buildifier-test:
  extends: [ .bazel:lint, .bazel:runner:linux-amd64 ]
  script:
    - bazel run //bazel/buildifier:test
  variables:
    FIX_COMMAND: "bazel run //bazel/buildifier"

bazel:run-gazelle:
  extends: [ .bazel:lint, .bazel:runner:linux-amd64 ]
  script:
    - bazel run //:gazelle -- -mode=diff -strict
  variables:
    FIX_COMMAND: "bazel run //:gazelle"

bazel:run-go-mod-tidy:
  extends: [ .bazel:lint, .bazel:runner:linux-amd64 ]
  script:
    - bazel run //:go_mod_tidy_all -- -diff
  variables:
    FIX_COMMAND: "bazel run //:go_mod_tidy_all"
