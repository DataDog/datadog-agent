bazel:mod-deps:
  extends: .bazel:runner:linux-amd64
  stage: lint
  script:
    # Why not `bazel mod deps --lockfile_mode=error`:
    # 1. `bazel` servers on persistent runners cache non-local repository rules, causing stale checks (#incident-46079),
    # 2. `--lockfile_mode=error` doesn't print discrepancies exhaustively, especially on rules_* lock files.
    #
    # Instead:
    # 1. use `--lockfile_mode=refresh` to forcibly re-evaluate non-local repository rules,
    # 2. use `--repo_env=REPIN=1` to regenerate rules_* lock files:
    #    - rules_jvm_external: implies RULES_JVM_EXTERNAL_REPIN=1 for maven_install.json,
    #    - rules_rust: implies CARGO_BAZEL_REPIN=1 for Cargo.Bazel.lock,
    # 3. use `git diff --exit-code` to still fail on any discrepancies while printing them exhaustively.
    - bazel mod deps --lockfile_mode=refresh --repo_env=REPIN=1
    - git diff --exit-code
  after_script:
    - |-
      if [ $CI_JOB_STATUS = failed ]; then
        echo >&2 "ðŸ’¡ bazel mod deps --repo_env=REPIN=1"
      fi

bazel:mod-tidy:
  extends: .bazel:runner:linux-amd64
  stage: lint
  script:
    - bazel mod tidy --lockfile_mode=off
    - git diff --exit-code
  after_script:
    - |-
      if [ $CI_JOB_STATUS = failed ]; then
        echo >&2 "ðŸ’¡ bazel mod tidy"
      fi

bazel:run-buildifier-test:
  extends: .bazel:runner:linux-amd64
  stage: lint
  script:
    - bazel run //bazel/buildifier:test
  after_script:
    - |-
      if [ $CI_JOB_STATUS = failed ]; then
        echo >&2 "ðŸ’¡ bazel run //bazel/buildifier"
      fi

bazel:run-gazelle:
  extends: .bazel:runner:linux-amd64
  stage: lint
  script:
    - bazel run //:gazelle -- -mode=diff -strict
  after_script:
    - |-
      if [ $CI_JOB_STATUS = failed ]; then
        echo >&2 "ðŸ’¡ bazel run //:gazelle"
      fi

bazel:run-go-mod-tidy:
  extends: .bazel:runner:linux-amd64
  stage: lint
  script:
    - bazel run //:go mod tidy -- -diff
  after_script:
    - |-
      if [ $CI_JOB_STATUS = failed ]; then
        echo >&2 "ðŸ’¡ bazel run //:go mod tidy"
      fi
