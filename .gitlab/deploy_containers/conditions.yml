
# Rule to make job manual when running deploy pipelines, or automatic and on success on RC pipelines
.manual_on_deploy_auto_on_rc:
  - if: $BUCKET_BRANCH != "beta" && $BUCKET_BRANCH != "stable"
    when: manual
    allow_failure: true
    variables:
      AGENT_REPOSITORY: agent-dev
      IMG_REGISTRIES: dev
  - if: $CI_COMMIT_TAG =~ /^[0-9]+\.[0-9]+\.[0-9]+-rc\.[0-9]+$/ && $FORCE_MANUAL != "true"
    when: on_success
    variables:
      AGENT_REPOSITORY: agent-dev
      IMG_REGISTRIES: dev
  - if: $CI_COMMIT_TAG =~ /^[0-9]+\.[0-9]+\.[0-9]+-rc\.[0-9]+$/ && $FORCE_MANUAL == "true"
    when: manual
    allow_failure: true
    variables:
      AGENT_REPOSITORY: agent-dev
      IMG_REGISTRIES: dev
  - when: manual
    allow_failure: true
    variables:
      AGENT_REPOSITORY: agent-dev
      IMG_REGISTRIES: dev

# Rule for job that are triggered on_success on RC pipelines
.on_rc:
  - if: $FORCE_MANUAL == "true" && $CI_COMMIT_TAG =~ /^[0-9]+\.[0-9]+\.[0-9]+-rc\.[0-9]+$/
    when: manual
    variables:
      AGENT_REPOSITORY: agent-dev
      IMG_REGISTRIES: dev
  - if: $CI_COMMIT_TAG =~ /^[0-9]+\.[0-9]+\.[0-9]+-rc\.[0-9]+$/
    when: on_success
    variables:
      AGENT_REPOSITORY: agent-dev
      IMG_REGISTRIES: dev

# Rule for job that can be triggered manually on final build, deploy to prod repository on stable branch deploy, else to dev repository
.on_final:
  - if: $BUCKET_BRANCH == "beta"
    when: never
  - if: $BUCKET_BRANCH != "beta" && $BUCKET_BRANCH != "stable"
    when: manual
    allow_failure: true
    variables:
      AGENT_REPOSITORY: agent-dev
      IMG_REGISTRIES: dev
  - when: manual
    allow_failure: true
    variables:
      AGENT_REPOSITORY: agent
      IMG_REGISTRIES: public
