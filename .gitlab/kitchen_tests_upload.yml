kitchen_tests_upload_common:
  stage: kitchen_tests_upload
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/datadog-ci-uploader$DATADOG_AGENT_BUILDIMAGES_SUFFIX:$DATADOG_AGENT_BUILDIMAGES
  tags: ["runner:main"]
  allow_failure: true
  when: always
  needs:
    - job : kitchen_centos_fips_install_script_agent-a7
      artifacts: true
    - job : kitchen_debian_install_script_agent-a7_x64
      artifacts: true
    - job : kitchen_ubuntu_install_script_agent-a7_x64
      artifacts: true
    - job : kitchen_suse_install_script_agent-a7
      artifacts: true
    - job : kitchen_amazonlinux_install_script_agent-a7_x64
      artifacts: true
  variables:
    DD_ENV: ci
  script:
    - set +x   
    - find . -name "kitchen-rspec-common-*.tar.gz"
    - export DATADOG_API_KEY=$(aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.datadog_api_key_org2 --with-decryption --query "Parameter.Value" --out text)
    - set -x
    - find . -maxdepth 1 -type f -name "kitchen-rspec-common-*.tar.gz" -exec inv -e junit-upload --tgz-path {} \;
