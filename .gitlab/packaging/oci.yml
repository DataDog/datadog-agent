.packaging_oci:
  stage: packaging
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/deb_x64$DATADOG_AGENT_BUILDIMAGES_SUFFIX:$DATADOG_AGENT_BUILDIMAGES
  tags: ["arch:amd64"]
  variables:
    KUBERNETES_CPU_REQUEST: 16
    KUBERNETES_MEMORY_REQUEST: "32Gi"
    KUBERNETES_MEMORY_LIMIT: "32Gi"
  script:
    - python3 -m pip install -r tasks/libs/requirements-github.txt
    - export GITHUB_KEY_B64=$($CI_PROJECT_DIR/tools/ci/aws_ssm_get_wrapper.sh ci.datadog-agent.platform-github-app-key)
    - export GITHUB_APP_ID=682216
    - export PACKAGE_VERSION=$(inv agent.version --url-safe --major-version 7)
    - export SIMPLE_VERSION=$(inv agent.version --no-include-git --no-include-pre --major-version 7)
    - set +x
    - export GH_TOKEN=$(inv -e github.get-token-from-app --app-id-env=GITHUB_APP_ID --pkey-env=GITHUB_KEY_B64)
    - git config --global credential.helper '!f() { echo username=x-access-token; echo "password=$GH_TOKEN"; };f'
    - cd /tmp/
    - git clone https://github.com/DataDog/datadog-packages
    - cd datadog-packages/cmd/datadog-package
    - go build .
    - mkdir -p /tmp/input
    - export OUTPUT_FILE=$(basename -a -s .xz $OMNIBUS_PACKAGE_DIR/*.tar.xz | head -n 1)
    - tar xJf $OMNIBUS_PACKAGE_DIR/datadog${FLAVOR:+-$FLAVOR}-agent-*.tar.xz -C /tmp/input/
    - rm -f $OMNIBUS_PACKAGE_DIR/datadog${FLAVOR:+-$FLAVOR}-agent-*.tar.xz*
    - ./datadog-package create --version ${PACKAGE_VERSION} --package datadog-agent --os linux --arch ${PACKAGE_ARCH} --archive --archive-path "${OMNIBUS_PACKAGE_DIR}/${OUTPUT_FILE}" /tmp/input/opt/datadog-packages/datadog-agent/${SIMPLE_VERSION}*/
    - $S3_CP_CMD ${OMNIBUS_PACKAGE_DIR}/${OUTPUT_FILE} ${S3_ARTIFACTS_URI}/
  before_script:
    - source /root/.bashrc
  artifacts:
    paths:
      - ${OMNIBUS_PACKAGE_DIR}

packaging_oci_amd64:
  extends: .packaging_oci
  needs: ["agent_remote_updater-x64-a7"]
  variables:
    PACKAGE_ARCH: amd64

packaging_oci_arm64:
  extends: .packaging_oci
  needs: ["agent_remote_updater-arm64-a7"]
  variables:
    PACKAGE_ARCH: arm64
