.new-e2e_agent_a6:
  rules: !reference [.on_kitchen_tests_a6] #TODO: Change when migration is complete to another name without 'kitchen'
  variables:
    AGENT_MAJOR_VERSION: 6
  retry: 1

.new-e2e_agent_a7:
  rules: !reference [.on_kitchen_tests_a7] #TODO: Change when migration is complete to another name without 'kitchen'
  variables:
    AGENT_MAJOR_VERSION: 7
  retry: 1

.new-e2e_install_script:
  variables:
    TARGETS: ./tests/agent-platform/install-script
    TEAM: agent-platform
    EXTRA_PARAMS: --osversion $E2E_OSVERS --platform $E2E_PLATFORM --cws-supported-osversion $E2E_CWS_SUPPORTED_OSVERS --major-version $AGENT_MAJOR_VERSION --arch $E2E_ARCH --flavor $FLAVOR --no-verbose

.new-e2e_step_by_step:
  variables:
    TARGETS: ./tests/agent-platform/step-by-step
    TEAM: agent-platform
    EXTRA_PARAMS: --osversion $E2E_OSVERS --platform $E2E_PLATFORM --cws-supported-osversion $E2E_CWS_SUPPORTED_OSVERS --major-version $AGENT_MAJOR_VERSION --arch $E2E_ARCH --flavor $FLAVOR

.new-e2e_package_signing:
  variables:
    TARGETS: ./tests/agent-platform/package-signing
    TEAM: agent-platform
    EXTRA_PARAMS: --osversion $E2E_BRANCH_OSVERS
    
.new-e2e_script_upgrade6:
  variables:
    TARGETS: ./tests/agent-platform/upgrade
    TEAM: agent-platform
    EXTRA_PARAMS: --osversion $E2E_OSVERS --platform $E2E_PLATFORM --arch $E2E_ARCH --flavor $FLAVOR
  parallel:
    matrix:
      - START_MAJOR_VERSION: [5,6]
        END_MAJOR_VERSION: [6]
  script:
    - export DATADOG_AGENT_API_KEY=$(aws ssm get-parameter --region us-east-1 --name ci.agent-linux-install-script.datadog_api_key --with-decryption --query "Parameter.Value" --out text)
    - inv -e new-e2e-tests.run --targets $TARGETS --junit-tar "junit-${CI_JOB_NAME}.tgz" ${EXTRA_PARAMS} --src-agent-version $START_MAJOR_VERSION --dest-agent-version $END_MAJOR_VERSION

.new-e2e_script_upgrade7:
  variables:
    TARGETS: ./tests/agent-platform/upgrade
    TEAM: agent-platform
    EXTRA_PARAMS: --osversion $E2E_OSVERS --platform $E2E_PLATFORM --arch $E2E_ARCH --flavor $FLAVOR
  parallel:
    matrix:
      - START_MAJOR_VERSION: [5,6,7]
        END_MAJOR_VERSION: [7]
  script:
    - export DATADOG_AGENT_API_KEY=$(aws ssm get-parameter --region us-east-1 --name ci.agent-linux-install-script.datadog_api_key --with-decryption --query "Parameter.Value" --out text)
    - inv -e new-e2e-tests.run --targets $TARGETS --junit-tar "junit-${CI_JOB_NAME}.tgz" ${EXTRA_PARAMS} --src-agent-version $START_MAJOR_VERSION --dest-agent-version $END_MAJOR_VERSION
