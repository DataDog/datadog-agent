---
# notify stage
# Contains jobs which send notifications depending on pipeline status.

include:
  - https://gitlab-templates.ddbuild.io/slack-notifier/v3-sdm/template.yml

notify-on-tagged-success:
  extends: .slack-notifier-base
  stage: notify
  rules: !reference [.on_deploy_stable_or_beta_repo_branch]
  dependencies: []
  tags: ["arch:amd64"]
  script: |
    MESSAGE_TEXT=":host-green: Tagged build <$CI_PIPELINE_URL|$CI_PIPELINE_ID> succeeded.
    *$CI_COMMIT_REF_NAME* is available in the staging repositories."
    postmessage "#agent-release-sync" "$MESSAGE_TEXT"

notify:
  extends: .slack-notifier-base
  stage: notify
  rules: !reference [.on_main_or_release_branch_or_deploy_always]
  dependencies: []
  tags: ["arch:amd64"]
  resource_group: notification
  timeout: 15 minutes # Added to prevent a stuck job blocking the resource_group defined above
  script:
    - !reference [.setup_python_mirror_linux]
    - !reference [.install_authanywhere]
    - python3 -m pip install -r tasks/libs/requirements-notifications.txt
    - |
      # Do not send notifications if this is a child pipeline of another repo
      # The triggering repo should already have its own notification system
      if [ "$CI_PIPELINE_SOURCE" != "pipeline" ]; then
        invoke notify.check-consistent-failures
      else
        echo "This pipeline was triggered by another repository, skipping notification."
      fi

send_pipeline_stats:
  stage: notify
  image: registry.ddbuild.io/ci/datadog-agent-buildimages/deb_x64$DATADOG_AGENT_BUILDIMAGES_SUFFIX:$DATADOG_AGENT_BUILDIMAGES
  tags: ["arch:amd64"]
  when: always
  dependencies: []
  script:
    - source /root/.bashrc
    - !reference [.install_authanywhere]
    - export DD_API_KEY=$($CI_PROJECT_DIR/tools/ci/aws_ssm_get_wrapper.sh $API_KEY_ORG2_SSM_NAME)
    - !reference [.setup_python_mirror_linux]
    - invoke -e notify.send-stats
