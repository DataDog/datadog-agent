functional_test_junit_upload_security_agent:
  stage: functional_test_junit_upload
  rules:
    - !reference [.except_mergequeue]
    - when: always
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/datadog-ci-uploader$DATADOG_AGENT_BUILDIMAGES_SUFFIX:$DATADOG_AGENT_BUILDIMAGES
  tags: ["arch:amd64"]
  allow_failure: true
  needs:
    - job: kitchen_test_security_agent_arm64
      optional: true
    - job: kitchen_test_security_agent_amazonlinux_x64
      optional: true
  variables:
    DD_ENV: ci
  script:
    - set +x
    - export DATADOG_API_KEY=$(aws ssm get-parameter --region us-east-1 --name ci.datadog-agent.datadog_api_key_org2 --with-decryption --query "Parameter.Value" --out text)
    - set -x
    - ss=0; for f in $DD_AGENT_TESTING_DIR/kitchen-junit-*.tar.gz; do [[ -e "$f" ]] || continue; inv -e junit-upload --tgz-path $f || ((ss++)); done; exit $ss
