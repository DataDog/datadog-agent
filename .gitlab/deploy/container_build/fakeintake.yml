---
docker_build_fakeintake:
  stage: container_build
  rules:
    - !reference [.except_mergequeue]
    - !reference [.on_fakeintake_changes]
    - !reference [.on_fakeintake_changes_on_main]
  needs: []
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/docker:20.10-py3
  tags: ["arch:amd64", "specific:true"]
  variables:
    TARGET: registry.ddbuild.io/ci/datadog-agent/fakeintake:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}
    DOCKERFILE: test/fakeintake/Dockerfile
    PLATFORMS: linux/amd64,linux/arm64
    BUILD_CONTEXT: .
    BASE_IMAGE_REGISTRY: "registry.ddbuild.io/images/mirror"
  script:
    - !reference [.login_to_docker_readonly]
    - |
      set -o pipefail
      BUILD_OUTPUT=$(mktemp)
      if ! docker buildx build --push --pull --platform ${PLATFORMS} --build-arg=CI --build-arg=BASE_IMAGE_REGISTRY=${BASE_IMAGE_REGISTRY} --file ${DOCKERFILE} --tag ${TARGET} $BUILD_CONTEXT 2>&1 | tee "$BUILD_OUTPUT"; then
        if grep -qE 'failed to resolve reference|failed to resolve|manifest unknown|pull access denied|repository does not exist|failed to fetch' "$BUILD_OUTPUT"; then
          echo "Build failed likely due to base image not yet in internal registry, retrying with docker.io..."
          docker buildx build --push --pull --platform ${PLATFORMS} --build-arg=CI --build-arg=BASE_IMAGE_REGISTRY=docker.io --file ${DOCKERFILE} --tag ${TARGET} $BUILD_CONTEXT
        else
          exit 1
        fi
      fi
  retry: 2
