.bazel:defs:
  cache:
    - key:
        prefix: bazelversion-$CI_RUNNER_DESCRIPTION
        files: [ .bazelversion ]
      paths:
        - .cache/bazelisk
        - .cache/bazel/install
      policy: pull-push
      when: on_success
    - key: bazel-$CI_RUNNER_DESCRIPTION
      paths:
        - .cache/bazel/cache
        - .cache/bazel/disk
        - .cache/bazel/repo-contents
      policy: pull-push
      when: on_success
  needs: [ ]
  variables:
    BAZELISK_HOME: "$XDG_CACHE_HOME/bazelisk"
    BAZEL_DISK_CACHE: "$BAZEL_OUTPUT_USER_ROOT/disk"
    BAZEL_OUTPUT_USER_ROOT: "$XDG_CACHE_HOME/bazel"
    BAZEL_REPO_CONTENTS_CACHE: "$BAZEL_OUTPUT_USER_ROOT/repo-contents"
    XDG_CACHE_HOME: "$CI_PROJECT_DIR/.cache"

.bazel:runner:linux-amd64:
  cache: []
  rules: !reference [..setup-datadog-ci-sections ]
  variables:
    XDG_CACHE_HOME: /data/bzl
  tags: [ "k8s-persistent:amd64", "specific:true" ]

.bazel:runner:linux-arm64:
  extends: .linux_arm64
  rules: !reference [..setup-datadog-ci-sections ]

.bazel:runner:macos-amd64:
  rules: !reference [..setup-datadog-ci-sections ]
  tags: [ "macos:sonoma-amd64", "specific:true" ]

.bazel:runner:macos-arm64:
  rules: !reference [..setup-datadog-ci-sections ]
  tags: [ "macos:sonoma-arm64", "specific:true" ]

.bazel:runner:windows-amd64:
  extends: .windows_docker_default
  rules: !reference [..setup-datadog-ci-sections ]
  timeout: 60m # pulling images alone can take more than 30m
  cache: []
  variables:
    ARCH: x64
    GIT_DEPTH: 2
    XDG_CACHE_HOME: c:\bzl
  script:
    - |-
      $FailFast = @'
      $ErrorActionPreference = 'Stop'
      $PSNativeCommandUseErrorActionPreference = $true
      Set-StrictMode -Version 3.0
      '@
      Invoke-Expression $FailFast
      $Utf8Script = [Text.Encoding]::UTF8.GetString([Text.Encoding]::GetEncoding([Console]::OutputEncoding.CodePage).GetBytes($POWERSHELL_SCRIPT))
      $EncodedCommand = [Convert]::ToBase64String([Text.Encoding]::Unicode.GetBytes("$FailFast`n$Utf8Script"))
      New-Item -ItemType Directory -Path "$XDG_CACHE_HOME" -Force | Out-Null
    - >-
      docker run
      --env=BAZELISK_HOME
      --env=BAZEL_DISK_CACHE
      --env=BAZEL_OUTPUT_USER_ROOT
      --env=BAZEL_REPO_CONTENTS_CACHE
      --env=CI_PROJECT_DIR
      --rm
      --volume="${CI_PROJECT_DIR}:$CI_PROJECT_DIR"
      --volume="${XDG_CACHE_HOME}:$XDG_CACHE_HOME"
      --workdir="$CI_PROJECT_DIR"
      "$WINBUILDIMAGE"
      powershell -NonInteractive -NoLogo -NoProfile -InputFormat Text -OutputFormat Text -EncodedCommand $EncodedCommand
