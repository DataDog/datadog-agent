.bazel:defs:
  cache:
    - key:
        prefix: bazelversion-$CI_RUNNER_DESCRIPTION
        files: [ .bazelversion ]
      paths:
        - .cache/bazelisk
        - .cache/bazel/install
      policy: pull-push
      when: on_success
    - key: bazel-$CI_RUNNER_DESCRIPTION
      paths:
        - .cache/bazel/cache
        - .cache/bazel/disk
        - .cache/bazel/repo-contents
      policy: pull-push
      when: on_success
  needs: [ ]
  variables:
    BAZELISK_HOME: "$XDG_CACHE_HOME/bazelisk"
    BAZEL_DISK_CACHE: "$BAZEL_OUTPUT_USER_ROOT/disk"
    BAZEL_OUTPUT_USER_ROOT: "$XDG_CACHE_HOME/bazel"
    BAZEL_REPO_CONTENTS_CACHE: "$BAZEL_OUTPUT_USER_ROOT/repo-contents"
    XDG_CACHE_HOME: "$CI_PROJECT_DIR/.cache"

.bazel:ext:windows:
  extends: .windows_docker_default
  timeout: 60m # pulling images alone can take more than 30m
  variables:
    GIT_DEPTH: 2
  script:
    - |-
      $FailFast = @'
      $ErrorActionPreference = 'Stop'
      $PSNativeCommandUseErrorActionPreference = $true
      Set-StrictMode -Version 3.0
      '@
      Invoke-Expression $FailFast
      $Utf8Script = [Text.Encoding]::UTF8.GetString([Text.Encoding]::GetEncoding([Console]::OutputEncoding.CodePage).GetBytes($SCRIPT))
      $EncodedCommand = [Convert]::ToBase64String([Text.Encoding]::Unicode.GetBytes("$FailFast`n$Utf8Script"))
    - >-
      docker run
      --env=BAZELISK_HOME
      --env=BAZEL_DISK_CACHE
      --env=BAZEL_OUTPUT_USER_ROOT
      --env=BAZEL_REPO_CONTENTS_CACHE
      --env=CI_PROJECT_DIR
      --env=RUNNER_TEMP_PROJECT_DIR
      --rm
      --volume="${CI_PROJECT_DIR}:$CI_PROJECT_DIR"
      --volume="${RUNNER_TEMP_PROJECT_DIR}:$RUNNER_TEMP_PROJECT_DIR"
      --workdir="$CI_PROJECT_DIR"
      "$WINBUILDIMAGE"
      powershell -NonInteractive -NoLogo -NoProfile -InputFormat Text -OutputFormat Text -EncodedCommand $EncodedCommand
