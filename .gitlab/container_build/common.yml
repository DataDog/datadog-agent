---
.static_quality_gate_docker: |
  # Measure Docker image size and generate in-place report
  # This runs after the main script and won't fail the job if there are issues.
  # This is common for all Docker image builds

  if [[ -n "$STATIC_QUALITY_GATE_NAME" ]]; then
    echo "üìä Starting Docker image measurement..."

    # Construct the built image reference from build variables
    # This follows the same pattern used in docker build jobs
    ECR_RELEASE_SUFFIX=${ECR_RELEASE_SUFFIX:-}
    TAG_SUFFIX=${TAG_SUFFIX:-}
    IMAGE_REF="${IMAGE}${ECR_RELEASE_SUFFIX}:v${CI_PIPELINE_ID}-${CI_COMMIT_SHORT_SHA}${TAG_SUFFIX}-$ARCH"
    
    echo "üîç Measuring Docker image: $IMAGE_REF"

    # Extract report prefix from gate name (e.g. static_quality_gate_docker_agent_amd64 -> docker_agent_amd64)
    REPORT_PREFIX="${STATIC_QUALITY_GATE_NAME#static_quality_gate_}"

    # Generate measurement report using STATIC_QUALITY_GATE_NAME variable
    dda inv quality-gates.measure-image-local \
      --image-ref "$IMAGE_REF" \
      --gate-name "$STATIC_QUALITY_GATE_NAME" \
      --build-job-name "$CI_JOB_NAME" \
      --output-path "${REPORT_PREFIX}_size_report_${CI_PIPELINE_ID}_${CI_COMMIT_SHA:0:8}.yml" \
      --debug || { echo "‚ö†Ô∏è  Docker image measurement failed for $IMAGE_REF"; exit 0; }

    echo "‚úÖ Docker image measurement completed"

    # Upload the report to S3 (same bucket structure as packages)
    BUCKET_BASE_PATH="s3://dd-ci-artefacts-build-stable/datadog-agent/static_quality_gates/GATE_REPORTS/${CI_COMMIT_SHA}"
    echo "Uploading report to ${BUCKET_BASE_PATH}"
    aws s3 cp --only-show-errors --region us-east-1 --sse AES256 \
      "${REPORT_PREFIX}_size_report_${CI_PIPELINE_ID}_${CI_COMMIT_SHA:0:8}.yml" \
      "${BUCKET_BASE_PATH}/${REPORT_PREFIX}_size_report_${CI_PIPELINE_ID}_${CI_COMMIT_SHA:0:8}.yml"
  else
    echo "‚ÑπÔ∏è  Skipping Docker image measurement (no STATIC_QUALITY_GATE_NAME defined)"
  fi

.static_quality_gate_report_path: "**/*_size_report_*.yml"
