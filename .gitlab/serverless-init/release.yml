# Serverless-init release pipeline
# Builds and publishes serverless-init images to registry.ddbuild.io
# Then triggers downstream pipeline to replicate to registry.datadoghq.com
#
# Usage:
#   For RC: Set tag with -rc suffix (e.g., "1.7.8-rc1"), latestTag: "no"
#   For Prod: Set tag without -rc (e.g., "1.7.8"), latestTag: "yes"
#
# This pipeline runs from the root of the datadog-agent repository

workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - when: never

variables:
  # User-configurable variables
  TAG:
    description: 'Docker image tag (e.g., 1.7.8-rc1 for RC, 1.7.8 for prod)'
    value: ''
  LATEST_TAG:
    description: 'Tag as latest? (yes for prod releases, no for RCs)'
    value: 'no'
    options:
      - 'yes'
      - 'no'
  BUILD_TAGS:
    description: 'Go build tags'
    value: 'serverless otlp zlib zstd'
  AGENT_VERSION:
    description: 'Datadog agent version (optional - defaults to version in code)'
    value: ''

  # Internal variables
  DOCKER_BUILDKIT: "1"
  DOCKER_TLS_CERTDIR: ''

stages:
  - build-and-publish
  - trigger-registry

# ==================== BUILD AND PUBLISH IMAGES ====================
# Build multi-arch images and push to registry.ddbuild.io

.build-and-publish-template:
  stage: build-and-publish
  image: registry.ddbuild.io/images/docker:27.3.1
  tags: ['arch:amd64']
  rules:
    - if: '$TAG == ""'
      when: never
    - when: always
  before_script:
    - |
      if [ "$TAG" = "" ]; then
        echo "ERROR: TAG variable is required"
        exit 1
      fi
    - docker buildx create --use --name multiarch-builder || docker buildx use multiarch-builder
    # Login to registry.ddbuild.io
    - !reference [.login_to_docker_readonly]
  script:
    - |
      echo "Building and publishing serverless-init image (${VARIANT_NAME})"

      # Determine image names and tags based on release type
      if [ "$LATEST_TAG" = "yes" ]; then
        # Production release - push with version and latest tags
        DDBUILD_IMAGE="registry.ddbuild.io/ci/datadog-agent/serverless-init"

        TAG_ARGS="-t ${DDBUILD_IMAGE}:${TAG}${IMAGE_SUFFIX}"
        TAG_ARGS="${TAG_ARGS} -t ${DDBUILD_IMAGE}:latest${IMAGE_SUFFIX}"
        TAG_ARGS="${TAG_ARGS} -t ${DDBUILD_IMAGE}:v${CI_PIPELINE_ID}${IMAGE_SUFFIX}"

        echo "ðŸ“¦ Publishing PRODUCTION release:"
        echo "  - registry.ddbuild.io/ci/datadog-agent/serverless-init:${TAG}${IMAGE_SUFFIX}"
        echo "  - registry.ddbuild.io/ci/datadog-agent/serverless-init:latest${IMAGE_SUFFIX}"
        echo "  - registry.ddbuild.io/ci/datadog-agent/serverless-init:v${CI_PIPELINE_ID}${IMAGE_SUFFIX}"
      else
        # Release candidate - push to -dev with version tag
        DDBUILD_IMAGE="registry.ddbuild.io/ci/datadog-agent/serverless-init-dev"

        TAG_ARGS="-t ${DDBUILD_IMAGE}:${TAG}${IMAGE_SUFFIX}"
        TAG_ARGS="${TAG_ARGS} -t ${DDBUILD_IMAGE}:v${CI_PIPELINE_ID}${IMAGE_SUFFIX}"

        echo "ðŸ§ª Publishing RELEASE CANDIDATE:"
        echo "  - registry.ddbuild.io/ci/datadog-agent/serverless-init-dev:${TAG}${IMAGE_SUFFIX}"
        echo "  - registry.ddbuild.io/ci/datadog-agent/serverless-init-dev:v${CI_PIPELINE_ID}${IMAGE_SUFFIX}"
      fi

      # Build and push multi-architecture image to registry
      # Add labels for registry replication
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --build-arg EXTENSION_VERSION="${TAG}" \
        --build-arg AGENT_VERSION="${AGENT_VERSION}" \
        --build-arg CMD_PATH="cmd/serverless-init" \
        --build-arg BUILD_TAGS="${BUILD_TAGS}" \
        -f .gitlab/serverless-init/Dockerfile${ALPINE_SUFFIX} \
        ${TAG_ARGS} \
        --label "org.opencontainers.image.created=$(date --rfc-3339=seconds)" \
        --label "org.opencontainers.image.authors=Datadog <package@datadoghq.com>" \
        --label "org.opencontainers.image.source=https://github.com/DataDog/datadog-agent" \
        --label "org.opencontainers.image.version=${TAG}" \
        --label "org.opencontainers.image.revision=${CI_COMMIT_SHA}" \
        --label "com.datadoghq.tags.pipeline.id=${CI_PIPELINE_ID}" \
        --label "com.datadoghq.tags.pipeline.url=${CI_PIPELINE_URL}" \
        --push \
        .

      echo "âœ… Successfully published ${VARIANT_NAME} image to registry.ddbuild.io!"

      # Save image information for downstream pipeline trigger
      mkdir -p image-info
      echo "${DDBUILD_IMAGE}:${TAG}${IMAGE_SUFFIX}" > image-info/${VARIANT_NAME}-image.txt
  artifacts:
    reports:
      dotenv: image-info/${VARIANT_NAME}-image.txt
    paths:
      - image-info/${VARIANT_NAME}-image.txt
    expire_in: 1 day

build-and-publish-standard:
  extends: .build-and-publish-template
  variables:
    ALPINE_SUFFIX: ""
    IMAGE_SUFFIX: ""
    VARIANT_NAME: "standard"

build-and-publish-alpine:
  extends: .build-and-publish-template
  variables:
    ALPINE_SUFFIX: ".alpine"
    IMAGE_SUFFIX: "-alpine"
    VARIANT_NAME: "alpine"

# ==================== TRIGGER REGISTRY REPLICATION ====================
# Trigger downstream pipeline to replicate images to public registries
# Separate jobs for standard and alpine variants

trigger-registry-replication-prod-standard:
  stage: trigger-registry
  trigger:
    project: DataDog/public-images
    strategy: depend
  rules:
    - if: '$LATEST_TAG == "yes"'
      when: on_success
  dependencies:
    - build-and-publish-standard
  variables:
    IMG_SOURCES: "registry.ddbuild.io/ci/datadog-agent/serverless-init:${TAG}"
    IMG_DESTINATIONS: "serverless-init:${TAG},serverless-init:latest,serverless-init:1"
    IMG_SIGNING: "false"
    IMG_REGISTRIES: "public"

trigger-registry-replication-prod-alpine:
  stage: trigger-registry
  trigger:
    project: DataDog/public-images
    strategy: depend
  rules:
    - if: '$LATEST_TAG == "yes"'
      when: on_success
  dependencies:
    - build-and-publish-alpine
  variables:
    IMG_SOURCES: "registry.ddbuild.io/ci/datadog-agent/serverless-init:${TAG}-alpine"
    IMG_DESTINATIONS: "serverless-init:${TAG}-alpine,serverless-init:latest-alpine,serverless-init:1-alpine"
    IMG_SIGNING: "false"
    IMG_REGISTRIES: "public"

trigger-registry-replication-rc-standard:
  stage: trigger-registry
  trigger:
    project: DataDog/public-images
    strategy: depend
  rules:
    - if: '$LATEST_TAG != "yes"'
      when: on_success
  dependencies:
    - build-and-publish-standard
  variables:
    IMG_SOURCES: "registry.ddbuild.io/ci/datadog-agent/serverless-init-dev:${TAG}"
    IMG_DESTINATIONS: "serverless-init-dev:${TAG},serverless-init-dev:latest,serverless-init-dev:1"
    IMG_SIGNING: "false"
    IMG_REGISTRIES: "prod"

trigger-registry-replication-rc-alpine:
  stage: trigger-registry
  trigger:
    project: DataDog/public-images
    strategy: depend
  rules:
    - if: '$LATEST_TAG != "yes"'
      when: on_success
  dependencies:
    - build-and-publish-alpine
  variables:
    IMG_SOURCES: "registry.ddbuild.io/ci/datadog-agent/serverless-init-dev:${TAG}-alpine"
    IMG_DESTINATIONS: "serverless-init-dev:${TAG}-alpine,serverless-init-dev:latest-alpine,serverless-init-dev:1-alpine"
    IMG_SIGNING: "false"
    IMG_REGISTRIES: "prod"
