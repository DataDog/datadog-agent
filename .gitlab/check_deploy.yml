---
# check_deploy stage
# Contains jobs which which check if the version of the Agent built in the pipeline
# alteady exists (in the apt staging repo), or if the release branch is "none".
# In both cases, these jobs fail in order to prevent the pipeline from deploying artifacts.

.if_not_version_6: &if_not_version_6
  if: $RELEASE_VERSION_6 == ""

.if_not_version_7: &if_not_version_7
  if: $RELEASE_VERSION_7 == ""

.if_deploy: &if_deploy
  if: $DEPLOY_AGENT == "true"

# Check that the current version hasn't already been deployed (we don't want to
# overwrite a public package). To update an erroneous package, first remove it
# from our S3 bucket.
check_already_deployed_version_6:
  rules:
    - <<: *if_not_version_6
      when: never
    - <<: *if_deploy
  stage: check_deploy
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/gitlab_agent_deploy:$DATADOG_AGENT_BUILDERS
  tags: ["runner:main", "size:large"]
  dependencies: ["agent_deb-x64-a6", "agent_deb-arm64-a6"]
  before_script:
    - ls $OMNIBUS_PACKAGE_DIR
  script:
    - cd $OMNIBUS_PACKAGE_DIR && ~/deploy_scripts/fail_deb_is_pkg_already_exists.sh datadog-agent_6*_amd64.deb
    - cd $OMNIBUS_PACKAGE_DIR && ~/deploy_scripts/fail_deb_is_pkg_already_exists.sh datadog-agent_6*_arm64.deb

check_already_deployed_version_7:
  rules:
    - <<: *if_not_version_7
      when: never
    - <<: *if_deploy
  stage: check_deploy
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/gitlab_agent_deploy:$DATADOG_AGENT_BUILDERS
  tags: ["runner:main", "size:large"]
  dependencies: ["agent_deb-x64-a7", "agent_deb-arm64-a7"]
  before_script:
    - ls $OMNIBUS_PACKAGE_DIR
  script:
    - cd $OMNIBUS_PACKAGE_DIR && ~/deploy_scripts/fail_deb_is_pkg_already_exists.sh datadog-agent_7*_amd64.deb
    - cd $OMNIBUS_PACKAGE_DIR && ~/deploy_scripts/fail_deb_is_pkg_already_exists.sh datadog-agent_7*_arm64.deb

# If we trigger a build only pipeline we stop here.
check_if_build_only:
  rules:
    - <<: *if_deploy
  stage: check_deploy
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-builders/gitlab_agent_deploy:$DATADOG_AGENT_BUILDERS
  tags: ["runner:main", "size:large"]
  dependencies: []
  script:
    - if [ "$DEB_RPM_BUCKET_BRANCH" == "none" ]; then echo "Stopping pipeline"; exit 1; fi
