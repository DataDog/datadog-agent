---
# e2e stage
# Contains test jobs based on the new-e2e tests framework
.new_e2e_template:
  stage: e2e
  image: registry.ddbuild.io/ci/datadog-agent-buildimages/linux$CI_IMAGE_LINUX_SUFFIX:$CI_IMAGE_LINUX
  tags: ["arch:amd64-cidc"]
  needs:
    - !reference [.needs_new_e2e_template]
  before_script:
    - !reference [.retrieve_linux_go_e2e_deps]
    - !reference [.retrieve_linux_pulumi_plugins]
    - !reference [.retrieve_linux_go_tools_deps]
    # Setup AWS Credentials
    - mkdir -p ~/.aws
    - |
      if [ -n "$E2E_USE_AWS_PROFILE" ]; then
        echo Using agent-qa-ci aws profile
        $CI_PROJECT_DIR/tools/ci/fetch_secret.sh $AGENT_QA_E2E profile >> ~/.aws/config || exit $?
        # Now all `aws` commands target the agent-qa profile
        export AWS_PROFILE=agent-qa-ci
      else
        # Assume role to fetch only once credentials and avoid rate limits
        echo Assuming ddbuild-agent-ci role
        roleoutput="$(aws sts assume-role --role-arn arn:aws:iam::669783387624:role/ddbuild-agent-ci --external-id ddbuild-agent-ci --role-session-name RoleSession)"
        export AWS_ACCESS_KEY_ID="$(echo "$roleoutput" | jq -r '.Credentials.AccessKeyId')"
        export AWS_SECRET_ACCESS_KEY="$(echo "$roleoutput" | jq -r '.Credentials.SecretAccessKey')"
        export AWS_SESSION_TOKEN="$(echo "$roleoutput" | jq -r '.Credentials.SessionToken')"
      fi
    # TODO: ADXT-768: Create new secret with different ssh key for the different cloud providers
    # SSH Key retrieval for AWS
    - $CI_PROJECT_DIR/tools/ci/fetch_secret.sh $AGENT_QA_E2E ssh_public_key_rsa > $E2E_AWS_PUBLIC_KEY_PATH || exit $?
    - touch $E2E_AWS_PRIVATE_KEY_PATH && chmod 600 $E2E_AWS_PRIVATE_KEY_PATH && $CI_PROJECT_DIR/tools/ci/fetch_secret.sh $AGENT_QA_E2E ssh_key_rsa > $E2E_AWS_PRIVATE_KEY_PATH || exit $?
    # SSH Key retrieval for Azure
    - $CI_PROJECT_DIR/tools/ci/fetch_secret.sh $AGENT_QA_E2E ssh_public_key_rsa > $E2E_AZURE_PUBLIC_KEY_PATH || exit $?
    - touch $E2E_AZURE_PRIVATE_KEY_PATH && chmod 600 $E2E_AZURE_PRIVATE_KEY_PATH && $CI_PROJECT_DIR/tools/ci/fetch_secret.sh $AGENT_QA_E2E ssh_key_rsa > $E2E_AZURE_PRIVATE_KEY_PATH || exit $?
    # SSH Key retrieval for GCP
    - $CI_PROJECT_DIR/tools/ci/fetch_secret.sh $AGENT_QA_E2E ssh_public_key_rsa > $E2E_GCP_PUBLIC_KEY_PATH || exit $?
    - touch $E2E_GCP_PRIVATE_KEY_PATH && chmod 600 $E2E_GCP_PRIVATE_KEY_PATH && $CI_PROJECT_DIR/tools/ci/fetch_secret.sh $AGENT_QA_E2E ssh_key_rsa > $E2E_GCP_PRIVATE_KEY_PATH || exit $?
    # Use S3 backend
    - pulumi login "s3://dd-pulumi-state?region=us-east-1&awssdk=v2&profile=$AWS_PROFILE"
    # Setup Azure credentials. https://www.pulumi.com/registry/packages/azure-native/installation-configuration/#set-configuration-using-pulumi-config
    # The app is called `agent-e2e-tests`
    - ARM_CLIENT_ID=$($CI_PROJECT_DIR/tools/ci/fetch_secret.sh $E2E_AZURE client_id) || exit $?; export ARM_CLIENT_ID
    - ARM_CLIENT_SECRET=$($CI_PROJECT_DIR/tools/ci/fetch_secret.sh $E2E_AZURE token) || exit $?; export ARM_CLIENT_SECRET
    - ARM_TENANT_ID=$($CI_PROJECT_DIR/tools/ci/fetch_secret.sh $E2E_AZURE tenant_id) || exit $?; export ARM_TENANT_ID
    - ARM_SUBSCRIPTION_ID=$($CI_PROJECT_DIR/tools/ci/fetch_secret.sh $E2E_AZURE subscription_id) || exit $?; export ARM_SUBSCRIPTION_ID
    # Setup GCP credentials. https://www.pulumi.com/registry/packages/gcp/installation-configuration/
    # The service account is called `agent-e2e-tests`
    - $CI_PROJECT_DIR/tools/ci/fetch_secret.sh $E2E_GCP credentials_json > ~/gcp-credentials.json || exit $?
    - export GOOGLE_APPLICATION_CREDENTIALS=~/gcp-credentials.json
    # Generate external links to CI VISIBILITY, used by artifacts:reports:annotations
    - dda inv -- -e gitlab.generate-ci-visibility-links --output=$EXTERNAL_LINKS_PATH
    - export DD_ENV=nativetest # TODO: Remove after testing native instrumentation
    - export DD_CIVISIBILITY_ENABLED=true
    - export DD_CIVISIBILITY_AGENTLESS_ENABLED=true
    - DD_API_KEY=$($CI_PROJECT_DIR/tools/ci/fetch_secret.sh $AGENT_API_KEY_ORG2 token) || exit $?; export DD_API_KEY
    # set the environment variables for the windows test signing
    - export WINDOWS_DDNPM_DRIVER=${WINDOWS_DDNPM_DRIVER:-$(dda inv release.get-release-json-value "dependencies::WINDOWS_DDNPM_DRIVER" --no-worktree)}
    - export WINDOWS_DDPROCMON_DRIVER=${WINDOWS_DDPROCMON_DRIVER:-$(dda inv release.get-release-json-value "dependencies::WINDOWS_DDPROCMON_DRIVER" --no-worktree)}
  variables:
    GIT_STRATEGY: "clone" # Needed because we use git merge-base
    DYNAMIC_TESTS_FLAG: "--impacted"
    SHOULD_RUN_IN_FLAKES_FINDER: "true"
    KUBERNETES_MEMORY_REQUEST: 12Gi
    KUBERNETES_MEMORY_LIMIT: 16Gi
    KUBERNETES_CPU_REQUEST: 6
    # AWS SSH Key configuration
    E2E_AWS_PUBLIC_KEY_PATH: /tmp/agent-qa-aws-ssh-key.pub
    E2E_AWS_PRIVATE_KEY_PATH: /tmp/agent-qa-aws-ssh-key
    E2E_KEY_PAIR_NAME: datadog-agent-ci-rsa
    # Azure SSH Key configuration
    E2E_AZURE_PUBLIC_KEY_PATH: /tmp/agent-qa-azure-ssh-key.pub
    E2E_AZURE_PRIVATE_KEY_PATH: /tmp/agent-qa-azure-ssh-key
    # GCP SSH Key configuration
    E2E_GCP_PUBLIC_KEY_PATH: /tmp/agent-qa-gcp-ssh-key.pub
    E2E_GCP_PRIVATE_KEY_PATH: /tmp/agent-qa-gcp-ssh-key
    E2E_PIPELINE_ID: $CI_PIPELINE_ID
    E2E_COMMIT_SHA: $CI_COMMIT_SHORT_SHA
    E2E_OUTPUT_DIR: $CI_PROJECT_DIR/e2e-output
    EXTERNAL_LINKS_PATH: external_links_$CI_JOB_ID.json
    E2E_LOGS_PROCESSING_TEST_DEPTH: 1
    FLAKY_PATTERNS_CONFIG: $CI_PROJECT_DIR/flaky-patterns-runtime.yaml
    E2E_RESULT_JSON: $CI_PROJECT_DIR/e2e_test_output.json
    E2E_USE_AWS_PROFILE: "true"
    E2E_COVERAGE_OUT_DIR: $CI_PROJECT_DIR/coverage
    PRE_BUILT_BINARIES_FLAG: "--use-prebuilt-binaries"
    MAX_RETRIES_FLAG: "" # Empty by default, can be set to `--max-retries=3` for example to retry failed tests
    REMOTE_STACK_CLEANING: "true"
  script:
    - export IS_DEV_BRANCH="$(dda inv -- -e pipeline.is-dev-branch)"
    - DYNAMIC_TESTS_BREAKGLASS=$($CI_PROJECT_DIR/tools/ci/fetch_secret.sh $DYNAMIC_TESTS_BREAKGLASS value) || exit $?; export DYNAMIC_TESTS_BREAKGLASS
    - |
      if [ "$DYNAMIC_TESTS_BREAKGLASS" == "true" ] || [ "$IS_DEV_BRANCH" == "false" ] || [ "$RUN_E2E_TESTS" == "on" ]; then
        export DYNAMIC_TESTS_FLAG=""
      fi
    - dda inv -- -e new-e2e-tests.run $DYNAMIC_TESTS_FLAG $PRE_BUILT_BINARIES_FLAG $MAX_RETRIES_FLAG --local-package $CI_PROJECT_DIR/$OMNIBUS_BASE_DIR --result-json $E2E_RESULT_JSON --targets $TARGETS -c ddagent:imagePullRegistry=669783387624.dkr.ecr.us-east-1.amazonaws.com -c ddagent:imagePullUsername=AWS -c ddagent:imagePullPassword=$(aws ecr get-login-password) --junit-tar junit-${CI_JOB_ID}.tgz ${EXTRA_PARAMS} --test-washer --logs-folder=$E2E_OUTPUT_DIR/logs --logs-post-processing --logs-post-processing-test-depth=$E2E_LOGS_PROCESSING_TEST_DEPTH
  after_script:
    - CODECOV_TOKEN=$($CI_PROJECT_DIR/tools/ci/fetch_secret.sh $CODECOV token) || exit $?; export CODECOV_TOKEN
    - $CI_PROJECT_DIR/tools/ci/junit_upload.sh "junit-${CI_JOB_ID}.tgz" "$E2E_RESULT_JSON"
    - |
      if [ -d "$E2E_COVERAGE_OUT_DIR" ]; then
        dda inv -- -e coverage.process-e2e-coverage-folders $E2E_COVERAGE_OUT_DIR
        dda inv -- -e dyntest.compute-and-upload-job-index --bucket-uri $S3_PERMANENT_ARTIFACTS_URI --coverage-folder $E2E_COVERAGE_OUT_DIR --commit-sha $CI_COMMIT_SHA --job-id $CI_JOB_ID
      fi
  artifacts:
    expire_in: 2 weeks
    when: always
    paths:
      # Root directory of the e2e tests output, if used by the test
      - $E2E_OUTPUT_DIR
      # Go test output, kept for investigations
      - $E2E_RESULT_JSON
      # junit tarball, kept for investigations
      - junit-*.tgz
      - $E2E_COVERAGE_OUT_DIR
    reports:
      annotations:
        - $EXTERNAL_LINKS_PATH

.needs_new_e2e_template:
  - go_e2e_deps
  - go_e2e_test_binaries
  - go_tools_deps
  - job: new-e2e-base-coverage
    optional: true

new-e2e-base-coverage:
  extends: .new_e2e_template
  needs:
    - go_e2e_deps
    - go_e2e_test_binaries
    - go_tools_deps
    - agent_deb-x64-a7
  rules:
    - !reference [.except_mergequeue]
    - !reference [.on_coverage_pipeline]
  variables:
    TARGETS: ./tests/agent-devx
    TEAM: agent-devx
    EXTRA_PARAMS: --run TestAgentBaselineSuite

new-e2e-base:
  extends: .new_e2e_template
  needs:
    - go_e2e_deps
    - go_tools_deps
    - go_e2e_test_binaries
    - agent_deb-x64-a7
  rules:
    - !reference [.except_mergequeue]
    - !reference [.except_coverage_pipeline]
    - when: on_success
  variables:
    TARGETS: ./tests/agent-devx
    TEAM: agent-devx
    EXTRA_PARAMS: --run TestAgentBaselineSuite

# Build test binaries job that creates pre-compiled test binaries
# This job runs early in the pipeline and creates artifacts that can be reused by test jobs
go_e2e_test_binaries:
  stage: binary_build
  image: registry.ddbuild.io/ci/datadog-agent-buildimages/linux$CI_IMAGE_LINUX_SUFFIX:$CI_IMAGE_LINUX
  tags: ["arch:amd64-cidc"]
  needs:
    - go_e2e_deps
  variables:
    KUBERNETES_CPU_REQUEST: 4
    KUBERNETES_MEMORY_REQUEST: 64Gi
    KUBERNETES_MEMORY_LIMIT: 64Gi
  before_script:
    - !reference [.retrieve_linux_go_e2e_deps]
  script:
    - pushd test/new-e2e
    - go install github.com/DataDog/orchestrion
    - popd
    - dda inv -- -e new-e2e-tests.build-binaries --output-dir test-binaries -p $KUBERNETES_CPU_REQUEST --manifest-file-path manifest.json
    - tar czf test-binaries.tar.gz test-binaries
  artifacts:
    expire_in: 1 week
    paths:
      - test-binaries.tar.gz
      - manifest.json
  rules:
    - !reference [.except_mergequeue]
    - when: on_success

.new_e2e_template_needs_windows_x64:
  extends: .new_e2e_template
  needs:
    - !reference [.needs_new_e2e_template]
    - windows_msi_and_bosh_zip_x64-a7
    - windows_msi_and_bosh_zip_x64-a7-fips

.new_e2e_template_needs_deb_x64:
  extends: .new_e2e_template
  needs:
    - !reference [.needs_new_e2e_template]
    - agent_deb-x64-a7
    - agent_deb-x64-a7-fips

.new_e2e_template_needs_container_deploy_linux:
  extends: .new_e2e_template
  needs:
    - !reference [.needs_new_e2e_template]
    - qa_agent_linux
    - qa_agent_linux_jmx
    - qa_dca
    - qa_dogstatsd

.new_e2e_template_needs_container_deploy:
  extends: .new_e2e_template
  needs:
    - !reference [.needs_new_e2e_template]
    - qa_agent
    - qa_agent_jmx
    - qa_dca
    - qa_dogstatsd

new-e2e-containers-ecs:
  extends: .new_e2e_template_needs_container_deploy
  rules:
    - !reference [.on_container_or_e2e_changes]
    - !reference [.manual]
  variables:
    TARGETS: ./tests/containers
    TEAM: container-integrations
    ON_NIGHTLY_FIPS: "true"
    EXTRA_PARAMS: --run TestECSSuite

new-e2e-containers:
  extends:
    - .new_e2e_template_needs_container_deploy_linux
  # TODO once images are deployed to ECR for dev branches, update
  #.on_main_or_rc_and_no_skip_e2e adding on_dev_branch_manual rules
  # and move rules to template
  rules:
    - !reference [.on_container_or_e2e_changes]
    - !reference [.dynamic_tests] # The job will always be created on any Go code modification, tests are skipped dynamically in the job
    - !reference [.manual]
  variables:
    TARGETS: ./tests/containers
    TEAM: container-integrations
    ON_NIGHTLY_FIPS: "true"
  parallel:
    matrix:
      # Temporarily disable old version of Kubernetes
      # On this version, the reported kubernetes CPU usage appears to be significantly off
      - EXTRA_PARAMS: "--run TestKindSuite -c ddinfra:kubernetesVersion=1.19"
      - EXTRA_PARAMS: "--run TestKindSuite -c ddinfra:kubernetesVersion=1.22"
      - EXTRA_PARAMS: "--run TestKindSuite -c ddinfra:kubernetesVersion=1.27"
      - EXTRA_PARAMS: "--run TestKindSuite -c ddinfra:kubernetesVersion=1.29"
      - EXTRA_PARAMS: "--run TestKindSuite -c ddinfra:osDescriptor=ubuntu:20-04"
      - EXTRA_PARAMS: "--run TestKindSuite -c ddinfra:osDescriptor=ubuntu:22-04"
      - EXTRA_PARAMS: --run TestDockerSuite
      - EXTRA_PARAMS: --run "TestK8S(CEL|Legacy)FilteringSuite"
      - EXTRA_PARAMS: --skip "Test(Kind|EKS|OpenShiftVM|ECS|Docker|K8SCELFiltering|K8SLegacyFiltering)Suite"

new-e2e-containers-k8s-latest:
  extends:
    - .new_e2e_template_needs_container_deploy_linux
  rules:
    - !reference [.on_container_or_e2e_changes]
    - !reference [.dynamic_tests] # The job will always be created on any Go code modification, tests are skipped dynamically in the job
    - !reference [.manual]
  variables:
    TARGETS: ./tests/containers
    TEAM: container-integrations
    ON_NIGHTLY_FIPS: "true"
    EXTRA_PARAMS: "--run TestKindSuite -c ddinfra:kubernetesVersion=v1.34.0@sha256:7416a61b42b1662ca6ca89f02028ac133a309a2a30ba309614e8ec94d976dc5a"

new-e2e-containers-eks-init:
  stage: e2e_init
  extends: .new_e2e_template
  needs:
    - go_e2e_deps
    - go_tools_deps
  rules:
    - !reference [.on_container_or_e2e_changes]
    - !reference [.dynamic_tests] # The job will always be created on any Go code modification, tests are skipped dynamically in the job
    - !reference [.manual]
  variables:
    TARGETS: ./tests/containers
    TEAM: container-integrations
    EXTRA_PARAMS: --run TestEKSSuite
    E2E_INIT_ONLY: "true"
    SHOULD_RUN_IN_FLAKES_FINDER: "false"
    PRE_BUILT_BINARIES_FLAG: ""
    KUBERNETES_MEMORY_REQUEST: 12Gi
    KUBERNETES_MEMORY_LIMIT: 16Gi
  allow_failure: true
  retry: !reference [.retry_only_infra_failure, retry]

new-e2e-containers-eks:
  extends: .new_e2e_template_needs_container_deploy
  rules:
    - !reference [.on_container_or_e2e_changes]
    - !reference [.dynamic_tests] # The job will always be created on any Go code modification, tests are skipped dynamically in the job
    - !reference [.manual]
  needs:
    - !reference [.new_e2e_template_needs_container_deploy, needs]
    - new-e2e-containers-eks-init
  variables:
    TARGETS: ./tests/containers
    TEAM: container-integrations
    EXTRA_PARAMS: --run TestEKSSuite
    E2E_PRE_INITIALIZED: "true"
    ON_NIGHTLY_FIPS: "true"
  retry: !reference [.retry_only_infra_failure, retry]

new-e2e-containers-openshift-init:
  stage: e2e_init
  extends: .new_e2e_template
  needs:
    - go_e2e_deps
    - go_tools_deps
  rules:
    - !reference [.on_e2e_main_release_or_rc]
    - changes:
        paths:
          - test/new-e2e/tests/containers/**/*
        compare_to: $COMPARE_TO_BRANCH
    - !reference [.manual]
  before_script:
    # We need to also fetch the OpenShift CRC pull secret and write it to a temp file, so we reference the new_e2e_template before_script first
    - !reference [.new_e2e_template, before_script]
    - $CI_PROJECT_DIR/tools/ci/fetch_secret.sh $CRC_PULL_SECRET > /tmp/crc-pull-secret.json || exit $?
  variables:
    TARGETS: ./tests/containers
    TEAM: container-integrations
    EXTRA_PARAMS: "--run TestOpenShiftVMSuite -c ddinfra:gcp/openshift/pullSecretPath=/tmp/crc-pull-secret.json"
    E2E_INIT_ONLY: "true"
    SHOULD_RUN_IN_FLAKES_FINDER: "false"
    PRE_BUILT_BINARIES_FLAG: ""
    KUBERNETES_MEMORY_REQUEST: 12Gi
    KUBERNETES_MEMORY_LIMIT: 16Gi
  allow_failure: true
  retry: !reference [.retry_only_infra_failure, retry]

new-e2e-containers-openshift:
  extends: .new_e2e_template_needs_container_deploy_linux
  rules:
    - !reference [.on_e2e_main_release_or_rc]
    - changes:
        paths:
          - test/new-e2e/tests/containers/**/*
        compare_to: $COMPARE_TO_BRANCH
    - !reference [.manual]
  needs:
    - !reference [.new_e2e_template_needs_container_deploy_linux, needs]
    - new-e2e-containers-openshift-init
  before_script:
    # We need to also fetch the OpenShift CRC pull secret and write it to a temp file, so we reference the new_e2e_template before_script first
    - !reference [.new_e2e_template, before_script]
    - $CI_PROJECT_DIR/tools/ci/fetch_secret.sh $CRC_PULL_SECRET > /tmp/crc-pull-secret.json || exit $?
  variables:
    TARGETS: ./tests/containers
    TEAM: container-integrations
    EXTRA_PARAMS: "--run TestOpenShiftVMSuite -c ddinfra:gcp/openshift/pullSecretPath=/tmp/crc-pull-secret.json"
    E2E_PRE_INITIALIZED: "true"
    ON_NIGHTLY_FIPS: "true"
  allow_failure: true
  retry: !reference [.retry_only_infra_failure, retry]

new-e2e-remote-config:
  extends: .new_e2e_template_needs_deb_x64
  rules:
    - !reference [.on_rc_or_e2e_changes]
    - !reference [.manual]
  variables:
    TARGETS: ./tests/remote-config
    TEAM: remote-config
    # TODO: Re-enable on fips pipeline when fips is available with remote config using: ON_NIGHTLY_FIPS: "true"

new-e2e-agent-configuration:
  extends: .new_e2e_template_needs_deb_x64
  rules:
    - !reference [.on_acfg_or_e2e_changes]
    - !reference [.dynamic_tests] # The job will always be created on any Go code modification, tests are skipped dynamically in the job
    - !reference [.manual]
  variables:
    TARGETS: ./tests/agent-configuration
    TEAM: agent-configuration
    EXTRA_PARAMS: --skip "Windows"

new-e2e-agent-configuration-windows:
  extends: .new_e2e_template_needs_windows_x64
  rules:
    - !reference [.on_acfg_or_e2e_changes]
    - !reference [.dynamic_tests] # The job will always be created on any Go code modification, tests are skipped dynamically in the job
    - !reference [.manual]
  variables:
    TARGETS: ./tests/agent-configuration
    TEAM: agent-configuration
    EXTRA_PARAMS: --run "Windows"

new-e2e-agent-runtimes:
  extends: .new_e2e_template_needs_deb_x64
  rules:
    - !reference [.on_arun_or_e2e_changes]
    - !reference [.manual]
  variables:
    TARGETS: ./tests/agent-runtimes
    TEAM: agent-runtimes
    EXTRA_PARAMS: --skip "Windows"
    ON_NIGHTLY_FIPS: "true"

new-e2e-agent-runtimes-windows:
  extends: .new_e2e_template_needs_windows_x64
  rules:
    - !reference [.on_e2e_main_release_or_rc]
    - changes:
        paths:
          - test/new-e2e/tests/agent-runtimes/**/*
        compare_to: $COMPARE_TO_BRANCH
    - !reference [.manual]
  variables:
    TARGETS: ./tests/agent-runtimes
    TEAM: agent-runtimes
    EXTRA_PARAMS: --run "Windows"
    ON_NIGHTLY_FIPS: "true"

new-e2e-agent-subcommands:
  extends: .new_e2e_template_needs_deb_x64
  rules:
    - !reference [.on_subcommands_or_e2e_changes]
    - !reference [.dynamic_tests] # The job will always be created on any Go code modification, tests are skipped dynamically in the job
    - !reference [.manual]
  variables:
    TARGETS: ./tests/agent-subcommands
    TEAM: agent-configuration
    ON_NIGHTLY_FIPS: "true"
    EXTRA_PARAMS: --skip "Windows"

new-e2e-agent-subcommands-windows:
  extends: .new_e2e_template_needs_windows_x64
  rules:
    - !reference [.on_e2e_main_release_or_rc]
    - changes:
        paths:
          - test/new-e2e/tests/agent-subcommands/**/*
        compare_to: $COMPARE_TO_BRANCH
    - !reference [.manual]
  variables:
    TARGETS: ./tests/agent-subcommands
    TEAM: agent-configuration
    ON_NIGHTLY_FIPS: "true"
    EXTRA_PARAMS: --run "Windows"

new-e2e-agent-health:
  extends: .new_e2e_template
  needs:
    - !reference [.needs_new_e2e_template]
    - agent_deb-x64-a7
  rules:
    - !reference [.on_healthplatform_or_e2e_changes]
    - !reference [.manual]
  variables:
    TARGETS: ./tests/agent-health
    TEAM: agent-health

new-e2e-fips-compliance-test:
  extends: .new_e2e_template
  needs:
    - !reference [.needs_new_e2e_template]
    - agent_deb-x64-a7-fips
    - qa_agent_fips_linux
    - qa_dca_fips
  rules:
    - !reference [.on_arun_or_e2e_changes]
    - !reference [.dynamic_tests] # The job will always be created on any Go code modification, tests are skipped dynamically in the job
    - !reference [.manual]
  variables:
    TARGETS: ./tests/fips-compliance
    TEAM: agent-runtimes
  parallel:
    matrix:
      - EXTRA_PARAMS: --run "TestFIPSCiphersLinuxSuite$"
      - EXTRA_PARAMS: --run "TestLinuxFIPSComplianceSuite$"
      - EXTRA_PARAMS: --run "TestFIPSCiphersClusterAgentSuite$"

new-e2e-windows-fips-compliance-test:
  extends: .new_e2e_template
  needs:
    - !reference [.needs_new_e2e_template]
    - qa_agent_fips
    - windows_msi_and_bosh_zip_x64-a7-fips
    - deploy_windows_testing-a7-fips
  rules:
    - !reference [.on_arun_or_e2e_changes]
    - !reference [.manual]
  variables:
    TARGETS: ./tests/fips-compliance
    TEAM: windows-products
  parallel:
    matrix:
      - EXTRA_PARAMS: --run "TestWindowsVM$"
      - EXTRA_PARAMS: --run "TestFIPSCiphersWindowsSuite$"

new-e2e-windows-service-test:
  extends: .new_e2e_template
  needs:
    - !reference [.needs_new_e2e_template]
    - windows_msi_and_bosh_zip_x64-a7
  rules:
    - !reference [.on_windows_service_or_e2e_changes]
    - !reference [.manual]
  variables:
    TARGETS: ./tests/windows/service-test
    TEAM: windows-products
    ON_NIGHTLY_FIPS: "true"
  parallel:
    matrix:
      - EXTRA_PARAMS: --run TestServiceBehaviorAgentCommand
      - EXTRA_PARAMS: --run TestServiceBehaviorPowerShell
      - EXTRA_PARAMS: --run TestServiceBehaviorWhenDisabledSystemProbe
      - EXTRA_PARAMS: --run TestServiceBehaviorWhenDisabledProcessAgent
      - EXTRA_PARAMS: --run TestServiceBehaviorWhenDisabledTraceAgent
      - EXTRA_PARAMS: --run TestServiceBehaviorWhenDisabledInstaller
      - EXTRA_PARAMS: --run TestDriverVerifierOnServiceBehaviorAgentCommand
      - EXTRA_PARAMS: --run TestDriverVerifierOnServiceBehaviorPowerShell
      - EXTRA_PARAMS: --run TestDriverVerifierOnServiceBehaviorWhenDisabledSystemProbe
      - EXTRA_PARAMS: --run TestDriverVerifierOnServiceBehaviorWhenDisabledProcessAgent
      - EXTRA_PARAMS: --run TestDriverVerifierOnServiceBehaviorWhenDisabledTraceAgent
      - EXTRA_PARAMS: --run TestDriverVerifierOnServiceBehaviorWhenDisabledInstaller

new-e2e-windows-certificate:
  extends: .new_e2e_template
  rules:
    - !reference [.on_windows_certificate_or_e2e_changes]
    - !reference [.manual]
  needs:
    - !reference [.needs_new_e2e_template]
    - deploy_windows_testing-a7
  variables:
    TARGETS: ./tests/windows/windows-certificate
    TEAM: windows-products
    EXTRA_PARAMS: --run "TestRemoteCertificates$"

new-e2e-language-detection:
  extends: .new_e2e_template_needs_deb_x64
  rules:
    - !reference [.on_language-detection_or_e2e_changes]
    - !reference [.manual]
  variables:
    TARGETS: ./tests/language-detection
    TEAM: container-experiences
    ON_NIGHTLY_FIPS: "true"

new-e2e-npm-packages:
  extends: .new_e2e_template
  rules:
    - !reference [.on_npm_or_e2e_changes]
    - !reference [.manual]
  needs:
    - !reference [.needs_new_e2e_template]
    - agent_deb-x64-a7
    - agent_rpm-x64-a7
  variables:
    TARGETS: ./tests/npm
    TEAM: cloud-network-monitoring
    EXTRA_PARAMS: --run "TestEC2(VM|VMSELinux|VMDirect)Suite"
    ON_NIGHTLY_FIPS: "true"

new-e2e-npm-packages-windows:
  extends: .new_e2e_template
  rules:
    - !reference [.on_npm_or_e2e_changes]
    - !reference [.manual]
  needs:
    - !reference [.needs_new_e2e_template]
    - windows_msi_and_bosh_zip_x64-a7
  variables:
    TARGETS: ./tests/npm
    TEAM: cloud-network-monitoring
    EXTRA_PARAMS: --run "TestEC2VMWKitSuite"
    ON_NIGHTLY_FIPS: "true"

new-e2e-npm-docker:
  extends: .new_e2e_template
  rules:
    - !reference [.on_npm_or_e2e_changes]
    - !reference [.manual]
  needs:
    - !reference [.needs_new_e2e_template]
    - qa_dca
    - qa_agent_linux
  variables:
    TARGETS: ./tests/npm
    TEAM: cloud-network-monitoring
    EXTRA_PARAMS: --run "Test(ECSVM|EC2VMContainerized)Suite"
    ON_NIGHTLY_FIPS: "true"

new-e2e-npm-eks-init:
  stage: e2e_init
  extends: .new_e2e_template
  needs:
    - go_e2e_deps
    - go_tools_deps
  rules:
    - !reference [.on_npm_or_e2e_changes]
    - !reference [.manual]
  variables:
    TARGETS: ./tests/npm
    TEAM: cloud-network-monitoring
    EXTRA_PARAMS: --run "TestEKSVMSuite"
    E2E_INIT_ONLY: "true"
    SHOULD_RUN_IN_FLAKES_FINDER: "false"
    PRE_BUILT_BINARIES_FLAG: ""
    KUBERNETES_MEMORY_REQUEST: 12Gi
    KUBERNETES_MEMORY_LIMIT: 16Gi
  allow_failure: true
  retry: !reference [.retry_only_infra_failure, retry]

new-e2e-npm-eks:
  extends: .new_e2e_template
  rules:
    - !reference [.on_npm_or_e2e_changes]
    - !reference [.manual]
  needs:
    - !reference [.needs_new_e2e_template]
    - new-e2e-npm-eks-init
    - qa_agent_linux
    - qa_dca
  variables:
    TARGETS: ./tests/npm
    TEAM: cloud-network-monitoring
    EXTRA_PARAMS: --run "TestEKSVMSuite"
    E2E_PRE_INITIALIZED: "true"
    ON_NIGHTLY_FIPS: "true"
  retry: !reference [.retry_only_infra_failure, retry]

new-e2e-npm:
  extends: .new_e2e_template
  rules:
    - !reference [.on_npm_or_e2e_changes]
    - !reference [.manual]
  needs:
    - !reference [.needs_new_e2e_template]
    - qa_agent_linux
    - qa_dca
  variables:
    TARGETS: ./tests/npm
    TEAM: cloud-network-monitoring
    EXTRA_PARAMS: --run TestCiliumLBConntracker

new-e2e-amp:
  extends: .new_e2e_template
  needs:
    - !reference [.needs_new_e2e_template]
    - agent_deb-x64-a7
    - qa_agent_linux
    - qa_agent_linux_jmx
    - qa_agent_fips_linux_jmx
    - qa_dca
  rules:
    - !reference [.on_amp_or_e2e_changes]
    - !reference [.dynamic_tests] # The job will always be created on any Go code modification, tests are skipped dynamically in the job
    - !reference [.manual]
  variables:
    TARGETS: ./tests/agent-metric-pipelines
    TEAM: agent-metric-pipelines
    ON_NIGHTLY_FIPS: "true"

new-e2e-alp:
  extends: .new_e2e_template
  needs:
    - !reference [.needs_new_e2e_template]
    - agent_deb-x64-a7
    - qa_agent_linux
    - qa_agent_linux_jmx
    - qa_agent_fips_linux_jmx
    - qa_dca
  rules:
    - !reference [.on_alp_or_e2e_changes]
    - !reference [.dynamic_tests] # The job will always be created on any Go code modification, tests are skipped dynamically in the job
    - !reference [.manual]
  variables:
    TARGETS: ./tests/agent-log-pipelines
    TEAM: agent-log-pipelines
    EXTRA_PARAMS: --skip "Windows"
  # Temporary for #incident-44744
  allow_failure: true
  retry: !reference [.retry_only_infra_failure, retry]

new-e2e-alp-windows:
  extends: .new_e2e_template
  needs:
    - !reference [.needs_new_e2e_template]
    - windows_msi_and_bosh_zip_x64-a7
  rules:
    - !reference [.on_alp_or_e2e_changes]
    - !reference [.dynamic_tests] # The job will always be created on any Go code modification, tests are skipped dynamically in the job
    - !reference [.manual]
  variables:
    TARGETS: ./tests/agent-log-pipelines
    TEAM: agent-log-pipelines
    EXTRA_PARAMS: --run "Windows"
  # Temporary for #incident-44744
  allow_failure: true
  retry: !reference [.retry_only_infra_failure, retry]

new-e2e-cws:
  extends: .new_e2e_template
  rules:
    - !reference [.on_cws_or_e2e_changes]
    - !reference [.manual]
  needs:
    - !reference [.needs_new_e2e_template]
    - agent_deb-x64-a7
    - qa_cws_instrumentation
    - qa_agent_linux
    - qa_dca
  variables:
    TARGETS: ./tests/cws
    TEAM: csm-threats-agent
    EXTRA_PARAMS: --skip "Windows"
    # Temporarily disable the test on FIPS pipeline, as remote-configuration is not available with FIPS Agent yet
    # ON_NIGHTLY_FIPS: "true"
  # Temporary, remove once we made sure the recent changes have no impact on the stability of these tests
  # NOTE: Do not remove this from e2e fips pipeline before remote config is available with fips, you can re-enable on fips pipeline when this test does not rely on remote-configuration
  allow_failure: true
  retry: !reference [.retry_only_infra_failure, retry]

new-e2e-cws-windows:
  extends: .new_e2e_template
  rules:
    - !reference [.on_cws_or_e2e_changes]
    - !reference [.manual]
  needs:
    - !reference [.needs_new_e2e_template]
    - windows_msi_and_bosh_zip_x64-a7
  variables:
    TARGETS: ./tests/cws
    TEAM: csm-threats-agent
    EXTRA_PARAMS: --run "Windows"
    # Temporarily disable the test on FIPS pipeline, as remote-configuration is not available with FIPS Agent yet
    # ON_NIGHTLY_FIPS: "true"
  # Temporary, remove once we made sure the recent changes have no impact on the stability of these tests
  # NOTE: Do not remove this from e2e fips pipeline before remote config is available with fips, you can re-enable on fips pipeline when this test does not rely on remote-configuration
  allow_failure: true
  retry: !reference [.retry_only_infra_failure, retry]

new-e2e-sbom:
  extends: .new_e2e_template_needs_container_deploy_linux
  rules:
    - !reference [.on_sbom_or_e2e_changes]
    - !reference [.manual]
  variables:
    TARGETS: ./tests/sbom
    TEAM: csm-threats-agent
    ON_NIGHTLY_FIPS: "true"
  parallel:
    matrix:
      - EXTRA_PARAMS: --run "TestSBOMKindSuite"

new-e2e-discovery:
  extends: .new_e2e_template
  needs:
    - !reference [.needs_new_e2e_template]
    - agent_deb-x64-a7
    - qa_agent_linux
  rules:
    - !reference [.on_discovery_or_e2e_changes]
    - !reference [.manual]
  variables:
    TARGETS: ./tests/discovery
    TEAM: agent-discovery
    ON_NIGHTLY_FIPS: "true"

new-e2e-process-ecs:
  extends: .new_e2e_template
  needs:
    - !reference [.needs_new_e2e_template]
    - qa_agent_linux
    - qa_dca
  rules:
    - !reference [.on_process_or_e2e_changes]
    - !reference [.manual]
  variables:
    EXTRA_PARAMS: --run TestECSFargateCoreAgentTestSuite|TestECSFargateTestSuite|TestECSEC2CoreAgentSuite|TestECSEC2TestSuite
    TARGETS: ./tests/process
    TEAM: container-experiences
    ON_NIGHTLY_FIPS: "true"

new-e2e-process:
  extends: .new_e2e_template
  needs:
    - !reference [.needs_new_e2e_template]
    - agent_deb-x64-a7
    - qa_agent_linux
    - qa_dca
  rules:
    - !reference [.on_process_or_e2e_changes]
    - !reference [.manual]
  variables:
    EXTRA_PARAMS: --skip "TestECSFargateCoreAgentTestSuite|TestECSFargateTestSuite|TestECSEC2CoreAgentSuite|TestECSEC2TestSuite|Windows"
    TARGETS: ./tests/process
    TEAM: container-experiences
    ON_NIGHTLY_FIPS: "true"

new-e2e-process-windows:
  extends: .new_e2e_template
  needs:
    - !reference [.needs_new_e2e_template]
    - windows_msi_and_bosh_zip_x64-a7
  rules:
    - !reference [.on_process_or_e2e_changes]
    - !reference [.dynamic_tests] # The job will always be created on any Go code modification, tests are skipped dynamically in the job
    - !reference [.manual]
  variables:
    EXTRA_PARAMS: --run "Windows"
    TARGETS: ./tests/process
    TEAM: container-experiences
    ON_NIGHTLY_FIPS: "true"

new-e2e-orchestrator-ecs:
  extends: .new_e2e_template_needs_container_deploy_linux
  rules:
    - !reference [.on_orchestrator_or_e2e_changes]
    - !reference [.manual]
  variables:
    EXTRA_PARAMS: --run TestECSSuite
    TARGETS: ./tests/orchestrator
    TEAM: kubernetes-experiences
    ON_NIGHTLY_FIPS: "true"
  timeout: 55m

new-e2e-orchestrator:
  extends: .new_e2e_template_needs_container_deploy_linux
  rules:
    - !reference [.on_orchestrator_or_e2e_changes]
    - !reference [.manual]
  variables:
    EXTRA_PARAMS: --skip TestECSSuite
    TARGETS: ./tests/orchestrator
    TEAM: kubernetes-experiences
    ON_NIGHTLY_FIPS: "true"

new-e2e-apm:
  extends: .new_e2e_template
  rules:
    - !reference [.on_apm_or_e2e_changes]
    - !reference [.dynamic_tests] # The job will always be created on any Go code modification, tests are skipped dynamically in the job
    - !reference [.manual]
  needs:
    - !reference [.needs_new_e2e_template]
    - qa_agent_linux
    - agent_deb-x64-a7
  variables:
    TARGETS: ./tests/apm
    TEAM: apm-agent
    # Temporarily disable the test on FIPS pipeline, as remote-configuration is not available with FIPS Agent yet
    # ON_NIGHTLY_FIPS: "true"
  parallel:
    matrix:
      - EXTRA_PARAMS: --run TestDockerFakeintakeSuiteUDS
      - EXTRA_PARAMS: --run TestDockerFakeintakeSuiteTCP
      - EXTRA_PARAMS: --run TestVMFakeintakeSuiteUDS
      - EXTRA_PARAMS: --run TestVMFakeintakeSuiteTCP

.new_e2e_fleet_template:
  extends: .new_e2e_template
  rules:
    - !reference [.on_installer_or_e2e_changes]
    - !reference [.manual]
  needs:
    - !reference [.needs_new_e2e_template]
    - deploy_deb_testing-a7_arm64
    - deploy_deb_testing-a7_x64
    - deploy_rpm_testing-a7_arm64
    - deploy_rpm_testing-a7_x64
    - deploy_suse_rpm_testing_arm64-a7
    - deploy_suse_rpm_testing_x64-a7
    - deploy_windows_testing-a7
    - deploy_installer_oci
    - deploy_agent_oci
    - deploy_ddot_oci
    - qa_installer_script_linux
    - qa_installer_script_windows
  variables:
    TEAM: fleet
    E2E_USE_AWS_PROFILE: "false"
    MAX_RETRIES_FLAG: "--max-retries=3"
    TARGETS: ./tests/fleet

new-e2e-fleet-config:
  extends: .new_e2e_fleet_template
  variables:
    EXTRA_PARAMS: --run TestFleetConfig

new-e2e-fleet-upgrade:
  extends: .new_e2e_fleet_template
  variables:
    EXTRA_PARAMS: --run TestFleetUpgrade

new-e2e-fleet-extensions:
  extends: .new_e2e_fleet_template
  variables:
    EXTRA_PARAMS: --run TestFleetExtensions

new-e2e-installer-script:
  extends: .new_e2e_template
  rules:
    - !reference [.on_installer_or_e2e_changes]
    - !reference [.manual]
  needs:
    - !reference [.needs_new_e2e_template]
    - deploy_deb_testing-a7_arm64
    - deploy_deb_testing-a7_x64
    - deploy_rpm_testing-a7_arm64
    - deploy_rpm_testing-a7_x64
    - deploy_suse_rpm_testing_arm64-a7
    - deploy_suse_rpm_testing_x64-a7
    - deploy_installer_oci
    - deploy_agent_oci
    - qa_installer_script_linux
  variables:
    TARGETS: ./tests/installer/script
    TEAM: fleet
    FLEET_INSTALL_METHOD: "install_script"
    E2E_USE_AWS_PROFILE: "false"
    MAX_RETRIES_FLAG: "--max-retries=3"

new-e2e-installer:
  extends: .new_e2e_template
  rules:
    - !reference [.on_installer_or_e2e_changes]
    - !reference [.manual]
  needs:
    - !reference [.needs_new_e2e_template]
    - deploy_deb_testing-a7_arm64
    - deploy_deb_testing-a7_x64
    - deploy_rpm_testing-a7_arm64
    - deploy_rpm_testing-a7_x64
    - deploy_suse_rpm_testing_arm64-a7
    - deploy_suse_rpm_testing_x64-a7
    - deploy_windows_testing-a7
    - deploy_installer_oci
    - deploy_agent_oci
    - qa_installer_script_linux
    - qa_installer_script_windows
    - deploy_ddot_oci
  variables:
    TARGETS: ./tests/installer/unix
    TEAM: fleet
    FLEET_INSTALL_METHOD: "install_script"
    E2E_LOGS_PROCESSING_TEST_DEPTH: 2
    E2E_USE_AWS_PROFILE: "false"
    MAX_RETRIES_FLAG: "--max-retries=3"

new-e2e-installer-ansible:
  extends: .new_e2e_template
  rules:
    - !reference [.on_installer_or_e2e_changes]
    - !reference [.manual]
  needs:
    - !reference [.needs_new_e2e_template]
    - deploy_deb_testing-a7_arm64
    - deploy_deb_testing-a7_x64
    - deploy_rpm_testing-a7_arm64
    - deploy_rpm_testing-a7_x64
    - deploy_suse_rpm_testing_arm64-a7
    - deploy_suse_rpm_testing_x64-a7
    - deploy_windows_testing-a7
    - deploy_installer_oci
    - deploy_agent_oci
    - qa_installer_script_windows
  variables:
    TARGETS: ./tests/installer/unix
    TEAM: fleet
    FLEET_INSTALL_METHOD: "ansible"
    E2E_USE_AWS_PROFILE: "false"
    MAX_RETRIES_FLAG: "--max-retries=3"

new-e2e-ndm-netflow:
  extends: .new_e2e_template
  rules:
    - !reference [.on_ndm_netflow_or_e2e_changes]
    - !reference [.dynamic_tests] # The job will always be created on any Go code modification, tests are skipped dynamically in the job
    - !reference [.manual]
  needs:
    - !reference [.needs_new_e2e_template]
    - qa_agent_linux
  variables:
    TARGETS: ./tests/ndm/netflow
    TEAM: ndm-integrations
    ON_NIGHTLY_FIPS: "true"

new-e2e-ndm-snmp:
  extends: .new_e2e_template
  rules:
    - !reference [.on_ndm_snmp_or_e2e_changes]
    - !reference [.manual]
  needs:
    - !reference [.needs_new_e2e_template]
    - agent_deb-x64-a7
    - qa_agent_linux
  variables:
    TARGETS: ./tests/ndm/snmp
    TEAM: ndm-core
    ON_NIGHTLY_FIPS: "true"

new-e2e-ha-agent:
  extends: .new_e2e_template_needs_deb_x64
  rules:
    - !reference [.on_ha_agent_or_e2e_changes]
    - !reference [.manual]
  variables:
    TARGETS: ./tests/ha-agent
    TEAM: ndm-core
    # Temporarily disable the test on FIPS pipeline, as remote-configuration is not available with FIPS Agent yet
    # ON_NIGHTLY_FIPS: "true"
    EXTRA_PARAMS: --skip TestHAAgentFailoverSuite

new-e2e-ha-agent-failover:
  extends: .new_e2e_template_needs_deb_x64
  rules:
    - !reference [.on_ha_agent_or_e2e_changes]
    - !reference [.manual]
  variables:
    TARGETS: ./tests/ha-agent
    TEAM: ndm-core
    ON_NIGHTLY_FIPS: "true"
    EXTRA_PARAMS: --run TestHAAgentFailoverSuite
  allow_failure: true
  retry: !reference [.retry_only_infra_failure, retry]

new-e2e-netpath:
  extends: .new_e2e_template_needs_deb_x64
  rules:
    - !reference [.on_netpath_or_e2e_changes]
    - !reference [.manual]
  variables:
    TARGETS: ./tests/netpath
    TEAM: cloud-network-monitoring
    EXTRA_PARAMS: --skip "Windows"
    ON_NIGHTLY_FIPS: "true"

new-e2e-netpath-windows:
  extends: .new_e2e_template_needs_windows_x64
  rules:
    - !reference [.on_netpath_or_e2e_changes]
    - !reference [.dynamic_tests] # The job will always be created on any Go code modification, tests are skipped dynamically in the job
    - !reference [.manual]
  variables:
    TARGETS: ./tests/netpath
    TEAM: cloud-network-monitoring
    EXTRA_PARAMS: --run "Windows"
    ON_NIGHTLY_FIPS: "true"

new-e2e-windows-systemprobe:
  extends: .new_e2e_template
  rules:
    - !reference [.on_windows_systemprobe_or_e2e_changes]
    - !reference [.manual]
  needs:
    - !reference [.needs_new_e2e_template]
    - deploy_windows_testing-a7
    - tests_windows_sysprobe_x64
    - windows_msi_and_bosh_zip_x64-a7
  variables:
    TARGETS: ./tests/sysprobe-functional
    TEAM: windows-products
  parallel:
    matrix:
      - EXTRA_PARAMS: --run TestUSMAutoTaggingSuite
      - EXTRA_PARAMS: --run TestVMSuite

new-e2e-windows-security-agent:
  extends: .new_e2e_template
  rules:
    - !reference [.on_windows_security_or_e2e_changes]
    - !reference [.manual]
  needs:
    - !reference [.needs_new_e2e_template]
    - deploy_windows_testing-a7
    - tests_windows_secagent_x64
  variables:
    TARGETS: ./tests/security-agent-functional
    TEAM: windows-products

new-e2e-otel-eks-init:
  stage: e2e_init
  extends: .new_e2e_template
  rules:
    - !reference [.on_otel_or_e2e_changes]
    - !reference [.manual]
  needs:
    - go_e2e_deps
    - go_tools_deps
  variables:
    TARGETS: ./tests/otel
    TEAM: otel
    EXTRA_PARAMS: --run "TestOTelAgentIA(EKS|USTEKS)"
    E2E_INIT_ONLY: "true"
    SHOULD_RUN_IN_FLAKES_FINDER: "false"
    PRE_BUILT_BINARIES_FLAG: ""
    KUBERNETES_MEMORY_REQUEST: 12Gi
    KUBERNETES_MEMORY_LIMIT: 16Gi
  allow_failure: true
  retry: !reference [.retry_only_infra_failure, retry]

new-e2e-otel-eks:
  extends: .new_e2e_template
  rules:
    - !reference [.on_otel_or_e2e_changes]
    - !reference [.manual]
  needs:
    - !reference [.needs_new_e2e_template]
    - qa_dca
    - qa_agent_full
    - qa_ot_agent_standalone
    - new-e2e-otel-eks-init
  variables:
    TARGETS: ./tests/otel
    EXTRA_PARAMS: --run "TestOTelAgentIA(EKS|USTEKS)"
    TEAM: otel
    E2E_PRE_INITIALIZED: "true"
  retry: !reference [.retry_only_infra_failure, retry]

new-e2e-otel:
  extends: .new_e2e_template
  rules:
    - !reference [.on_otel_or_e2e_changes]
    - !reference [.manual]
  needs:
    - !reference [.needs_new_e2e_template]
    - qa_dca
    - qa_agent_full
    - qa_ot_agent_standalone
  variables:
    TARGETS: ./tests/otel
    EXTRA_PARAMS: --skip "TestOTelAgentIA(EKS|USTEKS)"
    TEAM: otel
    ON_NIGHTLY_FIPS: "true"

new-e2e-ssi:
  extends: .new_e2e_template
  rules:
    - !reference [.on_ssi_or_e2e_changes]
    - !reference [.manual]
  needs:
    - !reference [.needs_new_e2e_template]
    - qa_dca
    - qa_agent_linux
  variables:
    TARGETS: ./tests/ssi
    TEAM: injection-platform

.new-e2e_package_signing:
  variables:
    TARGETS: ./tests/agent-platform/package-signing
    TEAM: agent-delivery
    EXTRA_PARAMS: --osdescriptors $E2E_BRANCH_DESCRIPTORS
    ON_NIGHTLY_FIPS: "true"

new-e2e-package-signing-debian-a7-x86_64:
  extends:
    - .new_e2e_template
    - .new-e2e_package_signing
  variables:
    E2E_DESCRIPTORS: "debian/x86_64/9,debian/x86_64/10,debian/x86_64/11,debian/x86_64/12"
    E2E_CWS_SUPPORTED_DESCRIPTORS: "debian/x86_64/10,debian/x86_64/11"
    E2E_BRANCH_DESCRIPTORS: "debian/x86_64/11"
  needs:
    - !reference [.needs_new_e2e_template]
    - agent_deb-x64-a7
  rules: !reference [.on_package_signing_tests]

new-e2e-package-signing-suse-a7-x86_64:
  extends:
    - .new_e2e_template
    - .new-e2e_package_signing
  variables:
    E2E_DESCRIPTORS: "suse/x86_64/12,suse/x86_64/15-4"
    E2E_CWS_SUPPORTED_DESCRIPTORS: "suse/x86_64/12,suse/x86_64/15-4"
    E2E_BRANCH_DESCRIPTORS: "suse/x86_64/15-4"
  needs:
    - !reference [.needs_new_e2e_template]
    - agent_suse-x64-a7
  rules: !reference [.on_package_signing_tests]

new-e2e-cspm:
  extends: .new_e2e_template
  rules:
    - !reference [.on_cspm_or_e2e_changes]
    - !reference [.manual]
  needs:
    - !reference [.needs_new_e2e_template]
    - qa_agent_linux
    - qa_dca
  variables:
    TARGETS: ./tests/cspm
    TEAM: cspm
    ON_NIGHTLY_FIPS: "true"
  timeout: 35m

new-e2e-gpu:
  extends: .new_e2e_template_needs_container_deploy_linux
  rules:
    - !reference [.on_gpu_or_e2e_changes]
    - !reference [.manual]
  variables:
    TARGETS: ./tests/gpu # the target path where tests are
    TEAM: ebpf-platform
    E2E_PULUMI_LOG_LEVEL: 10 # incident-33572
    ON_NIGHTLY_FIPS: "true"
  needs: # list of required jobs. By default gitlab waits for any previous jobs.
    - !reference [.new_e2e_template_needs_container_deploy_linux, needs]
    - agent_deb-x64-a7 # agent 7 debian package
  parallel:
    matrix:
      - EXTRA_PARAMS: "--run TestGPUHostSuiteUbuntu2204"
      - EXTRA_PARAMS: "--run TestGPUK8sSuiteUbuntu2204"
      - EXTRA_PARAMS: "--run TestGPUHostSuiteUbuntu1804Driver510"
      - EXTRA_PARAMS: "--run TestGPUHostSuiteUbuntu1804Driver430" # This driver is not supported by the agent, but we can check that the agent does not crash. No need to test in k8s this one.
  retry: !reference [.retry_only_infra_failure, retry]

all-artifacts: # This job is used to collect all artifacts needed in the flake finder pipeline, because we are limited to 5 cross pipelines needs: https://forum.gitlab.com/t/needs-pipeline-job-limit-on-premise/88731
  stage: e2e
  tags: ["arch:amd64-cidc"]
  image: registry.ddbuild.io/ci/datadog-agent-buildimages/linux$CI_IMAGE_LINUX_SUFFIX:$CI_IMAGE_LINUX
  rules:
    - !reference [.except_disable_e2e_tests]
    - !reference [.on_deploy_nightly_repo_branch]
    - !reference [.manual]
  needs:
    - agent_deb-x64-a7
    - agent_deb-x64-a7-fips
    - windows_msi_and_bosh_zip_x64-a7-fips
    - windows_msi_and_bosh_zip_x64-a7
    - agent_rpm-x64-a7
    - agent_suse-x64-a7
  script:
    - exit 0
  artifacts:
    paths:
      - $OMNIBUS_PACKAGE_DIR
      - $OMNIBUS_PACKAGE_DIR_SUSE
    expire_in: 1 day
generate-flakes-finder-pipeline:
  image: registry.ddbuild.io/ci/datadog-agent-buildimages/linux$CI_IMAGE_LINUX_SUFFIX:$CI_IMAGE_LINUX
  stage: e2e
  rules:
    - !reference [.except_disable_e2e_tests]
    - !reference [.on_deploy_nightly_repo_branch]
    - !reference [.manual]
  dependencies: [compute_gitlab_ci_config]
  needs:
    - all-artifacts
    - compute_gitlab_ci_config
    - deploy_deb_testing-a7_arm64
    - deploy_deb_testing-a7_x64
    - deploy_rpm_testing-a7_arm64
    - deploy_rpm_testing-a7_x64
    - deploy_suse_rpm_testing_arm64-a7
    - deploy_suse_rpm_testing_x64-a7
    - deploy_windows_testing-a7
    - deploy_windows_testing-a7-fips
    - deploy_installer_oci
    - deploy_agent_oci
    - qa_cws_instrumentation
    - qa_dca
    - qa_dogstatsd
    - qa_agent
    - qa_agent_fips
    - qa_agent_fips_jmx
    - qa_agent_fips_linux
    - qa_agent_fips_linux_jmx
    - qa_agent_full
    - tests_windows_sysprobe_x64
  tags: ["arch:amd64-cidc"]
  script:
    - dda inv -- -e testwasher.generate-flake-finder-pipeline
    - dda inv -- -e linter.gitlab-ci --input-file $CI_PROJECT_DIR/flake-finder-gitlab-ci.yml
  artifacts:
    paths:
      - $CI_PROJECT_DIR/flake-finder-gitlab-ci.yml

trigger-flakes-finder:
  stage: e2e
  needs: [generate-flakes-finder-pipeline]
  rules:
    - !reference [.except_disable_e2e_tests]
    - !reference [.on_deploy_nightly_repo_branch]
    - !reference [.manual]
  variables:
    PARENT_PIPELINE_ID: $CI_PIPELINE_ID
    PARENT_COMMIT_SHA: $CI_COMMIT_SHORT_SHA
    PARENT_COMMIT_SHORT_SHA: $CI_COMMIT_SHORT_SHA
  trigger:
    include:
      - artifact: flake-finder-gitlab-ci.yml
        job: generate-flakes-finder-pipeline
  allow_failure: true

generate-fips-e2e-pipeline:
  image: registry.ddbuild.io/ci/datadog-agent-buildimages/linux$CI_IMAGE_LINUX_SUFFIX:$CI_IMAGE_LINUX
  stage: e2e
  rules:
    - !reference [.except_disable_e2e_tests]
    - !reference [.on_deploy_nightly_repo_branch]
    - !reference [.manual]
  needs:
    - all-artifacts
    - agent_deb-x64-a7-fips
    - agent_deb-x64-a7
    - windows_msi_and_bosh_zip_x64-a7-fips
    - windows_msi_and_bosh_zip_x64-a7
    - agent_rpm-x64-a7
    - agent_suse-x64-a7
    - compute_gitlab_ci_config
    - deploy_deb_testing-a7_arm64
    - deploy_deb_testing-a7_x64
    - deploy_rpm_testing-a7_arm64
    - deploy_rpm_testing-a7_x64
    - deploy_suse_rpm_testing_arm64-a7
    - deploy_suse_rpm_testing_x64-a7
    - deploy_windows_testing-a7
    - deploy_installer_oci
    - deploy_agent_oci
    - qa_cws_instrumentation
    - qa_dca
    - qa_dogstatsd
    - qa_agent
    - qa_agent_full
    - qa_agent_fips
    - qa_agent_fips_jmx
    - qa_agent_fips_linux
    - qa_agent_fips_linux_jmx
    - tests_windows_sysprobe_x64
  tags: ["arch:amd64-cidc"]
  script:
    - dda inv -- -e fips.generate-fips-e2e-pipeline
    - dda inv -- -e linter.gitlab-ci --input-file $CI_PROJECT_DIR/fips-e2e-gitlab-ci.yml
  artifacts:
    paths:
      - $CI_PROJECT_DIR/fips-e2e-gitlab-ci.yml

trigger-fips-e2e:
  stage: e2e
  needs: [generate-fips-e2e-pipeline]
  rules:
    - !reference [.except_disable_e2e_tests]
    - !reference [.on_deploy_nightly_repo_branch]
    - !reference [.manual]
  variables:
    PARENT_PIPELINE_ID: $CI_PIPELINE_ID
    PARENT_COMMIT_SHA: $CI_COMMIT_SHORT_SHA
    PARENT_COMMIT_SHORT_SHA: $CI_COMMIT_SHORT_SHA
  trigger:
    include:
      - artifact: fips-e2e-gitlab-ci.yml
        job: generate-fips-e2e-pipeline
    strategy: depend
