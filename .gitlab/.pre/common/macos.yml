---
# This is the scripts to be executed on the Gitlab macOS runners before every job.
# We don't have virtualization now so we need to clean the environment and install the proper dependencies before every job.
.macos_runner_maintenance:
  - DD_API_KEY="$("$CI_PROJECT_DIR"/tools/ci/fetch_secret.sh "$AGENT_API_KEY_ORG2" token)" || exit $?; export DD_API_KEY
  - DD_APP_KEY="$("$CI_PROJECT_DIR"/tools/ci/fetch_secret.sh "$AGENT_APP_KEY_ORG2" token)" || exit $?; export DD_APP_KEY
  # Report runner ID to Datadog, see this document for AWS meta data retrieval: https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instancedata-data-retrieval.html
  - |
    AWS_TOKEN="$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")"
    RUNNER_ID="$(curl -s http://169.254.169.254/latest/meta-data/instance-id -H "X-aws-ec2-metadata-token: $AWS_TOKEN" || hostname)"
    datadog-ci tag --level job --tags macos_runner:"$RUNNER_ID"
    echo "Reported runner ID to Datadog: $RUNNER_ID"
  # Report current version to datadog if main / release branch
  - |
    if [ "$CI_COMMIT_BRANCH" = "main" ] || [[ "$CI_COMMIT_BRANCH" =~ ^[0-9]+\.[0-9]+\.(x|[0-9]+)$ ]]; then
      dda inv -- -e macos.report-versions -l all || true
    fi
  # Remove inactive versions
  - |
    if [ "$((RANDOM%20))" -eq 0 ]; then
      echo Trying to remove inactive versions
      dda inv -- -e macos.remove-inactive-versions -l python -t "$PYTHON_VERSION" || true
      dda inv -- -e macos.remove-inactive-versions -l go -t "$(cat .go-version)" || true
    fi
  # Create custom temporary folder to isolate jobs from each other
  # We have to symlink it to /tmp/gitlabci to avoid some path length issues (sockets should be <= 104 characters on MacOS)
  - |
    export TMPDIR=/tmp/gitlabci
    NEWTMPDIR="$RUNNER_TEMP_PROJECT_DIR/gitlabci"
    rm -fr "$(realpath $TMPDIR)" "$NEWTMPDIR"
    mkdir "$NEWTMPDIR"
    sudo ln -fs "$NEWTMPDIR" $TMPDIR
    echo "Temporary folder created, TMPDIR=$TMPDIR -> $NEWTMPDIR"

.install_python_dependencies:
  # Update the version of dda to the latest version
  # dda is already preinstalled in the runner image but it might be an outdated version if the runner image is outdated
  - |
    export DDA_VERSION="$($robust_curl https://raw.githubusercontent.com/DataDog/datadog-agent-buildimages/${BUILDIMAGES_COMMIT}/dda.env | awk -F= '/^DDA_VERSION=/ {print $2}')"
    pip install --upgrade dda==$DDA_VERSION
  - dda self dep sync -f legacy-tasks

.vault_login:
  # Point the CLI to our internal vault
  - export VAULT_ADDR=https://vault.us1.ddbuild.io
  - vault login -method=aws -no-print

.aws_retry_config:
  - export AWS_RETRY_MODE=standard
  - export AWS_RETRY_MAX_ATTEMPTS=5

.macos_gitlab:
  needs: ["go_deps", "go_tools_deps"]
  id_tokens:
    CI_IDENTITIES_GITLAB_ID_TOKEN:
      aud: ci-identities
  variables:
    AWS_SHARED_CREDENTIALS_FILE: ${CI_PROJECT_DIR}/.aws/credentials-by-job-id/${CI_JOB_ID}
  before_script:
    - !reference [.vault_login]
    - !reference [.aws_retry_config]
    # Selecting the current Go version
    - |
      eval $(gimme $(cat .go-version))
      export GOPATH=$GOROOT
    - !reference [.install_python_dependencies]
    # See there is no virtualization, we need to clean the environment regularly
    - !reference [.macos_runner_maintenance]
    - dda inv -- -e rtloader.make
    - dda inv -- -e rtloader.install
    - !reference [.retrieve_linux_go_deps]
    - !reference [.retrieve_linux_go_tools_deps]
    - dda inv -- -e install-tools
