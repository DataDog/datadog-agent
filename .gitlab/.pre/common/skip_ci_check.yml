# Disallow [skip ci] in commit messages and PR descriptions

skip-ci-check:
  image: registry.ddbuild.io/ci/datadog-agent-buildimages/linux$CI_IMAGE_LINUX_SUFFIX:$CI_IMAGE_LINUX
  needs: []
  stage: setup
  tags: ["arch:amd64", "specific:true"]
  id_tokens:
    DDOCTOSTS_ID_TOKEN:
      aud: dd-octo-sts
  rules:
    - !reference [.on_mergequeue]
  script:
    - export GITHUB_TOKEN=$(dd-octo-sts token --scope DataDog/datadog-agent --policy self.gitlab.pull-request-read)
    - bash tools/ci/check_skip_ci.sh "$CI_COMMIT_SHA"
  after_script:
    - if [ -n "${GITHUB_TOKEN:-}" ]; then dd-octo-sts revoke -t "$GITHUB_TOKEN" || true; fi
