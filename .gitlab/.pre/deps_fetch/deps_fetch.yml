---
# deps_fetch stage
# Contains jobs which fetch go dependencies, in order
# to reuse them in further jobs that need them.

.retrieve_linux_go_deps:
  - mkdir -p $GOPATH/pkg/mod/cache && tar xJf modcache.tar.xz -C $GOPATH/pkg/mod/cache
  - rm -f modcache.tar.xz

.retrieve_linux_go_tools_deps:
  - mkdir -p $GOPATH/bin $GOPATH/pkg/mod/cache && tar xJf modcache_tools.tar.xz -C $GOPATH
  - rm -f modcache_tools.tar.xz
  - export PATH=$PATH:$GOPATH/bin

.retrieve_linux_go_tools_deps_arm64:
  - mkdir -p $GOPATH/bin $GOPATH/pkg/mod/cache && tar xJf modcache_tools_arm64.tar.xz -C $GOPATH
  - rm -f modcache_tools_arm64.tar.xz
  - export PATH=$PATH:$GOPATH/bin

.retrieve_linux_go_e2e_deps:
  - mkdir -p $GOPATH/pkg/mod/cache && tar xJf modcache_e2e.tar.xz -C $GOPATH/pkg/mod/cache
  - rm -f modcache_e2e.tar.xz

.retrieve_linux_pulumi_plugins:
  - mkdir -p ~/.pulumi && tar xJf pulumi_plugins.tar.xz -C ~/.pulumi
  - rm -f pulumi_plugins.tar.xz

.cache:
  stage: deps_fetch
  image: registry.ddbuild.io/ci/datadog-agent-buildimages/linux$CI_IMAGE_LINUX_SUFFIX:$CI_IMAGE_LINUX
  needs: ["setup_agent_version"]
  variables:
    KUBERNETES_CPU_REQUEST: 16
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      variables:
        POLICY: pull-push
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      variables:
        POLICY: pull
  retry: 2

# HACK: If you change the behavior of this job, change the `cache:key:prefix` value to invalidate the cache
go_deps:
  extends: .cache
  tags: ["arch:amd64", "specific:true"]
  variables:
    KUBERNETES_MEMORY_REQUEST: 12Gi
    KUBERNETES_MEMORY_LIMIT: 16Gi
  script:
    # If the cache already contains the dependencies, don't redownload them
    # but still provide the artifact that's expected for the other jobs to run
    - if [ -f modcache.tar.xz  ]; then exit 0; fi
    - dda inv -- -e deps --verbose
    - cd $GOPATH/pkg/mod/cache/ && tar c -I "xz -T${KUBERNETES_CPU_REQUEST}" -f $CI_PROJECT_DIR/modcache.tar.xz .
  artifacts:
    expire_in: 1 day
    paths:
      - $CI_PROJECT_DIR/modcache.tar.xz
  cache:
    # The `cache:key:files` only accepts up to two paths ([docs](https://docs.gitlab.com/ee/ci/yaml/#cachekeyfiles)).
    # We should also include the file this job is defined in to invalicate the cache when this job is modified.
    - key:
        files:
          - go.mod
          - ./**/go.mod
        prefix: "go_deps_modcache"
      paths:
        - modcache.tar.xz
  timeout: 35m

go_tools_deps:
  extends: .cache
  tags: ["arch:amd64", "specific:true"]
  script:
    - if [ -f modcache_tools.tar.xz  ]; then exit 0; fi
    - dda inv -- -e install-tools
    # Exclude datadog-package binary from the cache: it's already installed on all images and they don't have the same glibc version
    - cd $GOPATH && tar c -I "xz -T${KUBERNETES_CPU_REQUEST}" -f $CI_PROJECT_DIR/modcache_tools.tar.xz $(find bin/ -type f ! -name 'datadog-package') pkg/mod/cache/
  artifacts:
    expire_in: 1 day
    paths:
      - $CI_PROJECT_DIR/modcache_tools.tar.xz
  cache:
    - key:
        files:
          - ./**/go.mod
          - .gitlab/.pre/deps_fetch/deps_fetch.yml
        prefix: "go_tools_deps_modcache"
      paths:
        - modcache_tools.tar.xz

go_tools_deps_arm64:
  extends: .cache
  tags: ["arch:arm64", "specific:true"]
  script:
    - if [ -f modcache_tools_arm64.tar.xz  ]; then exit 0; fi
    - dda inv -- -e install-tools
    # Exclude datadog-package binary from the cache: it's already installed on all images and they don't have the same glibc version
    - cd $GOPATH && tar c -I "xz -T${KUBERNETES_CPU_REQUEST}" -f $CI_PROJECT_DIR/modcache_tools_arm64.tar.xz $(find bin/ -type f ! -name 'datadog-package') pkg/mod/cache/
  artifacts:
    expire_in: 1 day
    paths:
      - $CI_PROJECT_DIR/modcache_tools_arm64.tar.xz
  cache:
    - key:
        files:
          - ./**/go.mod
          - .gitlab/.pre/deps_fetch/deps_fetch.yml
        prefix: "go_tools_deps_modcache_arm64"
      paths:
        - modcache_tools_arm64.tar.xz

go_e2e_deps:
  id_tokens:
    DDOCTOSTS_ID_TOKEN:
      aud: dd-octo-sts
  extends: .cache
  tags: ["arch:amd64", "specific:true"]
  before_script:
    - export GITHUB_TOKEN=$(dd-octo-sts token --scope DataDog/datadog-agent --policy self.gitlab.read)
  script:
    - |
      if [ ! -f modcache_e2e.tar.xz ]; then
        dda inv -- -e new-e2e-tests.deps
        tar c -I "xz -T${KUBERNETES_CPU_REQUEST}" -f $CI_PROJECT_DIR/modcache_e2e.tar.xz -C $GOPATH/pkg/mod/cache/ .
      fi
    - |
      if [ ! -f pulumi_plugins.tar.xz ]; then
        # Pre-download Pulumi plugins used by e2e scenarios and components, should no longer be needed when we move test-infra-definitions to datadog-agent
        pushd ./test/new-e2e
        PULUMI_CONFIG_PASSPHRASE=dummy pulumi --non-interactive plugin install
        popd
        tar c -I "xz -T${KUBERNETES_CPU_REQUEST}" -f $CI_PROJECT_DIR/pulumi_plugins.tar.xz -C ~/.pulumi plugins
      fi
  artifacts:
    expire_in: 1 day
    paths:
      - $CI_PROJECT_DIR/modcache_e2e.tar.xz
      - $CI_PROJECT_DIR/pulumi_plugins.tar.xz
  cache:
    - key:
        files:
          - ./test/new-e2e/go.mod
          - .gitlab/.pre/deps_fetch/deps_fetch.yml
        prefix: "go_e2e_deps_modcache"
      paths:
        - modcache_e2e.tar.xz
    - key:
        files:
          - ./test/new-e2e/go.mod
          - .gitlab/.pre/deps_fetch/deps_fetch.yml
        prefix: "pulumi_plugins"
      paths:
        - pulumi_plugins.tar.xz

fetch_openjdk:
  needs: []
  tags: ["arch:amd64", "specific:true"]
  rules:
    - !reference [.manual]
  stage: deps_fetch
  image: registry.ddbuild.io/ci/datadog-agent-buildimages/linux$CI_IMAGE_LINUX_SUFFIX:$CI_IMAGE_LINUX
  variables:
    JDK_FILENAME: OpenJDK11U-jre_x64_windows_hotspot_11.0.25_9.zip
    JDK_URL: https://github.com/adoptium/temurin11-binaries/releases/download/jdk-11.0.25%2B9
    JDK_SHA256: 052f09448d5b8d9afb7a8e5049d40d7fafa8f5884afe6043bb2359787fd41e84
  script:
    - wget "$JDK_URL/$JDK_FILENAME" -O "$JDK_FILENAME"
    - echo "$JDK_SHA256  $JDK_FILENAME" | sha256sum -c
    - $S3_CP_CMD "$JDK_FILENAME" "$S3_DD_AGENT_OMNIBUS_JAVA_URI/$JDK_FILENAME" --grants read=uri=http://acs.amazonaws.com/groups/global/AllUsers
