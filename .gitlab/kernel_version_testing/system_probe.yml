kernel_version_testing_system_probe_linux_x64_ec2:
  extends:
    - .kitchen_ec2_location_us_east_1
  stage: kernel_version_testing
  rules:
    !reference [.on_system_probe_changes_or_manual]
  image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/datadog-agent-buildimages/system-probe_x64:$DATADOG_AGENT_SYSPROBE_BUILDIMAGES
  needs: ["go_deps", "go_tools_deps"]
  tags: ["runner:main"]
  variables:
    ARCH: x86_64
    EC2_INSTANCE_TYPE: "z1d.metal"
    AWS_REGION: us-east-1
  script:
    - apt install -y openssh-client
    - curl -fsSL https://get.pulumi.com | sh    
    - 'export PATH=$PATH:/root/.pulumi/bin'
    - export PULUMI_CONFIG_PASSPHRASE=1234
    - pulumi login --local
    - apt install -y xsltproc
    - inv -e system-probe.test-microvms --security-groups=$KITCHEN_EC2_SG_IDS --subnets=$KITCHEN_EC2_SUBNET --instance-type-x86=$EC2_INSTANCE_TYPE

