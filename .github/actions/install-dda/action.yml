name: Install dda
description: Installs the defined version of dda
inputs:
  version:
    description: The version of dda to install
    required: false
    default: ""
  features:
    description: A space-separated list of features to install
    required: false
    default: ""

runs:
  using: composite
  steps:
  - name: Set version
    id: set-version
    run: |-
      buildimages_version="$(yq '.variables.CI_IMAGE_LINUX' .gitlab-ci.yml)"
      buildimages_commit="${buildimages_version#*-}"
      version="$(curl -s https://raw.githubusercontent.com/DataDog/datadog-agent-buildimages/${buildimages_commit}/dda.env | awk -F= '/^DDA_VERSION=/ {print $2}')"
      echo "version=${version}" >> $GITHUB_OUTPUT
    shell: bash

  - name: Install dda
    uses: DataDog/datadog-agent-dev@1bc144c32a57327b768fb7161081b6a25a5c485e
    with:
      version: ${{ inputs.version || steps.set-version.outputs.version }}
      features: ${{ inputs.features }}
