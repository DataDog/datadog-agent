name: Update e2e tests Helm Chart Version

on:
  schedule:
    # Run weekly on Mondays at 6am UTC
    - cron: "0 6 * * 1"

  # Allow manual trigger
  workflow_dispatch:

permissions: {}

jobs:
  update-e2e-helm-version:
    timeout-minutes: 10
    name: Check for new Datadog Helm Chart version for E2E tests
    runs-on: ubuntu-latest
    permissions:
      id-token: write # Required for OIDC token from GitHub
    environment:
      name: main
    steps:
      - uses: DataDog/dd-octo-sts-action@acaa02eee7e3bb0839e4272dacb37b8f3b58ba80 # v1.0.3
        id: octo-sts
        with:
          scope: DataDog/datadog-agent
          policy: self.update-e2e-helm-chart-version.create-pr

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: true
          token: ${{ steps.octo-sts.outputs.token }}

      - name: Fetch latest Helm chart version
        id: fetch-version
        run: |
          set -euo pipefail
          
          # Fetch the Helm repository index
          curl -sL https://helm.datadoghq.com/index.yaml -o /tmp/index.yaml
          
          # Extract the latest version of the datadog chart
          # The chart entries are listed with newest first, so we get the first "version:" after "datadog:"
          LATEST_VERSION=$(awk '/^  datadog:$/{flag=1; next} flag && /^    version:/ {print $2; exit}' /tmp/index.yaml)
          echo "Latest Helm chart version: $LATEST_VERSION"
          
          # Get current version from the e2e tests file
          CURRENT_VERSION=$(grep -oP 'HelmVersion = "\K[^"]+' test/e2e-framework/components/datadog/agent/kubernetes_helm.go)
          echo "Current version in e2e tests: $CURRENT_VERSION"
          
          # Compare versions
          if [ "$LATEST_VERSION" = "$CURRENT_VERSION" ]; then
            echo "No update needed. Current version is up to date."
            echo "has_new_version=false" >> "$GITHUB_OUTPUT"
          else
            echo "New version available: $LATEST_VERSION"
            echo "has_new_version=true" >> "$GITHUB_OUTPUT"
            echo "latest_version=$LATEST_VERSION" >> "$GITHUB_OUTPUT"
            echo "current_version=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"
          fi

      - name: Update Helm version in e2e tests
        id: update-version
        if: steps.fetch-version.outputs.has_new_version == 'true'
        run: |
          set -euo pipefail
          
          LATEST_VERSION="${{ steps.fetch-version.outputs.latest_version }}"
          CURRENT_VERSION="${{ steps.fetch-version.outputs.current_version }}"
          FILE="test/e2e-framework/components/datadog/agent/kubernetes_helm.go"
          
          # Update the version in the e2e tests file
          sed -i "s/HelmVersion = \"$CURRENT_VERSION\"/HelmVersion = \"$LATEST_VERSION\"/" "$FILE"
          
          # Verify the change
          if grep -q "HelmVersion = \"$LATEST_VERSION\"" "$FILE"; then
            echo "Successfully updated e2e Helm version to $LATEST_VERSION"
            echo "updated=true" >> "$GITHUB_OUTPUT"
          else
            echo "Failed to update e2e Helm version"
            echo "updated=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi

      - uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e # v7.0.8
        name: Create pull request
        if: steps.update-version.outputs.updated == 'true'
        with:
          commit-message: "chore(e2e): update Datadog Helm chart version in e2e tests to ${{ steps.fetch-version.outputs.latest_version }}"
          branch: update-e2e-helm-chart-version-${{ github.run_id }}
          token: ${{ steps.octo-sts.outputs.token }}
          sign-commits: true
          title: "[automated] Update Datadog Helm chart version in e2e tests to ${{ steps.fetch-version.outputs.latest_version }}"
          body: |
            ### What does this PR do?
            Updates the Datadog Helm chart version used in e2e tests from `${{ steps.fetch-version.outputs.current_version }}` to `${{ steps.fetch-version.outputs.latest_version }}`.

            ### Motivation
            Keep e2e tests using the latest stable Datadog Helm chart version to ensure compatibility and benefit from latest features and bug fixes.

            ### Changed files
            - `test/e2e-framework/components/datadog/agent/kubernetes_helm.go`

            ### Describe how you validated your changes
            CI will validate that e2e tests pass with the new Helm chart version.

            ---
            ðŸ¤– This PR was automatically generated by the `update-e2e-helm-chart-version` GitHub Action workflow.
          team-reviewers: agent-devx
          labels: team/agent-devx,qa/done,changelog/no-changelog
