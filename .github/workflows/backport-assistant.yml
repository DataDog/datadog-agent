name: Backport Assistant

on:
  pull_request:
    types: [opened, labeled, unlabeled]
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  # Post/update eligibility table when PR is opened or fix type label is added/removed
  update_eligibility:
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.base.ref == 'main' &&
      github.event.pull_request.user.type != 'Bot' &&
      (
        github.event.action == 'opened' ||
        ((github.event.action == 'labeled' || github.event.action == 'unlabeled') && (startsWith(github.event.label.name, 'bugfix/') || startsWith(github.event.label.name, 'security/') || github.event.label.name == 'backport/exception'))
      )
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          sparse-checkout: |
            .dda
            .github
            tasks
            release.json
          persist-credentials: false

      - name: Install dda
        uses: ./.github/actions/install-dda
        with:
          features: legacy-tasks

      - name: Get release info and post comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          EVENT_ACTION: ${{ github.event.action }}
          ADDED_LABEL: ${{ github.event.label.name }}
        run: |
          # Get release info
          LAST_STABLE=$(cat release.json | jq -r '.last_stable["7"]')
          MILESTONE=$(cat release.json | jq -r '.current_milestone')
          LAST_STABLE_MAJOR=$(echo "$LAST_STABLE" | cut -d. -f1)
          LAST_STABLE_MINOR=$(echo "$LAST_STABLE" | cut -d. -f2)
          PATCH_BRANCH="${LAST_STABLE_MAJOR}.${LAST_STABLE_MINOR}.x"
          
          # Get RC branches
          BRANCHES=$(dda inv -- release.get-unreleased-release-branches 2>/dev/null || echo '[]')
          RC_BRANCHES=$(echo "$BRANCHES" | jq -r --arg stable "$LAST_STABLE_MINOR" '[.[] | select(. | split(".")[1] != $stable)] | join(" ")')
          
          # Get PR labels
          LABELS=$(gh pr view "$PR_NUMBER" --json labels -q '.labels[].name' | tr '\n' ' ')
          
          # Check fix type labels
          RC_ELIGIBLE="no"
          PATCH_ELIGIBLE="no"
          
          if echo "$LABELS" | grep -qiE 'bugfix/regression|bugfix/critical|security/cve|security/critical|backport/exception'; then
            RC_ELIGIBLE="yes"
          fi
          if echo "$LABELS" | grep -qiE 'bugfix/critical|security/cve|security/critical|backport/exception'; then
            PATCH_ELIGIBLE="yes"
          fi
          
          # Build comment
          cat << EOF > comment.md
          <!-- backport-assistant -->
          ## üîÑ Backport Assistant
          EOF
          
          if [ "$EVENT_ACTION" = "labeled" ] && [ -n "$ADDED_LABEL" ]; then
            echo "" >> comment.md
            echo "‚úÖ Label \`$ADDED_LABEL\` added" >> comment.md
          elif [ "$EVENT_ACTION" = "unlabeled" ] && [ -n "$ADDED_LABEL" ]; then
            echo "" >> comment.md
            echo "üîÑ Label \`$ADDED_LABEL\` removed" >> comment.md
          fi
          
          cat << EOF >> comment.md
          
          | Release | Status | Eligible | Label to backport |
          |---------|--------|----------|-------------------|
          EOF
          
          # Add RC releases
          for BRANCH in $RC_BRANCHES; do
            MINOR=$(echo "$BRANCH" | sed 's/\.x$//' | cut -d. -f2)
            VERSION="${LAST_STABLE_MAJOR}.${MINOR}.0"
            [ "$RC_ELIGIBLE" = "yes" ] && ELIGIBLE="üü° Potentially" || ELIGIBLE="‚ùå"
            echo "| **$VERSION** | üöÄ RC | $ELIGIBLE | \`backport/$BRANCH\` |" >> comment.md
          done
          
          # Add patch release
          [ "$PATCH_ELIGIBLE" = "yes" ] && PATCH_CELL="üü° Potentially" || PATCH_CELL="‚ùå"
          echo "| **$LAST_STABLE+** | ‚úÖ Stable | $PATCH_CELL | \`backport/$PATCH_BRANCH\` |" >> comment.md
          
          # Add dev
          echo "| **$MILESTONE** | üî® Dev | ‚úÖ | _main_ |" >> comment.md
          
          cat << EOF >> comment.md
          
          üìÖ [**Release Calendar**](https://docs.google.com/spreadsheets/d/14PXAEEm2EZWfR8dWdOOHjeU_lt8zx9waRe_BIzQ36s4) _(internal)_
          üìñ [**Backport Guidelines**](https://datadoghq.atlassian.net/wiki/spaces/agent/pages/1755676984/Expectations+For+Agent+Releases#backport-pr-guidelines) _(internal)_
          
          ---
          
          ### Fix type labels
          
          | Label | Description | RC | Patch |
          |-------|-------------|:--:|:-----:|
          | \`bugfix/regression\` | Regression from **current release cycle** | ‚úÖ | ‚ùå |
          | \`bugfix/critical\` | Critical bug with **customer impact** | ‚úÖ | ‚ö†Ô∏è |
          | \`security/cve\` | Known **CVE** vulnerability | ‚úÖ | ‚ö†Ô∏è |
          | \`security/critical\` | Critical security issue | ‚úÖ | ‚ö†Ô∏è |
          | \`backport/exception\` | Exception - **requires justification** | ‚ö†Ô∏è | ‚ö†Ô∏è |
          
          üü° = Fill the backport request form via \`/agent\` in [#agent-release-sync](https://dd.enterprise.slack.com/archives/CE4PS8MHS)
          EOF
          
          # Update existing comment or create new one
          COMMENT_ID=$(gh pr view "$PR_NUMBER" --json comments -q '.comments[] | select(.body | contains("<!-- backport-assistant -->")) | .id' | tail -1)
          if [ -n "$COMMENT_ID" ]; then
            gh api graphql -f query='mutation($id: ID!, $body: String!) { updateIssueComment(input: {id: $id, body: $body}) { issueComment { id } } }' -f id="$COMMENT_ID" -f body="$(cat comment.md)"
          else
            gh pr comment "$PR_NUMBER" --body-file comment.md
          fi

  # Confirm when backport branch label is added
  confirm_backport:
    runs-on: ubuntu-latest
    if: |
      github.event.action == 'labeled' &&
      startsWith(github.event.label.name, 'backport/7')
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          sparse-checkout: release.json
          persist-credentials: false

      - name: Confirm backport
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          LABEL: ${{ github.event.label.name }}
        run: |
          LAST_STABLE=$(cat release.json | jq -r '.last_stable["7"]')
          LAST_STABLE_MINOR=$(echo "$LAST_STABLE" | cut -d. -f2)
          TARGET_BRANCH=$(echo "$LABEL" | sed 's/backport\///')
          TARGET_MINOR=$(echo "$TARGET_BRANCH" | sed 's/\.x$//' | cut -d. -f2)
          
          # Get PR labels
          LABELS=$(gh pr view "$PR_NUMBER" --json labels -q '.labels[].name' | tr '\n' ' ')
          
          # Check eligibility
          # RC eligible: bugfix/regression, bugfix/critical, security/cve, security/critical, backport/exception
          HAS_ANY_TYPE=$(echo "$LABELS" | grep -qE 'bugfix/regression|bugfix/critical|security/cve|security/critical|backport/exception' && echo "yes" || echo "no")
          # Patch eligible: bugfix/critical, security/cve, security/critical, backport/exception (NOT regression)
          PATCH_ELIGIBLE=$(echo "$LABELS" | grep -qE 'bugfix/critical|security/cve|security/critical|backport/exception' && echo "yes" || echo "no")
          HAS_EXCEPTION=$(echo "$LABELS" | grep -q 'backport/exception' && echo "yes" || echo "no")
          
          if [ "$TARGET_MINOR" = "$LAST_STABLE_MINOR" ]; then
            # Patch release
            if [ "$HAS_EXCEPTION" = "yes" ]; then
              cat << EOF > comment.md
          ‚ö†Ô∏è **Patch release EXCEPTION: $TARGET_BRANCH** ‚Üí $LAST_STABLE
          
          **Required:**
          - [ ] Justification documented in PR description
          - [ ] PM/EM approval obtained
          - [ ] Discussed in [#agent-release-sync](https://dd.enterprise.slack.com/archives/CE4PS8MHS)
          EOF
            elif [ "$PATCH_ELIGIBLE" = "yes" ]; then
              cat << EOF > comment.md
          ‚ö†Ô∏è **Patch release: $TARGET_BRANCH** ‚Üí $LAST_STABLE
          
          **Required:**
          - [ ] Customer impact documented
          - [ ] PM/EM approval obtained
          EOF
            else
              cat << EOF > comment.md
          ‚ùå **Patch release requires:** \`bugfix/critical\`, \`security/cve\`, \`security/critical\`, or \`backport/exception\`
          
          If this is a regression, target an RC release instead.
          EOF
            fi
          else
            # RC backport
            TARGET_VERSION="${TARGET_BRANCH%.x}.0"
            if [ "$HAS_EXCEPTION" = "yes" ]; then
              cat << EOF > comment.md
          ‚ö†Ô∏è **RC backport EXCEPTION: $TARGET_BRANCH ‚Üí $TARGET_VERSION**
          
          **Required:** Justification + PM/EM approval
          EOF
            elif [ "$HAS_ANY_TYPE" = "yes" ]; then
              cat << EOF > comment.md
          ‚úÖ **RC backport: $TARGET_BRANCH ‚Üí $TARGET_VERSION**
          EOF
            else
              cat << EOF > comment.md
          ‚ö†Ô∏è **Missing fix type label** - Add \`bugfix/regression\`, \`bugfix/critical\`, \`security/cve\`, or \`security/critical\`
          EOF
            fi
          fi
          
          echo "" >> comment.md
          echo "**After merge:** \`/agent\` in [#agent-release-sync](https://dd.enterprise.slack.com/archives/CE4PS8MHS)" >> comment.md
          
          gh pr comment "$PR_NUMBER" --body-file comment.md
