# Report PR merged event to Datadog

name: Report Merged PR

on:
  push:
    branches:
      - main

permissions: {}

jobs:
  report_merged_pr:
    runs-on: ubuntu-latest
    environment:
      name: main
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Install dda
        uses: ./.github/actions/install-dda
        with:
          features: legacy-tasks

      - name: Extract PR number from commit message
        id: extract_pr
        run: |
          # Get the last commit message from the push to main
          COMMIT_MESSAGE="$(git log -1 --pretty=format:"%s")"
          echo "Last commit message: $COMMIT_MESSAGE"

          # Extract PR number from format "(#1234)" in commit message
          PR_NUMBER="$(echo "$COMMIT_MESSAGE" | grep -oE '\(#[0-9]+\)' | grep -oE '[0-9]+' | tail -n 1)"

          # If no PR number found in commit message, exit with error
          if [ -z "$PR_NUMBER" ]; then
            echo "Error: No PR number found in commit message format (#{number})"
            echo "Commit message was: $COMMIT_MESSAGE"
            exit 1
          else
            echo "Extracted PR number from commit message: $PR_NUMBER"
          fi

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - name: Send merge event to Datadog
        env:
          PR_NUMBER: ${{ steps.extract_pr.outputs.pr_number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DD_API_KEY: ${{ secrets.REPORT_MERGED_PR_DD_API_KEY }}
        run: |
          dda inv -- -e github.pr-merge-dd-event-sender -p "$PR_NUMBER"
