---
name: "Label analysis"

on:
  pull_request:
    types: [labeled, unlabeled, synchronize]
    branches:
      - main
      - "[0-9]+.[0-9]+.x"

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

permissions: {}

jobs:
  get-pr-context:
    if: github.triggering_actor != 'dd-devflow[bot]'
    runs-on: ubuntu-latest
    outputs:
      PR_NUMBER: ${{ steps.context.outputs.pr_number }}
      HEAD_REF: ${{ steps.context.outputs.head_ref }}
      IS_FORK: ${{ steps.context.outputs.is_fork }}
    steps:
      - name: Get PR context
        id: context
        env:
          HEAD_REF: ${{ github.head_ref }}
        run: |
          echo "pr_number=${{ github.event.pull_request.number }}" >> "$GITHUB_OUTPUT"
          echo "head_ref=$HEAD_REF" >> "$GITHUB_OUTPUT"
          if [[ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]]; then
            echo "is_fork=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_fork=false" >> "$GITHUB_OUTPUT"
          fi

  release-note-check:
    needs: get-pr-context
    runs-on: ubuntu-latest
    steps:
      # Checkout base repo for trusted code (tasks, dda install)
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: main
          fetch-depth: 0
          sparse-checkout: |
            .gitlab-ci.yml
            .github/actions/install-dda
            tasks
          persist-credentials: false
      # Fetch and checkout only releasenotes folders from PR (data only, no code execution)
      # Using refs/pull/NUMBER/head works for both fork and non-fork PRs
      - name: Fetch PR head
        run: git fetch origin "refs/pull/${{ needs.get-pr-context.outputs.PR_NUMBER }}/head"
      - name: Checkout releasenotes from PR
        run: git checkout FETCH_HEAD -- releasenotes releasenotes-dca releasenotes-installscript 2>/dev/null || true
      - name: Install dda
        uses: ./.github/actions/install-dda
        with:
          features: legacy-tasks
      - name: Check release note
        env:
          BRANCH_NAME: ${{ needs.get-pr-context.outputs.HEAD_REF }}
          PR_ID: ${{ needs.get-pr-context.outputs.PR_NUMBER }}
        run: dda inv -- -e linter.releasenote

  fetch-labels:
    needs: get-pr-context
    runs-on: ubuntu-latest
    outputs:
      LABELS: ${{ steps.pr-labels.outputs.LABELS }}
    steps:
      - name: Get PR labels
        id: pr-labels
        env:
          PR_NUMBER: ${{ needs.get-pr-context.outputs.PR_NUMBER }}
        run: |
          labels="$(curl --retry 4 -fsSL \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER" \
            | jq -r '[.labels[].name] | join(" ")')"
          echo "Fetched labels for PR $PR_NUMBER: $labels"
          echo "LABELS=$labels" >> "$GITHUB_OUTPUT"

  team-label-check:
    needs: [get-pr-context, fetch-labels]
    runs-on: ubuntu-latest
    steps:
      - name: Check team assignment
        run: |
          for label in $LABELS; do
            if [[ "$label" =~ ^qa/ ]]; then
              echo "A label to skip QA is set -- no need for team assignment"
              exit 0
            fi
            if [[ "$label" =~ ^team/ && "$label" != team/triage ]]; then
              echo "Team label found: $label"
              exit 0
            fi
          done
          echo "PR ${{ needs.get-pr-context.outputs.PR_NUMBER }} requires at least one non-triage team assignment label (label starting by 'team/')"
          exit 1
        env:
          LABELS: ${{ needs.fetch-labels.outputs.LABELS }}

  skip-qa-check:
    needs: [get-pr-context, fetch-labels]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: main
          sparse-checkout: |
            .gitlab-ci.yml
            .github/actions/install-dda
            tasks
          persist-credentials: false
      - name: Install dda
        uses: ./.github/actions/install-dda
        with:
          features: legacy-tasks
      - name: Check qa/[done|no-code-change] labels are not set together
        env:
          LABELS: ${{ needs.fetch-labels.outputs.LABELS }}
        run: |
          dda inv -- -e github.check-qa-labels --labels "${LABELS[@]}"

  agenttelemetry-list-change-ack-check:
    needs: get-pr-context
    if: needs.get-pr-context.outputs.IS_FORK == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ needs.get-pr-context.outputs.HEAD_REF }}
      - name: Install dda
        uses: ./.github/actions/install-dda
        with:
          features: legacy-tasks
      - name: Check agent telemetry metric list
        run: dda inv -- -e github.agenttelemetry-list-change-ack-check --pr-id=${{ needs.get-pr-context.outputs.PR_NUMBER }}
