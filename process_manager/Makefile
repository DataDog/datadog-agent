.PHONY: help build test test-engine test-e2e test-all clean run-daemon stop-daemon
.PHONY: docker-build docker-shell docker-test docker-test-e2e docker-mock docker-down docker-clean
.PHONY: dev-start dev-stop dev-daemon dev-cli

help:
	@echo "Process Manager - Test Suite"
	@echo ""
	@echo "Native targets:"
	@echo "  make build          - Build all binaries (release mode)"
	@echo "  make build-debug    - Build all binaries (debug mode)"
	@echo "  make test           - Run all tests (engine + e2e)"
	@echo "  make test-engine    - Run engine integration tests only"
	@echo "  make test-e2e       - Run e2e tests (daemon + CLI)"
	@echo "  make test-quick     - Run quick smoke tests"
	@echo "  make clean          - Clean build artifacts"
	@echo "  make run-daemon     - Start daemon in background"
	@echo "  make stop-daemon    - Stop running daemon"
	@echo "  make fmt            - Format code"
	@echo "  make clippy         - Run clippy linter"
	@echo "  make ci             - Run full CI pipeline (fmt, clippy, test)"
	@echo ""
	@echo "Docker targets (for macOS testing):"
	@echo "  make docker-build   - Build Docker test image"
	@echo "  make docker-shell   - Get interactive shell in container"
	@echo "  make docker-test    - Run all tests in Docker"
	@echo "  make docker-test-e2e - Run e2e tests in Docker"
	@echo "  make docker-mock    - Test with mock Datadog services"
	@echo "  make docker-down    - Stop all containers"
	@echo "  make docker-clean   - Remove containers and images"
	@echo ""
	@echo "Manual testing (multi-container):"
	@echo "  make dev-start      - Start dev environment (daemon + cli containers)"
	@echo "  make dev-daemon     - Get shell in daemon container"
	@echo "  make dev-cli        - Get shell in CLI container"
	@echo "  make dev-stop       - Stop dev environment"

# Build targets
build:
	@echo "ğŸ”¨ Building release binaries..."
	cargo build --release
	@echo "âœ… Build complete: target/release/{daemon,cli}"

build-debug:
	@echo "ğŸ”¨ Building debug binaries..."
	cargo build
	@echo "âœ… Build complete: target/debug/{daemon,cli}"

# Test targets
test-engine:
	@echo "ğŸ§ª Running engine integration tests..."
	cd engine && cargo test --lib --tests
	@echo "âœ… Engine tests passed"

test-e2e: build
	@echo "ğŸ§ª Running e2e tests in parallel..."
	@echo "âš ï¸  Note: E2E tests will start/stop daemon automatically"
	@echo "ğŸ’¡ If tests fail with 'Address already in use', run: pkill -9 -f 'target/release/daemon'"
	cd tests && cargo test
	@echo "âœ… E2E tests passed"

test-all: test-engine test-e2e
	@echo "ğŸ‰ All tests passed!"

test: test-all

test-quick:
	@echo "âš¡ Running quick smoke tests..."
	cd engine && cargo test --test engine_lifecycle -- --test-threads=1
	@echo "âœ… Quick tests passed"

# Code quality
fmt:
	@echo "ğŸ¨ Formatting code..."
	cargo fmt --all
	@echo "âœ… Code formatted"

fmt-check:
	@echo "ğŸ” Checking code format..."
	cargo fmt --all -- --check

clippy:
	@echo "ğŸ“ Running clippy..."
	cargo clippy --all-targets --all-features -- -D warnings
	@echo "âœ… Clippy checks passed"

# Daemon management
run-daemon:
	@echo "ğŸš€ Starting daemon..."
	@pkill -9 -f "target/debug/daemon" || true
	@pkill -9 -f "target/release/daemon" || true
	@sleep 1
	./target/debug/daemon &
	@sleep 2
	@echo "âœ… Daemon running (PID: $$(pgrep -f 'target/debug/daemon'))"

stop-daemon:
	@echo "ğŸ›‘ Stopping daemon..."
	@pkill -9 -f "target/debug/daemon" || true
	@pkill -9 -f "target/release/daemon" || true
	@echo "âœ… Daemon stopped"

# CI pipeline
ci: fmt-check clippy test-all
	@echo "ğŸ‰ CI pipeline passed!"

# Clean
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	cargo clean
	rm -f tests/*.tmp
	@echo "âœ… Clean complete"

# Documentation
docs:
	@echo "ğŸ“š Building documentation..."
	cargo doc --no-deps --open

# Install targets
install: build
	@echo "Installing binaries..."
	sudo cp target/release/dd-procmgrd /usr/local/bin/dd-procmgrd
	sudo cp target/release/dd-procmgr /usr/local/bin/dd-procmgr
	@echo "Installed to /usr/local/bin/{dd-procmgrd,dd-procmgr}"

uninstall:
	@echo "Uninstalling binaries..."
	sudo rm -f /usr/local/bin/dd-procmgrd
	sudo rm -f /usr/local/bin/dd-procmgr
	@echo "Uninstalled"

# Development helpers
dev-setup:
	@echo "ğŸ› ï¸  Setting up development environment..."
	rustup component add rustfmt clippy
	@echo "âœ… Development tools installed"

watch:
	@echo "ğŸ‘€ Watching for changes..."
	cargo watch -x build

# Report test coverage (requires cargo-tarpaulin)
coverage:
	@echo "ğŸ“Š Generating test coverage report..."
	cargo tarpaulin --out Html --output-dir coverage
	@echo "âœ… Coverage report: coverage/index.html"

#
# Docker targets (for macOS and cross-platform testing)
#

docker-build:
	@echo "ğŸ³ Building Docker test image..."
	docker build -f Dockerfile.test -t pm-test .
	@echo "âœ… Docker image built"

docker-shell: docker-build
	@echo "ğŸ³ Starting interactive shell..."
	docker run -it --rm \
		-v $(PWD):/workspace \
		-w /workspace \
		--cap-add SYS_ADMIN \
		--security-opt apparmor:unconfined \
		pm-test bash

docker-test: docker-build
	@echo "ğŸ³ Running all tests in Docker..."
	docker run --rm \
		-v $(PWD):/workspace \
		-w /workspace \
		--cap-add SYS_ADMIN \
		--security-opt apparmor:unconfined \
		pm-test \
		bash -c "cargo build --release && make test-engine && make test-e2e"

docker-test-e2e: docker-build
	@echo "ğŸ³ Running e2e tests in Docker..."
	docker run --rm \
		-v $(PWD):/workspace \
		-w /workspace \
		--cap-add SYS_ADMIN \
		--security-opt apparmor:unconfined \
		pm-test \
		bash -c "cargo build && make test-e2e"

docker-mock: docker-build
	@echo "ğŸ³ Testing with mock Datadog services..."
	@echo "ğŸ“ Setting up mock services..."
	@mkdir -p docker/mock-datadog
	docker run --rm \
		-v $(PWD):/workspace \
		-w /workspace \
		--cap-add SYS_ADMIN \
		--cap-add NET_BIND_SERVICE \
		--security-opt apparmor:unconfined \
		pm-test \
		bash -c "./docker/scripts/test-mock-datadog.sh"

docker-compose-up:
	@echo "ğŸ³ Starting docker-compose services..."
	docker-compose up -d
	@echo "âœ… Services started"
	@echo "   - process-manager: docker-compose exec process-manager bash"
	@echo "   - mock-datadog: docker-compose exec mock-datadog bash"

docker-down:
	@echo "ğŸ³ Stopping docker-compose services..."
	docker-compose down
	@echo "âœ… Services stopped"

docker-clean: docker-down
	@echo "ğŸ³ Cleaning Docker images and containers..."
	docker rmi pm-test || true
	docker-compose down -v --rmi all || true
	docker-compose -f docker-compose.dev.yml down -v || true
	@echo "âœ… Docker cleanup complete"

#
# Manual testing targets (multi-container development)
#

dev-start: docker-build
	@echo "ğŸ³ Starting development environment..."
	docker-compose -f docker-compose.dev.yml up -d
	@echo "âœ… Dev environment started!"
	@echo ""
	@echo "Next steps:"
	@echo "  1. Terminal 1: make dev-daemon"
	@echo "     Then run: cargo build --release && ./target/release/daemon examples/mock-datadog.yaml"
	@echo ""
	@echo "  2. Terminal 2: make dev-cli"
	@echo "     Then run: ./target/release/cli list"

dev-daemon:
	@echo "ğŸ³ Connecting to daemon container..."
	docker-compose -f docker-compose.dev.yml exec daemon bash

dev-cli:
	@echo "ğŸ³ Connecting to CLI container..."
	docker-compose -f docker-compose.dev.yml exec cli bash

dev-stop:
	@echo "ğŸ³ Stopping development environment..."
	docker-compose -f docker-compose.dev.yml down
	@echo "âœ… Dev environment stopped"

