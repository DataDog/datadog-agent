# Datadog Agent - Process Manager Configuration
# Equivalent to the systemd datadog-agent.service unit
#
# This configuration is used by dd-procmgrd to supervise the main Datadog Agent process.
# Place this file at: /etc/datadog-agent/process-manager/processes.d/datadog-agent.yaml
# The process name is derived from the filename (datadog-agent)
#
# Note: dd-procmgrd must run as root to handle user switching, runtime directories,
# and capabilities for child processes.

description: Datadog Agent
command: /opt/datadog-agent/bin/agent/agent
args:
  - run
  - -c
  - /etc/datadog-agent/datadog.yaml
process_type: simple
auto_start: true

# User to run as (systemd User=dd-agent)
# dd-procmgrd must run as root to switch to this user
user: dd-agent

# Restart policy (systemd Restart=on-failure)
restart: on-failure

# Start limits (systemd StartLimitInterval=10, StartLimitBurst=5)
start_limit_interval_sec: 10
start_limit_burst: 5

# PID file (systemd PIDFile=)
pidfile: /opt/datadog-agent/run/agent.pid

# Environment file (systemd EnvironmentFile=-)
# Prefix with '-' to ignore if file doesn't exist
environment_file: -/etc/datadog-agent/environment

# Environment variables (systemd Environment=)
env:
  DD_FLEET_POLICIES_DIR: /etc/datadog-agent/managed/datadog-agent/stable

# Note: RuntimeDirectory is NOT configured here because systemd already handles it
# via RuntimeDirectory=datadog in the service unit file. If we configured it here,
# stopping the agent would clean up /run/datadog/ and delete dd-procmgrd's socket.

# Ambient capabilities (systemd AmbientCapabilities=)
# Allows binding to privileged ports (< 1024) when running as non-root
ambient_capabilities:
  - CAP_NET_BIND_SERVICE

# Mutual exclusion (systemd Conflicts=datadog-agent-exp.service)
# Only one variant can run at a time - stable OR experimental
conflicts:
  - datadog-agent-exp

# Soft dependencies (systemd Wants=)
# Auto-starts these processes if they are defined, but continues if they fail
# Note: datadog-agent-trace is NOT here - it uses socket activation (starts on first connection)
wants:
  - datadog-agent-installer
  - datadog-agent-process
  - datadog-agent-sysprobe
  - datadog-agent-security
  - datadog-agent-data-plane
  - datadog-agent-ddot

# Output handling
stdout: inherit
stderr: inherit
