# Datadog Security Agent - Process Manager Configuration
# Equivalent to the systemd datadog-agent-security.service unit
#
# This configuration is used by dd-procmgrd to supervise the Datadog Security Agent.
# Place this file at: /etc/pm/processes.d/datadog-agent-security.yaml
# The process name is derived from the filename (datadog-agent-security)

description: Datadog Security Agent
command: /opt/datadog-agent/embedded/bin/security-agent
args:
  - start
  - -c
  - /etc/datadog-agent/datadog.yaml
  - -c
  - /etc/datadog-agent/security-agent.yaml
  - --sysprobe-config
  - /etc/datadog-agent/system-probe.yaml
# Note: --pidfile removed - process manager tracks PIDs internally
process_type: simple
auto_start: false  # Started via 'wants' from main agent

# No user specified - runs as root (required for security monitoring)

# Restart policy (systemd Restart=on-failure)
restart: on-failure

# Start limits (systemd StartLimitInterval=10, StartLimitBurst=5)
start_limit_interval_sec: 10
start_limit_burst: 5

# Environment file (systemd EnvironmentFile=-)
environment_file: -/etc/datadog-agent/environment

# Environment variables (systemd Environment=)
env:
  DD_FLEET_POLICIES_DIR: /etc/datadog-agent/managed/datadog-agent/stable

# Conditional starting (systemd ConditionPathExists=|)
# Process only starts if at least one of these config files exists
# The '|' prefix means OR logic - any one path existing satisfies the condition
condition_path_exists:
  - "|/etc/datadog-agent/security-agent.yaml"
  - "|/etc/datadog-agent/managed/datadog-agent/stable/security-agent.yaml"

# Ordering (systemd After=)
after:
  - datadog-agent
  - datadog-agent-exp

# Binding (systemd BindsTo=)
# This process is bound to the main agent - stops when main agent stops
binds_to:
  - datadog-agent

# Mutual exclusion (systemd Conflicts=)
conflicts:
  - datadog-agent-security-exp

# Output handling
stdout: inherit
stderr: inherit

