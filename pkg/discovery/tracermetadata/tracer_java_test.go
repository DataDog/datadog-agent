// Unless explicitly stated otherwise all files in this repository are licensed
// under the Apache License Version 2.0.
// This product includes software developed at Datadog (https://www.datadoghq.com/).
// Copyright 2025-present Datadog, Inc.

// This file has no build tag so it can run on all platforms (including macOS),
// unlike tracer_memfd_test.go which requires linux for memfd syscalls.

package tracermetadata

import (
	"testing"

	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

func TestParseJavaTracerMetadata(t *testing.T) {
	// Captured from a Java tracer (dd-trace-java 1.59.0) memfd via hexdump -C /proc/<pid>/fd/<fd>
	data := []byte{
		0x88, 0xae, 0x73, 0x63, 0x68, 0x65, 0x6d, 0x61, 0x5f, 0x76, 0x65, 0x72, 0x73, 0x69, 0x6f, 0x6e,
		0x02, 0xaf, 0x74, 0x72, 0x61, 0x63, 0x65, 0x72, 0x5f, 0x6c, 0x61, 0x6e, 0x67, 0x75, 0x61, 0x67,
		0x65, 0xa4, 0x6a, 0x61, 0x76, 0x61, 0xae, 0x74, 0x72, 0x61, 0x63, 0x65, 0x72, 0x5f, 0x76, 0x65,
		0x72, 0x73, 0x69, 0x6f, 0x6e, 0xd9, 0x11, 0x31, 0x2e, 0x35, 0x39, 0x2e, 0x30, 0x7e, 0x37, 0x65,
		0x31, 0x62, 0x62, 0x30, 0x33, 0x62, 0x63, 0x33, 0xa8, 0x68, 0x6f, 0x73, 0x74, 0x6e, 0x61, 0x6d,
		0x65, 0xd9, 0x10, 0x72, 0x61, 0x70, 0x68, 0x61, 0x65, 0x6c, 0x2d, 0x64, 0x65, 0x62, 0x69, 0x61,
		0x6e, 0x31, 0x32, 0xae, 0x6c, 0x6f, 0x67, 0x73, 0x5f, 0x63, 0x6f, 0x6c, 0x6c, 0x65, 0x63, 0x74,
		0x65, 0x64, 0xc3, 0xaa, 0x72, 0x75, 0x6e, 0x74, 0x69, 0x6d, 0x65, 0x5f, 0x69, 0x64, 0xd9, 0x24,
		0x36, 0x32, 0x61, 0x66, 0x32, 0x64, 0x36, 0x36, 0x2d, 0x62, 0x62, 0x34, 0x37, 0x2d, 0x34, 0x38,
		0x30, 0x31, 0x2d, 0x62, 0x36, 0x34, 0x64, 0x2d, 0x36, 0x63, 0x31, 0x32, 0x62, 0x30, 0x66, 0x38,
		0x61, 0x31, 0x31, 0x62, 0xac, 0x73, 0x65, 0x72, 0x76, 0x69, 0x63, 0x65, 0x5f, 0x6e, 0x61, 0x6d,
		0x65, 0xd9, 0x20, 0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d, 0x70, 0x6c, 0x65, 0x2e, 0x64,
		0x65, 0x6d, 0x6f, 0x2e, 0x44, 0x65, 0x6d, 0x6f, 0x41, 0x70, 0x70, 0x6c, 0x69, 0x63, 0x61, 0x74,
		0x69, 0x6f, 0x6e, 0xac, 0x70, 0x72, 0x6f, 0x63, 0x65, 0x73, 0x73, 0x5f, 0x74, 0x61, 0x67, 0x73,
		0xd9, 0x8c, 0x65, 0x6e, 0x74, 0x72, 0x79, 0x70, 0x6f, 0x69, 0x6e, 0x74, 0x2e, 0x6e, 0x61, 0x6d,
		0x65, 0x3a, 0x63, 0x6f, 0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d, 0x70, 0x6c, 0x65, 0x2e, 0x64, 0x65,
		0x6d, 0x6f, 0x2e, 0x64, 0x65, 0x6d, 0x6f, 0x61, 0x70, 0x70, 0x6c, 0x69, 0x63, 0x61, 0x74, 0x69,
		0x6f, 0x6e, 0x2c, 0x65, 0x6e, 0x74, 0x72, 0x79, 0x70, 0x6f, 0x69, 0x6e, 0x74, 0x2e, 0x74, 0x79,
		0x70, 0x65, 0x3a, 0x63, 0x6c, 0x61, 0x73, 0x73, 0x2c, 0x65, 0x6e, 0x74, 0x72, 0x79, 0x70, 0x6f,
		0x69, 0x6e, 0x74, 0x2e, 0x77, 0x6f, 0x72, 0x6b, 0x64, 0x69, 0x72, 0x3a, 0x6a, 0x61, 0x76, 0x61,
		0x5f, 0x61, 0x70, 0x70, 0x2c, 0x73, 0x76, 0x63, 0x2e, 0x61, 0x75, 0x74, 0x6f, 0x3a, 0x63, 0x6f,
		0x6d, 0x2e, 0x65, 0x78, 0x61, 0x6d, 0x70, 0x6c, 0x65, 0x2e, 0x64, 0x65, 0x6d, 0x6f, 0x2e, 0x64,
		0x65, 0x6d, 0x6f, 0x61, 0x70, 0x70, 0x6c, 0x69, 0x63, 0x61, 0x74, 0x69, 0x6f, 0x6e,
	}

	var trm TracerMetadata
	_, err := trm.UnmarshalMsg(data)
	require.NoError(t, err)
	require.Equal(t, uint8(2), trm.SchemaVersion)
	require.Equal(t, "java", trm.TracerLanguage)
	require.Equal(t, "1.59.0~7e1bb03bc3", trm.TracerVersion)
	require.Equal(t, "raphael-debian12", trm.Hostname)
	require.Equal(t, true, trm.LogsCollected)
	require.Equal(t, "62af2d66-bb47-4801-b64d-6c12b0f8a11b", trm.RuntimeID)
	require.Equal(t, "com.example.demo.DemoApplication", trm.ServiceName)
	require.Equal(t, "entrypoint.name:com.example.demo.demoapplication,entrypoint.type:class,entrypoint.workdir:java_app,svc.auto:com.example.demo.demoapplication", trm.ProcessTags)

	tags := trm.GetTags()
	assert.Equal(t, []string{
		"tracer_service_name:com.example.demo.DemoApplication",
		"entrypoint.name:com.example.demo.demoapplication",
		"entrypoint.type:class",
		"entrypoint.workdir:java_app",
		"svc.auto:com.example.demo.demoapplication",
	}, tags)
}
