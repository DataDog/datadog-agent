/* Unless explicitly stated otherwise all files in this repository are licensed
 * under the Apache License Version 2.0.
 * This product includes software developed at Datadog (https://www.datadoghq.com/).
 * Copyright 2025-present Datadog, Inc. */

#ifndef DD_DISCOVERY_H
#define DD_DISCOVERY_H

/* Warning, this file is autogenerated by cbindgen. Don't modify this manually. */

#include <stdbool.h>
#include <stddef.h>
#include <stdint.h>

/**
 * Length-delimited byte string â€” avoids NUL-termination so the Go caller
 * can use `C.GoStringN(data, len)` directly without `strlen`.
 * NULL `data` with `len == 0` represents an absent/empty value.
 */
struct dd_str {
  const char *data;
  size_t len;
};

/**
 * Array of `dd_str`.
 */
struct dd_strs {
  const struct dd_str *data;
  size_t len;
};

struct dd_tracer_metadata {
  uint8_t schema_version;
  struct dd_str runtime_id;
  struct dd_str tracer_language;
  struct dd_str tracer_version;
  struct dd_str hostname;
  struct dd_str service_name;
  struct dd_str service_env;
  struct dd_str service_version;
};

struct dd_tracer_metadata_slice {
  const struct dd_tracer_metadata *data;
  size_t len;
};

/**
 * Unified Service Tagging.
 */
struct dd_ust {
  struct dd_str service;
  struct dd_str env;
  struct dd_str version;
};

/**
 * Slice of `u16` values (port numbers).
 */
struct dd_u16_slice {
  const uint16_t *data;
  size_t len;
};

struct dd_service {
  int32_t pid;
  struct dd_str generated_name;
  struct dd_str generated_name_source;
  struct dd_strs additional_generated_names;
  struct dd_tracer_metadata_slice tracer_metadata;
  struct dd_ust ust;
  struct dd_u16_slice tcp_ports;
  struct dd_u16_slice udp_ports;
  struct dd_strs log_files;
  bool apm_instrumentation;
  struct dd_str language;
  struct dd_str service_type;
  bool has_nvidia_gpu;
};

struct dd_discovery_result {
  struct dd_service *services;
  size_t services_len;
  int32_t *injected_pids;
  size_t injected_pids_len;
};

/**
 * Run service discovery and return a heap-allocated result.
 *
 * # Parameters
 * - `new_pids` / `new_pids_len`: optional slice of PIDs to fully scan.
 *   Pass NULL + 0 for none.
 * - `heartbeat_pids` / `heartbeat_pids_len`: optional slice of PIDs for heartbeat.
 *   Pass NULL + 0 for none.
 *
 * # Returns
 * Pointer to a `dd_discovery_result`. The caller MUST pass it to
 * `dd_discovery_free` exactly once after reading the fields.
 *
 * # Safety
 * - If `new_pids` is non-NULL, it must point to a valid array of `new_pids_len` i32 values.
 * - If `heartbeat_pids` is non-NULL, it must point to a valid array of `heartbeat_pids_len` i32 values.
 * - The returned pointer must be freed with `dd_discovery_free` exactly once.
 */
struct dd_discovery_result *dd_discovery_get_services(const int32_t *new_pids,
                                                      size_t new_pids_len,
                                                      const int32_t *heartbeat_pids,
                                                      size_t heartbeat_pids_len);

/**
 * Free a `dd_discovery_result` previously returned by `dd_discovery_get_services`.
 *
 * # Safety
 * `result` must be a pointer returned by `dd_discovery_get_services` and must
 * not have been freed before. Passing NULL is a no-op.
 */
void dd_discovery_free(struct dd_discovery_result *result);

#endif  /* DD_DISCOVERY_H */
