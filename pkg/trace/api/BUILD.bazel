load("@rules_go//go:def.bzl", "go_library", "go_test")

go_library(
    name = "api",
    srcs = [
        "api.go",
        "container.go",
        "container_linux.go",
        "debug_server.go",
        "debugger.go",
        "dogstatsd.go",
        "endpoints.go",
        "evp_proxy.go",
        "info.go",
        "listener.go",
        "otlp.go",
        "payload.go",
        "pipe.go",
        "pipe_off.go",
        "pipeline_stats.go",
        "profiles.go",
        "responses.go",
        "symdb.go",
        "telemetry.go",
        "tracer_flare.go",
        "transports.go",
        "version.go",
    ],
    importpath = "github.com/DataDog/datadog-agent/pkg/trace/api",
    visibility = ["//visibility:public"],
    deps = [
        "//pkg/obfuscate",
        "//pkg/proto/pbgo/trace",
        "//pkg/trace/api/apiutil",
        "//pkg/trace/api/internal/header",
        "//pkg/trace/config",
        "//pkg/trace/info",
        "//pkg/trace/log",
        "//pkg/trace/sampler",
        "//pkg/trace/telemetry",
        "//pkg/trace/timing",
        "//pkg/trace/traceutil",
        "//pkg/trace/watchdog",
        "@com_github_datadog_datadog_go_v5//statsd",
        "@com_github_datadog_opentelemetry_mapping_go_pkg_otlp_attributes//:attributes",
        "@com_github_datadog_opentelemetry_mapping_go_pkg_otlp_attributes//source",
        "@com_github_google_uuid//:uuid",
        "@com_github_tinylib_msgp//msgp",
        "@io_opentelemetry_go_collector_pdata//pcommon",
        "@io_opentelemetry_go_collector_pdata//ptrace",
        "@io_opentelemetry_go_collector_pdata//ptrace/ptraceotlp",
        "@io_opentelemetry_go_collector_semconv//v1.17.0:v1_17_0",
        "@io_opentelemetry_go_collector_semconv//v1.6.1:v1_6_1",
        "@org_golang_google_grpc//:go_default_library",
        "@org_golang_google_grpc//metadata",
        "@org_uber_go_atomic//:atomic",
    ] + select({
        "@rules_go//go/platform:android": [
            "//pkg/util/cgroups",
            "//pkg/util/log",
        ],
        "@rules_go//go/platform:linux": [
            "//pkg/util/cgroups",
            "//pkg/util/log",
        ],
        "@rules_go//go/platform:windows": [
            "@com_github_microsoft_go_winio//:go-winio",
        ],
        "//conditions:default": [],
    }),
)

go_test(
    name = "api_test",
    srcs = [
        "api_nix_test.go",
        "api_oom_test.go",
        "api_test.go",
        "container_linux_test.go",
        "debugger_test.go",
        "dogstatsd_test.go",
        "dogstatsd_uds_test.go",
        "evp_proxy_test.go",
        "fuzz_test.go",
        "info_test.go",
        "listener_test.go",
        "otlp_test.go",
        "pipeline_stats_test.go",
        "profiles_test.go",
        "responses_test.go",
        "symdb_test.go",
        "telemetry_test.go",
        "tracer_flare_test.go",
    ],
    embed = [":api"],
    deps = [
        "//pkg/obfuscate",
        "//pkg/proto/pbgo/trace",
        "//pkg/trace/api/apiutil",
        "//pkg/trace/api/internal/header",
        "//pkg/trace/config",
        "//pkg/trace/info",
        "//pkg/trace/sampler",
        "//pkg/trace/telemetry",
        "//pkg/trace/teststatsd",
        "//pkg/trace/testutil",
        "//pkg/trace/timing",
        "//pkg/trace/traceutil",
        "@com_github_datadog_datadog_go_v5//statsd",
        "@com_github_datadog_opentelemetry_mapping_go_pkg_otlp_attributes//:attributes",
        "@com_github_datadog_opentelemetry_mapping_go_pkg_otlp_attributes//source",
        "@com_github_stretchr_testify//assert",
        "@com_github_stretchr_testify//require",
        "@com_github_tinylib_msgp//msgp",
        "@com_github_vmihailenco_msgpack_v4//:msgpack",
        "@io_opentelemetry_go_collector_component//componenttest",
        "@io_opentelemetry_go_collector_pdata//pcommon",
        "@io_opentelemetry_go_collector_pdata//ptrace",
        "@io_opentelemetry_go_collector_pdata//ptrace/ptraceotlp",
        "@io_opentelemetry_go_collector_semconv//v1.6.1:v1_6_1",
        "@org_uber_go_atomic//:atomic",
    ] + select({
        "@rules_go//go/platform:aix": [
            "//pkg/trace/log",
        ],
        "@rules_go//go/platform:android": [
            "//pkg/trace/log",
        ],
        "@rules_go//go/platform:darwin": [
            "//pkg/trace/log",
        ],
        "@rules_go//go/platform:dragonfly": [
            "//pkg/trace/log",
        ],
        "@rules_go//go/platform:freebsd": [
            "//pkg/trace/log",
        ],
        "@rules_go//go/platform:illumos": [
            "//pkg/trace/log",
        ],
        "@rules_go//go/platform:ios": [
            "//pkg/trace/log",
        ],
        "@rules_go//go/platform:js": [
            "//pkg/trace/log",
        ],
        "@rules_go//go/platform:linux": [
            "//pkg/trace/log",
        ],
        "@rules_go//go/platform:netbsd": [
            "//pkg/trace/log",
        ],
        "@rules_go//go/platform:openbsd": [
            "//pkg/trace/log",
        ],
        "@rules_go//go/platform:plan9": [
            "//pkg/trace/log",
        ],
        "@rules_go//go/platform:solaris": [
            "//pkg/trace/log",
        ],
        "//conditions:default": [],
    }),
)
