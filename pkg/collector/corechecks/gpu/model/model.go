// Unless explicitly stated otherwise all files in this repository are licensed
// under the Apache License Version 2.0.
// This product includes software developed at Datadog (https://www.datadoghq.com/).
// Copyright 2024-present Datadog, Inc.

// Package model contains the model for the GPU check, with types shared between the system-probe GPU probe and
// the gpu core agent check
package model

// MemoryMetrics contains the memory stats for a given memory type
type MemoryMetrics struct {
	// CurrentBytes is the amount of memory that is allocated when the stats are generated.
	CurrentBytes uint64 `json:"current_bytes"`

	// MaxBytes is the maximum amount of memory that has been allocated in the interval.
	// While it's not reported to the backend, we leave it as it's useful for debugging
	// and unit testing.
	MaxBytes uint64 `json:"max_bytes"`
}

// UtilizationMetrics contains the GPU stats for a given device and process
type UtilizationMetrics struct {
	// UsedCores stores the average number of GPU cores used by this process in the interval
	UsedCores float64 `json:"used_cores"`

	// Memory stores the memory stats for the process during the interval
	Memory MemoryMetrics `json:"memory"`

	// ActiveTimePct is the percentage of time (0-100) that the process had active kernels running during the interval
	ActiveTimePct float64 `json:"active_time_pct"`
}

// ProcessStatsKey is the key used to identify a GPUStats object
type ProcessStatsKey struct {
	// PID is the process ID
	PID uint32 `json:"pid"`

	// DeviceUUID is the UUID of the device
	DeviceUUID string `json:"device_uuid"`

	// ContainerID is the ID of the container the process is running on
	ContainerID string `json:"container_id"`
}

// ProcessStatsTuple is a single entry in the GPUStats array, as we cannot use a complex key in the map
type ProcessStatsTuple struct {
	Key                ProcessStatsKey
	UtilizationMetrics UtilizationMetrics
}

// DeviceUtilizationMetrics contains device-wide GPU utilization statistics
type DeviceUtilizationMetrics struct {
	// ActiveTimePct is the percentage of time (0-100) that any kernel was running on this device during the interval
	ActiveTimePct float64 `json:"active_time_pct"`
}

// DeviceStatsTuple is a single entry for device-level statistics
type DeviceStatsTuple struct {
	// DeviceUUID is the UUID of the device
	DeviceUUID string `json:"device_uuid"`

	// Metrics contains the device-level utilization metrics
	Metrics DeviceUtilizationMetrics `json:"metrics"`
}

// GPUStats contains the statistics generated by the system-probe GPU module, which are sent to the core agent.
// Contains an array of StatsTuple, where each entry is a tuple of a StatsKey and the corresponding UtilizationMetrics
type GPUStats struct {
	ProcessMetrics []ProcessStatsTuple `json:"process_metrics"` // Per-process metrics
	DeviceMetrics  []DeviceStatsTuple  `json:"device_metrics"`  // Device-level metrics
}
