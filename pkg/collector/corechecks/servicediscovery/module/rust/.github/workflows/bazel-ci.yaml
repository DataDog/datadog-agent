name: Bazel CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      with:
        persist-credentials: false

    - name: Install Bazelisk
      run: |
        # Download and install Bazelisk
        BAZELISK_VERSION="v1.25.0"
        wget -q "https://github.com/bazelbuild/bazelisk/releases/download/${BAZELISK_VERSION}/bazelisk-linux-amd64"
        chmod +x bazelisk-linux-amd64
        sudo mv bazelisk-linux-amd64 /usr/local/bin/bazel
        bazel --version

    - name: Cache Bazel
      uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4
      with:
        path: |
          ~/.cache/bazel
          ~/.cache/bazelisk
        key: ${{ runner.os }}-bazel-${{ hashFiles('.bazelversion', 'MODULE.bazel', 'MODULE.bazel.lock') }}
        restore-keys: |
          ${{ runner.os }}-bazel-

    - name: Cache Buildifier
      id: cache-buildifier
      uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4
      with:
        path: ~/.local/bin/buildifier
        key: ${{ runner.os }}-buildifier-v7.3.1

    - name: Install Buildifier
      if: steps.cache-buildifier.outputs.cache-hit != 'true'
      run: |
        mkdir -p ~/.local/bin
        wget -q https://github.com/bazelbuild/buildtools/releases/download/v7.3.1/buildifier-linux-amd64
        chmod +x buildifier-linux-amd64
        mv buildifier-linux-amd64 ~/.local/bin/buildifier

    - name: Add buildifier to PATH
      run: echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Check Bazel file formatting
      run: |
        buildifier --version
        buildifier -mode=check -lint=warn -r .

    - name: Build
      run: bazel build --aspects=@rules_rust//rust:defs.bzl%rust_clippy_aspect --output_groups=+clippy_checks //...

    - name: Run tests
      run: bazel test //...

    - name: Install
      run: bazel run -- //:install --destdir foo
