# ============================================================================
# Rust Optimization Configuration (matches Cargo release profile)
# ============================================================================

# Define a "release" config that mimics cargo --release
common:release -c opt

# Cargo release profile optimizations
common:release --@rules_rust//rust/settings:lto=fat
common:release --@rules_rust//rust/settings:extra_rustc_flag=-Copt-level=z
common:release --@rules_rust//rust/settings:extra_rustc_flag=-Cpanic=abort
common:release --@rules_rust//rust/settings:extra_rustc_flag=-Ccodegen-units=1
build:release --strip=always

# ============================================================================
# General Bazel Configuration
# ============================================================================

# Use all CPU cores
build --jobs=auto

# Show detailed error messages
build --verbose_failures

# Use persistent workers for faster builds
build --worker_sandboxing

# Enable disk cache
build --disk_cache=~/.cache/bazel

# ============================================================================
# Test Configuration
# ============================================================================

# Show test output on failure
test --test_output=errors

# Run tests with optimizations in release mode
test:release --test_env=RUST_BACKTRACE=1

# ============================================================================
# Rust-Specific Settings
# ============================================================================

# Note: Rust channel and edition are configured in MODULE.bazel
# via the rust.toolchain() call

# ============================================================================
# Platform-Specific Settings
# ============================================================================

# Linux-specific optimizations
build:linux --copt=-ffunction-sections
build:linux --copt=-fdata-sections
build:linux --linkopt=-Wl,--gc-sections

# Auto-detect platform
build --enable_platform_specific_config
