// Unless explicitly stated otherwise all files in this repository are licensed
// under the Apache License Version 2.0.
// This product includes software developed at Datadog (https://www.datadoghq.com/).
// Copyright 2016-2019 Datadog, Inc.

package kubernetes

import "github.com/DataDog/datadog-agent/pkg/logs/decoder"

const (
	flagFull = "F"
	flagPartial = "P"
)

// PartialLineHandler is a Handler to manage the kubernetes prefixed logs.
// A typical kubernetes log looks like:
// [timestamp stream flag message]
// T1 S1 P M1 // max 16KB
// T2 S2 F M2 // max 16KB
// The line generated by this handler should be:
// T2 S2 F M1M2
// Normally, a line should be at max 16KB which is less than the default
// LineGenerator decode length (defaultMaxDecodeLength = 1MB).
type PartialLineHandler struct {
	nextHandler decoder.Handler
	lineBuf *partialLineBuffer
}

func (p *PartialLineHandler) Handle(line *decoder.RichLine) {
	if line.Flag == flagFull {
		p.SendResult()
	} else {
		p.cacheLine(line)
	}
}

func (p *PartialLineHandler) cacheLine(line *decoder.RichLine) {
	p.lineBuf.appendContent(line.Content)
}

func (p *PartialLineHandler) Cleanup() {
	p.nextHandler.SendResult()
	p.nextHandler.Cleanup()
}

func (p *PartialLineHandler) SendResult() {
	line := p.lineBuf.toLine()
	if line != nil {
		p.nextHandler.Handle(line)
	}
}
