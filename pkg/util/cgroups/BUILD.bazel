load("@rules_go//go:def.bzl", "go_library", "go_test")

go_library(
    name = "cgroups",
    srcs = [
        "cgroup.go",
        "cgroup_mock.go",
        "cgroup_shared.go",
        "cgroupv1.go",
        "cgroupv1_cpu.go",
        "cgroupv1_io.go",
        "cgroupv1_memory.go",
        "cgroupv1_pids.go",
        "cgroupv2.go",
        "cgroupv2_cpu.go",
        "cgroupv2_io.go",
        "cgroupv2_memory.go",
        "cgroupv2_pids.go",
        "doc.go",
        "errors.go",
        "file.go",
        "memory_controller.go",
        "namespace_linux.go",
        "pid_mapper.go",
        "reader.go",
        "reader_detector.go",
        "readerv1.go",
        "readerv2.go",
        "reporter.go",
        "self_reader.go",
        "stats.go",
        "utils.go",
    ],
    importpath = "github.com/DataDog/datadog-agent/pkg/util/cgroups",
    visibility = ["//visibility:public"],
    deps = select({
        "@rules_go//go/platform:android": [
            "//pkg/util/log",
            "//pkg/util/pointer",
            "@com_github_containerd_cgroups_v3//cgroup1",
            "@com_github_karrick_godirwalk//:godirwalk",
        ],
        "@rules_go//go/platform:linux": [
            "//pkg/util/log",
            "//pkg/util/pointer",
            "@com_github_containerd_cgroups_v3//cgroup1",
            "@com_github_karrick_godirwalk//:godirwalk",
        ],
        "//conditions:default": [],
    }),
)

go_test(
    name = "cgroups_test",
    srcs = [
        "cgroup_shared_test.go",
        "cgroupv1_cpu_test.go",
        "cgroupv1_io_test.go",
        "cgroupv1_memory_test.go",
        "cgroupv1_pids_test.go",
        "cgroupv2_cpu_test.go",
        "cgroupv2_io_test.go",
        "cgroupv2_memory_test.go",
        "cgroupv2_pids_test.go",
        "file_for_test.go",
        "pid_mapper_test.go",
        "reader_detector_test.go",
        "readerv1_test.go",
        "readerv2_test.go",
        "reporter_for_test.go",
        "self_reader_test.go",
    ],
    data = glob(["testdata/**"]),
    embed = [":cgroups"],
    deps = select({
        "@rules_go//go/platform:android": [
            "//pkg/util/pointer",
            "@com_github_google_go_cmp//cmp",
            "@com_github_stretchr_testify//assert",
            "@com_github_stretchr_testify//require",
        ],
        "@rules_go//go/platform:linux": [
            "//pkg/util/pointer",
            "@com_github_google_go_cmp//cmp",
            "@com_github_stretchr_testify//assert",
            "@com_github_stretchr_testify//require",
        ],
        "//conditions:default": [],
    }),
)
