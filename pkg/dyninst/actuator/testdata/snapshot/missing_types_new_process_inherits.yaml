# Tests the interaction between deferred recompilation and new processes
# inheriting discovered types. Exercises:
# 1. Processes 1001 (svc-a) and 1002 (svc-b) start; pipeline loads them.
# 2. While loading process 1002, missing types are reported for process 1001.
# 3. Types are recorded but recompilation is deferred (pipeline busy).
# 4. Process 1002 finishes loading. Pipeline becomes idle.
# 5. Deferred recompilation triggers for process 1001.
# 6. While process 1001 is being recompiled, a new process 1003 for svc-a
#    arrives. Its program inherits the discovered types immediately.
# 7. Everything completes. Both 1001 and 1003 are attached with types.
- !processes-updated
  updated:
    - process_id: {pid: 1001}
      executable: {path: /usr/bin/app-a}
      service: svc-a
      probes:
        - {type: LOG_PROBE, id: probe1, where: {methodName: main}, captureSnapshot: true}
    - process_id: {pid: 1002}
      executable: {path: /usr/bin/app-b}
      service: svc-b
      probes:
        - {type: LOG_PROBE, id: probe2, where: {methodName: foo}, captureSnapshot: true}
- !loaded {program_id: 1}
- !attached {program_id: 1, process_id: 1001}
# Pipeline is busy loading program 2 for process 1002.
# Report missing types for process 1001 -- deferred since pipeline is busy.
- !missing-types-reported {process_id: 1001, type_names: [MyStruct]}
# Program 2 loads. Pipeline becomes idle â†’ deferred recompilation for 1001.
- !loaded {program_id: 2}
- !attached {program_id: 2, process_id: 1002}
# While 1001 is being recompiled, a new process 1003 joins svc-a.
# Its program should inherit the discovered types [MyStruct].
- !processes-updated
  updated:
    - process_id: {pid: 1003}
      executable: {path: /usr/bin/app-a}
      service: svc-a
      probes:
        - {type: LOG_PROBE, id: probe1, where: {methodName: main}, captureSnapshot: true}
# Complete the recompilation cycle for process 1001.
- !detached {program_id: 1, process_id: 1001}
- !unloaded {program_id: 1}
# Process 1003's program loads (program 3). Process 1001's recompiled
# program (program 4) is dequeued and starts loading.
- !loaded {program_id: 3}
- !attached {program_id: 3, process_id: 1003}
# Process 1001's recompiled program loads with inherited types.
- !loaded {program_id: 4}
- !attached {program_id: 4, process_id: 1001}
---
event: !processes-updated
  updated:
    - process_id: {pid: 1001}
      executable: {path: /usr/bin/app-a}
      service: svc-a
      probes:
        - {type: LOG_PROBE, id: probe1, where: {methodName: main}, captureSnapshot: true}
    - process_id: {pid: 1002}
      executable: {path: /usr/bin/app-b}
      service: svc-b
      probes:
        - {type: LOG_PROBE, id: probe2, where: {methodName: foo}, captureSnapshot: true}
effects:
  - !spawn-bpf-loading {executable: /usr/bin/app-a@0.0m0.0, probes: [probe1], process_id: 1001, program_id: 1}
state:
  currently_loading: <nil> -> 1
  queued_programs: '[] -> [2]'
  processes:
    1001: <nil> -> WaitingForProgram (prog 1)
    1002: <nil> -> WaitingForProgram (prog 2)
  programs:
    1: <nil> -> Loading (proc 1001)
    2: <nil> -> Queued (proc 1002)
  stats:
    numProcesses: 0 -> 2
    numPrograms: 0 -> 2
    numWaitingForProgram: 0 -> 2
---
event: !loaded {program_id: 1}
effects:
  - !attach-to-process {executable: /usr/bin/app-a@0.0m0.0, process_id: 1001, program_id: 1}
  - !spawn-bpf-loading {executable: /usr/bin/app-b@0.0m0.0, probes: [probe2], process_id: 1002, program_id: 2}
state:
  currently_loading: 1 -> 2
  queued_programs: '[2] -> []'
  processes:
    1001: WaitingForProgram (prog 1) -> Attaching (prog 1)
    1002: WaitingForProgram (prog 2)
  programs:
    1: Loading (proc 1001) -> Loaded (proc 1001)
    2: Queued (proc 1002) -> Loading (proc 1002)
  stats:
    loaded: 0 -> 1
    numAttaching: 0 -> 1
    numWaitingForProgram: 2 -> 1
---
event: !attached {program_id: 1, process_id: 1001}
state:
  currently_loading: "2"
  queued_programs: '[]'
  processes:
    1001: Attaching (prog 1) -> Attached (prog 1)
    1002: WaitingForProgram (prog 2)
  programs:
    1: Loaded (proc 1001)
    2: Loading (proc 1002)
  stats:
    attached: 0 -> 1
    numAttached: 0 -> 1
    numAttaching: 1 -> 0
---
event: !missing-types-reported {process_id: 1001, type_names: [MyStruct]}
state:
  currently_loading: "2"
  queued_programs: '[]'
  processes:
    1001: Attached (prog 1)
    1002: WaitingForProgram (prog 2)
  programs:
    1: Loaded (proc 1001)
    2: Loading (proc 1002)
  discovered_types:
    svc-a: '[] -> [MyStruct]'
---
event: !loaded {program_id: 2}
effects:
  - !attach-to-process {executable: /usr/bin/app-b@0.0m0.0, process_id: 1002, program_id: 2}
  - !detach-from-process {failure: "no", process_id: 1001, program_id: 1}
state:
  currently_loading: 2 -> <nil>
  queued_programs: '[]'
  processes:
    1001: Attached (prog 1) -> Detaching (prog 1)
    1002: WaitingForProgram (prog 2) -> Attaching (prog 2)
  programs:
    1: Loaded (proc 1001) -> Draining (proc 1001)
    2: Loading (proc 1002) -> Loaded (proc 1002)
  stats:
    loaded: 1 -> 2
    numAttached: 1 -> 0
    numAttaching: 0 -> 1
    numDetaching: 0 -> 1
    numWaitingForProgram: 1 -> 0
    typeRecompilationsTriggered: 0 -> 1
---
event: !attached {program_id: 2, process_id: 1002}
state:
  currently_loading: <nil>
  queued_programs: '[]'
  processes:
    1001: Detaching (prog 1)
    1002: Attaching (prog 2) -> Attached (prog 2)
  programs:
    1: Draining (proc 1001)
    2: Loaded (proc 1002)
  stats:
    attached: 1 -> 2
    numAttached: 0 -> 1
    numAttaching: 1 -> 0
---
event: !processes-updated
  updated:
    - process_id: {pid: 1003}
      executable: {path: /usr/bin/app-a}
      service: svc-a
      probes:
        - {type: LOG_PROBE, id: probe1, where: {methodName: main}, captureSnapshot: true}
effects:
  - !spawn-bpf-loading {additional_types: [MyStruct], executable: /usr/bin/app-a@0.0m0.0, probes: [probe1], process_id: 1003, program_id: 3}
state:
  currently_loading: <nil> -> 3
  queued_programs: '[]'
  processes:
    1001: Detaching (prog 1)
    1002: Attached (prog 2)
    1003: <nil> -> WaitingForProgram (prog 3)
  programs:
    1: Draining (proc 1001)
    2: Loaded (proc 1002)
    3: <nil> -> Loading (proc 1003)
  stats:
    numProcesses: 2 -> 3
    numPrograms: 2 -> 3
    numWaitingForProgram: 0 -> 1
---
event: !detached {program_id: 1, process_id: 1001}
effects:
  - !unload-program {program_id: 1}
state:
  currently_loading: "3"
  queued_programs: '[]'
  processes:
    1001: Detaching (prog 1)
    1002: Attached (prog 2)
    1003: WaitingForProgram (prog 3)
  programs:
    1: Draining (proc 1001) -> Unloading (proc 1001)
    2: Loaded (proc 1002)
    3: Loading (proc 1003)
  stats:
    detached: 0 -> 1
---
event: !unloaded {program_id: 1}
state:
  currently_loading: "3"
  queued_programs: '[] -> [4]'
  processes:
    1001: Detaching (prog 1) -> WaitingForProgram (prog 4)
    1002: Attached (prog 2)
    1003: WaitingForProgram (prog 3)
  programs:
    1: Unloading (proc 1001) -> <nil>
    2: Loaded (proc 1002)
    3: Loading (proc 1003)
    4: <nil> -> Queued (proc 1001)
  stats:
    numDetaching: 1 -> 0
    numWaitingForProgram: 1 -> 2
    unloaded: 0 -> 1
---
event: !loaded {program_id: 3}
effects:
  - !attach-to-process {executable: /usr/bin/app-a@0.0m0.0, process_id: 1003, program_id: 3}
  - !spawn-bpf-loading {additional_types: [MyStruct], executable: /usr/bin/app-a@0.0m0.0, probes: [probe1], process_id: 1001, program_id: 4}
state:
  currently_loading: 3 -> 4
  queued_programs: '[4] -> []'
  processes:
    1001: WaitingForProgram (prog 4)
    1002: Attached (prog 2)
    1003: WaitingForProgram (prog 3) -> Attaching (prog 3)
  programs:
    2: Loaded (proc 1002)
    3: Loading (proc 1003) -> Loaded (proc 1003)
    4: Queued (proc 1001) -> Loading (proc 1001)
  stats:
    loaded: 2 -> 3
    numAttaching: 0 -> 1
    numWaitingForProgram: 2 -> 1
---
event: !attached {program_id: 3, process_id: 1003}
state:
  currently_loading: "4"
  queued_programs: '[]'
  processes:
    1001: WaitingForProgram (prog 4)
    1002: Attached (prog 2)
    1003: Attaching (prog 3) -> Attached (prog 3)
  programs:
    2: Loaded (proc 1002)
    3: Loaded (proc 1003)
    4: Loading (proc 1001)
  stats:
    attached: 2 -> 3
    numAttached: 1 -> 2
    numAttaching: 1 -> 0
---
event: !loaded {program_id: 4}
effects:
  - !attach-to-process {executable: /usr/bin/app-a@0.0m0.0, process_id: 1001, program_id: 4}
state:
  currently_loading: 4 -> <nil>
  queued_programs: '[]'
  processes:
    1001: WaitingForProgram (prog 4) -> Attaching (prog 4)
    1002: Attached (prog 2)
    1003: Attached (prog 3)
  programs:
    2: Loaded (proc 1002)
    3: Loaded (proc 1003)
    4: Loading (proc 1001) -> Loaded (proc 1001)
  stats:
    loaded: 3 -> 4
    numAttaching: 0 -> 1
    numWaitingForProgram: 1 -> 0
---
event: !attached {program_id: 4, process_id: 1001}
state:
  currently_loading: <nil>
  queued_programs: '[]'
  processes:
    1001: Attaching (prog 4) -> Attached (prog 4)
    1002: Attached (prog 2)
    1003: Attached (prog 3)
  programs:
    2: Loaded (proc 1002)
    3: Loaded (proc 1003)
    4: Loaded (proc 1001)
  stats:
    attached: 3 -> 4
    numAttached: 2 -> 3
    numAttaching: 1 -> 0
