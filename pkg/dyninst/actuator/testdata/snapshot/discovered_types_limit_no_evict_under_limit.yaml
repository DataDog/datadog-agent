# Tests that orphaned discovered types are preserved when the total stays
# under the configured limit.
#
# Flow:
# 1. Configure limit of 10
# 2. Process for svc-a gets 3 types, then is removed
# 3. Types remain orphaned because total (3) is under limit (10)
- !config {discovered_types_limit: 10}
- !processes-updated
  updated:
    - process_id: {pid: 1001}
      executable: {path: /usr/bin/app-a}
      service: svc-a
      probes:
        - {type: LOG_PROBE, id: probe1, where: {methodName: main}, captureSnapshot: true}
- !loaded {program_id: 1}
- !attached {program_id: 1, process_id: 1001}
- !missing-types-reported {process_id: 1001, type_names: [TypeA, TypeB, TypeC]}
- !detached {program_id: 1, process_id: 1001}
- !unloaded {program_id: 1}
- !loaded {program_id: 2}
- !attached {program_id: 2, process_id: 1001}
# Remove process; types stay because total (3) < limit (10)
- !processes-updated
  removed: [1001]
- !detached {program_id: 2, process_id: 1001}
- !unloaded {program_id: 2}
---
event: !processes-updated
  updated:
    - process_id: {pid: 1001}
      executable: {path: /usr/bin/app-a}
      service: svc-a
      probes:
        - {type: LOG_PROBE, id: probe1, where: {methodName: main}, captureSnapshot: true}
effects:
  - !spawn-bpf-loading {executable: /usr/bin/app-a@0.0m0.0, probes: [probe1], process_id: 1001, program_id: 1}
state:
  currently_loading: <nil> -> 1
  queued_programs: '[]'
  processes:
    1001: <nil> -> WaitingForProgram (prog 1)
  programs:
    1: <nil> -> Loading (proc 1001)
  stats:
    numProcesses: 0 -> 1
    numPrograms: 0 -> 1
    numWaitingForProgram: 0 -> 1
---
event: !loaded {program_id: 1}
effects:
  - !attach-to-process {executable: /usr/bin/app-a@0.0m0.0, process_id: 1001, program_id: 1}
state:
  currently_loading: 1 -> <nil>
  queued_programs: '[]'
  processes:
    1001: WaitingForProgram (prog 1) -> Attaching (prog 1)
  programs:
    1: Loading (proc 1001) -> Loaded (proc 1001)
  stats:
    loaded: 0 -> 1
    numAttaching: 0 -> 1
    numWaitingForProgram: 1 -> 0
---
event: !attached {program_id: 1, process_id: 1001}
state:
  currently_loading: <nil>
  queued_programs: '[]'
  processes:
    1001: Attaching (prog 1) -> Attached (prog 1)
  programs:
    1: Loaded (proc 1001)
  stats:
    attached: 0 -> 1
    numAttached: 0 -> 1
    numAttaching: 1 -> 0
---
event: !missing-types-reported {process_id: 1001, type_names: [TypeA, TypeB, TypeC]}
effects:
  - !detach-from-process {failure: "no", process_id: 1001, program_id: 1}
state:
  currently_loading: <nil>
  queued_programs: '[]'
  processes:
    1001: Attached (prog 1) -> Detaching (prog 1)
  programs:
    1: Loaded (proc 1001) -> Draining (proc 1001)
  discovered_types:
    svc-a: '[] -> [TypeA TypeB TypeC]'
  stats:
    numAttached: 1 -> 0
    numDetaching: 0 -> 1
    typeRecompilationsTriggered: 0 -> 1
---
event: !detached {program_id: 1, process_id: 1001}
effects:
  - !unload-program {program_id: 1}
state:
  currently_loading: <nil>
  queued_programs: '[]'
  processes:
    1001: Detaching (prog 1)
  programs:
    1: Draining (proc 1001) -> Unloading (proc 1001)
  stats:
    detached: 0 -> 1
---
event: !unloaded {program_id: 1}
effects:
  - !spawn-bpf-loading {additional_types: [TypeA, TypeB, TypeC], executable: /usr/bin/app-a@0.0m0.0, probes: [probe1], process_id: 1001, program_id: 2}
state:
  currently_loading: <nil> -> 2
  queued_programs: '[]'
  processes:
    1001: Detaching (prog 1) -> WaitingForProgram (prog 2)
  programs:
    1: Unloading (proc 1001) -> <nil>
    2: <nil> -> Loading (proc 1001)
  stats:
    numDetaching: 1 -> 0
    numWaitingForProgram: 0 -> 1
    unloaded: 0 -> 1
---
event: !loaded {program_id: 2}
effects:
  - !attach-to-process {executable: /usr/bin/app-a@0.0m0.0, process_id: 1001, program_id: 2}
state:
  currently_loading: 2 -> <nil>
  queued_programs: '[]'
  processes:
    1001: WaitingForProgram (prog 2) -> Attaching (prog 2)
  programs:
    2: Loading (proc 1001) -> Loaded (proc 1001)
  stats:
    loaded: 1 -> 2
    numAttaching: 0 -> 1
    numWaitingForProgram: 1 -> 0
---
event: !attached {program_id: 2, process_id: 1001}
state:
  currently_loading: <nil>
  queued_programs: '[]'
  processes:
    1001: Attaching (prog 2) -> Attached (prog 2)
  programs:
    2: Loaded (proc 1001)
  stats:
    attached: 1 -> 2
    numAttached: 0 -> 1
    numAttaching: 1 -> 0
---
event: !processes-updated
  removed: [1001]
effects:
  - !detach-from-process {failure: "no", process_id: 1001, program_id: 2}
state:
  currently_loading: <nil>
  queued_programs: '[]'
  processes:
    1001: Attached (prog 2) -> Detaching (prog 2)
  programs:
    2: Loaded (proc 1001) -> Draining (proc 1001)
  stats:
    numAttached: 1 -> 0
    numDetaching: 0 -> 1
---
event: !detached {program_id: 2, process_id: 1001}
effects:
  - !unload-program {program_id: 2}
state:
  currently_loading: <nil>
  queued_programs: '[]'
  processes:
    1001: Detaching (prog 2)
  programs:
    2: Draining (proc 1001) -> Unloading (proc 1001)
  stats:
    detached: 1 -> 2
---
event: !unloaded {program_id: 2}
state:
  currently_loading: <nil>
  queued_programs: '[]'
  processes:
    1001: Detaching (prog 2) -> <nil>
  programs:
    2: Unloading (proc 1001) -> <nil>
  stats:
    numDetaching: 1 -> 0
    numProcesses: 1 -> 0
    numPrograms: 1 -> 0
    unloaded: 1 -> 2
---
