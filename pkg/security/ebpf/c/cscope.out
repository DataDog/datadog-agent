cscope 15 $HOME/go/src/github.com/DataDog/datadog-agent/pkg/security/ebpf/c               0000203668
	@approvers.h

1 #i‚de‡
_APPROVERS_H


2 
	#_APPROVERS_H


	)

4 
	~"sysˇŒs.h
"

6 
	#BASENAME_FILTER_SIZE
 256

	)

8 
	sba£«me_t
 {

9 
	mvÆue
[
BASENAME_FILTER_SIZE
];

12 
	sba£«me_fûãr_t
 {

13 
u64
 
	mevít_mask
;

16 
bpf_m≠_def
 
SEC
("m≠s/ba£«me_≠¥ovîs"Ë
	gba£«me_≠¥ovîs
 = {

17 .
ty≥
 = 
BPF_MAP_TYPE_HASH
,

18 .
	gkey_size
 = 
BASENAME_FILTER_SIZE
,

19 .
	gvÆue_size
 = (
ba£«me_fûãr_t
),

20 .
	gmax_íåõs
 = 255,

21 .
	gpönög
 = 0,

22 .
	g«me•a˚
 = "",

25 
gë_díåy_«me
(
díåy
 *díåy, *
buf„r
, 
size_t
 
n
);

27 
__©åibuã__
((
Æways_ölöe
)Ë
	$≠¥ove_by_ba£«me
(
díåy
 *díåy, 
u64
 
evít_ty≥
) {

28 
ba£«me_t
 
ba£«me
 = {};

29 
	`gë_díåy_«me
(
díåy
, &
ba£«me
, (basename));

31 
ba£«me_fûãr_t
 *
fûãr
 = 
	`bpf_m≠_lookup_ñem
(&
ba£«me_≠¥ovîs
, &
ba£«me
);

32 i‡(
fûãr
 && fûãr->
evít_mask
 & (1 << (
evít_ty≥
-1))) {

36 
	}
}

38 
__©åibuã__
((
Æways_ölöe
)Ë
	$ba£«me_≠¥ovî
(
sysˇŒ_ˇche_t
 *
sysˇŒ
, 
díåy
 *díåy, 
u64
 
evít_ty≥
) {

39 i‡((
sysˇŒ
->
pﬁicy
.
Êags
 & 
BASENAME
) > 0) {

40  
	`≠¥ove_by_ba£«me
(
díåy
, 
evít_ty≥
);

43 
	}
}

	@bpf.h

1 #i‚de‡
_BPF_MONITORING_H_


2 
	#_BPF_MONITORING_H_


	)

4 
	#CHECK_HELPER_CALL_FUNC_ID
 1

	)

5 
	#CHECK_HELPER_CALL_INSN
 2

	)

7 
u64
 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_check_hñ≥r_ˇŒ_öput
() {

8 
u64
 
öput
;

9 
	`LOAD_CONSTANT
("check_hñ≥r_ˇŒ_öput", 
öput
);

10  
öput
;

11 
	}
}

13 
	sbpf_m≠_t
 {

14 
u32
 
	mid
;

15 
bpf_m≠_ty≥
 
	mm≠_ty≥
;

16 
	m«me
[
BPF_OBJ_NAME_LEN
];

19 
	sbpf_¥og_t
 {

20 
u32
 
	mid
;

21 
bpf_¥og_ty≥
 
	m¥og_ty≥
;

22 
bpf_©èch_ty≥
 
	m©èch_ty≥
;

23 
u32
 
	m∑ddög
;

24 
u64
 
	mhñ≥rs
[3];

25 
	m«me
[
BPF_OBJ_NAME_LEN
];

28 
	sbpf_tgid_fd_t
 {

29 
u32
 
	mtgid
;

30 
u32
 
	mfd
;

33 
	sbpf_evít_t
 {

34 
kevít_t
 
	mevít
;

35 
¥o˚ss_c⁄ãxt_t
 
	m¥o˚ss
;

36 
•™_c⁄ãxt_t
 
	m•™
;

37 
c⁄èöî_c⁄ãxt_t
 
	mc⁄èöî
;

38 
sysˇŒ_t
 
	msysˇŒ
;

40 
bpf_m≠_t
 
	mm≠
;

41 
bpf_¥og_t
 
	m¥og
;

42 
	mcmd
;

43 
u32
 
	m∑ddög
;

46 
bpf_m≠_def
 
SEC
("m≠s/bpf_m≠s"Ë
	gbpf_m≠s
 = {

47 .
ty≥
 = 
BPF_MAP_TYPE_LRU_HASH
,

48 .
	gkey_size
 = (
u32
),

49 .
	gvÆue_size
 = (
bpf_m≠_t
),

50 .
	gmax_íåõs
 = 4096,

51 .
	gpönög
 = 0,

52 .
	g«me•a˚
 = "",

55 
bpf_m≠_def
 
SEC
("m≠s/bpf_¥ogs"Ë
	gbpf_¥ogs
 = {

56 .
ty≥
 = 
BPF_MAP_TYPE_LRU_HASH
,

57 .
	gkey_size
 = (
u32
),

58 .
	gvÆue_size
 = (
bpf_¥og_t
),

59 .
	gmax_íåõs
 = 4096,

60 .
	gpönög
 = 0,

61 .
	g«me•a˚
 = "",

64 
bpf_m≠_def
 
SEC
("m≠s/tgid_fd_m≠_id"Ë
	gtgid_fd_m≠_id
 = {

65 .
ty≥
 = 
BPF_MAP_TYPE_LRU_HASH
,

66 .
	gkey_size
 = (
bpf_tgid_fd_t
),

67 .
	gvÆue_size
 = (
u32
),

68 .
	gmax_íåõs
 = 4096,

69 .
	gpönög
 = 0,

70 .
	g«me•a˚
 = "",

73 
bpf_m≠_def
 
SEC
("m≠s/tgid_fd_¥og_id"Ë
	gtgid_fd_¥og_id
 = {

74 .
ty≥
 = 
BPF_MAP_TYPE_LRU_HASH
,

75 .
	gkey_size
 = (
bpf_tgid_fd_t
),

76 .
	gvÆue_size
 = (
u32
),

77 .
	gmax_íåõs
 = 4096,

78 .
	gpönög
 = 0,

79 .
	g«me•a˚
 = "",

82 
__©åibuã__
((
Æways_ölöe
)Ë
	$ßve_obj_fd
(
sysˇŒ_ˇche_t
 *
sysˇŒ
) {

83 
bpf_tgid_fd_t
 
key
 = {

84 .
tgid
 = 
	`bpf_gë_cuºít_pid_tgid
() >> 32,

85 .
fd
 = 
sysˇŒ
->
bpf
.
ªtvÆ
,

88 
u32
 
id
 = 0;

90 
sysˇŒ
->
bpf
.
cmd
) {

91 
BPF_MAP_CREATE
:

92 
BPF_MAP_GET_FD_BY_ID
:

93 
id
 = 
sysˇŒ
->
bpf
.
m≠_id
;

94 
	`bpf_m≠_upd©e_ñem
(&
tgid_fd_m≠_id
, &
key
, &
id
, 
BPF_ANY
);

96 
BPF_PROG_LOAD
:

97 
BPF_PROG_GET_FD_BY_ID
:

98 
id
 = 
sysˇŒ
->
bpf
.
¥og_id
;

99 
	`bpf_m≠_upd©e_ñem
(&
tgid_fd_¥og_id
, &
key
, &
id
, 
BPF_ANY
);

102 
	}
}

104 
__©åibuã__
((
Æways_ölöe
)Ë
u32
 
	$„tch_m≠_id
(
fd
) {

105 
bpf_tgid_fd_t
 
key
 = {

106 .
tgid
 = 
	`bpf_gë_cuºít_pid_tgid
() >> 32,

107 .
fd
 = fd,

110 
u32
 *
m≠_id
 = 
	`bpf_m≠_lookup_ñem
(&
tgid_fd_m≠_id
, &
key
);

111 i‡(
m≠_id
 =
NULL
) {

114  *
m≠_id
;

115 
	}
}

117 
__©åibuã__
((
Æways_ölöe
)Ë
u32
 
	$„tch_¥og_id
(
fd
) {

118 
bpf_tgid_fd_t
 
key
 = {

119 .
tgid
 = 
	`bpf_gë_cuºít_pid_tgid
() >> 32,

120 .
fd
 = fd,

123 
u32
 *
m≠_id
 = 
	`bpf_m≠_lookup_ñem
(&
tgid_fd_¥og_id
, &
key
);

124 i‡(
m≠_id
 =
NULL
) {

127  *
m≠_id
;

128 
	}
}

130 
__©åibuã__
((
Æways_ölöe
)Ë
	$p›uœã_m≠_id_™d_¥og_id
(
sysˇŒ_ˇche_t
 *
sysˇŒ
) {

131 
fd
 = 0;

133 
sysˇŒ
->
bpf
.
cmd
) {

134 
BPF_MAP_LOOKUP_ELEM_CMD
:

135 
BPF_MAP_UPDATE_ELEM_CMD
:

136 
BPF_MAP_DELETE_ELEM_CMD
:

137 
BPF_MAP_LOOKUP_AND_DELETE_ELEM_CMD
:

138 
BPF_MAP_GET_NEXT_KEY_CMD
:

139 
BPF_MAP_FREEZE_CMD
:

140 
	`bpf_¥obe_ªad
(&
fd
, (fd), &
sysˇŒ
->
bpf
.
©å
->
m≠_fd
);

141 
sysˇŒ
->
bpf
.
m≠_id
 = 
	`„tch_m≠_id
(
fd
);

143 
BPF_PROG_ATTACH_CMD
:

144 
	`bpf_¥obe_ªad
(&
fd
, (fd), &
sysˇŒ
->
bpf
.
©å
->
©èch_bpf_fd
);

145 
sysˇŒ
->
bpf
.
¥og_id
 = 
	`„tch_¥og_id
(
fd
);

147 
BPF_PROG_DETACH_CMD
:

148 
	`bpf_¥obe_ªad
(&
fd
, (fd), &
sysˇŒ
->
bpf
.
©å
->
èrgë_fd
);

149 
sysˇŒ
->
bpf
.
¥og_id
 = 
	`„tch_¥og_id
(
fd
);

151 
BPF_PROG_QUERY_CMD
:

152 
	`bpf_¥obe_ªad
(&
fd
, (fd), &
sysˇŒ
->
bpf
.
©å
->
quîy
.
èrgë_fd
);

153 
sysˇŒ
->
bpf
.
¥og_id
 = 
	`„tch_¥og_id
(
fd
);

155 
BPF_PROG_TEST_RUN_CMD
:

156 
	`bpf_¥obe_ªad
(&
fd
, (fd), &
sysˇŒ
->
bpf
.
©å
->
ã°
.
¥og_fd
);

157 
sysˇŒ
->
bpf
.
¥og_id
 = 
	`„tch_¥og_id
(
fd
);

159 
BPF_PROG_GET_NEXT_ID_CMD
:

160 
	`bpf_¥obe_ªad
(&
sysˇŒ
->
bpf
.
¥og_id
, (sysˇŒ->bpf.¥og_id), &sysˇŒ->bpf.
©å
->
°¨t_id
);

162 
BPF_MAP_GET_NEXT_ID_CMD
:

163 
	`bpf_¥obe_ªad
(&
sysˇŒ
->
bpf
.
m≠_id
, (sysˇŒ->bpf.
¥og_id
), &sysˇŒ->bpf.
©å
->
°¨t_id
);

165 
BPF_OBJ_GET_INFO_BY_FD_CMD
:

166 
	`bpf_¥obe_ªad
(&
fd
, (fd), &
sysˇŒ
->
bpf
.
©å
->
öfo
.
bpf_fd
);

167 
sysˇŒ
->
bpf
.
m≠_id
 = 
	`„tch_m≠_id
(
fd
);

168 
sysˇŒ
->
bpf
.
¥og_id
 = 
	`„tch_¥og_id
(
fd
);

170 
BPF_OBJ_PIN_CMD
:

171 
	`bpf_¥obe_ªad
(&
fd
, (fd), &
sysˇŒ
->
bpf
.
©å
->
bpf_fd
);

172 
sysˇŒ
->
bpf
.
m≠_id
 = 
	`„tch_m≠_id
(
fd
);

173 
sysˇŒ
->
bpf
.
¥og_id
 = 
	`„tch_¥og_id
(
fd
);

175 
BPF_RAW_TRACEPOINT_OPEN_CMD
:

176 
	`bpf_¥obe_ªad
(&
fd
, (fd), &
sysˇŒ
->
bpf
.
©å
->
øw_åa˚poöt
.
¥og_fd
);

177 
sysˇŒ
->
bpf
.
¥og_id
 = 
	`„tch_¥og_id
(
fd
);

179 
BPF_TASK_FD_QUERY_CMD
:

180 
	`bpf_¥obe_ªad
(&
fd
, (fd), &
sysˇŒ
->
bpf
.
©å
->
èsk_fd_quîy
.fd);

181 
sysˇŒ
->
bpf
.
¥og_id
 = 
	`„tch_¥og_id
(
fd
);

183 
BPF_MAP_LOOKUP_BATCH_CMD
:

184 
BPF_MAP_LOOKUP_AND_DELETE_BATCH_CMD
:

185 
BPF_MAP_UPDATE_BATCH_CMD
:

186 
BPF_MAP_DELETE_BATCH_CMD
:

187 
	`bpf_¥obe_ªad
(&
fd
, (fd), &
sysˇŒ
->
bpf
.
©å
->
b©ch
.
m≠_fd
);

188 
sysˇŒ
->
bpf
.
m≠_id
 = 
	`„tch_m≠_id
(
fd
);

190 
BPF_LINK_CREATE_CMD
:

191 
	`bpf_¥obe_ªad
(&
fd
, (fd), &
sysˇŒ
->
bpf
.
©å
->
lök_¸óã
.
¥og_fd
);

192 
sysˇŒ
->
bpf
.
¥og_id
 = 
	`„tch_¥og_id
(
fd
);

194 
BPF_LINK_UPDATE_CMD
:

195 
	`bpf_¥obe_ªad
(&
fd
, (fd), &
sysˇŒ
->
bpf
.
©å
->
lök_upd©e
.
ﬁd_¥og_fd
);

196 
sysˇŒ
->
bpf
.
¥og_id
 = 
	`„tch_¥og_id
(
fd
);

198 
BPF_PROG_BIND_MAP_CMD
:

199 
	`bpf_¥obe_ªad
(&
fd
, (fd), &
sysˇŒ
->
bpf
.
©å
->
¥og_böd_m≠
.
m≠_fd
);

200 
sysˇŒ
->
bpf
.
m≠_id
 = 
	`„tch_m≠_id
(
fd
);

201 
	`bpf_¥obe_ªad
(&
fd
, (fd), &
sysˇŒ
->
bpf
.
©å
->
¥og_böd_m≠
.
¥og_fd
);

202 
sysˇŒ
->
bpf
.
¥og_id
 = 
	`„tch_¥og_id
(
fd
);

205 
	}
}

207 
__©åibuã__
((
Æways_ölöe
)Ë
	$fûl_‰om_sysˇŒ_¨gs
(
sysˇŒ_ˇche_t
 *
sysˇŒ
, 
bpf_evít_t
 *
evít
) {

208 
evít
->
cmd
) {

209 
BPF_MAP_CREATE
:

210 
	`bpf_¥obe_ªad
(&
evít
->
m≠
.
m≠_ty≥
, ”vít->m≠.m≠_ty≥), &
sysˇŒ
->
bpf
.
©å
->map_type);

211 
	`bpf_¥obe_ªad
(&
evít
->
m≠
.
«me
, ”vít->m≠.«me), &
sysˇŒ
->
bpf
.
©å
->
m≠_«me
);

213 
BPF_PROG_LOAD
:

214 
	`bpf_¥obe_ªad
(&
evít
->
¥og
.
¥og_ty≥
, ”vít->¥og.¥og_ty≥), &
sysˇŒ
->
bpf
.
©å
->prog_type);

215 
	`bpf_¥obe_ªad
(&
evít
->
¥og
.
«me
, ”vít->¥og.«me), &
sysˇŒ
->
bpf
.
©å
->
¥og_«me
);

216 
	`bpf_¥obe_ªad
(&
evít
->
¥og
.
©èch_ty≥
, ”vít->¥og.©èch_ty≥), &
sysˇŒ
->
bpf
.
©å
->
ex≥˘ed_©èch_ty≥
);

219 
	}
}

221 
__©åibuã__
((
Æways_ölöe
)Ë
	$£nd_bpf_evít
(*
˘x
, 
sysˇŒ_ˇche_t
 *
sysˇŒ
) {

222 
bpf_evít_t
 
evít
 = {

223 .
sysˇŒ
.
ªtvÆ
 = sysˇŒ->
bpf
.retval,

224 .
cmd
 = 
sysˇŒ
->
bpf
.cmd,

227 
¥oc_ˇche_t
 *
íåy
 = 
	`fûl_¥o˚ss_c⁄ãxt
(&
evít
.
¥o˚ss
);

228 
	`fûl_c⁄èöî_c⁄ãxt
(
íåy
, &
evít
.
c⁄èöî
);

229 
	`fûl_•™_c⁄ãxt
(&
evít
.
•™
);

231 
u32
 
id
 = 0;

234 i‡(
sysˇŒ
->
bpf
.
m≠_id
 != 0) {

235 
id
 = 
sysˇŒ
->
bpf
.
m≠_id
;

236 
bpf_m≠_t
 *
m≠
 = 
	`bpf_m≠_lookup_ñem
(&
bpf_m≠s
, &
id
);

237 i‡(
m≠
 !
NULL
) {

238 
evít
.
m≠
 = *map;

243 i‡(
sysˇŒ
->
bpf
.
¥og_id
 != 0) {

244 
id
 = 
sysˇŒ
->
bpf
.
¥og_id
;

245 
bpf_¥og_t
 *
¥og
 = 
	`bpf_m≠_lookup_ñem
(&
bpf_¥ogs
, &
id
);

246 i‡(
¥og
 !
NULL
) {

247 
evít
.
¥og
 = *prog;

251 i‡(
evít
.
m≠
.
id
 =0 &&Évít.
¥og
.id == 0) {

253 
	`fûl_‰om_sysˇŒ_¨gs
(
sysˇŒ
, &
evít
);

257 
	`£nd_evít
(
˘x
, 
EVENT_BPF
, 
evít
);

259 
	}
}

261 
	$SYSCALL_KPROBE3
(
bpf
, , 
cmd
, 
bpf_©å
 
__u£r
 *, 
u©å
, , 
size
) {

262 
pﬁicy_t
 
pﬁicy
 = 
	`„tch_pﬁicy
(
EVENT_BPF
);

263 i‡(
	`is_disˇrded_by_¥o˚ss
(
pﬁicy
.
mode
, 
EVENT_BPF
)) {

267 
sysˇŒ_ˇche_t
 
sysˇŒ
 = {

268 .
ty≥
 = 
EVENT_BPF
,

269 .
bpf
 = {

270 .
cmd
 = cmd,

273 
	`bpf_¥obe_ªad
(&
sysˇŒ
.
bpf
.
©å
, (sysˇŒ.bpf.©å), &
u©å
);

275 
	`ˇche_sysˇŒ
(&
sysˇŒ
);

278 
	}
}

280 
__©åibuã__
((
Æways_ölöe
)Ë
	$sys_bpf_ªt
(*
˘x
, 
ªtvÆ
) {

281 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`p›_sysˇŒ
(
EVENT_BPF
);

282 i‡(!
sysˇŒ
)

285 
sysˇŒ
->
bpf
.
ªtvÆ
 =Ñetval;

288 i‡(
sysˇŒ
->
bpf
.
m≠_id
 !0 || sysˇŒ->bpf.
¥og_id
 != 0) {

289 
	`ßve_obj_fd
(
sysˇŒ
);

293 
	`p›uœã_m≠_id_™d_¥og_id
(
sysˇŒ
);

296 
	`£nd_bpf_evít
(
˘x
, 
sysˇŒ
);

298 
	}
}

300 
	$SYSCALL_KRETPROBE
(
bpf
) {

301  
	`sys_bpf_ªt
(
˘x
, ()
	`PT_REGS_RC
(ctx));

302 
	}
}

304 
SEC
("tracepoint/syscalls/sys_exit_bpf")

305 
	$åa˚poöt_sysˇŒs_sys_exô_bpf
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

306  
	`sys_bpf_ªt
(
¨gs
,árgs->
ªt
);

307 
	}
}

309 
SEC
("kprobe/security_bpf_map")

310 
	$k¥obe_£curôy_bpf_m≠
(
±_ªgs
 *
˘x
) {

311 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
EVENT_BPF
);

312 i‡(!
sysˇŒ
)

315 
bpf_m≠
 *
m≠
 = (bpf_m≠ *)
	`PT_REGS_PARM1
(
˘x
);

318 
bpf_m≠_t
 
m
 = {};

319 
	`bpf_¥obe_ªad
(&
m
.
id
, (m.id), &
m≠
->id);

320 
	`bpf_¥obe_ªad
(&
m
.
«me
, (m.«me), &
m≠
->name);

321 
	`bpf_¥obe_ªad
(&
m
.
m≠_ty≥
, (m.m≠_ty≥), &
m≠
->map_type);

324 
	`bpf_m≠_upd©e_ñem
(&
bpf_m≠s
, &
m
.
id
, &m, 
BPF_ANY
);

327 
sysˇŒ
->
bpf
.
m≠_id
 = 
m
.
id
;

329 
	}
}

331 
SEC
("kprobe/security_bpf_prog")

332 
	$k¥obe_£curôy_bpf_¥og
(
±_ªgs
 *
˘x
) {

333 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
EVENT_BPF
);

334 i‡(!
sysˇŒ
)

337 
bpf_¥og
 *
¥og
 = (bpf_¥og *)
	`PT_REGS_PARM1
(
˘x
);

338 
bpf_¥og_aux
 *
¥og_aux
 = 0;

339 
	`bpf_¥obe_ªad
(&
¥og_aux
, ’rog_aux), &
¥og
->
aux
);

342 
bpf_¥og_t
 
p
 = {};

343 
	`bpf_¥obe_ªad
(&
p
.
id
, ’.id), &
¥og_aux
->id);

344 
	`bpf_¥obe_ªad
(&
p
.
¥og_ty≥
, ’.¥og_ty≥), &
¥og
->
ty≥
);

345 
	`bpf_¥obe_ªad
(&
p
.
©èch_ty≥
, ’.©èch_ty≥), &
¥og
->
ex≥˘ed_©èch_ty≥
);

346 
	`bpf_¥obe_ªad
(&
p
.
«me
, ’.«me), &
¥og_aux
->name);

349 
sysˇŒ
->
bpf
.
¥og_id
 = 
p
.
id
;

352 
p
.
hñ≥rs
[0] = 
sysˇŒ
->
bpf
.helpers[0];

353 
p
.
hñ≥rs
[1] = 
sysˇŒ
->
bpf
.helpers[1];

354 
p
.
hñ≥rs
[2] = 
sysˇŒ
->
bpf
.helpers[2];

357 
	`bpf_m≠_upd©e_ñem
(&
bpf_¥ogs
, &
p
.
id
, &p, 
BPF_ANY
);

359 
	}
}

361 
SEC
("kprobe/check_helper_call")

362 
	$k¥obe_check_hñ≥r_ˇŒ
(
±_ªgs
 *
˘x
) {

363 
func_id
 = 0;

364 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
EVENT_BPF
);

365 i‡(!
sysˇŒ
)

368 
u64
 
öput
 = 
	`gë_check_hñ≥r_ˇŒ_öput
();

369 i‡(
öput
 =
CHECK_HELPER_CALL_FUNC_ID
) {

370 
func_id
 = ()
	`PT_REGS_PARM2
(
˘x
);

371 } i‡(
öput
 =
CHECK_HELPER_CALL_INSN
) {

372 
bpf_ö¢
 *
ö¢
 = (bpf_ö¢ *)
	`PT_REGS_PARM2
(
˘x
);

373 
	`bpf_¥obe_ªad
(&
func_id
, (func_id), &
ö¢
->
imm
);

376 i‡(
func_id
 >= 128) {

377 
sysˇŒ
->
bpf
.
hñ≥rs
[2] |(
u64
Ë1 << (
func_id
 - 128);

378 } i‡(
func_id
 >= 64) {

379 
sysˇŒ
->
bpf
.
hñ≥rs
[1] |(
u64
Ë1 << (
func_id
 - 64);

380 } i‡(
func_id
 >= 0) {

381 
sysˇŒ
->
bpf
.
hñ≥rs
[0] |(
u64
Ë1 << (
func_id
);

384 
	}
}

	@bpf_const.h

1 #i‚de‡
_BPF_CONST_H_


2 
	#_BPF_CONST_H_


	)

4 
	ebpf_cmd_def
 {

5 
	mBPF_MAP_CREATE_CMD
,

6 
	mBPF_MAP_LOOKUP_ELEM_CMD
,

7 
	mBPF_MAP_UPDATE_ELEM_CMD
,

8 
	mBPF_MAP_DELETE_ELEM_CMD
,

9 
	mBPF_MAP_GET_NEXT_KEY_CMD
,

10 
	mBPF_PROG_LOAD_CMD
,

11 
	mBPF_OBJ_PIN_CMD
,

12 
	mBPF_OBJ_GET_CMD
,

13 
	mBPF_PROG_ATTACH_CMD
,

14 
	mBPF_PROG_DETACH_CMD
,

15 
	mBPF_PROG_TEST_RUN_CMD
,

16 
	mBPF_PROG_GET_NEXT_ID_CMD
,

17 
	mBPF_MAP_GET_NEXT_ID_CMD
,

18 
	mBPF_PROG_GET_FD_BY_ID_CMD
,

19 
	mBPF_MAP_GET_FD_BY_ID_CMD
,

20 
	mBPF_OBJ_GET_INFO_BY_FD_CMD
,

21 
	mBPF_PROG_QUERY_CMD
,

22 
	mBPF_RAW_TRACEPOINT_OPEN_CMD
,

23 
	mBPF_BTF_LOAD_CMD
,

24 
	mBPF_BTF_GET_FD_BY_ID_CMD
,

25 
	mBPF_TASK_FD_QUERY_CMD
,

26 
	mBPF_MAP_LOOKUP_AND_DELETE_ELEM_CMD
,

27 
	mBPF_MAP_FREEZE_CMD
,

28 
	mBPF_BTF_GET_NEXT_ID_CMD
,

29 
	mBPF_MAP_LOOKUP_BATCH_CMD
,

30 
	mBPF_MAP_LOOKUP_AND_DELETE_BATCH_CMD
,

31 
	mBPF_MAP_UPDATE_BATCH_CMD
,

32 
	mBPF_MAP_DELETE_BATCH_CMD
,

33 
	mBPF_LINK_CREATE_CMD
,

34 
	mBPF_LINK_UPDATE_CMD
,

35 
	mBPF_LINK_GET_FD_BY_ID_CMD
,

36 
	mBPF_LINK_GET_NEXT_ID_CMD
,

37 
	mBPF_ENABLE_STATS_CMD
,

38 
	mBPF_ITER_CREATE_CMD
,

39 
	mBPF_LINK_DETACH_CMD
,

40 
	mBPF_PROG_BIND_MAP_CMD
,

43 
	ubpf_©å_def
 {

45 
__u32
 
	mm≠_ty≥
;

46 
__u32
 
	mkey_size
;

47 
__u32
 
	mvÆue_size
;

48 
__u32
 
	mmax_íåõs
;

49 
__u32
 
	mm≠_Êags
;

52 
__u32
 
	mö√r_m≠_fd
;

53 
__u32
 
	mnuma_node
;

56 
	mm≠_«me
[
BPF_OBJ_NAME_LEN
];

57 
__u32
 
	mm≠_ifödex
;

58 
__u32
 
	mbtf_fd
;

59 
__u32
 
	mbtf_key_ty≥_id
;

60 
__u32
 
	mbtf_vÆue_ty≥_id
;

61 
__u32
 
	mbtf_vmlöux_vÆue_ty≥_id
;

68 
__u32
 
	mm≠_fd
;

69 
__Æig√d_u64
 
	mkey
;

71 
__Æig√d_u64
 
	mvÆue
;

72 
__Æig√d_u64
 
	m√xt_key
;

74 
__u64
 
	mÊags
;

78 
__Æig√d_u64
 
	mö_b©ch
;

81 
__Æig√d_u64
 
	mout_b©ch
;

82 
__Æig√d_u64
 
	mkeys
;

83 
__Æig√d_u64
 
	mvÆues
;

84 
__u32
 
	mcou¡
;

89 
__u32
 
	mm≠_fd
;

90 
__u64
 
	mñem_Êags
;

91 
__u64
 
	mÊags
;

92 } 
	mb©ch
;

95 
__u32
 
	m¥og_ty≥
;

96 
__u32
 
	mö¢_˙t
;

97 
__Æig√d_u64
 
	mö¢s
;

98 
__Æig√d_u64
 
	mli˚n£
;

99 
__u32
 
	mlog_Àvñ
;

100 
__u32
 
	mlog_size
;

101 
__Æig√d_u64
 
	mlog_buf
;

102 
__u32
 
	mkîn_vîsi⁄
;

103 
__u32
 
	m¥og_Êags
;

104 
	m¥og_«me
[
BPF_OBJ_NAME_LEN
];

105 
__u32
 
	m¥og_ifödex
;

110 
__u32
 
	mex≥˘ed_©èch_ty≥
;

111 
__u32
 
	m¥og_btf_fd
;

112 
__u32
 
	mfunc_öfo_ªc_size
;

113 
__Æig√d_u64
 
	mfunc_öfo
;

114 
__u32
 
	mfunc_öfo_˙t
;

115 
__u32
 
	mlöe_öfo_ªc_size
;

116 
__Æig√d_u64
 
	mlöe_öfo
;

117 
__u32
 
	mlöe_öfo_˙t
;

118 
__u32
 
	m©èch_btf_id
;

121 
__u32
 
	m©èch_¥og_fd
;

123 
__u32
 
	m©èch_btf_obj_fd
;

125 
	m__u32
 :32;

126 
__Æig√d_u64
 
	mfd_¨øy
;

130 
__Æig√d_u64
 
	m∑th«me
;

131 
__u32
 
	mbpf_fd
;

132 
__u32
 
	mfûe_Êags
;

136 
__u32
 
	mèrgë_fd
;

137 
__u32
 
	m©èch_bpf_fd
;

138 
__u32
 
	m©èch_ty≥
;

139 
__u32
 
	m©èch_Êags
;

140 
__u32
 
	mª∂a˚_bpf_fd
;

147 
__u32
 
	m¥og_fd
;

148 
__u32
 
	mªtvÆ
;

149 
__u32
 
	md©a_size_ö
;

150 
__u32
 
	md©a_size_out
;

154 
__Æig√d_u64
 
	md©a_ö
;

155 
__Æig√d_u64
 
	md©a_out
;

156 
__u32
 
	mª≥©
;

157 
__u32
 
	mduøti⁄
;

158 
__u32
 
	m˘x_size_ö
;

159 
__u32
 
	m˘x_size_out
;

163 
__Æig√d_u64
 
	m˘x_ö
;

164 
__Æig√d_u64
 
	m˘x_out
;

165 
__u32
 
	mÊags
;

166 
__u32
 
	m˝u
;

167 } 
	mã°
;

171 
__u32
 
	m°¨t_id
;

172 
__u32
 
	m¥og_id
;

173 
__u32
 
	mm≠_id
;

174 
__u32
 
	mbtf_id
;

175 
__u32
 
	mlök_id
;

177 
__u32
 
	m√xt_id
;

178 
__u32
 
	m›í_Êags
;

182 
__u32
 
	mbpf_fd
;

183 
__u32
 
	möfo_Àn
;

184 
__Æig√d_u64
 
	möfo
;

185 } 
	möfo
;

188 
__u32
 
	mèrgë_fd
;

189 
__u32
 
	m©èch_ty≥
;

190 
__u32
 
	mquîy_Êags
;

191 
__u32
 
	m©èch_Êags
;

192 
__Æig√d_u64
 
	m¥og_ids
;

193 
__u32
 
	m¥og_˙t
;

194 } 
	mquîy
;

197 
__u64
 
	m«me
;

198 
__u32
 
	m¥og_fd
;

199 } 
	møw_åa˚poöt
;

202 
__Æig√d_u64
 
	mbtf
;

203 
__Æig√d_u64
 
	mbtf_log_buf
;

204 
__u32
 
	mbtf_size
;

205 
__u32
 
	mbtf_log_size
;

206 
__u32
 
	mbtf_log_Àvñ
;

210 
__u32
 
	mpid
;

211 
__u32
 
	mfd
;

212 
__u32
 
	mÊags
;

213 
__u32
 
	mbuf_Àn
;

214 
__Æig√d_u64
 
	mbuf
;

219 
__u32
 
	m¥og_id
;

220 
__u32
 
	mfd_ty≥
;

221 
__u64
 
	m¥obe_off£t
;

222 
__u64
 
	m¥obe_addr
;

223 } 
	mèsk_fd_quîy
;

226 
__u32
 
	m¥og_fd
;

228 
__u32
 
	mèrgë_fd
;

229 
__u32
 
	mèrgë_ifödex
;

231 
__u32
 
	m©èch_ty≥
;

232 
__u32
 
	mÊags
;

234 
__u32
 
	mèrgë_btf_id
;

236 
__Æig√d_u64
 
	môî_öfo
;

237 
__u32
 
	môî_öfo_Àn
;

244 
__u64
 
	mbpf_cookõ
;

245 } 
	m≥rf_evít
;

247 } 
	mlök_¸óã
;

250 
__u32
 
	mlök_fd
;

252 
__u32
 
	m√w_¥og_fd
;

253 
__u32
 
	mÊags
;

256 
__u32
 
	mﬁd_¥og_fd
;

257 } 
	mlök_upd©e
;

260 
__u32
 
	mlök_fd
;

261 } 
	mlök_dëach
;

264 
__u32
 
	mty≥
;

265 } 
	míabÀ_°©s
;

268 
__u32
 
	mlök_fd
;

269 
__u32
 
	mÊags
;

270 } 
	môî_¸óã
;

273 
__u32
 
	m¥og_fd
;

274 
__u32
 
	mm≠_fd
;

275 
__u32
 
	mÊags
;

276 } 
	m¥og_böd_m≠
;

277 } 
__©åibuã__
((
Æig√d
(8)));

	@buffer_selector.h

1 #i‚de‡
_BUFFER_SELECTOR_H


2 
	#_BUFFER_SELECTOR_H


	)

4 
	#SYSCALL_MONITOR_KEY
 0

	)

5 
	#ERPC_MONITOR_KEY
 1

	)

7 
bpf_m≠_def
 
SEC
("m≠s/buf„r_£À˘‹"Ë
	gbuf„r_£À˘‹
 = {

8 .
ty≥
 = 
BPF_MAP_TYPE_ARRAY
,

9 .
	gkey_size
 = (
u32
),

10 .
	gvÆue_size
 = (
u32
),

11 .
	gmax_íåõs
 = 2,

12 .
	gpönög
 = 0,

13 .
	g«me•a˚
 = "",

16 
__©åibuã__
((
Æways_ölöe
))

17 
bpf_m≠_def
 *
	$£À˘_buf„r
(
bpf_m≠_def
 *
‰⁄t_buf„r
,

18 
bpf_m≠_def
 *
back_buf„r
,

19 
u32
 
£À˘‹_key
) {

20 
u32
 *
buf„r_id
 = 
	`bpf_m≠_lookup_ñem
(&
buf„r_£À˘‹
, &
£À˘‹_key
);

21 i‡(
buf„r_id
 =
NULL
)

22  
NULL
;

24  *
buf„r_id
 ? 
back_buf„r
 : 
‰⁄t_buf„r
;

25 
	}
}

27 
__©åibuã__
((
Æways_ölöe
))

28 *
	$bpf_m≠_lookup_‹_åy_öô
(
bpf_m≠_def
 *
m≠
, *
key
, *
zîo
) {

29 i‡(
m≠
 =
NULL
) {

30  
NULL
;

33 *
vÆue
 = 
	`bpf_m≠_lookup_ñem
(
m≠
, 
key
);

34 i‡(
vÆue
 !
NULL
)

35  
vÆue
;

38 i‡(
	`bpf_m≠_upd©e_ñem
(
m≠
, 
key
, 
zîo
, 
BPF_NOEXIST
) < 0)

39  
NULL
;

41  
	`bpf_m≠_lookup_ñem
(
m≠
, 
key
);

42 
	}
}

	@cgroup.h

1 #i‚de‡
_CGROUP_H_


2 
	#_CGROUP_H_


	)

4 
	#CGROUP_DEFAULT
 1

	)

5 
	#CGROUP_CENTOS_7
 2

	)

7 
u32
 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_cgroup_wrôe_ty≥
() {

8 
u64
 
ty≥
;

9 
	`LOAD_CONSTANT
("cgroup_wrôe_ty≥", 
ty≥
);

10  
ty≥
;

11 
	}
}

13 
__©åibuã__
((
Æways_ölöe
)Ë
	$åa˚__cgroup_wrôe
(
±_ªgs
 *
˘x
) {

14 
u32
 
cgroup_wrôe_ty≥
 = 
	`gë_cgroup_wrôe_ty≥
();

15 
u32
 
pid
;

17 
cgroup_wrôe_ty≥
) {

18 
CGROUP_DEFAULT
: {

19 *
pid_buff
 = (*Ë
	`PT_REGS_PARM2
(
˘x
);

20 
pid
 = 
	`©oi
(
pid_buff
);

23 
CGROUP_CENTOS_7
: {

24 
pid
 = (
u32
Ë
	`PT_REGS_PARM3
(
˘x
);

32 
¥oc_ˇche_t
 
√w_íåy
 = {};

33 
¥oc_ˇche_t
 *
ﬁd_íåy
;

34 
u8
 
√w_cookõ
 = 0;

35 
u32
 
cookõ
 = 0;

38 
pid_ˇche_t
 *
pid_íåy
 = (pid_ˇche_à*Ë
	`bpf_m≠_lookup_ñem
(&
pid_ˇche
, &
pid
);

39 i‡(
pid_íåy
) {

40 
cookõ
 = 
pid_íåy
->cookie;

42 
ﬁd_íåy
 = 
	`gë_¥oc_‰om_cookõ
(
cookõ
);

43 i‡(
ﬁd_íåy
) {

45 
	`c›y_¥oc_ˇche
(
ﬁd_íåy
, &
√w_íåy
);

48 
√w_cookõ
 = 1;

49 
cookõ
 = 
	`bpf_gë_¥™dom_u32
();

52 
díåy
 *
c⁄èöî_d
;

53 
q°r
 
c⁄èöî_q°r
;

54 *
c⁄èöî_id
;

56 
cgroup_wrôe_ty≥
) {

57 
CGROUP_DEFAULT
: {

59 
kînfs_›í_fûe
 *
kîn_f
 = (kînfs_›í_fûê*Ë
	`PT_REGS_PARM1
(
˘x
);

60 
fûe
 *
f
;

61 
	`bpf_¥obe_ªad
(&
f
, (f), &
kîn_f
->
fûe
);

62 
díåy
 *díåy = 
	`gë_fûe_díåy
(
f
);

65 
	`bpf_¥obe_ªad
(&
c⁄èöî_d
, (c⁄èöî_d), &
díåy
->
d_∑ª¡
);

66 
	`bpf_¥obe_ªad
(&
c⁄èöî_q°r
, (c⁄èöî_q°r), &
díåy
->
d_«me
);

67 
	`bpf_¥obe_ªad
(&
c⁄èöî_q°r
, (c⁄èöî_q°r), &
c⁄èöî_d
->
d_«me
);

68 
c⁄èöî_id
 = (*Ë
c⁄èöî_q°r
.
«me
;

71 
CGROUP_CENTOS_7
: {

72 *
cgroup
 = (*Ë
	`PT_REGS_PARM1
(
˘x
);

73 
	`bpf_¥obe_ªad
(&
c⁄èöî_d
, (c⁄èöî_d), 
cgroup
 + 72);

74 
	`bpf_¥obe_ªad
(&
c⁄èöî_q°r
, (c⁄èöî_q°r), &
c⁄èöî_d
->
d_«me
);

75 
c⁄èöî_id
 = (*Ë
c⁄èöî_q°r
.
«me
;

76 
¥efix
[4];

77 
	`bpf_¥obe_ªad
(&
¥efix
, ’ªfix), 
c⁄èöî_id
);

78 i‡(
¥efix
[0] == 'd' &&Örefix[1] == 'o' &&Örefix[2] == 'c' &&Örefix[3] == 'k') {

79 
c⁄èöî_id
 += 7;

88 
	`bpf_¥obe_ªad
(&
√w_íåy
.
c⁄èöî
.
c⁄èöî_id
, (new_entry.container.container_id), container_id);

89 
	`bpf_m≠_upd©e_ñem
(&
¥oc_ˇche
, &
cookõ
, &
√w_íåy
, 
BPF_ANY
);

91 i‡(
√w_cookõ
) {

92 
pid_ˇche_t
 
√w_pid_íåy
 = {

93 .
cookõ
 = cookie,

95 
	`bpf_m≠_upd©e_ñem
(&
pid_ˇche
, &
pid
, &
√w_pid_íåy
, 
BPF_ANY
);

98 
	}
}

100 
SEC
("kprobe/cgroup_procs_write")

101 
	$k¥obe_cgroup_¥ocs_wrôe
(
±_ªgs
 *
˘x
) {

102  
	`åa˚__cgroup_wrôe
(
˘x
);

103 
	}
}

105 
SEC
("kprobe/cgroup1_procs_write")

106 
	$k¥obe_cgroup1_¥ocs_wrôe
(
±_ªgs
 *
˘x
) {

107  
	`åa˚__cgroup_wrôe
(
˘x
);

108 
	}
}

110 
SEC
("kprobe/cgroup_tasks_write")

111 
	$k¥obe_cgroup_èsks_wrôe
(
±_ªgs
 *
˘x
) {

112  
	`åa˚__cgroup_wrôe
(
˘x
);

113 
	}
}

115 
SEC
("kprobe/cgroup1_tasks_write")

116 
	$k¥obe_cgroup1_èsks_wrôe
(
±_ªgs
 *
˘x
) {

117  
	`åa˚__cgroup_wrôe
(
˘x
);

118 
	}
}

	@chmod.h

1 #i‚de‡
_CHMOD_H_


2 
	#_CHMOD_H_


	)

4 
	~"sysˇŒs.h
"

6 
	schmod_evít_t
 {

7 
kevít_t
 
	mevít
;

8 
¥o˚ss_c⁄ãxt_t
 
	m¥o˚ss
;

9 
•™_c⁄ãxt_t
 
	m•™
;

10 
c⁄èöî_c⁄ãxt_t
 
	mc⁄èöî
;

11 
sysˇŒ_t
 
	msysˇŒ
;

12 
fûe_t
 
	mfûe
;

13 
u32
 
	mmode
;

14 
u32
 
	m∑ddög
;

17 
__©åibuã__
((
Æways_ölöe
)Ë
	$chmod_≠¥ovîs
(
sysˇŒ_ˇche_t
 *
sysˇŒ
) {

18  
	`ba£«me_≠¥ovî
(
sysˇŒ
, sysˇŒ->
£èâr
.
díåy
, 
EVENT_CHMOD
);

19 
	}
}

21 
__©åibuã__
((
Æways_ölöe
)Ë
	$åa˚__sys_chmod
(
umode_t
 
mode
) {

22 
pﬁicy_t
 
pﬁicy
 = 
	`„tch_pﬁicy
(
EVENT_CHMOD
);

23 i‡(
	`is_disˇrded_by_¥o˚ss
(
pﬁicy
.
mode
, 
EVENT_CHMOD
)) {

27 
sysˇŒ_ˇche_t
 
sysˇŒ
 = {

28 .
ty≥
 = 
EVENT_CHMOD
,

29 .
pﬁicy
 =Öolicy,

30 .
£èâr
 = {

31 .
mode
 = modê& 
S_IALLUGO
,

35 
	`ˇche_sysˇŒ
(&
sysˇŒ
);

38 
	}
}

40 
	$SYSCALL_KPROBE2
(
chmod
, c⁄° *, 
fûíame
, 
umode_t
, 
mode
) {

41  
	`åa˚__sys_chmod
(
mode
);

42 
	}
}

44 
	$SYSCALL_KPROBE2
(
fchmod
, , 
fd
, 
umode_t
, 
mode
) {

45  
	`åa˚__sys_chmod
(
mode
);

46 
	}
}

48 
	$SYSCALL_KPROBE3
(
fchmod©
, , 
dúfd
, c⁄° *, 
fûíame
, 
umode_t
, 
mode
) {

49  
	`åa˚__sys_chmod
(
mode
);

50 
	}
}

52 
__©åibuã__
((
Æways_ölöe
)Ë
	$sys_chmod_ªt
(*
˘x
, 
ªtvÆ
) {

53 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`p›_sysˇŒ
(
EVENT_CHMOD
);

54 i‡(!
sysˇŒ
)

57 i‡(
	`IS_UNHANDLED_ERROR
(
ªtvÆ
))

60 
chmod_evít_t
 
evít
 = {

61 .
sysˇŒ
.
ªtvÆ
 =Ñetval,

62 .
fûe
 = 
sysˇŒ
->
£èâr
.file,

63 .
∑ddög
 = 0,

64 .
mode
 = 
sysˇŒ
->
£èâr
.mode,

67 
¥oc_ˇche_t
 *
íåy
 = 
	`fûl_¥o˚ss_c⁄ãxt
(&
evít
.
¥o˚ss
);

68 
	`fûl_c⁄èöî_c⁄ãxt
(
íåy
, &
evít
.
c⁄èöî
);

69 
	`fûl_•™_c⁄ãxt
(&
evít
.
•™
);

73 
	`£nd_evít
(
˘x
, 
EVENT_CHMOD
, 
evít
);

76 
	}
}

78 
__©åibuã__
((
Æways_ölöe
)Ë
	$k¥obe_sys_chmod_ªt
(
±_ªgs
 *
˘x
) {

79 
ªtvÆ
 = 
	`PT_REGS_RC
(
˘x
);

80  
	`sys_chmod_ªt
(
˘x
, 
ªtvÆ
);

81 
	}
}

83 
SEC
("tracepoint/syscalls/sys_exit_chmod")

84 
	$åa˚poöt_sysˇŒs_sys_exô_chmod
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

85  
	`sys_chmod_ªt
(
¨gs
,árgs->
ªt
);

86 
	}
}

88 
	$SYSCALL_KRETPROBE
(
chmod
) {

89  
	`k¥obe_sys_chmod_ªt
(
˘x
);

90 
	}
}

92 
SEC
("tracepoint/syscalls/sys_exit_fchmod")

93 
	$åa˚poöt_sysˇŒs_sys_exô_fchmod
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

94  
	`sys_chmod_ªt
(
¨gs
,árgs->
ªt
);

95 
	}
}

97 
	$SYSCALL_KRETPROBE
(
fchmod
) {

98  
	`k¥obe_sys_chmod_ªt
(
˘x
);

99 
	}
}

101 
SEC
("tracepoint/syscalls/sys_exit_fchmodat")

102 
	$åa˚poöt_sysˇŒs_sys_exô_fchmod©
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

103  
	`sys_chmod_ªt
(
¨gs
,árgs->
ªt
);

104 
	}
}

106 
	$SYSCALL_KRETPROBE
(
fchmod©
) {

107  
	`k¥obe_sys_chmod_ªt
(
˘x
);

108 
	}
}

110 
SEC
("tracepoint/handle_sys_chmod_exit")

111 
	$åa˚poöt_h™dÀ_sys_chmod_exô
(
åa˚poöt_øw_sysˇŒs_sys_exô_t
 *
¨gs
) {

112  
	`sys_chmod_ªt
(
¨gs
,árgs->
ªt
);

113 
	}
}

	@chown.h

1 #i‚de‡
_CHOWN_H_


2 
	#_CHOWN_H_


	)

4 
	~"sysˇŒs.h
"

6 
	schown_evít_t
 {

7 
kevít_t
 
	mevít
;

8 
¥o˚ss_c⁄ãxt_t
 
	m¥o˚ss
;

9 
•™_c⁄ãxt_t
 
	m•™
;

10 
c⁄èöî_c⁄ãxt_t
 
	mc⁄èöî
;

11 
sysˇŒ_t
 
	msysˇŒ
;

12 
fûe_t
 
	mfûe
;

13 
uid_t
 
	muid
;

14 
gid_t
 
	mgid
;

17 
__©åibuã__
((
Æways_ölöe
)Ë
	$chown_≠¥ovîs
(
sysˇŒ_ˇche_t
 *
sysˇŒ
) {

18  
	`ba£«me_≠¥ovî
(
sysˇŒ
, sysˇŒ->
£èâr
.
díåy
, 
EVENT_CHOWN
);

19 
	}
}

21 
__©åibuã__
((
Æways_ölöe
)Ë
	$åa˚__sys_chown
(
uid_t
 
u£r
, 
gid_t
 
group
) {

22 
pﬁicy_t
 
pﬁicy
 = 
	`„tch_pﬁicy
(
EVENT_CHOWN
);

23 i‡(
	`is_disˇrded_by_¥o˚ss
(
pﬁicy
.
mode
, 
EVENT_CHOWN
)) {

27 
sysˇŒ_ˇche_t
 
sysˇŒ
 = {

28 .
ty≥
 = 
EVENT_CHOWN
,

29 .
pﬁicy
 =Öolicy,

30 .
£èâr
 = {

31 .
u£r
 = user,

32 .
group
 = group

36 
	`ˇche_sysˇŒ
(&
sysˇŒ
);

39 
	}
}

41 
	$SYSCALL_KPROBE3
(
lchown
, c⁄° *, 
fûíame
, 
uid_t
, 
u£r
, 
gid_t
, 
group
) {

42  
	`åa˚__sys_chown
(
u£r
, 
group
);

43 
	}
}

45 
	$SYSCALL_KPROBE3
(
fchown
, , 
fd
, 
uid_t
, 
u£r
, 
gid_t
, 
group
) {

46  
	`åa˚__sys_chown
(
u£r
, 
group
);

47 
	}
}

49 
	$SYSCALL_KPROBE3
(
chown
, c⁄° *, 
fûíame
, 
uid_t
, 
u£r
, 
gid_t
, 
group
) {

50  
	`åa˚__sys_chown
(
u£r
, 
group
);

51 
	}
}

53 
	$SYSCALL_KPROBE3
(
lchown16
, c⁄° *, 
fûíame
, 
uid_t
, 
u£r
, 
gid_t
, 
group
) {

54  
	`åa˚__sys_chown
(
u£r
, 
group
);

55 
	}
}

57 
	$SYSCALL_KPROBE3
(
fchown16
, , 
fd
, 
uid_t
, 
u£r
, 
gid_t
, 
group
) {

58  
	`åa˚__sys_chown
(
u£r
, 
group
);

59 
	}
}

61 
	$SYSCALL_KPROBE3
(
chown16
, c⁄° *, 
fûíame
, 
uid_t
, 
u£r
, 
gid_t
, 
group
) {

62  
	`åa˚__sys_chown
(
u£r
, 
group
);

63 
	}
}

65 
	$SYSCALL_KPROBE4
(
fchow«t
, , 
dúfd
, c⁄° *, 
fûíame
, 
uid_t
, 
u£r
, 
gid_t
, 
group
) {

66  
	`åa˚__sys_chown
(
u£r
, 
group
);

67 
	}
}

69 
__©åibuã__
((
Æways_ölöe
)Ë
	$sys_chown_ªt
(*
˘x
, 
ªtvÆ
) {

70 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`p›_sysˇŒ
(
EVENT_CHOWN
);

71 i‡(!
sysˇŒ
)

74 i‡(
	`IS_UNHANDLED_ERROR
(
ªtvÆ
))

77 
chown_evít_t
 
evít
 = {

78 .
sysˇŒ
.
ªtvÆ
 =Ñetval,

79 .
fûe
 = 
sysˇŒ
->
£èâr
.file,

80 .
uid
 = 
sysˇŒ
->
£èâr
.
u£r
,

81 .
gid
 = 
sysˇŒ
->
£èâr
.
group
,

84 
¥oc_ˇche_t
 *
íåy
 = 
	`fûl_¥o˚ss_c⁄ãxt
(&
evít
.
¥o˚ss
);

85 
	`fûl_c⁄èöî_c⁄ãxt
(
íåy
, &
evít
.
c⁄èöî
);

86 
	`fûl_•™_c⁄ãxt
(&
evít
.
•™
);

90 
	`£nd_evít
(
˘x
, 
EVENT_CHOWN
, 
evít
);

93 
	}
}

95 
__©åibuã__
((
Æways_ölöe
)Ë
	$k¥obe_sys_chown_ªt
(
±_ªgs
 *
˘x
) {

96 
ªtvÆ
 = 
	`PT_REGS_RC
(
˘x
);

97  
	`sys_chown_ªt
(
˘x
, 
ªtvÆ
);

98 
	}
}

100 
SEC
("tracepoint/syscalls/sys_exit_lchown")

101 
	$åa˚poöt_sysˇŒs_sys_exô_lchown
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

102  
	`sys_chown_ªt
(
¨gs
,árgs->
ªt
);

103 
	}
}

105 
	$SYSCALL_KRETPROBE
(
lchown
) {

106  
	`k¥obe_sys_chown_ªt
(
˘x
);

107 
	}
}

109 
SEC
("tracepoint/syscalls/sys_exit_fchown")

110 
	$åa˚poöt_sysˇŒs_sys_exô_fchown
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

111  
	`sys_chown_ªt
(
¨gs
,árgs->
ªt
);

112 
	}
}

114 
	$SYSCALL_KRETPROBE
(
fchown
) {

115  
	`k¥obe_sys_chown_ªt
(
˘x
);

116 
	}
}

118 
SEC
("tracepoint/syscalls/sys_exit_chown")

119 
	$åa˚poöt_sysˇŒs_sys_exô_chown
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

120  
	`sys_chown_ªt
(
¨gs
,árgs->
ªt
);

121 
	}
}

123 
	$SYSCALL_KRETPROBE
(
chown
) {

124  
	`k¥obe_sys_chown_ªt
(
˘x
);

125 
	}
}

127 
SEC
("tracepoint/syscalls/sys_exit_lchown16")

128 
	$åa˚poöt_sysˇŒs_sys_exô_lchown16
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

129  
	`sys_chown_ªt
(
¨gs
,árgs->
ªt
);

130 
	}
}

132 
	$SYSCALL_KRETPROBE
(
lchown16
) {

133  
	`k¥obe_sys_chown_ªt
(
˘x
);

134 
	}
}

136 
SEC
("tracepoint/syscalls/sys_exit_fchown16")

137 
	$åa˚poöt_sysˇŒs_sys_exô_fchown16
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

138  
	`sys_chown_ªt
(
¨gs
,árgs->
ªt
);

139 
	}
}

141 
	$SYSCALL_KRETPROBE
(
fchown16
) {

142  
	`k¥obe_sys_chown_ªt
(
˘x
);

143 
	}
}

145 
SEC
("tracepoint/syscalls/sys_exit_chown16")

146 
	$åa˚poöt_sysˇŒs_sys_exô_chown16
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

147  
	`sys_chown_ªt
(
¨gs
,árgs->
ªt
);

148 
	}
}

150 
	$SYSCALL_KRETPROBE
(
chown16
) {

151  
	`k¥obe_sys_chown_ªt
(
˘x
);

152 
	}
}

154 
SEC
("tracepoint/syscalls/sys_exit_fchownat")

155 
	$åa˚poöt_sysˇŒs_sys_exô_fchow«t
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

156  
	`sys_chown_ªt
(
¨gs
,árgs->
ªt
);

157 
	}
}

159 
	$SYSCALL_KRETPROBE
(
fchow«t
) {

160  
	`k¥obe_sys_chown_ªt
(
˘x
);

161 
	}
}

163 
SEC
("tracepoint/handle_sys_chown_exit")

164 
	$åa˚poöt_h™dÀ_sys_chown_exô
(
åa˚poöt_øw_sysˇŒs_sys_exô_t
 *
¨gs
) {

165  
	`sys_chown_ªt
(
¨gs
,árgs->
ªt
);

166 
	}
}

	@commit_creds.h

1 #i‚de‡
_COMMIT_CREDS_H_


2 
	#_COMMIT_CREDS_H_


	)

4 
	s£tuid_evít_t
 {

5 
kevít_t
 
	mevít
;

6 
¥o˚ss_c⁄ãxt_t
 
	m¥o˚ss
;

7 
•™_c⁄ãxt_t
 
	m•™
;

8 
c⁄èöî_c⁄ãxt_t
 
	mc⁄èöî
;

9 
u32
 
	muid
;

10 
u32
 
	meuid
;

11 
u32
 
	mfsuid
;

14 
	s£tgid_evít_t
 {

15 
kevít_t
 
	mevít
;

16 
¥o˚ss_c⁄ãxt_t
 
	m¥o˚ss
;

17 
•™_c⁄ãxt_t
 
	m•™
;

18 
c⁄èöî_c⁄ãxt_t
 
	mc⁄èöî
;

19 
u32
 
	mgid
;

20 
u32
 
	megid
;

21 
u32
 
	mfsgid
;

24 
	sˇp£t_evít_t
 {

25 
kevít_t
 
	mevít
;

26 
¥o˚ss_c⁄ãxt_t
 
	m¥o˚ss
;

27 
•™_c⁄ãxt_t
 
	m•™
;

28 
c⁄èöî_c⁄ãxt_t
 
	mc⁄èöî
;

29 
u64
 
	mˇp_ef„˘ive
;

30 
u64
 
	mˇp_≥rmôãd
;

33 
__©åibuã__
((
Æways_ölöe
)Ë
	$¸edítüls_upd©e
(
u64
 
ty≥
) {

34 
sysˇŒ_ˇche_t
 
sysˇŒ
 = {

35 .
ty≥
 =Åype,

38 
	`ˇche_sysˇŒ
(&
sysˇŒ
);

40 
	}
}

42 
__©åibuã__
((
Æways_ölöe
)Ë
	$¸edítüls_¥ediˇã
(
u64
 
ty≥
) {

43  
ty≥
 =
EVENT_SETUID
 ||Åy≥ =
EVENT_SETGID
 ||Åy≥ =
EVENT_CAPSET
;

44 
	}
}

46 
__©åibuã__
((
Æways_ölöe
)Ë
	$¸edítüls_upd©e_ªt
(*
˘x
, 
ªtvÆ
) {

47 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`p›_sysˇŒ_wôh
(
¸edítüls_¥ediˇã
);

48 i‡(!
sysˇŒ
)

51 i‡(
ªtvÆ
 < 0)

54 
u32
 
pid
 = 
	`bpf_gë_cuºít_pid_tgid
() >> 32;

55 
pid_ˇche_t
 *
pid_íåy
 = (pid_ˇche_à*)
	`bpf_m≠_lookup_ñem
(&
pid_ˇche
, &
pid
);

56 i‡(!
pid_íåy
) {

60 
sysˇŒ
->
ty≥
) {

61 
EVENT_SETUID
: {

62 
£tuid_evít_t
 
evít
 = {};

63 
¥oc_ˇche_t
 *
íåy
 = 
	`fûl_¥o˚ss_c⁄ãxt
(&
evít
.
¥o˚ss
);

64 
	`fûl_c⁄èöî_c⁄ãxt
(
íåy
, &
evít
.
c⁄èöî
);

65 
	`fûl_•™_c⁄ãxt
(&
evít
.
•™
);

67 
evít
.
uid
 = 
pid_íåy
->
¸edítüls
.uid;

68 
evít
.
euid
 = 
pid_íåy
->
¸edítüls
.euid;

69 
evít
.
fsuid
 = 
pid_íåy
->
¸edítüls
.fsuid;

70 
	`£nd_evít
(
˘x
, 
EVENT_SETUID
, 
evít
);

73 
EVENT_SETGID
: {

74 
£tgid_evít_t
 
evít
 = {};

75 
¥oc_ˇche_t
 *
íåy
 = 
	`fûl_¥o˚ss_c⁄ãxt
(&
evít
.
¥o˚ss
);

76 
	`fûl_c⁄èöî_c⁄ãxt
(
íåy
, &
evít
.
c⁄èöî
);

77 
	`fûl_•™_c⁄ãxt
(&
evít
.
•™
);

79 
evít
.
gid
 = 
pid_íåy
->
¸edítüls
.gid;

80 
evít
.
egid
 = 
pid_íåy
->
¸edítüls
.egid;

81 
evít
.
fsgid
 = 
pid_íåy
->
¸edítüls
.fsgid;

82 
	`£nd_evít
(
˘x
, 
EVENT_SETGID
, 
evít
);

85 
EVENT_CAPSET
: {

86 
ˇp£t_evít_t
 
evít
 = {};

87 
¥oc_ˇche_t
 *
íåy
 = 
	`fûl_¥o˚ss_c⁄ãxt
(&
evít
.
¥o˚ss
);

88 
	`fûl_c⁄èöî_c⁄ãxt
(
íåy
, &
evít
.
c⁄èöî
);

89 
	`fûl_•™_c⁄ãxt
(&
evít
.
•™
);

91 
evít
.
ˇp_ef„˘ive
 = 
pid_íåy
->
¸edítüls
.cap_effective;

92 
evít
.
ˇp_≥rmôãd
 = 
pid_íåy
->
¸edítüls
.cap_permitted;

93 
	`£nd_evít
(
˘x
, 
EVENT_CAPSET
, 
evít
);

99 
	}
}

101 
__©åibuã__
((
Æways_ölöe
)Ë
	$k¥obe_¸edítüls_upd©e_ªt
(
±_ªgs
 *
˘x
) {

102 
ªtvÆ
 = 
	`PT_REGS_RC
(
˘x
);

103  
	`¸edítüls_upd©e_ªt
(
˘x
, 
ªtvÆ
);

104 
	}
}

106 
	$SYSCALL_KPROBE0
(
£tuid
) {

107  
	`¸edítüls_upd©e
(
EVENT_SETUID
);

108 
	}
}

110 
	$SYSCALL_KRETPROBE
(
£tuid
) {

111  
	`k¥obe_¸edítüls_upd©e_ªt
(
˘x
);

112 
	}
}

114 
SEC
("tracepoint/syscalls/sys_exit_setuid")

115 
	$åa˚poöt_sysˇŒs_sys_exô_£tuid
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

116  
	`¸edítüls_upd©e_ªt
(
¨gs
,árgs->
ªt
);

117 
	}
}

119 
	$SYSCALL_KPROBE0
(
£ãuid
) {

120  
	`¸edítüls_upd©e
(
EVENT_SETUID
);

121 
	}
}

123 
	$SYSCALL_KRETPROBE
(
£ãuid
) {

124  
	`k¥obe_¸edítüls_upd©e_ªt
(
˘x
);

125 
	}
}

127 
SEC
("tracepoint/syscalls/sys_exit_seteuid")

128 
	$åa˚poöt_sysˇŒs_sys_exô_£ãuid
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

129  
	`¸edítüls_upd©e_ªt
(
¨gs
,árgs->
ªt
);

130 
	}
}

132 
	$SYSCALL_KPROBE0
(
£tfsuid
) {

133  
	`¸edítüls_upd©e
(
EVENT_SETUID
);

134 
	}
}

136 
	$SYSCALL_KRETPROBE
(
£tfsuid
) {

137  
	`k¥obe_¸edítüls_upd©e_ªt
(
˘x
);

138 
	}
}

140 
SEC
("tracepoint/syscalls/sys_exit_setfsuid")

141 
	$åa˚poöt_sysˇŒs_sys_exô_£tfsuid
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

142  
	`¸edítüls_upd©e_ªt
(
¨gs
,árgs->
ªt
);

143 
	}
}

145 
	$SYSCALL_KPROBE0
(
£åeuid
) {

146  
	`¸edítüls_upd©e
(
EVENT_SETUID
);

147 
	}
}

149 
	$SYSCALL_KRETPROBE
(
£åeuid
) {

150  
	`k¥obe_¸edítüls_upd©e_ªt
(
˘x
);

151 
	}
}

153 
SEC
("tracepoint/syscalls/sys_exit_setreuid")

154 
	$åa˚poöt_sysˇŒs_sys_exô_£åeuid
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

155  
	`¸edítüls_upd©e_ªt
(
¨gs
,árgs->
ªt
);

156 
	}
}

158 
	$SYSCALL_KPROBE0
(
£åesuid
) {

159  
	`¸edítüls_upd©e
(
EVENT_SETUID
);

160 
	}
}

162 
	$SYSCALL_KRETPROBE
(
£åesuid
) {

163  
	`k¥obe_¸edítüls_upd©e_ªt
(
˘x
);

164 
	}
}

166 
SEC
("tracepoint/syscalls/sys_exit_setresuid")

167 
	$åa˚poöt_sysˇŒs_sys_exô_£åesuid
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

168  
	`¸edítüls_upd©e_ªt
(
¨gs
,árgs->
ªt
);

169 
	}
}

171 
	$SYSCALL_KPROBE0
(
£tuid16
) {

172  
	`¸edítüls_upd©e
(
EVENT_SETUID
);

173 
	}
}

175 
	$SYSCALL_KRETPROBE
(
£tuid16
) {

176  
	`k¥obe_¸edítüls_upd©e_ªt
(
˘x
);

177 
	}
}

179 
SEC
("tracepoint/syscalls/sys_exit_setuid16")

180 
	$åa˚poöt_sysˇŒs_sys_exô_£tuid16
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

181  
	`¸edítüls_upd©e_ªt
(
¨gs
,árgs->
ªt
);

182 
	}
}

184 
	$SYSCALL_KPROBE0
(
£ãuid16
) {

185  
	`¸edítüls_upd©e
(
EVENT_SETUID
);

186 
	}
}

188 
	$SYSCALL_KRETPROBE
(
£ãuid16
) {

189  
	`k¥obe_¸edítüls_upd©e_ªt
(
˘x
);

190 
	}
}

192 
SEC
("tracepoint/syscalls/sys_exit_seteuid16")

193 
	$åa˚poöt_sysˇŒs_sys_exô_£ãuid16
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

194  
	`¸edítüls_upd©e_ªt
(
¨gs
,árgs->
ªt
);

195 
	}
}

197 
	$SYSCALL_KPROBE0
(
£tfsuid16
) {

198  
	`¸edítüls_upd©e
(
EVENT_SETUID
);

199 
	}
}

201 
	$SYSCALL_KRETPROBE
(
£tfsuid16
) {

202  
	`k¥obe_¸edítüls_upd©e_ªt
(
˘x
);

203 
	}
}

205 
SEC
("tracepoint/syscalls/sys_exit_setfsuid16")

206 
	$åa˚poöt_sysˇŒs_sys_exô_£tfsuid16
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

207  
	`¸edítüls_upd©e_ªt
(
¨gs
,árgs->
ªt
);

208 
	}
}

210 
	$SYSCALL_KPROBE0
(
£åeuid16
) {

211  
	`¸edítüls_upd©e
(
EVENT_SETUID
);

212 
	}
}

214 
	$SYSCALL_KRETPROBE
(
£åeuid16
) {

215  
	`k¥obe_¸edítüls_upd©e_ªt
(
˘x
);

216 
	}
}

218 
SEC
("tracepoint/syscalls/sys_exit_setreuid16")

219 
	$åa˚poöt_sysˇŒs_sys_exô_£åeuid16
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

220  
	`¸edítüls_upd©e_ªt
(
¨gs
,árgs->
ªt
);

221 
	}
}

223 
	$SYSCALL_KPROBE0
(
£åesuid16
) {

224  
	`¸edítüls_upd©e
(
EVENT_SETUID
);

225 
	}
}

227 
	$SYSCALL_KRETPROBE
(
£åesuid16
) {

228  
	`k¥obe_¸edítüls_upd©e_ªt
(
˘x
);

229 
	}
}

231 
SEC
("tracepoint/syscalls/sys_exit_setresuid16")

232 
	$åa˚poöt_sysˇŒs_sys_exô_£åesuid16
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

233  
	`¸edítüls_upd©e_ªt
(
¨gs
,árgs->
ªt
);

234 
	}
}

236 
	$SYSCALL_KPROBE0
(
£tgid
) {

237  
	`¸edítüls_upd©e
(
EVENT_SETGID
);

238 
	}
}

240 
	$SYSCALL_KRETPROBE
(
£tgid
) {

241  
	`k¥obe_¸edítüls_upd©e_ªt
(
˘x
);

242 
	}
}

244 
SEC
("tracepoint/syscalls/sys_exit_setgid")

245 
	$åa˚poöt_sysˇŒs_sys_exô_£tgid
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

246  
	`¸edítüls_upd©e_ªt
(
¨gs
,árgs->
ªt
);

247 
	}
}

249 
	$SYSCALL_KPROBE0
(
£ãgid
) {

250  
	`¸edítüls_upd©e
(
EVENT_SETGID
);

251 
	}
}

253 
	$SYSCALL_KRETPROBE
(
£ãgid
) {

254  
	`k¥obe_¸edítüls_upd©e_ªt
(
˘x
);

255 
	}
}

257 
SEC
("tracepoint/syscalls/sys_exit_setegid")

258 
	$åa˚poöt_sysˇŒs_sys_exô_£ãgid
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

259  
	`¸edítüls_upd©e_ªt
(
¨gs
,árgs->
ªt
);

260 
	}
}

262 
	$SYSCALL_KPROBE0
(
£tfsgid
) {

263  
	`¸edítüls_upd©e
(
EVENT_SETGID
);

264 
	}
}

266 
	$SYSCALL_KRETPROBE
(
£tfsgid
) {

267  
	`k¥obe_¸edítüls_upd©e_ªt
(
˘x
);

268 
	}
}

270 
SEC
("tracepoint/syscalls/sys_exit_setfsgid")

271 
	$åa˚poöt_sysˇŒs_sys_exô_£tfsgid
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

272  
	`¸edítüls_upd©e_ªt
(
¨gs
,árgs->
ªt
);

273 
	}
}

275 
	$SYSCALL_KPROBE0
(
£åegid
) {

276  
	`¸edítüls_upd©e
(
EVENT_SETGID
);

277 
	}
}

279 
	$SYSCALL_KRETPROBE
(
£åegid
) {

280  
	`k¥obe_¸edítüls_upd©e_ªt
(
˘x
);

281 
	}
}

283 
SEC
("tracepoint/syscalls/sys_exit_setregid")

284 
	$åa˚poöt_sysˇŒs_sys_exô_£åegid
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

285  
	`¸edítüls_upd©e_ªt
(
¨gs
,árgs->
ªt
);

286 
	}
}

288 
	$SYSCALL_KPROBE0
(
£åesgid
) {

289  
	`¸edítüls_upd©e
(
EVENT_SETGID
);

290 
	}
}

292 
	$SYSCALL_KRETPROBE
(
£åesgid
) {

293  
	`k¥obe_¸edítüls_upd©e_ªt
(
˘x
);

294 
	}
}

296 
SEC
("tracepoint/syscalls/sys_exit_setresgid")

297 
	$åa˚poöt_sysˇŒs_sys_exô_£åesgid
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

298  
	`¸edítüls_upd©e_ªt
(
¨gs
,árgs->
ªt
);

299 
	}
}

301 
	$SYSCALL_KPROBE0
(
£tgid16
) {

302  
	`¸edítüls_upd©e
(
EVENT_SETGID
);

303 
	}
}

305 
	$SYSCALL_KRETPROBE
(
£tgid16
) {

306  
	`k¥obe_¸edítüls_upd©e_ªt
(
˘x
);

307 
	}
}

309 
SEC
("tracepoint/syscalls/sys_exit_setgid16")

310 
	$åa˚poöt_sysˇŒs_sys_exô_£tgid16
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

311  
	`¸edítüls_upd©e_ªt
(
¨gs
,árgs->
ªt
);

312 
	}
}

314 
	$SYSCALL_KPROBE0
(
£ãgid16
) {

315  
	`¸edítüls_upd©e
(
EVENT_SETGID
);

316 
	}
}

318 
	$SYSCALL_KRETPROBE
(
£ãgid16
) {

319  
	`k¥obe_¸edítüls_upd©e_ªt
(
˘x
);

320 
	}
}

322 
SEC
("tracepoint/syscalls/sys_exit_setegid16")

323 
	$åa˚poöt_sysˇŒs_sys_exô_£ãgid16
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

324  
	`¸edítüls_upd©e_ªt
(
¨gs
,árgs->
ªt
);

325 
	}
}

327 
	$SYSCALL_KPROBE0
(
£tfsgid16
) {

328  
	`¸edítüls_upd©e
(
EVENT_SETGID
);

329 
	}
}

331 
	$SYSCALL_KRETPROBE
(
£tfsgid16
) {

332  
	`k¥obe_¸edítüls_upd©e_ªt
(
˘x
);

333 
	}
}

335 
SEC
("tracepoint/syscalls/sys_exit_setfsgid16")

336 
	$åa˚poöt_sysˇŒs_sys_exô_£tfsgid16
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

337  
	`¸edítüls_upd©e_ªt
(
¨gs
,árgs->
ªt
);

338 
	}
}

340 
	$SYSCALL_KPROBE0
(
£åegid16
) {

341  
	`¸edítüls_upd©e
(
EVENT_SETGID
);

342 
	}
}

344 
	$SYSCALL_KRETPROBE
(
£åegid16
) {

345  
	`k¥obe_¸edítüls_upd©e_ªt
(
˘x
);

346 
	}
}

348 
SEC
("tracepoint/syscalls/sys_exit_setregid16")

349 
	$åa˚poöt_sysˇŒs_sys_exô_£åegid16
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

350  
	`¸edítüls_upd©e_ªt
(
¨gs
,árgs->
ªt
);

351 
	}
}

353 
	$SYSCALL_KPROBE0
(
£åesgid16
) {

354  
	`¸edítüls_upd©e
(
EVENT_SETGID
);

355 
	}
}

357 
	$SYSCALL_KRETPROBE
(
£åesgid16
) {

358  
	`k¥obe_¸edítüls_upd©e_ªt
(
˘x
);

359 
	}
}

361 
SEC
("tracepoint/syscalls/sys_exit_setresgid16")

362 
	$åa˚poöt_sysˇŒs_sys_exô_£åesgid16
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

363  
	`¸edítüls_upd©e_ªt
(
¨gs
,árgs->
ªt
);

364 
	}
}

366 
	$SYSCALL_KPROBE0
(
ˇp£t
) {

367  
	`¸edítüls_upd©e
(
EVENT_CAPSET
);

368 
	}
}

370 
	$SYSCALL_KRETPROBE
(
ˇp£t
) {

371  
	`k¥obe_¸edítüls_upd©e_ªt
(
˘x
);

372 
	}
}

374 
SEC
("tracepoint/syscalls/sys_exit_capset")

375 
	$åa˚poöt_sysˇŒs_sys_exô_ˇp£t
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

376  
	`¸edítüls_upd©e_ªt
(
¨gs
,árgs->
ªt
);

377 
	}
}

379 
SEC
("tracepoint/handle_sys_commit_creds_exit")

380 
	$åa˚poöt_h™dÀ_sys_commô_¸eds_exô
(
åa˚poöt_øw_sysˇŒs_sys_exô_t
 *
¨gs
) {

381  
	`¸edítüls_upd©e_ªt
(
¨gs
,árgs->
ªt
);

382 
	}
}

384 
	s¸ed_ids
 {

385 
kuid_t
 
	muid
;

386 
kgid_t
 
	mgid
;

387 
kuid_t
 
	msuid
;

388 
kgid_t
 
	msgid
;

389 
kuid_t
 
	meuid
;

390 
kgid_t
 
	megid
;

391 
kuid_t
 
	mfsuid
;

392 
kgid_t
 
	mfsgid
;

393 
	m£cuªbôs
;

394 
kî√l_ˇp_t
 
	mˇp_öhîôabÀ
;

395 
kî√l_ˇp_t
 
	mˇp_≥rmôãd
;

396 
kî√l_ˇp_t
 
	mˇp_ef„˘ive
;

397 
kî√l_ˇp_t
 
	mˇp_b£t
;

398 
kî√l_ˇp_t
 
	mˇp_ambõ¡
;

401 
SEC
("kprobe/commit_creds")

402 
	$k¥obe_commô_¸eds
(
±_ªgs
 *
˘x
) {

403 
u64
 
¸eds_uid_off£t
;

404 
	`LOAD_CONSTANT
("¸eds_uid_off£t", 
¸eds_uid_off£t
);

405 
¸ed_ids
 *
¸edítüls
 = (¸ed_id†*)(
	`PT_REGS_PARM1
(
˘x
Ë+ 
¸eds_uid_off£t
);

406 
pid_ˇche_t
 
√w_pid_íåy
 = {};

409 
u32
 
pid
 = 
	`bpf_gë_cuºít_pid_tgid
() >> 32;

410 
u8
 
√w_íåy
 = 0;

411 
pid_ˇche_t
 *
pid_íåy
 = (pid_ˇche_à*)
	`bpf_m≠_lookup_ñem
(&
pid_ˇche
, &
pid
);

412 i‡(!
pid_íåy
) {

413 
√w_íåy
 = 1;

414 
pid_íåy
 = &
√w_pid_íåy
;

416 i‡(!
pid_íåy
) {

419 
	`bpf_¥obe_ªad
(&
pid_íåy
->
¸edítüls
.
uid
, (pid_entry->credentials.uid), &credentials->uid);

420 
	`bpf_¥obe_ªad
(&
pid_íåy
->
¸edítüls
.
gid
, (pid_entry->credentials.gid), &credentials->gid);

421 
	`bpf_¥obe_ªad
(&
pid_íåy
->
¸edítüls
.
euid
, (pid_entry->credentials.euid), &credentials->euid);

422 
	`bpf_¥obe_ªad
(&
pid_íåy
->
¸edítüls
.
egid
, (pid_entry->credentials.egid), &credentials->egid);

423 
	`bpf_¥obe_ªad
(&
pid_íåy
->
¸edítüls
.
fsuid
, (pid_entry->credentials.fsuid), &credentials->fsuid);

424 
	`bpf_¥obe_ªad
(&
pid_íåy
->
¸edítüls
.
fsgid
, (pid_entry->credentials.fsgid), &credentials->fsgid);

425 
	`bpf_¥obe_ªad
(&
pid_íåy
->
¸edítüls
.
ˇp_ef„˘ive
, (pid_entry->credentials.cap_effective), &credentials->cap_effective);

426 
	`bpf_¥obe_ªad
(&
pid_íåy
->
¸edítüls
.
ˇp_≥rmôãd
, (pid_entry->credentials.cap_permitted), &credentials->cap_permitted);

428 i‡(
√w_íåy
) {

429 
	`bpf_m≠_upd©e_ñem
(&
pid_ˇche
, &
pid
, &
√w_pid_íåy
, 
BPF_ANY
);

432 
	}
}

	@container.h

1 #i‚de‡
_CONTAINER_H_


2 
	#_CONTAINER_H_


	)

4 
__©åibuã__
((
Æways_ölöe
)Ë
u32
 
	$c›y_c⁄èöî_id
(
§c
[
CONTAINER_ID_LEN
], 
d°
[CONTAINER_ID_LEN]) {

5 i‡(
§c
[0] == 0) {

9 #¥agm®
uƒﬁl


10 
i
 = 0; i < 
CONTAINER_ID_LEN
; i++)

12 i‡(
§c
[
i
] == 0)

15 
d°
[
i
] = 
§c
[i];

17  
CONTAINER_ID_LEN
;

18 
	}
}

	@defs.h

1 #i‚de‡
_DEFS_H_


2 
	#_DEFS_H_


	)

4 
	~"bpf_hñ≥rs.h
"

6 
	#LOAD_CONSTANT
(
∑øm
, 
v¨
Ë
	`asm
("%0 = "Ö¨am "Ül" : "Ù"(v¨))

	)

8 #i‡
deföed
(
__x86_64__
)

9 
	#SYSCALL64_PREFIX
 "__x64_"

	)

10 
	#SYSCALL32_PREFIX
 "__ü32_"

	)

12 
	#SYSCALL64_PT_REGS_PARM1
(
x
Ë((x)->
di
)

	)

13 
	#SYSCALL64_PT_REGS_PARM2
(
x
Ë((x)->
si
)

	)

14 
	#SYSCALL64_PT_REGS_PARM3
(
x
Ë((x)->
dx
)

	)

15 #i‡
USE_SYSCALL_WRAPPER
 == 1

16 
	#SYSCALL64_PT_REGS_PARM4
(
x
Ë((x)->
r10
)

	)

18 
	#SYSCALL64_PT_REGS_PARM4
(
x
Ë((x)->
cx
)

	)

20 
	#SYSCALL64_PT_REGS_PARM5
(
x
Ë((x)->
r8
)

	)

21 
	#SYSCALL64_PT_REGS_PARM6
(
x
Ë((x)->
r9
)

	)

23 
	#SYSCALL32_PT_REGS_PARM1
(
x
Ë((x)->
bx
)

	)

24 
	#SYSCALL32_PT_REGS_PARM2
(
x
Ë((x)->
cx
)

	)

25 
	#SYSCALL32_PT_REGS_PARM3
(
x
Ë((x)->
dx
)

	)

26 
	#SYSCALL32_PT_REGS_PARM4
(
x
Ë((x)->
si
)

	)

27 
	#SYSCALL32_PT_REGS_PARM5
(
x
Ë((x)->
di
)

	)

28 
	#SYSCALL32_PT_REGS_PARM6
(
x
Ë((x)->
bp
)

	)

30 #ñi‡
deföed
(
__Ørch64__
)

31 
	#SYSCALL64_PREFIX
 "__¨m64_"

	)

32 
	#SYSCALL32_PREFIX
 "__¨m32_"

	)

34 
	#SYSCALL64_PT_REGS_PARM1
(
x
Ë
	`PT_REGS_PARM1
(x)

	)

35 
	#SYSCALL64_PT_REGS_PARM2
(
x
Ë
	`PT_REGS_PARM2
(x)

	)

36 
	#SYSCALL64_PT_REGS_PARM3
(
x
Ë
	`PT_REGS_PARM3
(x)

	)

37 
	#SYSCALL64_PT_REGS_PARM4
(
x
Ë
	`PT_REGS_PARM4
(x)

	)

38 
	#SYSCALL64_PT_REGS_PARM5
(
x
Ë
	`PT_REGS_PARM5
(x)

	)

39 
	#SYSCALL64_PT_REGS_PARM6
(
x
Ë
	`PT_REGS_PARM6
(x)

	)

41 
	#SYSCALL32_PT_REGS_PARM1
(
x
Ë
	`PT_REGS_PARM1
(x)

	)

42 
	#SYSCALL32_PT_REGS_PARM2
(
x
Ë
	`PT_REGS_PARM2
(x)

	)

43 
	#SYSCALL32_PT_REGS_PARM3
(
x
Ë
	`PT_REGS_PARM3
(x)

	)

44 
	#SYSCALL32_PT_REGS_PARM4
(
x
Ë
	`PT_REGS_PARM4
(x)

	)

45 
	#SYSCALL32_PT_REGS_PARM5
(
x
Ë
	`PT_REGS_PARM5
(x)

	)

46 
	#SYSCALL32_PT_REGS_PARM6
(
x
Ë
	`PT_REGS_PARM6
(x)

	)

61 
	#__JOIN0
(
m
,...)

	)

62 
	#__JOIN1
(
m
,
t
,
a
,...Ë,
	`m
—,a)

	)

63 
	#__JOIN2
(
m
,
t
,
a
,...Ë,
	`m
—,aË
	`__JOIN1
(m,
__VA_ARGS__
)

	)

64 
	#__JOIN3
(
m
,
t
,
a
,...Ë,
	`m
—,aË
	`__JOIN2
(m,
__VA_ARGS__
)

	)

65 
	#__JOIN4
(
m
,
t
,
a
,...Ë,
	`m
—,aË
	`__JOIN3
(m,
__VA_ARGS__
)

	)

66 
	#__JOIN5
(
m
,
t
,
a
,...Ë,
	`m
—,aË
	`__JOIN4
(m,
__VA_ARGS__
)

	)

67 
	#__JOIN6
(
m
,
t
,
a
,...Ë,
	`m
—,aË
	`__JOIN5
(m,
__VA_ARGS__
)

	)

68 
	#__JOIN
(
n
,...Ë
__JOIN
##
	`n
(
__VA_ARGS__
)

	)

70 
	#__MAP0
(
n
,
m
,...)

	)

71 
	#__MAP1
(
n
,
m
,
t1
,
a1
,...Ë
	`m
(1,t1,a1)

	)

72 
	#__MAP2
(
n
,
m
,
t1
,
a1
,
t2
,
a2
Ë
	`m
(1,t1,a1Ëm(2,t2,a2)

	)

73 
	#__MAP3
(
n
,
m
,
t1
,
a1
,
t2
,
a2
,
t3
,
a3
Ë
	`m
(1,t1,a1Ëm(2,t2,a2Ëm(3,t3,a3)

	)

74 
	#__MAP4
(
n
,
m
,
t1
,
a1
,
t2
,
a2
,
t3
,
a3
,
t4
,
a4
Ë
	`m
(1,t1,a1Ëm(2,t2,a2Ëm(3,t3,a3Ëm(4,t4,a4)

	)

75 
	#__MAP5
(
n
,
m
,
t1
,
a1
,
t2
,
a2
,
t3
,
a3
,
t4
,
a4
,
t5
,
a5
Ë
	`m
(1,t1,a1Ëm(2,t2,a2Ëm(3,t3,a3Ëm(4,t4,a4Ëm(5,t5,a5)

	)

76 
	#__MAP6
(
n
,
m
,
t1
,
a1
,
t2
,
a2
,
t3
,
a3
,
t4
,
a4
,
t5
,
a5
,
t6
,
a6
Ë
	`m
(1,t1,a1Ëm(2,t2,a2Ëm(3,t3,a3Ëm(4,t4,a4Ëm(5,t5,a5Ëm(6,t6,a6)

	)

77 
	#__MAP
(
n
,...Ë
__MAP
##
	`n
“,
__VA_ARGS__
)

	)

79 
	#__SC_DECL
(
t
, 
a
Ëà
	)
a

80 
	#__SC_PASS
(
t
, 
a
Ë
	)
a

82 
	#SYSCALL_ABI_HOOKx
(
x
,
w‹d_size
,
ty≥
,
TYPE
,
¥efix
,
sysˇŒ
,
suffix
,...) \

83 
	`__©åibuã__
((
Æways_ölöe
)Ë
ty≥
##
__
##
sys
##
	`sysˇŒ
(
±_ªgs
 *
˘x
 
	`__JOIN
(
x
,
__SC_DECL
,
__VA_ARGS__
)); \

84 
	`SEC
(#ty≥ "/" 
SYSCALL
##
w‹d_size
##
_PREFIX
 #¥efix 
SYSCALL_PREFIX
 #syscall #suffix) \

85 
ty≥
##
__
 ##
w‹d_size
##
_
##
¥efix
 ##
sys
##
sysˇŒ
##
	`suffix
(
±_ªgs
 *
˘x
) { \

86 
SYSCALL_
##
TYPE
##
	`_PROLOG
(
x
,
__SC_
##
w‹d_size
##
_PARAM
,
sysˇŒ
,
__VA_ARGS__
) \

87  
ty≥
##
__sys
##
	`sysˇŒ
(
˘x
 
	`__JOIN
(
x
,
__SC_PASS
,
__VA_ARGS__
)); \

88 }

	)

90 
	#SYSCALL_HOOK_COMMON
(
x
,
ty≥
,
sysˇŒ
,...Ë
	`__©åibuã__
((
Æways_ölöe
)Ëty≥##
__sys
##
	`sysˇŒ
(
±_ªgs
 *
˘x
 
	`__JOIN
(x,
__SC_DECL
,
__VA_ARGS__
))

	)

92 #i‡
USE_SYSCALL_WRAPPER
 == 1

93 
	#SYSCALL_PREFIX
 "sys"

	)

94 
	#__SC_64_PARAM
(
n
, 
t
, 
a
Ëàa; 
	`bpf_¥obe_ªad
(&a, —), (*Ë&
SYSCALL64_PT_REGS_PARM
##
	`n
(
r˘x
));

	)

95 
	#__SC_32_PARAM
(
n
, 
t
, 
a
Ëàa; 
	`bpf_¥obe_ªad
(&a, —), (*Ë&
SYSCALL32_PT_REGS_PARM
##
	`n
(
r˘x
));

	)

96 
	#SYSCALL_KPROBE_PROLOG
(
x
,
m
,
sysˇŒ
,...) \

97 
±_ªgs
 *
r˘x
 = (±_ªg†*Ë
	`PT_REGS_PARM1
(
˘x
); \

98 i‡(!
r˘x
)  0; \

99 
	`__MAP
(
x
,
m
,
__VA_ARGS__
)

	)

100 
	#SYSCALL_KRETPROBE_PROLOG
(...)

	)

101 
	#SYSCALL_HOOKx
(
x
,
ty≥
,
TYPE
,
¥efix
,
«me
,...) \

102 
	`SYSCALL_ABI_HOOKx
(
x
,32,
ty≥
,
TYPE
,
¥efix
,
«me
,,
__VA_ARGS__
) \

103 
	`SYSCALL_ABI_HOOKx
(
x
,64,
ty≥
,
TYPE
,,
«me
,,
__VA_ARGS__
) \

104 
	`SYSCALL_HOOK_COMMON
(
x
,
ty≥
,
«me
,
__VA_ARGS__
)

	)

105 
	#SYSCALL_COMPAT_HOOKx
(
x
,
ty≥
,
TYPE
,
«me
,...) \

106 
	`SYSCALL_ABI_HOOKx
(
x
,32,
ty≥
,
TYPE
,
com∑t_
,
«me
,,
__VA_ARGS__
) \

107 
	`SYSCALL_ABI_HOOKx
(
x
,64,
ty≥
,
TYPE
,,
«me
,,
__VA_ARGS__
) \

108 
	`SYSCALL_HOOK_COMMON
(
x
,
ty≥
,
«me
,
__VA_ARGS__
)

	)

109 
	#SYSCALL_COMPAT_TIME_HOOKx
(
x
,
ty≥
,
TYPE
,
«me
,...) \

110 
	`SYSCALL_ABI_HOOKx
(
x
,32,
ty≥
,
TYPE
,
com∑t_
,
«me
,,
__VA_ARGS__
) \

111 
	`SYSCALL_ABI_HOOKx
(
x
,32,
ty≥
,
TYPE
,,
«me
,
_time32
,
__VA_ARGS__
) \

112 
	`SYSCALL_ABI_HOOKx
(
x
,64,
ty≥
,
TYPE
,,
«me
,,
__VA_ARGS__
) \

113 
	`SYSCALL_ABI_HOOKx
(
x
,64,
ty≥
,
TYPE
,,
«me
,
_time32
,
__VA_ARGS__
) \

114 
	`SYSCALL_HOOK_COMMON
(
x
,
ty≥
,
«me
,
__VA_ARGS__
)

	)

116 #unde‡
SYSCALL32_PREFIX


117 #unde‡
SYSCALL64_PREFIX


118 
	#SYSCALL32_PREFIX
 ""

	)

119 
	#SYSCALL64_PREFIX
 ""

	)

120 
	#SYSCALL_PREFIX
 "sys"

	)

121 
	#__SC_64_PARAM
(
n
, 
t
, 
a
Ëà®—Ë
SYSCALL64_PT_REGS_PARM
##
	`n
(
˘x
);

	)

122 
	#__SC_32_PARAM
(
n
, 
t
, 
a
Ëà®—Ë
SYSCALL32_PT_REGS_PARM
##
	`n
(
˘x
);

	)

123 
	#SYSCALL_KPROBE_PROLOG
(
x
,
m
,
sysˇŒ
,...) \

124 
±_ªgs
 *
r˘x
 = 
˘x
; \

125 i‡(!
r˘x
)  0; \

126 
	`__MAP
(
x
,
m
,
__VA_ARGS__
)

	)

127 
	#SYSCALL_KRETPROBE_PROLOG
(...)

	)

128 
	#SYSCALL_HOOKx
(
x
,
ty≥
,
TYPE
,
¥efix
,
«me
,...) \

129 
	`SYSCALL_ABI_HOOKx
(
x
,64,
ty≥
,
TYPE
,
com∑t_
,
«me
,,
__VA_ARGS__
) \

130 
	`SYSCALL_ABI_HOOKx
(
x
,64,
ty≥
,
TYPE
,,
«me
,,
__VA_ARGS__
) \

131 
	`SYSCALL_HOOK_COMMON
(
x
,
ty≥
,
«me
,
__VA_ARGS__
)

	)

132 
	#SYSCALL_COMPAT_HOOKx
(
x
,
ty≥
,
TYPE
,
«me
,...) \

133 
	`SYSCALL_ABI_HOOKx
(
x
,64,
ty≥
,
TYPE
,
com∑t_
,
«me
,,
__VA_ARGS__
) \

134 
	`SYSCALL_ABI_HOOKx
(
x
,64,
ty≥
,
TYPE
,,
«me
,,
__VA_ARGS__
) \

135 
	`SYSCALL_HOOK_COMMON
(
x
,
ty≥
,
«me
,
__VA_ARGS__
)

	)

136 
	#SYSCALL_COMPAT_TIME_HOOKx
(
x
,
ty≥
,
TYPE
,
«me
,...) \

137 
	`SYSCALL_ABI_HOOKx
(
x
,64,
ty≥
,
TYPE
,
com∑t_
,
«me
,,
__VA_ARGS__
) \

138 
	`SYSCALL_ABI_HOOKx
(
x
,64,
ty≥
,
TYPE
,,
«me
,,
__VA_ARGS__
) \

139 
	`SYSCALL_HOOK_COMMON
(
x
,
ty≥
,
«me
,
__VA_ARGS__
)

	)

142 
	#SYSCALL_KPROBE0
(
«me
, ...Ë
	`SYSCALL_HOOKx
(0,
k¥obe
,
KPROBE
,,
_
##«me,
__VA_ARGS__
)

	)

143 
	#SYSCALL_KPROBE1
(
«me
, ...Ë
	`SYSCALL_HOOKx
(1,
k¥obe
,
KPROBE
,,
_
##«me,
__VA_ARGS__
)

	)

144 
	#SYSCALL_KPROBE2
(
«me
, ...Ë
	`SYSCALL_HOOKx
(2,
k¥obe
,
KPROBE
,,
_
##«me,
__VA_ARGS__
)

	)

145 
	#SYSCALL_KPROBE3
(
«me
, ...Ë
	`SYSCALL_HOOKx
(3,
k¥obe
,
KPROBE
,,
_
##«me,
__VA_ARGS__
)

	)

146 
	#SYSCALL_KPROBE4
(
«me
, ...Ë
	`SYSCALL_HOOKx
(4,
k¥obe
,
KPROBE
,,
_
##«me,
__VA_ARGS__
)

	)

147 
	#SYSCALL_KPROBE5
(
«me
, ...Ë
	`SYSCALL_HOOKx
(5,
k¥obe
,
KPROBE
,,
_
##«me,
__VA_ARGS__
)

	)

148 
	#SYSCALL_KPROBE6
(
«me
, ...Ë
	`SYSCALL_HOOKx
(6,
k¥obe
,
KPROBE
,,
_
##«me,
__VA_ARGS__
)

	)

150 
	#SYSCALL_KRETPROBE
(
«me
, ...Ë
	`SYSCALL_HOOKx
(0,
kªçrobe
,
KRETPROBE
,,
_
##«me)

	)

152 
	#SYSCALL_COMPAT_KPROBE0
(
«me
, ...Ë
	`SYSCALL_COMPAT_HOOKx
(0,
k¥obe
,
KPROBE
,
_
##«me,
__VA_ARGS__
)

	)

153 
	#SYSCALL_COMPAT_KPROBE1
(
«me
, ...Ë
	`SYSCALL_COMPAT_HOOKx
(1,
k¥obe
,
KPROBE
,
_
##«me,
__VA_ARGS__
)

	)

154 
	#SYSCALL_COMPAT_KPROBE2
(
«me
, ...Ë
	`SYSCALL_COMPAT_HOOKx
(2,
k¥obe
,
KPROBE
,
_
##«me,
__VA_ARGS__
)

	)

155 
	#SYSCALL_COMPAT_KPROBE3
(
«me
, ...Ë
	`SYSCALL_COMPAT_HOOKx
(3,
k¥obe
,
KPROBE
,
_
##«me,
__VA_ARGS__
)

	)

156 
	#SYSCALL_COMPAT_KPROBE4
(
«me
, ...Ë
	`SYSCALL_COMPAT_HOOKx
(4,
k¥obe
,
KPROBE
,
_
##«me,
__VA_ARGS__
)

	)

157 
	#SYSCALL_COMPAT_KPROBE5
(
«me
, ...Ë
	`SYSCALL_COMPAT_HOOKx
(5,
k¥obe
,
KPROBE
,
_
##«me,
__VA_ARGS__
)

	)

158 
	#SYSCALL_COMPAT_KPROBE6
(
«me
, ...Ë
	`SYSCALL_COMPAT_HOOKx
(6,
k¥obe
,
KPROBE
,
_
##«me,
__VA_ARGS__
)

	)

160 
	#SYSCALL_COMPAT_KRETPROBE
(
«me
, ...Ë
	`SYSCALL_COMPAT_HOOKx
(0,
kªçrobe
,
KRETPROBE
,
_
##«me)

	)

162 
	#SYSCALL_COMPAT_TIME_KPROBE0
(
«me
, ...Ë
	`SYSCALL_COMPAT_TIME_HOOKx
(0,
k¥obe
,
KPROBE
,
_
##«me,
__VA_ARGS__
)

	)

163 
	#SYSCALL_COMPAT_TIME_KPROBE1
(
«me
, ...Ë
	`SYSCALL_COMPAT_TIME_HOOKx
(1,
k¥obe
,
KPROBE
,
_
##«me,
__VA_ARGS__
)

	)

164 
	#SYSCALL_COMPAT_TIME_KPROBE2
(
«me
, ...Ë
	`SYSCALL_COMPAT_TIME_HOOKx
(2,
k¥obe
,
KPROBE
,
_
##«me,
__VA_ARGS__
)

	)

165 
	#SYSCALL_COMPAT_TIME_KPROBE3
(
«me
, ...Ë
	`SYSCALL_COMPAT_TIME_HOOKx
(3,
k¥obe
,
KPROBE
,
_
##«me,
__VA_ARGS__
)

	)

166 
	#SYSCALL_COMPAT_TIME_KPROBE4
(
«me
, ...Ë
	`SYSCALL_COMPAT_TIME_HOOKx
(4,
k¥obe
,
KPROBE
,
_
##«me,
__VA_ARGS__
)

	)

167 
	#SYSCALL_COMPAT_TIME_KPROBE5
(
«me
, ...Ë
	`SYSCALL_COMPAT_TIME_HOOKx
(5,
k¥obe
,
KPROBE
,
_
##«me,
__VA_ARGS__
)

	)

168 
	#SYSCALL_COMPAT_TIME_KPROBE6
(
«me
, ...Ë
	`SYSCALL_COMPAT_TIME_HOOKx
(6,
k¥obe
,
KPROBE
,
_
##«me,
__VA_ARGS__
)

	)

170 
	#SYSCALL_COMPAT_TIME_KRETPROBE
(
«me
, ...Ë
	`SYSCALL_COMPAT_TIME_HOOKx
(0,
kªçrobe
,
KRETPROBE
,
_
##«me)

	)

172 
	#TTY_NAME_LEN
 64

	)

173 
	#CONTAINER_ID_LEN
 64

	)

174 
	#MAX_XATTR_NAME_LEN
 200

	)

176 
	#bpf_¥ötk
(
fmt
, ...) \

178 
____fmt
[] = 
fmt
; \

179 
	`bpf_åa˚_¥ötk
(
____fmt
, (____fmt), \

180 ##
__VA_ARGS__
); \

181 })

	)

183 
	#IS_UNHANDLED_ERROR
(
ªtvÆ
ËªtvÆ < 0 &&ÑëvÆ !-
EACCES
 &&ÑëvÆ !-
EPERM


	)

184 
	#IS_ERR
(
±r
Ë(()’åË> ()(-1000))

	)

186 
	#IS_KTHREAD
(
µid
, 
pid
Ëµid =2 ||Öid =2

	)

188 
	eevít_ty≥


190 
	mEVENT_ANY
 = 0,

191 
	mEVENT_FIRST_DISCARDER
 = 1,

192 
	mEVENT_OPEN
 = 
EVENT_FIRST_DISCARDER
,

193 
	mEVENT_MKDIR
,

194 
	mEVENT_LINK
,

195 
	mEVENT_RENAME
,

196 
	mEVENT_UNLINK
,

197 
	mEVENT_RMDIR
,

198 
	mEVENT_CHMOD
,

199 
	mEVENT_CHOWN
,

200 
	mEVENT_UTIME
,

201 
	mEVENT_SETXATTR
,

202 
	mEVENT_REMOVEXATTR
,

203 
	mEVENT_LAST_DISCARDER
 = 
EVENT_REMOVEXATTR
,

205 
	mEVENT_MOUNT
,

206 
	mEVENT_UMOUNT
,

207 
	mEVENT_FORK
,

208 
	mEVENT_EXEC
,

209 
	mEVENT_EXIT
,

210 
	mEVENT_INVALIDATE_DENTRY
,

211 
	mEVENT_SETUID
,

212 
	mEVENT_SETGID
,

213 
	mEVENT_CAPSET
,

214 
	mEVENT_ARGS_ENVS
,

215 
	mEVENT_MOUNT_RELEASED
,

216 
	mEVENT_SELINUX
,

217 
	mEVENT_BPF
,

218 
	mEVENT_PTRACE
,

219 
	mEVENT_MMAP
,

220 
	mEVENT_MPROTECT
,

221 
	mEVENT_SIGNAL
,

222 
	mEVENT_MAX
,

224 
	mEVENT_ALL
 = 0xffffffffffffffff

227 
	skevít_t
 {

228 
u64
 
	m˝u
;

229 
u64
 
	mtime°amp
;

230 
u64
 
	mty≥
;

233 
	ssysˇŒ_t
 {

234 
s64
 
	mªtvÆ
;

237 
	s•™_c⁄ãxt_t
 {

238 
u64
 
	m•™_id
;

239 
u64
 
	måa˚_id
;

242 
	s¥o˚ss_c⁄ãxt_t
 {

243 
u32
 
	mpid
;

244 
u32
 
	mtid
;

247 
	sc⁄èöî_c⁄ãxt_t
 {

248 
	mc⁄èöî_id
[
CONTAINER_ID_LEN
];

251 
	efûe_Êags
 {

252 
	mLOWER_LAYER
 = 1 << 0,

253 
	mUPPER_LAYER
 = 1 << 1,

256 
	s∑th_key_t
 {

257 
u64
 
	möo
;

258 
u32
 
	mmou¡_id
;

259 
u32
 
	m∑th_id
;

262 
	sktimevÆ
 {

263 
	mtv_£c
;

264 
	mtv_n£c
;

267 
	sfûe_mëad©a_t
 {

268 
u32
 
	muid
;

269 
u32
 
	mgid
;

270 
u32
 
	m∆ök
;

271 
u16
 
	mmode
;

272 
	m∑ddög
[2];

274 
ktimevÆ
 
	m˘ime
;

275 
ktimevÆ
 
	mmtime
;

278 
	sfûe_t
 {

279 
∑th_key_t
 
	m∑th_key
;

280 
u32
 
	mÊags
;

281 
u32
 
	m∑ddög
;

282 
fûe_mëad©a_t
 
	mmëad©a
;

285 
	såa˚poöt_øw_sysˇŒs_sys_exô_t


287 
	mcomm⁄_ty≥
;

288 
	mcomm⁄_Êags
;

289 
	mcomm⁄_¥ìm±_cou¡
;

290 
	mcomm⁄_pid
;

292 
	mid
;

293 
	mªt
;

296 
	såa˚poöt_sysˇŒs_sys_exô_t
 {

297 
	mcomm⁄_ty≥
;

298 
	mcomm⁄_Êags
;

299 
	mcomm⁄_¥ìm±_cou¡
;

300 
	mcomm⁄_pid
;

302 
	m__sysˇŒ_ªt
;

303 
	mªt
;

306 
bpf_m≠_def
 
SEC
("m≠s/∑th_id"Ë
	g∑th_id
 = {

307 .
ty≥
 = 
BPF_MAP_TYPE_ARRAY
,

308 .
	gkey_size
 = (
u32
),

309 .
	gvÆue_size
 = (
u32
),

310 .
	gmax_íåõs
 = 1,

311 .
	gpönög
 = 0,

312 .
	g«me•a˚
 = "",

315 
__©åibuã__
((
Æways_ölöe
)Ë
u32
 
	$gë_∑th_id
(
övÆid©e
) {

316 
u32
 
key
 = 0;

318 
u32
 *
¥ev_id
 = 
	`bpf_m≠_lookup_ñem
(&
∑th_id
, &
key
);

319 i‡(!
¥ev_id
) {

323 
u32
 
id
 = *
¥ev_id
;

327 i‡(
övÆid©e
) {

328 
	`__sync_„tch_™d_add
(
¥ev_id
, 1);

331  
id
;

332 
	}
}

334 
bpf_m≠_def
 
SEC
("m≠s/Êushög_disˇrdîs"Ë
	gÊushög_disˇrdîs
 = {

335 .
ty≥
 = 
BPF_MAP_TYPE_ARRAY
,

336 .
	gkey_size
 = (
u32
),

337 .
	gvÆue_size
 = (
u32
),

338 .
	gmax_íåõs
 = 1,

339 .
	gpönög
 = 0,

340 .
	g«me•a˚
 = "",

343 
__©åibuã__
((
Æways_ölöe
)Ë
u32
 
	$is_Êushög_disˇrdîs
() {

344 
u32
 
key
 = 0;

345 
u32
 *
¥ev_id
 = 
	`bpf_m≠_lookup_ñem
(&
Êushög_disˇrdîs
, &
key
);

346  
¥ev_id
 !
NULL
 && *prev_id;

347 
	}
}

349 
	s≥rf_m≠_°©s_t
 {

350 
u64
 
	mbyãs
;

351 
u64
 
	mcou¡
;

352 
u64
 
	mlo°
;

355 
bpf_m≠_def
 
SEC
("m≠s/evíts"Ë
	gevíts
 = {

356 .
ty≥
 = 
BPF_MAP_TYPE_PERF_EVENT_ARRAY
,

357 .
	gkey_size
 = (
__u32
),

358 .
	gvÆue_size
 = (
__u32
),

359 .
	gmax_íåõs
 = 0,

360 .
	gpönög
 = 0,

361 .
	g«me•a˚
 = "",

364 
bpf_m≠_def
 
SEC
("m≠s/evíts_°©s"Ë
	gevíts_°©s
 = {

365 .
ty≥
 = 
BPF_MAP_TYPE_PERCPU_ARRAY
,

366 .
	gkey_size
 = (
u32
),

367 .
	gvÆue_size
 = (
≥rf_m≠_°©s_t
),

368 .
	gmax_íåõs
 = 
EVENT_MAX
,

369 .
	gpönög
 = 0,

370 .
	g«me•a˚
 = "",

373 
	#£nd_evít
(
˘x
, 
evít_ty≥
, 
kî√l_evít
) \

374 
kî√l_evít
.
evít
.
ty≥
 = 
evít_ty≥
; \

375 
kî√l_evít
.
evít
.
˝u
 = 
	`bpf_gë_smp_¥o˚ss‹_id
(); \

376 
kî√l_evít
.
evít
.
time°amp
 = 
	`bpf_ktime_gë_ns
(); \

378 
u64
 
size
 = (
kî√l_evít
); \

379 
≥rf_ªt
 = 
	`bpf_≥rf_evít_ouçut
(
˘x
, &
evíts
, 
kî√l_evít
.
evít
.
˝u
, &kî√l_evít, 
size
); \

381 i‡(
kî√l_evít
.
evít
.
ty≥
 < 
EVENT_MAX
) { \

382 
≥rf_m≠_°©s_t
 *
°©s
 = 
	`bpf_m≠_lookup_ñem
(&
evíts_°©s
, &
kî√l_evít
.
evít
.
ty≥
); \

383 i‡(
°©s
 !
NULL
) { \

384 i‡(!
≥rf_ªt
) { \

385 
	`__sync_„tch_™d_add
(&
°©s
->
byãs
, 
size
 + 4); \

386 
	`__sync_„tch_™d_add
(&
°©s
->
cou¡
, 1); \

388 
	`__sync_„tch_™d_add
(&
°©s
->
lo°
, 1); \

392 

	)

395 
__©åibuã__
((
Æways_ölöe
)Ë
bump_disˇrdî_ªvisi⁄
(
u32
 
mou¡_id
);

397 
	smou¡_ªÀa£d_evít_t
 {

398 
kevít_t
 
	mevít
;

399 
u32
 
	mmou¡_id
;

400 
u32
 
	mdisˇrdî_ªvisi⁄
;

403 
	smou¡_ªf_t
 {

404 
u32
 
	mumou¡ed
;

405 
s32
 
	mcou¡î
;

408 
bpf_m≠_def
 
SEC
("m≠s/mou¡_ªf"Ë
	gmou¡_ªf
 = {

409 .
ty≥
 = 
BPF_MAP_TYPE_LRU_HASH
,

410 .
	gkey_size
 = (
u32
),

411 .
	gvÆue_size
 = (
mou¡_ªf_t
),

412 .
	gmax_íåõs
 = 64000,

413 .
	gpönög
 = 0,

414 .
	g«me•a˚
 = "",

417 
__©åibuã__
((
Æways_ölöe
)Ë
	$öc_mou¡_ªf
(
u32
 
mou¡_id
) {

418 
u32
 
key
 = 
mou¡_id
;

419 
mou¡_ªf_t
 
zîo
 = {};

421 
	`bpf_m≠_upd©e_ñem
(&
mou¡_ªf
, &
key
, &
zîo
, 
BPF_NOEXIST
);

422 
mou¡_ªf_t
 *
ªf
 = 
	`bpf_m≠_lookup_ñem
(&
mou¡_ªf
, &
key
);

423 i‡(
ªf
) {

424 
	`__sync_„tch_™d_add
(&
ªf
->
cou¡î
, 1);

426 
	}
}

428 
__©åibuã__
((
Æways_ölöe
)Ë
	$dec_mou¡_ªf
(
±_ªgs
 *
˘x
, 
u32
 
mou¡_id
) {

429 
u32
 
key
 = 
mou¡_id
;

430 
mou¡_ªf_t
 *
ªf
 = 
	`bpf_m≠_lookup_ñem
(&
mou¡_ªf
, &
key
);

431 i‡(
ªf
) {

432 
	`__sync_„tch_™d_add
(&
ªf
->
cou¡î
, -1);

433 i‡(
ªf
->
cou¡î
 > 0 || !ªf->
umou¡ed
) {

436 
	`bpf_m≠_dñëe_ñem
(&
mou¡_ªf
, &
key
);

441 
mou¡_ªÀa£d_evít_t
 
evít
 = {

442 .
mou¡_id
 = mount_id,

443 .
disˇrdî_ªvisi⁄
 = 
	`bump_disˇrdî_ªvisi⁄
(
mou¡_id
),

446 
	`£nd_evít
(
˘x
, 
EVENT_MOUNT_RELEASED
, 
evít
);

447 
	}
}

449 
__©åibuã__
((
Æways_ölöe
)Ë
	$umou¡ed
(
±_ªgs
 *
˘x
, 
u32
 
mou¡_id
) {

450 
u32
 
key
 = 
mou¡_id
;

451 
mou¡_ªf_t
 *
ªf
 = 
	`bpf_m≠_lookup_ñem
(&
mou¡_ªf
, &
key
);

452 i‡(
ªf
) {

453 i‡(
ªf
->
cou¡î
 <= 0) {

454 
	`bpf_m≠_dñëe_ñem
(&
mou¡_ªf
, &
key
);

456 
ªf
->
umou¡ed
 = 1;

461 
mou¡_ªÀa£d_evít_t
 
evít
 = {

462 .
mou¡_id
 = mount_id,

463 .
disˇrdî_ªvisi⁄
 = 
	`bump_disˇrdî_ªvisi⁄
(
mou¡_id
),

465 
	`£nd_evít
(
˘x
, 
EVENT_MOUNT_RELEASED
, 
evít
);

466 
	}
}

468 
__©åibuã__
((
Æways_ölöe
)Ë
u32
 
	$‹d
(
u8
 
c
) {

469 i‡(
c
 >= 49 && c <= 57) {

470  
c
 - 48;

473 
	}
}

475 
	#CHAR_TO_UINT32_BASE_10_MAX_LEN
 11

	)

477 
__©åibuã__
((
Æways_ölöe
)Ë
u32
 
	$©oi
(*
buff
) {

478 
u32
 
ªs
 = 0;

479 
ba£_mu…ùlõr
 = 1;

480 
u8
 
c
 = 0;

481 
buf„r
[
CHAR_TO_UINT32_BASE_10_MAX_LEN
];

483 
size
 = 
	`bpf_¥obe_ªad_°r
(&
buf„r
, (buf„r), 
buff
);

484 i‡(
size
 <= 1) {

487 
u32
 
curs‹
 = 
size
 - 2;

489 #¥agm®
uƒﬁl


490 
i
 = 1; i < 
CHAR_TO_UINT32_BASE_10_MAX_LEN
; i++)

492 i‡(
curs‹
 < 0) {

493  
ªs
;

495 
	`bpf_¥obe_ªad
(&
c
, (c), 
buf„r
 + 
curs‹
);

496 
ªs
 +
	`‹d
(
c
Ë* 
ba£_mu…ùlõr
;

497 
ba£_mu…ùlõr
 = base_multiplier * 10;

498 
curs‹
--;

501  
ªs
;

502 
	}
}

505 
__©åibuã__
((
Æways_ölöe
)Ë
övÆid©e_öode
(
±_ªgs
 *
˘x
, 
u32
 
mou¡_id
, 
u64
 
öode
, 
£nd_övÆid©e_evít
);

507 
bpf_m≠_def
 
SEC
("m≠s/íabÀd_evíts"Ë
	gíabÀd_evíts
 = {

508 .
ty≥
 = 
BPF_MAP_TYPE_ARRAY
,

509 .
	gkey_size
 = (
u32
),

510 .
	gvÆue_size
 = (
u64
),

511 .
	gmax_íåõs
 = 1,

512 .
	gpönög
 = 0,

513 .
	g«me•a˚
 = "",

516 
__©åibuã__
((
Æways_ölöe
)Ë
u64
 
	$gë_íabÀd_evíts
() {

517 
u32
 
key
 = 0;

518 
u64
 *
mask
 = 
	`bpf_m≠_lookup_ñem
(&
íabÀd_evíts
, &
key
);

519 i‡(
mask
)

520  *
mask
;

522 
	}
}

524 
__©åibuã__
((
Æways_ölöe
)Ë
	$mask_has_evít
(
u64
 
mask
, 
evít_ty≥
 
evít
) {

525  
mask
 & (1 << (
evít
-
EVENT_FIRST_DISCARDER
));

526 
	}
}

528 
__©åibuã__
((
Æways_ölöe
)Ë
	$is_evít_íabÀd
(
evít_ty≥
 
evít
) {

529  
	`mask_has_evít
(
	`gë_íabÀd_evíts
(), 
evít
);

530 
	}
}

532 
__©åibuã__
((
Æways_ölöe
)Ë
	$add_evít_to_mask
(
u64
 *
mask
, 
evít_ty≥
 
evít
) {

533 i‡(
evít
 =
EVENT_ALL
) {

534 *
mask
 = 
evít
;

536 *
mask
 |1 << (
evít
 - 
EVENT_FIRST_DISCARDER
);

538 
	}
}

540 
	#VFS_ARG_POSITION1
 1

	)

541 
	#VFS_ARG_POSITION2
 2

	)

542 
	#VFS_ARG_POSITION3
 3

	)

543 
	#VFS_ARG_POSITION4
 4

	)

544 
	#VFS_ARG_POSITION5
 5

	)

545 
	#VFS_ARG_POSITION6
 6

	)

547 
__©åibuã__
((
Æways_ölöe
)Ë
u64
 
	$gë_vfs_u∆ök_díåy_posôi⁄
() {

548 
u64
 
vfs_u∆ök_díåy_posôi⁄
;

549 
	`LOAD_CONSTANT
("vfs_u∆ök_díåy_posôi⁄", 
vfs_u∆ök_díåy_posôi⁄
);

550  
vfs_u∆ök_díåy_posôi⁄
;

551 
	}
}

553 
__©åibuã__
((
Æways_ölöe
)Ë
u64
 
	$gë_vfs_mkdú_díåy_posôi⁄
() {

554 
u64
 
vfs_mkdú_díåy_posôi⁄
;

555 
	`LOAD_CONSTANT
("vfs_mkdú_díåy_posôi⁄", 
vfs_mkdú_díåy_posôi⁄
);

556  
vfs_mkdú_díåy_posôi⁄
;

557 
	}
}

559 
__©åibuã__
((
Æways_ölöe
)Ë
u64
 
	$gë_vfs_lök_èrgë_díåy_posôi⁄
() {

560 
u64
 
vfs_lök_èrgë_díåy_posôi⁄
;

561 
	`LOAD_CONSTANT
("vfs_lök_èrgë_díåy_posôi⁄", 
vfs_lök_èrgë_díåy_posôi⁄
);

562  
vfs_lök_èrgë_díåy_posôi⁄
;;

563 
	}
}

565 
__©åibuã__
((
Æways_ölöe
)Ë
u64
 
	$gë_vfs_£tx©å_díåy_posôi⁄
() {

566 
u64
 
vfs_£tx©å_díåy_posôi⁄
;

567 
	`LOAD_CONSTANT
("vfs_£tx©å_díåy_posôi⁄", 
vfs_£tx©å_díåy_posôi⁄
);

568  
vfs_£tx©å_díåy_posôi⁄
;

569 
	}
}

571 
__©åibuã__
((
Æways_ölöe
)Ë
u64
 
	$gë_vfs_ªmovex©å_díåy_posôi⁄
() {

572 
u64
 
vfs_ªmovex©å_díåy_posôi⁄
;

573 
	`LOAD_CONSTANT
("vfs_ªmovex©å_díåy_posôi⁄", 
vfs_ªmovex©å_díåy_posôi⁄
);

574  
vfs_ªmovex©å_díåy_posôi⁄
;

575 
	}
}

577 
	#VFS_RENAME_REGISTER_INPUT
 1

	)

578 
	#VFS_RENAME_STRUCT_INPUT
 2

	)

580 
__©åibuã__
((
Æways_ölöe
)Ë
u64
 
	$gë_vfs_ª«me_öput_ty≥
() {

581 
u64
 
vfs_ª«me_öput_ty≥
;

582 
	`LOAD_CONSTANT
("vfs_ª«me_öput_ty≥", 
vfs_ª«me_öput_ty≥
);

583  
vfs_ª«me_öput_ty≥
;

584 
	}
}

586 
__©åibuã__
((
Æways_ölöe
)Ë
u64
 
	$gë_vfs_ª«me_§c_díåy_off£t
() {

587 
u64
 
off£t
;

588 
	`LOAD_CONSTANT
("vfs_ª«me_§c_díåy_off£t", 
off£t
);

589  
off£t
 ? offset : 16;

590 
	}
}

592 
__©åibuã__
((
Æways_ölöe
)Ë
u64
 
	$gë_vfs_ª«me_èrgë_díåy_off£t
() {

593 
u64
 
off£t
;

594 
	`LOAD_CONSTANT
("vfs_ª«me_èrgë_díåy_off£t", 
off£t
);

595  
off£t
 ? offset : 40;

596 
	}
}

	@dentry.h

1 #i‚de‡
_DENTRY_H_


2 
	#_DENTRY_H_


	)

4 
	~<löux/dˇche.h
>

5 
	~<löux/ty≥s.h
>

6 
	~<löux/mou¡.h
>

7 
	~<löux/fs.h
>

9 
	~"defs.h
"

10 
	~"fûãrs.h
"

12 
	#MNT_OFFSETOF_MNT
 32

13 

	)

14 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_öode_öo
(
öode
 *inode) {

15 
öo
;

16 
	`bpf_¥obe_ªad
(&
öo
, (
öode
), &öode->
i_öo
);

17  
öo
;

18 
	}
}

20 
__©åibuã__
((
Æways_ölöe
)Ë
	$wrôe_öode_öo
(
öode
 *öode, 
u64
 *
öo
) {

21 
	`bpf_¥obe_ªad
(
öo
, (
öode
), &öode->
i_öo
);

22 
	}
}

24 
dev_t
 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_öode_dev
(
öode
 *inode) {

25 
dev_t
 
dev
;

26 
su≥r_block
 *
sb
;

27 
	`bpf_¥obe_ªad
(&
sb
, (sb), &
öode
->
i_sb
);

28 
	`bpf_¥obe_ªad
(&
dev
, (dev), &
sb
->
s_dev
);

29  
dev
;

30 
	}
}

32 
dev_t
 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_díåy_dev
(
díåy
 *dentry) {

33 
dev_t
 
dev
;

34 
su≥r_block
 *
sb
;

35 
	`bpf_¥obe_ªad
(&
sb
, (sb), &
díåy
->
d_sb
);

36 
	`bpf_¥obe_ªad
(&
dev
, (dev), &
sb
->
s_dev
);

37  
dev
;

38 
	}
}

40 
u32
 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_mou¡_off£t_of_mou¡_id
() {

41 
u64
 
off£t
;

42 
	`LOAD_CONSTANT
("mou¡_id_off£t", 
off£t
);

43  
off£t
 ? offset : 284;

44 
	}
}

46 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_vfsmou¡_mou¡_id
(
vfsmou¡
 *
m¡
) {

47 
mou¡_id
;

49 
	`bpf_¥obe_ªad
(&
mou¡_id
, (mou¡_id), (*)
m¡
 + 
	`gë_mou¡_off£t_of_mou¡_id
(Ë- 
MNT_OFFSETOF_MNT
);

50  
mou¡_id
;

51 
	}
}

53 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_∑th_mou¡_id
(
∑th
 *path) {

54 
vfsmou¡
 *
m¡
;

55 
	`bpf_¥obe_ªad
(&
m¡
, (m¡), &
∑th
->mnt);

56  
	`gë_vfsmou¡_mou¡_id
(
m¡
);

57 
	}
}

59 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_fûe_mou¡_id
(
fûe
 *file) {

60 
vfsmou¡
 *
m¡
;

61 
	`bpf_¥obe_ªad
(&
m¡
, (m¡), &
fûe
->
f_∑th
.mnt);

62  
	`gë_vfsmou¡_mou¡_id
(
m¡
);

63 
	}
}

66 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_mou¡_mou¡_id
(*
m¡
) {

67 
mou¡_id
;

70 
	`bpf_¥obe_ªad
(&
mou¡_id
, (mou¡_id), (*)
m¡
 + 
	`gë_mou¡_off£t_of_mou¡_id
());

71  
mou¡_id
;

72 
	}
}

74 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_mou¡_≥î_group_id
(*
m¡
) {

75 
mou¡_id
;

78 
	`bpf_¥obe_ªad
(&
mou¡_id
, (mou¡_id), (*)
m¡
 + 
	`gë_mou¡_off£t_of_mou¡_id
() + 4);

79  
mou¡_id
;

80 
	}
}

82 
vfsmou¡
 * 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_mou¡_vfsmou¡
(*
m¡
) {

83  (
vfsmou¡
 *)(
m¡
 + 32);

84 
	}
}

86 
díåy
 * 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_vfsmou¡_díåy
(
vfsmou¡
 *
m¡
) {

87 
díåy
 *dentry;

88 
	`bpf_¥obe_ªad
(&
díåy
, (díåy), &
m¡
->
m¡_roŸ
);

89  
díåy
;

90 
	}
}

92 
su≥r_block
 * 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_díåy_sb
(
díåy
 *dentry) {

93 
su≥r_block
 *
sb
;

94 
	`bpf_¥obe_ªad
(&
sb
, (sb), &
díåy
->
d_sb
);

95  
sb
;

96 
	}
}

98 
fûe_sy°em_ty≥
 * 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_su≥r_block_fs
(
su≥r_block
 *
sb
) {

99 
fûe_sy°em_ty≥
 *
fs
;

100 
	`bpf_¥obe_ªad
(&
fs
, (fs), &
sb
->
s_ty≥
);

101  
fs
;

102 
	}
}

104 
su≥r_block
 * 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_vfsmou¡_sb
(
vfsmou¡
 *
m¡
) {

105 
su≥r_block
 *
sb
;

106 
	`bpf_¥obe_ªad
(&
sb
, (sb), &
m¡
->
m¡_sb
);

107  
sb
;

108 
	}
}

110 
dev_t
 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_sb_dev
(
su≥r_block
 *
sb
) {

111 
dev_t
 
dev
;

112 
	`bpf_¥obe_ªad
(&
dev
, (dev), &
sb
->
s_dev
);

113  
dev
;

114 
	}
}

116 
díåy
 * 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_mou¡poöt_díåy
(*
m¡poöt
) {

117 
díåy
 *dentry;

120 
	`bpf_¥obe_ªad
(&
díåy
, (díåy), (*)
m¡poöt
 + 16);

121  
díåy
;

122 
	}
}

124 
dev_t
 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_vfsmou¡_dev
(
vfsmou¡
 *
m¡
) {

125  
	`gë_sb_dev
(
	`gë_vfsmou¡_sb
(
m¡
));

126 
	}
}

128 
dev_t
 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_mou¡_dev
(*
m¡
) {

129  
	`gë_vfsmou¡_dev
(
	`gë_mou¡_vfsmou¡
(
m¡
));

130 
	}
}

132 
öode
* 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_díåy_öode
(
díåy
 *dentry) {

133 
öode
 *
d_öode
;

134 
	`bpf_¥obe_ªad
(&
d_öode
, (d_öode), &
díåy
->d_inode);

135  
d_öode
;

136 
	}
}

138 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_díåy_öo
(
díåy
 *dentry) {

139  
	`gë_öode_öo
(
	`gë_díåy_öode
(
díåy
));

140 
	}
}

142 
__©åibuã__
((
Æways_ölöe
)Ë
	$fûl_fûe_mëad©a
(
díåy
* díåy, 
fûe_mëad©a_t
* 
fûe
) {

143 
öode
 *
d_öode
;

144 
	`bpf_¥obe_ªad
(&
d_öode
, (d_öode), &
díåy
->d_inode);

146 
	`bpf_¥obe_ªad
(&
fûe
->
∆ök
, (fûe->∆ök), (*)&
d_öode
->
i_∆ök
);

147 
	`bpf_¥obe_ªad
(&
fûe
->
mode
, (fûe->mode), &
d_öode
->
i_mode
);

148 
	`bpf_¥obe_ªad
(&
fûe
->
uid
, (fûe->uid), &
d_öode
->
i_uid
);

149 
	`bpf_¥obe_ªad
(&
fûe
->
gid
, (fûe->gid), &
d_öode
->
i_gid
);

151 
	`bpf_¥obe_ªad
(&
fûe
->
˘ime
, (fûe->˘ime), &
d_öode
->
i_˘ime
);

152 
	`bpf_¥obe_ªad
(&
fûe
->
mtime
, (fûe->mtime), &
d_öode
->
i_mtime
);

153 
	}
}

155 
__©åibuã__
((
Æways_ölöe
)Ë
	$wrôe_díåy_öode
(
díåy
 *díåy, 
öode
 **
d_öode
) {

156 
	`bpf_¥obe_ªad
(
d_öode
, (d_öode), &
díåy
->d_inode);

157 
	}
}

159 
díåy
* 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_fûe_díåy
(
fûe
 *file) {

160 
díåy
 *
f_díåy
;

161 
	`bpf_¥obe_ªad
(&
f_díåy
, (f_díåy), &
fûe
->
f_∑th
.
díåy
);

162  
f_díåy
;

163 
	}
}

165 
díåy
* 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_∑th_díåy
(
∑th
 *path) {

166 
díåy
 *dentry;

167 
	`bpf_¥obe_ªad
(&
díåy
, (díåy), &
∑th
->dentry);

168  
díåy
;

169 
	}
}

171 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_∑th_öo
(
∑th
 *path) {

172 
díåy
 *dentry;

173 
	`bpf_¥obe_ªad
(&
díåy
, (díåy), &
∑th
->dentry);

175 i‡(
díåy
) {

176  
	`gë_díåy_öo
(
díåy
);

179 
	}
}

181 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_díåy_«me
(
díåy
 *díåy, *
buf„r
, 
size_t
 
n
) {

182 
q°r
 qstr;

183 
	`bpf_¥obe_ªad
(&
q°r
, (q°r), &
díåy
->
d_«me
);

184 
	`bpf_¥obe_ªad_°r
(
buf„r
, 
n
, (*)
q°r
.
«me
);

185 
	}
}

187 
	#gë_díåy_key_∑th
(
díåy
, 
∑th
Ë(
∑th_key_t
Ë{ .
öo
 = 
	`gë_díåy_öo
(díåy), .
mou¡_id
 = 
	`gë_∑th_mou¡_id
’©hË}

	)

188 
	#gë_öode_key_∑th
(
öode
, 
∑th
Ë(
∑th_key_t
Ë{ .
öo
 = 
	`gë_öode_öo
(öode), .
mou¡_id
 = 
	`gë_∑th_mou¡_id
’©hË}

	)

190 
is_ovîœyfs
(
díåy
 *dentry);

191 
£t_ovîœyfs_öo
(
díåy
 *díåy, 
u64
 *
öo
, 
u32
 *
Êags
);

193 
__©åibuã__
((
Æways_ölöe
)Ë
	$£t_fûe_öode
(
díåy
 *díåy, 
fûe_t
 *
fûe
, 
övÆid©e
) {

194 
fûe
->
∑th_key
.
∑th_id
 = 
	`gë_∑th_id
(
övÆid©e
);

195 i‡(!
fûe
->
∑th_key
.
öo
) {

196 
fûe
->
∑th_key
.
öo
 = 
	`gë_díåy_öo
(
díåy
);

199 i‡(
	`is_ovîœyfs
(
díåy
)) {

200 
	`£t_ovîœyfs_öo
(
díåy
, &
fûe
->
∑th_key
.
öo
, &fûe->
Êags
);

202 
	}
}

	@dentry_resolver.h

1 #i‚de‡
_DENTRY_RESOLVER_H_


2 
	#_DENTRY_RESOLVER_H_


	)

4 
	~<löux/dˇche.h
>

5 
	~<löux/ty≥s.h
>

6 
	~<löux/mou¡.h
>

7 
	~<löux/fs.h
>

9 
	~"defs.h
"

10 
	~"fûãrs.h
"

11 
	~"díåy.h
"

13 
	#DENTRY_INVALID
 -1

	)

14 
	#DENTRY_DISCARDED
 -2

	)

16 
	#FAKE_INODE_MSW
 0xdódc001UL

	)

18 
	#DR_MAX_TAIL_CALL
 30

	)

19 
	#DR_MAX_ITERATION_DEPTH
 50

	)

20 
	#DR_MAX_SEGMENT_LENGTH
 255

	)

22 
	s∑th_Àaf_t
 {

23 
∑th_key_t
 
	m∑ª¡
;

24 
	m«me
[
DR_MAX_SEGMENT_LENGTH
 + 1];

25 
u16
 
	mÀn
;

28 
bpf_m≠_def
 
SEC
("m≠s/∑th«mes"Ë
	g∑th«mes
 = {

29 .
ty≥
 = 
BPF_MAP_TYPE_LRU_HASH
,

30 .
	gkey_size
 = (
∑th_key_t
),

31 .
	gvÆue_size
 = (
∑th_Àaf_t
),

32 .
	gmax_íåõs
 = 64000,

33 .
	gpönög
 = 0,

34 .
	g«me•a˚
 = "",

37 
	#DR_NO_CALLBACK
 -1

	)

39 
	edr_k¥obe_¥ogs


41 
	mDR_OPEN_CALLBACK_KPROBE_KEY
 = 1,

42 
	mDR_SETATTR_CALLBACK_KPROBE_KEY
,

43 
	mDR_MKDIR_CALLBACK_KPROBE_KEY
,

44 
	mDR_MOUNT_CALLBACK_KPROBE_KEY
,

45 
	mDR_SECURITY_INODE_RMDIR_CALLBACK_KPROBE_KEY
,

46 
	mDR_SETXATTR_CALLBACK_KPROBE_KEY
,

47 
	mDR_UNLINK_CALLBACK_KPROBE_KEY
,

48 
	mDR_LINK_SRC_CALLBACK_KPROBE_KEY
,

49 
	mDR_LINK_DST_CALLBACK_KPROBE_KEY
,

50 
	mDR_RENAME_CALLBACK_KPROBE_KEY
,

51 
	mDR_SELINUX_CALLBACK_KPROBE_KEY
,

54 
bpf_m≠_def
 
SEC
("m≠s/díåy_ªsﬁvî_k¥obe_ˇŒbacks"Ë
	gdíåy_ªsﬁvî_k¥obe_ˇŒbacks
 = {

55 .
ty≥
 = 
BPF_MAP_TYPE_PROG_ARRAY
,

56 .
	gkey_size
 = (
u32
),

57 .
	gvÆue_size
 = (
u32
),

58 .
	gmax_íåõs
 = 
EVENT_MAX
,

61 
	edr_åa˚poöt_¥ogs


63 
	mDR_OPEN_CALLBACK_TRACEPOINT_KEY
 = 1,

64 
	mDR_MKDIR_CALLBACK_TRACEPOINT_KEY
,

65 
	mDR_MOUNT_CALLBACK_TRACEPOINT_KEY
,

66 
	mDR_LINK_DST_CALLBACK_TRACEPOINT_KEY
,

67 
	mDR_RENAME_CALLBACK_TRACEPOINT_KEY
,

70 
bpf_m≠_def
 
SEC
("m≠s/díåy_ªsﬁvî_åa˚poöt_ˇŒbacks"Ë
	gdíåy_ªsﬁvî_åa˚poöt_ˇŒbacks
 = {

71 .
ty≥
 = 
BPF_MAP_TYPE_PROG_ARRAY
,

72 .
	gkey_size
 = (
u32
),

73 .
	gvÆue_size
 = (
u32
),

74 .
	gmax_íåõs
 = 
EVENT_MAX
,

77 
	#DR_KPROBE
 1

	)

78 
	#DR_TRACEPOINT
 2

	)

80 
	#DR_ERPC_KEY
 0

	)

81 
	#DR_ERPC_PARENT_KEY
 1

	)

82 
	#DR_ERPC_SEGMENT_KEY
 2

	)

83 
	#DR_KPROBE_DENTRY_RESOLVER_KERN_KEY
 3

	)

85 
bpf_m≠_def
 
SEC
("m≠s/díåy_ªsﬁvî_k¥obe_¥ogs"Ë
	gdíåy_ªsﬁvî_k¥obe_¥ogs
 = {

86 .
ty≥
 = 
BPF_MAP_TYPE_PROG_ARRAY
,

87 .
	gkey_size
 = (
u32
),

88 .
	gvÆue_size
 = (
u32
),

89 .
	gmax_íåõs
 = 4,

92 
	#DR_TRACEPOINT_DENTRY_RESOLVER_KERN_KEY
 0

	)

94 
bpf_m≠_def
 
SEC
("m≠s/díåy_ªsﬁvî_åa˚poöt_¥ogs"Ë
	gdíåy_ªsﬁvî_åa˚poöt_¥ogs
 = {

95 .
ty≥
 = 
BPF_MAP_TYPE_PROG_ARRAY
,

96 .
	gkey_size
 = (
u32
),

97 .
	gvÆue_size
 = (
u32
),

98 .
	gmax_íåõs
 = 1,

101 
__©åibuã__
((
Æways_ölöe
)Ë
	$ªsﬁve_díåy_èû_ˇŒ
(
díåy_ªsﬁvî_öput_t
 *
öput
) {

102 
∑th_Àaf_t
 
m≠_vÆue
 = {};

103 
∑th_key_t
 
key
 = 
öput
->key;

104 
∑th_key_t
 
√xt_key
 = 
öput
->
key
;

105 
q°r
 qstr;

106 
díåy
 *díåy = 
öput
->dentry;

107 
díåy
 *
d_∑ª¡
;

108 
öode
 *
d_öode
 = 
NULL
;

109 
£gmít_Àn
 = 0;

111 i‡(
key
.
öo
 =0 || key.
mou¡_id
 == 0) {

112  
DENTRY_INVALID
;

118 #¥agm®
uƒﬁl


119 
i
 = 0; i < 
DR_MAX_ITERATION_DEPTH
; i++)

121 
d_∑ª¡
 = 
NULL
;

122 
	`bpf_¥obe_ªad
(&
d_∑ª¡
, (d_∑ª¡), &
díåy
->d_parent);

124 
key
 = 
√xt_key
;

125 i‡(
díåy
 !
d_∑ª¡
) {

126 
	`wrôe_díåy_öode
(
d_∑ª¡
, &
d_öode
);

127 
	`wrôe_öode_öo
(
d_öode
, &
√xt_key
.
öo
);

129 
√xt_key
.
öo
 = 0;

130 
√xt_key
.
mou¡_id
 = 0;

133 i‡(
öput
->
disˇrdî_ty≥
 && 
i
 <= 3) {

134 i‡(
	`is_disˇrded_by_öode
(
öput
->
disˇrdî_ty≥
, 
key
.
mou¡_id
, key.
öo
, 
i
 == 0)) {

135  
DENTRY_DISCARDED
;

139 
	`bpf_¥obe_ªad
(&
q°r
, (q°r), &
díåy
->
d_«me
);

140 
£gmít_Àn
 = 
	`bpf_¥obe_ªad_°r
(&
m≠_vÆue
.
«me
, (m≠_vÆue.«me), (*)
q°r
.name);

141 i‡(
£gmít_Àn
 > 0) {

142 
m≠_vÆue
.
Àn
 = (
u16
Ë
£gmít_Àn
;

144 
m≠_vÆue
.
Àn
 = 0;

147 i‡(
m≠_vÆue
.
«me
[0] == '/' || map_value.name[0] == 0) {

148 
m≠_vÆue
.
«me
[0] = '/';

149 
√xt_key
.
öo
 = 0;

150 
√xt_key
.
mou¡_id
 = 0;

153 
m≠_vÆue
.
∑ª¡
 = 
√xt_key
;

155 
	`bpf_m≠_upd©e_ñem
(&
∑th«mes
, &
key
, &
m≠_vÆue
, 
BPF_ANY
);

157 
díåy
 = 
d_∑ª¡
;

158 i‡(
√xt_key
.
öo
 == 0) {

159 
öput
->
díåy
 = 
d_∑ª¡
;

160 
öput
->
key
 = 
√xt_key
;

161  
i
 + 1;

165 i‡(
öput
->
ôî©i⁄
 =
DR_MAX_TAIL_CALL
) {

166 
m≠_vÆue
.
«me
[0] = 0;

167 
m≠_vÆue
.
∑ª¡
.
mou¡_id
 = 0;

168 
m≠_vÆue
.
∑ª¡
.
öo
 = 0;

169 
	`bpf_m≠_upd©e_ñem
(&
∑th«mes
, &
√xt_key
, &
m≠_vÆue
, 
BPF_ANY
);

173 
öput
->
díåy
 = 
d_∑ª¡
;

174 
öput
->
key
 = 
√xt_key
;

175  
DR_MAX_ITERATION_DEPTH
;

176 
	}
}

178 
	#díåy_ªsﬁvî_kîn
(
˘x
, 
¥ogs_m≠
, 
ˇŒbacks_m≠
, 
díåy_ªsﬁvî_kîn_key
) \

179 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
EVENT_ANY
); \

180 i‡(!
sysˇŒ
) \

183 
sysˇŒ
->
ªsﬁvî
.
ôî©i⁄
++; \

184 
sysˇŒ
->
ªsﬁvî
.
ªt
 = 
	`ªsﬁve_díåy_èû_ˇŒ
(&syscall->resolver); \

186 i‡(
sysˇŒ
->
ªsﬁvî
.
ªt
 > 0) { \

187 i‡(
sysˇŒ
->
ªsﬁvî
.
ôî©i⁄
 < 
DR_MAX_TAIL_CALL
 && sysˇŒ->ªsﬁvî.
key
.
öo
 != 0) { \

188 
	`bpf_èû_ˇŒ_com∑t
(
˘x
, 
¥ogs_m≠
, 
díåy_ªsﬁvî_kîn_key
); \

191 
sysˇŒ
->
ªsﬁvî
.
ªt
 +
DR_MAX_ITERATION_DEPTH
 * (sysˇŒ->ªsﬁvî.
ôî©i⁄
 - 1); \

194 i‡(
sysˇŒ
->
ªsﬁvî
.
ˇŒback
 >= 0) { \

195 
	`bpf_èû_ˇŒ_com∑t
(
˘x
, 
ˇŒbacks_m≠
, 
sysˇŒ
->
ªsﬁvî
.
ˇŒback
); \

197 

	)

198 
SEC
("kprobe/dentry_resolver_kern")

199 
	$k¥obe_díåy_ªsﬁvî_kîn
(
±_ªgs
 *
˘x
) {

200 
	`díåy_ªsﬁvî_kîn
(
˘x
, &
díåy_ªsﬁvî_k¥obe_¥ogs
, &
díåy_ªsﬁvî_k¥obe_ˇŒbacks
, 
DR_KPROBE_DENTRY_RESOLVER_KERN_KEY
);

202 
	}
}

204 
SEC
("tracepoint/dentry_resolver_kern")

205 
	$åa˚poöt_díåy_ªsﬁvî_kîn
(*
˘x
) {

206 
	`díåy_ªsﬁvî_kîn
(
˘x
, &
díåy_ªsﬁvî_åa˚poöt_¥ogs
, &
díåy_ªsﬁvî_åa˚poöt_ˇŒbacks
, 
DR_TRACEPOINT_DENTRY_RESOLVER_KERN_KEY
);

208 
	}
}

210 
	sdr_îpc_°©e_t
 {

211 *
	mu£r•a˚_buf„r
;

212 
∑th_key_t
 
	mkey
;

213 
	mªt
;

214 
	môî©i⁄
;

215 
u32
 
	mbuf„r_size
;

216 
u32
 
	mchÆÀnge
;

217 
u16
 
	mcurs‹
;

220 
bpf_m≠_def
 
SEC
("m≠s/dr_îpc_°©e"Ë
	gdr_îpc_°©e
 = {

221 .
ty≥
 = 
BPF_MAP_TYPE_ARRAY
,

222 .
	gkey_size
 = (
u32
),

223 .
	gvÆue_size
 = (
dr_îpc_°©e_t
),

224 .
	gmax_íåõs
 = 1,

225 .
	gpönög
 = 0,

226 .
	g«me•a˚
 = "",

229 
	#DR_ERPC_OK
 0

	)

230 
	#DR_ERPC_CACHE_MISS
 1

	)

231 
	#DR_ERPC_BUFFER_SIZE
 2

	)

232 
	#DR_ERPC_WRITE_PAGE_FAULT
 3

	)

233 
	#DR_ERPC_TAIL_CALL_ERROR
 4

	)

234 
	#DR_ERPC_READ_PAGE_FAULT
 5

	)

235 
	#DR_ERPC_UNKNOWN_ERROR
 6

	)

237 
	sdr_îpc_°©s_t
 {

238 
u64
 
	mcou¡
;

241 
bpf_m≠_def
 
SEC
("m≠s/dr_îpc_°©s_fb"Ë
	gdr_îpc_°©s_fb
 = {

242 .
ty≥
 = 
BPF_MAP_TYPE_PERCPU_ARRAY
,

243 .
	gkey_size
 = (
u32
),

244 .
	gvÆue_size
 = (
dr_îpc_°©s_t
),

245 .
	gmax_íåõs
 = 6,

246 .
	gpönög
 = 0,

247 .
	g«me•a˚
 = "",

250 
bpf_m≠_def
 
SEC
("m≠s/dr_îpc_°©s_bb"Ë
	gdr_îpc_°©s_bb
 = {

251 .
ty≥
 = 
BPF_MAP_TYPE_PERCPU_ARRAY
,

252 .
	gkey_size
 = (
u32
),

253 .
	gvÆue_size
 = (
dr_îpc_°©s_t
),

254 .
	gmax_íåõs
 = 6,

255 .
	gpönög
 = 0,

256 .
	g«me•a˚
 = "",

259 
__©åibuã__
((
Æways_ölöe
)Ë
	$m⁄ô‹_ªsﬁuti⁄_îr
(
u32
 
ªsﬁuti⁄_îr
) {

260 i‡(
ªsﬁuti⁄_îr
 > 0) {

261 
bpf_m≠_def
 *
îpc_°©s
 = 
	`£À˘_buf„r
(&
dr_îpc_°©s_fb
, &
dr_îpc_°©s_bb
, 
ERPC_MONITOR_KEY
);

262 i‡(
îpc_°©s
 =
NULL
) {

266 
dr_îpc_°©s_t
 *
°©s
 = 
	`bpf_m≠_lookup_ñem
(
îpc_°©s
, &
ªsﬁuti⁄_îr
);

267 i‡(
°©s
 =
NULL
) {

270 
	`__sync_„tch_™d_add
(&
°©s
->
cou¡
, 1);

273 
	}
}

275 
u32
 
__©åibuã__
((
Æways_ölöe
)Ë
	$∑r£_îpc_ªque°
(
dr_îpc_°©e_t
 *
°©e
, *
d©a
) {

276 
u32
 
îr
 = 0;

277 
ªt
 = 
	`bpf_¥obe_ªad
(&
°©e
->
key
, (°©e->key), 
d©a
);

278 i‡(
ªt
 < 0) {

279 
îr
 = 
DR_ERPC_READ_PAGE_FAULT
;

280 
exô
;

282 
ªt
 = 
	`bpf_¥obe_ªad
(&
°©e
->
u£r•a˚_buf„r
, (°©e->u£r•a˚_buf„r), 
d©a
 + (°©e->
key
));

283 i‡(
ªt
 < 0) {

284 
îr
 = 
DR_ERPC_READ_PAGE_FAULT
;

285 
exô
;

287 
ªt
 = 
	`bpf_¥obe_ªad
(&
°©e
->
buf„r_size
, (°©e->buf„r_size), 
d©a
 + (°©e->
key
Ë+ (°©e->
u£r•a˚_buf„r
));

288 i‡(
ªt
 < 0) {

289 
îr
 = 
DR_ERPC_READ_PAGE_FAULT
;

290 
exô
;

292 
ªt
 = 
	`bpf_¥obe_ªad
(&
°©e
->
chÆÀnge
, (°©e->chÆÀnge), 
d©a
 + (°©e->
key
Ë+ (°©e->
u£r•a˚_buf„r
Ë+ (°©e->
buf„r_size
));

293 i‡(
ªt
 < 0) {

294 
îr
 = 
DR_ERPC_READ_PAGE_FAULT
;

295 
exô
;

298 
°©e
->
ôî©i⁄
 = 0;

299 
°©e
->
ªt
 = 0;

300 
°©e
->
curs‹
 = 0;

302 
exô
:

303  
îr
;

304 
	}
}

306 
SEC
("kprobe/dentry_resolver_erpc")

307 
	$k¥obe_díåy_ªsﬁvî_îpc
(
±_ªgs
 *
˘x
) {

308 
u32
 
key
 = 0;

309 
u32
 
ªsﬁuti⁄_îr
 = 0;

310 
∑th_Àaf_t
 *
m≠_vÆue
 = 0;

311 
∑th_key_t
 
ôî©i⁄_key
 = {};

313 
dr_îpc_°©e_t
 *
°©e
 = 
	`bpf_m≠_lookup_ñem
(&
dr_îpc_°©e
, &
key
);

314 i‡(
°©e
 =
NULL
) {

318 
°©e
->
ôî©i⁄
++;

320 #¥agm®
uƒﬁl


321 
i
 = 0; i < 
DR_MAX_ITERATION_DEPTH
; i++)

323 
ôî©i⁄_key
 = 
°©e
->
key
;

324 
m≠_vÆue
 = 
	`bpf_m≠_lookup_ñem
(&
∑th«mes
, &
ôî©i⁄_key
);

325 i‡(
m≠_vÆue
 =
NULL
) {

326 
ªsﬁuti⁄_îr
 = 
DR_ERPC_CACHE_MISS
;

327 
exô
;

331 i‡(
°©e
->
curs‹
 + (°©e->
key
Ë>°©e->
buf„r_size
) {

332 
ªsﬁuti⁄_îr
 = 
DR_ERPC_BUFFER_SIZE
;

333 
exô
;

336 
°©e
->
ªt
 = 
	`bpf_¥obe_wrôe_u£r
((*Ë°©e->
u£r•a˚_buf„r
 + sèã->
curs‹
, &°©e->
key
, (state->key));

337 i‡(
°©e
->
ªt
 < 0) {

338 
ªsﬁuti⁄_îr
 = 
°©e
->
ªt
 =-14 ? 
DR_ERPC_WRITE_PAGE_FAULT
 : 
DR_ERPC_UNKNOWN_ERROR
;

339 
exô
;

341 
°©e
->
ªt
 = 
	`bpf_¥obe_wrôe_u£r
((*Ë°©e->
u£r•a˚_buf„r
 + sèã->
curs‹
 + 
	`off£tof
(
∑th_key_t
, 
∑th_id
), &°©e->
chÆÀnge
, (state->challenge));

342 i‡(
°©e
->
ªt
 < 0) {

343 
ªsﬁuti⁄_îr
 = 
°©e
->
ªt
 =-14 ? 
DR_ERPC_WRITE_PAGE_FAULT
 : 
DR_ERPC_UNKNOWN_ERROR
;

344 
exô
;

347 
°©e
->
curs‹
 +(°©e->
key
);

350 i‡(
°©e
->
curs‹
 + 
m≠_vÆue
->
Àn
 >°©e->
buf„r_size
) {

351 
ªsﬁuti⁄_îr
 = 
DR_ERPC_BUFFER_SIZE
;

352 
exô
;

355 
°©e
->
ªt
 = 
	`bpf_¥obe_wrôe_u£r
((*Ë°©e->
u£r•a˚_buf„r
 + sèã->
curs‹
, 
m≠_vÆue
->
«me
, 
DR_MAX_SEGMENT_LENGTH
 + 1);

356 i‡(
°©e
->
ªt
 < 0) {

357 
ªsﬁuti⁄_îr
 = 
°©e
->
ªt
 =-14 ? 
DR_ERPC_WRITE_PAGE_FAULT
 : 
DR_ERPC_UNKNOWN_ERROR
;

358 
exô
;

361 
°©e
->
curs‹
 +
m≠_vÆue
->
Àn
;

363 
°©e
->
key
.
öo
 = 
m≠_vÆue
->
∑ª¡
.ino;

364 
°©e
->
key
.
∑th_id
 = 
m≠_vÆue
->
∑ª¡
.path_id;

365 
°©e
->
key
.
mou¡_id
 = 
m≠_vÆue
->
∑ª¡
.mount_id;

366 i‡(
°©e
->
key
.
öo
 == 0)

367 
exô
;

369 i‡(
°©e
->
ôî©i⁄
 < 
DR_MAX_TAIL_CALL
) {

370 
	`bpf_èû_ˇŒ_com∑t
(
˘x
, &
díåy_ªsﬁvî_k¥obe_¥ogs
, 
DR_ERPC_KEY
);

371 
ªsﬁuti⁄_îr
 = 
DR_ERPC_TAIL_CALL_ERROR
;

374 
exô
:

375 
	`m⁄ô‹_ªsﬁuti⁄_îr
(
ªsﬁuti⁄_îr
);

377 
	}
}

379 
SEC
("kprobe/dentry_resolver_segment_erpc")

380 
	$k¥obe_díåy_ªsﬁvî_£gmít_îpc
(
±_ªgs
 *
˘x
) {

381 
u32
 
key
 = 0;

382 
u32
 
ªsﬁuti⁄_îr
 = 0;

383 
dr_îpc_°©e_t
 *
°©e
 = 
	`bpf_m≠_lookup_ñem
(&
dr_îpc_°©e
, &
key
);

384 i‡(
°©e
 =
NULL
) {

389 
∑th_key_t
 
∑th_key
 = 
°©e
->
key
;

390 
∑th_Àaf_t
 *
m≠_vÆue
 = 
	`bpf_m≠_lookup_ñem
(&
∑th«mes
, &
∑th_key
);

391 i‡(
m≠_vÆue
 =
NULL
) {

392 
ªsﬁuti⁄_îr
 = 
DR_ERPC_CACHE_MISS
;

393 
exô
;

396 i‡(
m≠_vÆue
->
Àn
 + (
key
Ë> 
°©e
->
buf„r_size
) {

398 
ªsﬁuti⁄_îr
 = 
DR_ERPC_BUFFER_SIZE
;

399 
exô
;

402 
ªt
 = 
	`bpf_¥obe_wrôe_u£r
((*Ë
°©e
->
u£r•a˚_buf„r
, &°©e->
key
, (state->key));

403 i‡(
ªt
 < 0) {

404 
ªsﬁuti⁄_îr
 = 
ªt
 =-14 ? 
DR_ERPC_WRITE_PAGE_FAULT
 : 
DR_ERPC_UNKNOWN_ERROR
;

405 
exô
;

407 
ªt
 = 
	`bpf_¥obe_wrôe_u£r
((*Ë
°©e
->
u£r•a˚_buf„r
 + 
	`off£tof
(
∑th_key_t
, 
∑th_id
), &°©e->
chÆÀnge
, (state->challenge));

408 i‡(
ªt
 < 0) {

409 
ªsﬁuti⁄_îr
 = 
ªt
 =-14 ? 
DR_ERPC_WRITE_PAGE_FAULT
 : 
DR_ERPC_UNKNOWN_ERROR
;

410 
exô
;

413 
ªt
 = 
	`bpf_¥obe_wrôe_u£r
((*Ë
°©e
->
u£r•a˚_buf„r
 + (°©e->
key
), 
m≠_vÆue
->
«me
, 
DR_MAX_SEGMENT_LENGTH
 + 1);

414 i‡(
ªt
 < 0) {

415 
ªsﬁuti⁄_îr
 = 
ªt
 =-14 ? 
DR_ERPC_WRITE_PAGE_FAULT
 : 
DR_ERPC_UNKNOWN_ERROR
;

416 
exô
;

419 
exô
:

420 
	`m⁄ô‹_ªsﬁuti⁄_îr
(
ªsﬁuti⁄_îr
);

422 
	}
}

424 
SEC
("kprobe/dentry_resolver_parent_erpc")

425 
	$k¥obe_díåy_ªsﬁvî_∑ª¡_îpc
(
±_ªgs
 *
˘x
) {

426 
u32
 
key
 = 0;

427 
u32
 
ªsﬁuti⁄_îr
 = 0;

428 
dr_îpc_°©e_t
 *
°©e
 = 
	`bpf_m≠_lookup_ñem
(&
dr_îpc_°©e
, &
key
);

429 i‡(
°©e
 =
NULL
) {

434 
∑th_key_t
 
∑th_key
 = 
°©e
->
key
;

435 
∑th_Àaf_t
 *
m≠_vÆue
 = 
	`bpf_m≠_lookup_ñem
(&
∑th«mes
, &
∑th_key
);

436 i‡(
m≠_vÆue
 =
NULL
) {

437 
ªsﬁuti⁄_îr
 = 
DR_ERPC_CACHE_MISS
;

438 
exô
;

441 i‡((
m≠_vÆue
->
∑ª¡
Ë> 
°©e
->
buf„r_size
) {

443 
ªsﬁuti⁄_îr
 = 
DR_ERPC_BUFFER_SIZE
;

444 
exô
;

447 
ªt
 = 
	`bpf_¥obe_wrôe_u£r
((*Ë
°©e
->
u£r•a˚_buf„r
, &
m≠_vÆue
->
∑ª¡
, (map_value->parent));

448 i‡(
ªt
 < 0) {

449 
ªsﬁuti⁄_îr
 = 
ªt
 =-14 ? 
DR_ERPC_WRITE_PAGE_FAULT
 : 
DR_ERPC_UNKNOWN_ERROR
;

450 
exô
;

452 
ªt
 = 
	`bpf_¥obe_wrôe_u£r
((*Ë
°©e
->
u£r•a˚_buf„r
 + 
	`off£tof
(
∑th_key_t
, 
∑th_id
), &°©e->
chÆÀnge
, (state->challenge));

453 i‡(
ªt
 < 0) {

454 
ªsﬁuti⁄_îr
 = 
ªt
 =-14 ? 
DR_ERPC_WRITE_PAGE_FAULT
 : 
DR_ERPC_UNKNOWN_ERROR
;

455 
exô
;

458 
exô
:

459 
	`m⁄ô‹_ªsﬁuti⁄_îr
(
ªsﬁuti⁄_îr
);

461 
	}
}

463 
__©åibuã__
((
Æways_ölöe
)Ë
	$h™dÀ_dr_ªque°
(
±_ªgs
 *
˘x
, *
d©a
, 
u32
 
dr_îpc_key
) {

464 
u32
 
key
 = 0;

465 
dr_îpc_°©e_t
 *
°©e
 = 
	`bpf_m≠_lookup_ñem
(&
dr_îpc_°©e
, &
key
);

466 i‡(
°©e
 =
NULL
) {

470 
u32
 
ªsﬁuti⁄_îr
 = 
	`∑r£_îpc_ªque°
(
°©e
, 
d©a
);

471 i‡(
ªsﬁuti⁄_îr
 > 0) {

472 
exô
;

475 
	`bpf_èû_ˇŒ_com∑t
(
˘x
, &
díåy_ªsﬁvî_k¥obe_¥ogs
, 
dr_îpc_key
);

477 
exô
:

478 
	`m⁄ô‹_ªsﬁuti⁄_îr
(
ªsﬁuti⁄_îr
);

480 
	}
}

482 
__©åibuã__
((
Æways_ölöe
)Ë
	$ªsﬁve_díåy
(*
˘x
, 
dr_ty≥
) {

483 i‡(
dr_ty≥
 =
DR_KPROBE
) {

484 
	`bpf_èû_ˇŒ_com∑t
(
˘x
, &
díåy_ªsﬁvî_k¥obe_¥ogs
, 
DR_KPROBE_DENTRY_RESOLVER_KERN_KEY
);

485 } i‡(
dr_ty≥
 =
DR_TRACEPOINT
) {

486 
	`bpf_èû_ˇŒ_com∑t
(
˘x
, &
díåy_ªsﬁvî_åa˚poöt_¥ogs
, 
DR_TRACEPOINT_DENTRY_RESOLVER_KERN_KEY
);

489 
	}
}

	@discarders.h

1 #i‚de‡
_DISCARDERS_H


2 
	#_DISCARDERS_H


	)

4 
	#REVISION_ARRAY_SIZE
 4096

	)

6 
bpf_m≠_def
 
SEC
("m≠s/disˇrdî_ªvisi⁄s"Ë
	gdisˇrdî_ªvisi⁄s
 = {

7 .
ty≥
 = 
BPF_MAP_TYPE_ARRAY
,

8 .
	gkey_size
 = (
u32
),

9 .
	gvÆue_size
 = (
u32
),

10 .
	gmax_íåõs
 = 
REVISION_ARRAY_SIZE
,

11 .
	gpönög
 = 0,

12 .
	g«me•a˚
 = "",

15 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_disˇrdî_ªvisi⁄
(
u32
 
mou¡_id
) {

16 
u32
 
i
 = 
mou¡_id
 % 
REVISION_ARRAY_SIZE
;

17 
u32
 *
ªvisi⁄
 = 
	`bpf_m≠_lookup_ñem
(&
disˇrdî_ªvisi⁄s
, &
i
);

19  
ªvisi⁄
 ? *revision : 0;

20 
	}
}

22 
__©åibuã__
((
Æways_ölöe
)Ë
	$bump_disˇrdî_ªvisi⁄
(
u32
 
mou¡_id
) {

23 
u32
 
i
 = 
mou¡_id
 % 
REVISION_ARRAY_SIZE
;

24 
u32
 *
ªvisi⁄
 = 
	`bpf_m≠_lookup_ñem
(&
disˇrdî_ªvisi⁄s
, &
i
);

25 i‡(!
ªvisi⁄
) {

31 i‡(*
ªvisi⁄
 > 0) {

32 i‡(*
ªvisi⁄
 + 1 == 0) {

33 
	`__sync_„tch_™d_add
(
ªvisi⁄
, 2);

35 
	`__sync_„tch_™d_add
(
ªvisi⁄
, 1);

39  *
ªvisi⁄
;

40 
	}
}

42 
	sdisˇrdî_∑øms_t
 {

43 
u64
 
	mevít_mask
;

44 
u64
 
	mtime°amps
[
EVENT_LAST_DISCARDER
-
EVENT_FIRST_DISCARDER
];

45 
u64
 
	mexpúe_©
;

46 
u32
 
	mis_ªèöed
;

49 
u64
* 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_disˇrdî_time°amp
(
disˇrdî_∑øms_t
 *
∑øms
, 
u64
 
evít_ty≥
) {

50 
evít_ty≥
) {

51 
EVENT_OPEN
:

52  &
∑øms
->
time°amps
[
EVENT_OPEN
-
EVENT_FIRST_DISCARDER
];

53 
EVENT_MKDIR
:

54  &
∑øms
->
time°amps
[
EVENT_MKDIR
-
EVENT_FIRST_DISCARDER
];

55 
EVENT_LINK
:

56  &
∑øms
->
time°amps
[
EVENT_LINK
-
EVENT_FIRST_DISCARDER
];

57 
EVENT_RENAME
:

58  &
∑øms
->
time°amps
[
EVENT_RENAME
-
EVENT_FIRST_DISCARDER
];

59 
EVENT_UNLINK
:

60  &
∑øms
->
time°amps
[
EVENT_UNLINK
-
EVENT_FIRST_DISCARDER
];

61 
EVENT_RMDIR
:

62  &
∑øms
->
time°amps
[
EVENT_RMDIR
-
EVENT_FIRST_DISCARDER
];

63 
EVENT_CHMOD
:

64  &
∑øms
->
time°amps
[
EVENT_CHMOD
-
EVENT_FIRST_DISCARDER
];

65 
EVENT_CHOWN
:

66  &
∑øms
->
time°amps
[
EVENT_CHOWN
-
EVENT_FIRST_DISCARDER
];

67 
EVENT_UTIME
:

68  &
∑øms
->
time°amps
[
EVENT_UTIME
-
EVENT_FIRST_DISCARDER
];

69 
EVENT_SETXATTR
:

70  &
∑øms
->
time°amps
[
EVENT_SETXATTR
-
EVENT_FIRST_DISCARDER
];

71 
EVENT_REMOVEXATTR
:

72  &
∑øms
->
time°amps
[
EVENT_REMOVEXATTR
-
EVENT_FIRST_DISCARDER
];

74  
NULL
;

76 
	}
}

78 * 
__©åibuã__
((
Æways_ölöe
)Ë
	$is_disˇrded
(
bpf_m≠_def
 *
disˇrdî_m≠
, *
key
, 
u64
 
evít_ty≥
) {

79 *
íåy
 = 
	`bpf_m≠_lookup_ñem
(
disˇrdî_m≠
, 
key
);

80 i‡(
íåy
 =
NULL
)

81  
NULL
;

83 
disˇrdî_∑øms_t
 *
∑øms
 = (disˇrdî_∑øms_à*)
íåy
;

85 
u64
 
tm
 = 
	`bpf_ktime_gë_ns
();

89 i‡(
∑øms
->
is_ªèöed
) {

90 i‡(
∑øms
->
expúe_©
 < 
tm
) {

91 
	`bpf_m≠_dñëe_ñem
(
disˇrdî_m≠
, 
key
);

93  
NULL
;

96 
u64
* 
pid_tm
 = 
	`gë_disˇrdî_time°amp
(
∑øms
, 
evít_ty≥
);

97 i‡(
pid_tm
 !
NULL
 && *pid_tm && *pid_tm <
tm
) {

98  
NULL
;

101 i‡(
	`mask_has_evít
(
∑øms
->
evít_mask
, 
evít_ty≥
)) {

102  
íåy
;

105  
NULL
;

106 
	}
}

109 
__©åibuã__
((
Æways_ölöe
)Ë
	$ªmove_disˇrdî
(
bpf_m≠_def
 *
disˇrdî_m≠
, *
key
) {

110 
disˇrdî_∑øms_t
 *
∑øms
 = 
	`bpf_m≠_lookup_ñem
(
disˇrdî_m≠
, 
key
);

111 i‡(
∑øms
) {

112 
u64
 
ªã¡i⁄
;

113 
	`LOAD_CONSTANT
("disˇrdî_ªã¡i⁄", 
ªã¡i⁄
);

115 
∑øms
->
is_ªèöed
 = 1;

116 
∑øms
->
expúe_©
 = 
	`bpf_ktime_gë_ns
(Ë+ 
ªã¡i⁄
;

118 
	}
}

120 
	söode_disˇrdî_t
 {

121 
∑th_key_t
 
	m∑th_key
;

122 
u32
 
	mis_Àaf
;

123 
u32
 
	m∑ddög
;

126 
	söode_disˇrdî_∑øms_t
 {

127 
disˇrdî_∑øms_t
 
	m∑øms
;

128 
u32
 
	mªvisi⁄
;

131 
bpf_m≠_def
 
SEC
("m≠s/öode_disˇrdîs"Ë
	göode_disˇrdîs
 = {

132 .
ty≥
 = 
BPF_MAP_TYPE_LRU_HASH
,

133 .
	gkey_size
 = (
öode_disˇrdî_t
),

134 .
	gvÆue_size
 = (
öode_disˇrdî_∑øms_t
),

135 .
	gmax_íåõs
 = 4096,

136 .
	gpönög
 = 0,

137 .
	g«me•a˚
 = "",

140 
__©åibuã__
((
Æways_ölöe
)Ë
	$disˇrd_öode
(
u64
 
evít_ty≥
, 
u32
 
mou¡_id
, u64 
öode
, u64 
timeout
, u32 
is_Àaf
) {

141 i‡(!
mou¡_id
 || !
öode
) {

145 
öode_disˇrdî_t
 
key
 = {

146 .
∑th_key
 = {

147 .
öo
 = 
öode
,

148 .
mou¡_id
 = mount_id,

150 .
is_Àaf
 = is_leaf,

153 
u64
 *
disˇrdî_time°amp
;

154 
u64
 
time°amp
 = 
timeout
 ? 
	`bpf_ktime_gë_ns
() +Åimeout : 0;

156 
öode_disˇrdî_∑øms_t
 *
öode_∑øms
 = 
	`bpf_m≠_lookup_ñem
(&
öode_disˇrdîs
, &
key
);

157 i‡(
öode_∑øms
) {

158 
öode_∑øms
->
∑øms
.
evít_mask
 |1 << (
evít_ty≥
 - 
EVENT_FIRST_DISCARDER
);

159 
	`add_evít_to_mask
(&
öode_∑øms
->
∑øms
.
evít_mask
, 
evít_ty≥
);

161 i‡((
disˇrdî_time°amp
 = 
	`gë_disˇrdî_time°amp
(&
öode_∑øms
->
∑øms
, 
evít_ty≥
)Ë!
NULL
) {

162 *
disˇrdî_time°amp
 = 
time°amp
;

165 
u64
 
tm
 = 
	`bpf_ktime_gë_ns
();

166 i‡(
öode_∑øms
->
∑øms
.
is_ªèöed
 && inode_∑øms->∑øms.
expúe_©
 < 
tm
) {

167 
öode_∑øms
->
∑øms
.
is_ªèöed
 = 0;

170 
öode_disˇrdî_∑øms_t
 
√w_öode_∑øms
 = {

171 .
ªvisi⁄
 = 
	`gë_disˇrdî_ªvisi⁄
(
mou¡_id
),

173 
	`add_evít_to_mask
(&
√w_öode_∑øms
.
∑øms
.
evít_mask
, 
evít_ty≥
);

175 i‡((
disˇrdî_time°amp
 = 
	`gë_disˇrdî_time°amp
(&
√w_öode_∑øms
.
∑øms
, 
evít_ty≥
)Ë!
NULL
) {

176 *
disˇrdî_time°amp
 = 
time°amp
;

178 
	`bpf_m≠_upd©e_ñem
(&
öode_disˇrdîs
, &
key
, &
√w_öode_∑øms
, 
BPF_NOEXIST
);

182 
	}
}

184 
__©åibuã__
((
Æways_ölöe
)Ë
	$is_disˇrded_by_öode
(
u64
 
evít_ty≥
, 
u32
 
mou¡_id
, u64 
öode
, u32 
is_Àaf
) {

185 
öode_disˇrdî_t
 
key
 = {

186 .
∑th_key
 = {

187 .
öo
 = 
öode
,

188 .
mou¡_id
 = mount_id,

190 .
is_Àaf
 = is_leaf,

193 
öode_disˇrdî_∑øms_t
 *
öode_∑øms
 = (öode_disˇrdî_∑øms_à*Ë
	`is_disˇrded
(&
öode_disˇrdîs
, &
key
, 
evít_ty≥
);

194 i‡(!
öode_∑øms
) {

198  
öode_∑øms
->
ªvisi⁄
 =
	`gë_disˇrdî_ªvisi⁄
(
mou¡_id
);

199 
	}
}

201 
__©åibuã__
((
Æways_ölöe
)Ë
	$ªmove_öode_disˇrdîs
(
u32
 
mou¡_id
, 
u64
 
öode
) {

202 
u64
 
ªã¡i⁄
;

203 
	`LOAD_CONSTANT
("disˇrdî_ªã¡i⁄", 
ªã¡i⁄
);

205 
u64
 
expúe_©
 = 
	`bpf_ktime_gë_ns
(Ë+ 
ªã¡i⁄
;

207 
öode_disˇrdî_t
 
key
 = {

208 .
∑th_key
 = {

209 .
öo
 = 
öode
,

210 .
mou¡_id
 = mount_id,

214 
öode_disˇrdî_∑øms_t
 
√w_öode_∑øms
 = {

215 .
∑øms
 = {

216 .
is_ªèöed
 = 1,

217 .
expúe_©
 =Éxpire_at,

219 .
ªvisi⁄
 = 
	`gë_disˇrdî_ªvisi⁄
(
mou¡_id
),

222 #¥agm®
uƒﬁl


223 
i
 = 0; i != 2; i++) {

224 
key
.
is_Àaf
 = 
i
;

226 
öode_disˇrdî_∑øms_t
 *
öode_∑øms
 = 
	`bpf_m≠_lookup_ñem
(&
öode_disˇrdîs
, &
key
);

227 i‡(
öode_∑øms
) {

228 
öode_∑øms
->
∑øms
.
is_ªèöed
 = 1;

229 
öode_∑øms
->
∑øms
.
expúe_©
 =Éxpire_at;

232 
	`bpf_m≠_upd©e_ñem
(&
öode_disˇrdîs
, &
key
, &
√w_öode_∑øms
, 
BPF_NOEXIST
);

235 
	}
}

237 
__©åibuã__
((
Æways_ölöe
)Ë
	$expúe_öode_disˇrdî
(
u32
 
mou¡_id
, 
u64
 
öode
) {

238 i‡(!
mou¡_id
 || !
öode
) {

242 
	`ªmove_öode_disˇrdîs
(
mou¡_id
, 
öode
);

244 
	}
}

246 
__Æways_ölöe
 
u32
 
	$is_ru¡ime_disˇrded
() {

247 
u64
 
disˇrded
 = 0;

248 
	`LOAD_CONSTANT
("ru¡ime_disˇrded", 
disˇrded
);

249  
disˇrded
;

250 
	}
}

252 
	spid_disˇrdî_∑øms_t
 {

253 
disˇrdî_∑øms_t
 
	m∑øms
;

256 
	spid_disˇrdî_t
 {

257 
u32
 
	mtgid
;

260 
bpf_m≠_def
 
SEC
("m≠s/pid_disˇrdîs"Ë
	gpid_disˇrdîs
 = { \

261 .
ty≥
 = 
BPF_MAP_TYPE_LRU_HASH
,

262 .
	gkey_size
 = (
u32
),

263 .
	gvÆue_size
 = (
pid_disˇrdî_∑øms_t
),

264 .
	gmax_íåõs
 = 512,

265 .
	gpönög
 = 0,

266 .
	g«me•a˚
 = "",

269 
__©åibuã__
((
Æways_ölöe
)Ë
	$disˇrd_pid
(
u64
 
evít_ty≥
, 
u32
 
tgid
, u64 
timeout
) {

270 
pid_disˇrdî_t
 
key
 = {

271 .
tgid
 =Ågid,

274 
u64
 *
disˇrdî_time°amp
;

275 
u64
 
time°amp
 = 
timeout
 ? 
	`bpf_ktime_gë_ns
() +Åimeout : 0;

277 
pid_disˇrdî_∑øms_t
 *
pid_∑øms
 = 
	`bpf_m≠_lookup_ñem
(&
pid_disˇrdîs
, &
key
);

278 i‡(
pid_∑øms
) {

279 
	`add_evít_to_mask
(&
pid_∑øms
->
∑øms
.
evít_mask
, 
evít_ty≥
);

281 i‡((
disˇrdî_time°amp
 = 
	`gë_disˇrdî_time°amp
(&
pid_∑øms
->
∑øms
, 
evít_ty≥
)Ë!
NULL
) {

282 *
disˇrdî_time°amp
 = 
time°amp
;

285 
pid_disˇrdî_∑øms_t
 
√w_pid_∑øms
 = {};

286 
	`add_evít_to_mask
(&
√w_pid_∑øms
.
∑øms
.
evít_mask
, 
evít_ty≥
);

288 i‡((
disˇrdî_time°amp
 = 
	`gë_disˇrdî_time°amp
(&
√w_pid_∑øms
.
∑øms
, 
evít_ty≥
)Ë!
NULL
) {

289 *
disˇrdî_time°amp
 = 
time°amp
;

291 
	`bpf_m≠_upd©e_ñem
(&
pid_disˇrdîs
, &
key
, &
√w_pid_∑øms
, 
BPF_NOEXIST
);

295 
	}
}

297 
__©åibuã__
((
Æways_ölöe
)Ë
	$is_disˇrded_by_pid
(
u64
 
evít_ty≥
, 
u32
 
tgid
) {

298 
pid_disˇrdî_t
 
key
 = {

299 .
tgid
 =Ågid,

302  
	`is_disˇrded
(&
pid_disˇrdîs
, &
key
, 
evít_ty≥
Ë!
NULL
;

303 
	}
}

305 
__©åibuã__
((
Æways_ölöe
)Ë
	$is_disˇrded_by_¥o˚ss
(c⁄° 
mode
, 
u64
 
evít_ty≥
) {

306 
u64
 
pid_tgid
 = 
	`bpf_gë_cuºít_pid_tgid
();

307 
u32
 
tgid
 = 
pid_tgid
 >> 32;

309 
u64
 
ru¡ime_pid
;

310 
	`LOAD_CONSTANT
("ru¡ime_pid", 
ru¡ime_pid
);

312 i‡(
	`is_ru¡ime_disˇrded
(Ë&& 
ru¡ime_pid
 =
tgid
) {

316 i‡(
mode
 !
NO_FILTER
) {

318 i‡(
	`is_disˇrded_by_pid
(
evít_ty≥
, 
tgid
))

321 
¥oc_ˇche_t
 *
íåy
 = 
	`gë_¥oc_ˇche
(
tgid
);

322 i‡(
íåy
 && 
	`is_disˇrded_by_öode
(
evít_ty≥
,É¡ry->
execuèbÀ
.
∑th_key
.
mou¡_id
,É¡ry->execuèbÀ.∑th_key.
öo
, 0)) {

328 
	}
}

330 
__©åibuã__
((
Æways_ölöe
)Ë
	$ªmove_pid_disˇrdî
(
u32
 
tgid
) {

331 
pid_disˇrdî_t
 
key
 = {

332 .
tgid
 =Ågid,

335 
	`ªmove_disˇrdî
(&
pid_disˇrdîs
, &
key
);

336 
	}
}

	@erpc.h

1 #i‚de‡
_ERPC_H


2 
	#_ERPC_H


	)

4 
	~"fûãrs.h
"

5 
	~"•™.h
"

7 
	#RPC_CMD
 0xdódc001

	)

9 
	eîpc_›
 {

10 
	mUNKNOWN_OP
,

11 
	mDISCARD_INODE_OP
,

12 
	mDISCARD_PID_OP
,

13 
	mRESOLVE_SEGMENT_OP
,

14 
	mRESOLVE_PATH_OP
,

15 
	mRESOLVE_PARENT_OP
,

16 
	mREGISTER_SPAN_TLS_OP
,

17 
	mEXPIRE_INODE_DISCARDER_OP
,

20 
__©åibuã__
((
Æways_ölöe
)Ë
	$h™dÀ_disˇrd
(*
d©a
, 
u64
 *
evít_ty≥
, u64 *
timeout
) {

21 
u64
 
vÆue
;

23 
	`bpf_¥obe_ªad
(&
vÆue
, (vÆue), 
d©a
);

24 *
evít_ty≥
 = 
vÆue
;

26 
	`bpf_¥obe_ªad
(&
vÆue
, (vÆue), 
d©a
 + (value));

27 *
timeout
 = 
vÆue
;

29  2*(
vÆue
);

30 
	}
}

32 
	sdisˇrd_ªque°_t
 {

33 
u64
 
	mevít_ty≥
;

34 
u64
 
	mtimeout
;

37 
	sdisˇrd_öode_t
 {

38 
disˇrd_ªque°_t
 
	mªq
;

39 
u64
 
	möode
;

40 
u32
 
	mmou¡_id
;

41 
u32
 
	mis_Àaf
;

44 
	sexpúe_öode_disˇrdî_t
 {

45 
u64
 
	möode
;

46 
u32
 
	mmou¡_id
;

49 
	sdisˇrd_pid_t
 {

50 
disˇrd_ªque°_t
 
	mªq
;

51 
u32
 
	mpid
;

54 
__©åibuã__
((
Æways_ölöe
)Ë
	$is_ru¡ime_ªque°
() {

55 
u64
 
pid
;

56 
	`LOAD_CONSTANT
("ru¡ime_pid", 
pid
);

58 
u64
 
pid_tgid
 = 
	`bpf_gë_cuºít_pid_tgid
();

59  
pid_tgid
 >> 32 =
pid
;

60 
	}
}

62 
__©åibuã__
((
Æways_ölöe
)Ë
	$h™dÀ_disˇrd_öode
(*
d©a
) {

63 i‡(!
	`is_ru¡ime_ªque°
()) {

67 
disˇrd_öode_t
 
disˇrdî
;

68 
	`bpf_¥obe_ªad
(&
disˇrdî
, (disˇrdî), 
d©a
);

70  
	`disˇrd_öode
(
disˇrdî
.
ªq
.
evít_ty≥
, disˇrdî.
mou¡_id
, disˇrdî.
öode
, disˇrdî.ªq.
timeout
, disˇrdî.
is_Àaf
);

71 
	}
}

73 
__©åibuã__
((
Æways_ölöe
)Ë
	$h™dÀ_expúe_öode_disˇrdî
(*
d©a
) {

74 i‡(!
	`is_ru¡ime_ªque°
()) {

78 
expúe_öode_disˇrdî_t
 
disˇrdî
;

79 
	`bpf_¥obe_ªad
(&
disˇrdî
, (disˇrdî), 
d©a
);

81  
	`expúe_öode_disˇrdî
(
disˇrdî
.
mou¡_id
, disˇrdî.
öode
);

82 
	}
}

84 
__©åibuã__
((
Æways_ölöe
)Ë
	$h™dÀ_disˇrd_pid
(*
d©a
) {

85 i‡(!
	`is_ru¡ime_ªque°
()) {

89 
disˇrd_pid_t
 
disˇrdî
;

90 
	`bpf_¥obe_ªad
(&
disˇrdî
, (disˇrdî), 
d©a
);

92  
	`disˇrd_pid
(
disˇrdî
.
ªq
.
evít_ty≥
, disˇrdî.
pid
, disˇrdî.ªq.
timeout
);

93 
	}
}

95 
__©åibuã__
((
Æways_ölöe
)Ë
	$is_îpc_ªque°
(
±_ªgs
 *
˘x
) {

96 
u32
 
cmd
 = 
	`PT_REGS_PARM3
(
˘x
);

97 i‡(
cmd
 !
RPC_CMD
) {

102 
	}
}

104 
__©åibuã__
((
Æways_ölöe
)Ë
	$h™dÀ_îpc_ªque°
(
±_ªgs
 *
˘x
) {

105 *
ªq
 = (*)
	`PT_REGS_PARM4
(
˘x
);

107 
u8
 
›
 = 0;

108 
ªt
 = 
	`bpf_¥obe_ªad
(&
›
, (›), 
ªq
);

109 i‡(
ªt
 < 0) {

110 
ªt
 = 
DR_ERPC_READ_PAGE_FAULT
;

111 
bpf_m≠_def
 *
îpc_°©s
 = 
	`£À˘_buf„r
(&
dr_îpc_°©s_fb
, &
dr_îpc_°©s_bb
, 
ERPC_MONITOR_KEY
);

112 i‡(
îpc_°©s
 =
NULL
) {

116 
dr_îpc_°©s_t
 *
°©s
 = 
	`bpf_m≠_lookup_ñem
(
îpc_°©s
, &
ªt
);

117 i‡(
°©s
 =
NULL
) {

120 
	`__sync_„tch_™d_add
(&
°©s
->
cou¡
, 1);

124 *
d©a
 = 
ªq
 + (
›
);

126 i‡(!
	`is_Êushög_disˇrdîs
()) {

127 
›
) {

128 
DISCARD_INODE_OP
:

129  
	`h™dÀ_disˇrd_öode
(
d©a
);

130 
DISCARD_PID_OP
:

131  
	`h™dÀ_disˇrd_pid
(
d©a
);

135 
›
) {

136 
RESOLVE_SEGMENT_OP
:

137  
	`h™dÀ_dr_ªque°
(
˘x
, 
d©a
, 
DR_ERPC_SEGMENT_KEY
);

138 
RESOLVE_PATH_OP
:

139  
	`h™dÀ_dr_ªque°
(
˘x
, 
d©a
, 
DR_ERPC_KEY
);

140 
RESOLVE_PARENT_OP
:

141  
	`h™dÀ_dr_ªque°
(
˘x
, 
d©a
, 
DR_ERPC_PARENT_KEY
);

142 
REGISTER_SPAN_TLS_OP
:

143  
	`h™dÀ_ªgi°î_•™_mem‹y
(
d©a
);

144 
EXPIRE_INODE_DISCARDER_OP
:

145  
	`h™dÀ_expúe_öode_disˇrdî
(
d©a
);

149 
	}
}

	@exec.h

1 #i‚de‡
_EXEC_H_


2 
	#_EXEC_H_


	)

4 
	~<löux/ây.h
>

6 
	~"fûãrs.h
"

7 
	~"sysˇŒs.h
"

8 
	~"c⁄èöî.h
"

9 
	~"•™.h
"

11 
	#MAX_PERF_STR_BUFF_LEN
 256

	)

12 
	#MAX_STR_BUFF_LEN
 (1 << 15)

	)

13 
	#MAX_ARRAY_ELEMENT_PER_TAIL
 28

	)

14 
	#MAX_ARRAY_ELEMENT_SIZE
 4096

	)

15 
	#MAX_ARGS_ELEMENTS
 140

	)

17 
	s¨gs_ívs_evít_t
 {

18 
kevít_t
 
	mevít
;

19 
u32
 
	mid
;

20 
u32
 
	msize
;

21 
	mvÆue
[
MAX_PERF_STR_BUFF_LEN
];

24 
	s°r_¨øy_buf„r_t
 {

25 
	mvÆue
[
MAX_STR_BUFF_LEN
];

28 
bpf_m≠_def
 
SEC
("m≠s/¨gs_ívs_¥ogs"Ë
	g¨gs_ívs_¥ogs
 = {

29 .
ty≥
 = 
BPF_MAP_TYPE_PROG_ARRAY
,

30 .
	gkey_size
 = (
u32
),

31 .
	gvÆue_size
 = (
u32
),

32 .
	gmax_íåõs
 = 10,

35 
bpf_m≠_def
 
SEC
("m≠s/°r_¨øy_buf„rs"Ë
	g°r_¨øy_buf„rs
 = {

36 .
ty≥
 = 
BPF_MAP_TYPE_PERCPU_ARRAY
,

37 .
	gkey_size
 = (
u32
),

38 .
	gvÆue_size
 = (
°r_¨øy_buf„r_t
),

39 .
	gmax_íåõs
 = 1,

40 .
	gpönög
 = 0,

41 .
	g«me•a˚
 = "",

44 
	sexec_evít_t
 {

45 
kevít_t
 
	mevít
;

46 
¥o˚ss_c⁄ãxt_t
 
	m¥o˚ss
;

47 
•™_c⁄ãxt_t
 
	m•™
;

48 
¥oc_ˇche_t
 
	m¥oc_íåy
;

49 
pid_ˇche_t
 
	mpid_íåy
;

50 
u32
 
	m¨gs_id
;

51 
u32
 
	m¨gs_åunˇãd
;

52 
u32
 
	mívs_id
;

53 
u32
 
	mívs_åunˇãd
;

56 
	sexô_evít_t
 {

57 
kevít_t
 
	mevít
;

58 
¥o˚ss_c⁄ãxt_t
 
	m¥o˚ss
;

59 
•™_c⁄ãxt_t
 
	m•™
;

60 
c⁄èöî_c⁄ãxt_t
 
	mc⁄èöî
;

63 
	s_åa˚poöt_sched_¥o˚ss_f‹k


65 
	mcomm⁄_ty≥
;

66 
	mcomm⁄_Êags
;

67 
	mcomm⁄_¥ìm±_cou¡
;

68 
	mcomm⁄_pid
;

70 
	m∑ª¡_comm
[16];

71 
pid_t
 
	m∑ª¡_pid
;

72 
	mchûd_comm
[16];

73 
pid_t
 
	mchûd_pid
;

76 
	s_åa˚poöt_sched_¥o˚ss_exec
 {

77 
	mcomm⁄_ty≥
;

78 
	mcomm⁄_Êags
;

79 
	mcomm⁄_¥ìm±_cou¡
;

80 
	mcomm⁄_pid
;

82 
	md©a_loc_fûíame
;

83 
pid_t
 
	mpid
;

84 
pid_t
 
	mﬁd_pid
;

87 
	#MAX_PATH_LEN
 256

	)

89 
	sexec_∑th
 {

90 
	mfûíame
[
MAX_PATH_LEN
];

93 
bpf_m≠_def
 
SEC
("m≠s/exec_cou¡_fb"Ë
	gexec_cou¡_fb
 = {

94 .
ty≥
 = 
BPF_MAP_TYPE_LRU_HASH
,

95 .
	gkey_size
 = (
exec_∑th
),

96 .
	gvÆue_size
 = (
u64
),

97 .
	gmax_íåõs
 = 2048,

98 .
	gpönög
 = 0,

99 .
	g«me•a˚
 = "",

102 
bpf_m≠_def
 
SEC
("m≠s/exec_cou¡_bb"Ë
	gexec_cou¡_bb
 = {

103 .
ty≥
 = 
BPF_MAP_TYPE_LRU_HASH
,

104 .
	gkey_size
 = (
exec_∑th
),

105 .
	gvÆue_size
 = (
u64
),

106 .
	gmax_íåõs
 = 2048,

107 .
	gpönög
 = 0,

108 .
	g«me•a˚
 = "",

111 
¥oc_ˇche_t
 
__©åibuã__
((
Æways_ölöe
)Ë*
	$gë_¥oc_‰om_cookõ
(
u32
 
cookõ
) {

112 i‡(!
cookõ
) {

113  
NULL
;

116  
	`bpf_m≠_lookup_ñem
(&
¥oc_ˇche
, &
cookõ
);

117 
	}
}

119 
__©åibuã__
((
Æways_ölöe
)Ë
	$∑r£_°r_¨øy
(
±_ªgs
 *
˘x
, 
°r_¨øy_ªf_t
 *
¨øy_ªf
, 
u64
 
evít_ty≥
) {

120 c⁄° **
¨øy
 = 
¨øy_ªf
->array;

121 
ödex
 = 
¨øy_ªf
->index;

122 i‡(
ödex
 == 255) {

126 
¨øy_ªf
->
åunˇãd
 = 0;

128 
u32
 
key
 = 0;

129 
°r_¨øy_buf„r_t
 *
buff
 = 
	`bpf_m≠_lookup_ñem
(&
°r_¨øy_buf„rs
, &
key
);

130 i‡(!
buff
) {

134 c⁄° *
°r
;

135 
	`bpf_¥obe_ªad
(&
°r
, (°r), (*)&
¨øy
[
ödex
]);

137 
¨gs_ívs_evít_t
 
evít
 = {

138 .
id
 = 
¨øy_ªf
->id,

141 
i
 = 0, 
n
 = 0, 
buff_off£t
 = 0, 
≥rf_off£t
 = 0;

143 #¥agm®
uƒﬁl


144 
i
 = 0; i < 
MAX_ARRAY_ELEMENT_PER_TAIL
; i++) {

145 *
±r
 = &(
buff
->
vÆue
[(
buff_off£t
 + (
n
)Ë& (
MAX_STR_BUFF_LEN
 - 
MAX_ARRAY_ELEMENT_SIZE
 - 1)]);

147 
n
 = 
	`bpf_¥obe_ªad_°r
(
±r
, 
MAX_ARRAY_ELEMENT_SIZE
, (*)
°r
);

148 i‡(
n
 > 0) {

149 
n
--;

151 
Àn
 = 
n
 + (n);

152 
	`bpf_¥obe_ªad
(&(
buff
->
vÆue
[
buff_off£t
&(
MAX_STR_BUFF_LEN
 - 
MAX_ARRAY_ELEMENT_SIZE
 - 1)]), (
n
), &n);

153 
buff_off£t
 +
Àn
;

155 i‡(
evít
.
size
 + 
Àn
 >
MAX_PERF_STR_BUFF_LEN
) {

156 *
≥rf_±r
 = &(
buff
->
vÆue
[
≥rf_off£t
&(
MAX_STR_BUFF_LEN
 - 
MAX_ARRAY_ELEMENT_SIZE
 - 1)]);

157 
	`bpf_¥obe_ªad
(&
evít
.
vÆue
, 
MAX_PERF_STR_BUFF_LEN
, 
≥rf_±r
);

159 i‡(
evít
.
size
 =0 || 
Àn
 > 
MAX_PERF_STR_BUFF_LEN
) {

160 
evít
.
size
 = 
MAX_PERF_STR_BUFF_LEN
;

161 
≥rf_off£t
 = 
buff_off£t
;

162 
Àn
 = 0;

164 
≥rf_off£t
 +
evít
.
size
;

166 
	`£nd_evít
(
˘x
, 
evít_ty≥
, 
evít
);

167 
evít
.
size
 = 0;

169 
evít
.
size
 +
Àn
;

170 
ödex
++;

172 
	`bpf_¥obe_ªad
(&
°r
, (°r), (*)&
¨øy
[
ödex
]);

174 
ödex
 = 255;

178 
¨øy_ªf
->
ödex
 = index;

179 
¨øy_ªf
->
åunˇãd
 = 
i
 =
MAX_ARRAY_ELEMENT_PER_TAIL
;

182 i‡(
evít
.
size
 > 0) {

183 *
≥rf_±r
 = &(
buff
->
vÆue
[
≥rf_off£t
&(
MAX_STR_BUFF_LEN
 - 
MAX_ARRAY_ELEMENT_SIZE
 - 1)]);

184 
	`bpf_¥obe_ªad
(&
evít
.
vÆue
, 
MAX_PERF_STR_BUFF_LEN
, 
≥rf_±r
);

186 i‡(
evít
.
size
 > 
MAX_PERF_STR_BUFF_LEN
) {

187 
evít
.
size
 = 
MAX_PERF_STR_BUFF_LEN
;

189 
	`£nd_evít
(
˘x
, 
evít_ty≥
, 
evít
);

191 
	}
}

193 
SEC
("kprobe/parse_args_envs")

194 
	$k¥obe_∑r£_¨gs_ívs
(
±_ªgs
 *
˘x
) {

195 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
EVENT_EXEC
);

196 i‡(!
sysˇŒ
) {

200 
°r_¨øy_ªf_t
 *
¨øy
 = &
sysˇŒ
->
exec
.
¨gs
;

201 i‡(
sysˇŒ
->
exec
.
√xt_èû
 > 
MAX_ARGS_ELEMENTS
 / 
MAX_ARRAY_ELEMENT_PER_TAIL
) {

202 
¨øy
 = &
sysˇŒ
->
exec
.
ívs
;

204 
	`∑r£_°r_¨øy
(
˘x
, 
¨øy
, 
EVENT_ARGS_ENVS
);

206 
sysˇŒ
->
exec
.
√xt_èû
++;

208 
	`bpf_èû_ˇŒ_com∑t
(
˘x
, &
¨gs_ívs_¥ogs
, 
sysˇŒ
->
exec
.
√xt_èû
);

211 
	}
}

213 
__©åibuã__
((
Æways_ölöe
)Ë
	$åa˚__sys_execvót
(
±_ªgs
 *
˘x
, c⁄° **
¨gv
, c⁄° **
ív
) {

214 
sysˇŒ_ˇche_t
 
sysˇŒ
 = {

215 .
ty≥
 = 
EVENT_EXEC
,

216 .
exec
 = {

217 .
¨gs
 = {

218 .
id
 = 
	`bpf_gë_¥™dom_u32
(),

219 .
¨øy
 = 
¨gv
,

220 .
ödex
 = 0,

222 .
ívs
 = {

223 .
id
 = 
	`bpf_gë_¥™dom_u32
(),

224 .
¨øy
 = 
ív
,

228 
	`ˇche_sysˇŒ
(&
sysˇŒ
);

231 
	}
}

233 
	$SYSCALL_KPROBE3
(
execve
, c⁄° *, 
fûíame
, c⁄° **, 
¨gv
, c⁄° **, 
ív
) {

234  
	`åa˚__sys_execvót
(
˘x
, 
¨gv
, 
ív
);

235 
	}
}

237 
	$SYSCALL_KPROBE4
(
execvót
, , 
fd
, c⁄° *, 
fûíame
, c⁄° **, 
¨gv
, c⁄° **, 
ív
) {

238  
	`åa˚__sys_execvót
(
˘x
, 
¨gv
, 
ív
);

239 
	}
}

241 
__©åibuã__
((
Æways_ölöe
)Ë
	$h™dÀ_exec_evít
(
±_ªgs
 *
˘x
, 
sysˇŒ_ˇche_t
 *
sysˇŒ
, 
fûe
 *fûe, 
∑th
 *∑th, 
öode
 *inode) {

242 i‡(
sysˇŒ
->
exec
.
is_∑r£d
) {

245 
sysˇŒ
->
exec
.
is_∑r£d
 = 1;

247 
sysˇŒ
->
exec
.
díåy
 = 
	`gë_fûe_díåy
(
fûe
);

248 
sysˇŒ
->
exec
.
fûe
.
∑th_key
 = 
	`gë_öode_key_∑th
(
öode
, 
∑th
);

249 
sysˇŒ
->
exec
.
fûe
.
∑th_key
.
∑th_id
 = 
	`gë_∑th_id
(0);

251 
u64
 
pid_tgid
 = 
	`bpf_gë_cuºít_pid_tgid
();

252 
u32
 
tgid
 = 
pid_tgid
 >> 32;

254 
díåy
 *
exec_díåy
 = 
	`gë_∑th_díåy
(
∑th
);

255 
¥oc_ˇche_t
 
íåy
 = {

256 .
execuèbÀ
 = {

257 .
∑th_key
 = {

258 .
öo
 = 
sysˇŒ
->
exec
.
fûe
.
∑th_key
.ino,

259 .
mou¡_id
 = 
	`gë_∑th_mou¡_id
(
∑th
),

260 .
∑th_id
 = 
sysˇŒ
->
exec
.
fûe
.
∑th_key
.path_id,

262 .
Êags
 = 
sysˇŒ
->
exec
.
fûe
.flags,

264 .
c⁄èöî
 = {},

265 .
exec_time°amp
 = 
	`bpf_ktime_gë_ns
(),

267 
	`fûl_fûe_mëad©a
(
exec_díåy
, &
íåy
.
execuèbÀ
.
mëad©a
);

268 
	`£t_fûe_öode
(
exec_díåy
, &
íåy
.
execuèbÀ
, 0);

269 
	`bpf_gë_cuºít_comm
(&
íåy
.
comm
, (entry.comm));

273 
pid_ˇche_t
 *
f‹k_íåy
 = (pid_ˇche_à*Ë
	`bpf_m≠_lookup_ñem
(&
pid_ˇche
, &
tgid
);

274 i‡(
f‹k_íåy
) {

276 
u32
 
∑ª¡_cookõ
 = 
f‹k_íåy
->
cookõ
;

277 
¥oc_ˇche_t
 *
∑ª¡_íåy
 = 
	`gë_¥oc_‰om_cookõ
(
∑ª¡_cookõ
);

278 i‡(
∑ª¡_íåy
) {

280 
	`fûl_c⁄èöî_c⁄ãxt
(
∑ª¡_íåy
, &
íåy
.
c⁄èöî
);

286 
u32
 
cookõ
 = 
	`bpf_gë_¥™dom_u32
();

287 
	`bpf_m≠_upd©e_ñem
(&
¥oc_ˇche
, &
cookõ
, &
íåy
, 
BPF_ANY
);

290 i‡(
f‹k_íåy
) {

291 
f‹k_íåy
->
cookõ
 = cookie;

293 
pid_ˇche_t
 
√w_pid_íåy
 = {

294 .
cookõ
 = cookie,

296 
	`bpf_m≠_upd©e_ñem
(&
pid_ˇche
, &
tgid
, &
√w_pid_íåy
, 
BPF_ANY
);

300 
sysˇŒ
->
ªsﬁvî
.
key
 = sysˇŒ->
exec
.
fûe
.
∑th_key
;

301 
sysˇŒ
->
ªsﬁvî
.
díåy
 = sysˇŒ->
exec
.dentry;

302 
sysˇŒ
->
ªsﬁvî
.
disˇrdî_ty≥
 = 0;

303 
sysˇŒ
->
ªsﬁvî
.
ˇŒback
 = 
DR_NO_CALLBACK
;

304 
sysˇŒ
->
ªsﬁvî
.
ôî©i⁄
 = 0;

305 
sysˇŒ
->
ªsﬁvî
.
ªt
 = 0;

307 
	`ªsﬁve_díåy
(
˘x
, 
DR_KPROBE
);

309 
	}
}

311 
	#DO_FORK_STRUCT_INPUT
 1

	)

313 
__©åibuã__
((
Æways_ölöe
)Ë
	$h™dÀ_do_f‹k
(
±_ªgs
 *
˘x
) {

314 
u64
 
öput
;

315 
	`LOAD_CONSTANT
("do_f‹k_öput", 
öput
);

316 
u64
 
is_thªad
 = 1;

318 i‡(
öput
 =
DO_FORK_STRUCT_INPUT
) {

319 *
¨gs
 = (*)
	`PT_REGS_PARM1
(
˘x
);

320 
exô_sig«l
;

321 
	`bpf_¥obe_ªad
(&
exô_sig«l
, (), (*)
¨gs
 + 32);

323 i‡(
exô_sig«l
 =
SIGCHLD
) {

324 
is_thªad
 = 0;

327 
u64
 
Êags
 = (u64)
	`PT_REGS_PARM1
(
˘x
);

328 i‡((
Êags
 & 
SIGCHLD
) == SIGCHLD) {

329 
is_thªad
 = 0;

333 
sysˇŒ_ˇche_t
 
sysˇŒ
 = {

334 .
ty≥
 = 
EVENT_FORK
,

335 .
f‹k
 = {

336 .
is_thªad
 = is_thread,

339 
	`ˇche_sysˇŒ
(&
sysˇŒ
);

342 
	}
}

344 
SEC
("kprobe/kernel_clone")

345 
	$k¥obe_kî√l_˛⁄e
(
±_ªgs
 *
˘x
) {

346  
	`h™dÀ_do_f‹k
(
˘x
);

347 
	}
}

349 
SEC
("kprobe/do_fork")

350 
	$k¥obe_do_f‹k
(
±_ªgs
 *
˘x
) {

351  
	`h™dÀ_do_f‹k
(
˘x
);

352 
	}
}

354 
SEC
("kprobe/_do_fork")

355 
	$k¥obe__do_f‹k
(
±_ªgs
 *
˘x
) {

356  
	`h™dÀ_do_f‹k
(
˘x
);

357 
	}
}

359 
SEC
("kretprobe/alloc_pid")

360 
	$kªçrobe_Æloc_pid
(
±_ªgs
 *
˘x
) {

361 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
EVENT_FORK
);

362 i‡(!
sysˇŒ
) {

367 
pid
 *pid = (pid *Ë
	`PT_REGS_RC
(
˘x
);

368 
	`bpf_¥obe_ªad
(&
sysˇŒ
->
f‹k
.
pid
, (syscall->fork.pid), &pid);

370 
	}
}

376 
SEC
("kretprobe/__task_pid_nr_ns")

377 
	$kªçrobe__èsk_pid_ƒ_ns
(
±_ªgs
 *
˘x
) {

378 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
EVENT_EXEC
);

379 i‡(!
sysˇŒ
) {

383 
u32
 
roŸ_ƒ
 = 
	`bpf_gë_cuºít_pid_tgid
();

384 
u32
 
«me•a˚_ƒ
 = (
pid_t
Ë
	`PT_REGS_RC
(
˘x
);

386 
	`ªgi°î_ƒ
(
roŸ_ƒ
, 
«me•a˚_ƒ
);

388 
	}
}

390 
SEC
("tracepoint/sched/sched_process_exec")

391 
	$sched_¥o˚ss_exec
(
_åa˚poöt_sched_¥o˚ss_exec
 *
¨gs
) {

393 
__off£t
 = 
¨gs
->
d©a_loc_fûíame
 & 0xFFFF;

394 *
fûíame
 = (*)
¨gs
 + 
__off£t
;

396 
exec_∑th
 
key
 = {};

397 
	`bpf_¥obe_ªad_°r
(&
key
.
fûíame
, 
MAX_PATH_LEN
, filename);

399 
bpf_m≠_def
 *
exec_cou¡
 = 
	`£À˘_buf„r
(&
exec_cou¡_fb
, &
exec_cou¡_bb
, 
SYSCALL_MONITOR_KEY
);

400 i‡(
exec_cou¡
 =
NULL
)

403 
u64
 
zîo
 = 0;

404 
u64
 *
cou¡
 = 
	`bpf_m≠_lookup_‹_åy_öô
(
exec_cou¡
, &
key
, &
zîo
);

405 i‡(
cou¡
 =
NULL
) {

409 
	`__sync_„tch_™d_add
(
cou¡
, 1);

412 
	}
}

414 
SEC
("tracepoint/sched/sched_process_fork")

415 
	$sched_¥o˚ss_f‹k
(
_åa˚poöt_sched_¥o˚ss_f‹k
 *
¨gs
) {

417 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
EVENT_FORK
);

418 i‡(!
sysˇŒ
) {

423 
	`ˇche_ƒ_å™¶©i⁄s
(
sysˇŒ
->
f‹k
.
pid
);

426 i‡(
sysˇŒ
->
f‹k
.
is_thªad
) {

430 
u32
 
pid
 = 0;

431 
	`bpf_¥obe_ªad
(&
pid
, ’id), &
¨gs
->
chûd_pid
);

433 
u64
 
ts
 = 
	`bpf_ktime_gë_ns
();

434 
exec_evít_t
 
evít
 = {

435 .
pid_íåy
.
f‹k_time°amp
 = 
ts
,

437 
	`bpf_gë_cuºít_comm
(&
evít
.
¥oc_íåy
.
comm
, (event.proc_entry.comm));

438 
	`fûl_¥o˚ss_c⁄ãxt
(&
evít
.
¥o˚ss
);

439 
	`fûl_•™_c⁄ãxt
(&
evít
.
•™
);

443 
u32
 
µid
 = 
evít
.
¥o˚ss
.
pid
;

444 
evít
.
pid_íåy
.
µid
 =Öpid;

446 
evít
.
¥o˚ss
.
pid
 =Öid;

447 
evít
.
¥o˚ss
.
tid
 = 
pid
;

450 i‡(
	`IS_KTHREAD
(
µid
, 
pid
)) {

454 
pid_ˇche_t
 *
∑ª¡_pid_íåy
 = (pid_ˇche_à*Ë
	`bpf_m≠_lookup_ñem
(&
pid_ˇche
, &
µid
);

455 i‡(
∑ª¡_pid_íåy
) {

457 
evít
.
pid_íåy
.
cookõ
 = 
∑ª¡_pid_íåy
->cookie;

460 
evít
.
pid_íåy
.
¸edítüls
 = 
∑ª¡_pid_íåy
->credentials;

463 
¥oc_ˇche_t
 *
∑ª¡_¥oc_íåy
 = 
	`gë_¥oc_‰om_cookõ
(
evít
.
pid_íåy
.
cookõ
);

464 i‡(
∑ª¡_¥oc_íåy
) {

465 
	`c›y_¥oc_ˇche_ex˚±_comm
(
∑ª¡_¥oc_íåy
, &
evít
.
¥oc_íåy
);

470 
	`bpf_m≠_upd©e_ñem
(&
pid_ˇche
, &
pid
, &
evít
.
pid_íåy
, 
BPF_ANY
);

473 
	`£nd_evít
(
¨gs
, 
EVENT_FORK
, 
evít
);

476 
	}
}

478 
SEC
("kprobe/do_exit")

479 
	$k¥obe_do_exô
(
±_ªgs
 *
˘x
) {

480 
u64
 
pid_tgid
 = 
	`bpf_gë_cuºít_pid_tgid
();

481 
u32
 
tgid
 = 
pid_tgid
 >> 32;

482 
u32
 
pid
 = 
pid_tgid
;

484 i‡(
tgid
 =
pid
) {

485 i‡(!
	`is_Êushög_disˇrdîs
()) {

486 
	`ªmove_pid_disˇrdî
(
tgid
);

490 
pid_ˇche_t
 *
pid_íåy
 = (pid_ˇche_à*Ë
	`bpf_m≠_lookup_ñem
(&
pid_ˇche
, &
tgid
);

491 i‡(
pid_íåy
) {

492 
pid_íåy
->
exô_time°amp
 = 
	`bpf_ktime_gë_ns
();

495 i‡(
	`IS_KTHREAD
(
pid_íåy
->
µid
, 
pid
)) {

501 
exô_evít_t
 
evít
 = {};

502 
¥oc_ˇche_t
 *
ˇche_íåy
 = 
	`fûl_¥o˚ss_c⁄ãxt
(&
evít
.
¥o˚ss
);

503 
	`fûl_c⁄èöî_c⁄ãxt
(
ˇche_íåy
, &
evít
.
c⁄èöî
);

504 
	`fûl_•™_c⁄ãxt
(&
evít
.
•™
);

505 
	`£nd_evít
(
˘x
, 
EVENT_EXIT
, 
evít
);

507 
	`uƒegi°î_•™_mem‹y
();

511 
	`ªmove_ƒ
(
pid
);

514 
	}
}

516 
SEC
("kprobe/exit_itimers")

517 
	$k¥obe_exô_ôimîs
(
±_ªgs
 *
˘x
) {

518 *
sig«l
 = (*)
	`PT_REGS_PARM1
(
˘x
);

520 
u64
 
pid_tgid
 = 
	`bpf_gë_cuºít_pid_tgid
();

521 
u32
 
tgid
 = 
pid_tgid
 >> 32;

523 
¥oc_ˇche_t
 *
íåy
 = 
	`gë_¥oc_ˇche
(
tgid
);

524 i‡(
íåy
) {

525 
u64
 
ây_off£t
;

526 
	`LOAD_CONSTANT
("ây_off£t", 
ây_off£t
);

528 
u64
 
ây_«me_off£t
;

529 
	`LOAD_CONSTANT
("ây_«me_off£t", 
ây_«me_off£t
);

531 
ây_°ru˘
 *
ây
;

532 
	`bpf_¥obe_ªad
(&
ây
, —ty), (*)
sig«l
 + 
ây_off£t
);

533 
	`bpf_¥obe_ªad_°r
(
íåy
->
ây_«me
, 
TTY_NAME_LEN
, (*)
ây
 + 
ây_«me_off£t
);

537 
	}
}

539 
__©åibuã__
((
Æways_ölöe
)Ë
	$∑r£_¨gs_™d_ív
(
±_ªgs
 *
˘x
) {

540 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
EVENT_EXEC
);

541 i‡(!
sysˇŒ
) {

546 
	`fûl_•™_c⁄ãxt
(&
sysˇŒ
->
exec
.
•™_c⁄ãxt
);

548 
	`bpf_èû_ˇŒ_com∑t
(
˘x
, &
¨gs_ívs_¥ogs
, 
sysˇŒ
->
exec
.
√xt_èû
);

550 
	}
}

552 
SEC
("kprobe/prepare_binprm")

553 
	$k¥obe_¥ï¨e_bö¥m
(
±_ªgs
 *
˘x
) {

554  
	`∑r£_¨gs_™d_ív
(
˘x
);

555 
	}
}

557 
SEC
("kprobe/bprm_execve")

558 
	$k¥obe_b¥m_execve
(
±_ªgs
 *
˘x
) {

559  
	`∑r£_¨gs_™d_ív
(
˘x
);

560 
	}
}

562 
SEC
("kprobe/security_bprm_check")

563 
	$k¥obe_£curôy_b¥m_check
(
±_ªgs
 *
˘x
) {

564  
	`∑r£_¨gs_™d_ív
(
˘x
);

565 
	}
}

567 
__©åibuã__
((
Æways_ölöe
)Ë
	$fûl_¨gs_ívs
(
exec_evít_t
 *
evít
, 
sysˇŒ_ˇche_t
 *
sysˇŒ
) {

568 
evít
->
¨gs_id
 = 
sysˇŒ
->
exec
.
¨gs
.
id
;

569 
evít
->
¨gs_åunˇãd
 = 
sysˇŒ
->
exec
.
¨gs
.
åunˇãd
;

570 
evít
->
ívs_id
 = 
sysˇŒ
->
exec
.
ívs
.
id
;

571 
evít
->
ívs_åunˇãd
 = 
sysˇŒ
->
exec
.
ívs
.
åunˇãd
;

572 
	}
}

574 
SEC
("kprobe/security_bprm_committed_creds")

575 
	$k¥obe_£curôy_b¥m_commôãd_¸eds
(
±_ªgs
 *
˘x
) {

576 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`p›_sysˇŒ
(
EVENT_EXEC
);

577 i‡(!
sysˇŒ
) {

582 
u64
 
pid_tgid
 = 
	`bpf_gë_cuºít_pid_tgid
();

583 
u32
 
tgid
 = 
pid_tgid
 >> 32;

585 
pid_ˇche_t
 *
pid_íåy
 = (pid_ˇche_à*Ë
	`bpf_m≠_lookup_ñem
(&
pid_ˇche
, &
tgid
);

586 i‡(
pid_íåy
) {

587 
u32
 
cookõ
 = 
pid_íåy
->cookie;

588 
¥oc_ˇche_t
 *
¥oc_íåy
 = 
	`bpf_m≠_lookup_ñem
(&
¥oc_ˇche
, &
cookõ
);

589 i‡(
¥oc_íåy
) {

590 
exec_evít_t
 
evít
 = {};

592 
	`c›y_¥oc_ˇche_ex˚±_comm
(
¥oc_íåy
, &
evít
.proc_entry);

593 
	`bpf_gë_cuºít_comm
(&
evít
.
¥oc_íåy
.
comm
, (event.proc_entry.comm));

596 
	`c›y_pid_ˇche_ex˚±_exô_ts
(
pid_íåy
, &
evít
.pid_entry);

599 
	`fûl_¥o˚ss_c⁄ãxt
(&
evít
.
¥o˚ss
);

601 
	`c›y_•™_c⁄ãxt
(&
sysˇŒ
->
exec
.
•™_c⁄ãxt
, &
evít
.
•™
);

602 
	`fûl_¨gs_ívs
(&
evít
, 
sysˇŒ
);

605 
	`£nd_evít
(
˘x
, 
EVENT_EXEC
, 
evít
);

610 
	}
}

	@filename.h

1 #i‚de‡
_FILENAME_H_


2 
	#_FILENAME_H_


	)

4 
	~"sysˇŒs.h
"

6 
SEC
("kprobe/filename_create")

7 
	$k¥obe_fûíame_¸óã
(
±_ªgs
 *
˘x
) {

8 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
EVENT_ANY
);

9 i‡(!
sysˇŒ
)

12 
sysˇŒ
->
ty≥
) {

13 
EVENT_MKDIR
:

14 
sysˇŒ
->
mkdú
.
∑th
 = (∑th *)
	`PT_REGS_PARM3
(
˘x
);

16 
EVENT_LINK
:

17 
sysˇŒ
->
lök
.
èrgë_∑th
 = (
∑th
 *)
	`PT_REGS_PARM3
(
˘x
);

21 
	}
}

	@filters.h

1 #i‚de‡
_FILTERS_H


2 
	#_FILTERS_H


	)

4 
	~"¥o˚ss.h
"

6 
	epﬁicy_mode


8 
	mNO_FILTER
 = 0,

9 
	mACCEPT
 = 1,

10 
	mDENY
 = 2,

13 
	epﬁicy_Êags


15 
	mBASENAME
 = 1,

16 
	mFLAGS
 = 2,

17 
	mMODE
 = 4,

18 
	mPARENT_NAME
 = 8,

21 
	spﬁicy_t
 {

22 
	mmode
;

23 
	mÊags
;

26 
bpf_m≠_def
 
SEC
("m≠s/fûãr_pﬁicy"Ë
	gfûãr_pﬁicy
 = {

27 .
ty≥
 = 
BPF_MAP_TYPE_ARRAY
,

28 .
	gkey_size
 = (
u32
),

29 .
	gvÆue_size
 = (
pﬁicy_t
),

30 .
	gmax_íåõs
 = 
EVENT_MAX
,

31 .
	gpönög
 = 0,

32 .
	g«me•a˚
 = "",

	@ioctl.h

1 #i‚de‡
_IOCTL_H


2 
	#_IOCTL_H


	)

4 
	~"îpc.h
"

6 
SEC
("kprobe/do_vfs_ioctl")

7 
	$k¥obe_do_vfs_io˘l
(
±_ªgs
 *
˘x
) {

8 i‡(
	`is_îpc_ªque°
(
˘x
)) {

9  
	`h™dÀ_îpc_ªque°
(
˘x
);

13 
	}
}

	@link.h

1 #i‚de‡
_LINK_H_


2 
	#_LINK_H_


	)

4 
	~"sysˇŒs.h
"

6 
	slök_evít_t
 {

7 
kevít_t
 
	mevít
;

8 
¥o˚ss_c⁄ãxt_t
 
	m¥o˚ss
;

9 
•™_c⁄ãxt_t
 
	m•™
;

10 
c⁄èöî_c⁄ãxt_t
 
	mc⁄èöî
;

11 
sysˇŒ_t
 
	msysˇŒ
;

12 
fûe_t
 
	msour˚
;

13 
fûe_t
 
	mèrgë
;

16 
__©åibuã__
((
Æways_ölöe
)Ë
	$lök_≠¥ovîs
(
sysˇŒ_ˇche_t
 *
sysˇŒ
) {

17  
	`ba£«me_≠¥ovî
(
sysˇŒ
, sysˇŒ->
lök
.
§c_díåy
, 
EVENT_LINK
) ||

18 
	`ba£«me_≠¥ovî
(
sysˇŒ
, sysˇŒ->
lök
.
èrgë_díåy
, 
EVENT_LINK
);

19 
	}
}

21 
__©åibuã__
((
Æways_ölöe
)Ë
	$åa˚__sys_lök
() {

22 
pﬁicy_t
 
pﬁicy
 = 
	`„tch_pﬁicy
(
EVENT_LINK
);

23 i‡(
	`is_disˇrded_by_¥o˚ss
(
pﬁicy
.
mode
, 
EVENT_LINK
)) {

27 
sysˇŒ_ˇche_t
 
sysˇŒ
 = {

28 .
ty≥
 = 
EVENT_LINK
,

29 .
pﬁicy
 =Öolicy,

32 
	`ˇche_sysˇŒ
(&
sysˇŒ
);

35 
	}
}

37 
	$SYSCALL_KPROBE0
(
lök
) {

38  
	`åa˚__sys_lök
();

39 
	}
}

41 
	$SYSCALL_KPROBE0
(
lök©
) {

42  
	`åa˚__sys_lök
();

43 
	}
}

45 
SEC
("kprobe/vfs_link")

46 
	$k¥obe_vfs_lök
(
±_ªgs
 *
˘x
) {

47 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
EVENT_LINK
);

48 i‡(!
sysˇŒ
)

51 i‡(
sysˇŒ
->
lök
.
èrgë_díåy
) {

55 
díåy
 *
§c_díåy
 = (díåy *)
	`PT_REGS_PARM1
(
˘x
);

56 
sysˇŒ
->
lök
.
§c_díåy
 = src_dentry;

58 
sysˇŒ
->
lök
.
èrgë_díåy
 = (
díåy
 *)
	`PT_REGS_PARM3
(
˘x
);

60 i‡(
	`gë_vfs_lök_èrgë_díåy_posôi⁄
(Ë=
VFS_ARG_POSITION4
) {

62 
	`bpf_¥obe_ªad
(&
sysˇŒ
->
lök
.
èrgë_díåy
, (syscall->link.target_dentry), &syscall->link.target_dentry);

63 
sysˇŒ
->
lök
.
èrgë_díåy
 = (
díåy
 *Ë
	`PT_REGS_PARM4
(
˘x
);

68 
sysˇŒ
->
lök
.
§c_fûe
.
∑th_key
.
mou¡_id
 = 
	`gë_∑th_mou¡_id
(sysˇŒ->lök.
èrgë_∑th
);

69 
	`£t_fûe_öode
(
§c_díåy
, &
sysˇŒ
->
lök
.
§c_fûe
, 0);

71 i‡(
	`fûãr_sysˇŒ
(
sysˇŒ
, 
lök_≠¥ovîs
)) {

72  
	`m¨k_as_disˇrded
(
sysˇŒ
);

75 
	`fûl_fûe_mëad©a
(
§c_díåy
, &
sysˇŒ
->
lök
.
§c_fûe
.
mëad©a
);

76 
sysˇŒ
->
lök
.
èrgë_fûe
.
mëad©a
 = sysˇŒ->lök.
§c_fûe
.metadata;

79 
sysˇŒ
->
lök
.
èrgë_fûe
.
∑th_key
.
öo
 = 
FAKE_INODE_MSW
<<32 | 
	`bpf_gë_¥™dom_u32
();

80 
sysˇŒ
->
lök
.
èrgë_fûe
.
∑th_key
.
mou¡_id
 = sysˇŒ->lök.
§c_fûe
.path_key.mount_id;

81 i‡(
	`is_ovîœyfs
(
§c_díåy
))

82 
sysˇŒ
->
lök
.
èrgë_fûe
.
Êags
 |
UPPER_LAYER
;

84 
sysˇŒ
->
ªsﬁvî
.
díåy
 = 
§c_díåy
;

85 
sysˇŒ
->
ªsﬁvî
.
key
 = sysˇŒ->
lök
.
§c_fûe
.
∑th_key
;

86 
sysˇŒ
->
ªsﬁvî
.
disˇrdî_ty≥
 = sysˇŒ->
pﬁicy
.
mode
 !
NO_FILTER
 ? 
EVENT_LINK
 : 0;

87 
sysˇŒ
->
ªsﬁvî
.
ˇŒback
 = 
DR_LINK_SRC_CALLBACK_KPROBE_KEY
;

88 
sysˇŒ
->
ªsﬁvî
.
ôî©i⁄
 = 0;

89 
sysˇŒ
->
ªsﬁvî
.
ªt
 = 0;

91 
	`ªsﬁve_díåy
(
˘x
, 
DR_KPROBE
);

93 
	}
}

95 
SEC
("kprobe/dr_link_src_callback")

96 
__©åibuã__
((
Æways_ölöe
)Ë
	$k¥obe_dr_lök_§c_ˇŒback
(
±_ªgs
 *
˘x
) {

97 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
EVENT_LINK
);

98 i‡(!
sysˇŒ
)

101 i‡(
sysˇŒ
->
ªsﬁvî
.
ªt
 =
DENTRY_DISCARDED
) {

102  
	`m¨k_as_disˇrded
(
sysˇŒ
);

106 
	}
}

108 
__©åibuã__
((
Æways_ölöe
)Ë
	$sys_lök_ªt
(*
˘x
, 
ªtvÆ
, 
dr_ty≥
) {

109 i‡(
	`IS_UNHANDLED_ERROR
(
ªtvÆ
))

112 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
EVENT_LINK
);

113 i‡(!
sysˇŒ
)

116 
∑ss_to_u£r•a˚
 = !
sysˇŒ
->
disˇrded
 && 
	`is_evít_íabÀd
(
EVENT_LINK
);

119 i‡(
ªtvÆ
 >= 0) {

121 
	`övÆid©e_öode
(
˘x
, 
sysˇŒ
->
lök
.
§c_fûe
.
∑th_key
.
mou¡_id
, sysˇŒ->lök.§c_fûe.∑th_key.
öo
, !
∑ss_to_u£r•a˚
);

124 i‡(
∑ss_to_u£r•a˚
) {

125 
sysˇŒ
->
ªsﬁvî
.
díåy
 = sysˇŒ->
lök
.
èrgë_díåy
;

126 
sysˇŒ
->
ªsﬁvî
.
key
 = sysˇŒ->
lök
.
èrgë_fûe
.
∑th_key
;

127 
sysˇŒ
->
ªsﬁvî
.
disˇrdî_ty≥
 = 0;

128 
sysˇŒ
->
ªsﬁvî
.
ˇŒback
 = 
dr_ty≥
 =
DR_KPROBE
 ? 
DR_LINK_DST_CALLBACK_KPROBE_KEY
 : 
DR_LINK_DST_CALLBACK_TRACEPOINT_KEY
;

129 
sysˇŒ
->
ªsﬁvî
.
ôî©i⁄
 = 0;

130 
sysˇŒ
->
ªsﬁvî
.
ªt
 = 0;

132 
	`ªsﬁve_díåy
(
˘x
, 
dr_ty≥
);

136 
	`p›_sysˇŒ
(
EVENT_LINK
);

138 
	}
}

140 
__©åibuã__
((
Æways_ölöe
)Ë
	$k¥obe_sys_lök_ªt
(
±_ªgs
 *
˘x
) {

141 
ªtvÆ
 = 
	`PT_REGS_RC
(
˘x
);

142  
	`sys_lök_ªt
(
˘x
, 
ªtvÆ
, 
DR_KPROBE
);

143 
	}
}

145 
SEC
("tracepoint/syscalls/sys_exit_link")

146 
	$åa˚poöt_sysˇŒs_sys_exô_lök
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

147  
	`sys_lök_ªt
(
¨gs
,árgs->
ªt
, 
DR_TRACEPOINT
);

148 
	}
}

150 
	$SYSCALL_KRETPROBE
(
lök
) {

151  
	`k¥obe_sys_lök_ªt
(
˘x
);

152 
	}
}

154 
SEC
("tracepoint/syscalls/sys_exit_linkat")

155 
	$åa˚poöt_sysˇŒs_sys_exô_lök©
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

156  
	`sys_lök_ªt
(
¨gs
,árgs->
ªt
, 
DR_TRACEPOINT
);

157 
	}
}

159 
	$SYSCALL_KRETPROBE
(
lök©
) {

160  
	`k¥obe_sys_lök_ªt
(
˘x
);

161 
	}
}

163 
SEC
("tracepoint/handle_sys_link_exit")

164 
	$åa˚poöt_h™dÀ_sys_lök_exô
(
åa˚poöt_øw_sysˇŒs_sys_exô_t
 *
¨gs
) {

165  
	`sys_lök_ªt
(
¨gs
,árgs->
ªt
, 
DR_TRACEPOINT
);

166 
	}
}

168 
__©åibuã__
((
Æways_ölöe
)Ë
	$dr_lök_d°_ˇŒback
(*
˘x
, 
ªtvÆ
) {

169 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`p›_sysˇŒ
(
EVENT_LINK
);

170 i‡(!
sysˇŒ
)

173 i‡(
	`IS_UNHANDLED_ERROR
(
ªtvÆ
))

176 
lök_evít_t
 
evít
 = {

177 .
evít
.
ty≥
 = 
EVENT_LINK
,

178 .
evít
.
time°amp
 = 
	`bpf_ktime_gë_ns
(),

179 .
sysˇŒ
.
ªtvÆ
 =Ñetval,

180 .
sour˚
 = 
sysˇŒ
->
lök
.
§c_fûe
,

181 .
èrgë
 = 
sysˇŒ
->
lök
.
èrgë_fûe
,

184 
¥oc_ˇche_t
 *
íåy
 = 
	`fûl_¥o˚ss_c⁄ãxt
(&
evít
.
¥o˚ss
);

185 
	`fûl_c⁄èöî_c⁄ãxt
(
íåy
, &
evít
.
c⁄èöî
);

186 
	`fûl_•™_c⁄ãxt
(&
evít
.
•™
);

188 
	`£nd_evít
(
˘x
, 
EVENT_LINK
, 
evít
);

191 
	}
}

193 
SEC
("kprobe/dr_link_dst_callback")

194 
__©åibuã__
((
Æways_ölöe
)Ë
	$k¥obe_dr_lök_d°_ˇŒback
(
±_ªgs
 *
˘x
) {

195 
ªt
 = 
	`PT_REGS_RC
(
˘x
);

196  
	`dr_lök_d°_ˇŒback
(
˘x
, 
ªt
);

197 
	}
}

199 
SEC
("tracepoint/dr_link_dst_callback")

200 
__©åibuã__
((
Æways_ölöe
)Ë
	$åa˚poöt_dr_lök_d°_ˇŒback
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

201  
	`dr_lök_d°_ˇŒback
(
¨gs
,árgs->
ªt
);

202 
	}
}

	@mkdir.h

1 #i‚de‡
_MKDIR_H_


2 
	#_MKDIR_H_


	)

4 
	~"sysˇŒs.h
"

6 
	smkdú_evít_t
 {

7 
kevít_t
 
	mevít
;

8 
¥o˚ss_c⁄ãxt_t
 
	m¥o˚ss
;

9 
•™_c⁄ãxt_t
 
	m•™
;

10 
c⁄èöî_c⁄ãxt_t
 
	mc⁄èöî
;

11 
sysˇŒ_t
 
	msysˇŒ
;

12 
fûe_t
 
	mfûe
;

13 
u32
 
	mmode
;

14 
u32
 
	m∑ddög
;

17 
__©åibuã__
((
Æways_ölöe
)Ë
	$mkdú_≠¥ovîs
(
sysˇŒ_ˇche_t
 *
sysˇŒ
) {

18  
	`ba£«me_≠¥ovî
(
sysˇŒ
, sysˇŒ->
mkdú
.
díåy
, 
EVENT_MKDIR
);

19 
	}
}

21 
__©åibuã__
((
Æways_ölöe
)Ë
	$åa˚__sys_mkdú
(
umode_t
 
mode
) {

22 
pﬁicy_t
 
pﬁicy
 = 
	`„tch_pﬁicy
(
EVENT_MKDIR
);

23 i‡(
	`is_disˇrded_by_¥o˚ss
(
pﬁicy
.
mode
, 
EVENT_MKDIR
)) {

27 
sysˇŒ_ˇche_t
 
sysˇŒ
 = {

28 .
ty≥
 = 
EVENT_MKDIR
,

29 .
pﬁicy
 =Öolicy,

30 .
mkdú
 = {

31 .
mode
 = mode

35 
	`ˇche_sysˇŒ
(&
sysˇŒ
);

38 
	}
}

40 
	$SYSCALL_KPROBE2
(
mkdú
, c⁄° *, 
fûíame
, 
umode_t
, 
mode
)

42  
	`åa˚__sys_mkdú
(
mode
);

43 
	}
}

45 
	$SYSCALL_KPROBE3
(
mkdú©
, , 
dúfd
, c⁄° *, 
fûíame
, 
umode_t
, 
mode
)

47  
	`åa˚__sys_mkdú
(
mode
);

48 
	}
}

50 
SEC
("kprobe/vfs_mkdir")

51 
	$k¥obe_vfs_mkdú
(
±_ªgs
 *
˘x
) {

52 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
EVENT_MKDIR
);

53 i‡(!
sysˇŒ
)

56 i‡(
sysˇŒ
->
mkdú
.
díåy
) {

60 
sysˇŒ
->
mkdú
.
díåy
 = (díåy *Ë
	`PT_REGS_PARM2
(
˘x
);

62 i‡(
	`gë_vfs_mkdú_díåy_posôi⁄
(Ë=
VFS_ARG_POSITION3
) {

64 
	`bpf_¥obe_ªad
(&
sysˇŒ
->
mkdú
.
díåy
, (syscall->mkdir.dentry), &syscall->mkdir.dentry);

65 
sysˇŒ
->
mkdú
.
díåy
 = (díåy *Ë
	`PT_REGS_PARM3
(
˘x
);

68 
sysˇŒ
->
mkdú
.
fûe
.
∑th_key
.
mou¡_id
 = 
	`gë_∑th_mou¡_id
(sysˇŒ->mkdú.
∑th
);

70 i‡(
	`fûãr_sysˇŒ
(
sysˇŒ
, 
mkdú_≠¥ovîs
)) {

71  
	`disˇrd_sysˇŒ
(
sysˇŒ
);

75 
	}
}

77 
__©åibuã__
((
Æways_ölöe
)Ë
	$sys_mkdú_ªt
(*
˘x
, 
ªtvÆ
, 
dr_ty≥
) {

78 i‡(
	`IS_UNHANDLED_ERROR
(
ªtvÆ
))

81 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
EVENT_MKDIR
);

82 i‡(!
sysˇŒ
)

86 
	`£t_fûe_öode
(
sysˇŒ
->
mkdú
.
díåy
, &sysˇŒ->mkdú.
fûe
, 0);

88 
sysˇŒ
->
ªsﬁvî
.
key
 = sysˇŒ->
mkdú
.
fûe
.
∑th_key
;

89 
sysˇŒ
->
ªsﬁvî
.
díåy
 = sysˇŒ->
mkdú
.dentry;

90 
sysˇŒ
->
ªsﬁvî
.
disˇrdî_ty≥
 = sysˇŒ->
pﬁicy
.
mode
 !
NO_FILTER
 ? 
EVENT_MKDIR
 : 0;

91 
sysˇŒ
->
ªsﬁvî
.
ˇŒback
 = 
dr_ty≥
 =
DR_KPROBE
 ? 
DR_MKDIR_CALLBACK_KPROBE_KEY
 : 
DR_MKDIR_CALLBACK_TRACEPOINT_KEY
;

92 
sysˇŒ
->
ªsﬁvî
.
ôî©i⁄
 = 0;

93 
sysˇŒ
->
ªsﬁvî
.
ªt
 = 0;

95 
	`ªsﬁve_díåy
(
˘x
, 
dr_ty≥
);

98 
	`p›_sysˇŒ
(
EVENT_MKDIR
);

100 
	}
}

102 
__©åibuã__
((
Æways_ölöe
)Ë
	$k¥obe_sys_mkdú_ªt
(
±_ªgs
 *
˘x
) {

103 
ªtvÆ
 = 
	`PT_REGS_RC
(
˘x
);

104  
	`sys_mkdú_ªt
(
˘x
, 
ªtvÆ
, 
DR_KPROBE
);

105 
	}
}

107 
SEC
("tracepoint/syscalls/sys_exit_mkdir")

108 
	$åa˚poöt_sysˇŒs_sys_exô_mkdú
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

109  
	`sys_mkdú_ªt
(
¨gs
,árgs->
ªt
, 
DR_TRACEPOINT
);

110 
	}
}

112 
	$SYSCALL_KRETPROBE
(
mkdú
)

114  
	`k¥obe_sys_mkdú_ªt
(
˘x
);

115 
	}
}

117 
SEC
("tracepoint/syscalls/sys_exit_mkdirat")

118 
	$åa˚poöt_sysˇŒs_sys_exô_mkdú©
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

119  
	`sys_mkdú_ªt
(
¨gs
,árgs->
ªt
, 
DR_TRACEPOINT
);

120 
	}
}

122 
	$SYSCALL_KRETPROBE
(
mkdú©
) {

123  
	`k¥obe_sys_mkdú_ªt
(
˘x
);

124 
	}
}

126 
SEC
("tracepoint/handle_sys_mkdir_exit")

127 
	$åa˚poöt_h™dÀ_sys_mkdú_exô
(
åa˚poöt_øw_sysˇŒs_sys_exô_t
 *
¨gs
) {

128  
	`sys_mkdú_ªt
(
¨gs
,árgs->
ªt
, 
DR_TRACEPOINT
);

129 
	}
}

131 
__©åibuã__
((
Æways_ölöe
)Ë
	$dr_mkdú_ˇŒback
(*
˘x
, 
ªtvÆ
) {

132 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`p›_sysˇŒ
(
EVENT_MKDIR
);

133 i‡(!
sysˇŒ
)

136 i‡(
	`IS_UNHANDLED_ERROR
(
ªtvÆ
))

139 i‡(
sysˇŒ
->
ªsﬁvî
.
ªt
 =
DENTRY_DISCARDED
) {

143 
mkdú_evít_t
 
evít
 = {

144 .
sysˇŒ
.
ªtvÆ
 =Ñetval,

145 .
fûe
 = 
sysˇŒ
->
mkdú
.file,

146 .
mode
 = 
sysˇŒ
->
mkdú
.mode,

149 
	`fûl_fûe_mëad©a
(
sysˇŒ
->
mkdú
.
díåy
, &
evít
.
fûe
.
mëad©a
);

150 
¥oc_ˇche_t
 *
íåy
 = 
	`fûl_¥o˚ss_c⁄ãxt
(&
evít
.
¥o˚ss
);

151 
	`fûl_c⁄èöî_c⁄ãxt
(
íåy
, &
evít
.
c⁄èöî
);

152 
	`fûl_•™_c⁄ãxt
(&
evít
.
•™
);

154 
	`£nd_evít
(
˘x
, 
EVENT_MKDIR
, 
evít
);

156 
	}
}

158 
SEC
("kprobe/dr_mkdir_callback")

159 
__©åibuã__
((
Æways_ölöe
)Ë
	$k¥obe_dr_mkdú_ˇŒback
(
±_ªgs
 *
˘x
) {

160 
ªtvÆ
 = 
	`PT_REGS_RC
(
˘x
);

161  
	`dr_mkdú_ˇŒback
(
˘x
, 
ªtvÆ
);

162 
	}
}

164 
SEC
("tracepoint/dr_mkdir_callback")

165 
__©åibuã__
((
Æways_ölöe
)Ë
	$åa˚poöt_dr_mkdú_ˇŒback
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

166  
	`dr_mkdú_ˇŒback
(
¨gs
,árgs->
ªt
);

167 
	}
}

	@mmap.h

1 #i‚de‡
_MMAP_H_


2 
	#_MMAP_H_


	)

4 
bpf_m≠_def
 
SEC
("m≠s/mm≠_Êags_≠¥ovîs"Ë
	gmm≠_Êags_≠¥ovîs
 = {

5 .
ty≥
 = 
BPF_MAP_TYPE_ARRAY
,

6 .
	gkey_size
 = (
u32
),

7 .
	gvÆue_size
 = (
u32
),

8 .
	gmax_íåõs
 = 1,

9 .
	gpönög
 = 0,

10 .
	g«me•a˚
 = "",

13 
__©åibuã__
((
Æways_ölöe
)Ë
	$≠¥ove_mm≠_by_Êags
(
sysˇŒ_ˇche_t
 *
sysˇŒ
) {

14 
u32
 
key
 = 0;

15 
u32
 *
Êags
 = 
	`bpf_m≠_lookup_ñem
(&
mm≠_Êags_≠¥ovîs
, &
key
);

16 i‡(
Êags
 !
NULL
 && (
sysˇŒ
->
mm≠
.flags & *flags) > 0) {

20 
	}
}

22 
bpf_m≠_def
 
SEC
("m≠s/mm≠_¥Ÿe˘i⁄_≠¥ovîs"Ë
	gmm≠_¥Ÿe˘i⁄_≠¥ovîs
 = {

23 .
ty≥
 = 
BPF_MAP_TYPE_ARRAY
,

24 .
	gkey_size
 = (
u32
),

25 .
	gvÆue_size
 = (
u32
),

26 .
	gmax_íåõs
 = 1,

27 .
	gpönög
 = 0,

28 .
	g«me•a˚
 = "",

31 
__©åibuã__
((
Æways_ölöe
)Ë
	$≠¥ove_mm≠_by_¥Ÿe˘i⁄
(
sysˇŒ_ˇche_t
 *
sysˇŒ
) {

32 
u32
 
key
 = 0;

33 
u32
 *
Êags
 = 
	`bpf_m≠_lookup_ñem
(&
mm≠_¥Ÿe˘i⁄_≠¥ovîs
, &
key
);

34 i‡(
Êags
 !
NULL
 && (
sysˇŒ
->
mm≠
.
¥Ÿe˘i⁄
 & *flags) > 0) {

38 
	}
}

40 
__©åibuã__
((
Æways_ölöe
)Ë
	$mm≠_≠¥ovîs
(
sysˇŒ_ˇche_t
 *
sysˇŒ
) {

41 
∑ss_to_u£r•a˚
 = 0;

43 i‡((
sysˇŒ
->
pﬁicy
.
Êags
 & 
BASENAME
Ë> 0 && sysˇŒ->
mm≠
.
díåy
 !
NULL
) {

44 
∑ss_to_u£r•a˚
 = 
	`≠¥ove_by_ba£«me
(
sysˇŒ
->
mm≠
.
díåy
, 
EVENT_MMAP
);

47 i‡(!
∑ss_to_u£r•a˚
 && (
sysˇŒ
->
pﬁicy
.
Êags
 & 
FLAGS
) > 0) {

48 
∑ss_to_u£r•a˚
 = 
	`≠¥ove_mm≠_by_¥Ÿe˘i⁄
(
sysˇŒ
);

49 i‡(!
∑ss_to_u£r•a˚
) {

50 
∑ss_to_u£r•a˚
 = 
	`≠¥ove_mm≠_by_Êags
(
sysˇŒ
);

54  
∑ss_to_u£r•a˚
;

55 
	}
}

57 
	smm≠_evít_t
 {

58 
kevít_t
 
	mevít
;

59 
¥o˚ss_c⁄ãxt_t
 
	m¥o˚ss
;

60 
•™_c⁄ãxt_t
 
	m•™
;

61 
c⁄èöî_c⁄ãxt_t
 
	mc⁄èöî
;

62 
sysˇŒ_t
 
	msysˇŒ
;

64 
fûe_t
 
	mfûe
;

65 
u64
 
	maddr
;

66 
u64
 
	moff£t
;

67 
u32
 
	mÀn
;

68 
	m¥Ÿe˘i⁄
;

69 
	mÊags
;

70 
u32
 
	m∑ddög
;

73 
	såa˚poöt_sysˇŒs_sys_íãr_mm≠_t
 {

74 
	mcomm⁄_ty≥
;

75 
	mcomm⁄_Êags
;

76 
	mcomm⁄_¥ìm±_cou¡
;

77 
	mcomm⁄_pid
;

79 
	m__sysˇŒ_ƒ
;

80 
	maddr
;

81 
	mÀn
;

82 
	m¥Ÿe˘i⁄
;

83 
	mÊags
;

84 
	mfd
;

85 
	moff£t
;

88 
SEC
("tracepoint/syscalls/sys_enter_mmap")

89 
	$åa˚poöt_sysˇŒs_sys_íãr_mm≠
(
åa˚poöt_sysˇŒs_sys_íãr_mm≠_t
 *
¨gs
) {

90 
pﬁicy_t
 
pﬁicy
 = 
	`„tch_pﬁicy
(
EVENT_MMAP
);

91 i‡(
	`is_disˇrded_by_¥o˚ss
(
pﬁicy
.
mode
, 
EVENT_MMAP
)) {

95 
sysˇŒ_ˇche_t
 
sysˇŒ
 = {

96 .
ty≥
 = 
EVENT_MMAP
,

97 .
mm≠
 = {

98 .
off£t
 = 
¨gs
->offset,

99 .
Àn
 = (
u32
)
¨gs
->len,

100 .
¥Ÿe˘i⁄
 = ()
¨gs
->protection,

101 .
Êags
 = ()
¨gs
->flags,

105 
	`ˇche_sysˇŒ
(&
sysˇŒ
);

107 
	}
}

109 
__©åibuã__
((
Æways_ölöe
)Ë
	$sys_mm≠_ªt
(*
˘x
, 
ªtvÆ
, 
u64
 
addr
) {

110 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`p›_sysˇŒ
(
EVENT_MMAP
);

111 i‡(!
sysˇŒ
)

114 i‡(
sysˇŒ
->
ªsﬁvî
.
ªt
 =
DENTRY_DISCARDED
) {

118 i‡(
	`fûãr_sysˇŒ
(
sysˇŒ
, 
mm≠_≠¥ovîs
)) {

119  
	`disˇrd_sysˇŒ
(
sysˇŒ
);

122 i‡(
ªtvÆ
 != -1) {

123 
ªtvÆ
 = 0;

126 
mm≠_evít_t
 
evít
 = {

127 .
sysˇŒ
.
ªtvÆ
 =Ñetval,

128 .
fûe
 = 
sysˇŒ
->
mm≠
.file,

129 .
addr
 =áddr,

130 .
off£t
 = 
sysˇŒ
->
mm≠
.offset,

131 .
Àn
 = 
sysˇŒ
->
mm≠
.len,

132 .
¥Ÿe˘i⁄
 = 
sysˇŒ
->
mm≠
.protection,

133 .
Êags
 = 
sysˇŒ
->
mm≠
.flags,

136 i‡(
sysˇŒ
->
mm≠
.
díåy
 !
NULL
) {

137 
	`fûl_fûe_mëad©a
(
sysˇŒ
->
mm≠
.
díåy
, &
evít
.
fûe
.
mëad©a
);

139 
¥oc_ˇche_t
 *
íåy
 = 
	`fûl_¥o˚ss_c⁄ãxt
(&
evít
.
¥o˚ss
);

140 
	`fûl_c⁄èöî_c⁄ãxt
(
íåy
, &
evít
.
c⁄èöî
);

141 
	`fûl_•™_c⁄ãxt
(&
evít
.
•™
);

143 
	`£nd_evít
(
˘x
, 
EVENT_MMAP
, 
evít
);

145 
	}
}

147 
	$SYSCALL_KRETPROBE
(
mm≠
) {

148  
	`sys_mm≠_ªt
(
˘x
, ()
	`PT_REGS_RC
(˘x), (
u64
)PT_REGS_RC(ctx));

149 
	}
}

151 
SEC
("tracepoint/syscalls/sys_exit_mmap")

152 
	$åa˚poöt_sysˇŒs_sys_exô_mm≠
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

153  
	`sys_mm≠_ªt
(
¨gs
, (Ôrgs->
ªt
, (
u64
)args->ret);

154 
	}
}

156 
SEC
("kretprobe/fget")

157 
	$kªçrobe_fgë
(
±_ªgs
 *
˘x
) {

158 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
EVENT_MMAP
);

159 i‡(!
sysˇŒ
)

162 
fûe
 *
f
 = (fûe*Ë
	`PT_REGS_RC
(
˘x
);

163 
sysˇŒ
->
mm≠
.
díåy
 = 
	`gë_fûe_díåy
(
f
);

164 
	`£t_fûe_öode
(
sysˇŒ
->
mm≠
.
díåy
, &sysˇŒ->mm≠.
fûe
, 0);

165 
sysˇŒ
->
mm≠
.
fûe
.
∑th_key
.
mou¡_id
 = 
	`gë_fûe_mou¡_id
(
f
);

167 
sysˇŒ
->
ªsﬁvî
.
key
 = sysˇŒ->
mm≠
.
fûe
.
∑th_key
;

168 
sysˇŒ
->
ªsﬁvî
.
díåy
 = sysˇŒ->
mm≠
.dentry;

169 
sysˇŒ
->
ªsﬁvî
.
disˇrdî_ty≥
 = sysˇŒ->
pﬁicy
.
mode
 !
NO_FILTER
 ? 
EVENT_MMAP
 : 0;

170 
sysˇŒ
->
ªsﬁvî
.
ôî©i⁄
 = 0;

171 
sysˇŒ
->
ªsﬁvî
.
ªt
 = 0;

173 
	`ªsﬁve_díåy
(
˘x
, 
DR_KPROBE
);

175 
	}
}

	@mnt.h

1 #i‚de‡
_MNT_H_


2 
	#_MNT_H_


	)

4 
	~"sysˇŒs.h
"

6 
__©åibuã__
((
Æways_ölöe
)Ë
	$m¡_w™t_wrôe_¥ediˇã
(
u64
 
ty≥
) {

7  
ty≥
 =
EVENT_UTIME
 ||Åy≥ =
EVENT_CHMOD
 ||Åy≥ =
EVENT_CHOWN
 ||Åy≥ =
EVENT_RENAME
 ||

8 
ty≥
 =
EVENT_RMDIR
 ||Åy≥ =
EVENT_UNLINK
 ||Åy≥ =
EVENT_SETXATTR
 ||Åy≥ =
EVENT_REMOVEXATTR
;

9 
	}
}

11 
SEC
("kprobe/mnt_want_write")

12 
	$k¥obe_m¡_w™t_wrôe
(
±_ªgs
 *
˘x
) {

13 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ_wôh
(
m¡_w™t_wrôe_¥ediˇã
);

14 i‡(!
sysˇŒ
)

17 
vfsmou¡
 *
m¡
 = (vfsmou¡ *)
	`PT_REGS_PARM1
(
˘x
);

19 
sysˇŒ
->
ty≥
) {

20 
EVENT_UTIME
:

21 i‡(
sysˇŒ
->
£èâr
.
fûe
.
∑th_key
.
mou¡_id
 > 0)

23 
sysˇŒ
->
£èâr
.
fûe
.
∑th_key
.
mou¡_id
 = 
	`gë_vfsmou¡_mou¡_id
(
m¡
);

25 
EVENT_CHMOD
:

26 i‡(
sysˇŒ
->
£èâr
.
fûe
.
∑th_key
.
mou¡_id
 > 0)

28 
sysˇŒ
->
£èâr
.
fûe
.
∑th_key
.
mou¡_id
 = 
	`gë_vfsmou¡_mou¡_id
(
m¡
);

30 
EVENT_CHOWN
:

31 i‡(
sysˇŒ
->
£èâr
.
fûe
.
∑th_key
.
mou¡_id
 > 0)

33 
sysˇŒ
->
£èâr
.
fûe
.
∑th_key
.
mou¡_id
 = 
	`gë_vfsmou¡_mou¡_id
(
m¡
);

35 
EVENT_RENAME
:

36 i‡(
sysˇŒ
->
ª«me
.
§c_fûe
.
∑th_key
.
mou¡_id
 > 0)

38 
sysˇŒ
->
ª«me
.
§c_fûe
.
∑th_key
.
mou¡_id
 = 
	`gë_vfsmou¡_mou¡_id
(
m¡
);

39 
sysˇŒ
->
ª«me
.
èrgë_fûe
.
∑th_key
.
mou¡_id
 = sysˇŒ->ª«me.
§c_fûe
.path_key.mount_id;

41 
EVENT_RMDIR
:

42 i‡(
sysˇŒ
->
rmdú
.
fûe
.
∑th_key
.
mou¡_id
 > 0)

44 
sysˇŒ
->
rmdú
.
fûe
.
∑th_key
.
mou¡_id
 = 
	`gë_vfsmou¡_mou¡_id
(
m¡
);

46 
EVENT_UNLINK
:

47 i‡(
sysˇŒ
->
u∆ök
.
fûe
.
∑th_key
.
mou¡_id
 > 0)

49 
sysˇŒ
->
u∆ök
.
fûe
.
∑th_key
.
mou¡_id
 = 
	`gë_vfsmou¡_mou¡_id
(
m¡
);

51 
EVENT_SETXATTR
:

52 i‡(
sysˇŒ
->
x©å
.
fûe
.
∑th_key
.
mou¡_id
 > 0)

54 
sysˇŒ
->
x©å
.
fûe
.
∑th_key
.
mou¡_id
 = 
	`gë_vfsmou¡_mou¡_id
(
m¡
);

56 
EVENT_REMOVEXATTR
:

57 i‡(
sysˇŒ
->
x©å
.
fûe
.
∑th_key
.
mou¡_id
 > 0)

59 
sysˇŒ
->
x©å
.
fûe
.
∑th_key
.
mou¡_id
 = 
	`gë_vfsmou¡_mou¡_id
(
m¡
);

63 
	}
}

65 
__©åibuã__
((
Æways_ölöe
)Ë
	$m¡_w™t_wrôe_fûe_¥ediˇã
(
u64
 
ty≥
) {

66  
ty≥
 =
EVENT_SETXATTR
 ||Åy≥ =
EVENT_REMOVEXATTR
 ||Åy≥ =
EVENT_CHOWN
;

67 
	}
}

69 
__©åibuã__
((
Æways_ölöe
)Ë
	$åa˚__m¡_w™t_wrôe_fûe
(
±_ªgs
 *
˘x
) {

70 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ_wôh
(
m¡_w™t_wrôe_fûe_¥ediˇã
);

71 i‡(!
sysˇŒ
)

74 
fûe
 *fûê(fûê*)
	`PT_REGS_PARM1
(
˘x
);

75 
vfsmou¡
 *
m¡
;

76 
	`bpf_¥obe_ªad
(&
m¡
, (m¡), &
fûe
->
f_∑th
.mnt);

78 
sysˇŒ
->
ty≥
) {

79 
EVENT_CHOWN
:

80 i‡(
sysˇŒ
->
£èâr
.
fûe
.
∑th_key
.
mou¡_id
 > 0)

82 
sysˇŒ
->
£èâr
.
fûe
.
∑th_key
.
mou¡_id
 = 
	`gë_vfsmou¡_mou¡_id
(
m¡
);

84 
EVENT_SETXATTR
:

85 i‡(
sysˇŒ
->
x©å
.
fûe
.
∑th_key
.
mou¡_id
 > 0)

87 
sysˇŒ
->
x©å
.
fûe
.
∑th_key
.
mou¡_id
 = 
	`gë_vfsmou¡_mou¡_id
(
m¡
);

89 
EVENT_REMOVEXATTR
:

90 i‡(
sysˇŒ
->
x©å
.
fûe
.
∑th_key
.
mou¡_id
 > 0)

92 
sysˇŒ
->
x©å
.
fûe
.
∑th_key
.
mou¡_id
 = 
	`gë_vfsmou¡_mou¡_id
(
m¡
);

96 
	}
}

98 
SEC
("kprobe/mnt_want_write_file")

99 
	$k¥obe_m¡_w™t_wrôe_fûe
(
±_ªgs
 *
˘x
) {

100  
	`åa˚__m¡_w™t_wrôe_fûe
(
˘x
);

101 
	}
}

104 
SEC
("kprobe/mnt_want_write_file_path")

105 
	$k¥obe_m¡_w™t_wrôe_fûe_∑th
(
±_ªgs
 *
˘x
) {

106  
	`åa˚__m¡_w™t_wrôe_fûe
(
˘x
);

107 
	}
}

	@mount.h

1 #i‚de‡
_MOUNT_H_


2 
	#_MOUNT_H_


	)

4 
	~"sysˇŒs.h
"

6 
	#FSTYPE_LEN
 16

	)

8 
	smou¡_evít_t
 {

9 
kevít_t
 
	mevít
;

10 
¥o˚ss_c⁄ãxt_t
 
	m¥o˚ss
;

11 
•™_c⁄ãxt_t
 
	m•™
;

12 
c⁄èöî_c⁄ãxt_t
 
	mc⁄èöî
;

13 
sysˇŒ_t
 
	msysˇŒ
;

14 
u32
 
	mmou¡_id
;

15 
u32
 
	mgroup_id
;

16 
dev_t
 
	mdevi˚
;

17 
u32
 
	m∑ª¡_mou¡_id
;

18 
	m∑ª¡_öode
;

19 
	mroŸ_öode
;

20 
u32
 
	mroŸ_mou¡_id
;

21 
u32
 
	m∑ddög
;

22 
	mf°y≥
[
FSTYPE_LEN
];

25 
	$SYSCALL_COMPAT_KPROBE3
(
mou¡
, c⁄° *, 
sour˚
, c⁄° *, 
èrgë
, c⁄° *, 
f°y≥
) {

26 
sysˇŒ_ˇche_t
 
sysˇŒ
 = {

27 .
ty≥
 = 
EVENT_MOUNT
,

30 
	`ˇche_sysˇŒ
(&
sysˇŒ
);

32 
	}
}

34 
SEC
("kprobe/attach_recursive_mnt")

35 
	$k¥obe_©èch_ªcursive_m¡
(
±_ªgs
 *
˘x
) {

36 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
EVENT_MOUNT
);

37 i‡(!
sysˇŒ
)

40 
sysˇŒ
->
mou¡
.
§c_m¡
 = (mou¡ *)
	`PT_REGS_PARM1
(
˘x
);

41 
sysˇŒ
->
mou¡
.
de°_m¡
 = (mou¡ *)
	`PT_REGS_PARM2
(
˘x
);

42 
sysˇŒ
->
mou¡
.
de°_mou¡poöt
 = (
mou¡poöt
 *)
	`PT_REGS_PARM3
(
˘x
);

45 
díåy
 *díåy = 
	`gë_vfsmou¡_díåy
(
	`gë_mou¡_vfsmou¡
(
sysˇŒ
->
mou¡
.
§c_m¡
));

46 
sysˇŒ
->
mou¡
.
roŸ_key
.
mou¡_id
 = 
	`gë_mou¡_mou¡_id
(sysˇŒ->mou¡.
§c_m¡
);

47 
sysˇŒ
->
mou¡
.
roŸ_key
.
öo
 = 
	`gë_díåy_öo
(
díåy
);

49 
su≥r_block
 *
sb
 = 
	`gë_díåy_sb
(
díåy
);

50 
fûe_sy°em_ty≥
 *
s_ty≥
 = 
	`gë_su≥r_block_fs
(
sb
);

51 
	`bpf_¥obe_ªad
(&
sysˇŒ
->
mou¡
.
f°y≥
, (sysˇŒ->mou¡.f°y≥), &
s_ty≥
->
«me
);

53 
sysˇŒ
->
ªsﬁvî
.
key
 = sysˇŒ->
mou¡
.
roŸ_key
;

54 
sysˇŒ
->
ªsﬁvî
.
díåy
 = dentry;

55 
sysˇŒ
->
ªsﬁvî
.
disˇrdî_ty≥
 = 0;

56 
sysˇŒ
->
ªsﬁvî
.
ˇŒback
 = 
DR_NO_CALLBACK
;

57 
sysˇŒ
->
ªsﬁvî
.
ôî©i⁄
 = 0;

58 
sysˇŒ
->
ªsﬁvî
.
ªt
 = 0;

60 
	`ªsﬁve_díåy
(
˘x
, 
DR_KPROBE
);

62 
	}
}

64 
SEC
("kprobe/propagate_mnt")

65 
	$k¥obe_¥›ag©e_m¡
(
±_ªgs
 *
˘x
) {

66 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
EVENT_MOUNT
);

67 i‡(!
sysˇŒ
)

70 
sysˇŒ
->
mou¡
.
de°_m¡
 = (mou¡ *)
	`PT_REGS_PARM1
(
˘x
);

71 
sysˇŒ
->
mou¡
.
de°_mou¡poöt
 = (
mou¡poöt
 *)
	`PT_REGS_PARM2
(
˘x
);

72 
sysˇŒ
->
mou¡
.
§c_m¡
 = (mou¡ *)
	`PT_REGS_PARM3
(
˘x
);

75 
díåy
 *díåy = 
	`gë_vfsmou¡_díåy
(
	`gë_mou¡_vfsmou¡
(
sysˇŒ
->
mou¡
.
§c_m¡
));

76 
sysˇŒ
->
mou¡
.
roŸ_key
.
mou¡_id
 = 
	`gë_mou¡_mou¡_id
(sysˇŒ->mou¡.
§c_m¡
);

77 
sysˇŒ
->
mou¡
.
roŸ_key
.
öo
 = 
	`gë_díåy_öo
(
díåy
);

79 
su≥r_block
 *
sb
 = 
	`gë_díåy_sb
(
díåy
);

80 
fûe_sy°em_ty≥
 *
s_ty≥
 = 
	`gë_su≥r_block_fs
(
sb
);

81 
	`bpf_¥obe_ªad
(&
sysˇŒ
->
mou¡
.
f°y≥
, (sysˇŒ->mou¡.f°y≥), &
s_ty≥
->
«me
);

83 
sysˇŒ
->
ªsﬁvî
.
key
 = sysˇŒ->
mou¡
.
roŸ_key
;

84 
sysˇŒ
->
ªsﬁvî
.
díåy
 = dentry;

85 
sysˇŒ
->
ªsﬁvî
.
disˇrdî_ty≥
 = 0;

86 
sysˇŒ
->
ªsﬁvî
.
ˇŒback
 = 
DR_NO_CALLBACK
;

87 
sysˇŒ
->
ªsﬁvî
.
ôî©i⁄
 = 0;

88 
sysˇŒ
->
ªsﬁvî
.
ªt
 = 0;

90 
	`ªsﬁve_díåy
(
˘x
, 
DR_KPROBE
);

92 
	}
}

94 
__©åibuã__
((
Æways_ölöe
)Ë
	$sys_mou¡_ªt
(*
˘x
, 
ªtvÆ
, 
dr_ty≥
) {

95 i‡(
ªtvÆ
)

98 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
EVENT_MOUNT
);

99 i‡(!
sysˇŒ
)

102 
díåy
 *díåy = 
	`gë_mou¡poöt_díåy
(
sysˇŒ
->
mou¡
.
de°_mou¡poöt
);

103 
∑th_key_t
 
∑th_key
 = {

104 .
mou¡_id
 = 
	`gë_mou¡_mou¡_id
(
sysˇŒ
->
mou¡
.
de°_m¡
),

105 .
öo
 = 
	`gë_díåy_öo
(
díåy
),

107 
sysˇŒ
->
mou¡
.
∑th_key
 =Öath_key;

109 
sysˇŒ
->
ªsﬁvî
.
key
 = 
∑th_key
;

110 
sysˇŒ
->
ªsﬁvî
.
díåy
 = dentry;

111 
sysˇŒ
->
ªsﬁvî
.
disˇrdî_ty≥
 = 0;

112 
sysˇŒ
->
ªsﬁvî
.
ˇŒback
 = 
dr_ty≥
 =
DR_KPROBE
 ? 
DR_MOUNT_CALLBACK_KPROBE_KEY
 : 
DR_MOUNT_CALLBACK_TRACEPOINT_KEY
;

113 
sysˇŒ
->
ªsﬁvî
.
ôî©i⁄
 = 0;

114 
sysˇŒ
->
ªsﬁvî
.
ªt
 = 0;

116 
	`ªsﬁve_díåy
(
˘x
, 
dr_ty≥
);

119 
	`p›_sysˇŒ
(
EVENT_MOUNT
);

121 
	}
}

123 
SEC
("tracepoint/syscalls/sys_exit_mount")

124 
	$åa˚poöt_sysˇŒs_sys_exô_mou¡
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

125  
	`sys_mou¡_ªt
(
¨gs
,árgs->
ªt
, 
DR_TRACEPOINT
);

126 
	}
}

128 
	$SYSCALL_COMPAT_KRETPROBE
(
mou¡
) {

129 
ªtvÆ
 = 
	`PT_REGS_RC
(
˘x
);

130  
	`sys_mou¡_ªt
(
˘x
, 
ªtvÆ
, 
DR_KPROBE
);

131 
	}
}

133 
SEC
("tracepoint/handle_sys_mount_exit")

134 
	$åa˚poöt_h™dÀ_sys_mou¡_exô
(
åa˚poöt_øw_sysˇŒs_sys_exô_t
 *
¨gs
) {

135  
	`sys_mou¡_ªt
(
¨gs
,árgs->
ªt
, 
DR_TRACEPOINT
);

136 
	}
}

138 
__©åibuã__
((
Æways_ölöe
)Ë
	$dr_mou¡_ˇŒback
(*
˘x
, 
ªtvÆ
) {

139 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`p›_sysˇŒ
(
EVENT_MOUNT
);

140 i‡(!
sysˇŒ
)

143 
mou¡_evít_t
 
evít
 = {

144 .
sysˇŒ
.
ªtvÆ
 =Ñetval,

145 .
mou¡_id
 = 
	`gë_mou¡_mou¡_id
(
sysˇŒ
->
mou¡
.
§c_m¡
),

146 .
group_id
 = 
	`gë_mou¡_≥î_group_id
(
sysˇŒ
->
mou¡
.
§c_m¡
),

147 .
devi˚
 = 
	`gë_mou¡_dev
(
sysˇŒ
->
mou¡
.
§c_m¡
),

148 .
∑ª¡_mou¡_id
 = 
sysˇŒ
->
mou¡
.
∑th_key
.
mou¡_id
,

149 .
∑ª¡_öode
 = 
sysˇŒ
->
mou¡
.
∑th_key
.
öo
,

150 .
roŸ_öode
 = 
sysˇŒ
->
mou¡
.
roŸ_key
.
öo
,

151 .
roŸ_mou¡_id
 = 
sysˇŒ
->
mou¡
.
roŸ_key
.
mou¡_id
,

153 
	`bpf_¥obe_ªad_°r
(&
evít
.
f°y≥
, 
FSTYPE_LEN
, (*Ë
sysˇŒ
->
mou¡
.fstype);

155 i‡(
evít
.
mou¡_id
 =0 &&Évít.
devi˚
 == 0) {

159 
¥oc_ˇche_t
 *
íåy
 = 
	`fûl_¥o˚ss_c⁄ãxt
(&
evít
.
¥o˚ss
);

160 
	`fûl_c⁄èöî_c⁄ãxt
(
íåy
, &
evít
.
c⁄èöî
);

161 
	`fûl_•™_c⁄ãxt
(&
evít
.
•™
);

163 
	`£nd_evít
(
˘x
, 
EVENT_MOUNT
, 
evít
);

166 
	}
}

168 
SEC
("kprobe/dr_mount_callback")

169 
__©åibuã__
((
Æways_ölöe
)Ë
	$k¥obe_dr_mou¡_ˇŒback
(
±_ªgs
 *
˘x
) {

170 
ªt
 = 
	`PT_REGS_RC
(
˘x
);

171  
	`dr_mou¡_ˇŒback
(
˘x
, 
ªt
);

172 
	}
}

174 
SEC
("tracepoint/dr_mount_callback")

175 
__©åibuã__
((
Æways_ölöe
)Ë
	$åa˚poöt_dr_mou¡_ˇŒback
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

176  
	`dr_mou¡_ˇŒback
(
¨gs
,árgs->
ªt
);

177 
	}
}

	@mprotect.h

1 #i‚de‡
_MPROTECT_H_


2 
	#_MPROTECT_H_


	)

4 
bpf_m≠_def
 
SEC
("m≠s/m¥Ÿe˘_vm_¥Ÿe˘i⁄_≠¥ovîs"Ë
	gm¥Ÿe˘_vm_¥Ÿe˘i⁄_≠¥ovîs
 = {

5 .
ty≥
 = 
BPF_MAP_TYPE_ARRAY
,

6 .
	gkey_size
 = (
u32
),

7 .
	gvÆue_size
 = (
u32
),

8 .
	gmax_íåõs
 = 1,

9 .
	gpönög
 = 0,

10 .
	g«me•a˚
 = "",

13 
__©åibuã__
((
Æways_ölöe
)Ë
	$≠¥ove_m¥Ÿe˘_by_vm_¥Ÿe˘i⁄
(
sysˇŒ_ˇche_t
 *
sysˇŒ
) {

14 
u32
 
key
 = 0;

15 
u32
 *
Êags
 = 
	`bpf_m≠_lookup_ñem
(&
m¥Ÿe˘_vm_¥Ÿe˘i⁄_≠¥ovîs
, &
key
);

16 i‡(
Êags
 !
NULL
 && (
sysˇŒ
->
m¥Ÿe˘
.
vm_¥Ÿe˘i⁄
 & *flags) > 0) {

20 
	}
}

22 
bpf_m≠_def
 
SEC
("m≠s/m¥Ÿe˘_ªq_¥Ÿe˘i⁄_≠¥ovîs"Ë
	gm¥Ÿe˘_ªq_¥Ÿe˘i⁄_≠¥ovîs
 = {

23 .
ty≥
 = 
BPF_MAP_TYPE_ARRAY
,

24 .
	gkey_size
 = (
u32
),

25 .
	gvÆue_size
 = (
u32
),

26 .
	gmax_íåõs
 = 1,

27 .
	gpönög
 = 0,

28 .
	g«me•a˚
 = "",

31 
__©åibuã__
((
Æways_ölöe
)Ë
	$≠¥ove_m¥Ÿe˘_by_ªq_¥Ÿe˘i⁄
(
sysˇŒ_ˇche_t
 *
sysˇŒ
) {

32 
u32
 
key
 = 0;

33 
u32
 *
Êags
 = 
	`bpf_m≠_lookup_ñem
(&
m¥Ÿe˘_ªq_¥Ÿe˘i⁄_≠¥ovîs
, &
key
);

34 i‡(
Êags
 !
NULL
 && (
sysˇŒ
->
m¥Ÿe˘
.
ªq_¥Ÿe˘i⁄
 & *flags) > 0) {

38 
	}
}

40 
__©åibuã__
((
Æways_ölöe
)Ë
	$m¥Ÿe˘_≠¥ovîs
(
sysˇŒ_ˇche_t
 *
sysˇŒ
) {

41 
∑ss_to_u£r•a˚
 = 0;

43 i‡((
sysˇŒ
->
pﬁicy
.
Êags
 & 
FLAGS
) > 0) {

44 
vm_¥Ÿe˘i⁄_≠¥oved
 = 
	`≠¥ove_m¥Ÿe˘_by_vm_¥Ÿe˘i⁄
(
sysˇŒ
);

45 
ªq_¥Ÿe˘i⁄_≠¥oved
 = 
	`≠¥ove_m¥Ÿe˘_by_ªq_¥Ÿe˘i⁄
(
sysˇŒ
);

46 
∑ss_to_u£r•a˚
 = 
vm_¥Ÿe˘i⁄_≠¥oved
 && 
ªq_¥Ÿe˘i⁄_≠¥oved
;

49  
∑ss_to_u£r•a˚
;

50 
	}
}

52 
	sm¥Ÿe˘_evít_t
 {

53 
kevít_t
 
	mevít
;

54 
¥o˚ss_c⁄ãxt_t
 
	m¥o˚ss
;

55 
•™_c⁄ãxt_t
 
	m•™
;

56 
c⁄èöî_c⁄ãxt_t
 
	mc⁄èöî
;

57 
sysˇŒ_t
 
	msysˇŒ
;

59 
u64
 
	mvm_°¨t
;

60 
u64
 
	mvm_íd
;

61 
u64
 
	mvm_¥Ÿe˘i⁄
;

62 
u64
 
	mªq_¥Ÿe˘i⁄
;

65 
	$SYSCALL_KPROBE0
(
m¥Ÿe˘
) {

66 
pﬁicy_t
 
pﬁicy
 = 
	`„tch_pﬁicy
(
EVENT_MPROTECT
);

67 i‡(
	`is_disˇrded_by_¥o˚ss
(
pﬁicy
.
mode
, 
EVENT_MPROTECT
)) {

71 
sysˇŒ_ˇche_t
 
sysˇŒ
 = {

72 .
ty≥
 = 
EVENT_MPROTECT
,

75 
	`ˇche_sysˇŒ
(&
sysˇŒ
);

77 
	}
}

79 
SEC
("kprobe/security_file_mprotect")

80 
	$k¥obe_£curôy_fûe_m¥Ÿe˘
(
±_ªgs
 *
˘x
) {

81 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
EVENT_MPROTECT
);

82 i‡(!
sysˇŒ
)

86 
vm_¨ó_°ru˘
 *
vma
 = (vm_¨ó_°ru˘ *)
	`PT_REGS_PARM1
(
˘x
);

87 
	`bpf_¥obe_ªad
(&
sysˇŒ
->
m¥Ÿe˘
.
vm_¥Ÿe˘i⁄
, (sysˇŒ->m¥Ÿe˘.vm_¥Ÿe˘i⁄), &
vma
->
vm_Êags
);

88 
	`bpf_¥obe_ªad
(&
sysˇŒ
->
m¥Ÿe˘
.
vm_°¨t
, (sysˇŒ->m¥Ÿe˘.vm_°¨t), &
vma
->vm_start);

89 
	`bpf_¥obe_ªad
(&
sysˇŒ
->
m¥Ÿe˘
.
vm_íd
, (sysˇŒ->m¥Ÿe˘.vm_íd), &
vma
->vm_end);

90 
sysˇŒ
->
m¥Ÿe˘
.
ªq_¥Ÿe˘i⁄
 = (
u64
)
	`PT_REGS_PARM2
(
˘x
);

92 
	}
}

94 
__©åibuã__
((
Æways_ölöe
)Ë
	$sys_m¥Ÿe˘_ªt
(*
˘x
, 
ªtvÆ
) {

95 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`p›_sysˇŒ
(
EVENT_MPROTECT
);

96 i‡(!
sysˇŒ
)

99 i‡(
	`fûãr_sysˇŒ
(
sysˇŒ
, 
m¥Ÿe˘_≠¥ovîs
)) {

100  
	`disˇrd_sysˇŒ
(
sysˇŒ
);

103 
m¥Ÿe˘_evít_t
 
evít
 = {

104 .
vm_¥Ÿe˘i⁄
 = 
sysˇŒ
->
m¥Ÿe˘
.vm_protection,

105 .
ªq_¥Ÿe˘i⁄
 = 
sysˇŒ
->
m¥Ÿe˘
.req_protection,

106 .
vm_°¨t
 = 
sysˇŒ
->
m¥Ÿe˘
.vm_start,

107 .
vm_íd
 = 
sysˇŒ
->
m¥Ÿe˘
.vm_end,

110 
¥oc_ˇche_t
 *
íåy
 = 
	`fûl_¥o˚ss_c⁄ãxt
(&
evít
.
¥o˚ss
);

111 
	`fûl_c⁄èöî_c⁄ãxt
(
íåy
, &
evít
.
c⁄èöî
);

112 
	`fûl_•™_c⁄ãxt
(&
evít
.
•™
);

114 
	`£nd_evít
(
˘x
, 
EVENT_MPROTECT
, 
evít
);

116 
	}
}

118 
	$SYSCALL_KRETPROBE
(
m¥Ÿe˘
) {

119  
	`sys_m¥Ÿe˘_ªt
(
˘x
, ()
	`PT_REGS_RC
(ctx));

120 
	}
}

122 
SEC
("tracepoint/syscalls/sys_exit_mprotect")

123 
	$åa˚poöt_sysˇŒs_sys_exô_m¥Ÿe˘
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

124  
	`sys_m¥Ÿe˘_ªt
(
¨gs
, (Ôrgs->
ªt
);

125 
	}
}

	@open.h

1 #i‚de‡
_OPEN_H_


2 
	#_OPEN_H_


	)

4 
	~"defs.h
"

5 
	~"fûãrs.h
"

6 
	~"sysˇŒs.h
"

7 
	~"¥o˚ss.h
"

9 
bpf_m≠_def
 
SEC
("m≠s/›í_Êags_≠¥ovîs"Ë
	g›í_Êags_≠¥ovîs
 = {

10 .
ty≥
 = 
BPF_MAP_TYPE_ARRAY
,

11 .
	gkey_size
 = (
u32
),

12 .
	gvÆue_size
 = (
u32
),

13 .
	gmax_íåõs
 = 1,

14 .
	gpönög
 = 0,

15 .
	g«me•a˚
 = "",

18 
	s›í_evít_t
 {

19 
kevít_t
 
	mevít
;

20 
¥o˚ss_c⁄ãxt_t
 
	m¥o˚ss
;

21 
•™_c⁄ãxt_t
 
	m•™
;

22 
c⁄èöî_c⁄ãxt_t
 
	mc⁄èöî
;

23 
sysˇŒ_t
 
	msysˇŒ
;

24 
fûe_t
 
	mfûe
;

25 
u32
 
	mÊags
;

26 
u32
 
	mmode
;

29 
__©åibuã__
((
Æways_ölöe
)Ë
	$åa˚__sys_›í©
(
Êags
, 
umode_t
 
mode
) {

30 
pﬁicy_t
 
pﬁicy
 = 
	`„tch_pﬁicy
(
EVENT_OPEN
);

31 i‡(
	`is_disˇrded_by_¥o˚ss
(
pﬁicy
.
mode
, 
EVENT_OPEN
)) {

35 
sysˇŒ_ˇche_t
 
sysˇŒ
 = {

36 .
ty≥
 = 
EVENT_OPEN
,

37 .
pﬁicy
 =Öolicy,

38 .
›í
 = {

39 .
Êags
 = flags,

40 .
mode
 = modê& 
S_IALLUGO
,

44 
	`ˇche_sysˇŒ
(&
sysˇŒ
);

47 
	}
}

49 
	$SYSCALL_KPROBE2
(
¸ót
, c⁄° *, 
fûíame
, 
umode_t
, 
mode
) {

50 
Êags
 = 
O_CREAT
|
O_WRONLY
|
O_TRUNC
;

51  
	`åa˚__sys_›í©
(
Êags
, 
mode
);

52 
	}
}

54 
	$SYSCALL_COMPAT_KPROBE3
(
›í_by_h™dÀ_©
, , 
mou¡_fd
, 
fûe_h™dÀ
 *, 
h™dÀ
, , 
Êags
) {

55 
umode_t
 
mode
 = 0;

56  
	`åa˚__sys_›í©
(
Êags
, 
mode
);

57 
	}
}

59 
	$SYSCALL_COMPAT_KPROBE0
(
åunˇã
) {

60 
Êags
 = 
O_CREAT
|
O_WRONLY
|
O_TRUNC
;

61 
umode_t
 
mode
 = 0;

62  
	`åa˚__sys_›í©
(
Êags
, 
mode
);

63 
	}
}

65 
	$SYSCALL_COMPAT_KPROBE3
(
›í
, c⁄° *, 
fûíame
, , 
Êags
, 
umode_t
, 
mode
) {

66  
	`åa˚__sys_›í©
(
Êags
, 
mode
);

67 
	}
}

69 
	$SYSCALL_COMPAT_KPROBE4
(
›í©
, , 
dúfd
, c⁄° *, 
fûíame
, , 
Êags
, 
umode_t
, 
mode
) {

70  
	`åa˚__sys_›í©
(
Êags
, 
mode
);

71 
	}
}

73 
	s›í©2_›í_how
 {

74 
u64
 
	mÊags
;

75 
u64
 
	mmode
;

76 
u64
 
	mªsﬁve
;

79 
	$SYSCALL_KPROBE4
(
›í©2
, , 
dúfd
, c⁄° *, 
fûíame
, 
›í©2_›í_how
*, 
phow
, 
size_t
, 
size
) {

80 
›í©2_›í_how
 
how
;

81 
	`bpf_¥obe_ªad
(&
how
, (
›í©2_›í_how
), 
phow
);

82  
	`åa˚__sys_›í©
(
how
.
Êags
, how.
mode
);

83 
	}
}

85 
__©åibuã__
((
Æways_ölöe
)Ë
	$≠¥ove_by_Êags
(
sysˇŒ_ˇche_t
 *
sysˇŒ
) {

86 
u32
 
key
 = 0;

87 
u32
 *
Êags
 = 
	`bpf_m≠_lookup_ñem
(&
›í_Êags_≠¥ovîs
, &
key
);

88 i‡(
Êags
 !
NULL
 && (
sysˇŒ
->
›í
.flags & *flags) > 0) {

89 #ifde‡
DEBUG


90 
	`bpf_¥ötk
("›í fœg†%dáµroved\n", 
sysˇŒ
->
›í
.
Êags
);

95 
	}
}

97 
__©åibuã__
((
Æways_ölöe
)Ë
	$›í_≠¥ovîs
(
sysˇŒ_ˇche_t
 *
sysˇŒ
) {

98 
∑ss_to_u£r•a˚
 = 0;

100 i‡((
sysˇŒ
->
pﬁicy
.
Êags
 & 
BASENAME
) > 0) {

101 
∑ss_to_u£r•a˚
 = 
	`≠¥ove_by_ba£«me
(
sysˇŒ
->
›í
.
díåy
, 
EVENT_OPEN
);

104 i‡(!
∑ss_to_u£r•a˚
 && (
sysˇŒ
->
pﬁicy
.
Êags
 & 
FLAGS
) > 0) {

105 
∑ss_to_u£r•a˚
 = 
	`≠¥ove_by_Êags
(
sysˇŒ
);

108  
∑ss_to_u£r•a˚
;

109 
	}
}

111 
__©åibuã__
((
Æways_ölöe
)Ë
	$h™dÀ_›í_evít
(
sysˇŒ_ˇche_t
 *
sysˇŒ
, 
fûe
 *fûe, 
∑th
 *∑th, 
öode
 *inode) {

112 i‡(
sysˇŒ
->
›í
.
díåy
) {

116 
díåy
 *díåy = 
	`gë_∑th_díåy
(
∑th
);

118 
sysˇŒ
->
›í
.
díåy
 = dentry;

119 
sysˇŒ
->
›í
.
fûe
.
∑th_key
 = 
	`gë_öode_key_∑th
(
öode
, 
∑th
);

121 
	`£t_fûe_öode
(
díåy
, &
sysˇŒ
->
›í
.
fûe
, 0);

123 i‡(
	`fûãr_sysˇŒ
(
sysˇŒ
, 
›í_≠¥ovîs
)) {

124  
	`m¨k_as_disˇrded
(
sysˇŒ
);

128 
	}
}

130 
SEC
("kprobe/vfs_truncate")

131 
	$k¥obe_vfs_åunˇã
(
±_ªgs
 *
˘x
) {

132 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
EVENT_OPEN
);

133 i‡(!
sysˇŒ
)

136 i‡(
sysˇŒ
->
›í
.
díåy
) {

140 
∑th
 *∑th = (∑th *)
	`PT_REGS_PARM1
(
˘x
);

141 
díåy
 *díåy = 
	`gë_∑th_díåy
(
∑th
);

143 
sysˇŒ
->
›í
.
díåy
 = dentry;

144 
sysˇŒ
->
›í
.
fûe
.
∑th_key
 = 
	`gë_díåy_key_∑th
(sysˇŒ->›í.
díåy
, 
∑th
);

146 
	`£t_fûe_öode
(
díåy
, &
sysˇŒ
->
›í
.
fûe
, 0);

148 i‡(
	`fûãr_sysˇŒ
(
sysˇŒ
, 
›í_≠¥ovîs
)) {

149  
	`m¨k_as_disˇrded
(
sysˇŒ
);

153 
	}
}

155 
SEC
("kprobe/vfs_open")

156 
	$k¥obe_vfs_›í
(
±_ªgs
 *
˘x
) {

157 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
EVENT_OPEN
);

158 i‡(!
sysˇŒ
)

161 
∑th
 *∑th = (∑th *)
	`PT_REGS_PARM1
(
˘x
);

162 
fûe
 *fûê(fûê*)
	`PT_REGS_PARM2
(
˘x
);

163 
díåy
 *díåy = 
	`gë_∑th_díåy
(
∑th
);

164 
öode
 *öodê
	`gë_díåy_öode
(
díåy
);

166  
	`h™dÀ_›í_evít
(
sysˇŒ
, 
fûe
, 
∑th
, 
öode
);

167 
	}
}

169 
SEC
("kprobe/do_dentry_open")

170 
	$k¥obe_do_díåy_›í
(
±_ªgs
 *
˘x
) {

171 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
EVENT_EXEC
);

172 i‡(!
sysˇŒ
)

175 
fûe
 *fûê(fûê*)
	`PT_REGS_PARM1
(
˘x
);

176 
öode
 *öodê(öodê*)
	`PT_REGS_PARM2
(
˘x
);

178  
	`h™dÀ_exec_evít
(
˘x
, 
sysˇŒ
, 
fûe
, &fûe->
f_∑th
, 
öode
);

179 
	}
}

181 
	s›í_Êags
 {

182 
	m›í_Êag
;

183 
umode_t
 
	mmode
;

186 
	sio_›í
 {

187 
fûe
 *
	mfûe
;

188 
	mdfd
;

189 
boﬁ
 
	mign‹e_n⁄block
;

190 
fûíame
 *
	mfûíame
;

191 
›í©2_›í_how
 
	mhow
;

194 
SEC
("kprobe/io_openat2")

195 
	$k¥obe_io_›í©2
(
±_ªgs
 *
˘x
) {

196 
io_›í
 
ªq
;

197 i‡(
	`bpf_¥obe_ªad
(&
ªq
, ‘eq), (*Ë
	`PT_REGS_PARM1
(
˘x
))) {

201 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
EVENT_OPEN
);

202 i‡(!
sysˇŒ
) {

203 
Êags
 = 
ªq
.
how
.Êag†& 
VALID_OPEN_FLAGS
;

204 
umode_t
 
mode
 = 
ªq
.
how
.modê& 
S_IALLUGO
;

205  
	`åa˚__sys_›í©
(
Êags
, 
mode
);

208 
	}
}

210 
__©åibuã__
((
Æways_ölöe
)Ë
	$sys_›í_ªt
(*
˘x
, 
ªtvÆ
, 
dr_ty≥
) {

211 i‡(
	`IS_UNHANDLED_ERROR
(
ªtvÆ
))

214 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
EVENT_OPEN
);

215 i‡(!
sysˇŒ
)

219 
	`öc_mou¡_ªf
(
sysˇŒ
->
›í
.
fûe
.
∑th_key
.
mou¡_id
);

220 i‡(
sysˇŒ
->
disˇrded
)

223 
sysˇŒ
->
ªsﬁvî
.
key
 = sysˇŒ->
›í
.
fûe
.
∑th_key
;

224 
sysˇŒ
->
ªsﬁvî
.
díåy
 = sysˇŒ->
›í
.dentry;

225 
sysˇŒ
->
ªsﬁvî
.
disˇrdî_ty≥
 = sysˇŒ->
pﬁicy
.
mode
 !
NO_FILTER
 ? 
EVENT_OPEN
 : 0;

226 
sysˇŒ
->
ªsﬁvî
.
ˇŒback
 = 
dr_ty≥
 =
DR_KPROBE
 ? 
DR_OPEN_CALLBACK_KPROBE_KEY
 : 
DR_OPEN_CALLBACK_TRACEPOINT_KEY
;

227 
sysˇŒ
->
ªsﬁvî
.
ôî©i⁄
 = 0;

228 
sysˇŒ
->
ªsﬁvî
.
ªt
 = 0;

231 
	`ªsﬁve_díåy
(
˘x
, 
dr_ty≥
);

234 
	`p›_sysˇŒ
(
EVENT_OPEN
);

236 
	}
}

238 
__©åibuã__
((
Æways_ölöe
)Ë
	$k¥obe_sys_›í_ªt
(
±_ªgs
 *
˘x
) {

239 
ªtvÆ
 = 
	`PT_REGS_RC
(
˘x
);

240  
	`sys_›í_ªt
(
˘x
, 
ªtvÆ
, 
DR_KPROBE
);

241 
	}
}

243 
SEC
("tracepoint/syscalls/sys_exit_creat")

244 
	$åa˚poöt_sysˇŒs_sys_exô_¸ót
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

245  
	`sys_›í_ªt
(
¨gs
,árgs->
ªt
, 
DR_TRACEPOINT
);

246 
	}
}

248 
	$SYSCALL_KRETPROBE
(
¸ót
) {

249  
	`k¥obe_sys_›í_ªt
(
˘x
);

250 
	}
}

252 
SEC
("tracepoint/syscalls/sys_exit_open_by_handle_at")

253 
	$åa˚poöt_sysˇŒs_sys_exô_›í_by_h™dÀ_©
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

254  
	`sys_›í_ªt
(
¨gs
,árgs->
ªt
, 
DR_TRACEPOINT
);

255 
	}
}

257 
	$SYSCALL_COMPAT_KRETPROBE
(
›í_by_h™dÀ_©
) {

258  
	`k¥obe_sys_›í_ªt
(
˘x
);

259 
	}
}

261 
SEC
("tracepoint/syscalls/sys_exit_truncate")

262 
	$åa˚poöt_sysˇŒs_sys_exô_åunˇã
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

263  
	`sys_›í_ªt
(
¨gs
,árgs->
ªt
, 
DR_TRACEPOINT
);

264 
	}
}

266 
	$SYSCALL_COMPAT_KRETPROBE
(
åunˇã
) {

267  
	`k¥obe_sys_›í_ªt
(
˘x
);

268 
	}
}

270 
SEC
("tracepoint/syscalls/sys_exit_open")

271 
	$åa˚poöt_sysˇŒs_sys_exô_›í
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

272  
	`sys_›í_ªt
(
¨gs
,árgs->
ªt
, 
DR_TRACEPOINT
);

273 
	}
}

275 
	$SYSCALL_COMPAT_KRETPROBE
(
›í
) {

276  
	`k¥obe_sys_›í_ªt
(
˘x
);

277 
	}
}

279 
SEC
("tracepoint/syscalls/sys_exit_openat")

280 
	$åa˚poöt_sysˇŒs_sys_exô_›í©
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

281  
	`sys_›í_ªt
(
¨gs
,árgs->
ªt
, 
DR_TRACEPOINT
);

282 
	}
}

284 
	$SYSCALL_COMPAT_KRETPROBE
(
›í©
) {

285  
	`k¥obe_sys_›í_ªt
(
˘x
);

286 
	}
}

288 
SEC
("tracepoint/syscalls/sys_exit_openat2")

289 
	$åa˚poöt_sysˇŒs_sys_exô_›í©2
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

290  
	`sys_›í_ªt
(
¨gs
,árgs->
ªt
, 
DR_TRACEPOINT
);

291 
	}
}

293 
	$SYSCALL_KRETPROBE
(
›í©2
) {

294  
	`k¥obe_sys_›í_ªt
(
˘x
);

295 
	}
}

297 
SEC
("tracepoint/handle_sys_open_exit")

298 
	$åa˚poöt_h™dÀ_sys_›í_exô
(
åa˚poöt_øw_sysˇŒs_sys_exô_t
 *
¨gs
) {

299  
	`sys_›í_ªt
(
¨gs
,árgs->
ªt
, 
DR_TRACEPOINT
);

300 
	}
}

302 
SEC
("kretprobe/io_openat2")

303 
	$kªçrobe_io_›í©2
(
±_ªgs
 *
˘x
) {

304 
fûe
 *
f
 = (fûê*Ë
	`PT_REGS_RC
(
˘x
);

305 i‡(
	`IS_ERR
(
f
))

308  
	`sys_›í_ªt
(
˘x
, 0, 
DR_KPROBE
);

309 
	}
}

311 
SEC
("kprobe/filp_close")

312 
	$k¥obe_fûp_˛o£
(
±_ªgs
 *
˘x
) {

313 
fûe
 *fûê(fûê*Ë
	`PT_REGS_PARM1
(
˘x
);

314 
u32
 
mou¡_id
 = 
	`gë_fûe_mou¡_id
(
fûe
);

315 i‡(
mou¡_id
) {

316 
	`dec_mou¡_ªf
(
˘x
, 
mou¡_id
);

320 
	}
}

322 
__©åibuã__
((
Æways_ölöe
)Ë
	$dr_›í_ˇŒback
(*
˘x
, 
ªtvÆ
) {

323 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`p›_sysˇŒ
(
EVENT_OPEN
);

324 i‡(!
sysˇŒ
)

327 i‡(
	`IS_UNHANDLED_ERROR
(
ªtvÆ
))

330 i‡(
sysˇŒ
->
ªsﬁvî
.
ªt
 =
DENTRY_DISCARDED
 || sysˇŒ->ªsﬁvî.ªà=
DENTRY_INVALID
) {

334 
›í_evít_t
 
evít
 = {

335 .
sysˇŒ
.
ªtvÆ
 =Ñetval,

336 .
fûe
 = 
sysˇŒ
->
›í
.file,

337 .
Êags
 = 
sysˇŒ
->
›í
.flags,

338 .
mode
 = 
sysˇŒ
->
›í
.mode,

341 
	`fûl_fûe_mëad©a
(
sysˇŒ
->
›í
.
díåy
, &
evít
.
fûe
.
mëad©a
);

342 
¥oc_ˇche_t
 *
íåy
 = 
	`fûl_¥o˚ss_c⁄ãxt
(&
evít
.
¥o˚ss
);

343 
	`fûl_c⁄èöî_c⁄ãxt
(
íåy
, &
evít
.
c⁄èöî
);

344 
	`fûl_•™_c⁄ãxt
(&
evít
.
•™
);

346 
	`£nd_evít
(
˘x
, 
EVENT_OPEN
, 
evít
);

348 
	}
}

350 
SEC
("kprobe/dr_open_callback")

351 
__©åibuã__
((
Æways_ölöe
)Ë
	$k¥obe_dr_›í_ˇŒback
(
±_ªgs
 *
˘x
) {

352 
ªtvÆ
 = 
	`PT_REGS_RC
(
˘x
);

353  
	`dr_›í_ˇŒback
(
˘x
, 
ªtvÆ
);

354 
	}
}

356 
SEC
("tracepoint/dr_open_callback")

357 
__©åibuã__
((
Æways_ölöe
)Ë
	$åa˚poöt_dr_›í_ˇŒback
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

358  
	`dr_›í_ˇŒback
(
¨gs
,árgs->
ªt
);

359 
	}
}

	@overlayfs.h

1 #i‚de‡
_OVERLAYFS_H_


2 
	#_OVERLAYFS_H_


	)

4 
	~"sysˇŒs.h
"

6 
	#OVERLAYFS_SUPER_MAGIC
 0x794c7630

	)

8 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_sizeof_öode
() {

9 
u64
 
sizeof_öode
;

10 
	`LOAD_CONSTANT
("sizeof_öode", 
sizeof_öode
);

12  
sizeof_öode
;

13 
	}
}

15 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_sb_magic_off£t
() {

16 
u64
 
off£t
;

17 
	`LOAD_CONSTANT
("sb_magic_off£t", 
off£t
);

19  
off£t
;

20 
	}
}

22 
__©åibuã__
((
Æways_ölöe
)Ë
	$is_ovîœyfs
(
díåy
 *dentry) {

23 
öode
 *
d_öode
;

24 
	`bpf_¥obe_ªad
(&
d_öode
, (d_öode), &
díåy
->d_inode);

26 
su≥r_block
 *
sb
;

27 
	`bpf_¥obe_ªad
(&
sb
, (sb), &
d_öode
->
i_sb
);

29 
u64
 
magic
;

30 
	`bpf_¥obe_ªad
(&
magic
, (magic), (*)
sb
 + 
	`gë_sb_magic_off£t
());

32  
magic
 =
OVERLAYFS_SUPER_MAGIC
;

33 
	}
}

35 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_ovl_lowî_öo
(
díåy
 *dentry) {

36 
öode
 *
d_öode
;

37 
	`bpf_¥obe_ªad
(&
d_öode
, (d_öode), &
díåy
->d_inode);

40 
öode
 *
lowî
;

41 
	`bpf_¥obe_ªad
(&
lowî
, ÷owî), (*)
d_öode
 + 
	`gë_sizeof_öode
() + 8);

43  
	`gë_öode_öo
(
lowî
);

44 
	}
}

46 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_ovl_uµî_öo
(
díåy
 *dentry) {

47 
öode
 *
d_öode
;

48 
	`bpf_¥obe_ªad
(&
d_öode
, (d_öode), &
díåy
->d_inode);

51 
díåy
 *
uµî
;

52 
	`bpf_¥obe_ªad
(&
uµî
, (uµî), (*)
d_öode
 + 
	`gë_sizeof_öode
());

54  
	`gë_díåy_öo
(
uµî
);

55 
	}
}

57 
__Æways_ölöe
 
	$£t_ovîœyfs_öo
(
díåy
 *díåy, 
u64
 *
öo
, 
u32
 *
Êags
) {

58 
u64
 
lowî_öode
 = 
	`gë_ovl_lowî_öo
(
díåy
);

59 
u64
 
uµî_öode
 = 
	`gë_ovl_uµî_öo
(
díåy
);

61 #ifde‡
DEBUG


62 
	`bpf_¥ötk
("gë_ovîœyfs_öÿlowî: %d uµî: %d\n", 
lowî_öode
, 
uµî_öode
);

65 i‡(
uµî_öode
)

66 *
Êags
 |
UPPER_LAYER
;

67 i‡(
lowî_öode
)

68 *
Êags
 |
LOWER_LAYER
;

70 i‡(
lowî_öode
) {

71 *
öo
 = 
lowî_öode
;

72 } i‡(
uµî_öode
) {

73 *
öo
 = 
uµî_öode
;

75 
	}
}

	@process.h

1 #i‚de‡
_PROCESS_H_


2 
	#_PROCESS_H_


	)

4 
	~<löux/ây.h
>

5 
	~<löux/sched.h
>

7 
	~"c⁄èöî.h
"

8 
	~"•™.h
"

10 
	s¥oc_ˇche_t
 {

11 
c⁄èöî_c⁄ãxt_t
 
	mc⁄èöî
;

12 
fûe_t
 
	mexecuèbÀ
;

14 
u64
 
	mexec_time°amp
;

15 
	mây_«me
[
TTY_NAME_LEN
];

16 
	mcomm
[
TASK_COMM_LEN
];

19 
__©åibuã__
((
Æways_ölöe
)Ë
u32
 
	$c›y_ây_«me
(
§c
[
TTY_NAME_LEN
], 
d°
[TTY_NAME_LEN]) {

20 i‡(
§c
[0] == 0) {

24 #¥agm®
uƒﬁl


25 
i
 = 0; i < 
TTY_NAME_LEN
; i++)

27 
d°
[
i
] = 
§c
[i];

29  
TTY_NAME_LEN
;

30 
	}
}

32 
__©åibuã__
((
Æways_ölöe
)Ë
	$c›y_¥oc_ˇche_ex˚±_comm
(
¥oc_ˇche_t
* 
§c
, ¥oc_ˇche_t* 
d°
) {

33 
	`c›y_c⁄èöî_id
(
§c
->
c⁄èöî
.
c⁄èöî_id
, 
d°
->container.container_id);

34 
d°
->
execuèbÀ
 = 
§c
->executable;

35 
d°
->
exec_time°amp
 = 
§c
->exec_timestamp;

36 
	`c›y_ây_«me
(
§c
->
ây_«me
, 
d°
->tty_name);

37 
	}
}

39 
__©åibuã__
((
Æways_ölöe
)Ë
	$c›y_¥oc_ˇche
(
¥oc_ˇche_t
 *
§c
, ¥oc_ˇche_à*
d°
) {

40 
	`c›y_¥oc_ˇche_ex˚±_comm
(
§c
, 
d°
);

41 
	`bpf_¥obe_ªad
(
d°
->
comm
, 
TASK_COMM_LEN
, 
§c
->comm);

43 
	}
}

45 
bpf_m≠_def
 
SEC
("m≠s/¥oc_ˇche"Ë
	g¥oc_ˇche
 = {

46 .
ty≥
 = 
BPF_MAP_TYPE_LRU_HASH
,

47 .
	gkey_size
 = (
u32
),

48 .
	gvÆue_size
 = (
¥oc_ˇche_t
),

49 .
	gmax_íåõs
 = 4096,

50 .
	gpönög
 = 0,

51 .
	g«me•a˚
 = "",

54 
__©åibuã__
((
Æways_ölöe
)Ë
	$fûl_c⁄èöî_c⁄ãxt
(
¥oc_ˇche_t
 *
íåy
, 
c⁄èöî_c⁄ãxt_t
 *
c⁄ãxt
) {

55 i‡(
íåy
) {

56 
	`c›y_c⁄èöî_id
(
íåy
->
c⁄èöî
.
c⁄èöî_id
, 
c⁄ãxt
->container_id);

58 
	}
}

60 
	s¸edítüls_t
 {

61 
u32
 
	muid
;

62 
u32
 
	mgid
;

63 
u32
 
	meuid
;

64 
u32
 
	megid
;

65 
u32
 
	mfsuid
;

66 
u32
 
	mfsgid
;

67 
u64
 
	mˇp_ef„˘ive
;

68 
u64
 
	mˇp_≥rmôãd
;

71 
__©åibuã__
((
Æways_ölöe
)Ë
	$c›y_¸edítüls
(
¸edítüls_t
* 
§c
, ¸edítüls_t* 
d°
) {

72 *
d°
 = *
§c
;

73 
	}
}

75 
	spid_ˇche_t
 {

76 
u32
 
	mcookõ
;

77 
u32
 
	mµid
;

78 
u64
 
	mf‹k_time°amp
;

79 
u64
 
	mexô_time°amp
;

80 
¸edítüls_t
 
	m¸edítüls
;

83 
__©åibuã__
((
Æways_ölöe
)Ë
	$c›y_pid_ˇche_ex˚±_exô_ts
(
pid_ˇche_t
* 
§c
, pid_ˇche_t* 
d°
) {

84 
d°
->
cookõ
 = 
§c
->cookie;

85 
d°
->
µid
 = 
§c
->ppid;

86 
d°
->
f‹k_time°amp
 = 
§c
->fork_timestamp;

87 
d°
->
¸edítüls
 = 
§c
->credentials;

88 
	}
}

90 
bpf_m≠_def
 
SEC
("m≠s/pid_ˇche"Ë
	gpid_ˇche
 = {

91 .
ty≥
 = 
BPF_MAP_TYPE_LRU_HASH
,

92 .
	gkey_size
 = (
u32
),

93 .
	gvÆue_size
 = (
pid_ˇche_t
),

94 .
	gmax_íåõs
 = 4096,

95 .
	gpönög
 = 0,

96 .
	g«me•a˚
 = "",

100 
¥oc_ˇche_t
 *
gë_¥oc_‰om_cookõ
(
u32
 
cookõ
);

102 
¥oc_ˇche_t
 * 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_¥oc_ˇche
(
u32
 
tgid
) {

103 
¥oc_ˇche_t
 *
íåy
 = 
NULL
;

105 
pid_ˇche_t
 *
pid_íåy
 = (pid_ˇche_à*Ë
	`bpf_m≠_lookup_ñem
(&
pid_ˇche
, &
tgid
);

106 i‡(
pid_íåy
) {

108 
u32
 
cookõ
 = 
pid_íåy
->cookie;

109 
íåy
 = 
	`gë_¥oc_‰om_cookõ
(
cookõ
);

111  
íåy
;

112 
	}
}

114 
¥oc_ˇche_t
 * 
__©åibuã__
((
Æways_ölöe
)Ë
	$fûl_¥o˚ss_c⁄ãxt
(
¥o˚ss_c⁄ãxt_t
 *
d©a
) {

116 
u64
 
pid_tgid
 = 
	`bpf_gë_cuºít_pid_tgid
();

117 
u32
 
tgid
 = 
pid_tgid
 >> 32;

120 
d©a
->
pid
 = 
tgid
;

121 
d©a
->
tid
 = 
pid_tgid
;

123  
	`gë_¥oc_ˇche
(
tgid
);

124 
	}
}

126 
bpf_m≠_def
 
SEC
("m≠s/roŸ_ƒ_«me•a˚_ƒ"Ë
	groŸ_ƒ_«me•a˚_ƒ
 = {

127 .
ty≥
 = 
BPF_MAP_TYPE_LRU_HASH
,

128 .
	gkey_size
 = (
u32
),

129 .
	gvÆue_size
 = (
u32
),

130 .
	gmax_íåõs
 = 32768,

131 .
	gpönög
 = 0,

132 .
	g«me•a˚
 = "",

135 
bpf_m≠_def
 
SEC
("m≠s/«me•a˚_ƒ_roŸ_ƒ"Ë
	g«me•a˚_ƒ_roŸ_ƒ
 = {

136 .
ty≥
 = 
BPF_MAP_TYPE_LRU_HASH
,

137 .
	gkey_size
 = (
u32
),

138 .
	gvÆue_size
 = (
u32
),

139 .
	gmax_íåõs
 = 32768,

140 .
	gpönög
 = 0,

141 .
	g«me•a˚
 = "",

144 
__©åibuã__
((
Æways_ölöe
)Ë
	$ªgi°î_ƒ
(
u32
 
roŸ_ƒ
, 
u64
 
«me•a˚_ƒ
) {

146 i‡(
roŸ_ƒ
 =0 || 
«me•a˚_ƒ
 == 0) {

151 
	`bpf_m≠_upd©e_ñem
(&
roŸ_ƒ_«me•a˚_ƒ
, &
roŸ_ƒ
, &
«me•a˚_ƒ
, 
BPF_ANY
);

152 
	`bpf_m≠_upd©e_ñem
(&
«me•a˚_ƒ_roŸ_ƒ
, &
«me•a˚_ƒ
, &
roŸ_ƒ
, 
BPF_ANY
);

153 
	}
}

155 
u32
 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_roŸ_ƒ
(
u32
 
«me•a˚_ƒ
) {

157 
u32
 *
pid
 = 
	`bpf_m≠_lookup_ñem
(&
«me•a˚_ƒ_roŸ_ƒ
, &
«me•a˚_ƒ
);

158  
pid
 ? *pid : 0;

159 
	}
}

161 
u32
 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_«me•a˚_ƒ
(
u32
 
roŸ_ƒ
) {

163 
u32
 *
pid
 = 
	`bpf_m≠_lookup_ñem
(&
roŸ_ƒ_«me•a˚_ƒ
, &
roŸ_ƒ
);

164  
pid
 ? *pid : 0;

165 
	}
}

167 
__©åibuã__
((
Æways_ölöe
)Ë
	$ªmove_ƒ
(
u32
 
roŸ_ƒ
) {

169 
u32
 
«me•a˚_ƒ
 = 
	`gë_«me•a˚_ƒ
(
roŸ_ƒ
);

170 i‡(
roŸ_ƒ
 =0 || 
«me•a˚_ƒ
 == 0) {

174 
	`bpf_m≠_dñëe_ñem
(&
roŸ_ƒ_«me•a˚_ƒ
, &
roŸ_ƒ
);

175 
	`bpf_m≠_dñëe_ñem
(&
«me•a˚_ƒ_roŸ_ƒ
, &
«me•a˚_ƒ
);

176 
	}
}

178 
u64
 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_pid_Àvñ_off£t
() {

179 
u64
 
pid_Àvñ_off£t
;

180 
	`LOAD_CONSTANT
("pid_Àvñ_off£t", 
pid_Àvñ_off£t
);

181  
pid_Àvñ_off£t
;

182 
	}
}

184 
u64
 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_pid_numbîs_off£t
() {

185 
u64
 
pid_numbîs_off£t
;

186 
	`LOAD_CONSTANT
("pid_numbîs_off£t", 
pid_numbîs_off£t
);

187  
pid_numbîs_off£t
;

188 
	}
}

190 
u64
 
__©åibuã__
((
Æways_ölöe
)Ë
	$gë_sizeof_upid
() {

191 
u64
 
sizeof_upid
;

192 
	`LOAD_CONSTANT
("sizeof_upid", 
sizeof_upid
);

193  
sizeof_upid
;

194 
	}
}

196 
__©åibuã__
((
Æways_ölöe
)Ë
	$ˇche_ƒ_å™¶©i⁄s
(
pid
 *pid) {

197 i‡(
pid
 =
NULL
) {

202 
u32
 
roŸ_ƒ
 = 0;

203 
	`bpf_¥obe_ªad
(&
roŸ_ƒ
, ‘oŸ_ƒ), (*)
pid
 + 
	`gë_pid_numbîs_off£t
());

206 
u32
 
pid_Àvñ
 = 0;

207 
	`bpf_¥obe_ªad
(&
pid_Àvñ
, ’id_Àvñ), (*)
pid
 + 
	`gë_pid_Àvñ_off£t
());

210 
u32
 
«me•a˚_ƒ
 = 0;

211 
u64
 
«me•a˚_numbîs_off£t
 = 
pid_Àvñ
 * 
	`gë_sizeof_upid
();

212 
	`bpf_¥obe_ªad
(&
«me•a˚_ƒ
, “ame•a˚_ƒ), (*)
pid
 + 
	`gë_pid_numbîs_off£t
(Ë+ 
«me•a˚_numbîs_off£t
);

214 
	`ªgi°î_ƒ
(
roŸ_ƒ
, 
«me•a˚_ƒ
);

216 
	}
}

	@procfs.h

1 #i‚de‡
_PROCFS_H_


2 
	#_PROCFS_H_


	)

4 
bpf_m≠_def
 
SEC
("m≠s/exec_fûe_ˇche"Ë
	gexec_fûe_ˇche
 = {

5 .
ty≥
 = 
BPF_MAP_TYPE_LRU_HASH
,

6 .
	gkey_size
 = (
u64
),

7 .
	gvÆue_size
 = (
fûe_t
),

8 .
	gmax_íåõs
 = 4096,

9 .
	gpönög
 = 0,

10 .
	g«me•a˚
 = "",

13 
SEC
("kprobe/security_inode_getattr")

14 
	$k¥obe_£curôy_öode_gë©å
(
±_ªgs
 *
˘x
) {

15 
u64
 
pid
;

16 
	`LOAD_CONSTANT
("ru¡ime_pid", 
pid
);

18 
u64
 
pid_tgid
 = 
	`bpf_gë_cuºít_pid_tgid
();

19 
u32
 
tgid
 = 
pid_tgid
 >> 32;

21 i‡((
u64
)
tgid
 !
pid
) {

25 
u32
 
mou¡_id
 = 0;

26 
díåy
 *dentry;

28 
u64
 
gë©å2
;

29 
	`LOAD_CONSTANT
("gë©å2", 
gë©å2
);

31 i‡(
gë©å2
) {

32 
vfsmou¡
 *
m¡
 = (vfsmou¡ *)
	`PT_REGS_PARM1
(
˘x
);

33 
mou¡_id
 = 
	`gë_vfsmou¡_mou¡_id
(
m¡
);

35 
díåy
 = (díåy *)
	`PT_REGS_PARM2
(
˘x
);

37 
∑th
 *∑th = (∑th *)
	`PT_REGS_PARM1
(
˘x
);

38 
mou¡_id
 = 
	`gë_∑th_mou¡_id
(
∑th
);

40 
díåy
 = 
	`gë_∑th_díåy
(
∑th
);

43 
u32
 
Êags
 = 0;

44 
u64
 
öode
 = 
	`gë_díåy_öo
(
díåy
);

45 i‡(
	`is_ovîœyfs
(
díåy
)) {

46 
	`£t_ovîœyfs_öo
(
díåy
, &
öode
, &
Êags
);

49 
fûe_t
 
íåy
 = {

50 .
∑th_key
 = {

51 .
öo
 = 
öode
,

52 .
mou¡_id
 = mount_id,

54 .
Êags
 = flags,

57 
	`fûl_fûe_mëad©a
(
díåy
, &
íåy
.
mëad©a
);

59 
	`bpf_m≠_upd©e_ñem
(&
exec_fûe_ˇche
, &
öode
, &
íåy
, 
BPF_NOEXIST
);

62 
	}
}

	@ptrace.h

1 #i‚de‡
_PTRACE_H_


2 
	#_PTRACE_H_


	)

4 
	s±ø˚_evít_t
 {

5 
kevít_t
 
	mevít
;

6 
¥o˚ss_c⁄ãxt_t
 
	m¥o˚ss
;

7 
•™_c⁄ãxt_t
 
	m•™
;

8 
c⁄èöî_c⁄ãxt_t
 
	mc⁄èöî
;

9 
sysˇŒ_t
 
	msysˇŒ
;

11 
u32
 
	mªque°
;

12 
u32
 
	mpid
;

13 
u64
 
	maddr
;

16 
	$SYSCALL_KPROBE3
(
±ø˚
, 
u32
, 
ªque°
, 
pid_t
, 
pid
, *, 
addr
) {

17 
pﬁicy_t
 
pﬁicy
 = 
	`„tch_pﬁicy
(
EVENT_PTRACE
);

18 i‡(
	`is_disˇrded_by_¥o˚ss
(
pﬁicy
.
mode
, 
EVENT_PTRACE
)) {

22 
sysˇŒ_ˇche_t
 
sysˇŒ
 = {

23 .
ty≥
 = 
EVENT_PTRACE
,

24 .
±ø˚
 = {

25 .
ªque°
 =Ñequest,

26 .
pid
 =Öid,

27 .
addr
 = (
u64
)addr,

31 
	`ˇche_sysˇŒ
(&
sysˇŒ
);

33 
	}
}

35 
__©åibuã__
((
Æways_ölöe
)Ë
	$sys_±ø˚_ªt
(*
˘x
, 
ªtvÆ
) {

36 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`p›_sysˇŒ
(
EVENT_PTRACE
);

37 i‡(!
sysˇŒ
)

41 
u32
 
«me•a˚_ƒ
 = 
	`gë_roŸ_ƒ
(
sysˇŒ
->
±ø˚
.
pid
);

42 i‡(
«me•a˚_ƒ
 == 0) {

43 
«me•a˚_ƒ
 = 
sysˇŒ
->
±ø˚
.
pid
;

46 
±ø˚_evít_t
 
evít
 = {

47 .
sysˇŒ
.
ªtvÆ
 =Ñetval,

48 .
ªque°
 = 
sysˇŒ
->
±ø˚
.request,

49 .
pid
 = 
«me•a˚_ƒ
,

50 .
addr
 = 
sysˇŒ
->
±ø˚
.addr,

53 
¥oc_ˇche_t
 *
íåy
 = 
	`fûl_¥o˚ss_c⁄ãxt
(&
evít
.
¥o˚ss
);

54 
	`fûl_c⁄èöî_c⁄ãxt
(
íåy
, &
evít
.
c⁄èöî
);

55 
	`fûl_•™_c⁄ãxt
(&
evít
.
•™
);

57 
	`£nd_evít
(
˘x
, 
EVENT_PTRACE
, 
evít
);

59 
	}
}

61 
	$SYSCALL_KRETPROBE
(
±ø˚
) {

62  
	`sys_±ø˚_ªt
(
˘x
, ()
	`PT_REGS_RC
(ctx));

63 
	}
}

65 
SEC
("tracepoint/syscalls/sys_exit_ptrace")

66 
	$åa˚poöt_sysˇŒs_sys_exô_±ø˚
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

67  
	`sys_±ø˚_ªt
(
¨gs
, (Ôrgs->
ªt
);

68 
	}
}

	@raw_syscalls.h

1 #i‚de‡
_RAW_SYSCALLS_H


2 
	#_RAW_SYSCALLS_H


	)

4 
	~"defs.h
"

6 
	s_åa˚poöt_øw_sysˇŒs_sys_íãr
 {

7 
	mcomm⁄_ty≥
;

8 
	mcomm⁄_Êags
;

9 
	mcomm⁄_¥ìm±_cou¡
;

10 
	mcomm⁄_pid
;

11 
	mid
;

12 
	m¨gs
[6];

15 
bpf_m≠_def
 
SEC
("m≠s/c⁄cuºít_sysˇŒs"Ë
	gc⁄cuºít_sysˇŒs
 = {

16 .
ty≥
 = 
BPF_MAP_TYPE_ARRAY
,

17 .
	gkey_size
 = (
u32
),

18 .
	gvÆue_size
 = (),

19 .
	gmax_íåõs
 = 1,

20 .
	gpönög
 = 0,

21 .
	g«me•a˚
 = "",

24 
bpf_m≠_def
 
SEC
("m≠s/sys_exô_¥ogs"Ë
	gsys_exô_¥ogs
 = {

25 .
ty≥
 = 
BPF_MAP_TYPE_PROG_ARRAY
,

26 .
	gkey_size
 = (
u32
),

27 .
	gvÆue_size
 = (
u32
),

28 .
	gmax_íåõs
 = 64,

31 
	#CONCURRENT_SYSCALLS_COUNTER
 0

	)

33 
	s¥o˚ss_sysˇŒ_t
 {

34 
	mcomm
[
TASK_COMM_LEN
];

35 
	mpid
;

36 
	mid
;

39 
bpf_m≠_def
 
SEC
("m≠s/noisy_¥o˚s£s_fb"Ë
	gnoisy_¥o˚s£s_fb
 = {

40 .
ty≥
 = 
BPF_MAP_TYPE_LRU_HASH
,

41 .
	gkey_size
 = (
¥o˚ss_sysˇŒ_t
),

42 .
	gvÆue_size
 = (
u64
),

43 .
	gmax_íåõs
 = 2048,

44 .
	gpönög
 = 0,

45 .
	g«me•a˚
 = "",

48 
bpf_m≠_def
 
SEC
("m≠s/noisy_¥o˚s£s_bb"Ë
	gnoisy_¥o˚s£s_bb
 = {

49 .
ty≥
 = 
BPF_MAP_TYPE_LRU_HASH
,

50 .
	gkey_size
 = (
¥o˚ss_sysˇŒ_t
),

51 .
	gvÆue_size
 = (
u64
),

52 .
	gmax_íåõs
 = 2048,

53 .
	gpönög
 = 0,

54 .
	g«me•a˚
 = "",

57 
SEC
("tracepoint/raw_syscalls/sys_enter")

58 
	$sys_íãr
(
_åa˚poöt_øw_sysˇŒs_sys_íãr
 *
¨gs
) {

59 
¥o˚ss_sysˇŒ_t
 
sysˇŒ
 = {};

60 
	`bpf_¥obe_ªad
(&
sysˇŒ
.
pid
, (sysˇŒ.pid), &
¨gs
->
comm⁄_pid
);

61 
	`bpf_¥obe_ªad
(&
sysˇŒ
.
id
, (sysˇŒ.id), &
¨gs
->id);

62 
	`bpf_gë_cuºít_comm
(&
sysˇŒ
.
comm
, (syscall.comm));

64 
bpf_m≠_def
 *
noisy_¥o˚s£s
 = 
	`£À˘_buf„r
(&
noisy_¥o˚s£s_fb
, &
noisy_¥o˚s£s_bb
, 
SYSCALL_MONITOR_KEY
);

65 i‡(
noisy_¥o˚s£s
 =
NULL
)

68 
u64
 
zîo
 = 0;

69 
u64
 *
cou¡
 = 
	`bpf_m≠_lookup_‹_åy_öô
(
noisy_¥o˚s£s
, &
sysˇŒ
, &
zîo
);

70 i‡(
cou¡
 =
NULL
) {

74 
	`__sync_„tch_™d_add
(
cou¡
, 1);

76 
u32
 
key
 = 
CONCURRENT_SYSCALLS_COUNTER
;

77 *
c⁄cuºít_sysˇŒs_cou¡î
 = 
	`bpf_m≠_lookup_ñem
(&
c⁄cuºít_sysˇŒs
, &
key
);

78 i‡(
c⁄cuºít_sysˇŒs_cou¡î
 =
NULL
)

81 
	`__sync_„tch_™d_add
(
c⁄cuºít_sysˇŒs_cou¡î
, 1);

84 
	}
}

88 
__©åibuã__
((
Æways_ölöe
)Ë
	$h™dÀ_sys_exô
(
åa˚poöt_øw_sysˇŒs_sys_exô_t
 *
¨gs
) {

89 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
EVENT_ANY
);

90 i‡(!
sysˇŒ
)

93 
	`bpf_èû_ˇŒ_com∑t
(
¨gs
, &
sys_exô_¥ogs
, 
sysˇŒ
->
ty≥
);

95 
	}
}

97 
SEC
("tracepoint/raw_syscalls/sys_exit")

98 
	$sys_exô
(
åa˚poöt_øw_sysˇŒs_sys_exô_t
 *
¨gs
) {

99 
u64
 
ÁŒback
;

100 
	`LOAD_CONSTANT
("åa˚poöt_øw_sysˇŒ_ÁŒback", 
ÁŒback
);

101 i‡(
ÁŒback
) {

102 
	`h™dÀ_sys_exô
(
¨gs
);

106 
u64
 
íabÀd
;

107 
	`LOAD_CONSTANT
("sysˇŒ_m⁄ô‹", 
íabÀd
);

108 i‡(
íabÀd
) {

109 
u32
 
key
 = 
CONCURRENT_SYSCALLS_COUNTER
;

110 *
c⁄cuºít_sysˇŒs_cou¡î
 = 
	`bpf_m≠_lookup_ñem
(&
c⁄cuºít_sysˇŒs
, &
key
);

111 i‡(
c⁄cuºít_sysˇŒs_cou¡î
 =
NULL
)

114 
	`__sync_„tch_™d_add
(
c⁄cuºít_sysˇŒs_cou¡î
, -1);

115 i‡(*
c⁄cuºít_sysˇŒs_cou¡î
 < 0) {

116 
	`__sync_„tch_™d_add
(
c⁄cuºít_sysˇŒs_cou¡î
, 1);

121 
	}
}

	@rename.h

1 #i‚de‡
_RENAME_H_


2 
	#_RENAME_H_


	)

4 
	~"sysˇŒs.h
"

6 
	sª«me_evít_t
 {

7 
kevít_t
 
	mevít
;

8 
¥o˚ss_c⁄ãxt_t
 
	m¥o˚ss
;

9 
•™_c⁄ãxt_t
 
	m•™
;

10 
c⁄èöî_c⁄ãxt_t
 
	mc⁄èöî
;

11 
sysˇŒ_t
 
	msysˇŒ
;

12 
fûe_t
 
	mﬁd
;

13 
fûe_t
 
	m√w
;

16 
__©åibuã__
((
Æways_ölöe
)Ë
	$ª«me_≠¥ovîs
(
sysˇŒ_ˇche_t
 *
sysˇŒ
) {

17  
	`ba£«me_≠¥ovî
(
sysˇŒ
, sysˇŒ->
ª«me
.
§c_díåy
, 
EVENT_RENAME
) ||

18 
	`ba£«me_≠¥ovî
(
sysˇŒ
, sysˇŒ->
ª«me
.
èrgë_díåy
, 
EVENT_RENAME
);

19 
	}
}

21 
__©åibuã__
((
Æways_ölöe
)Ë
	$åa˚__sys_ª«me
() {

22 
sysˇŒ_ˇche_t
 
sysˇŒ
 = {

23 .
pﬁicy
 = 
	`„tch_pﬁicy
(
EVENT_RENAME
),

24 .
ty≥
 = 
EVENT_RENAME
,

27 
	`ˇche_sysˇŒ
(&
sysˇŒ
);

30 
	}
}

32 
	$SYSCALL_KPROBE0
(
ª«me
) {

33  
	`åa˚__sys_ª«me
();

34 
	}
}

36 
	$SYSCALL_KPROBE0
(
ª«mót
) {

37  
	`åa˚__sys_ª«me
();

38 
	}
}

40 
	$SYSCALL_KPROBE0
(
ª«mót2
) {

41  
	`åa˚__sys_ª«me
();

42 
	}
}

44 
SEC
("kprobe/vfs_rename")

45 
	$k¥obe_vfs_ª«me
(
±_ªgs
 *
˘x
) {

46 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
EVENT_RENAME
);

47 i‡(!
sysˇŒ
)

51 i‡(
sysˇŒ
->
ª«me
.
èrgë_fûe
.
∑th_key
.
öo
) {

55 
díåy
 *
§c_díåy
;

56 
díåy
 *
èrgë_díåy
;

58 i‡(
	`gë_vfs_ª«me_öput_ty≥
(Ë=
VFS_RENAME_REGISTER_INPUT
) {

59 
§c_díåy
 = (
díåy
 *)
	`PT_REGS_PARM2
(
˘x
);

60 
èrgë_díåy
 = (
díåy
 *)
	`PT_REGS_PARM4
(
˘x
);

62 
ª«med©a
 *
ª«me_d©a
 = (ª«med©®*)
	`PT_REGS_PARM1
(
˘x
);

64 
	`bpf_¥obe_ªad
(&
§c_díåy
, (§c_díåy), (*Ë
ª«me_d©a
 + 
	`gë_vfs_ª«me_§c_díåy_off£t
());

65 
	`bpf_¥obe_ªad
(&
èrgë_díåy
, —¨gë_díåy), (*Ë
ª«me_d©a
 + 
	`gë_vfs_ª«me_èrgë_díåy_off£t
());

68 
sysˇŒ
->
ª«me
.
§c_díåy
 = src_dentry;

69 
sysˇŒ
->
ª«me
.
èrgë_díåy
 =Åarget_dentry;

71 
	`fûl_fûe_mëad©a
(
§c_díåy
, &
sysˇŒ
->
ª«me
.
§c_fûe
.
mëad©a
);

72 
sysˇŒ
->
ª«me
.
èrgë_fûe
.
mëad©a
 = sysˇŒ->ª«me.
§c_fûe
.metadata;

73 i‡(
	`is_ovîœyfs
(
§c_díåy
)) {

74 
sysˇŒ
->
ª«me
.
èrgë_fûe
.
Êags
 |
UPPER_LAYER
;

79 
	`£t_fûe_öode
(
§c_díåy
, &
sysˇŒ
->
ª«me
.
èrgë_fûe
, 1);

82 
sysˇŒ
->
ª«me
.
§c_fûe
.
∑th_key
.
öo
 = 
FAKE_INODE_MSW
<<32 | 
	`bpf_gë_¥™dom_u32
();

85 
u64
 
öode
 = 
	`gë_díåy_öo
(
èrgë_díåy
);

86 i‡(
öode
) {

87 
	`övÆid©e_öode
(
˘x
, 
sysˇŒ
->
ª«me
.
èrgë_fûe
.
∑th_key
.
mou¡_id
, 
öode
, 1);

91 i‡(
	`fûãr_sysˇŒ
(
sysˇŒ
, 
ª«me_≠¥ovîs
)) {

92  
	`m¨k_as_disˇrded
(
sysˇŒ
);

96 i‡(
	`is_disˇrded_by_¥o˚ss
(
sysˇŒ
->
pﬁicy
.
mode
, 
EVENT_RENAME
)) {

97  
	`m¨k_as_disˇrded
(
sysˇŒ
);

101 
sysˇŒ
->
ªsﬁvî
.
díåy
 = sysˇŒ->
ª«me
.
§c_díåy
;

102 
sysˇŒ
->
ªsﬁvî
.
key
 = sysˇŒ->
ª«me
.
§c_fûe
.
∑th_key
;

103 
sysˇŒ
->
ªsﬁvî
.
disˇrdî_ty≥
 = 0;

104 
sysˇŒ
->
ªsﬁvî
.
ˇŒback
 = 
DR_NO_CALLBACK
;

105 
sysˇŒ
->
ªsﬁvî
.
ôî©i⁄
 = 0;

106 
sysˇŒ
->
ªsﬁvî
.
ªt
 = 0;

108 
	`ªsﬁve_díåy
(
˘x
, 
DR_KPROBE
);

110 
	}
}

112 
__©åibuã__
((
Æways_ölöe
)Ë
	$sys_ª«me_ªt
(*
˘x
, 
ªtvÆ
, 
dr_ty≥
) {

113 i‡(
	`IS_UNHANDLED_ERROR
(
ªtvÆ
)) {

117 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
EVENT_RENAME
);

118 i‡(!
sysˇŒ
)

121 
u64
 
öode
 = 
	`gë_díåy_öo
(
sysˇŒ
->
ª«me
.
§c_díåy
);

124 i‡(
sysˇŒ
->
ª«me
.
èrgë_fûe
.
∑th_key
.
öo
 !
öode
 && 
ªtvÆ
 >= 0) {

125 
	`övÆid©e_öode
(
˘x
, 
sysˇŒ
->
ª«me
.
èrgë_fûe
.
∑th_key
.
mou¡_id
, 
öode
, 1);

128 
∑ss_to_u£r•a˚
 = !
sysˇŒ
->
disˇrded
 && 
	`is_evít_íabÀd
(
EVENT_RENAME
);

131 i‡(
ªtvÆ
 >= 0) {

132 
	`övÆid©e_öode
(
˘x
, 
sysˇŒ
->
ª«me
.
èrgë_fûe
.
∑th_key
.
mou¡_id
, sysˇŒ->ª«me.èrgë_fûe.∑th_key.
öo
, !
∑ss_to_u£r•a˚
);

135 i‡(
∑ss_to_u£r•a˚
) {

137 
sysˇŒ
->
ªsﬁvî
.
key
 = sysˇŒ->
ª«me
.
èrgë_fûe
.
∑th_key
;

138 
sysˇŒ
->
ªsﬁvî
.
díåy
 = sysˇŒ->
ª«me
.
§c_díåy
;

139 
sysˇŒ
->
ªsﬁvî
.
disˇrdî_ty≥
 = 0;

140 
sysˇŒ
->
ªsﬁvî
.
ˇŒback
 = 
dr_ty≥
 =
DR_KPROBE
 ? 
DR_RENAME_CALLBACK_KPROBE_KEY
 : 
DR_RENAME_CALLBACK_TRACEPOINT_KEY
;

141 
sysˇŒ
->
ªsﬁvî
.
ôî©i⁄
 = 0;

142 
sysˇŒ
->
ªsﬁvî
.
ªt
 = 0;

144 
	`ªsﬁve_díåy
(
˘x
, 
dr_ty≥
);

148 
	`p›_sysˇŒ
(
EVENT_RENAME
);

150 
	}
}

152 
__©åibuã__
((
Æways_ölöe
)Ë
	$k¥obe_sys_ª«me_ªt
(
±_ªgs
 *
˘x
) {

153 
ªtvÆ
 = 
	`PT_REGS_RC
(
˘x
);

154  
	`sys_ª«me_ªt
(
˘x
, 
ªtvÆ
, 
DR_KPROBE
);

155 
	}
}

157 
SEC
("tracepoint/syscalls/sys_exit_rename")

158 
	$åa˚poöt_sysˇŒs_sys_exô_ª«me
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

159  
	`sys_ª«me_ªt
(
¨gs
,árgs->
ªt
, 
DR_TRACEPOINT
);

160 
	}
}

162 
	$SYSCALL_KRETPROBE
(
ª«me
) {

163  
	`k¥obe_sys_ª«me_ªt
(
˘x
);

164 
	}
}

166 
SEC
("tracepoint/syscalls/sys_exit_renameat")

167 
	$åa˚poöt_sysˇŒs_sys_exô_ª«mót
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

168  
	`sys_ª«me_ªt
(
¨gs
,árgs->
ªt
, 
DR_TRACEPOINT
);

169 
	}
}

171 
	$SYSCALL_KRETPROBE
(
ª«mót
) {

172  
	`k¥obe_sys_ª«me_ªt
(
˘x
);

173 
	}
}

175 
SEC
("tracepoint/syscalls/sys_exit_renameat2")

176 
	$åa˚poöt_sysˇŒs_sys_exô_ª«mót2
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

177  
	`sys_ª«me_ªt
(
¨gs
,árgs->
ªt
, 
DR_TRACEPOINT
);

178 
	}
}

180 
	$SYSCALL_KRETPROBE
(
ª«mót2
) {

181  
	`k¥obe_sys_ª«me_ªt
(
˘x
);

182 
	}
}

184 
SEC
("tracepoint/handle_sys_rename_exit")

185 
	$åa˚poöt_h™dÀ_sys_ª«me_exô
(
åa˚poöt_øw_sysˇŒs_sys_exô_t
 *
¨gs
) {

186  
	`sys_ª«me_ªt
(
¨gs
,árgs->
ªt
, 
DR_TRACEPOINT
);

187 
	}
}

189 
__©åibuã__
((
Æways_ölöe
)Ë
	$dr_ª«me_ˇŒback
(*
˘x
, 
ªtvÆ
) {

190 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`p›_sysˇŒ
(
EVENT_RENAME
);

191 i‡(!
sysˇŒ
)

194 i‡(
	`IS_UNHANDLED_ERROR
(
ªtvÆ
))

197 
ª«me_evít_t
 
evít
 = {

198 .
sysˇŒ
.
ªtvÆ
 =Ñetval,

199 .
ﬁd
 = 
sysˇŒ
->
ª«me
.
§c_fûe
,

200 .
√w
 = 
sysˇŒ
->
ª«me
.
èrgë_fûe
,

203 
¥oc_ˇche_t
 *
íåy
 = 
	`fûl_¥o˚ss_c⁄ãxt
(&
evít
.
¥o˚ss
);

204 
	`fûl_c⁄èöî_c⁄ãxt
(
íåy
, &
evít
.
c⁄èöî
);

205 
	`fûl_•™_c⁄ãxt
(&
evít
.
•™
);

207 
	`£nd_evít
(
˘x
, 
EVENT_RENAME
, 
evít
);

210 
	}
}

212 
SEC
("kprobe/dr_rename_callback")

213 
__©åibuã__
((
Æways_ölöe
)Ë
	$k¥obe_dr_ª«me_ˇŒback
(
±_ªgs
 *
˘x
) {

214 
ªt
 = 
	`PT_REGS_RC
(
˘x
);

215  
	`dr_ª«me_ˇŒback
(
˘x
, 
ªt
);

216 
	}
}

218 
SEC
("tracepoint/dr_rename_callback")

219 
__©åibuã__
((
Æways_ölöe
)Ë
	$åa˚poöt_dr_ª«me_ˇŒback
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

220  
	`dr_ª«me_ˇŒback
(
¨gs
,árgs->
ªt
);

221 
	}
}

	@rmdir.h

1 #i‚de‡
_RMDIR_H_


2 
	#_RMDIR_H_


	)

4 
	~"sysˇŒs.h
"

6 
	srmdú_evít_t
 {

7 
kevít_t
 
	mevít
;

8 
¥o˚ss_c⁄ãxt_t
 
	m¥o˚ss
;

9 
•™_c⁄ãxt_t
 
	m•™
;

10 
c⁄èöî_c⁄ãxt_t
 
	mc⁄èöî
;

11 
sysˇŒ_t
 
	msysˇŒ
;

12 
fûe_t
 
	mfûe
;

15 
__©åibuã__
((
Æways_ölöe
)Ë
	$rmdú_≠¥ovîs
(
sysˇŒ_ˇche_t
 *
sysˇŒ
) {

16  
	`ba£«me_≠¥ovî
(
sysˇŒ
, sysˇŒ->
rmdú
.
díåy
, 
EVENT_RMDIR
);

17 
	}
}

18 
__©åibuã__
((
Æways_ölöe
)Ë
u∆ök_≠¥ovîs
(
sysˇŒ_ˇche_t
 *
sysˇŒ
);

20 
	$SYSCALL_KPROBE0
(
rmdú
) {

21 
sysˇŒ_ˇche_t
 
sysˇŒ
 = {

22 .
ty≥
 = 
EVENT_RMDIR
,

23 .
pﬁicy
 = 
	`„tch_pﬁicy
(
EVENT_RMDIR
),

26 
	`ˇche_sysˇŒ
(&
sysˇŒ
);

29 
	}
}

31 
__©åibuã__
((
Æways_ölöe
)Ë
	$rmdú_¥ediˇã
(
u64
 
ty≥
) {

32  
ty≥
 =
EVENT_RMDIR
 ||Åy≥ =
EVENT_UNLINK
;

33 
	}
}

36 
SEC
("kprobe/security_inode_rmdir")

37 
	$k¥obe_£curôy_öode_rmdú
(
±_ªgs
 *
˘x
) {

38 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ_wôh
(
rmdú_¥ediˇã
);

39 i‡(!
sysˇŒ
)

42 
∑th_key_t
 
key
 = {};

43 
díåy
 *díåy = 
NULL
;

45 
sysˇŒ
->
ty≥
) {

46 
EVENT_RMDIR
:

47 i‡(
sysˇŒ
->
rmdú
.
fûe
.
∑th_key
.
öo
) {

52 
díåy
 = (díåy *)
	`PT_REGS_PARM2
(
˘x
);

53 
	`£t_fûe_öode
(
díåy
, &
sysˇŒ
->
rmdú
.
fûe
, 1);

54 
	`fûl_fûe_mëad©a
(
díåy
, &
sysˇŒ
->
rmdú
.
fûe
.
mëad©a
);

57 
key
 = 
sysˇŒ
->
rmdú
.
fûe
.
∑th_key
;

59 
sysˇŒ
->
rmdú
.
díåy
 = dentry;

60 i‡(
	`fûãr_sysˇŒ
(
sysˇŒ
, 
rmdú_≠¥ovîs
)) {

61  
	`m¨k_as_disˇrded
(
sysˇŒ
);

65 
EVENT_UNLINK
:

66 i‡(
sysˇŒ
->
u∆ök
.
fûe
.
∑th_key
.
öo
) {

71 
díåy
 = (díåy *Ë
	`PT_REGS_PARM2
(
˘x
);

72 
	`£t_fûe_öode
(
díåy
, &
sysˇŒ
->
u∆ök
.
fûe
, 1);

73 
	`fûl_fûe_mëad©a
(
díåy
, &
sysˇŒ
->
u∆ök
.
fûe
.
mëad©a
);

76 
key
 = 
sysˇŒ
->
u∆ök
.
fûe
.
∑th_key
;

78 
sysˇŒ
->
u∆ök
.
díåy
 = dentry;

79 
sysˇŒ
->
pﬁicy
 = 
	`„tch_pﬁicy
(
EVENT_RMDIR
);

80 i‡(
	`fûãr_sysˇŒ
(
sysˇŒ
, 
rmdú_≠¥ovîs
)) {

81  
	`m¨k_as_disˇrded
(
sysˇŒ
);

89 i‡(
	`is_disˇrded_by_¥o˚ss
(
sysˇŒ
->
pﬁicy
.
mode
, sysˇŒ->
ty≥
)) {

90  
	`m¨k_as_disˇrded
(
sysˇŒ
);

93 i‡(
díåy
 !
NULL
) {

94 
sysˇŒ
->
ªsﬁvî
.
key
 = key;

95 
sysˇŒ
->
ªsﬁvî
.
díåy
 = dentry;

96 
sysˇŒ
->
ªsﬁvî
.
disˇrdî_ty≥
 = sysˇŒ->
pﬁicy
.
mode
 !
NO_FILTER
 ? sysˇŒ->
ty≥
 : 0;

97 
sysˇŒ
->
ªsﬁvî
.
ˇŒback
 = 
DR_SECURITY_INODE_RMDIR_CALLBACK_KPROBE_KEY
;

98 
sysˇŒ
->
ªsﬁvî
.
ôî©i⁄
 = 0;

99 
sysˇŒ
->
ªsﬁvî
.
ªt
 = 0;

101 
	`ªsﬁve_díåy
(
˘x
, 
DR_KPROBE
);

104 
	}
}

106 
SEC
("kprobe/dr_security_inode_rmdir_callback")

107 
__©åibuã__
((
Æways_ölöe
)Ë
	$k¥obe_dr_£curôy_öode_rmdú_ˇŒback
(
±_ªgs
 *
˘x
) {

108 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ_wôh
(
rmdú_¥ediˇã
);

109 i‡(!
sysˇŒ
)

112 i‡(
sysˇŒ
->
ªsﬁvî
.
ªt
 =
DENTRY_DISCARDED
) {

113  
	`m¨k_as_disˇrded
(
sysˇŒ
);

116 
	}
}

118 
__©åibuã__
((
Æways_ölöe
)Ë
	$sys_rmdú_ªt
(*
˘x
, 
ªtvÆ
) {

119 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`p›_sysˇŒ_wôh
(
rmdú_¥ediˇã
);

120 i‡(!
sysˇŒ
)

123 i‡(
	`IS_UNHANDLED_ERROR
(
ªtvÆ
)) {

127 
∑ss_to_u£r•a˚
 = !
sysˇŒ
->
disˇrded
 && 
	`is_evít_íabÀd
(
EVENT_RMDIR
);

128 i‡(
∑ss_to_u£r•a˚
) {

129 
rmdú_evít_t
 
evít
 = {

130 .
sysˇŒ
.
ªtvÆ
 =Ñetval,

131 .
fûe
 = 
sysˇŒ
->
rmdú
.file,

134 
¥oc_ˇche_t
 *
íåy
 = 
	`fûl_¥o˚ss_c⁄ãxt
(&
evít
.
¥o˚ss
);

135 
	`fûl_c⁄èöî_c⁄ãxt
(
íåy
, &
evít
.
c⁄èöî
);

136 
	`fûl_•™_c⁄ãxt
(&
evít
.
•™
);

138 
	`£nd_evít
(
˘x
, 
EVENT_RMDIR
, 
evít
);

141 i‡(
ªtvÆ
 >= 0) {

142 
	`övÆid©e_öode
(
˘x
, 
sysˇŒ
->
rmdú
.
fûe
.
∑th_key
.
mou¡_id
, sysˇŒ->rmdú.fûe.∑th_key.
öo
, !
∑ss_to_u£r•a˚
);

146 
	}
}

148 
SEC
("tracepoint/syscalls/sys_exit_rmdir")

149 
	$åa˚poöt_sysˇŒs_sys_exô_rmdú
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

150  
	`sys_rmdú_ªt
(
¨gs
,árgs->
ªt
);

151 
	}
}

153 
	$SYSCALL_KRETPROBE
(
rmdú
) {

154 
ªtvÆ
 = 
	`PT_REGS_RC
(
˘x
);

155  
	`sys_rmdú_ªt
(
˘x
, 
ªtvÆ
);

156 
	}
}

158 
SEC
("tracepoint/handle_sys_rmdir_exit")

159 
	$åa˚poöt_h™dÀ_sys_rmdú_exô
(
åa˚poöt_øw_sysˇŒs_sys_exô_t
 *
¨gs
) {

160  
	`sys_rmdú_ªt
(
¨gs
,árgs->
ªt
);

161 
	}
}

	@selinux.h

1 #i‚de‡
_SELINUX_H_


2 
	#_SELINUX_H_


	)

4 
	~"defs.h
"

5 
	~"fûãrs.h
"

6 
	~"sysˇŒs.h
"

7 
	~"¥o˚ss.h
"

9 
	e£löux_sour˚_evít_t


11 
	mSELINUX_BOOL_CHANGE_SOURCE_EVENT
,

12 
	mSELINUX_DISABLE_CHANGE_SOURCE_EVENT
,

13 
	mSELINUX_ENFORCE_CHANGE_SOURCE_EVENT
,

14 
	mSELINUX_BOOL_COMMIT_SOURCE_EVENT
,

17 
	e£löux_evít_köd_t


19 
	mSELINUX_BOOL_CHANGE_EVENT_KIND
,

20 
	mSELINUX_STATUS_CHANGE_EVENT_KIND
,

21 
	mSELINUX_BOOL_COMMIT_EVENT_KIND
,

24 
	s£löux_evít_t
 {

25 
kevít_t
 
	mevít
;

26 
¥o˚ss_c⁄ãxt_t
 
	m¥o˚ss
;

27 
•™_c⁄ãxt_t
 
	m•™
;

28 
c⁄èöî_c⁄ãxt_t
 
	mc⁄èöî
;

29 
fûe_t
 
	mfûe
;

30 
u32
 
	mevít_köd
;

31 
£löux_wrôe_∑ylﬂd_t
 
	m∑ylﬂd
;

34 
	#SELINUX_WRITE_BUFFER_LEN
 64

	)

36 
	s£löux_wrôe_buf„r_t
 {

37 
	mbuf„r
[
SELINUX_WRITE_BUFFER_LEN
];

40 
bpf_m≠_def
 
SEC
("m≠s/£löux_wrôe_buf„r"Ë
	g£löux_wrôe_buf„r
 = {

41 .
ty≥
 = 
BPF_MAP_TYPE_PERCPU_ARRAY
,

42 .
	gkey_size
 = (
u32
),

43 .
	gvÆue_size
 = (
£löux_wrôe_buf„r_t
),

44 .
	gmax_íåõs
 = 1,

45 .
	gpönög
 = 0,

46 .
	g«me•a˚
 = "",

49 
bpf_m≠_def
 
SEC
("m≠s/£löux_íf‹˚_°©us"Ë
	g£löux_íf‹˚_°©us
 = {

50 .
ty≥
 = 
BPF_MAP_TYPE_ARRAY
,

51 .
	gkey_size
 = (
u32
),

52 .
	gvÆue_size
 = (
u16
),

53 .
	gmax_íåõs
 = 2,

54 .
	gpönög
 = 0,

55 .
	g«me•a˚
 = "",

58 
	#SELINUX_ENFORCE_STATUS_DISABLE_KEY
 0

	)

59 
	#SELINUX_ENFORCE_STATUS_ENFORCE_KEY
 1

	)

61 
__©åibuã__
((
Æways_ölöe
)Ë
	$∑r£_buf_to_boﬁ
(c⁄° *
buf
) {

62 
u32
 
key
 = 0;

63 
£löux_wrôe_buf„r_t
 *
c›y
 = 
	`bpf_m≠_lookup_ñem
(&
£löux_wrôe_buf„r
, &
key
);

64 i‡(!
c›y
) {

67 
ªad_°©us
 = 
	`bpf_¥obe_ªad_°r
(&
c›y
->
buf„r
, 
SELINUX_WRITE_BUFFER_LEN
, (*)
buf
);

68 i‡(!
ªad_°©us
) {

72 #¥agm®
uƒﬁl


73 
size_t
 
i
 = 0; i < 
SELINUX_WRITE_BUFFER_LEN
; i++) {

74 
cuº
 = 
c›y
->
buf„r
[
i
];

75 i‡(
cuº
 == 0) {

77 } i‡('0' < 
cuº
 && curr <= '9') {

79 } i‡(
cuº
 != '0') {

85 
	}
}

87 
__©åibuã__
((
Æways_ölöe
)Ë
	$fûl_£löux_°©us_∑ylﬂd
(
sysˇŒ_ˇche_t
 *
sysˇŒ
) {

89 
u32
 
key
 = 
SELINUX_ENFORCE_STATUS_DISABLE_KEY
;

90 *
±r
 = 
	`bpf_m≠_lookup_ñem
(&
£löux_íf‹˚_°©us
, &
key
);

91 i‡(!
±r
) {

94 
sysˇŒ
->
£löux
.
∑ylﬂd
.
°©us
.
dißbÀ_vÆue
 = *(
u16
 *)
±r
;

97 
key
 = 
SELINUX_ENFORCE_STATUS_ENFORCE_KEY
;

98 
±r
 = 
	`bpf_m≠_lookup_ñem
(&
£löux_íf‹˚_°©us
, &
key
);

99 i‡(!
±r
) {

102 
sysˇŒ
->
£löux
.
∑ylﬂd
.
°©us
.
íf‹˚_vÆue
 = *(
u16
 *)
±r
;

105 
	}
}

107 
__©åibuã__
((
Æways_ölöe
)Ë
	$h™dÀ_£löux_evít
(*
˘x
, 
fûe
 *fûe, c⁄° *
buf
, 
size_t
 
cou¡
, 
£löux_sour˚_evít_t
 
sour˚_evít
) {

108 
sysˇŒ_ˇche_t
 
sysˇŒ
 = {

109 .
ty≥
 = 
EVENT_SELINUX
,

110 .
pﬁicy
 = 
	`„tch_pﬁicy
(
EVENT_SELINUX
),

111 .
£löux
 = {

112 .
∑ylﬂd
.
boﬁ_vÆue
 = -1,

116 
díåy
 *díåy = 
	`gë_fûe_díåy
(
fûe
);

117 
sysˇŒ
.
£löux
.
díåy
 = dentry;

118 
sysˇŒ
.
£löux
.
fûe
.
∑th_key
.
mou¡_id
 = 
	`gë_fûe_mou¡_id
(file);

120 i‡(
cou¡
 < 
SELINUX_WRITE_BUFFER_LEN
) {

121 
vÆue
 = 
	`∑r£_buf_to_boﬁ
(
buf
);

122 
sour˚_evít
) {

123 
SELINUX_BOOL_CHANGE_SOURCE_EVENT
:

124 
sysˇŒ
.
£löux
.
evít_köd
 = 
SELINUX_BOOL_CHANGE_EVENT_KIND
;

125 
sysˇŒ
.
£löux
.
∑ylﬂd
.
boﬁ_vÆue
 = 
vÆue
;

127 
SELINUX_BOOL_COMMIT_SOURCE_EVENT
:

128 
sysˇŒ
.
£löux
.
evít_köd
 = 
SELINUX_BOOL_COMMIT_EVENT_KIND
;

129 
sysˇŒ
.
£löux
.
∑ylﬂd
.
boﬁ_vÆue
 = 
vÆue
;

131 
SELINUX_ENFORCE_CHANGE_SOURCE_EVENT
:

132 
sysˇŒ
.
£löux
.
evít_köd
 = 
SELINUX_STATUS_CHANGE_EVENT_KIND
;

133 i‡(
vÆue
 >= 0) {

134 
u32
 
key
 = 
SELINUX_ENFORCE_STATUS_ENFORCE_KEY
;

135 
	`bpf_m≠_upd©e_ñem
(&
£löux_íf‹˚_°©us
, &
key
, &
vÆue
, 
BPF_ANY
);

137 
	`fûl_£löux_°©us_∑ylﬂd
(&
sysˇŒ
);

139 
SELINUX_DISABLE_CHANGE_SOURCE_EVENT
:

140 
sysˇŒ
.
£löux
.
evít_köd
 = 
SELINUX_STATUS_CHANGE_EVENT_KIND
;

141 i‡(
vÆue
 >= 0) {

142 
u32
 
key
 = 
SELINUX_ENFORCE_STATUS_DISABLE_KEY
;

143 
	`bpf_m≠_upd©e_ñem
(&
£löux_íf‹˚_°©us
, &
key
, &
vÆue
, 
BPF_ANY
);

145 
	`fûl_£löux_°©us_∑ylﬂd
(&
sysˇŒ
);

151 
	`fûl_fûe_mëad©a
(
sysˇŒ
.
£löux
.
díåy
, &sysˇŒ.£löux.
fûe
.
mëad©a
);

152 
	`£t_fûe_öode
(
sysˇŒ
.
£löux
.
díåy
, &sysˇŒ.£löux.
fûe
, 0);

154 
sysˇŒ
.
ªsﬁvî
.
key
 = sysˇŒ.
£löux
.
fûe
.
∑th_key
;

155 
sysˇŒ
.
ªsﬁvî
.
díåy
 = sysˇŒ.
£löux
.dentry;

156 
sysˇŒ
.
ªsﬁvî
.
disˇrdî_ty≥
 = sysˇŒ.
pﬁicy
.
mode
 !
NO_FILTER
 ? 
EVENT_SELINUX
 : 0;

157 
sysˇŒ
.
ªsﬁvî
.
ˇŒback
 = 
DR_SELINUX_CALLBACK_KPROBE_KEY
;

158 
sysˇŒ
.
ªsﬁvî
.
ôî©i⁄
 = 0;

159 
sysˇŒ
.
ªsﬁvî
.
ªt
 = 0;

161 
	`ˇche_sysˇŒ
(&
sysˇŒ
);

164 
	`ªsﬁve_díåy
(
˘x
, 
DR_KPROBE
);

167 
	`p›_sysˇŒ
(
EVENT_SELINUX
);

170 
	}
}

172 
__©åibuã__
((
Æways_ölöe
)Ë
	$dr_£löux_ˇŒback
(*
˘x
, 
ªtvÆ
) {

173 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`p›_sysˇŒ
(
EVENT_SELINUX
);

174 i‡(!
sysˇŒ
)

177 i‡(
sysˇŒ
->
ªsﬁvî
.
ªt
 =
DENTRY_DISCARDED
 || sysˇŒ->ªsﬁvî.ªà=
DENTRY_INVALID
)

180 
£löux_evít_t
 
evít
 = {};

181 
evít
.
evít_köd
 = 
sysˇŒ
->
£löux
.event_kind;

182 
evít
.
fûe
 = 
sysˇŒ
->
£löux
.file;

183 
evít
.
∑ylﬂd
 = 
sysˇŒ
->
£löux
.payload;

185 
¥oc_ˇche_t
 *
íåy
 = 
	`fûl_¥o˚ss_c⁄ãxt
(&
evít
.
¥o˚ss
);

186 
	`fûl_c⁄èöî_c⁄ãxt
(
íåy
, &
evít
.
c⁄èöî
);

187 
	`fûl_•™_c⁄ãxt
(&
evít
.
•™
);

189 
	`£nd_evít
(
˘x
, 
EVENT_SELINUX
, 
evít
);

191 
	}
}

193 
SEC
("kprobe/dr_selinux_callback")

194 
__©åibuã__
((
Æways_ölöe
)Ë
	$k¥obe_dr_£löux_ˇŒback
(
±_ªgs
 *
˘x
) {

195 
ªtvÆ
 = 
	`PT_REGS_RC
(
˘x
);

196  
	`dr_£löux_ˇŒback
(
˘x
, 
ªtvÆ
);

197 
	}
}

199 
	#PROBE_SEL_WRITE_FUNC
(
func_«me
, 
sour˚_evít
) \

200 
	`SEC
("kprobe/" #func_name) \

201 
k¥obe_
##
	`func_«me
(
±_ªgs
 *
˘x
) { \

202 
fûe
 *fûê(fûê*)
	`PT_REGS_PARM1
(
˘x
); \

203 c⁄° *
buf
 = (c⁄° *)
	`PT_REGS_PARM2
(
˘x
); \

204 
size_t
 
cou¡
 = (size_t)
	`PT_REGS_PARM3
(
˘x
); \

206  
	`h™dÀ_£löux_evít
(
˘x
, 
fûe
, 
buf
, 
cou¡
, (
sour˚_evít
)); \

207 }

	)

209 
	$PROBE_SEL_WRITE_FUNC
(
£l_wrôe_dißbÀ
, 
SELINUX_DISABLE_CHANGE_SOURCE_EVENT
)

210 
	$PROBE_SEL_WRITE_FUNC
(
£l_wrôe_íf‹˚
, 
SELINUX_ENFORCE_CHANGE_SOURCE_EVENT
)

211 
	$PROBE_SEL_WRITE_FUNC
(
£l_wrôe_boﬁ
, 
SELINUX_BOOL_CHANGE_SOURCE_EVENT
)

212 
	$PROBE_SEL_WRITE_FUNC
(
£l_commô_boﬁs_wrôe
, 
SELINUX_BOOL_COMMIT_SOURCE_EVENT
)

	@setattr.h

1 #i‚de‡
_SETATTR_H_


2 
	#_SETATTR_H_


	)

4 
	~"sysˇŒs.h
"

6 
__©åibuã__
((
Æways_ölöe
)Ë
chmod_≠¥ovîs
(
sysˇŒ_ˇche_t
 *
sysˇŒ
);

7 
__©åibuã__
((
Æways_ölöe
)Ë
chown_≠¥ovîs
(
sysˇŒ_ˇche_t
 *
sysˇŒ
);

8 
__©åibuã__
((
Æways_ölöe
)Ë
utime_≠¥ovîs
(
sysˇŒ_ˇche_t
 *
sysˇŒ
);

10 
__©åibuã__
((
Æways_ölöe
)Ë
	$£curôy_öode_¥ediˇã
(
u64
 
ty≥
) {

11  
ty≥
 =
EVENT_UTIME
 ||Åy≥ =
EVENT_CHMOD
 ||Åy≥ =
EVENT_CHOWN
;

12 
	}
}

14 
SEC
("kprobe/security_inode_setattr")

15 
	$k¥obe_£curôy_öode_£èâr
(
±_ªgs
 *
˘x
) {

16 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ_wôh
(
£curôy_öode_¥ediˇã
);

17 i‡(!
sysˇŒ
)

20 
díåy
 *díåy = (díåy *)
	`PT_REGS_PARM1
(
˘x
);

21 
	`fûl_fûe_mëad©a
(
díåy
, &
sysˇŒ
->
£èâr
.
fûe
.
mëad©a
);

23 
üâr
 *üâ∏(üâ∏*)
	`PT_REGS_PARM2
(
˘x
);

24 i‡(
üâr
 !
NULL
) {

25 
vÆid
;

26 
	`bpf_¥obe_ªad
(&
vÆid
, (vÆid), &
üâr
->
ü_vÆid
);

27 i‡(
vÆid
 & 
ATTR_GID
) {

28 
	`bpf_¥obe_ªad
(&
sysˇŒ
->
£èâr
.
group
, (sysˇŒ->£èâr.group), &
üâr
->
ü_gid
);

31 i‡(
vÆid
 & (
ATTR_TOUCH
 | 
ATTR_ATIME_SET
 | 
ATTR_MTIME_SET
)) {

32 i‡(
sysˇŒ
->
£èâr
.
fûe
.
∑th_key
.
öo
) {

35 
	`bpf_¥obe_ªad
(&
sysˇŒ
->
£èâr
.
©ime
, (sysˇŒ->£èâr.©ime), &
üâr
->
ü_©ime
);

36 
	`bpf_¥obe_ªad
(&
sysˇŒ
->
£èâr
.
mtime
, (sysˇŒ->£èâr.mtime), &
üâr
->
ü_mtime
);

40 i‡(
sysˇŒ
->
£èâr
.
fûe
.
∑th_key
.
öo
) {

44 
sysˇŒ
->
£èâr
.
díåy
 = dentry;

47 
	`£t_fûe_öode
(
díåy
, &
sysˇŒ
->
£èâr
.
fûe
, 0);

49 
u64
 
evít_ty≥
 = 0;

50 
sysˇŒ
->
ty≥
) {

51 
EVENT_UTIME
:

52 i‡(
	`fûãr_sysˇŒ
(
sysˇŒ
, 
utime_≠¥ovîs
)) {

53  
	`disˇrd_sysˇŒ
(
sysˇŒ
);

55 
evít_ty≥
 = 
EVENT_UTIME
;

57 
EVENT_CHMOD
:

58 i‡(
	`fûãr_sysˇŒ
(
sysˇŒ
, 
chmod_≠¥ovîs
)) {

59  
	`disˇrd_sysˇŒ
(
sysˇŒ
);

61 
evít_ty≥
 = 
EVENT_CHMOD
;

63 
EVENT_CHOWN
:

64 i‡(
	`fûãr_sysˇŒ
(
sysˇŒ
, 
chown_≠¥ovîs
)) {

65  
	`disˇrd_sysˇŒ
(
sysˇŒ
);

67 
evít_ty≥
 = 
EVENT_CHOWN
;

71 
sysˇŒ
->
ªsﬁvî
.
díåy
 = sysˇŒ->
£èâr
.dentry;

72 
sysˇŒ
->
ªsﬁvî
.
key
 = sysˇŒ->
£èâr
.
fûe
.
∑th_key
;

73 
sysˇŒ
->
ªsﬁvî
.
disˇrdî_ty≥
 = sysˇŒ->
pﬁicy
.
mode
 !
NO_FILTER
 ? 
evít_ty≥
 : 0;

74 
sysˇŒ
->
ªsﬁvî
.
ˇŒback
 = 
DR_SETATTR_CALLBACK_KPROBE_KEY
;

75 
sysˇŒ
->
ªsﬁvî
.
ôî©i⁄
 = 0;

76 
sysˇŒ
->
ªsﬁvî
.
ªt
 = 0;

78 
	`ªsﬁve_díåy
(
˘x
, 
DR_KPROBE
);

80 
	}
}

82 
SEC
("kprobe/dr_setattr_callback")

83 
__©åibuã__
((
Æways_ölöe
)Ë
	$k¥obe_dr_£èâr_ˇŒback
(
±_ªgs
 *
˘x
) {

84 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ_wôh
(
£curôy_öode_¥ediˇã
);

85 i‡(!
sysˇŒ
)

88 i‡(
sysˇŒ
->
ªsﬁvî
.
ªt
 =
DENTRY_DISCARDED
) {

89  
	`disˇrd_sysˇŒ
(
sysˇŒ
);

93 
	}
}

	@setxattr.h

1 #i‚de‡
_SETXATTR_H_


2 
	#_SETXATTR_H_


	)

4 
	~"sysˇŒs.h
"

6 
	s£tx©å_evít_t
 {

7 
kevít_t
 
	mevít
;

8 
¥o˚ss_c⁄ãxt_t
 
	m¥o˚ss
;

9 
•™_c⁄ãxt_t
 
	m•™
;

10 
c⁄èöî_c⁄ãxt_t
 
	mc⁄èöî
;

11 
sysˇŒ_t
 
	msysˇŒ
;

12 
fûe_t
 
	mfûe
;

13 
	m«me
[
MAX_XATTR_NAME_LEN
];

16 
__©åibuã__
((
Æways_ölöe
)Ë
	$åa˚__sys_£tx©å
(c⁄° *
x©å_«me
) {

17 
pﬁicy_t
 
pﬁicy
 = 
	`„tch_pﬁicy
(
EVENT_SETXATTR
);

18 i‡(
	`is_disˇrded_by_¥o˚ss
(
pﬁicy
.
mode
, 
EVENT_SETXATTR
)) {

22 
sysˇŒ_ˇche_t
 
sysˇŒ
 = {

23 .
ty≥
 = 
EVENT_SETXATTR
,

24 .
pﬁicy
 =Öolicy,

25 .
x©å
 = {

26 .
«me
 = 
x©å_«me
,

30 
	`ˇche_sysˇŒ
(&
sysˇŒ
);

33 
	}
}

35 
	$SYSCALL_KPROBE2
(
£tx©å
, c⁄° *, 
fûíame
, c⁄° *, 
«me
) {

36  
	`åa˚__sys_£tx©å
(
«me
);

37 
	}
}

39 
	$SYSCALL_KPROBE2
(
l£tx©å
, c⁄° *, 
fûíame
, c⁄° *, 
«me
) {

40  
	`åa˚__sys_£tx©å
(
«me
);

41 
	}
}

43 
	$SYSCALL_KPROBE2
(
f£tx©å
, , 
fd
, c⁄° *, 
«me
) {

44  
	`åa˚__sys_£tx©å
(
«me
);

45 
	}
}

47 
__©åibuã__
((
Æways_ölöe
)Ë
	$åa˚__sys_ªmovex©å
(c⁄° *
x©å_«me
) {

48 
pﬁicy_t
 
pﬁicy
 = 
	`„tch_pﬁicy
(
EVENT_REMOVEXATTR
);

49 i‡(
	`is_disˇrded_by_¥o˚ss
(
pﬁicy
.
mode
, 
EVENT_REMOVEXATTR
)) {

53 
sysˇŒ_ˇche_t
 
sysˇŒ
 = {

54 .
ty≥
 = 
EVENT_REMOVEXATTR
,

55 .
pﬁicy
 =Öolicy,

56 .
x©å
 = {

57 .
«me
 = 
x©å_«me
,

61 
	`ˇche_sysˇŒ
(&
sysˇŒ
);

64 
	}
}

66 
	$SYSCALL_KPROBE2
(
ªmovex©å
, c⁄° *, 
fûíame
, c⁄° *, 
«me
) {

67  
	`åa˚__sys_ªmovex©å
(
«me
);

68 
	}
}

70 
	$SYSCALL_KPROBE2
(
Ãemovex©å
, c⁄° *, 
fûíame
, c⁄° *, 
«me
) {

71  
	`åa˚__sys_ªmovex©å
(
«me
);

72 
	}
}

74 
	$SYSCALL_KPROBE2
(
‰emovex©å
, , 
fd
, c⁄° *, 
«me
) {

75  
	`åa˚__sys_ªmovex©å
(
«me
);

76 
	}
}

78 
__©åibuã__
((
Æways_ölöe
)Ë
	$åa˚__vfs_£tx©å
(
±_ªgs
 *
˘x
, 
u64
 
evít_ty≥
) {

79 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
evít_ty≥
);

80 i‡(!
sysˇŒ
)

83 i‡(
sysˇŒ
->
x©å
.
fûe
.
∑th_key
.
öo
) {

87 
sysˇŒ
->
x©å
.
díåy
 = (díåy *)
	`PT_REGS_PARM1
(
˘x
);

89 i‡((
evít_ty≥
 =
EVENT_SETXATTR
 && 
	`gë_vfs_£tx©å_díåy_posôi⁄
(Ë=
VFS_ARG_POSITION2
) ||

90 (
evít_ty≥
 =
EVENT_REMOVEXATTR
 && 
	`gë_vfs_ªmovex©å_díåy_posôi⁄
(Ë=
VFS_ARG_POSITION2
)) {

92 
	`bpf_¥obe_ªad
(&
sysˇŒ
->
x©å
.
díåy
, (syscall->xattr.dentry), &syscall->xattr.dentry);

93 
sysˇŒ
->
x©å
.
díåy
 = (díåy *Ë
	`PT_REGS_PARM2
(
˘x
);

96 
	`£t_fûe_öode
(
sysˇŒ
->
x©å
.
díåy
, &sysˇŒ->x©å.
fûe
, 0);

99 
sysˇŒ
->
ªsﬁvî
.
díåy
 = sysˇŒ->
x©å
.dentry;

100 
sysˇŒ
->
ªsﬁvî
.
key
 = sysˇŒ->
x©å
.
fûe
.
∑th_key
;

101 
sysˇŒ
->
ªsﬁvî
.
disˇrdî_ty≥
 = sysˇŒ->
pﬁicy
.
mode
 !
NO_FILTER
 ? 
evít_ty≥
 : 0;

102 
sysˇŒ
->
ªsﬁvî
.
ˇŒback
 = 
DR_SETXATTR_CALLBACK_KPROBE_KEY
;

103 
sysˇŒ
->
ªsﬁvî
.
ôî©i⁄
 = 0;

104 
sysˇŒ
->
ªsﬁvî
.
ªt
 = 0;

106 
	`ªsﬁve_díåy
(
˘x
, 
DR_KPROBE
);

108 
	}
}

110 
__©åibuã__
((
Æways_ölöe
)Ë
	$x©å_¥ediˇã
(
u64
 
ty≥
) {

111  
ty≥
 =
EVENT_SETXATTR
 ||Åy≥ =
EVENT_REMOVEXATTR
;

112 
	}
}

114 
SEC
("kprobe/dr_setxattr_callback")

115 
__©åibuã__
((
Æways_ölöe
)Ë
	$k¥obe_dr_£tx©å_ˇŒback
(
±_ªgs
 *
˘x
) {

116 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ_wôh
(
x©å_¥ediˇã
);

117 i‡(!
sysˇŒ
)

120 i‡(
sysˇŒ
->
ªsﬁvî
.
ªt
 =
DENTRY_DISCARDED
) {

121  
	`disˇrd_sysˇŒ
(
sysˇŒ
);

125 
	}
}

127 
SEC
("kprobe/vfs_setxattr")

128 
	$k¥obe_vfs_£tx©å
(
±_ªgs
 *
˘x
) {

129  
	`åa˚__vfs_£tx©å
(
˘x
, 
EVENT_SETXATTR
);

130 
	}
}

132 
SEC
("kprobe/vfs_removexattr")

133 
	$k¥obe_vfs_ªmovex©å
(
±_ªgs
 *
˘x
) {

134  
	`åa˚__vfs_£tx©å
(
˘x
, 
EVENT_REMOVEXATTR
);

135 
	}
}

137 
__©åibuã__
((
Æways_ölöe
)Ë
	$sys_x©å_ªt
(*
˘x
, 
ªtvÆ
, 
u64
 
evít_ty≥
) {

138 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`p›_sysˇŒ
(
evít_ty≥
);

139 i‡(!
sysˇŒ
)

142 i‡(
	`IS_UNHANDLED_ERROR
(
ªtvÆ
))

145 
£tx©å_evít_t
 
evít
 = {

146 .
sysˇŒ
.
ªtvÆ
 =Ñetval,

147 .
fûe
 = 
sysˇŒ
->
x©å
.file,

151 
	`bpf_¥obe_ªad_°r
(&
evít
.
«me
, 
MAX_XATTR_NAME_LEN
, (*Ë
sysˇŒ
->
x©å
.name);

153 
¥oc_ˇche_t
 *
íåy
 = 
	`fûl_¥o˚ss_c⁄ãxt
(&
evít
.
¥o˚ss
);

154 
	`fûl_c⁄èöî_c⁄ãxt
(
íåy
, &
evít
.
c⁄èöî
);

155 
	`fûl_fûe_mëad©a
(
sysˇŒ
->
x©å
.
díåy
, &
evít
.
fûe
.
mëad©a
);

156 
	`fûl_•™_c⁄ãxt
(&
evít
.
•™
);

158 
	`£nd_evít
(
˘x
, 
evít_ty≥
, 
evít
);

161 
	}
}

163 
__©åibuã__
((
Æways_ölöe
)Ë
	$k¥obe_sys_£tx©å_ªt
(
±_ªgs
 *
˘x
) {

164 
ªtvÆ
 = 
	`PT_REGS_RC
(
˘x
);

165  
	`sys_x©å_ªt
(
˘x
, 
ªtvÆ
, 
EVENT_SETXATTR
);

166 
	}
}

168 
SEC
("tracepoint/syscalls/sys_exit_setxattr")

169 
	$åa˚poöt_sysˇŒs_sys_exô_£tx©å
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

170  
	`sys_x©å_ªt
(
¨gs
,árgs->
ªt
, 
EVENT_SETXATTR
);

171 
	}
}

173 
	$SYSCALL_KRETPROBE
(
£tx©å
) {

174  
	`k¥obe_sys_£tx©å_ªt
(
˘x
);

175 
	}
}

177 
SEC
("tracepoint/syscalls/sys_exit_fsetxattr")

178 
	$åa˚poöt_sysˇŒs_sys_exô_f£tx©å
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

179  
	`sys_x©å_ªt
(
¨gs
,árgs->
ªt
, 
EVENT_SETXATTR
);

180 
	}
}

182 
	$SYSCALL_KRETPROBE
(
f£tx©å
) {

183  
	`k¥obe_sys_£tx©å_ªt
(
˘x
);

184 
	}
}

186 
SEC
("tracepoint/syscalls/sys_exit_lsetxattr")

187 
	$åa˚poöt_sysˇŒs_sys_exô_l£tx©å
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

188  
	`sys_x©å_ªt
(
¨gs
,árgs->
ªt
, 
EVENT_SETXATTR
);

189 
	}
}

191 
	$SYSCALL_KRETPROBE
(
l£tx©å
) {

192  
	`k¥obe_sys_£tx©å_ªt
(
˘x
);

193 
	}
}

195 
SEC
("tracepoint/handle_sys_setxattr_exit")

196 
	$åa˚poöt_h™dÀ_sys_£tx©å_exô
(
åa˚poöt_øw_sysˇŒs_sys_exô_t
 *
¨gs
) {

197  
	`sys_x©å_ªt
(
¨gs
,árgs->
ªt
, 
EVENT_SETXATTR
);

198 
	}
}

200 
__©åibuã__
((
Æways_ölöe
)Ë
	$k¥obe_sys_ªmovex©å_ªt
(
±_ªgs
 *
˘x
) {

201 
ªtvÆ
 = 
	`PT_REGS_RC
(
˘x
);

202  
	`sys_x©å_ªt
(
˘x
, 
ªtvÆ
, 
EVENT_REMOVEXATTR
);

203 
	}
}

205 
SEC
("tracepoint/syscalls/sys_exit_removexattr")

206 
	$åa˚poöt_sysˇŒs_sys_exô_ªmovex©å
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

207  
	`sys_x©å_ªt
(
¨gs
,árgs->
ªt
, 
EVENT_REMOVEXATTR
);

208 
	}
}

210 
	$SYSCALL_KRETPROBE
(
ªmovex©å
) {

211  
	`k¥obe_sys_ªmovex©å_ªt
(
˘x
);

212 
	}
}

214 
SEC
("tracepoint/syscalls/sys_exit_lremovexattr")

215 
	$åa˚poöt_sysˇŒs_sys_exô_Ãemovex©å
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

216  
	`sys_x©å_ªt
(
¨gs
,árgs->
ªt
, 
EVENT_REMOVEXATTR
);

217 
	}
}

219 
	$SYSCALL_KRETPROBE
(
Ãemovex©å
) {

220  
	`k¥obe_sys_ªmovex©å_ªt
(
˘x
);

221 
	}
}

223 
SEC
("tracepoint/syscalls/sys_exit_fremovexattr")

224 
	$åa˚poöt_sysˇŒs_sys_exô_‰emovex©å
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

225  
	`sys_x©å_ªt
(
¨gs
,árgs->
ªt
, 
EVENT_REMOVEXATTR
);

226 
	}
}

228 
	$SYSCALL_KRETPROBE
(
‰emovex©å
) {

229  
	`k¥obe_sys_ªmovex©å_ªt
(
˘x
);

230 
	}
}

232 
SEC
("tracepoint/handle_sys_removexattr_exit")

233 
	$åa˚poöt_h™dÀ_sys_ªmovex©å_exô
(
åa˚poöt_øw_sysˇŒs_sys_exô_t
 *
¨gs
) {

234  
	`sys_x©å_ªt
(
¨gs
,árgs->
ªt
, 
EVENT_REMOVEXATTR
);

235 
	}
}

	@signal.h

1 #i‚de‡
_SIGNAL_H_


2 
	#_SIGNAL_H_


	)

4 
	ssig«l_evít_t
 {

5 
kevít_t
 
	mevít
;

6 
¥o˚ss_c⁄ãxt_t
 
	m¥o˚ss
;

7 
•™_c⁄ãxt_t
 
	m•™
;

8 
c⁄èöî_c⁄ãxt_t
 
	mc⁄èöî
;

9 
sysˇŒ_t
 
	msysˇŒ
;

11 
u32
 
	mpid
;

12 
u32
 
	mty≥
;

15 
	$SYSCALL_KPROBE2
(
kûl
, , 
pid
, , 
ty≥
) {

16 
pﬁicy_t
 
pﬁicy
 = 
	`„tch_pﬁicy
(
EVENT_SIGNAL
);

17 i‡(
	`is_disˇrded_by_¥o˚ss
(
pﬁicy
.
mode
, 
EVENT_SIGNAL
)) {

22 i‡(
pid
 < 1)

27 
u32
 
roŸ_ƒ
 = 
	`gë_roŸ_ƒ
((u32)
pid
);

28 i‡(!
roŸ_ƒ
)

29 
roŸ_ƒ
 = 
pid
;

32 
sysˇŒ_ˇche_t
 
sysˇŒ
 = {

33 .
ty≥
 = 
EVENT_SIGNAL
,

34 .
sig«l
 = {

35 .
pid
 = 
roŸ_ƒ
,

36 .
ty≥
 =Åype,

39 
	`ˇche_sysˇŒ
(&
sysˇŒ
);

41 
	}
}

44 
SEC
("kretprobe/check_kill_permission")

45 
	$kªçrobe_check_kûl_≥rmissi⁄
(
±_ªgs
* 
˘x
) {

46 
ªtvÆ
 = ()
	`PT_REGS_RC
(
˘x
);

48 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`p›_sysˇŒ
(
EVENT_SIGNAL
);

49 i‡(!
sysˇŒ
) {

54 i‡(
	`IS_UNHANDLED_ERROR
(
ªtvÆ
))

58 
sig«l_evít_t
 
evít
 = {

59 .
sysˇŒ
.
ªtvÆ
 =Ñetval,

60 .
pid
 = 
sysˇŒ
->
sig«l
.pid,

61 .
ty≥
 = 
sysˇŒ
->
sig«l
.type,

63 
¥oc_ˇche_t
 *
íåy
 = 
	`fûl_¥o˚ss_c⁄ãxt
(&
evít
.
¥o˚ss
);

64 
	`fûl_c⁄èöî_c⁄ãxt
(
íåy
, &
evít
.
c⁄èöî
);

65 
	`fûl_•™_c⁄ãxt
(&
evít
.
•™
);

66 
	`£nd_evít
(
˘x
, 
EVENT_SIGNAL
, 
evít
);

68 
	}
}

	@span.h

1 #i‚de‡
_SPAN_H_


2 
	#_SPAN_H_


	)

4 
	~"defs.h
"

6 
	eés_f‹m©
 {

7 
	mDEFAULT


10 
	s•™_és_t
 {

11 
u64
 
	mf‹m©
;

12 
u64
 
	mmax_thªads
;

13 *
	mba£
;

16 
bpf_m≠_def
 
SEC
("m≠s/•™_és"Ë
	g•™_és
 = {

17 .
ty≥
 = 
BPF_MAP_TYPE_LRU_HASH
,

18 .
	gkey_size
 = (
u32
),

19 .
	gvÆue_size
 = (
•™_és_t
),

20 .
	gmax_íåõs
 = 4096,

21 .
	gpönög
 = 0,

22 .
	g«me•a˚
 = "",

26 
u32
 
gë_«me•a˚_ƒ
(u32 
roŸ_ƒ
);

28 
__©åibuã__
((
Æways_ölöe
)Ë
	$h™dÀ_ªgi°î_•™_mem‹y
(*
d©a
) {

29 
•™_és_t
 
és
 = {};

30 
	`bpf_¥obe_ªad
(&
és
, —ls), 
d©a
);

32 
u64
 
pid_tgid
 = 
	`bpf_gë_cuºít_pid_tgid
();

33 
u32
 
tgid
 = 
pid_tgid
 >> 32;

35 
	`bpf_m≠_upd©e_ñem
(&
•™_és
, &
tgid
, &
és
, 
BPF_NOEXIST
);

38 
	}
}

40 
__©åibuã__
((
Æways_ölöe
)Ë
	$uƒegi°î_•™_mem‹y
() {

41 
u64
 
pid_tgid
 = 
	`bpf_gë_cuºít_pid_tgid
();

42 
u32
 
tgid
 = 
pid_tgid
 >> 32;

44 
	`bpf_m≠_dñëe_ñem
(&
•™_és
, &
tgid
);

47 
	}
}

49 
__©åibuã__
((
Æways_ölöe
)Ë
	$fûl_•™_c⁄ãxt
(
•™_c⁄ãxt_t
 *
•™
) {

50 
u64
 
pid_tgid
 = 
	`bpf_gë_cuºít_pid_tgid
();

51 
u32
 
tgid
 = 
pid_tgid
 >> 32;

53 
•™_és_t
 *
és
 = 
	`bpf_m≠_lookup_ñem
(&
•™_és
, &
tgid
);

54 i‡(
és
) {

55 
u32
 
tid
 = 
pid_tgid
;

57 
u32
 
pid
 = 
	`gë_«me•a˚_ƒ
(
tid
);

58 i‡(
pid
) {

59 
tid
 = 
pid
;

62 
off£t
 = (
tid
 % 
és
->
max_thªads
Ë* (
•™_c⁄ãxt_t
);

63 
ªt
 = 
	`bpf_¥obe_ªad
(
•™
, (
•™_c⁄ãxt_t
), 
és
->
ba£
 + 
off£t
);

64 i‡(
ªt
 < 0) {

65 
•™
->
•™_id
 = 0;

66 
•™
->
åa˚_id
 = 0;

69 
	}
}

71 
__©åibuã__
((
Æways_ölöe
)Ë
	$c›y_•™_c⁄ãxt
(
•™_c⁄ãxt_t
 *
§c
, •™_c⁄ãxt_à*
d°
) {

72 
d°
->
•™_id
 = 
§c
->span_id;

73 
d°
->
åa˚_id
 = 
§c
->trace_id;

74 
	}
}

	@syscalls.h

1 #i‚de‡
_SYSCALLS_H_


2 
	#_SYSCALLS_H_


	)

4 
	~"fûãrs.h
"

5 
	~"¥o˚ss.h
"

6 
	~"bpf_c⁄°.h
"

8 
	#FSTYPE_LEN
 16

	)

10 
	s°r_¨øy_ªf_t
 {

11 
u32
 
	mid
;

12 
u8
 
	mödex
;

13 
u8
 
	måunˇãd
;

14 c⁄° **
	m¨øy
;

17 
	sdíåy_ªsﬁvî_öput_t
 {

18 
∑th_key_t
 
	mkey
;

19 
díåy
 *
	mdíåy
;

20 
u64
 
	mdisˇrdî_ty≥
;

21 
	mˇŒback
;

22 
	mªt
;

23 
	môî©i⁄
;

26 
	u£löux_wrôe_∑ylﬂd_t
 {

28 
u32
 
	mboﬁ_vÆue
;

30 
u16
 
	mdißbÀ_vÆue
;

31 
u16
 
	míf‹˚_vÆue
;

32 } 
	m°©us
;

35 
	ssysˇŒ_ˇche_t
 {

36 
pﬁicy_t
 
	mpﬁicy
;

37 
u64
 
	mty≥
;

38 
u32
 
	mdisˇrded
;

40 
díåy_ªsﬁvî_öput_t
 
	mªsﬁvî
;

44 
	mÊags
;

45 
umode_t
 
	mmode
;

46 
díåy
 *
	mdíåy
;

47 
fûe_t
 
	mfûe
;

48 } 
	m›í
;

51 
umode_t
 
	mmode
;

52 
díåy
 *
	mdíåy
;

53 
∑th
 *
	m∑th
;

54 
fûe_t
 
	mfûe
;

55 } 
	mmkdú
;

58 
díåy
 *
	mdíåy
;

59 
fûe_t
 
	mfûe
;

60 
	mÊags
;

61 } 
	mu∆ök
;

64 
díåy
 *
	mdíåy
;

65 
fûe_t
 
	mfûe
;

66 } 
	mrmdú
;

69 
fûe_t
 
	m§c_fûe
;

70 
	m§c_öode
;

71 
díåy
 *
	m§c_díåy
;

72 
díåy
 *
	mèrgë_díåy
;

73 
fûe_t
 
	mèrgë_fûe
;

74 } 
	mª«me
;

77 
díåy
 *
	mdíåy
;

78 
∑th
 *
	m∑th
;

79 
fûe_t
 
	mfûe
;

81 
umode_t
 
	mmode
;

83 
uid_t
 
	mu£r
;

84 
gid_t
 
	mgroup
;

87 
ktimevÆ
 
	m©ime
;

88 
ktimevÆ
 
	mmtime
;

91 } 
	m£èâr
;

94 
mou¡
 *
	m§c_m¡
;

95 
mou¡
 *
	mde°_m¡
;

96 
mou¡poöt
 *
	mde°_mou¡poöt
;

97 
∑th_key_t
 
	mroŸ_key
;

98 
∑th_key_t
 
	m∑th_key
;

99 c⁄° *
	mf°y≥
;

100 } 
	mmou¡
;

103 
vfsmou¡
 *
	mvfs
;

104 } 
	mumou¡
;

107 
fûe_t
 
	m§c_fûe
;

108 
∑th
 *
	mèrgë_∑th
;

109 
díåy
 *
	m§c_díåy
;

110 
díåy
 *
	mèrgë_díåy
;

111 
fûe_t
 
	mèrgë_fûe
;

112 } 
	mlök
;

115 
díåy
 *
	mdíåy
;

116 
fûe_t
 
	mfûe
;

117 c⁄° *
	m«me
;

118 } 
	mx©å
;

121 
díåy
 *
	mdíåy
;

122 
fûe_t
 
	mfûe
;

123 
°r_¨øy_ªf_t
 
	m¨gs
;

124 
°r_¨øy_ªf_t
 
	mívs
;

125 
•™_c⁄ãxt_t
 
	m•™_c⁄ãxt
;

126 
u32
 
	m√xt_èû
;

127 
u8
 
	mis_∑r£d
;

128 } 
	mexec
;

131 
u32
 
	mis_thªad
;

132 
pid
 *
	mpid
;

133 } 
	mf‹k
;

136 
díåy
 *
	mdíåy
;

137 
fûe_t
 
	mfûe
;

138 
u32
 
	mevít_köd
;

139 
£löux_wrôe_∑ylﬂd_t
 
	m∑ylﬂd
;

140 } 
	m£löux
;

143 
	mcmd
;

144 
u32
 
	mm≠_id
;

145 
u32
 
	m¥og_id
;

146 
	mªtvÆ
;

147 
u64
 
	mhñ≥rs
[3];

148 
bpf_©å_def
 *
	m©å
;

149 } 
	mbpf
;

152 
u32
 
	mªque°
;

153 
u32
 
	mpid
;

154 
u64
 
	maddr
;

155 } 
	m±ø˚
;

158 
u64
 
	moff£t
;

159 
u32
 
	mÀn
;

160 
	m¥Ÿe˘i⁄
;

161 
	mÊags
;

162 
fûe_t
 
	mfûe
;

163 
díåy
 *
	mdíåy
;

164 } 
	mmm≠
;

167 
u64
 
	mvm_°¨t
;

168 
u64
 
	mvm_íd
;

169 
u64
 
	mvm_¥Ÿe˘i⁄
;

170 
u64
 
	mªq_¥Ÿe˘i⁄
;

171 } 
	mm¥Ÿe˘
;

174 
u32
 
	mpid
;

175 
u32
 
	mty≥
;

176 } 
	msig«l
;

180 
bpf_m≠_def
 
SEC
("m≠s/sysˇŒs"Ë
	gsysˇŒs
 = {

181 .
ty≥
 = 
BPF_MAP_TYPE_LRU_HASH
,

182 .
	gkey_size
 = (
u64
),

183 .
	gvÆue_size
 = (
sysˇŒ_ˇche_t
),

184 .
	gmax_íåõs
 = 1024,

185 .
	gpönög
 = 0,

186 .
	g«me•a˚
 = "",

189 
pﬁicy_t
 
__©åibuã__
((
Æways_ölöe
)Ë
	$„tch_pﬁicy
(
u64
 
evít_ty≥
) {

190 
pﬁicy_t
 *
pﬁicy
 = 
	`bpf_m≠_lookup_ñem
(&
fûãr_pﬁicy
, &
evít_ty≥
);

191 i‡(
pﬁicy
) {

192  *
pﬁicy
;

194 
pﬁicy_t
 
em±y_pﬁicy
 = { };

195  
em±y_pﬁicy
;

196 
	}
}

199 
__©åibuã__
((
Æways_ölöe
)Ë
	$ˇche_sysˇŒ
(
sysˇŒ_ˇche_t
 *
sysˇŒ
) {

200 
u64
 
key
 = 
	`bpf_gë_cuºít_pid_tgid
();

201 
	`bpf_m≠_upd©e_ñem
(&
sysˇŒs
, &
key
, 
sysˇŒ
, 
BPF_ANY
);

202 
	}
}

204 
sysˇŒ_ˇche_t
 * 
__©åibuã__
((
Æways_ölöe
)Ë
	$≥ek_sysˇŒ
(
u64
 
ty≥
) {

205 
u64
 
key
 = 
	`bpf_gë_cuºít_pid_tgid
();

206 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = (sysˇŒ_ˇche_à*Ë
	`bpf_m≠_lookup_ñem
(&
sysˇŒs
, &
key
);

207 i‡(!
sysˇŒ
) {

208  
NULL
;

210 i‡(!
ty≥
 || 
sysˇŒ
->type ==Åype) {

211  
sysˇŒ
;

213  
NULL
;

214 
	}
}

216 
sysˇŒ_ˇche_t
 * 
__©åibuã__
((
Æways_ölöe
)Ë
≥ek_sysˇŒ_wôh
((*
¥ediˇã
)(
u64
 
ty≥
)) {

217 
u64
 
key
 = 
	`bpf_gë_cuºít_pid_tgid
();

218 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = (sysˇŒ_ˇche_à*Ë
	`bpf_m≠_lookup_ñem
(&
sysˇŒs
, &
key
);

219 i‡(!
sysˇŒ
) {

220  
NULL
;

222 i‡(
	`¥ediˇã
(
sysˇŒ
->
ty≥
)) {

223  
sysˇŒ
;

225  
NULL
;

226 
	}
}

228 
sysˇŒ_ˇche_t
 * 
__©åibuã__
((
Æways_ölöe
)Ë
p›_sysˇŒ_wôh
((*
¥ediˇã
)(
u64
 
ty≥
)) {

229 
u64
 
key
 = 
	`bpf_gë_cuºít_pid_tgid
();

230 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = (sysˇŒ_ˇche_à*Ë
	`bpf_m≠_lookup_ñem
(&
sysˇŒs
, &
key
);

231 i‡(!
sysˇŒ
) {

232  
NULL
;

234 i‡(
	`¥ediˇã
(
sysˇŒ
->
ty≥
)) {

235 
	`bpf_m≠_dñëe_ñem
(&
sysˇŒs
, &
key
);

236  
sysˇŒ
;

238  
NULL
;

239 
	}
}

241 
sysˇŒ_ˇche_t
 * 
__©åibuã__
((
Æways_ölöe
)Ë
	$p›_sysˇŒ
(
u64
 
ty≥
) {

242 
u64
 
key
 = 
	`bpf_gë_cuºít_pid_tgid
();

243 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = (sysˇŒ_ˇche_à*Ë
	`bpf_m≠_lookup_ñem
(&
sysˇŒs
, &
key
);

244 i‡(!
sysˇŒ
) {

245  
NULL
;

247 i‡(!
ty≥
 || 
sysˇŒ
->type ==Åype) {

248 
	`bpf_m≠_dñëe_ñem
(&
sysˇŒs
, &
key
);

249  
sysˇŒ
;

251  
NULL
;

252 
	}
}

254 
__©åibuã__
((
Æways_ölöe
)Ë
	$disˇrd_sysˇŒ
(
sysˇŒ_ˇche_t
 *
sysˇŒ
) {

255 
u64
 
key
 = 
	`bpf_gë_cuºít_pid_tgid
();

256 
	`bpf_m≠_dñëe_ñem
(&
sysˇŒs
, &
key
);

258 
	}
}

260 
__©åibuã__
((
Æways_ölöe
)Ë
	$m¨k_as_disˇrded
(
sysˇŒ_ˇche_t
 *
sysˇŒ
) {

261 
sysˇŒ
->
disˇrded
 = 1;

263 
	}
}

265 
__©åibuã__
((
Æways_ölöe
)Ë
fûãr_sysˇŒ
(
sysˇŒ_ˇche_t
 *
sysˇŒ
, (*
check_≠¥ovîs
)(syscall_cache_t *syscall)) {

266 i‡(
sysˇŒ
->
pﬁicy
.
mode
 =
NO_FILTER
)

269 
∑ss_to_u£r•a˚
 = 
sysˇŒ
->
pﬁicy
.
mode
 =
ACCEPT
 ? 1 : 0;

271 i‡(
sysˇŒ
->
pﬁicy
.
mode
 =
DENY
) {

272 
∑ss_to_u£r•a˚
 = 
	`check_≠¥ovîs
(
sysˇŒ
);

275  !
∑ss_to_u£r•a˚
;

276 
	}
}

	@umount.h

1 #i‚de‡
_UMOUNT_H_


2 
	#_UMOUNT_H_


	)

4 
	~"sysˇŒs.h
"

6 
	sumou¡_evít_t
 {

7 
kevít_t
 
	mevít
;

8 
¥o˚ss_c⁄ãxt_t
 
	m¥o˚ss
;

9 
•™_c⁄ãxt_t
 
	m•™
;

10 
c⁄èöî_c⁄ãxt_t
 
	mc⁄èöî
;

11 
sysˇŒ_t
 
	msysˇŒ
;

12 
u32
 
	mmou¡_id
;

15 
	$SYSCALL_KPROBE0
(
umou¡
) {

17 
	}
}

19 
SEC
("kprobe/security_sb_umount")

20 
	$k¥obe_£curôy_sb_umou¡
(
±_ªgs
 *
˘x
) {

21 
sysˇŒ_ˇche_t
 
sysˇŒ
 = {

22 .
ty≥
 = 
EVENT_UMOUNT
,

23 .
umou¡
 = {

24 .
vfs
 = (
vfsmou¡
 *)
	`PT_REGS_PARM1
(
˘x
),

28 
	`ˇche_sysˇŒ
(&
sysˇŒ
);

30 
	}
}

32 
__©åibuã__
((
Æways_ölöe
)Ë
	$sys_umou¡_ªt
(*
˘x
, 
ªtvÆ
) {

33 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`p›_sysˇŒ
(
EVENT_UMOUNT
);

34 i‡(!
sysˇŒ
)

37 i‡(
ªtvÆ
)

40 
mou¡_id
 = 
	`gë_vfsmou¡_mou¡_id
(
sysˇŒ
->
umou¡
.
vfs
);

42 
umou¡_evít_t
 
evít
 = {

43 .
sysˇŒ
 .
ªtvÆ
 =Ñetval,

44 .
mou¡_id
 = mount_id

47 
¥oc_ˇche_t
 *
íåy
 = 
	`fûl_¥o˚ss_c⁄ãxt
(&
evít
.
¥o˚ss
);

48 
	`fûl_c⁄èöî_c⁄ãxt
(
íåy
, &
evít
.
c⁄èöî
);

49 
	`fûl_•™_c⁄ãxt
(&
evít
.
•™
);

51 
	`£nd_evít
(
˘x
, 
EVENT_UMOUNT
, 
evít
);

53 
	`umou¡ed
(
˘x
, 
mou¡_id
);

56 
	}
}

58 
SEC
("tracepoint/syscalls/sys_exit_umount")

59 
	$åa˚poöt_sysˇŒs_sys_exô_umou¡
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

60  
	`sys_umou¡_ªt
(
¨gs
,árgs->
ªt
);

61 
	}
}

63 
	$SYSCALL_KRETPROBE
(
umou¡
) {

64 
ªtvÆ
 = 
	`PT_REGS_RC
(
˘x
);

65  
	`sys_umou¡_ªt
(
˘x
, 
ªtvÆ
);

66 
	}
}

68 
SEC
("tracepoint/handle_sys_umount_exit")

69 
	$åa˚poöt_h™dÀ_sys_umou¡_exô
(
åa˚poöt_øw_sysˇŒs_sys_exô_t
 *
¨gs
) {

70  
	`sys_umou¡_ªt
(
¨gs
,árgs->
ªt
);

71 
	}
}

	@unlink.h

1 #i‚de‡
_UNLINK_H_


2 
	#_UNLINK_H_


	)

4 
	~"sysˇŒs.h
"

5 
	~"¥o˚ss.h
"

7 
	su∆ök_evít_t
 {

8 
kevít_t
 
	mevít
;

9 
¥o˚ss_c⁄ãxt_t
 
	m¥o˚ss
;

10 
•™_c⁄ãxt_t
 
	m•™
;

11 
c⁄èöî_c⁄ãxt_t
 
	mc⁄èöî
;

12 
sysˇŒ_t
 
	msysˇŒ
;

13 
fûe_t
 
	mfûe
;

14 
u32
 
	mÊags
;

15 
u32
 
	m∑ddög
;

18 
__©åibuã__
((
Æways_ölöe
)Ë
	$u∆ök_≠¥ovîs
(
sysˇŒ_ˇche_t
 *
sysˇŒ
) {

19  
	`ba£«me_≠¥ovî
(
sysˇŒ
, sysˇŒ->
u∆ök
.
díåy
, 
EVENT_UNLINK
);

20 
	}
}

22 
__©åibuã__
((
Æways_ölöe
)Ë
	$åa˚__sys_u∆ök
(
Êags
) {

23 
sysˇŒ_ˇche_t
 
sysˇŒ
 = {

24 .
ty≥
 = 
EVENT_UNLINK
,

25 .
pﬁicy
 = 
	`„tch_pﬁicy
(
EVENT_UNLINK
),

26 .
u∆ök
 = {

27 .
Êags
 = flags,

31 
	`ˇche_sysˇŒ
(&
sysˇŒ
);

34 
	}
}

36 
	$SYSCALL_KPROBE0
(
u∆ök
) {

37  
	`åa˚__sys_u∆ök
(0);

38 
	}
}

40 
	$SYSCALL_KPROBE3
(
u∆ök©
, , 
dúfd
, c⁄° *, 
fûíame
, , 
Êags
) {

41  
	`åa˚__sys_u∆ök
(
Êags
);

42 
	}
}

44 
SEC
("kprobe/vfs_unlink")

45 
	$k¥obe_vfs_u∆ök
(
±_ªgs
 *
˘x
) {

46 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
EVENT_UNLINK
);

47 i‡(!
sysˇŒ
)

50 i‡(
sysˇŒ
->
u∆ök
.
fûe
.
∑th_key
.
öo
) {

54 
díåy
 *díåy = (díåy *Ë
	`PT_REGS_PARM2
(
˘x
);

56 i‡(
	`gë_vfs_u∆ök_díåy_posôi⁄
(Ë=
VFS_ARG_POSITION3
) {

58 
	`bpf_¥obe_ªad
(&
díåy
, (dentry), &dentry);

59 
díåy
 = (díåy *Ë
	`PT_REGS_PARM3
(
˘x
);

63 
sysˇŒ
->
u∆ök
.
díåy
 = dentry;

64 
	`£t_fûe_öode
(
díåy
, &
sysˇŒ
->
u∆ök
.
fûe
, 1);

65 
	`fûl_fûe_mëad©a
(
díåy
, &
sysˇŒ
->
u∆ök
.
fûe
.
mëad©a
);

67 i‡(
	`fûãr_sysˇŒ
(
sysˇŒ
, 
u∆ök_≠¥ovîs
)) {

68  
	`m¨k_as_disˇrded
(
sysˇŒ
);

71 i‡(
	`is_disˇrded_by_¥o˚ss
(
sysˇŒ
->
pﬁicy
.
mode
, 
EVENT_UNLINK
)) {

72  
	`m¨k_as_disˇrded
(
sysˇŒ
);

76 
sysˇŒ
->
ªsﬁvî
.
díåy
 = dentry;

77 
sysˇŒ
->
ªsﬁvî
.
key
 = sysˇŒ->
u∆ök
.
fûe
.
∑th_key
;

78 
sysˇŒ
->
ªsﬁvî
.
disˇrdî_ty≥
 = sysˇŒ->
pﬁicy
.
mode
 !
NO_FILTER
 ? 
EVENT_UNLINK
 : 0;

79 
sysˇŒ
->
ªsﬁvî
.
ˇŒback
 = 
DR_UNLINK_CALLBACK_KPROBE_KEY
;

80 
sysˇŒ
->
ªsﬁvî
.
ôî©i⁄
 = 0;

81 
sysˇŒ
->
ªsﬁvî
.
ªt
 = 0;

83 
	`ªsﬁve_díåy
(
˘x
, 
DR_KPROBE
);

85 
	}
}

87 
SEC
("kprobe/dr_unlink_callback")

88 
__©åibuã__
((
Æways_ölöe
)Ë
	$k¥obe_dr_u∆ök_ˇŒback
(
±_ªgs
 *
˘x
) {

89 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`≥ek_sysˇŒ
(
EVENT_UNLINK
);

90 i‡(!
sysˇŒ
)

93 i‡(
sysˇŒ
->
ªsﬁvî
.
ªt
 < 0) {

94  
	`m¨k_as_disˇrded
(
sysˇŒ
);

98 
	}
}

100 
__©åibuã__
((
Æways_ölöe
)Ë
	$sys_u∆ök_ªt
(*
˘x
, 
ªtvÆ
) {

101 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`p›_sysˇŒ
(
EVENT_UNLINK
);

102 i‡(!
sysˇŒ
)

105 i‡(
	`IS_UNHANDLED_ERROR
(
ªtvÆ
)) {

109 
u64
 
íabÀd_evíts
 = 
	`gë_íabÀd_evíts
();

110 
∑ss_to_u£r•a˚
 = !
sysˇŒ
->
disˇrded
 &&

111 (
	`mask_has_evít
(
íabÀd_evíts
, 
EVENT_UNLINK
) ||

112 
	`mask_has_evít
(
íabÀd_evíts
, 
EVENT_RMDIR
));

113 i‡(
∑ss_to_u£r•a˚
) {

114 i‡(
sysˇŒ
->
u∆ök
.
Êags
 & 
AT_REMOVEDIR
) {

115 
rmdú_evít_t
 
evít
 = {

116 .
sysˇŒ
.
ªtvÆ
 =Ñetval,

117 .
fûe
 = 
sysˇŒ
->
u∆ök
.file,

120 
¥oc_ˇche_t
 *
íåy
 = 
	`fûl_¥o˚ss_c⁄ãxt
(&
evít
.
¥o˚ss
);

121 
	`fûl_c⁄èöî_c⁄ãxt
(
íåy
, &
evít
.
c⁄èöî
);

122 
	`fûl_•™_c⁄ãxt
(&
evít
.
•™
);

124 
	`£nd_evít
(
˘x
, 
EVENT_RMDIR
, 
evít
);

126 
u∆ök_evít_t
 
evít
 = {

127 .
sysˇŒ
.
ªtvÆ
 =Ñetval,

128 .
fûe
 = 
sysˇŒ
->
u∆ök
.file,

129 .
Êags
 = 
sysˇŒ
->
u∆ök
.flags,

132 
¥oc_ˇche_t
 *
íåy
 = 
	`fûl_¥o˚ss_c⁄ãxt
(&
evít
.
¥o˚ss
);

133 
	`fûl_c⁄èöî_c⁄ãxt
(
íåy
, &
evít
.
c⁄èöî
);

134 
	`fûl_•™_c⁄ãxt
(&
evít
.
•™
);

136 
	`£nd_evít
(
˘x
, 
EVENT_UNLINK
, 
evít
);

140 i‡(
ªtvÆ
 >= 0) {

141 
	`övÆid©e_öode
(
˘x
, 
sysˇŒ
->
u∆ök
.
fûe
.
∑th_key
.
mou¡_id
, sysˇŒ->u∆ök.fûe.∑th_key.
öo
, !
∑ss_to_u£r•a˚
);

145 
	}
}

147 
__©åibuã__
((
Æways_ölöe
)Ë
	$k¥obe_sys_u∆ök_ªt
(
±_ªgs
 *
˘x
) {

148 
ªtvÆ
 = 
	`PT_REGS_RC
(
˘x
);

149  
	`sys_u∆ök_ªt
(
˘x
, 
ªtvÆ
);

150 
	}
}

152 
SEC
("tracepoint/syscalls/sys_exit_unlink")

153 
	$åa˚poöt_sysˇŒs_sys_exô_u∆ök
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

154  
	`sys_u∆ök_ªt
(
¨gs
,árgs->
ªt
);

155 
	}
}

157 
	$SYSCALL_KRETPROBE
(
u∆ök
) {

158  
	`k¥obe_sys_u∆ök_ªt
(
˘x
);

159 
	}
}

161 
SEC
("tracepoint/syscalls/sys_exit_unlinkat")

162 
	$åa˚poöt_sysˇŒs_sys_exô_u∆ök©
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

163  
	`sys_u∆ök_ªt
(
¨gs
,árgs->
ªt
);

164 
	}
}

166 
	$SYSCALL_KRETPROBE
(
u∆ök©
) {

167  
	`k¥obe_sys_u∆ök_ªt
(
˘x
);

168 
	}
}

170 
SEC
("tracepoint/handle_sys_unlink_exit")

171 
	$åa˚poöt_h™dÀ_sys_u∆ök_exô
(
åa˚poöt_øw_sysˇŒs_sys_exô_t
 *
¨gs
) {

172  
	`sys_u∆ök_ªt
(
¨gs
,árgs->
ªt
);

173 
	}
}

	@utimes.h

1 #i‚de‡
_UTIME_H_


2 
	#_UTIME_H_


	)

4 
	~"sysˇŒs.h
"

6 
	~<u≠i/löux/utime.h
>

12 
	sutimes_evít_t
 {

13 
kevít_t
 
	mevít
;

14 
¥o˚ss_c⁄ãxt_t
 
	m¥o˚ss
;

15 
•™_c⁄ãxt_t
 
	m•™
;

16 
c⁄èöî_c⁄ãxt_t
 
	mc⁄èöî
;

17 
sysˇŒ_t
 
	msysˇŒ
;

18 
fûe_t
 
	mfûe
;

19 
ktimevÆ
 
	m©ime
, 
	mmtime
;

22 
__©åibuã__
((
Æways_ölöe
)Ë
	$åa˚__sys_utimes
() {

23 
pﬁicy_t
 
pﬁicy
 = 
	`„tch_pﬁicy
(
EVENT_UTIME
);

24 i‡(
	`is_disˇrded_by_¥o˚ss
(
pﬁicy
.
mode
, 
EVENT_UTIME
)) {

28 
sysˇŒ_ˇche_t
 
sysˇŒ
 = {

29 .
ty≥
 = 
EVENT_UTIME
,

30 .
pﬁicy
 =Öolicy,

33 
	`ˇche_sysˇŒ
(&
sysˇŒ
);

36 
	}
}

38 
__©åibuã__
((
Æways_ölöe
)Ë
	$utime_≠¥ovîs
(
sysˇŒ_ˇche_t
 *
sysˇŒ
) {

39  
	`ba£«me_≠¥ovî
(
sysˇŒ
, sysˇŒ->
£èâr
.
díåy
, 
EVENT_UTIME
);

40 
	}
}

44 
	$SYSCALL_COMPAT_KPROBE0
(
utime
) {

45  
	`åa˚__sys_utimes
();

46 
	}
}

48 
	$SYSCALL_KPROBE0
(
utime32
) {

49  
	`åa˚__sys_utimes
();

50 
	}
}

52 
	$SYSCALL_COMPAT_TIME_KPROBE0
(
utimes
) {

53  
	`åa˚__sys_utimes
();

54 
	}
}

56 
	$SYSCALL_COMPAT_TIME_KPROBE0
(
utimíßt
) {

57  
	`åa˚__sys_utimes
();

58 
	}
}

60 
	$SYSCALL_COMPAT_TIME_KPROBE0
(
futimeßt
) {

61  
	`åa˚__sys_utimes
();

62 
	}
}

64 
__©åibuã__
((
Æways_ölöe
)Ë
	$sys_utimes_ªt
(*
˘x
, 
ªtvÆ
) {

65 
sysˇŒ_ˇche_t
 *
sysˇŒ
 = 
	`p›_sysˇŒ
(
EVENT_UTIME
);

66 i‡(!
sysˇŒ
)

69 i‡(
	`IS_UNHANDLED_ERROR
(
ªtvÆ
))

72 
utimes_evít_t
 
evít
 = {

73 .
sysˇŒ
.
ªtvÆ
 =Ñetval,

74 .
©ime
 = 
sysˇŒ
->
£èâr
.atime,

75 .
mtime
 = 
sysˇŒ
->
£èâr
.mtime,

76 .
fûe
 = 
sysˇŒ
->
£èâr
.file,

79 
¥oc_ˇche_t
 *
íåy
 = 
	`fûl_¥o˚ss_c⁄ãxt
(&
evít
.
¥o˚ss
);

80 
	`fûl_c⁄èöî_c⁄ãxt
(
íåy
, &
evít
.
c⁄èöî
);

81 
	`fûl_•™_c⁄ãxt
(&
evít
.
•™
);

85 
	`£nd_evít
(
˘x
, 
EVENT_UTIME
, 
evít
);

88 
	}
}

90 
__©åibuã__
((
Æways_ölöe
)Ë
	$k¥obe_sys_utimes_ªt
(
±_ªgs
 *
˘x
) {

91 
ªtvÆ
 = 
	`PT_REGS_RC
(
˘x
);

92  
	`sys_utimes_ªt
(
˘x
, 
ªtvÆ
);

93 
	}
}

95 
SEC
("tracepoint/syscalls/sys_exit_utime")

96 
	$åa˚poöt_sysˇŒs_sys_exô_utime
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

97  
	`sys_utimes_ªt
(
¨gs
,árgs->
ªt
);

98 
	}
}

100 
	$SYSCALL_COMPAT_KRETPROBE
(
utime
) {

101  
	`k¥obe_sys_utimes_ªt
(
˘x
);

102 
	}
}

104 
SEC
("tracepoint/syscalls/sys_exit_utime32")

105 
	$åa˚poöt_sysˇŒs_sys_exô_utime32
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

106  
	`sys_utimes_ªt
(
¨gs
,árgs->
ªt
);

107 
	}
}

109 
	$SYSCALL_KRETPROBE
(
utime32
) {

110  
	`k¥obe_sys_utimes_ªt
(
˘x
);

111 
	}
}

113 
SEC
("tracepoint/syscalls/sys_exit_utimes")

114 
	$åa˚poöt_sysˇŒs_sys_exô_utimes
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

115  
	`sys_utimes_ªt
(
¨gs
,árgs->
ªt
);

116 
	}
}

118 
	$SYSCALL_COMPAT_TIME_KRETPROBE
(
utimes
) {

119  
	`k¥obe_sys_utimes_ªt
(
˘x
);

120 
	}
}

122 
SEC
("tracepoint/syscalls/sys_exit_utimensat")

123 
	$åa˚poöt_sysˇŒs_sys_exô_utimíßt
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

124  
	`sys_utimes_ªt
(
¨gs
,árgs->
ªt
);

125 
	}
}

127 
	$SYSCALL_COMPAT_TIME_KRETPROBE
(
utimíßt
) {

128  
	`k¥obe_sys_utimes_ªt
(
˘x
);

129 
	}
}

131 
SEC
("tracepoint/syscalls/sys_exit_futimesat")

132 
	$åa˚poöt_sysˇŒs_sys_exô_futimeßt
(
åa˚poöt_sysˇŒs_sys_exô_t
 *
¨gs
) {

133  
	`sys_utimes_ªt
(
¨gs
,árgs->
ªt
);

134 
	}
}

136 
	$SYSCALL_COMPAT_TIME_KRETPROBE
(
futimeßt
) {

137  
	`k¥obe_sys_utimes_ªt
(
˘x
);

138 
	}
}

140 
SEC
("tracepoint/handle_sys_utimes_exit")

141 
	$åa˚poöt_h™dÀ_sys_utimes_exô
(
åa˚poöt_øw_sysˇŒs_sys_exô_t
 *
¨gs
) {

142  
	`sys_utimes_ªt
(
¨gs
,árgs->
ªt
);

143 
	}
}

	@
1
.
0
41
401
approvers.h
bpf.h
bpf_const.h
buffer_selector.h
cgroup.h
chmod.h
chown.h
commit_creds.h
container.h
defs.h
dentry.h
dentry_resolver.h
discarders.h
erpc.h
exec.h
filename.h
filters.h
ioctl.h
link.h
mkdir.h
mmap.h
mnt.h
mount.h
mprotect.h
open.h
overlayfs.h
process.h
procfs.h
ptrace.h
raw_syscalls.h
rename.h
rmdir.h
selinux.h
setattr.h
setxattr.h
signal.h
span.h
syscalls.h
umount.h
unlink.h
utimes.h
