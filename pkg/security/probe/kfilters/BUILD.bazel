load("@rules_go//go:def.bzl", "go_library", "go_test")

go_library(
    name = "kfilters",
    srcs = [
        "approvers.go",
        "bpf.go",
        "capabilities.go",
        "capabilities_linux.go",
        "capabilities_windows.go",
        "connect.go",
        "kfilters.go",
        "kfilters_bpf.go",
        "mmap.go",
        "mprotect.go",
        "open.go",
        "policy.go",
        "prctl.go",
        "process.go",
        "report.go",
        "setsockopt.go",
        "splice.go",
        "sysctl.go",
    ],
    importpath = "github.com/DataDog/datadog-agent/pkg/security/probe/kfilters",
    visibility = ["//visibility:public"],
    deps = [
        "//pkg/security/probe/config",
        "//pkg/security/secl/compiler/eval",
        "//pkg/security/secl/rules",
    ] + select({
        "@rules_go//go/platform:android": [
            "//pkg/security/ebpf",
            "//pkg/security/probe/managerhelper",
            "//pkg/security/secl/model",
            "//pkg/security/secl/model/sharedconsts",
            "@com_github_datadog_ebpf_manager//:ebpf-manager",
            "@org_golang_x_sys//unix",
        ],
        "@rules_go//go/platform:linux": [
            "//pkg/security/ebpf",
            "//pkg/security/probe/managerhelper",
            "//pkg/security/secl/model",
            "//pkg/security/secl/model/sharedconsts",
            "@com_github_datadog_ebpf_manager//:ebpf-manager",
            "@org_golang_x_sys//unix",
        ],
        "//conditions:default": [],
    }),
)

go_test(
    name = "kfilters_test",
    srcs = [
        "approvers_test.go",
        "report_test.go",
    ],
    embed = [":kfilters"],
    deps = select({
        "@rules_go//go/platform:android": [
            "//pkg/security/ebpf",
            "//pkg/security/probe/config",
            "//pkg/security/secl/compiler/eval",
            "//pkg/security/secl/model",
            "//pkg/security/secl/rules",
            "@com_github_stretchr_testify//assert",
            "@org_golang_x_sys//unix",
        ],
        "@rules_go//go/platform:linux": [
            "//pkg/security/ebpf",
            "//pkg/security/probe/config",
            "//pkg/security/secl/compiler/eval",
            "//pkg/security/secl/model",
            "//pkg/security/secl/rules",
            "@com_github_stretchr_testify//assert",
            "@org_golang_x_sys//unix",
        ],
        "//conditions:default": [],
    }),
)
