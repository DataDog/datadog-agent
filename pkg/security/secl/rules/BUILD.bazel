load("@rules_go//go:def.bzl", "go_library", "go_test")

go_library(
    name = "rules",
    srcs = [
        "actions.go",
        "approvers.go",
        "bucket.go",
        "capabilities.go",
        "collected_events.go",
        "collected_events_regular.go",
        "errors.go",
        "evaluation_set.go",
        "filter_values.go",
        "opts.go",
        "policy.go",
        "policy_dir.go",
        "policy_loader.go",
        "policy_provider.go",
        "rule_filters.go",
        "ruleset.go",
    ],
    importpath = "github.com/DataDog/datadog-agent/pkg/security/secl/rules",
    visibility = ["//visibility:public"],
    deps = [
        "//pkg/security/secl/compiler/ast",
        "//pkg/security/secl/compiler/eval",
        "//pkg/security/secl/log",
        "//pkg/security/secl/model",
        "//pkg/security/secl/utils",
        "//pkg/security/secl/validators",
        "@com_github_fsnotify_fsnotify//:fsnotify",
        "@com_github_hashicorp_go_multierror//:go-multierror",
        "@com_github_masterminds_semver_v3//:semver",
        "@com_github_skydive_project_go_debouncer//:go-debouncer",
        "@com_github_spf13_cast//:cast",
        "@in_gopkg_yaml_v2//:yaml_v2",
    ],
)

go_test(
    name = "rules_test",
    srcs = [
        "evaluation_set_test.go",
        "policy_loader_test.go",
        "policy_test.go",
        "rule_filters_test.go",
        "ruleset_test.go",
    ],
    embed = [":rules"],
    deps = [
        "@com_github_hashicorp_go_multierror//:go-multierror",
        "@com_github_stretchr_testify//assert",
    ] + select({
        "@rules_go//go/platform:android": [
            "//pkg/security/secl/compiler/ast",
            "//pkg/security/secl/compiler/eval",
            "//pkg/security/secl/model",
            "@com_github_google_go_cmp//cmp",
            "@com_github_google_go_cmp//cmp/cmpopts",
            "@com_github_masterminds_semver_v3//:semver",
            "@in_gopkg_yaml_v3//:yaml_v3",
        ],
        "@rules_go//go/platform:linux": [
            "//pkg/security/secl/compiler/ast",
            "//pkg/security/secl/compiler/eval",
            "//pkg/security/secl/model",
            "@com_github_google_go_cmp//cmp",
            "@com_github_google_go_cmp//cmp/cmpopts",
            "@com_github_masterminds_semver_v3//:semver",
            "@in_gopkg_yaml_v3//:yaml_v3",
        ],
        "//conditions:default": [],
    }),
)
