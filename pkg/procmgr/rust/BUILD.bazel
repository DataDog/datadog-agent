load("@rules_pkg//pkg:install.bzl", "pkg_install")
load("@rules_pkg//pkg:mappings.bzl", "pkg_attributes", "pkg_files")
load("@rules_rust//rust:defs.bzl", "rust_binary")

rust_binary(
    name = "dd-procmgrd",
    srcs = glob(["src/**/*.rs"]),
    edition = "2024",
    target_compatible_with = [
        "@platforms//os:linux",
    ],
    visibility = ["//visibility:public"],
    deps = [
        "@procmgrd_crates//:anyhow",
        "@procmgrd_crates//:log",
        "@procmgrd_crates//:nix",
        "@procmgrd_crates//:serde",
        "@procmgrd_crates//:serde_yaml",
        "@procmgrd_crates//:simple_logger",
        "@procmgrd_crates//:tokio",
    ],
)

pkg_files(
    name = "dd-procmgrd_pkg",
    srcs = [":dd-procmgrd"],
    attributes = pkg_attributes(
        mode = "0755",
    ),
)

pkg_install(
    name = "install",
    srcs = [":dd-procmgrd_pkg"],
)
