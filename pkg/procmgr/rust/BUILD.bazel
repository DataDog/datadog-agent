load("@rules_pkg//pkg:install.bzl", "pkg_install")
load("@rules_pkg//pkg:mappings.bzl", "pkg_attributes", "pkg_files")
load("@rules_rust//rust:defs.bzl", "rust_binary", "rust_test")

rust_binary(
    name = "dd-procmgrd",
    srcs = glob(["src/**/*.rs"]),
    edition = "2024",
    target_compatible_with = [
        "@platforms//os:linux",
    ],
    visibility = ["//visibility:public"],
    deps = [
        "@crates//:anyhow",
        "@crates//:log",
        "@crates//:nix",
        "@crates//:serde",
        "@crates//:serde_yaml",
        "@crates//:simple_logger",
        "@crates//:tokio",
    ],
)

pkg_files(
    name = "all_files",
    srcs = [":dd-procmgrd"],
    attributes = pkg_attributes(
        mode = "0755",
    ),
    prefix = "embedded/bin",
)

pkg_install(
    name = "install",
    srcs = [":all_files"],
)

# ============================================================================
# Tests
# ============================================================================

rust_test(
    name = "dd-procmgrd_test",
    crate = ":dd-procmgrd",
    edition = "2024",
    deps = [
        "@crates//:tempfile",
    ],
)

rust_test(
    name = "integration_test",
    srcs = [
        "tests/helpers/mod.rs",
        "tests/integration.rs",
    ],
    crate_root = "tests/integration.rs",
    data = [":dd-procmgrd"],
    edition = "2024",
    rustc_env = {
        "CARGO_BIN_EXE_dd-procmgrd": "$(rootpath :dd-procmgrd)",
    },
    deps = [
        "@crates//:nix",
        "@crates//:tempfile",
    ],
)
