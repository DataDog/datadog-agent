#!/usr/bin/env bash
set -euo pipefail

# Check `bazelisk` properly bootstraps `bazel` or fail with instructions
if [ -z "${BAZEL_REAL:-}" ] || [ "${BAZELISK_SKIP_WRAPPER:-}" != true ]; then
  >&2 cat "$(dirname "$0")/bazelisk.md"
  exit 2
fi

# CI specific setup
if [ -n "${CI:-}" ]; then
  if [ ! -d "${XDG_CACHE_HOME:-}" ]; then
    >&2 echo "ðŸ”´ XDG_CACHE_HOME (${XDG_CACHE_HOME:-}) must denote a directory in CI!"
    exit 2
  fi

  # Pass CI-specific options through `.user.bazelrc` so any nested `bazel run` also honor them
  cat >"$(dirname "$(dirname "$0")")/user.bazelrc" <<EOF
common --config=ci
EOF
fi

exec "$BAZEL_REAL" "$@"
