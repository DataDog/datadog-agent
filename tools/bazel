#!/usr/bin/env bash
set -euo pipefail

# Check `bazelisk` properly bootstraps `bazel` or fail with instructions
if [ -z "${BAZEL_REAL:-}" ] || [ "${BAZELISK_SKIP_WRAPPER:-}" != true ]; then
  >&2 cat "$(dirname "$0")/bazelisk.md"
  exit 2
fi

# CI specific setup
if [ -n "${CI:-}" ]; then
  if [ ! -d "${XDG_CACHE_HOME:-}" ]; then
    >&2 echo "ðŸ”´ XDG_CACHE_HOME (${XDG_CACHE_HOME:-}) must denote a directory in CI!"
    exit 2
  fi

  if [ -d /Users/ec2-user ]; then
    find /Users/ec2-user/cache/DataDog/datadog-agent -mindepth 1 -name 'bazel*' -exec rm -rv {} + || true
    find /Users/ec2-user/cache/DataDog/datadog-agent || true
  fi

  # Pass CI-specific options through `.user.bazelrc` so any nested `bazel run` also honor them
  cat >"$(dirname "$(dirname "$0")")/user.bazelrc" <<EOF
common --config=ci
EOF
fi

# Warn non-CI users running `bazel` in a container without persisting its cache
if [[ -z "${XDG_CACHE_HOME:-}" && ( -e /.dockerenv || -e /run/.containerenv ) ]]; then
  >&2 echo "ðŸ’¡ To persist caches across restarts, consider sharing a directory and setting XDG_CACHE_HOME to its path:"
  # shellcheck disable=SC2016
  >&2 echo '    docker run --env=XDG_CACHE_HOME=/cache --volume="$HOME/.cache:/cache" ...'
fi

exec "$BAZEL_REAL" "$@"
