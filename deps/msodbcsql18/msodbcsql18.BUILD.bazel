"""Build file for msodbcsql18 - Microsoft ODBC Driver 18 for SQL Server.

This replicates the functionality of omnibus/config/software/msodbcsql18.rb
by extracting pre-built binaries from Microsoft's deb/rpm packages.

The Omnibus build:
1. Downloads platform-specific deb/rpm package
2. Extracts it using dpkg-deb or rpm2cpio
3. Patches the rpath of the .so file using patchelf
4. Moves lib64/, share/ to embedded/msodbcsql/
5. Creates a symlink: lib/libmsodbcsql-18.3.so -> lib64/libmsodbcsql-18.3.so.3.1
6. Moves license files
"""

load("@rules_license//rules:license.bzl", "license")
load("@rules_pkg//pkg:install.bzl", "pkg_install")
load("@rules_pkg//pkg:mappings.bzl", "pkg_attributes", "pkg_filegroup", "pkg_files", "pkg_mklink")

package(
    default_package_metadata = [":license"],
    default_visibility = ["//visibility:public"],
)

VERSION = "18.3.3.1-1"
SO_VERSION = "18.3"
SO_FULL_VERSION = "3.1"
SO_FILENAME = "libmsodbcsql-%s.so.%s" % (SO_VERSION, SO_FULL_VERSION)
SO_LINK_NAME = "libmsodbcsql-%s.so" % SO_VERSION

license(
    name = "license",
    license_kinds = ["@rules_license//licenses/spdx:LicenseRef-Proprietary"],
    license_text = "LICENSE.txt",
    visibility = ["//visibility:public"],
)

# ============================================================================
# Extract and patch the driver from deb/rpm packages
# ============================================================================

genrule(
    name = "extract_and_patch",
    srcs = select({
        "//:linux_x86_64": ["@msodbcsql18_deb_amd64//file"],
        "//:linux_arm64": ["@msodbcsql18_deb_arm64//file"],
    }),
    outs = [
        SO_FILENAME,
        "msodbcsqlr18.rll",
        "LICENSE.txt",
    ],
    cmd = """
        set -e
        WORKDIR=$$(mktemp -d)
        trap "rm -rf $$WORKDIR" EXIT

        # Extract deb package
        dpkg-deb -R $(SRCS) $$WORKDIR

        # Patch rpath to use the embedded lib directory
        $(location @patchelf) --force-rpath --set-rpath '/opt/datadog-agent/embedded/lib' \
            $$WORKDIR/opt/microsoft/msodbcsql18/lib64/{so_filename}

        # Copy the files we need
        cp $$WORKDIR/opt/microsoft/msodbcsql18/lib64/{so_filename} $(location {so_filename})
        cp $$WORKDIR/opt/microsoft/msodbcsql18/share/resources/en_US/msodbcsqlr18.rll $(location msodbcsqlr18.rll)
        cp $$WORKDIR/usr/share/doc/msodbcsql18/LICENSE.txt $(location LICENSE.txt)
    """.format(so_filename = SO_FILENAME),
    tools = ["@patchelf"],
    visibility = ["//visibility:public"],
)

# ============================================================================
# Packaging - Library files
# ============================================================================

# Main shared library file
pkg_files(
    name = "lib64_files",
    srcs = [SO_FILENAME],
    prefix = "embedded/msodbcsql/lib64",
    renames = {
        SO_FILENAME: SO_FILENAME,
    },
)

# Symlink: lib/libmsodbcsql-18.3.so -> ../lib64/libmsodbcsql-18.3.so.3.1
# This matches what the Omnibus build does
pkg_mklink(
    name = "lib_symlink",
    attributes = pkg_attributes(mode = "0755"),
    link_name = "embedded/msodbcsql/lib/%s" % SO_LINK_NAME,
    target = "../lib64/%s" % SO_FILENAME,
)

# Resource file (.rll) for error messages/localization
pkg_files(
    name = "resource_files",
    srcs = ["msodbcsqlr18.rll"],
    prefix = "embedded/msodbcsql/share/resources/en_US",
)

# License file
pkg_files(
    name = "license_files",
    srcs = ["LICENSE.txt"],
    prefix = "embedded/msodbcsql/share/doc/msodbcsql18",
)

# ============================================================================
# Filegroup for all files
# ============================================================================

pkg_filegroup(
    name = "all_files",
    srcs = [
        ":lib64_files",
        ":lib_symlink",
        ":resource_files",
        ":license_files",
    ],
)

# ============================================================================
# Installation target
# ============================================================================

pkg_install(
    name = "install",
    srcs = [":all_files"],
)
