load("@@//bazel/rules:so_symlink.bzl", "so_symlink")
load("@rules_cc//cc:cc_library.bzl", "cc_library")
load("@rules_cc//cc:cc_shared_library.bzl", "cc_shared_library")
load("@rules_license//rules:license.bzl", "license")
load("@rules_pkg//pkg:install.bzl", "pkg_install")
load("@rules_pkg//pkg:mappings.bzl", "pkg_filegroup", "pkg_files")

package(default_package_metadata = [":license"])

license(
    name = "license",
    license_kinds = ["@rules_license//licenses/spdx:MIT"],
    license_text = "COPYING",
    visibility = ["//visibility:public"],
)

cc_library(
    name = "libpopt",
    srcs = [
        "src/popt.c",
        "src/poptconfig.c",
        "src/popthelp.c",
        "src/poptint.c",
        "src/poptint.h",
        "src/poptparse.c",
        "src/system.h",
    ],
    textual_hdrs = [
        "src/lookup3.c",
    ],
    hdrs = [
        "src/popt.h",
    ],
    copts = [
        "-std=gnu99",
        "-O2",
    ],
    local_defines = [
        "_GNU_SOURCE",
        "HAVE_STPCPY",
        "HAVE_STRERROR",
        "HAVE_GETUID",
        "HAVE_GETEUID",
        "HAVE_MTRACE",
        "HAVE_SECURE_GETENV",
        "HAVE_SETUID",
        "HAVE_VASPRINTF",
        "HAVE_SRANDOM",
        "HAVE_GLOB_PATTERN_P",
        "HAVE_MBSRTOWCS",
        "HAVE_FNMATCH_H",
        "HAVE_GLOB_H",
        "HAVE_LANGINFO_H",
        "HAVE_MCHECK_H",
        "HAVE_STDALIGN_H",
        'PACKAGE=\\"popt\\"',
        'POPT_SYSCONFDIR=\\"/etc/\\"',
    ],
    strip_include_prefix = "src",
    visibility = ["//visibility:public"],
)

cc_shared_library(
    name = "popt",
    deps = [
        ":libpopt",
    ],
    additional_linker_inputs = [
        "src/libpopt.vers",
    ],
    user_link_flags = [
        "-Wl,--no-undefined",
        "-Wl,--version-script=$(location src/libpopt.vers)",
    ],
    visibility = ["//visibility:public"],
)

so_symlink(
    name = "lib_files",
    src = ":popt",
    libname = "libpopt",
    version = "0.0.2",
)

pkg_files(
    name = "hdr_files",
    srcs = glob(["src/popt.h"]),
    prefix = "include",
)

pkg_filegroup(
    name = "all_files",
    srcs = [
        ":hdr_files",
        ":lib_files",
    ],
    visibility = ["@@//deps/openscap:__pkg__", "@@//packages:__subpackages__"],
)

pkg_install(
    name = "install",
    srcs = [
        ":all_files",
    ],
)
