# Secret connector

http_archive = use_repo_rule("//third_party/bazel/tools/build_defs/repo:http.bzl", "http_archive")

VERSION = "1.4.1"

# Define URLs for each platform
secret_generic_urls = {
    "linux": {
        "x86_64": "https://github.com/DataDog/datadog-secret-backend/releases/download/v{version}/datadog-secret-backend-linux-amd64.tar.gz",
        "arm64": "https://github.com/DataDog/datadog-secret-backend/releases/download/v{version}/datadog-secret-backend-linux-arm64.tar.gz",
    },
    "windows": {
        "x86_64": "https://github.com/DataDog/datadog-secret-backend/releases/download/v{version}/datadog-secret-backend-windows-amd64.zip",
        "arm64": "https://github.com/DataDog/datadog-secret-backend/releases/download/v{version}/datadog-secret-backend-windows-arm64.zip",
    },
    "macos": {
        "x86_64": "https://github.com/DataDog/datadog-secret-backend/releases/download/v{version}/datadog-secret-backend-darwin-amd64.tar.gz",
        "arm64": "https://github.com/DataDog/datadog-secret-backend/releases/download/v{version}/datadog-secret-backend-darwin-arm64.tar.gz",
    },
}

# Define SHA256 checksums for verification
# Note: These should be updated for each version
secret_generic_sha256 = {
    "linux": {
        "x86_64": "88677d8a70c0d5018fd0719ffaa3b82c7b43ab2a38b1d743aed8b7a1d7bbae27",
        "arm64": "3d1ec9987d46ce92c6d0e9fd0a84d859cf6450db76e344bdfb6ebc1494c07820",
    },
    "windows": {
        "x86_64": "55cf4c672564f68687bd8272db95c282cdf2caafe7fc91a6b868b8b5d932231b",
        "arm64": "7d681b44c68bc963049ddaf0774642db5db2c50714b2495cba6feb5f7f96c8d8",
    },
    "macos": {
        "x86_64": "b4a1ee58b2371ca4bf90518bd8169354e799d7a49ce5c8c9aa3eb247c632b96d",
        "arm64": "bbe2774bbc00c7f5380b59891e7ceb61bf5efb87ccaba29a8a7846ef98cd8109",
    },
}

[
    # Define URLs for each architecture. This is used for the Linux build only; Windows and Darwin are not supported yet.
    # When we do those, we can make this parameterized.
    http_archive(
        name = "secret_connector_{platform}_{arch}".format(
            arch = arch,
            platform = platform,
        ),
        files = {
            "BUILD.bazel": "//deps/secret_connector:overlay.BUILD.bazel",
        },
        sha256 = secret_generic_sha256[platform][arch],
        urls = [
            secret_generic_urls[platform][arch].format(version = VERSION),
        ],
    )
    for platform in ("linux", "macos", "windows")
    for arch in ("x86_64", "arm64")
]
