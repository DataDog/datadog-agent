# Secret connector

http_archive = use_repo_rule("//third_party/bazel/tools/build_defs/repo:http.bzl", "http_archive")

VERSION = "1.5.2"

# Define URLs for each platform
secret_generic_urls = {
    "linux": {
        "x86_64": "https://github.com/DataDog/datadog-secret-backend/releases/download/v{version}/datadog-secret-backend-linux-amd64.tar.gz",
        "arm64": "https://github.com/DataDog/datadog-secret-backend/releases/download/v{version}/datadog-secret-backend-linux-arm64.tar.gz",
    },
    "windows": {
        "x86_64": "https://github.com/DataDog/datadog-secret-backend/releases/download/v{version}/datadog-secret-backend-windows-amd64.zip",
        "arm64": "https://github.com/DataDog/datadog-secret-backend/releases/download/v{version}/datadog-secret-backend-windows-arm64.zip",
    },
    "macos": {
        "x86_64": "https://github.com/DataDog/datadog-secret-backend/releases/download/v{version}/datadog-secret-backend-darwin-amd64.tar.gz",
        "arm64": "https://github.com/DataDog/datadog-secret-backend/releases/download/v{version}/datadog-secret-backend-darwin-arm64.tar.gz",
    },
}

# Define SHA256 checksums for verification
# Note: These should be updated for each version
secret_generic_sha256 = {
    "linux": {
        "x86_64": "3f7a999d12a07ceb5d02151e44c3943ec898ae2a8789b8949b43c8d384e6217c",
        "arm64": "b656210a0b1e8e2ec10457837d85faa3e8847ccd613c671a95a038543747b846",
    },
    "windows": {
        "x86_64": "ea46bd9f1efd0ae4ac1c9fc0591f5860e994771e6717d08a4f1502a888a2f372",
        "arm64": "2c1b70474b52fee0ea805026d4cfdd8f96d1b38b9384382a76ec0cf0f23e3971",
    },
    "macos": {
        "x86_64": "e957504a8c86221482d1b850574509c7a381084fae5ab73661345a4e46212737",
        "arm64": "3ef1e4e533707a55dec5e2f141070f79b67f3a6e1bfd440b2d27bad64d62ad7a",
    },
}

[
    # Define URLs for each architecture. This is used for the Linux build only; Windows and Darwin are not supported yet.
    # When we do those, we can make this parameterized.
    http_archive(
        name = "secret_connector_{platform}_{arch}".format(
            arch = arch,
            platform = platform,
        ),
        files = {
            "BUILD.bazel": "//deps/secret_connector:overlay.BUILD.bazel",
        },
        sha256 = secret_generic_sha256[platform][arch],
        urls = [
            secret_generic_urls[platform][arch].format(version = VERSION),
        ],
    )
    for platform in ("linux", "macos", "windows")
    for arch in ("x86_64", "arm64")
]
