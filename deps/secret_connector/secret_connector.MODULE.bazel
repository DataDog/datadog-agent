# Secret connector

http_archive = use_repo_rule("//third_party/bazel/tools/build_defs/repo:http.bzl", "http_archive")

VERSION = "1.5.1"

# Define URLs for each platform
secret_generic_urls = {
    "linux": {
        "x86_64": "https://github.com/DataDog/datadog-secret-backend/releases/download/v{version}/datadog-secret-backend-linux-amd64.tar.gz",
        "arm64": "https://github.com/DataDog/datadog-secret-backend/releases/download/v{version}/datadog-secret-backend-linux-arm64.tar.gz",
    },
    "windows": {
        "x86_64": "https://github.com/DataDog/datadog-secret-backend/releases/download/v{version}/datadog-secret-backend-windows-amd64.zip",
        "arm64": "https://github.com/DataDog/datadog-secret-backend/releases/download/v{version}/datadog-secret-backend-windows-arm64.zip",
    },
    "macos": {
        "x86_64": "https://github.com/DataDog/datadog-secret-backend/releases/download/v{version}/datadog-secret-backend-darwin-amd64.tar.gz",
        "arm64": "https://github.com/DataDog/datadog-secret-backend/releases/download/v{version}/datadog-secret-backend-darwin-arm64.tar.gz",
    },
}

# Define SHA256 checksums for verification
# Note: These should be updated for each version
secret_generic_sha256 = {
    "linux": {
        "x86_64": "eb17a21c4aa543737c34597a67815f273de9240629a03d91643e3e8d40019e48",
        "arm64": "1987a766917a119c15cdcce7ef9e1d1a19289b26c1bf304427ea329c9a2c16f1",
    },
    "windows": {
        "x86_64": "e370fb7953de604d39a7ecb05ba03be3477d923445f2d8ceddf172a3474325d8",
        "arm64": "2a93ebe2d7468afb7f657cb90702f1e66d8006405b31db254d0c5194f2019fe2",
    },
    "macos": {
        "x86_64": "5e3318786f168f15ac02db144132a044ea981edded45def8aa1c763c568ce388",
        "arm64": "f75de28244a2282858a3e9ae7222ad668ddab92e7a13009c26b3f7c84c642229",
    },
}

[
    # Define URLs for each architecture. This is used for the Linux build only; Windows and Darwin are not supported yet.
    # When we do those, we can make this parameterized.
    http_archive(
        name = "secret_connector_{platform}_{arch}".format(
            arch = arch,
            platform = platform,
        ),
        files = {
            "BUILD.bazel": "//deps/secret_connector:overlay.BUILD.bazel",
        },
        sha256 = secret_generic_sha256[platform][arch],
        urls = [
            secret_generic_urls[platform][arch].format(version = VERSION),
        ],
    )
    for platform in ("linux", "macos", "windows")
    for arch in ("x86_64", "arm64")
]
