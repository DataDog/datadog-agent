# Secret connector

http_archive = use_repo_rule("//third_party/bazel/tools/build_defs/repo:http.bzl", "http_archive")

VERSION = "1.4.2"

# Define URLs for each platform
secret_generic_urls = {
    "linux": {
        "x86_64": "https://github.com/DataDog/datadog-secret-backend/releases/download/v{version}/datadog-secret-backend-linux-amd64.tar.gz",
        "arm64": "https://github.com/DataDog/datadog-secret-backend/releases/download/v{version}/datadog-secret-backend-linux-arm64.tar.gz",
    },
    "windows": {
        "x86_64": "https://github.com/DataDog/datadog-secret-backend/releases/download/v{version}/datadog-secret-backend-windows-amd64.zip",
        "arm64": "https://github.com/DataDog/datadog-secret-backend/releases/download/v{version}/datadog-secret-backend-windows-arm64.zip",
    },
    "macos": {
        "x86_64": "https://github.com/DataDog/datadog-secret-backend/releases/download/v{version}/datadog-secret-backend-darwin-amd64.tar.gz",
        "arm64": "https://github.com/DataDog/datadog-secret-backend/releases/download/v{version}/datadog-secret-backend-darwin-arm64.tar.gz",
    },
}

# Define SHA256 checksums for verification
# Note: These should be updated for each version
secret_generic_sha256 = {
    "linux": {
        "x86_64": "91962d9c683b591769c60c09f34e5211124a703545e40a2fa5286f79fd3f2ddc",
        "arm64": "c7aabfdf0b14ee263304104058b0b98e2bf68d22fcc88e8df53d2b83fdb80f0e",
    },
    "windows": {
        "x86_64": "06483a4a3f6a2d18ae20bfa1cce791e30d43997941cbff9c64ca2ce09bb249d0",
        "arm64": "0c45c233ef2b0a5c7433684dae1306c9b290327a3d9e2f257348a45549caf20d",
    },
    "macos": {
        "x86_64": "9b198a301e82ff796d82ea08315777ee58dd4e684684158c29030196864b52d5",
        "arm64": "a2d5e0cd931f9e5b8cc572af6a2b3271714c179d21c30266bbf5ce67909df265",
    },
}

[
    # Define URLs for each architecture. This is used for the Linux build only; Windows and Darwin are not supported yet.
    # When we do those, we can make this parameterized.
    http_archive(
        name = "secret_connector_{platform}_{arch}".format(
            arch = arch,
            platform = platform,
        ),
        files = {
            "BUILD.bazel": "//deps/secret_connector:overlay.BUILD.bazel",
        },
        sha256 = secret_generic_sha256[platform][arch],
        urls = [
            secret_generic_urls[platform][arch].format(version = VERSION),
        ],
    )
    for platform in ("linux", "macos", "windows")
    for arch in ("x86_64", "arm64")
]
