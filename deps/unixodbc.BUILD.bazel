load("@bazel_skylib//rules:copy_file.bzl", "copy_file")
load("@rules_cc//cc:defs.bzl", "cc_library")

copy_file(
    name = "config_h",
    src = select({
        "@platforms//cpu:x86_64": "x86_64/config.h",
        "//conditions:default": "@platforms//:incompatible",
    }),
    out = "config.h",
)

cc_library(
    name = "libltdl",
    srcs = glob(
        ["libltdl/**/*.c", "libltdl/**/*.h"],
        exclude = [
            # Non-Unix loaders
            "libltdl/loaders/load_add_on.c",
            "libltdl/loaders/dyld.c",
            "libltdl/loaders/loadlibrary.c",
            "libltdl/loaders/shl_load.c",
            # Non-glibc implementation that is not needed
            "libltdl/lt__argz.c",
        ],
    ) + [":config_h"],
    visibility = ["//visibility:public"],
    copts = ["-O3", "-DLTDL"],
    includes = ["libltdl/libltdl", "libltdl/.", "."],
)
