load("@bazel_lib//lib:copy_to_directory.bzl", "copy_to_directory")
load("@bazel_skylib//rules:run_binary.bzl", "run_binary")

# Keep in sync with the ones on repos.MODULE.bazel
python_externals = {
    "bzip2": "1.0.8",
    "mpdecimal": "4.0.0",
    "sqlite": "3.50.4.0",
    "xz": "5.2.5",
    "zlib": "1.3.1",
    "libffi": "3.4.4",
    "openssl-bin": "3.0.16.2",
    "tcltk": "8.6.15.0",
}

# These rules will make it easier to get a reference to their folder via $(location)
# and they add the version in the folder name (as some of the vcxproj stuff relies on that)
[
    copy_to_directory(
        name = "{}_win_dir".format(dep),
        srcs = ["@{}_win".format(dep)],
        out = "{}-{}".format(dep, version),
        include_external_repositories = ["*"],
    )
    for dep, version in python_externals.items()
]

run_binary(
    name = "python_win",
    srcs = (
        glob(["**"]) + [
            "bzip2_win_dir",
            "mpdecimal_win_dir",
            "sqlite_win_dir",
            "xz_win_dir",
            "zlib_win_dir",
            "libffi_win_dir",
            "openssl-bin_win_dir",
            "tcltk_win_dir",
        ]
    ),
    outs = [
        "LICENSE.txt",
        "TCL_LIBRARY.env",
        "_asyncio.exp",
        "_asyncio.lib",
        "_asyncio.pdb",
        "_asyncio.pyd",
        "_bz2.exp",
        "_bz2.lib",
        "_bz2.pdb",
        "_bz2.pyd",
        "_ctypes.exp",
        "_ctypes.lib",
        "_ctypes.pdb",
        "_ctypes.pyd",
        "_ctypes_test.exp",
        "_ctypes_test.lib",
        "_ctypes_test.pdb",
        "_ctypes_test.pyd",
        "_decimal.exp",
        "_decimal.lib",
        "_decimal.pdb",
        "_decimal.pyd",
        "_elementtree.exp",
        "_elementtree.lib",
        "_elementtree.pdb",
        "_elementtree.pyd",
        "_hashlib.exp",
        "_hashlib.lib",
        "_hashlib.pdb",
        "_hashlib.pyd",
        "_lzma.exp",
        "_lzma.lib",
        "_lzma.pdb",
        "_lzma.pyd",
        "_multiprocessing.exp",
        "_multiprocessing.lib",
        "_multiprocessing.pdb",
        "_multiprocessing.pyd",
        "_overlapped.exp",
        "_overlapped.lib",
        "_overlapped.pdb",
        "_overlapped.pyd",
        "_queue.exp",
        "_queue.lib",
        "_queue.pdb",
        "_queue.pyd",
        "_socket.exp",
        "_socket.lib",
        "_socket.pdb",
        "_socket.pyd",
        "_sqlite3.exp",
        "_sqlite3.lib",
        "_sqlite3.pdb",
        "_sqlite3.pyd",
        "_ssl.exp",
        "_ssl.lib",
        "_ssl.pdb",
        "_ssl.pyd",
        "_testbuffer.exp",
        "_testbuffer.lib",
        "_testbuffer.pdb",
        "_testbuffer.pyd",
        "_testcapi.exp",
        "_testcapi.lib",
        "_testcapi.pdb",
        "_testcapi.pyd",
        "_testclinic.exp",
        "_testclinic.lib",
        "_testclinic.pdb",
        "_testclinic.pyd",
        "_testclinic_limited.exp",
        "_testclinic_limited.lib",
        "_testclinic_limited.pdb",
        "_testclinic_limited.pyd",
        "_testconsole.exp",
        "_testconsole.lib",
        "_testconsole.pdb",
        "_testconsole.pyd",
        "_testembed.exe",
        "_testembed.pdb",
        "_testimportmultiple.exp",
        "_testimportmultiple.lib",
        "_testimportmultiple.pdb",
        "_testimportmultiple.pyd",
        "_testinternalcapi.exp",
        "_testinternalcapi.lib",
        "_testinternalcapi.pdb",
        "_testinternalcapi.pyd",
        "_testlimitedcapi.exp",
        "_testlimitedcapi.lib",
        "_testlimitedcapi.pdb",
        "_testlimitedcapi.pyd",
        "_testmultiphase.exp",
        "_testmultiphase.lib",
        "_testmultiphase.pdb",
        "_testmultiphase.pyd",
        "_testsinglephase.exp",
        "_testsinglephase.lib",
        "_testsinglephase.pdb",
        "_testsinglephase.pyd",
        "_tkinter.exp",
        "_tkinter.lib",
        "_tkinter.pdb",
        "_tkinter.pyd",
        "_uuid.exp",
        "_uuid.lib",
        "_uuid.pdb",
        "_uuid.pyd",
        "_wmi.exp",
        "_wmi.lib",
        "_wmi.pdb",
        "_wmi.pyd",
        "_zoneinfo.exp",
        "_zoneinfo.lib",
        "_zoneinfo.pdb",
        "_zoneinfo.pyd",
        "libcrypto-3.dll",
        "libcrypto-3.pdb",
        "libffi-8.dll",
        "liblzma.lib",
        "liblzma.pdb",
        "libssl-3.dll",
        "libssl-3.pdb",
        "py.exe",
        "py.pdb",
        "pybuilddir.txt",
        "pyconfig.h",
        "pyexpat.exp",
        "pyexpat.lib",
        "pyexpat.pdb",
        "pyexpat.pyd",
        "pyshellext.dll",
        "pyshellext.exp",
        "pyshellext.lib",
        "pyshellext.pdb",
        "python.exe",
        "python.pdb",
        "python3.dll",
        "python3.exp",
        "python3.lib",
        "python3.pdb",
        "python313.dll",
        "python313.exp",
        "python313.lib",
        "python313.pdb",
        "pythonw.exe",
        "pythonw.pdb",
        "pyw.exe",
        "pyw.pdb",
        "select.exp",
        "select.lib",
        "select.pdb",
        "select.pyd",
        "sqlite3.dll",
        "sqlite3.exp",
        "sqlite3.lib",
        "sqlite3.pdb",
        "tcl86t.dll",
        "tk86t.dll",
        "unicodedata.exp",
        "unicodedata.lib",
        "unicodedata.pdb",
        "unicodedata.pyd",
        "vcruntime140.dll",
        "vcruntime140_1.dll",
        "venvlauncher.exe",
        "venvlauncher.pdb",
        "venvwlauncher.exe",
        "venvwlauncher.pdb",
        "winsound.exp",
        "winsound.lib",
        "winsound.pdb",
        "winsound.pyd",
        "xxlimited.exp",
        "xxlimited.lib",
        "xxlimited.pdb",
        "xxlimited.pyd",
        "xxlimited_35.exp",
        "xxlimited_35.lib",
        "xxlimited_35.pdb",
        "xxlimited_35.pyd",
        "zlib1.dll",
    ],
    args = [
        "$(location LICENSE)",
        "$(location python.exe)",
    ],
    env = {
        "PROCESSOR_ARCHITECTURE": "AMD64",
        # Paths to dependencies:
        "BZ2_DIR": "$(location bzip2_win_dir)",
        "MPDECIMAL_DIR": "$(location mpdecimal_win_dir)",
        "SQLITE3_DIR": "$(location sqlite_win_dir)",
        "XZ_DIR": "$(location xz_win_dir)",
        "ZLIB_DIR": "$(location zlib_win_dir)",
        "LIBFFI_DIR": "$(location libffi_win_dir)",
        "OPENSSL_DIR": r"$(location openssl-bin_win_dir)\amd64",
        "TCLTK_DIR": r"$(location tcltk_win_dir)\amd64",
        "TCL_VERSION": python_externals["tcltk"],
        # This sets up vs toolchain and depends on the system
        "MSBUILD": r"C:\devtools\vstudio\MSBuild\Current\Bin\MSBuild.exe",
    },
    tool = "build_python.bat",
)
