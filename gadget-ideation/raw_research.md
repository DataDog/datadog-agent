Project: Innovation Week 2025 - Workload CaptureRepository: datadog-agentAnalysis Date: 2025-10-29Method: Code-based exploration and analysisTable of ContentsPush-Based Workloads (Application-Initiated)System-Level Data Sources (Kernel/OS)Check/Integration-Based Data Sources (Polling)Network Monitoring Data Sources (eBPF-Based)Kubernetes/Container Data SourcesLog Collection Data SourcesSecurity Monitoring Data SourcesCloud Provider IntegrationsAutodiscovery MechanismsSummary Statistics1. PUSH-BASED WORKLOADS (Application-Initiated)1.1 DogStatsD Metrics (Port 8125)Primary Use Case: Push-based metrics from applicationsIngestion MethodsUDP ListenerPort: 8125 (default)Protocol: Connectionless datagramConfiguration: dogstatsd_port (can be __random__ for auto-allocation)Features:Configurable socket receive buffer (dogstatsd_so_rcvbuf)Non-local traffic support (dogstatsd_non_local_traffic)Packet aggregation buffer (dogstatsd_packet_buffer_size)Location: comp/dogstatsd/listeners/udp.go:45-164Unix Domain Socket (UDS) - Datagram ModePath: /var/run/datadog/dsd.socket (default)Protocol: unixgram (connectionless datagram)Configuration: dogstatsd_socketFeatures:Origin detection support (Linux only)Lower latency than UDPLocation: comp/dogstatsd/listeners/uds_datagram.go:24-106Unix Domain Socket (UDS) - Stream ModePath: /var/run/datadog/dsd-stream.sock (default)Protocol: unix (stream-oriented, connection-based)Configuration: dogstatsd_stream_socketFeatures:Connection pooling support4-byte little-endian length prefix framingMultiple concurrent client connectionsLocation: comp/dogstatsd/listeners/uds_stream.go:26-121Named Pipes (Windows Only)Prefix: \\\\.\\pipe\\Buffer Size: 1MB default (configurable via PipeBufferSize)Features:Multiple concurrent clientsMessage-delimited protocol (newline-separated)Location: comp/dogstatsd/listeners/named_pipe_windows.go:29-236Metric Types SupportedTypeSymbolDescriptionGauge g Point-in-time value Count c Increment counter Distribution d Statistical distribution Histogram h Histogram aggregation Set s Unique value counting Timing ms Timing measurements Location: comp/dogstatsd/server/parse_metrics.go:15-24Protocol Format<metric_name>:<value>|<type>|@<sample_rate>|#<tag1>:<value1>,<tag2>:<value2>Example: request.count:1|c|@0.5|#env:prod,service:webOrigin Detection (Linux Only)Mechanism: SO_PASSCRED socket optionData Provided: PID, UID, GID via ancillary data (SCM_CREDENTIALS)Benefits: Automatic container origin tagging without client modificationsCache: 1-minute TTL for PID-to-container mappingLocation: comp/dogstatsd/listeners/uds_linux.go:27-137Additional Message TypesService Checks:Format: _sc|<name>|<status>Status values: Unknown (3), Ok (0), Warning (1), Critical (2)Optional fields: timestamp, hostname, message, tagsLocation: comp/dogstatsd/server/parse_service_checks.go:17-95Events:Format: _e{<title.length>,<text.length>}:<title>|<text>Priority: normal, lowAlert types: success, info, warning, errorLocation: comp/dogstatsd/server/parse_events.go:17-80Configuration Keys SummaryConfig KeyTypeDefaultPurposedogstatsd_port String 8125 UDP port dogstatsd_socket String /var/run/datadog/dsd.socket UDS datagram path dogstatsd_stream_socket String /var/run/datadog/dsd-stream.sock UDS stream path dogstatsd_non_local_traffic Bool false Allow non-localhost UDP dogstatsd_buffer_size Int 4096 Packet buffer size dogstatsd_packet_buffer_size Int 16 Aggregation buffer capacity dogstatsd_packet_buffer_flush_timeout Duration 100ms Flush timeout dogstatsd_so_rcvbuf Int 0 SO_RCVBUF socket option dogstatsd_origin_detection Bool false Enable origin detection dogstatsd_origin_detection_client Bool false Honor client-sent origin 1.2 APM/Trace Data (Port 8126)Primary Use Case: Application Performance Monitoring and distributed tracingIngestion MethodsHTTP/TCP ListenerPort: 8126 (default)Protocol: HTTP over TCPConfiguration: ReceiverPort, ReceiverHostMax Request Size: 25 MB default (MaxRequestBytes)Timeout: 5 seconds default (ReceiverTimeout)Location: pkg/trace/api/api.go:256-350Unix Domain Socket (UDS)Path: Configurable via ReceiverSocketPermissions: 0o722 (read/write for all)Environment Variable: DD_APM_UNIX_RECEIVER_FD for pre-configured listenersLocation: pkg/trace/api/api.go:319-360Windows Named PipesConfiguration: WindowsPipeNameBuffer Size: 1,000,000 bytes default (PipeBufferSize)Protocol Versions and FormatsVersionFormatStatusDescriptionv0.1 msgpack/JSON DEPRECATED Legacy format v0.2 msgpack/JSON DEPRECATED Legacy format v0.3 msgpack/JSON Active Standard format v0.4 msgpack Active TracerPayload with sampling rates v0.5 msgpack Active Dictionary-based compression v0.7 msgpack Active Current standard (TracerPayload) v1.0 msgpack Latest Index-based string references Location: pkg/trace/api/version.goHTTP EndpointsTrace Ingestion:/v0.3/traces, /v0.4/traces, /v0.5/traces - Legacy trace endpoints/v0.7/traces - Current standard endpoint/v1.0/traces - Latest endpoint (optional)Location: pkg/trace/api/endpoints.go:42-174Statistics:/v0.6/stats - Client statistics (ClientStatsPayload format)Handler: handleStats() at pkg/trace/api/api.go:593-634Profiling:/profiling/v1/input - Profiling data proxyTarget: <https://intake.profile.datadoghq.com/api/v2/profile>Timeout: 5 seconds defaultIdle Connection Timeout: 47 seconds (prime number to avoid collisions)Location: pkg/trace/api/profiles.go:78-98Debugger:/debugger/v1/input - Live Debugger logs proxy/debugger/v1/diagnostics - Debugger diagnostics/debugger/v2/input - Debugger V2 intake proxyLocation: pkg/trace/api/debugger.goSymbol Database:/symdb/v1/input - Symbol database proxy for profilingLocation: pkg/trace/api/symdb.goDogStatsD Proxy:/dogstatsd/v1/proxy - DEPRECATED/dogstatsd/v2/proxy - HTTP to UDP proxy for DogStatsD metricsTarget: Core Agent UDP port 8125Location: pkg/trace/api/dogstatsd.go:18-63Event Processing (EVP):/evp_proxy/v1/, /evp_proxy/v2/, /evp_proxy/v3/, /evp_proxy/v4/Timeout: 30 seconds defaultLocation: pkg/trace/api/evp_proxy.goTelemetry:/telemetry/proxy/ - Instrumentation telemetry forwardingConfiguration: TelemetryConfig.EnabledLocation: pkg/trace/api/telemetry.goOpenLineage:/openlineage/api/v1/lineage - OpenLineage data collectionLocation: pkg/trace/api/openlineage.goTracer Flare:/tracer_flare/v1 - Tracer diagnostics and support flaresLocation: pkg/trace/api/tracer_flare.goInfo/Discovery:/info - API discovery and version informationLists all available endpoints and agent stateLocation: pkg/trace/api/info.goRequest Handling ConfigurationTimeouts:General: 5 seconds (ReceiverTimeout)Profiling: 5 seconds (ProfilingProxy.ReceiverTimeout)EVP: 30 seconds (EVPProxy.ReceiverTimeout)Rate Limiting:Connection limiting in 30-second lease periodsReturns 429 (Too Many Requests) when limit exceededDecoder semaphore: GOMAXPROCS/2 (default)Size Limits:Max request bytes: 25 MBMax connections: Configurable (MaxConnections)Location: pkg/trace/config/config.go:396-608Container and Orchestration IntegrationContainer Identification:Cgroup-based detectionOrigin-info based detectionProc-root based detectionX-Datadog-Container-ID header extractionLocation: pkg/trace/api/container.goOrchestrator Detection:ECS, EKS, or UnknownInjected as tags in profiling and telemetry requestsLocation: pkg/trace/config/config.go:257-2621.3 OpenTelemetry (OTLP)Primary Use Case: OpenTelemetry protocol support for traces and metricsgRPC ReceiverPort: Configurable (disabled by default, port 0)Protocol: gRPCConfiguration:OTLPReceiver.GRPCPort - Port numberOTLPReceiver.BindHost - Bind addressGrpcMaxRecvMsgSizeMib - Max message size (10 MiB default)Max Concurrent Streams: 1 per connectionEnvironment Variable: DD_OTLP_CONFIG_GRPC_FD for pre-configured listenersLocation: pkg/trace/api/otlp.go:53-103OTLP Data Reception MethodsExport() - Main gRPC export handler (line 160)ReceiveResourceSpans() - Resource span processing (line 245)receiveResourceSpansV2() - V2 processing logic (line 252)receiveResourceSpansV1() - V1 processing logic (line 366)Configuration OptionsSettingDefaultPurposeGRPCPort 0 (disabled) gRPC receiver port BindHost localhost Host binding address SpanNameRemappings {} Map Datadog span names SpanNameAsResourceName false Use OTel span name as DD resource name MaxRequestBytes 25MB Max request size ProbabilisticSampling 0 Sampling percentage GrpcMaxRecvMsgSizeMib 10 Max gRPC message size (MiB) Location: pkg/trace/config/config.go:48-942. SYSTEM-LEVEL DATA SOURCES (Kernel/OS)2.1 /proc Filesystem (Linux)Process-Level FilesFile PathData CollectedLocation/proc/[pid]/stat CPU time, scheduling info, state pkg/process/procutil/process_linux.go /proc/[pid]/status Memory (VmRSS, VmSize, VmSwap), threads, UIDs/GIDs pkg/process/procutil/process_linux.go:47-57 /proc/[pid]/environ Environment variables pkg/util/kernel/proc.go:102 /proc/[pid]/fd/ File descriptors, memfd files pkg/util/kernel/proc.go:157-212 /proc/[pid]/io I/O counters and statistics /proc/[pid]/maps Memory mappings /proc/[pid]/smaps Detailed memory mappings /proc/[pid]/ns/ Namespace inodes pkg/network/usm/procnet/procnet.go:57 /proc/[pid]/cgroup Cgroup membership pkg/security/utils/cgroup.go:52-69 /proc/[pid]/net/tcp TCP connection state (per-namespace) pkg/network/usm/procnet/procnet.go:64 /proc/[pid]/net/tcp6 IPv6 TCP connection state pkg/network/usm/procnet/procnet.go:64 System-Wide FilesFile PathData CollectedLocation/proc/meminfo Total memory, swap information pkg/gohai/memory/memory_linux.go:74 /proc/stat CPU statistics (aggregate) pkg/serverless/proc/proc.go /proc/net/tcp TCP connection state (system-wide) pkg/network/proc_net.go:27-92 /proc/net/tcp6 IPv6 TCP connection state pkg/network/proc_net.go:27-92 /proc/net/netstat Extended network statistics pkg/collector/corechecks/net/network/network.go /proc/uptime System uptime pkg/serverless/proc/proc.go /proc/cpuinfo CPU information pkg/gohai/cpu/cpu_linux_default.go /proc/sys/fs/file-nr File descriptor statistics pkg/collector/corechecks/system/filehandles/file_handles.go:25 2.2 /sys Filesystem (Linux)sysfs PathsCgroup Filesystem:/sys/fs/cgroup/ - Cgroup v1 and v2 filesystemsLocation: pkg/util/cgroups/self_reader.go:18,70Cgroup v1 Controller Files:/sys/fs/cgroup/memory/[path]/memory.limit_in_bytes/sys/fs/cgroup/memory/[path]/memory.stat/sys/fs/cgroup/memory/[path]/memory.usage_in_bytes/sys/fs/cgroup/memory/[path]/memory.swap.limit_in_bytes/sys/fs/cgroup/cpu/[path]/cpu.stat/sys/fs/cgroup/cpuset/[path]/cpuset.cpus/sys/fs/cgroup/blkio/[path]/blkio.io_service_bytes/sys/fs/cgroup/devices/[path]/devices.allowLocation: pkg/gpu/cgroups.go:63-66Cgroup v2 (Unified Hierarchy) Files:/sys/fs/cgroup/[path]/memory.current/sys/fs/cgroup/[path]/memory.max/sys/fs/cgroup/[path]/memory.stat/sys/fs/cgroup/[path]/cpu.stat/sys/fs/cgroup/[path]/io.statKernel Debug/Trace Filesystem:/sys/kernel/debug/tracing/events/[tracepoint]/format - Tracepoint definitions/sys/kernel/debug/tracing/kprobe_profile - KProbe statistics/sys/kernel/debug/tracing/uprobe_profile - UProbe statisticsLocation: pkg/security/probe/constantfetch/tracepoints.go:22-60Location: pkg/ebpf/telemetry/debugfs_stat_collector_linux.go:76-962.3 Cgroup Data CollectionCgroup V1 ControllersMonitored files per controller:memory: limit_in_bytes, stat, usage_in_bytes, swap.limit_in_bytescpu: stat, shares, cfs_period_us, cfs_quota_uscpuset: cpus, memsblkio: io_service_bytes, io_serviceddevices: allow, denyCgroup V2 (Unified Hierarchy)Single unified hierarchy at /sys/fs/cgroup/:memory.current, memory.max, memory.statcpu.stat, cpu.weight, cpu.maxio.stat, io.weightCgroup Detection and ParsingLocation: pkg/util/cgroups/reader_detector.goParses /proc/[pid]/cgroup format: hierarchy-ID:controller-list:cgroup-pathResolves cgroup paths by walking /sys/fs/cgroup treeLocation: pkg/security/utils/cgroup.go:52-69GPU Cgroup IntegrationDevice allow lists for GPU access controlConfigures cgroupv1 device controller for GPU visibilityLocation: pkg/gpu/cgroups.go:75-2022.4 eBPF Programs and MapseBPF InfrastructureeBPF Manager:Wrapper around github.com/DataDog/ebpf-managerModifier support for program customizationLocation: pkg/ebpf/manager.go:24-53eBPF Map Types:BPF_MAP_TYPE_HASH - Hash tablesBPF_MAP_TYPE_ARRAY - Array mapsBPF_MAP_TYPE_RING_BUFFER - Ring buffers for event deliveryLocation: pkg/ebpf/maps/generic_map.goLocation: pkg/ebpf/c/map-defs.hKernel Symbol Resolution:Reads kernel symbols for runtime eBPF program patchingLocation: pkg/ebpf/ksyms.goLocation: pkg/ebpf/ksyms_bpf.goPerformance Monitoring via eBPFPerf Events:perf_event_open() syscall for hardware countersMonitored events:CPU cyclesInstructions executedCache missesBranch missesLocation: pkg/ebpf/perf.goLocation: pkg/ebpf/perf_ring_buffer.goLocation: pkg/security/ebpf/probes/perf_event.go2.5 System Calls and Kernel InterfacesSyscalls Usedperf_event_open() - Performance monitoringbpf() - eBPF program loading and managementopenat() / open() - File accessstat() / fstat() / statx() - File metadataKernel Helpers (via eBPF)BPF helpers for reading sysctl values from /proc/sysBPF helpers for reading process memory and registersLocation: pkg/ebpf/c/bpf_helper_defs.hTracefs/Debugfs AccessTracepoint Format Reading:Reads tracepoint definitions from tracefsExtracts field offsets for eBPF programsLocation: pkg/security/probe/constantfetch/tracepoints.go:22-60Probe Statistics:Reads kprobe and uprobe statisticsPaths: debugfs/tracefs/kprobe_profile, debugfs/tracefs/uprobe_profileLocation: pkg/ebpf/telemetry/debugfs_stat_collector_linux.go:76-962.6 Hardware Counters and Performance MonitoringPerf Events IntegrationUses perf_event_open() syscallMonitors:CPU cyclesInstructionsCache hits/missesBranch predictionsLocation: pkg/ebpf/perf.goGPU MonitoringCUDA Device Tracking:Tracks CUDA device usage per process/threadReads CUDA_VISIBLE_DEVICES environment variableDevice allocation and assignment trackingLocation: pkg/gpu/context.go:34-692.7 Windows-Specific System APIsProcess API (Toolhelp)DLL: PSAPI.dll, kernel32.dllFunctions:GetProcessMemoryInfo() - Process memory countersWorkingSetSize, PagefileUsage, etc.GetProcessHandleCount() - Open handle countGetProcessIoCounters() - I/O operations and transfer countsReadOperationCount, WriteOperationCountReadTransferCount, WriteTransferCountLocation: pkg/process/procutil/process_windows_toolhelp.go:28-41Performance Data Helper (PDH)Monitored via PDH API:CPU utilization (per processor and aggregate)Memory usage (physical and virtual)Disk I/O (read/write rates)Network traffic (bytes sent/received)Location: pkg/util/pdhutil/pdh.goVersion Information APIDLL: kernel32.dll, version.dllFunctions:GetModuleHandleW() - Module handle retrievalGetModuleFileNameW() - Module file pathFile version APIs for Windows version detectionLocation: pkg/util/winutil/winver.go:22-263. CHECK/INTEGRATION-BASED DATA SOURCES (Polling)3.1 Check FrameworkCore Check SystemCheck Interface:All checks implement: Run(), Stop(), Configure(), Interval()Base implementation: CheckBaseRegistration: RegisterCheck(name, factory) patternLocation: pkg/collector/check/check.goLocation: pkg/collector/corechecks/checkbase.goLocation: pkg/collector/corechecks/loader.goCheck Factory PatternChecks registered via catalogDynamic loading based on configurationGoCheckLoader for Go-based checks3.2 System-Level ChecksCPU CheckMetrics: CPU usage, cores, context switchesData Source: gopsutil libraryAPIs: cpu.Times(), cpu.Info()Metrics Emitted: system.cpu.context_switches, system.cpu.num_coresLocation: pkg/collector/corechecks/system/cpu/cpu/cpu.goMemory CheckMetrics: Memory usage, swap usageData Source: gopsutil libraryLocation: pkg/collector/corechecks/system/memory/memory.goDisk I/O CheckMetrics: Disk read/write rates, IOPSData Source: Block device statisticsCommands: lsblk for device enumerationlsblk --noheadings --raw --output=NAME,LABELLocation: pkg/collector/corechecks/system/disk/diskv2/disk.goLocation: pkg/collector/corechecks/system/disk/diskv2/disk_nix.go:54File Handles CheckMetrics: Open file handles, limitsData Source: /proc/sys/fs/file-nrLocation: pkg/collector/corechecks/system/filehandles/file_handles.go:25Load Average CheckMetrics: System load (1min, 5min, 15min)Data Source: /proc/loadavg or system callsLocation: pkg/collector/corechecks/system/cpu/load/load.goUptime CheckMetrics: System uptime secondsData Source: /proc/uptime or system callsLocation: pkg/collector/corechecks/system/uptime/uptime.go3.3 Network Protocol ChecksNTP (Network Time Protocol) CheckConfiguration:Endpoint: pool.ntp.org (Datadog: 0-3.datadog.pool.ntp.org)Protocol: UDP port 123Default Interval: 15 minutes (900s) - respects pool rate limitsTimeout: ConfigurableVersion: NTPv3/v4Metrics:system.ntp.offset - NTP offset in secondsLibrary: github.com/beevik/ntpConfiguration File: cmd/agent/dist/conf.d/ntp.d/conf.yaml.defaultLocation: pkg/collector/corechecks/net/ntp/ntp.go3.4 Database IntegrationsOracle Database CheckConnection Details:Drivers: godror, go-oraProtocol: SQL over TCPAuthentication: Username/passwordSSL/TLS: Trust store supportMax Connections: 10 concurrentData Collected:Activity metrics (queries from activity_queries.go)Lock informationStatement metrics (from v$sqlstats, v$sql)System metricsTablespace informationProcess informationCustom Queries: User-defined SQL queries via configConfiguration File: cmd/agent/dist/conf.d/oracle.d/conf.yaml.exampleLocation: pkg/collector/corechecks/oracle/oracle.goMySQL IntegrationConnection Details:Protocol: TCP port 3306 or Unix socketAuthentication: Username/passwordTLS: Optional encryptionFeatures:AWS RDS/Aurora supportDBM (Database Monitoring) - advanced monitoringQuery metrics and samplesReplication monitoringAutodiscovery: ad_identifiers: _dbm_mysqlConfiguration File: cmd/agent/dist/conf.d/mysql.d/conf_aws_rds.yaml.defaultPostgreSQL IntegrationConnection Details:Protocol: TCP port 5432 or Unix socketAuthentication: Username/passwordTLS: Optional encryptionFeatures:AWS RDS/Aurora supportDBM (Database Monitoring)Query metrics and samplesReplication monitoringAutodiscovery: ad_identifiers: _dbm_postgresConfiguration File: cmd/agent/dist/conf.d/postgres.d/conf_aws_rds.yaml.default3.5 SNMP (Network Device Monitoring)Protocol: SNMP v1, v2, v3 pollingConnection Details:Port: UDP 161 (default, configurable)Target: Network devices (switches, routers, etc.)Authentication:v1/v2: Community stringv3: User/authKey/privKey with MD5, SHA, SHA256, etc.Data Collection:OID querying (batch size: 60 default)Device metadata collectionTopology collectionVPN tunnels and route tablesInterface configurationPing capabilityDiscovery:Device discovery with autodiscoverySubnet tagging supportImplementation: gosnmp library with custom session handlingConfiguration File: cmd/agent/dist/conf.d/snmp.d/auto_conf.yamlLocation: pkg/collector/corechecks/snmp/snmp.goLocation: pkg/snmp/snmp.goLocation: pkg/snmp/gosnmplib/3.6 JMX (Java Application Monitoring)Connection Methods:JMX host/port connectionProcess attach API (via process_name_regex and tools_jar_path)Custom JMX URLFeatures:SSL/TLS Support: Trust stores, keystoresRMI Registry SSL: OptionalCustom JAR Paths: For classpath extensionsMetric Collection:MBean refresh period: 600s (default)Default JVM metrics:Garbage collection (jvm.gc.*)Memory usage (jvm.heap_memory, jvm.non_heap_memory)Threading (jvm.thread_count)Custom metrics via domain/bean/attribute matchingRegular expression support for filteringNew GC metric names optionConfiguration File: cmd/agent/dist/conf.d/jmx.d/conf.yaml.example3.7 HTTP/HTTPS Endpoint MonitoringPrometheus/OpenMetrics ScrapingMechanism:Scrapes Prometheus metrics endpoints via HTTP/HTTPSKubernetes annotation-based autodiscoveryConfiguration:prometheus_scrape.version - v1 or v2 endpoint typesprometheus_scrape.checks - Custom check configurationsEnvironment variable: DD_PROMETHEUS_SCRAPE_CHECKSKubernetes Annotations:Pod/container annotations for autodiscoveryDynamic URL construction from annotationsMetric Processing:Filters, transforms, and emits metricsOpenMetrics check integrationLocation: comp/core/autodiscovery/common/utils/prometheus.goLocation: comp/core/autodiscovery/common/utils/prometheus_pods.goLocation: comp/core/autodiscovery/common/utils/prometheus_apiserver.go3.8 Kubernetes API Server IntegrationEndpoints Queried:/api/v1/pods - Pod list/api/v1/events - Cluster eventsDynamic custom resource queriesData Collected:Cluster eventsAPI resourcesCustom resource definitionsConfiguration File: cmd/agent/dist/conf.d/kubernetes_apiserver.d/conf.yaml.exampleLocation: pkg/collector/corechecks/cluster/kubernetesapiserver/kubernetes_apiserver.go3.9 Autodiscovery MechanismsService Listener SystemLocation: comp/core/autodiscovery/listeners/types.goListener Types:Container Listener (container.go)Monitors Docker containers via workloadmetaExtracts ports, tags, network infoSupports Docker labels for AD identifiersKubernetes Endpoints Listener (kube_endpoints.go)Watches Kubernetes Endpoints resourcesAuto-discovers services on clusterMatches with Prometheus annotationsKubernetes Services Listener (kube_services.go)Monitors Kubernetes Service objectsExtracts endpoints and portsRDS Database Listener (dbm_rds.go)AWS-specific: Discovers RDS/Aurora instancesPolls AWS API for database instancesRegion-aware discoveryAuto-generates MySQL/PostgreSQL checksSNMP Listener (snmp.go)Auto-discovers SNMP devicesSubnet-based discoveryStatic Config Listener (staticconfig.go)File-based configuration parsingEnvironment Listener (environment.go)Environment variable-based configuration3.10 Data Flow & Polling PatternsCollection FlowService Detection (Listener)
  ↓
AD Identifier Matching
  ↓
Template Resolution
  ↓
Check Configuration
  ↓
Check Scheduling (Runner)
  ↓
Metric Collection
  ↓
Aggregation & SubmissionPolling IntervalsCheck TypeDefault IntervalConfigurable ViaNTP 900s (15 min) min_collection_interval RDS Discovery Configurable discovery_interval JMX MBeans 600s (10 min) MBean refresh config SNMP Per-device Instance interval General Checks Variable min_collection_interval 3.11 Configuration PatternsDatabase Check Patternad_identifiers:
  - _dbm_<database_type>  # e.g., _dbm_mysql, _dbm_postgres
init_config: {...}
instances:
  - host: "%%host%%"
    port: "%%port%%"
    tags: [...]SNMP Patternad_identifiers:
  - snmp
instances:
  - ip_address: "%%host%%"
    snmp_version: "%%extra_version%%"3.12 Custom Check MechanismsCheck Registration PatternCreate check struct implementing Check interfaceRegister via RegisterCheck(name, factory) in loaderLoaders call factory function for each configured instanceCheck runs on configured intervalIntegration with SenderChecks use GetSender() to submit metrics/eventsSender provides:Gauge() - Point-in-time valuesCount() - Increment countersServiceCheck() - Service statusEvent() - EventsCommit() - Flush metrics4. NETWORK MONITORING DATA SOURCES (eBPF-Based)4.1 Network Traffic Capture MechanismsAF_PACKET Socket-Based CaptureImplementation:AFPacketSource struct: RAW_SOCKET with eBPF SOCKET_FILTERMemory-mapped ring buffer via afpacket.TPacketFrame Size: 4096 bytes (default, configurable via OptSnapLen)Memory: Configurable block size/num blocksTelemetry:Polled packets countProcessed packets countCaptured packets countDropped packets countLocation: pkg/network/filter/packet_source_linux.go:1-150Headless Socket FilterPurpose: Pure packet inspection without pollingImplementation:Creates raw socket attached to eBPF filterAF_PACKET socket with ETH_P_ALL protocol bindingFilter-only mode (no packet retrieval)Location: pkg/network/filter/socket_filter.go:35-61Packet Visitor PatternzeroCopyPacketReader interface for efficient readingAFPacketVisitor callback pattern for processingLocation: pkg/network/filter/packet_source_linux.go:1444.2 eBPF-Based Network MonitoringCore eBPF ProgramsConnection Tracer (eBPF):Type: ebpfTracer struct using cilium/ebpfTelemetry tracking:TCP/UDP sendsMiscountsFailed tuplesPID collisionsMetrics:Active connectionsUnbatched close eventsUDP sends processingLocation: pkg/network/tracer/connection/ebpf_tracer.go:1-100eBPF Source FilesLocated in pkg/network/ebpf/c/:FilePurposetracer.c Core connection tracking logic conntrack.c Connection state management runtime/usm.c Universal Service Monitoring (protocol analysis) co-re/tracer-fentry.c CO-RE (Compile-Once Run-Everywhere) support runtime/offset-guess.c Kernel structure offset detection prebuilt/dns.c DNS packet filtering and collection Probe TypesKProbes: Linux kernel probes (syscall-level interception)Fentry: eBPF function entry tracing (Linux 5.8+)uProbes: User-space function tracingTracepoints: Static kernel tracepoints4.3 Connection TrackingConnection State ManagementState Interface:Tracks stateful connection data per clientManaged with telemetry deltasClosed connection buffer managementStatistics cookies for deduplicationLocation: pkg/network/state.go:76-116Connection Data StructureConnectionStats:Comprehensive connection metricsSent/received bytes and packets (StatCounters)Connection type: TCP/UDP enumConnection family: IPv4/IPv6Connection direction: INCOMING, OUTGOING, LOCAL, NONEConnections Wrapper:Includes DNS dataTelemetry informationUSM protocol dataLocation: pkg/network/event_common.go:1-200Conntrack IntegrationConntrackTuple:Network flow informationMethods: Family(), Type(), SourceAddress(), DestAddress()Full connection tuple with namespace trackingLocation: pkg/network/ebpf/conntrack.go:1-70eBPF-less Tracer (Alternative)Uses AF_PACKET for packet capture without eBPFTCP/UDP processor for protocol parsingConnection map tracking per packetLocation: pkg/network/tracer/connection/ebpfless_tracer.go:51-804.4 DNS MonitoringDNS Reverse ResolutiondnsMonitor:Wraps socket filter snooperSupports both classic BPF and eBPF filteringFalls back to classic BPF on pre-4.1.0 kernelsInitialization:NewReverseDNS(): Initializes DNS snooping in root namespaceLocation: pkg/network/dns/monitor_linux.go:27-98DNS Packet SnoopingsocketFilterSnooper:DNS traffic interceptionReverse DNS Cache: 100K entries, 1-minute TTLStats: Queries, successes, errors, dropped packetsTelemetry: Decoding errors, truncated packets, domain collectionLocation: pkg/network/dns/snooper.go:45-100DNS ParserDNS packet parsing and response matchingDomain name extractionQuery/response correlationLocation: pkg/network/dns/parser.go4.5 HTTP/HTTPS Traffic AnalysisProtocol Dispatcherprotocol struct:HTTP protocol monitoringIn-flight request tracking mapEvent batching and state managementScratch buffer for packet inspectionLocation: pkg/network/protocols/http/protocol.go:32-80HTTP/2 SupportDynamic table for HPACK decompressionStream state trackingLatency measurementLocation: pkg/network/protocols/http2/protocol.goSupported ProtocolsAll located in pkg/network/protocols/:HTTP:Files: http/statkeeper.go, http/model.go, http/stats.goTLS support: http/tls_counter.go, http/tls_counter_linux.goStatus code tracking, latency quantizationHTTP/2:Directory: http2/Kafka:Files: kafka/statkeeper.go, kafka/protocol.go, kafka/client.go, kafka/server.goRedis:Files: redis_monitor_test.goPostgreSQL:Directory: postgres/gRPC:Supported via HTTP/2 trackingAMQP:Directory: amqp/TLS/SSL MonitoringTLS certificate extraction and analysisEncrypted traffic identificationLocation: pkg/network/protocols/tls/4.6 Service Mesh MonitoringIstio IntegrationistioMonitor:Monitors Istio sidecar proxy (Envoy)uProbes: SSL_read, SSL_write, SSL_do_handshake, SSL_set_bio, SSL_shutdownShared libraries mapping for Envoy/OpenSSL trackingLocation: pkg/network/usm/istio.go:1-100Envoy MonitoringIntegrated via Istio supportDetects encrypted connections via uProbes on TLS functions4.7 Packet Capture and Socket MonitoringRaw Socket BindingRaw socket creation: AF_PACKET, SOCK_RAW, ETH_P_ALLeBPF filter attachment via file descriptorNetwork namespace isolationLocation: pkg/network/filter/socket_filter.go:39-61Perf Ring BuffersEvent delivery mechanism from kernel to userspaceFixed-size perf buffersLocation: pkg/ebpf/perf_ring_buffer.goProtocol Event ConsumerBatch event processingWorker pool for protocol analysisAdaptive sampling based on loadLocation: pkg/network/protocols/events/consumer.go4.8 System-Probe Module IntegrationNetwork Tracer ModuleFunction: createNetworkTracerModule() - entry pointFeatures:Exposes HTTP endpoints: /connections, /network_id, etc.Concurrent request limitingSupports NPM (Network Performance Monitoring) and USM modesLocation: cmd/system-probe/modules/network_tracer.go:43-100USM EndpointsHTTP debug endpoints for protocol monitoring:/debug/http_monitoring - HTTP traffic analysis/debug/usm_telemetry - USM-specific metricsLocation: cmd/system-probe/modules/usm_endpoints_common.go:21-404.9 Connection Tracer InterfaceTracer InterfaceMethods:Start(), Stop()GetConnections()FlushPending()Remove()GetMap(), DumpMaps()Type(), Pause(), Resume()TracerType Enum:KProbePrebuiltKProbeRuntimeCompiledKProbeCOREFentryEbpflessLocation: pkg/network/tracer/connection/tracer.go:43-81Main TracerTracer struct:Orchestrates connection tracking, DNS resolution, USM monitoringComponents: ebpfTracer, usmMonitor, reverseDNS, conntracker, gwLookupUDP Connection Timeout: 120 seconds (configurable)Telemetry: Skipped connections, expired TCP conns, closed connsLocation: pkg/network/tracer/tracer.go:80-1004.10 Key Data FlowApplications (network activity)
         ↓
AF_PACKET Socket (RAW_SOCKET)
         ↓
eBPF SOCKET_FILTER / Headless Socket Filter
         ↓
Protocol Parsers (HTTP, HTTP/2, Kafka, Redis, DNS, etc.)
         ↓
Connection Tracker (KProbe/Fentry/eBPF-less)
         ↓
DNS Reverse Lookup
         ↓
Connection State Manager
         ↓
System-Probe Module
         ↓
HTTP Endpoints (/connections, /debug/http_monitoring)
         ↓
Agent Forwarding to Datadog5. KUBERNETES/CONTAINER DATA SOURCES5.1 Kubernetes API ServerAPI Endpoints QueriedPod Queries:/api/v1/pods?fieldSelector=spec.nodeName=%sFilters pods by node nameReturns pod specs, status, metadataEvent Watching:/api/v1/events?watch=true&resourceVersion=<rv>Watch pattern for real-time cluster eventsEvent streaming with resource version trackingDynamic Resources:Custom resource queries via client-go's dynamic interfaceClients:kubernetes.Interface - Standard Kubernetes clientdynamic.Interface - Dynamic resource clientscale.ScalesGetter - Scale subresource clientQPS Limits:Informer: 5 QPSStandard: 10 QPSController: 150 QPSAuthentication:Bearer tokensClient certificatesTLS verificationLocation: pkg/util/kubernetes/apiserver/apiserver.go5.2 Kubelet API EndpointsKubelet HTTP EndpointsEndpoints:/pods - Full pod list on node/stats/summary - Node and container statistics/metrics - Prometheus-format metrics/configz - Kubelet configuration/spec - Connection test endpointPod Resources API:Protocol: gRPCSocket: /var/lib/kubelet/pod-resources/kubelet.sockData: Device allocations, CPU/memory topologyFallback Mechanism:Can fallback to API server query: /api/v1/pods?fieldSelector=spec.nodeName=%sConfigurable via kubelet_use_api_serverLocation: pkg/util/kubernetes/kubelet/kubelet_client.go5.3 Container Runtime Interface (CRI)CRI ClientProtocol: gRPC over Unix socketConfiguration: cri_socket_path (configurable)Operations:GetContainerStats(containerID) - Single container statisticsListContainerStats() - All container statisticsRuntime version detectionSupported Runtimes:containerdCRI-ODocker (via CRI shim)Location: pkg/util/containers/cri/util.go5.4 Container Metrics CollectorsDocker CollectorData Source: Docker daemon socketDefault: /var/run/docker.sockProtocol: HTTP over Unix socketMetrics:Container CPU usageMemory usage (RSS, cache, swap)Network I/OBlock I/OLocation: pkg/util/containers/metrics/docker/collector.goContainerd CollectorData Source: Cgroup v1/v2 filesystemDirect cgroup reads for metricsMetrics:CPU usage from cpu.statMemory from memory.stat, memory.currentI/O from io.statLocation: pkg/util/containers/metrics/containerd/collector.goKubelet CollectorData Source: Kubelet /stats/summary endpointMetrics:Container-level statsPod-level aggregatesNode-level statsVolume usageLocation: pkg/util/containers/metrics/kubelet/collector.goCRI CollectorData Source: CRI gRPC APIMetrics:Container stats via ContainerStats RPCFilesystem usageCPU and memory usageLocation: pkg/util/containers/metrics/cri/collector.go5.5 Cluster Agent API EndpointsMetadata EndpointsLocation: cmd/cluster-agent/api/v1/kubernetes_metadata.goEndpoints:EndpointPurposeData Returned/api/v1/tags/pod/{nodeName}/{ns}/{podName} Pod metadata Tags, labels, annotations /api/v1/tags/node/{nodeName} Node labels Node tags and labels /api/v1/tags/namespace/{ns} Namespace labels Namespace tags /api/v1/metadata/namespace/{ns} Namespace metadata Annotations and labels /api/v1/annotations/node/{nodeName} Node annotations Node annotations /api/v1/cluster/id Cluster identification Cluster ID /api/v1/uid/node/{nodeName} Node UID Node unique identifier /api/v1/languagedetection APM language detection Detected languages in pods /api/v2/series Metrics collection Time series data 5.6 Orchestrator MetadataResource TypesLocation: pkg/orchestrator/model/types.goSupported Kubernetes Resources:K8sPodK8sNodeK8sServiceK8sDeploymentK8sStatefulSetK8sDaemonSetK8sJobK8sCronJobK8sReplicaSetK8sHPA (Horizontal Pod Autoscaler)K8sVPA (Vertical Pod Autoscaler)K8sNetworkPolicyK8sEndpointSliceK8sIngressK8sPersistentVolumeK8sPersistentVolumeClaimK8sRoleK8sRoleBindingK8sClusterRoleK8sClusterRoleBindingK8sServiceAccount5.7 Key Configuration ParametersKubernetes API ServerParameterDescriptionkubernetes_api_server_url API server address kubernetes_kubeconfig_path Kubeconfig file path kubernetes_http_kubelet_port Kubelet HTTP port (10255) kubernetes_https_kubelet_port Kubelet HTTPS port (10250) Kubelet ConfigurationParameterDescriptionkubelet_url Kubelet URL override kubelet_port Kubelet port kubelet_tls_verify Verify kubelet TLS kubelet_client_ca CA cert for kubelet kubelet_client_crt Client cert for kubelet kubelet_client_key Client key for kubelet kubelet_use_api_server Redirect pod queries to API server kubelet_cache_pods_duration Pod list cache TTL CRI ConfigurationParameterDescriptioncri_socket_path CRI socket location cri_connection_timeout Connection timeout cri_query_timeout Query timeout 5.8 Container ID ExtractionContainer ID FormatsDocker: docker://<container-id>containerd: containerd://<container-id>CRI-O: cri-o://<container-id>Extraction MethodsFrom cgroup paths: /kubepods/<qos>/<pod-id>/<container-id>From pod status: containerStatuses[].containerIDFrom CRI queries: Direct container ID from runtime6. LOG COLLECTION DATA SOURCES6.1 File Tailing MechanismsFile Tailer ImplementationLocation: pkg/logs/tailers/file/tailer.goFeatures:File Offset Tracking: lastReadOffset, decodedOffsetPlatform-Specific: Windows/Unix implementationsFile Rotation Detection: Inode/fingerprint trackingFingerprinting: Track files across rotationsConfigurable Polling: sleepDuration between readsThread Safety:Atomic operations for offset tracking (lines 48-54)Decoder Integration:Parses raw bytes into log messages (line 78)Timeouts:Unix: Rotation detection timeoutWindows: File locking timeoutFile ProviderLocation: pkg/logs/launchers/file/provider/file_provider.goFeatures:Wildcard Pattern Matching: *.log, /var/log/**/*.logSelection Strategies:By modification timeBy name (alphabetical)File Discovery: Periodic scanning for new filesUpdate Mechanisms: Dynamic file addition/removal6.2 Container Log Collection (stdout/stderr)Container TailerLocation: pkg/logs/tailers/container/tailer.goInterfaces:DockerContainerLogInterface: Docker API integration (lines 42-43)Kubelet API: Log streaming (lines 45-54)Docker API: Log streaming (lines 56-68)Features:Multi-container log demultiplexing (lines 70-77)Docker log format parsingStdout/stderr stream separationContainer Runtime SupportLocation: pkg/logs/launchers/container/launcher.go:27-35Supported Runtimes:Docker (via Docker API)Kubernetes/Kubelet (kubelet.StreamLogs)containerdPodmanCRI-OLog FramingLocation: pkg/logs/internal/framer/docker_stream.goDocker Stream Format:Header parsing for stdout/stderr demultiplexingStream byte identification:0x01: stdout0x02: stderrSize prefix for message framing6.3 Journald IntegrationJournald TailerLocation: pkg/logs/tailers/journald/tailer.go:1-59Library: github.com/coreos/go-systemd/sdjournal (line 17)Configuration (lines 37-48):Include/exclude filters for system unitsInclude/exclude filters for user unitsJournal path specificationFeatures:Structured JSON message processing (line 52-56)Dynamic tag provider integration (line 54-56)Noop decoder (journald provides structured logs) (line 78)Processing Rules:Exclude specific system units (lines 43-47)Exclude specific user unitsJournald LauncherLocation: pkg/logs/launchers/journald/launcher.go:1-80Factory Pattern:SDJournalFactory for creating journal instances (lines 33-40)Launcher initialization with factory (lines 55-67)Dynamic tailer creation (lines 71-76)6.4 Windows Event LogWindows Event TailerLocation: pkg/logs/tailers/windowsevent/tailer.go:1-80Build Tag: //go:build windows (line 6)Configuration (lines 36-41):Channel path specificationQuery specificationImplementation (lines 44-60):Event subscription managementBookmark support for position trackingEvent rendering contextAPIs Used (lines 29-32):winevtapi - Windows Event Log API wrapperevtsubscribe.PullSubscription - Pull-based subscriptionsevtbookmark.Bookmark - Position trackingWindows Event LauncherLocation: pkg/logs/launchers/windowsevent/launcher.goPlatform-Specific: Windows-only with no-op for other systems6.5 TCP/UDP Log ListenersTCP Log ListenerLocation: pkg/logs/launchers/listener/tcp.go:1-80Structure (lines 23-34):TCPListener with connection managementMultiple concurrent connections supportedImplementation (lines 36-68):TCP listener initialization and startListening on configurable portTailer per connection (lines 74-87)UDP Log ListenerLocation: pkg/logs/launchers/listener/udp.go:1-77Limitations (lines 19-28):UDP buffering explanationMessage boundary considerationsStructure (lines 31-46):UDPListener with frameSize configurationImplementation (lines 49-77):UDP connection setupSocket tailer delegationSocket TailerLocation: pkg/logs/tailers/socket/tailer.go:1-80Generic Handler (lines 26-34):Handles both TCP and UDPProtocol-specific reading callback (lines 37-48)Lifecycle (lines 51-62):Start/Stop management6.6 Cloud Provider Log IntegrationsNote on Cloud Provider IntegrationCloud provider integrations are NOT native data sources. Instead, supported through:TCP/UDP listeners - For syslog-style forwardingIntegration launchers - For application-level collectionChannel-based ingestion - For serverless environmentsChannel-Based Tailer (Serverless)Location: pkg/logs/tailers/channel/tailer.go:1-50Environment Variables (lines 19-26):DD_SERVICE - Service nameK_SERVICE - Knative serviceCONTAINER_APP_NAME - Container app nameStructure (lines 28-38):Channel-based tailer for serverless integrationUse Cases:AWS Lambda (via DD_LAMBDA_HANDLER wrapper)Azure Container AppsGoogle Cloud Functions6.7 Syslog SupportImplementation MethodsUDP Listener: Port 514 (default) - RFC 3164 formatTCP Listener: TCP syslog transportSyslog Message ParsingMessage parsing happens in decoder layerSupports both UDP and TCP transportsLocation: pkg/logs/launchers/listener/6.8 Integration Log CollectionIntegration LauncherLocation: pkg/logs/launchers/integration/launcher.go:1-435Purpose:Integration checks write logs to filesTemporary files in /var/run/datadog/integrations/File launcher tails these filesFeatures (lines 72-142):Disk usage management with configurable limitsRuntime log file creation and managementLog size enforcement and rotation (lines 187-253)Automatic source conversion to file sources (lines 308-321)6.9 Log Source Type RegistryLocation: comp/logs/agent/config/integration_config.go:19-37const (
    TCPType           = "tcp"               // TCP Network listener
    UDPType           = "udp"               // UDP Network listener
    FileType          = "file"              // File tailing
    DockerType        = "docker"            // Docker container logs
    ContainerdType    = "containerd"        // Containerd logs
    JournaldType      = "journald"          // Systemd journal logs
    IntegrationType   = "integration"       // Integration file logs
    WindowsEventType  = "windows_event"     // Windows Event Log
    StringChannelType = "string_channel"    // Channel-based ingestion
)6.10 Processing PipelineOverall ArchitectureTailers (raw data)
  ↓
Decoders (parse bytes)
  ↓
Framing Layer (protocol-specific)
  ↓
Parsers (extract metadata)
  ↓
Message Forwarding (output channels)LogSource ManagementLocation: pkg/logs/sources/source.go:1-205LogSource structure manages lifecycleStatus trackingParent/child source relationshipsTracks bytes read and processing info6.11 Launcher OrchestrationLocation: pkg/logs/launchers/launchers.go:1-83All Launchers Managed:File launcherContainer launcher (Docker/Kubernetes/Containerd/Podman/CRI-O)Journald launcherWindows Event launcherListener launcher (TCP/UDP)Integration launcherChannel launcher (serverless)Lifecycle:Started/stopped with agentDynamic launcher addition (lines 55-61)6.12 Summary TableSource TypeLauncherTailerNetworkPlatformKey FeaturesFiles file/launcher.go file/tailer.go No All Rotation, Fingerprinting, Wildcards Docker container/launcher.go container/tailer.go Docker API Linux/Mac Stdout/Stderr demux, Multi-container Kubernetes container/launcher.go container/tailer.go Kubelet API K8s Pod log streaming Journald journald/launcher.go journald/tailer.go No Linux (systemd) Structured logs, Unit filtering Windows Event windowsevent/launcher.go windowsevent/tailer.go No Windows Event subscriptions, Bookmarks TCP listener/launcher.go socket/tailer.go TCP All Network syslog, Variable framesize UDP listener/launcher.go socket/tailer.go UDP All Syslog, Port-based Integration integration/launcher.go file/tailer.go No All Temporary file write, Disk quota Channel channel/launcher.go channel/tailer.go In-memory All Serverless, AWS Lambda 7. SECURITY MONITORING DATA SOURCES7.1 Cloud Workload Security (CWS) - Runtime SecurityCWS Consumer ModuleLocation: pkg/security/module/cws.goArchitecture:Orchestrates event collection from eBPF probesEvaluates events against SECL rulesSends anomaly events to DatadogIntegration:Rate limiting for event suppressionSelf-testing framework for monitoring healthContainer running telemetry trackingServer: gRPC server for CWS communicationLocation: pkg/security/module/server.go7.2 Event Types (Comprehensive Event Model)Location: pkg/security/secl/model/events.goFile Operations (43+ Event Types)File Integrity Monitoring (FIM):FileOpenEventType - File opens with permissions trackingFileChmodEventType - Permission changesFileChownEventType - Owner/group changesFileRenameEventType - File/directory renamesFileUnlinkEventType - File deletionsRmdirEventType - Directory deletionsFileLinkEventType - Hard link creationFileSetXAttrEventType - Extended attribute changesFileRemoveXAttrEventType - Extended attribute removalFileChdirEventType - Directory changesFileUtimesEventType - Timestamp modificationsProcess MonitoringForkEventType - Process fork eventsExecEventType - Process executionExitEventType - Process exitSetuidEventType - Privilege elevation (setuid)SetgidEventType - Privilege elevation (setgid)CapsetEventType - Capability modificationsArgsEnvsEventType - Command arguments and environment variablesMount/Volume OperationsFileMountEventType - Mount operationsFileUmountEventType - Unmount operationsFileFsmountEventType - Filesystem mount eventsFileOpenTreeEventType - Open tree operationsFileMoveMountEventType - Mount movesMountReleasedEventType - Mount release detectionUnshareMountNsEventType - Mount namespace unshareNetwork MonitoringAcceptEventType - Server socket acceptsBindEventType - Socket bind eventsConnectEventType - Client connectionsDNSEventType - DNS queriesShortDNSResponseEventType - Short DNS responsesFullDNSResponseEventType - Full DNS responsesFailedDNSEventType - Failed DNS queriesNetDeviceEventType - Network device eventsVethPairEventType - Virtual ethernet pair creationVethPairNsEventType - Virtual ethernet namespace movesNetworkFlowMonitorEventType - General network flow monitoringRawPacketFilterEventType - Raw packet capture/filteringSystem Security MonitoringSELinuxEventType - SELinux policy enforcement/changesBPFEventType - BPF program loading/unloadingPTraceEventType - Process tracing activitySignalEventType - Signal deliveryPrCtlEventType - prctl() system calls (process control)SysCtlEventType - sysctl configuration changesSetrlimitEventType - Resource limit modificationsMemory OperationsMMapEventType - Memory mappingMProtectEventType - Memory protection changesModule ManagementLoadModuleEventType - Kernel module loadingUnloadModuleEventType - Kernel module unloadingSpecial MonitoringSpliceEventType - Splice system call activityIMDSEventType - AWS IMDS request/response monitoringOnDemandEventType - On-demand event collectionLoginUIDWriteEventType - Login UID write eventsCgroupTracingEventType - Cgroup tracing startCgroupWriteEventType - Cgroup creation/modification7.3 eBPF Security Probes (48+ Modules)Location: pkg/security/ebpf/probes/Core File System Probesopen.go - File open operationsdentry.go - Dentry/path resolutionexec.go - Process executionmount.go - Mount/filesystem operationslink.go - Link/symlink operationsunlink.go - File deletionrename.go - File/directory renameschmod.go - Permission changeschown.go - Ownership changessetxattr.go - Extended attributesutimes.go - Timestamp modificationsSecurity-Focused Probesptrace.go - Process tracing (debug/inspection)bpf.go - BPF operationsselinux.go - SELinux policy enforcementcapabilities.go - Capability usagesignal.go - Signal deliveryperf_event.go - Performance monitoringNetwork Probesconnect.go - TCP/UDP connectionsbind.go - Socket bindingaccept.go - Connection acceptssetsockopt.go - Socket optionsflow.go - Network flow trackingrawpacket.go - Raw packet capturetc.go - Traffic controlSystem Probe Modulessyscall_monitor.go - System call monitoringioctl.go - ioctl operationsiouring.go - IO_URING operationsmodule.go - Kernel module operationsmmap.go - Memory mappingmprotect.go - Memory protectionprctl.go - Process controlsysctl.go - System controlsetrlimit.go - Resource limits7.4 File Integrity Monitoring (FIM)Location: pkg/security/secl/rules/fim_unix.goLocation: pkg/security/secl/rules/fim_others.goLocation: pkg/security/ptracer/fim_handlers.goMonitoring ScopeFile creation/modification timestampsFile permission changes (chmod)File ownership changes (chown)Extended attributes (xattr)Hard linksSymbolic linksFile deletions7.5 Process Monitoring (PTracer)Location: pkg/security/ptracer/ptracer.goPTracer-Based MonitoringComponents:ptracer.go - Process tracer orchestrationfim_handlers.go - FIM event handlersprocess_handlers.go - Process lifecycle trackingnetwork_handlers.go - Network activity trackingexec.go - Execution trackingprocess.go - Process state managementData CapturedProcess command line argumentsEnvironment variablesFile access patterns (read/write/execute)Network socket operationsSystem call invocationsInter-process communication7.6 Compliance Scanning (CSPM)Location: pkg/compliance/Framework Evaluatorsevaluator_xccdf.go - OpenSCAP/XCCDF evaluation for CIS benchmarksevaluator_rego.go - OPA/Rego policy evaluationagent.go - Main compliance agent orchestrationData SourcesLinux Audit Framework (inputs_audits.go):File watch rules (fanotify/inotify)File permission monitoringRead/write/execute access trackingDocker/Container Compliance (inputs_docker.go):Container image scanningContainer configuration complianceKubernetes Configuration (k8sconfig/):Pod security policiesRBAC configurationsNetwork policiesDatabase Configuration (dbconfig/):Database security settingsPackage Manager Compliance (aptconfig/):APT package configuration complianceCheck ResultsCompliance status: pass/fail/error/unknownResource type and IDContainer metadata (if applicable)Kubernetes managed statusCustom data fields7.7 Activity Dumps & Security ProfilesActivity Dump CollectionLocation: pkg/security/security_profile/ad.goLocation: pkg/security/security_profile/dump/activity_dump.goLocation: pkg/security/security_profile/activity_tree/activity_tree.goFeatures:Event collection into profilesTree structure for workload activityTemporal ordering of eventsSecurity Profile ManagementLocation: pkg/security/security_profile/profile/profile.goLocation: pkg/security/security_profile/manager.goLocation: pkg/security/security_profile/secprofs.goProfile Data:Event type trackingSyscall usage patternsContainer image versionsWorkload selector matchingProfile lifecycle managementSecurity profile persistenceData Captured in ProfilesSyscalls invoked by workloadsFile access patternsNetwork connection patternsProcess execution chainsContainer metadata (image, tag, ID)Event type filtering state7.8 Event Resolvers (Data Enrichment)Location: pkg/security/resolvers/Resolver TypesResolverPurposeprocess/ Process cache and metadata cgroup/ Cgroup to workload mapping file/ File metadata and hashing hash/ File hash computation mount/ Mount point resolution dentry/ Filesystem path resolution dns/ DNS query/response tracking path/ Path normalization tags/ Container/workload tagging container/ Container metadata resolution usergroup/ User/group name resolution selinux/ SELinux context resolution tc/ Traffic control monitoring netns/ Network namespace mapping sbom/ Software Bill of Materials generation usersessions/ User session tracking 7.9 Probe Monitors (Event Flow Control)Location: pkg/security/probe/monitors/Monitor TypesSyscalls Monitor (syscalls/syscalls_monitor.go):Syscall event counting and statisticsDNS Monitor (dns/dns_monitor.go):DNS query monitoringCgroups Monitor (cgroups/cgroups_monitor.go):Cgroup lifecycle trackingDiscarder Monitor (discarder/discarder_monitor.go):Event filtering (discarders)Approver Monitor (approver/approver_monitor.go):Rule-based event approvalMetrics TrackedSyscalls in-flight by event typeDNS query/response patternsCgroup creation/destructionEvent discard ratesRule matching statistics7.10 Rules EngineLocation: pkg/security/rules/Components:engine.go - Rule evaluation enginemonitor/ - Rule performance monitoringautosuppression/ - Automatic event suppressionfiltermodel/ - Event filtering modelSECL (Security Expression Language)Rule-based event filtering and detectionContext-aware filtering based on:Process propertiesFile pathsNetwork endpointsContainer metadataUser/group information7.11 Windows Security MonitoringLocation: pkg/security/seclwin/model/Windows-Specific Data Sourcesmodel_win.go - Windows event modelevents.go - Windows event typesprobe_kernel_file_windows.go - Windows file system monitoringprobe_kernel_reg_windows.go - Windows registry monitoringprobe_auditing_windows.go - Windows audit integrationMonitored EventsFile creation/modification/deletionRegistry key/value changesProcess executionNetwork connectionsDLL loadingLocation: pkg/security/probe/probe_kernel_file_windows.goLocation: pkg/security/probe/probe_kernel_reg_windows.goLocation: pkg/security/probe/probe_auditing_windows.go7.12 Runtime Security ConfigurationLocation: pkg/security/config/config.goFeatures TrackedRuntime security enablement statusFile Integrity Monitoring (FIM) statusSelf-test execution and validationKernel hardening configuration flags (100+ kernel configs):Memory management hardeningStack protection mechanismsASLR and DEP settingsModule signature verificationSELinux/AppArmor/Landlock configuration7.13 Summary TableCategoryImplementationKey MonitoringCWS Runtime eBPF probes + PTracer Processes, files, network, syscalls FIM File system probes File modifications, permissions, attributes CSPM XCCDF + Rego evaluators Compliance benchmarks, configurations Process Security PTracer + exec probes Command execution, privilege escalation Network Security eBPF network probes Connections, DNS, raw packets Activity Dumps Tree-based aggregation Workload behavior profiles Compliance Audit framework + Docker API System and container compliance Event Enrichment Multiple resolvers Process context, file metadata, tags 8. CLOUD PROVIDER INTEGRATIONS8.1 AWS (EC2/ECS/Fargate)Instance Metadata Service (IMDS)Base URL: <http://169.254.169.254>IMDS EndpointsInstance Metadata:/latest/meta-data/instance-id - Instance identifier/latest/meta-data/hostname - Instance hostname/latest/meta-data/public-ipv4 - Public IP address/latest/meta-data/placement/region - AWS region/latest/meta-data/placement/availability-zone - AZNetwork Information:/latest/meta-data/network/interfaces/macs - List of MAC addresses/latest/meta-data/network/interfaces/macs/{mac}/vpc-id - VPC ID/latest/meta-data/network/interfaces/macs/{mac}/subnet-id - Subnet ID/latest/meta-data/network/interfaces/macs/{mac}/subnet-ipv4-cidr-block - Subnet CIDR/latest/meta-data/network/interfaces/macs/{mac}/vpc-ipv4-cidr-blocks - VPC IPv4 CIDRs/latest/meta-data/network/interfaces/macs/{mac}/vpc-ipv6-cidr-blocks - VPC IPv6 CIDRsTags and Credentials:/latest/meta-data/tags/instance - Instance tags/latest/meta-data/iam/security-credentials/ - IAM role informationInstance Identity:/latest/dynamic/instance-identity/document/ - Instance identity (region, accountID, instanceID)IMDSv2 Token Endpoint:/latest/api/token - Token retrieval (PUT request)Header: X-aws-ec2-metadata-token-ttl-seconds: <seconds>Location: pkg/util/ec2/internal/imds_helpers.goLocation: pkg/util/ec2/network.goLocation: pkg/util/ec2/tags/ec2_tags.goIMDSv2 AuthenticationToken obtained via PUT request to /latest/api/tokenToken TTL configurable (default: ec2_metadata_token_lifetime)All subsequent requests include header: X-aws-ec2-metadata-token: <token>ECS/Fargate MetadataEnvironment Variables:ECS_CONTAINER_METADATA_URI - v3 API endpointECS_CONTAINER_METADATA_URI_V4 - v4 API endpointECS_CONTAINER_AUTHORIZATION_TOKEN - Authentication tokenEndpoints:/task - Task metadata/taskWithTags - Task metadata with propagated resource tags/ - Container metadata (root path)Location: pkg/util/ecs/metadata/v3or4/client.goAWS SDK IntegrationsRDS API:DescribeDBInstances - Database discovery and metadataTag-based filtering for database instancesEC2 API:DescribeTags - Retrieving EC2 instance tagsAutomatic credential detection via instance roleLocation: pkg/databasemonitoring/aws/rds.go8.2 AzureAzure Instance Metadata ServiceBase URL: <http://169.254.169.254>Required Header: Metadata: trueAzure IMDS EndpointsCompute Metadata:/metadata/instance/compute?api-version=2017-08-01 - Full compute metadata/metadata/instance/compute/vmId?api-version=2017-04-02&format=text - VM identifier/metadata/instance/compute/resourceGroupName?api-version=2017-08-01&format=text - Resource group/metadata/instance/compute/resourceId?api-version=2021-02-01&format=text - Canonical Cloud Resource IDNetwork Metadata:/metadata/instance/network/interface/0/ipv4/ipAddress/0/publicIpAddress?api-version=2017-04-02&format=text - Public IPAzure ConfigurationHostname Styles:vmid - Use VM ID as hostnamename - Use VM namename_and_resource_group - Combine name and RGfull - Full Azure resource pathConfiguration: azure_hostname_styleResource ID Handling: Lower-cased for case-insensitive comparisonLocation: pkg/util/cloudproviders/azure/azure.go8.3 Google Cloud Platform (GCP)GCP Compute MetadataBase URL: <http://169.254.169.254/computeMetadata/v1>Required Header: Metadata-Flavor: GoogleGCP Metadata EndpointsInstance Metadata:/instance/hostname - Instance hostname/instance/name - Instance name/instance/zone - Instance zone (format: projects/PROJECT_NUM/zones/ZONE)Network Metadata:/instance/network-interfaces/ - List of network interfaces/instance/network-interfaces/{interface}/network - VPC network ID/instance/network-interfaces/{interface}/access-configs/0/external-ip - Public IPCluster Metadata:/instance/attributes/cluster-name - Kubernetes cluster nameProject Metadata:/project/project-id - GCP project IDRecursive Metadata:/?recursive=true - Full recursive metadata dumpReturns instance tags, instance type, internal hostname, project infoGCP ConfigurationTag Exclusion:exclude_gce_tags - Exclude specific tags from collectionLocation: pkg/util/cloudproviders/gce/gce.goLocation: pkg/util/cloudproviders/gce/gce_tags.go8.4 Other Cloud ProvidersAlibaba CloudBase URL: <http://100.100.100.200>Endpoints:/latest/meta-data/instance-id - Instance identifierNTP Servers: Multiple ntp*.aliyun.com endpointsLocation: pkg/util/cloudproviders/alibaba/alibaba.goTencent CloudBase URL: <http://169.254.0.23>Endpoints:/meta-data/instance-id - Instance identifierNTP: ntpupdate.tencentyun.comLocation: pkg/util/cloudproviders/tencent/tencent.goOracle CloudBase URL: <http://169.254.169.254>Authentication Header: Authorization: Bearer OracleEndpoints:/opc/v2/instance/id - Instance identifier/opc/v2/instance/id - Canonical Cloud Resource ID (CCRID)Location: pkg/util/cloudproviders/oracle/oracle.goIBM CloudBase URL: <http://169.254.169.254>Token Endpoint:/instance_identity/v1/token?version=2022-03-08 (PUT request)Instance Endpoint:/metadata/v1/instance?version=2022-03-08Headers:Token header: Authorization: Bearer <token>Metadata header: Metadata-Flavor: ibmLocation: pkg/util/cloudproviders/ibm/ibm.go8.5 Data Sources and CachingCaching MechanismAll metadata fetches use cachedfetch.Fetcher with caching to handle:Quota exhaustionTemporary endpoint unavailabilityConcurrent requestsTimeout ConfigurationsProviderConfig KeyUnitEC2 ec2_metadata_timeout milliseconds Azure azure_metadata_timeout milliseconds GCP gce_metadata_timeout milliseconds IBM ibm_metadata_timeout seconds Max Hostname Size LimitsConfiguration: metadata_endpoints_max_hostname_sizeApplied across all cloud providers8.6 Detection StrategyCloud Detection OrderEC2/AWS (IMDS v2 first, then v1, then DMI)GCP (hostname endpoint)Azure (IMDS)AlibabaTencentOracleIBMCloud FoundryKubernetesLocation: pkg/util/cloudproviders/cloudproviders.go8.7 Critical Metadata CollectedCommon Across All ProvidersInstance IDHostnamePublic IP addressRegion/zoneNetwork/VPC IDInstance tagsAccount/Project IDCanonical Cloud Resource ID (CCRID)AWS-SpecificSecurity credentials from instance roleInstance identity document (region, accountID, instanceID)VPC subnet CIDR blocksContainer instance ARN (for ECS)RDS database instances (tag-based discovery)GCP-SpecificMachine typeProject ID (numeric and string)Custom instance attributesKubernetes cluster name8.8 Key Integration PointsIntegration StrategiesMetadata Endpoints - Lightweight HTTP calls for instance metadataCredential Discovery - Instance roles/managed identities for API accessTag-based Discovery - Finding related resources (RDS, databases, etc.)Fallback Mechanisms - Multiple methods (IMDS v1/v2, DMI, UUID)Caching - To handle rate limiting and availability issuesConfiguration ControlAll endpoints are configurable and can be disabled per cloud provider via the configuration system.9. AUTODISCOVERY MECHANISMS9.1 Service Listener TypesLocation: comp/core/autodiscovery/listeners/1. Container ListenerFile: container.goFunctionality:Monitors Docker containers via workloadmetaExtracts ports, tags, network infoSupports Docker labels for AD identifiers2. Kubernetes Endpoints ListenerFile: kube_endpoints.goFunctionality:Watches Kubernetes Endpoints resourcesAuto-discovers services on clusterMatches with Prometheus annotations3. Kubernetes Services ListenerFile: kube_services.goFunctionality:Monitors Kubernetes Service objectsExtracts endpoints and ports4. RDS Database ListenerFile: dbm_rds.goAWS-Specific Features:Discovers RDS/Aurora instancesPolls AWS API for database instancesRegion-aware discoverySupports auto-generated MySQL/PostgreSQL checks5. SNMP ListenerFile: snmp.goFunctionality:Auto-discovers SNMP devicesSubnet-based discovery6. Static Config ListenerFile: staticconfig.goFunctionality:File-based configuration parsing7. Environment ListenerFile: environment.goFunctionality:Environment variable-based configuration9.2 Autodiscovery FlowService Detection (Listener)
  ↓
AD Identifier Matching
  ↓
Template Resolution (%%host%%, %%port%%)
  ↓
Check Configuration Generation
  ↓
Check Scheduling
  ↓
Metric CollectionSummary StatisticsTotal Data Source Categories9 major categories covering:Push-based workloads (DogStatsD, APM, OTLP)System-level data (proc, sys, cgroups, eBPF)Check/integration-based (databases, SNMP, JMX, HTTP)Network monitoring (eBPF packet capture, protocol analysis)Kubernetes/container (API server, kubelet, CRI, metrics)Log collection (file, container, journald, Windows, syslog)Security monitoring (CWS, FIM, CSPM, process tracing)Cloud providers (AWS, Azure, GCP, Alibaba, Tencent, Oracle, IBM)Autodiscovery (7 listener types)Network Ports SummaryPortProtocolPurpose8125 UDP/UDS DogStatsD metrics 8126 HTTP/TCP APM traces and profiling Configurable gRPC OTLP receiver 161 UDP SNMP polling 123 UDP NTP time synchronization 3306 TCP MySQL database 5432 TCP PostgreSQL database 514 UDP/TCP Syslog Configurable TCP/UDP Custom log listeners Key Technology StackeBPF - Kernel-level monitoring and network traffic analysisgRPC - Container runtime communication (CRI)HTTP/REST - Cloud metadata, Kubernetes APIs, check integrationsUnix Sockets - Low-latency local communication (DogStatsD, APM)Memory-Mapped Buffers - High-performance packet capturePerf Ring Buffers - Efficient kernel-to-userspace event deliveryPrometheus - Metrics scraping from HTTP endpointsSNMP - Network device monitoringJMX - Java application monitoringsystemd Journal - Linux log collectionWorkload Capture RelevanceFor the Innovation Week project focused on dogstatsd and APM workload capture:Primary SourcesDogStatsD listeners: UDP (8125), UDS datagram, UDS streamAPM HTTP receivers: Port 8126, multiple protocol versionsOrigin detection: Container ID tagging via SO_PASSCREDSupporting ContextContainer metadata (Docker, containerd, Kubernetes)Pod labels and annotationsProcess information (PID, command line, environment)Network connection dataPerformance Impact FactorsTag cardinality - Number of unique tag combinationsContext count - Unique metric name + tag combinationsConnection rates - New connections per secondMessage rates - Metrics/traces per secondMessage size - Payload sizes for aggregationExisting InfrastructureWorkload-capture-proxy feature: Already implemented in operatorLocation: internal/controller/datadogagent/feature/workloadcaptureproxy/Intercepts DogStatsD traffic before reaching agentData flow: Apps → UDS → Proxy → Agent/ADPProvides perfect visibility for workload analysisConclusionThis comprehensive catalog documents all data sources in the Datadog Agent, compiled entirely from code analysis with specific file paths and line numbers. The agent's architecture enables monitoring across infrastructure, applications, logs, security, and cloud platforms through a combination of:Push-based ingestion for application telemetryPolling-based collection for infrastructure and integrationseBPF-based monitoring for kernel-level visibilityCloud provider integrations for metadata enrichmentAutodiscovery for dynamic configurationFor the workload capture project, the focus areas are DogStatsD (port 8125) and APM (port 8126) data sources, with supporting context from container, Kubernetes, and process metadata sources.