# Lima VM configuration for MCP evaluation - TOOLS MODE
# Start with: limactl start lima-tools.yaml --name mcp-eval-tools
# Shell into VM: limactl shell mcp-eval-tools

vmType: vz

images:
  # Fedora 42 (ships with kernel 6.14+)
  - location: "https://download.fedoraproject.org/pub/fedora/linux/releases/42/Cloud/x86_64/images/Fedora-Cloud-Base-Generic-42-1.1.x86_64.qcow2"
    arch: "x86_64"
  - location: "https://download.fedoraproject.org/pub/fedora/linux/releases/42/Cloud/aarch64/images/Fedora-Cloud-Base-Generic-42-1.1.aarch64.qcow2"
    arch: "aarch64"

# CPUs and Memory
cpus: 4
memory: "8GiB"
disk: "10GiB"

# No mounts - MCP directory will be copied on startup
mountType: virtiofs

# SSH settings
ssh:
  localPort: 0
  loadDotSSHPubKeys: true
  forwardAgent: true

# Network (user-v2 mode doesn't require socket_vmnet)
networks:
  - lima: user-v2

# Provision scripts
provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail

      # Update package list
      dnf update -y

      # Install basic tools (excluding golang - we'll install specific version)
      dnf install -y \
        @development-tools \
        gcc \
        make \
        pkg-config \
        libseccomp-devel \
        procps-ng \
        iproute \
        util-linux \
        strace \
        curl \
        git \
        wget \
        vim \
        htop \
        net-tools \
        bind-utils

      # Install Go 1.25.5
      GO_VERSION="1.25.5"
      GO_ARCH="arm64"  # aarch64 for Lima on Apple Silicon
      GO_TARBALL="go${GO_VERSION}.linux-${GO_ARCH}.tar.gz"
      GO_URL="https://go.dev/dl/${GO_TARBALL}"

      echo "Downloading Go ${GO_VERSION} for linux-${GO_ARCH}..."
      wget -q "${GO_URL}" -O "/tmp/${GO_TARBALL}"

      echo "Installing Go to /usr/local/go..."
      rm -rf /usr/local/go
      tar -C /usr/local -xzf "/tmp/${GO_TARBALL}"
      rm "/tmp/${GO_TARBALL}"

      # Add Go to system-wide PATH
      echo 'export PATH=$PATH:/usr/local/go/bin' > /etc/profile.d/golang.sh
      chmod +x /etc/profile.d/golang.sh

      # Verify Go installation
      /usr/local/go/bin/go version

      # Fix systemd-binfmt.service failures
      systemctl mask systemd-binfmt.service

      echo "Kernel version: $(uname -r)"
      KERNEL_VERSION=$(uname -r | cut -d. -f1,2)
      echo "Running kernel $KERNEL_VERSION"

      # Create eval-user for running safe-shell commands
      if ! id -u eval-user > /dev/null 2>&1; then
        useradd -m -s /bin/bash eval-user
        echo "Created eval-user for safe-shell command execution"
      fi

      # Configure sudoers to allow lima user to run safe-shell as eval-user without password
      echo "lima ALL=(eval-user) NOPASSWD: /usr/local/bin/safe-shell" > /etc/sudoers.d/safe-shell-eval
      chmod 0440 /etc/sudoers.d/safe-shell-eval
      echo "Configured sudoers for safe-shell execution as eval-user"

      echo "VM provisioning complete"

  - mode: user
    script: |
      #!/bin/bash
      set -eux -o pipefail

      # Set up user environment
      echo 'export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin' >> ~/.bashrc

      # Verify Go is accessible
      /usr/local/go/bin/go version

      echo "User environment setup complete"

# Port forwarding (for MCP server - TOOLS MODE)
portForwards:
  - guestPort: 8080
    hostPort: 8083
    proto: tcp

# Message to display when VM starts
message: |
  ┌─────────────────────────────────────────────┐
  │ MCP Evaluation VM - TOOLS MODE (Fedora 42)  │
  ├─────────────────────────────────────────────┤
  │ MCP directory: /mcp                         │
  │ Build server:  cd /mcp && make build        │
  │ Run server:    ./bin/mcp-server -mode tools │
  │ Port forward:  8083 (host) -> 8080 (guest)  │
  ├─────────────────────────────────────────────┤
  │ Kernel: 6.14+ (Fedora 42)                   │
  └─────────────────────────────────────────────┘
