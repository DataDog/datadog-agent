# Order Processor Scenario
#
# Deploys an order processing application with an internal payment service.
#
# Expected behavior:
# - Order processor handles incoming orders
# - Payment service processes payment requests
# - Initial period of normal operation
# - After ~30 seconds, behavior changes
# - CPU and memory usage patterns shift
# - Eventually pod may restart
#
# Observable in fine-grained-monitor:
# - Initial period of stable metrics (low CPU/memory)
# - Changepoint in resource usage after ~30 seconds
# - CPU spikes during processing
# - Memory gradually increasing over time
# - Application logs show payment processing attempts
# - Eventually OOM kill (exit code 137) may occur
# - Pod restarts and cycle repeats
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: order-processor-config
  labels:
    app: order-processor
data:
  # Script content will be injected from mock_service.py by cluster.py
  mock_service.py: __INJECT_SCRIPT__
  # Script content will be injected from app.py by cluster.py
  app.py: __INJECT_SCRIPT__
---
apiVersion: v1
kind: Pod
metadata:
  name: order-processor
  labels:
    app: order-processor
spec:
  restartPolicy: Always
  volumes:
    - name: scripts
      configMap:
        name: order-processor-config
        defaultMode: 0755
  containers:
    # External payment service
    - name: payment-service
      image: python:3.11-slim
      command: ["python3", "/scripts/mock_service.py"]
      volumeMounts:
        - name: scripts
          mountPath: /scripts
      ports:
        - containerPort: 8080
      resources:
        requests:
          memory: "32Mi"
          cpu: "10m"
        limits:
          memory: "128Mi"
          cpu: "100m"

    # Order processing application
    - name: processor
      image: python:3.11-slim
      command: ["python3", "/scripts/app.py"]
      volumeMounts:
        - name: scripts
          mountPath: /scripts
      resources:
        requests:
          memory: "64Mi"
          cpu: "50m"
        limits:
          memory: "256Mi"
          cpu: "200m"
