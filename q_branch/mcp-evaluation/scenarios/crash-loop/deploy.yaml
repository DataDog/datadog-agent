# Crash Loop Scenario
#
# Deploys a pod that crashes after a short delay,
# demonstrating Kubernetes restart backoff behavior.
#
# Expected behavior:
# - Container starts, runs for 5-15 seconds randomly
# - Exits with code 1 (simulated crash)
# - Kubernetes restarts with exponential backoff
# - Backoff increases: 10s, 20s, 40s, 80s... up to 5 minutes
# - After success streak, backoff resets
#
# Observable in fine-grained-monitor:
# - Exit code 1 on each crash
# - Increasing gaps between restarts (backoff visible)
# - CrashLoopBackOff status during backoff period
# - Restart count incrementing
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: batch-processor-config
  labels:
    app: batch-processor
data:
  # Script content will be injected from process.py by cluster.py
  process.py: __INJECT_SCRIPT__
---
apiVersion: v1
kind: Pod
metadata:
  name: batch-processor
  labels:
    app: batch-processor
spec:
  restartPolicy: Always
  volumes:
    - name: script
      configMap:
        name: batch-processor-config
        defaultMode: 0755
  containers:
    - name: processor
      image: python:3.11-slim
      command: ["python3", "/scripts/process.py"]
      volumeMounts:
        - name: script
          mountPath: /scripts
      resources:
        requests:
          memory: "32Mi"
          cpu: "10m"
        limits:
          memory: "64Mi"
          cpu: "100m"
