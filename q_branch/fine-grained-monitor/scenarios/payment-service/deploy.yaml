# Generated by k8s-adapter from Vibecoder output
# Scenario: payment-service



---
apiVersion: v1
kind: ConfigMap
metadata:
  name: fraud-db-config
  namespace: {{NAMESPACE}}
  labels:
    app: fraud-db
    scenario: payment-service
    fgm-run: "{{RUN_ID}}"
data:
  redis.conf: |
    # Redis configuration for database operations

    # Network
    bind 0.0.0.0
    protected-mode no
    port 6379
    tcp-backlog 511
    timeout 0
    tcp-keepalive 300

    # General
    daemonize no
    supervised no
    loglevel notice
    logfile ""

    # Snapshotting (RDB persistence)
    save 900 1
    save 300 10
    save 60 10000
    stop-writes-on-bgsave-error yes
    rdbcompression yes
    rdbchecksum yes
    dbfilename dump.rdb
    dir /data

    # Replication
    replica-serve-stale-data yes
    replica-read-only yes
    repl-diskless-sync no
    repl-diskless-sync-delay 5

    # Memory Management
    maxmemory-samples 5

    # Append Only File (AOF persistence)
    appendonly yes
    appendfilename "appendonly.aof"
    appendfsync everysec
    no-appendfsync-on-rewrite no
    auto-aof-rewrite-percentage 100
    auto-aof-rewrite-min-size 64mb
    aof-load-truncated yes
    aof-use-rdb-preamble yes

    # Lua scripting
    lua-time-limit 5000

    # Slow log
    slowlog-log-slower-than 10000
    slowlog-max-len 128

    # Latency monitor
    latency-monitor-threshold 0

    # Event notification
    notify-keyspace-events ""

    # Advanced config
    hash-max-ziplist-entries 512
    hash-max-ziplist-value 64
    list-max-ziplist-size -2
    list-compress-depth 0
    set-max-intset-entries 512
    zset-max-ziplist-entries 128
    zset-max-ziplist-value 64
    hll-sparse-max-bytes 3000
    stream-node-max-bytes 4096
    stream-node-max-entries 100
    activerehashing yes
    client-output-buffer-limit normal 0 0 0
    client-output-buffer-limit replica 256mb 64mb 60
    client-output-buffer-limit pubsub 32mb 8mb 60
    hz 10
    dynamic-hz yes
    aof-rewrite-incremental-fsync yes
    rdb-save-incremental-fsync yes



---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: load-generator
  namespace: {{NAMESPACE}}
  labels:
    app: load-generator
    scenario: payment-service
    fgm-run: "{{RUN_ID}}"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: load-generator
  template:
    metadata:
      labels:
        app: load-generator
        scenario: payment-service
        fgm-run: "{{RUN_ID}}"
    spec:
      containers:
        - name: load-generator
          image: fgm-scenario-payment-service-load-generator:{{IMAGE_TAG}}
          imagePullPolicy: IfNotPresent
          args:
            - "--host=http://payment-service:8081"
            - "--autostart"
            - "--web-host=0.0.0.0"
            - "--web-port=8089"
          ports:
            - name: port-8089
              containerPort: 8089
              protocol: TCP
          env:
            - name: LOCUST_HOST
              value: "http://payment-service:8081"
            - name: LOCUST_USERS
              value: "10"
            - name: LOCUST_SPAWN_RATE
              value: "2"
            - name: LOCUST_RUN_TIME
              value: "0"
            - name: LOCUST_HEADLESS
              value: "false"
            - name: LOCUST_WEB_PORT
              value: "8089"
            - name: DD_SERVICE
              value: "load-generator"
            - name: DD_VERSION
              value: "1.0.0"
            - name: DD_TRACE_ENABLED
              value: "true"
            - name: DD_LOGS_INJECTION
              value: "true"
            - name: DD_AGENT_HOST
              value: "dd-agent"
            - name: DD_TRACE_AGENT_PORT
              value: "8126"
            - name: DD_DOGSTATSD_PORT
              value: "8125"
            - name: DD_HOSTNAME
              value: "i-${HOSTNAME}"
            - name: RUNNING_IN_CONTAINER
              value: "true"
            # Inject run-specific environment
            - name: GENSIM_RUN_ID
              value: "{{RUN_ID}}"
            - name: DD_ENV
              value: "gensim-{{RUN_ID}}"
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi
          readinessProbe:
            httpGet:
              path: /
              port: 8089
            initialDelaySeconds: 10
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /
              port: 8089
            initialDelaySeconds: 30
            periodSeconds: 30

---
apiVersion: v1
kind: Service
metadata:
  name: load-generator
  namespace: {{NAMESPACE}}
  labels:
    app: load-generator
    scenario: payment-service
    fgm-run: "{{RUN_ID}}"
spec:
  type: ClusterIP
  selector:
    app: load-generator
  ports:
    - name: port-8089
      port: 8089
      targetPort: 8089
      protocol: TCP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: payment-service
  namespace: {{NAMESPACE}}
  labels:
    app: payment-service
    scenario: payment-service
    fgm-run: "{{RUN_ID}}"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: payment-service
  template:
    metadata:
      labels:
        app: payment-service
        scenario: payment-service
        fgm-run: "{{RUN_ID}}"
    spec:
      containers:
        - name: payment-service
          image: fgm-scenario-payment-service-payment-service:{{IMAGE_TAG}}
          imagePullPolicy: IfNotPresent
          ports:
            - name: port-8081
              containerPort: 8081
              protocol: TCP
          env:
            - name: PORT
              value: "8081"
            - name: GIN_MODE
              value: "release"
            - name: FRAUD_DB_URL
              value: "http://fraud-db:6379"
            - name: DD_SERVICE
              value: "payment-service"
            - name: DD_VERSION
              value: "1.0.0"
            - name: DD_TRACE_ENABLED
              value: "true"
            - name: DD_LOGS_INJECTION
              value: "true"
            - name: DD_AGENT_HOST
              value: "dd-agent"
            - name: DD_TRACE_AGENT_PORT
              value: "8126"
            - name: DD_DOGSTATSD_PORT
              value: "8125"
            - name: DD_TRACE_STATS_COMPUTATION_ENABLED
              value: "true"
            - name: DD_HOSTNAME
              value: "i-${HOSTNAME}"
            - name: RUNNING_IN_CONTAINER
              value: "true"
            # Inject run-specific environment
            - name: GENSIM_RUN_ID
              value: "{{RUN_ID}}"
            - name: DD_ENV
              value: "gensim-{{RUN_ID}}"
          resources:
            requests:
              cpu: 10m
              memory: 128Mi
            limits:
              cpu: 10m
          readinessProbe:
            httpGet:
              path: /health
              port: 8081
            initialDelaySeconds: 10
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /health
              port: 8081
            initialDelaySeconds: 30
            periodSeconds: 30

---
apiVersion: v1
kind: Service
metadata:
  name: payment-service
  namespace: {{NAMESPACE}}
  labels:
    app: payment-service
    scenario: payment-service
    fgm-run: "{{RUN_ID}}"
spec:
  type: ClusterIP
  selector:
    app: payment-service
  ports:
    - name: port-8081
      port: 8081
      targetPort: 8081
      protocol: TCP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fraud-db
  namespace: {{NAMESPACE}}
  labels:
    app: fraud-db
    scenario: payment-service
    fgm-run: "{{RUN_ID}}"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: fraud-db
  template:
    metadata:
      labels:
        app: fraud-db
        scenario: payment-service
        fgm-run: "{{RUN_ID}}"
    spec:
      containers:
        - name: fraud-db
          image: redis:7-alpine
          imagePullPolicy: IfNotPresent
          args:
            - "sh"
            - "-c"
            - "redis-server /usr/local/etc/redis/redis.conf --maxmemory $${REDIS_MAXMEMORY} --maxmemory-policy $${REDIS_MAXMEMORY_POLICY} --appendonly yes --appendfsync everysec
"
          ports:
            - name: port-6379
              containerPort: 6379
              protocol: TCP
          env:
            - name: REDIS_MAXMEMORY
              value: "256mb"
            - name: REDIS_MAXMEMORY_POLICY
              value: "allkeys-lru"
            - name: DD_SERVICE
              value: "fraud-db"
            - name: DD_VERSION
              value: "1.0.0"
            - name: DD_TRACE_ENABLED
              value: "true"
            - name: DD_LOGS_INJECTION
              value: "true"
            - name: DD_AGENT_HOST
              value: "dd-agent"
            - name: DD_TRACE_AGENT_PORT
              value: "8126"
            - name: DD_DOGSTATSD_PORT
              value: "8125"
            - name: DD_TRACE_STATS_COMPUTATION_ENABLED
              value: "true"
            - name: DD_HOSTNAME
              value: "i-${HOSTNAME}"
            - name: RUNNING_IN_CONTAINER
              value: "true"
            # Inject run-specific environment
            - name: GENSIM_RUN_ID
              value: "{{RUN_ID}}"
            - name: DD_ENV
              value: "gensim-{{RUN_ID}}"
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi
          volumeMounts:
            - name: fraud-db-config
              mountPath: /usr/local/etc/redis
              readOnly: true
          readinessProbe:
            tcpSocket:
              port: 6379
            initialDelaySeconds: 5
            periodSeconds: 10
          livenessProbe:
            tcpSocket:
              port: 6379
            initialDelaySeconds: 10
            periodSeconds: 30
      volumes:
        - name: fraud-db-config
          configMap:
            name: fraud-db-config

---
apiVersion: v1
kind: Service
metadata:
  name: fraud-db
  namespace: {{NAMESPACE}}
  labels:
    app: fraud-db
    scenario: payment-service
    fgm-run: "{{RUN_ID}}"
spec:
  type: ClusterIP
  selector:
    app: fraud-db
  ports:
    - name: port-6379
      port: 6379
      targetPort: 6379
      protocol: TCP

