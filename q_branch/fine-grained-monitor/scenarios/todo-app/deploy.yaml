# Generated by k8s-adapter from Vibecoder output
# Scenario: todo-app


---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: todo-frontend
  namespace: {{NAMESPACE}}
  labels:
    app: todo-frontend
    scenario: todo-app
    fgm-run: "{{RUN_ID}}"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: todo-frontend
  template:
    metadata:
      labels:
        app: todo-frontend
        scenario: todo-app
        fgm-run: "{{RUN_ID}}"
    spec:
      containers:
        - name: todo-frontend
          image: fgm-scenario-todo-app-todo-frontend:{{IMAGE_TAG}}
          imagePullPolicy: IfNotPresent
          ports:
            - name: port-8080
              containerPort: 8080
              protocol: TCP
          env:
            - name: PORT
              value: "8080"
            - name: API_BASE_URL
              value: "http://localhost:8081/api"
            - name: SERVER_NAME
              value: "localhost"
            - name: TODO_BACKEND_URL
              value: "http://todo-backend:8081"
            - name: DD_SERVICE
              value: "todo-frontend"
            - name: DD_VERSION
              value: "1.0.0"
            - name: DD_TRACE_ENABLED
              value: "true"
            - name: DD_LOGS_INJECTION
              value: "true"
            - name: DD_AGENT_HOST
              value: "dd-agent"
            - name: DD_TRACE_AGENT_PORT
              value: "8126"
            - name: DD_DOGSTATSD_PORT
              value: "8125"
            - name: DD_TRACE_STATS_COMPUTATION_ENABLED
              value: "true"
            - name: ETCD_ENDPOINTS
              value: "http://etcd:2379"
            - name: DD_HOSTNAME
              value: "i-${HOSTNAME}"
            # Inject run-specific environment
            - name: GENSIM_RUN_ID
              value: "{{RUN_ID}}"
            - name: DD_ENV
              value: "gensim-{{RUN_ID}}"
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 30

---
apiVersion: v1
kind: Service
metadata:
  name: todo-frontend
  namespace: {{NAMESPACE}}
  labels:
    app: todo-frontend
    scenario: todo-app
    fgm-run: "{{RUN_ID}}"
spec:
  type: ClusterIP
  selector:
    app: todo-frontend
  ports:
    - name: port-8080
      port: 8080
      targetPort: 8080
      protocol: TCP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: todo-backend
  namespace: {{NAMESPACE}}
  labels:
    app: todo-backend
    scenario: todo-app
    fgm-run: "{{RUN_ID}}"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: todo-backend
  template:
    metadata:
      labels:
        app: todo-backend
        scenario: todo-app
        fgm-run: "{{RUN_ID}}"
    spec:
      containers:
        - name: todo-backend
          image: fgm-scenario-todo-app-todo-backend:{{IMAGE_TAG}}
          imagePullPolicy: IfNotPresent
          ports:
            - name: port-8081
              containerPort: 8081
              protocol: TCP
          env:
            - name: PORT
              value: "8081"
            - name: GIN_MODE
              value: "release"
            - name: DATABASE_URL
              value: "postgresql://postgres:password@todo-db:5432/app_db?sslmode=disable"
            - name: POSTGRES_HOST
              value: "todo-db"
            - name: POSTGRES_PORT
              value: "5432"
            - name: POSTGRES_USER
              value: "postgres"
            - name: POSTGRES_PASSWORD
              value: "password"
            - name: POSTGRES_DB
              value: "app_db"
            - name: TODO_DB_URL
              value: "http://todo-db:5432"
            - name: DD_SERVICE
              value: "todo-backend"
            - name: DD_VERSION
              value: "1.0.0"
            - name: DD_TRACE_ENABLED
              value: "true"
            - name: DD_LOGS_INJECTION
              value: "true"
            - name: DD_AGENT_HOST
              value: "dd-agent"
            - name: DD_TRACE_AGENT_PORT
              value: "8126"
            - name: DD_DOGSTATSD_PORT
              value: "8125"
            - name: DD_TRACE_STATS_COMPUTATION_ENABLED
              value: "true"
            - name: ETCD_ENDPOINTS
              value: "http://etcd:2379"
            - name: DD_HOSTNAME
              value: "i-${HOSTNAME}"
            # Inject run-specific environment
            - name: GENSIM_RUN_ID
              value: "{{RUN_ID}}"
            - name: DD_ENV
              value: "gensim-{{RUN_ID}}"
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi
          readinessProbe:
            httpGet:
              path: /health
              port: 8081
            initialDelaySeconds: 10
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /health
              port: 8081
            initialDelaySeconds: 30
            periodSeconds: 30

---
apiVersion: v1
kind: Service
metadata:
  name: todo-backend
  namespace: {{NAMESPACE}}
  labels:
    app: todo-backend
    scenario: todo-app
    fgm-run: "{{RUN_ID}}"
spec:
  type: ClusterIP
  selector:
    app: todo-backend
  ports:
    - name: port-8081
      port: 8081
      targetPort: 8081
      protocol: TCP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: todo-db
  namespace: {{NAMESPACE}}
  labels:
    app: todo-db
    scenario: todo-app
    fgm-run: "{{RUN_ID}}"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: todo-db
  template:
    metadata:
      labels:
        app: todo-db
        scenario: todo-app
        fgm-run: "{{RUN_ID}}"
    spec:
      # Postgres requires non-root user (UID 70 in alpine images)
      securityContext:
        runAsUser: 70
        runAsGroup: 70
        fsGroup: 70
      containers:
        - name: todo-db
          image: postgres:15-alpine
          imagePullPolicy: IfNotPresent
          ports:
            - name: port-5432
              containerPort: 5432
              protocol: TCP
          env:
            - name: POSTGRES_DB
              value: "app_db"
            - name: POSTGRES_USER
              value: "postgres"
            - name: POSTGRES_PASSWORD
              value: "password"
            - name: POSTGRES_HOST_AUTH_METHOD
              value: "md5"
            - name: DD_SERVICE
              value: "todo-db"
            - name: DD_VERSION
              value: "1.0.0"
            - name: DD_TRACE_ENABLED
              value: "true"
            - name: DD_LOGS_INJECTION
              value: "true"
            - name: DD_AGENT_HOST
              value: "dd-agent"
            - name: DD_TRACE_AGENT_PORT
              value: "8126"
            - name: DD_DOGSTATSD_PORT
              value: "8125"
            - name: DD_TRACE_STATS_COMPUTATION_ENABLED
              value: "true"
            - name: ETCD_ENDPOINTS
              value: "http://etcd:2379"
            - name: DD_HOSTNAME
              value: "i-${HOSTNAME}"
            # Postgres data directory (helps with permissions)
            - name: PGDATA
              value: "/var/lib/postgresql/data/pgdata"
            # Inject run-specific environment
            - name: GENSIM_RUN_ID
              value: "{{RUN_ID}}"
            - name: DD_ENV
              value: "gensim-{{RUN_ID}}"
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi
          # Postgres health checks using pg_isready
          readinessProbe:
            exec:
              command:
                - pg_isready
                - -U
                - postgres
                - -d
                - app_db
            initialDelaySeconds: 5
            periodSeconds: 5
          livenessProbe:
            exec:
              command:
                - pg_isready
                - -U
                - postgres
                - -d
                - app_db
            initialDelaySeconds: 15
            periodSeconds: 10

---
apiVersion: v1
kind: Service
metadata:
  name: todo-db
  namespace: {{NAMESPACE}}
  labels:
    app: todo-db
    scenario: todo-app
    fgm-run: "{{RUN_ID}}"
spec:
  type: ClusterIP
  selector:
    app: todo-db
  ports:
    - name: port-5432
      port: 5432
      targetPort: 5432
      protocol: TCP

