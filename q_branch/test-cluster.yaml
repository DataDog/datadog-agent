apiVersion: datadoghq.com/v2alpha1
kind: DatadogAgent
metadata:
  name: datadog
spec:
  global:
    checksTagCardinality: high
    clusterName: sopell-gadget-dev
    kubelet:
      tlsVerify: false
    credentials:
      apiSecret:
        secretName: datadog-secret
        keyName: api-key
      appSecret:
        secretName: datadog-secret
        keyName: app-key
  override:
    nodeAgent:
      image:
        #name: docker.io/datadog/agent-dev:sopell-q-branch-cpu-oscillation-per-container-py3-jmx
        name: localhost/datadog-agent:local
        pullPolicy: Never
      extraConfd:
        configMap:
          name: cpu-oscillation-config
      env:
        - name: DD_DD_URL
          value: "http://proxy-dumper.default.svc.cluster.local:8081"
  features:
    logCollection:
      enabled: true
    liveProcessCollection:
      enabled: true
    liveContainerCollection:
      enabled: true
    processDiscovery:
      enabled: true
    oomKill:
      enabled: true
    tcpQueueLength:
      enabled: true
    ebpfCheck:
      enabled: true
    apm:
      enabled: true
    cspm:
      enabled: true
    cws:
      enabled: true
    npm:
      enabled: true
    usm:
      enabled: true
    dogstatsd:
      unixDomainSocketConfig:
        enabled: true
---
# Proxy dumper to intercept and log metrics
apiVersion: apps/v1
kind: Deployment
metadata:
  name: proxy-dumper
spec:
  replicas: 1
  selector:
    matchLabels:
      app: proxy-dumper
  template:
    metadata:
      labels:
        app: proxy-dumper
    spec:
      containers:
      - name: proxy-dumper
        image: proxy-dumper
        imagePullPolicy: Never
        ports:
        - containerPort: 8081
---
apiVersion: v1
kind: Service
metadata:
  name: proxy-dumper
spec:
  selector:
    app: proxy-dumper
  ports:
  - port: 8081
    targetPort: 8081
---
# ConfigMap to enable cpu_oscillation check
apiVersion: v1
kind: ConfigMap
metadata:
  name: cpu-oscillation-config
data:
  cpu_oscillation.yaml: |
    instances:
      - enabled: true
        warmup_seconds: 60
        min_amplitude: 10
        min_direction_reversals: 40
---
