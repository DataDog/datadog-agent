apiVersion: datadoghq.com/v2alpha1
kind: DatadogAgent
metadata:
  name: datadog
spec:
  global:
    clusterName: gadget-dev
    kubelet:
      tlsVerify: false
    credentials:
      apiSecret:
        secretName: datadog-secret
        keyName: api-key
      appSecret:
        secretName: datadog-secret
        keyName: app-key
  override:
    nodeAgent:
      image:
        # localhost/ prefix required - operator prepends default registry without it
        name: localhost/datadog-agent:local
        pullPolicy: Never
  features:
    logCollection:
      enabled: true
    liveProcessCollection:
      enabled: true
    liveContainerCollection:
      enabled: true
    processDiscovery:
      enabled: true
    oomKill:
      enabled: true
    tcpQueueLength:
      enabled: true
    ebpfCheck:
      enabled: true
    apm:
      enabled: true
    cspm:
      enabled: true
    cws:
      enabled: true
    npm:
      enabled: true
    usm:
      enabled: true
    dogstatsd:
      unixDomainSocketConfig:
        enabled: true
---
# CPU Oscillation stress test - creates rapid on/off CPU pattern
apiVersion: v1
kind: Pod
metadata:
  name: cpu-oscillator
  labels:
    app: cpu-oscillator
spec:
  containers:
  - name: oscillator
    image: busybox
    command:
    - /bin/sh
    - -c
    - |
      # Oscillate CPU: 2 seconds busy, 2 seconds idle
      # This creates ~0.25 Hz oscillation pattern
      while true; do
        # CPU spike: tight loop for 2 seconds
        end=$(($(date +%s) + 2))
        while [ $(date +%s) -lt $end ]; do
          : # busy loop
        done
        # CPU idle: sleep for 2 seconds
        sleep 2
      done
    resources:
      requests:
        cpu: "100m"
        memory: "32Mi"
      limits:
        cpu: "500m"
        memory: "64Mi"
