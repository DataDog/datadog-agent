# DO NOT EDIT

# Datadog Internal Hosts
#######################################################################
# (Allow more such hosts as needed.)
# Note that anything else we rewrite to must also be allowed here.
allow binaries.ddbuild.io
allow depot-read-api-bzl.us1.ddbuild.io
allow depot-read-api-cli.us1.ddbuild.io
allow depot-read-api-generic.us1.ddbuild.io
allow depot-read-api-go.us1.ddbuild.io
allow depot-read-api-java.us1.ddbuild.io
allow depot-read-api-python.us1.ddbuild.io
allow registry.ddbuild.io
allow vault.us1.ddbuild.io
allow nodejs.org
allow go.dev
allow go.dev/dl
allow golang.google.cn
allow tukaani.org
allow bcr.bazel.build
allow dd-agent-omnibus.s3.amazonaws.com
allow cdn.jsdelivr.net
allow raw.githubusercontent.com
allow index.crates.io

# This list is temporary. It should be upstreamed to basic adms support.
allow dbus.freedesktop.org
allow download.savannah.nongnu.org
allow freetds.org
allow ftp.rpm.org
allow gnupg.org
allow lua.org
allow mirrors.edge.kernel.org
allow mirrors.kernel.org
allow sourceware.org
allow sqlite.org

# Our windows filters are not stored on an internal host.
allow s3.amazonaws.com

# DEBUGGING
######################################################################
# These hosts have been used for downloading Java artifacts. We'll allow them
# for the time being, but we should dig into how they are being specified in
# broader Bazel configuration, and work get these artifacts into ADMS more
# formally, so we can begin to lock down this configuration more.

# dd-agent and dd-trace jars
# (https://github.com/DataDog/logs-backend/blob/8ea7c29de6185481f61ba0b3affa97acad69d18b/rules/jvm/setup.bzl#L84-L98)
allow s3.us-east-1.amazonaws.com
######################################################################

# Rewrite Rules for External Hosts
#######################################################################
# The list of hosts below is based on what has already been observed in the wild,
# and pulled in by Depot's Bazel support:
#
#     aws-vault exec sso-build-stable-dependency-mgmt-s3-admin -- \
#         aws s3 ls s3://dd-depot-us1-ddbuild-io/bzl/
#
# We will explicitly enable downloading via Depot for these hosts, to preserve what
# functionality we currently provide. This also gives us more control and visibility
# into what we're actually downloading, and allows us to track down misconfigurations
# more easily.
rewrite (bcr.bazel.build)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (tukaani.org)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
# rewrite (go.dev)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
# rewrite (golang.google.cn)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (nodejs.org)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (aka.ms)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (amazon-ecr-credential-helper-releases.s3.us-east-2.amazonaws.com)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (apache.jfrog.io)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (archive.apache.org)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (boostorg.jfrog.io)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (cache.agilebits.com)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (cdn.azul.com)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (download.gnome.org)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (fastdl.mongodb.org)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (get.helm.sh)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (git.kernel.org)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (github.com)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (raw.githubusercontent.com)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (cdn.jsdelivr.net)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (dl.google.com)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2

# Taken from https://blog.aspect.build/configuring-bazels-downloader
# > For some reason the bazel team decided that mirror.bazel.build should be the source of truth for these 3 files, let
# > those through
rewrite (mirror.bazel.build/bazel_coverage_output_generator/.*) depot-read-api-bzl.us1.ddbuild.io/$1
rewrite (mirror.bazel.build/bazel_java_tools/.*) depot-read-api-bzl.us1.ddbuild.io/$1
rewrite (mirror.bazel.build/openjdk/.*) depot-read-api-bzl.us1.ddbuild.io/$1
# > For everything else, our urls exactly match what mirror.bazel.build gives so skip the indirection
rewrite mirror.bazel.build/(.*) depot-read-api-bzl.us1.ddbuild.io/$1

rewrite (releases.hashicorp.com)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (snapshot.ubuntu.com)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (sourceware.org)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (storage.googleapis.com)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (www.colm.net)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (www.openssl.org)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (www.gnupg.org)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (www.tcpdump.org)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (www.unixodbc.org)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (mirrors.edge.kernel.org)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (pyyaml.org)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (python.org)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (mirrors.kernel.org)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (curl.haxx.se)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2

# Rewrite Rules for External Hosts - Specific Language Ecosystems
#######################################################################
# In some cases, we are accessing upstream repositories for various language ecosystems
# that we otherwise support internally, despite Bazel being ostensibly configured to use
# our internal repositories. This potentially suggests "holes" in our configuration, or
# artifacts being pulled in via harder-to-detect means.
#
# These situations are highlighted here for visibility; eventually, we should sort out
# these situations and entirely block the relevant upstream hosts entirely.

# TODO: Investigate why these aren't using our internal repository already.
rewrite (pypi.org)/(.*) depot-read-api-python.us1.ddbuild.io/magicmirror/magicmirror/@current/$2
rewrite (pypi.python.org)/(.*) depot-read-api-python.us1.ddbuild.io/magicmirror/magicmirror/@current/$2
rewrite (files.pythonhosted.org)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2

# TODO: Move to Depot NPM when available
rewrite (registry.npmjs.org)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2

# TODO: Move to Depot Java when we can determine why requests to repo1.maven.org
# are still being made.
rewrite (repo1.maven.org)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
rewrite (central.sonatype.com)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2

# TODO: We don't support Rust in ADMS yet, but once we do, this can go away. In
# the meantime, it's a kind of "back door" to mirroring Rust artifacts internally.
rewrite (static.crates.io)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2
# This is for Rust runtimes
rewrite (static.rust-lang.org)/(.*) depot-read-api-bzl.us1.ddbuild.io/$1/$2

# Block everything else
#######################################################################
# If something is not explicitly allowed above, it will be blocked. If users
# need to download something that is blocked, they can speak with #dependency-management
# in Slack to get it unblocked.
block *
all_blocked_message This blocking should only be happening in CI - reach out to Datadog#dependency-management
