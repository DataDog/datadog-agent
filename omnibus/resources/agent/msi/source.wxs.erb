<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
  <!-- This is how we include wxi files -->
  <?include "parameters.wxi" ?>

  <!--
    Id="*" is to enable upgrading. * means that the product ID will be autogenerated on each build.
    Name is made of localized product name and version number.
  -->
  <?if $(var.Platform) = x64 ?>
    <?define Win64 = "yes" ?>
    <?define PlatformProgramFilesFolder = "ProgramFiles64Folder" ?>
  <?else ?>
    <?define Win64 = "no" ?>
    <?define PlatformProgramFilesFolder = "ProgramFilesFolder" ?>
  <?endif ?>

  <Product Id="*"
           Name="!(loc.ProductName)"
           Language="1033"
           Version="$(var.VersionNumber)"
           Manufacturer="!(loc.ManufacturerName)"
           UpgradeCode="$(var.UpgradeCode)"
           Codepage="1252">

    <!--
      Define the minimum supported installer version (2.0).
      The install should be done for the whole machine not just the current user
    -->
    <Package Id="*"
             Keywords="Installer"
             Comments="!(loc.InstallerComment)"
             Description="!(loc.ProductName) $(var.DisplayVersionNumber)"
             Manufacturer="!(loc.ManufacturerName)"
             InstallScope="perMachine"
             InstallerVersion="400"
             Languages="1033"
             InstallPrivileges="elevated"
             Compressed="yes" />

    <!-- This removes entirely the previous version -->
    <Upgrade Id="$(var.UpgradeCode)">
        <UpgradeVersion OnlyDetect='no'
                        Property='PREVIOUSFOUND'
                        Minimum='1.0.0' IncludeMinimum='yes'
                        Maximum="$(var.VersionNumber)" IncludeMaximum='yes'/>
    </Upgrade>

    <!-- This allows downgrades, and same-version reinstalls.  Otherwise,
    same version gets installed "side by side" -->
    <MajorUpgrade
      AllowDowngrades="no"
      AllowSameVersionUpgrades="yes"
      DowngradeErrorMessage="Automatic downgrades are not supported.  Uninstall the current version, and then reinstall the desired version."
      Schedule="afterInstallInitialize" />


    <!-- Close application when uninstalling -->
    <util:CloseApplication Id="CloseTrayApp"
                          CloseMessage="yes"
                          EndSessionMessage="yes"
                          Target="ddtray.exe"
                          ElevatedCloseMessage="yes"
                          TerminateProcess="1"
                          Timeout="1"
                          RebootPrompt="no"/>

    <!-- -->
    <Property Id="REINSTALLMODE" Value="amus" />
    <!-- Set property to always log -->
    <Property Id="MsiLogging" Value="iwearucmop!" />

    <!-- No need to restart Windows after the installation -->
    <Property Id="MSIRESTARTMANAGERCONTROL" Value="Disable" />

    <Property Id="DDAGENTUSER_NAME" />
    <Property Id="DDAGENTUSER_PASSWORD" Hidden="yes" />
    <Property Id="APIKEY" Hidden="yes" />
    <Property Id="SITE" Value="datadoghq.com" />
    <Property Id="FinalizeInstall" Hidden="yes" />
    <Property Id="CLOSEDSOURCEACCEPTED" /> <!-- this key is set by the approval dialog-->
     <PropertyRef Id="WIX_ACCOUNT_ADMINISTRATORS" />
     <PropertyRef Id="WIX_ACCOUNT_LOCALSYSTEM" />
     <PropertyRef Id="WIX_ACCOUNT_USERS" />

     <Property Id="SYSPROBE_PRESENT" Value="true" />
    <!--
      The following four properties are set to see if the user specified the binary dir or config dir on
      the command line. These properties are loaded before the property is loaded from the registry (below)
      so we can tell if it was actually supplied on the command line.

      The second of each pair is because the directory can be stored with a trailing "\", but it's the same
      directory.  Makes the comparison (below) easier.
    -->
    <SetProperty Id="PROJECTLOCATIONONCMDLINE" Value="[PROJECTLOCATION]" Before="AppSearch">PROJECTLOCATION </SetProperty>
    <SetProperty Id="PROJECTLOCATIONONCMDLINESLASH" Value="[PROJECTLOCATION]\" Before="AppSearch">PROJECTLOCATION </SetProperty>
    <SetProperty Id="CONFDIRONCOMMANDLINE" Value="[APPLICATIONDATADIRECTORY]" Before="AppSearch">APPLICATIONDATADIRECTORY </SetProperty>
    <SetProperty Id="CONFDIRONCOMMANDLINESLASH" Value="[APPLICATIONDATADIRECTORY]\" Before="AppSearch">APPLICATIONDATADIRECTORY </SetProperty>

    <!--
      The following property is set to either C:\ProgramData\Datadog or to the value of [APPLICATIONDATADIRECTORY]
      if it is provided as installation parameter. This property will be used during AppSearch phase to detect
      existence of datadog.yaml file
    -->
    <SetProperty Id="APPLICATIONDATADIRECTORY_BEFORE_APPSEARCH" Action="SetApplicationDataDirectory_FromCmdline" Value="[APPLICATIONDATADIRECTORY]" Before="AppSearch">APPLICATIONDATADIRECTORY</SetProperty>
    <SetProperty Id="APPLICATIONDATADIRECTORY_BEFORE_APPSEARCH" Action="SetApplicationDataDirectory_NotFromCmdline" Value="[CommonAppDataFolder]Datadog" Before="AppSearch">NOT APPLICATIONDATADIRECTORY</SetProperty>

    <!--
      The following sets a property (to be used by the custom action).
      the "&" indicates the action state of a feature (so &NPM refers to the NPM _feature_ not the NPM property that might be set on the command line)
      "3" refers to the action state "on the local computer" (which is the only one we support besides "not present", which happens to be "2")

      So, the NPMFEATURESTATE property will be set to "off" if the NPM feature is no installed on the local computer
      and will be set to "on" if it is used on the local computer.

      This flag will be used in the custom action to decide what service dependencies need to be set

      For more information on this syntax see
      https://www.firegiant.com/wix/tutorial/com-expression-syntax-miscellanea/expression-syntax/
      -->

    <!--<SetProperty Action="SetNPMOff" Id="NPMFEATURESTATE" Before="SetFinalizeProperty" Value="off" Sequence="execute"><![CDATA[not (&NPM = 3)]]></SetProperty>
    <SetProperty Action="SetNPMOn"  Id="NPMFEATURESTATE" Before="SetFinalizeProperty" Value="on"  Sequence="execute"><![CDATA[(&NPM = 3)]]></SetProperty>
     This condition allows the install if
        1) the user didn't supply the binary directory on the command line
        2) this is NOT an upgrade
        3) it is an upgrade, but the supplied directory is the same as the originally installed one.

      Case (3) is to allow automation tools to supply the same arguments regardless of whether it's an install or
      upgrade.-->
    <Condition
      Message="!(loc.NoMoveInstallDir)">
      <!-- Inside of conditional must be TRUE to meet the condition (to NOT fail the install) -->
      <![CDATA[(NOT PROJECTLOCATIONONCMDLINE) OR (NOT PREVIOUSFOUND)
              OR ((PROJECTLOCATIONONCMDLINE~=PROJECTLOCATION) OR
                  (PROJECTLOCATIONONCMDLINESLASH~=PROJECTLOCATION))]]>
    </Condition>

    <!-- Same as above, but for the configuration directory. -->
    <Condition
      Message="!(loc.NoMoveConfDir)">
      <!-- Inside of conditional must be TRUE to meet the condition (to NOT fail the install) -->
      <![CDATA[(NOT CONFDIRONCOMMANDLINE) OR (NOT PREVIOUSFOUND)
              OR ((CONFDIRONCOMMANDLINE~=APPLICATIONDATADIRECTORY) OR
                  (CONFDIRONCOMMANDLINESLASH~=APPLICATIONDATADIRECTORY))]]>
    </Condition>
    <Media Id="1" Cabinet="agent.cab" EmbedCab="yes" />

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="$(var.PlatformProgramFilesFolder)">
        <Directory Id="APPLICATIONROOTDIRECTORY" Name="Datadog">
          <Directory Id="PROJECTLOCATION" Name="Datadog Agent"/>
        </Directory>
      </Directory>
      <Directory Id="CommonAppDataFolder" SourceName="CommonAppData">
        <Directory Id="APPLICATIONDATADIRECTORY" Name="Datadog">
          <Component Id="conffolder" Guid="e540d2db-f443-4a98-bd72-7ab2654f4ffb">
            <CreateFolder>
                <Permission User="[WIX_ACCOUNT_ADMINISTRATORS]" GenericAll="yes" ChangePermission="yes"/>
                <Permission User="[WIX_ACCOUNT_LOCALSYSTEM]" GenericAll="yes" ChangePermission="yes"/>
                <Permission User="[WIX_ACCOUNT_USERS]" GenericAll="no" ChangePermission="yes"/>
            </CreateFolder>
          </Component>
        </Directory>
      </Directory>
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="Datadog"/>
      </Directory>
    </Directory>

    <!-- Detect existence of datadog.yaml file -->
    <Property Id="DATADOGYAMLEXISTS">
      <DirectorySearch Id="DatadogYamlSearchDirId" Path="[APPLICATIONDATADIRECTORY_BEFORE_APPSEARCH]" Depth="0" AssignToProperty="yes">
        <FileSearch Id="DatadogYamlSearchFileId" Name="datadog.yaml"/>
      </DirectorySearch>
    </Property>

    <CustomAction
        Id="LaunchApp"
        Directory="AGENT"
        Execute="immediate"
        Return="asyncNoWait"
        ExeCommand="&quot;[AGENT]ddtray.exe&quot; &quot;--launch-gui&quot;" />


    <!-- Delete application when uninstalling -->
    <!--
      RemoveFolderEx requires that we "remember" the path for uninstall.
      Read the path value and set the PROJECTLOCATION property with the value.
    -->
    <Property Id="PROJECTLOCATION" Secure="yes">
      <RegistrySearch Key="SOFTWARE\Datadog\Datadog Agent"
                      Root="HKLM"
                      Type="raw"
                      Id="APPLICATIONROOTDIRECTORY_REGSEARCH"
                      Name="InstallPath" />
    </Property>
    <Property Id="APPLICATIONDATADIRECTORY" Secure="yes">
      <RegistrySearch Key="SOFTWARE\Datadog\Datadog Agent"
                      Root="HKLM"
                      Type="raw"
                      Id="APPLICATIONDATADIRECTORY_REGSEARCH"
                      Name="ConfigRoot" />
    </Property>

    <!-- check to see if the npm service is already in DEMAND_START state.  If so, 
         was installed by previous method, and can infer that closed source was accepted
         on prior install -->
    <Property Id="DD_FILTER_INSTALLED">
      <RegistrySearch Key="SYSTEM\CurrentControlSet\Services\ddnpm"
                      Root="HKLM"
                      Type="raw"
                      Id="DDFILTERINSTALLED_REGSEARCH"
                      Name="Start" />
    </Property>
    
    
    <DirectoryRef Id="PROJECTLOCATION">
      <Component Id="CleanupMainApplicationFolder" Guid="096249cf-3fe7-4342-a80f-77101ceed5fe">
        <RegistryValue Root="HKLM"
                       Key="SOFTWARE\Datadog\Datadog Agent"
                       Name="InstallPath"
                       Type="string"
                       Value="[PROJECTLOCATION]"/>
        <RegistryValue Root="HKLM"
                       Key="SOFTWARE\Datadog\Datadog Agent"
                       Name="ConfigRoot"
                       Type="string"
                       Value="[APPLICATIONDATADIRECTORY]"/>
        <util:RemoveFolderEx On="uninstall" Property="PROJECTLOCATION"/>
      </Component>
    </DirectoryRef>
    <!-- Let's ship our dist folder with the service and gui executables -->
    <DirectoryRef Id="PROJECTLOCATION">
      <!-- put the agent in the embedded folder so that it can find the python DLLS -->
      <Directory Id="BIN" Name="bin">
        <!-- Windows service declaration for Datadog Agent -->
        <Component Id="DATADOGAGENTSERVICE" Guid="BCFAD885-5C69-49D3-99CB-494D14E87AAE">
          <File Id="agent.exe"
                Name="agent.exe"
                Vital="yes"
                KeyPath="yes"
                DiskId="1"
                Source="$(var.BinFiles)/agent.exe"/>


          <!-- The "Name" field must match the argument to eventlog.Open() -->
          <util:EventSource Log="Application" Name="DatadogAgent"
                EventMessageFile="[BIN]agent.exe"
                SupportsErrors="yes"
                SupportsInformationals="yes"
                SupportsWarnings="yes"/>



        </Component>
        <Component Id="RTLOADERDLLS" Guid="E81FBBB0-7BB9-4D52-A5F1-36A2123E6979">
          <?if $(var.IncludePython2) = true ?>
          <File Id="twodll"
                Name="libdatadog-agent-two.dll"
                Vital="yes"
                KeyPath="yes"
                DiskId="1"
                Source="$(var.BinFiles)/libdatadog-agent-two.dll"/>
          <?endif ?>
          <?if $(var.IncludePython3) = true ?>
          <File Id="threedll"
                Name="libdatadog-agent-three.dll"
                Vital="yes"
                DiskId="1"
                Source="$(var.BinFiles)/libdatadog-agent-three.dll"/>
            <?endif ?>
        </Component>

        <?if $(var.IncludePython2) = true ?>
        <Component Id="MSVCRUNTIME" Guid="30ce4f57-47ce-47c0-8564-e510d69787a9">

            <Condition> <![CDATA[VersionNT <= 601]]> </Condition>
            <File Id="msvcm90.dll"
                Name="msvcm90.dll"
                Vital="yes"
                KeyPath="yes"
                DiskId="1"
                Source="$(var.BinFiles)/msvcm90.dll"/>
            <File Id="msvcp90.dll"
                Name="msvcp90.dll"
                Vital="yes"
                DiskId="1"
                Source="$(var.BinFiles)/msvcp90.dll"/>
            <File Id="msvcr90.dll"
                Name="msvcr90.dll"
                Vital="yes"
                DiskId="1"
                Source="$(var.BinFiles)/msvcr90.dll"/>
            <File Id="Microsoft.VC90.CRT.manifest"
                Name="Microsoft.VC90.CRT.manifest"
                Vital="yes"
                DiskId="1"
                Source="$(var.BinFiles)/Microsoft.VC90.CRT.manifest"/>

        </Component>
        <?endif ?>

        <Directory Id="AGENT" Name="agent">
          <?if $(var.Platform) = x64 ?>
            <!-- Windows service declaration for APM agent -->
            <Component Id="DATADOGAPMSERVICE" Guid="a8e611fa-aedb-4c16-969c-bb827af0bd53">
                <File Id="trace_agent.exe"
                    Name="trace-agent.exe"
                    Vital="yes"
                    KeyPath="yes"
                    DiskId="1"
                    Source="$(var.BinFiles)/trace-agent.exe"/>
                <!-- The "Name" field must match the argument to eventlog.Open() -->
                <util:EventSource Log="Application" Name="datadog-trace-agent"
                        EventMessageFile="[AGENT]trace-agent.exe"
                        SupportsErrors="yes"
                        SupportsInformationals="yes"
                        SupportsWarnings="yes"/>
            </Component>
            <!-- Windows service declaration for Process agent -->
            <Component Id="DATADOGPROCESSSERVICE" Guid="3b119795-ddf8-44eb-9d53-301f7186e2f3">
                <File Id="process_agent.exe"
                    Name="process-agent.exe"
                    Vital="yes"
                    KeyPath="yes"
                    DiskId="1"
                    Source="$(var.BinFiles)/process-agent.exe"/>
                <!-- The "Name" field must match the argument to eventlog.Open() -->
                <util:EventSource Log="Application" Name="datadog-process-agent"
                        EventMessageFile="[AGENT]process-agent.exe"
                        SupportsErrors="yes"
                        SupportsInformationals="yes"
                        SupportsWarnings="yes"/>
            </Component>
              <Directory Id="DRIVER" Name="driver">
                <Merge Id="ddnpminstall" SourceFile="$(var.BinFiles)\ddnpm.msm" DiskId="1" Language="1033" >
                </Merge>
              </Directory>
            <Component Id="DATADOGSYSPROBESERVICE" Guid="5D41ECDB-B91E-4802-878C-CDBA84721623">
              <File Id="system_probe.exe"
                  Name="system-probe.exe"
                  Vital="yes"
                  KeyPath="yes"
                  DiskId="1"
                  Source="$(var.BinFiles)/system-probe.exe" />
              <!-- The "Name" field must match the argument to eventlog.Open() -->
              <util:EventSource Log="Application" Name="datadog-system-probe"
                    EventMessageFile="[AGENT]system-probe.exe"
                    SupportsErrors="yes"
                    SupportsInformationals="yes"
                    SupportsWarnings="yes"/>
            </Component>
          <?endif?>
        </Directory>
      </Directory>
    </DirectoryRef>

    <!-- Datadog Agent specific directory definitions -->
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcut" Guid="05206095-f4a0-4bb7-9ebd-80c7488dd7f9">
        <Shortcut Id="ApplicationStartMenuShortcut"
                  Name="Datadog Agent Manager"
                  Description="Manage your Datadog Agent"
                  Target="[AGENT]ddtray.exe"
                  Arguments= "&quot;--launch-gui&quot;"
                  WorkingDirectory="AGENT"/>

        <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall"/>
        <RegistryValue Root="HKCU"
                       Key="Software\Microsoft\Datadog"
                       Name="installed"
                       Type="integer"
                       Value="1"
                       KeyPath="yes"/>
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="APPLICATIONDATADIRECTORY">
      <Component Id="datadog.yaml.example"
                 Guid="83461594-01AC-11E2-BE35-37EC6088709B"
                 NeverOverwrite="no"
                 Permanent="no">
        <File Id="datadog.yaml.example"
            Name="datadog.yaml.example"
            KeyPath="yes"
            Source="$(var.EtcFiles)\datadog.yaml.example"/>
      </Component>

      <Component Id="system_probe.yaml.example"
                Guid="a268622a-0305-4b5d-b08a-2371820f6b3f"
                NeverOverwrite="yes"
                Permanent="yes">
        <File Id="system_probe.yaml.example"
          Name="system-probe.yaml"
          KeyPath="yes"
          Source="$(var.EtcFiles)\system-probe.yaml.example"/>
      </Component>


      <Directory Id="checks.d" Name="checks.d">
        <Component Id="checks.d"
                   Guid="92cbe7e0-e72c-42c4-9353-741d94b63495"
                   Location="either">
          <CreateFolder/>
        </Component>
      </Directory>

      <!-- Directory to store the registry that keep track of tailed file offsets -->
      <Directory Id="REGISTRYDIRECTORY" Name="run">
        <Component Id="REGISTRYDIRECTORY"
                   Guid="5acf7ec1-3bcf-40d7-8840-f8de8a472c3c"
                   Permanent="yes"
                   Location="either"
                   NeverOverwrite="yes">
          <CreateFolder/>
        </Component>
      </Directory>

      <Directory Id="EXAMPLECONFSLOCATION" Name= "conf.d">
        <Component Id="conf.d"
                   Guid="54fcfacb-726b-46e3-a699-ec19258a24be"
                   Permanent="yes"
                   Location="either"
                   NeverOverwrite="yes">
          <CreateFolder>
              <Permission User="[WIX_ACCOUNT_ADMINISTRATORS]" GenericAll="yes" ChangePermission="yes"/>
              <Permission User="[WIX_ACCOUNT_LOCALSYSTEM]" GenericAll="yes" ChangePermission="yes"/>
              <Permission User="[WIX_ACCOUNT_USERS]" GenericAll="no" ChangePermission="yes"/>
          </CreateFolder>
        </Component>
      </Directory>

      <Directory Id="logs" Name="logs">
        <Component Id="logs"
                   Guid="e194d05a-6dc7-40be-a626-6a15b43c456b"
                   Permanent="yes"
                   Location="either"
                   NeverOverwrite="yes">
            <CreateFolder>
                <Permission User="[WIX_ACCOUNT_ADMINISTRATORS]" GenericAll="yes" ChangePermission="yes"/>
                <Permission User="[WIX_ACCOUNT_LOCALSYSTEM]" GenericAll="yes" ChangePermission="yes"/>
                <Permission User="[WIX_ACCOUNT_USERS]" GenericAll="no" ChangePermission="yes"/>
            </CreateFolder>

        </Component>
      </Directory>
    </DirectoryRef>
    
    <InstallExecuteSequence>
      <Custom Action='WixCloseApplications' Before='RemoveFiles'> </Custom>

      <!-- go ahead and always stop the services; if they're not installed (new install) it won't have any impact -->

      <!-- always stop the services, regardless of what's going on -->
      <Custom Action='StopDDServices' Before='StopServices'> </Custom>

      <!-- only run the FinalizeInstall action on INSTALL (for now) Note this
           is from the perspective of the installer being run; on upgrade the
           installer is called twice; the existing (previously installed)
           installer is called with _UPGRADE, and then the new installer
           is called with _INSTALL -->
      <Custom Action='SetFinalizeProperty' Before='FinalizeInstall'> <![CDATA[Installed="" OR REMOVE<>"ALL" ]]> </Custom>
      <Custom Action='FinalizeInstall' Before='StartServices'>       <![CDATA[Installed="" OR REMOVE<>"ALL" ]]> </Custom>

      <!-- Same deal here -->
      <Custom Action='StartDDServices' After='StartServices'>  <![CDATA[REMOVE<>"ALL"]]></Custom>

      <!-- only do the uninstall (which removes the user state and file perms)
           on a full uninstall -->
      <Custom Action='DoUninstall' Before='RemoveRegistryValues'>      <![CDATA[REMOVE="ALL" AND UPGRADINGPRODUCTCODE=""]]> </Custom>

      <Custom Action='DoRollback' Before='FinalizeInstall'>       <![CDATA[REMOVE<>"ALL" OR UPGRADINGPRODUCTCODE<>""]]> </Custom>
    </InstallExecuteSequence>

    <!-- Set the components defined in our fragment files that will be used for our feature  -->
    <Feature
      Id="MainApplication"
      Title="Datadog Agent"
      Level="1"
      Absent="disallow"
      ConfigurableDirectory="APPLICATIONROOTDIRECTORY">
        <ComponentRef Id="conffolder" />
        <ComponentGroupRef Id="ProjectDir" />
        <ComponentRef Id="datadog.yaml.example" />
        <ComponentRef Id="logs" />
        <ComponentRef Id="conf.d" />
        <ComponentRef Id="checks.d" />
        <ComponentRef Id="REGISTRYDIRECTORY" />
        <ComponentRef Id="ApplicationShortcut" />
        <ComponentRef Id="DATADOGAGENTSERVICE" />
        <ComponentRef Id="RTLOADERDLLS" />
        <?if $(var.Platform) = x64 ?>
          <ComponentRef Id="DATADOGAPMSERVICE" />
          <ComponentRef Id="DATADOGPROCESSSERVICE" />
        <?endif ?>
        <ComponentGroupRef Id="ExtraEXAMPLECONFSLOCATION" />
        <ComponentRef Id="CleanupMainApplicationFolder" />
        <?if $(var.IncludePython2) = true ?>
          <ComponentRef Id="MSVCRUNTIME" />
        <?endif ?>
          <ComponentRef Id="DATADOGSYSPROBESERVICE" />
          <ComponentRef Id="system_probe.yaml.example" />
          <MergeRef Id="ddnpminstall"/>
      <!-- don't install by default (indicated by level 100)  Only things with level
        <= INSTALLLEVEL (1 by default) will be installed.  Can be changed via gui or command line params to optionally install -->
      <Feature  Id="NPM"
                Level="100"
                Title="Network Performance Monitoring"
                ConfigurableDirectory="APPLICATIONROOTDIRECTORY"
                Absent="allow"
                AllowAdvertise="no"
      >
        <!--  This space intentionally left blank.
              Starting with 7.44, the npm components are no longer controlled
              by a feature.  Rather, they're controlled by the new closed 
              source directive.  However, docs & released management tools 
              use the ADDLOCAL=NPM; if there's no such feature it errors out
              Provide an empty feature; the parsing will do the right thing
              in the custom action
              -->
        
      </Feature>
    </Feature>

    <!-- UI Stuff: 100% Omnibus Generated -->
    <Icon Id="project.ico" SourceFile="Resources\assets\project.ico"/>
    <Property Id="ARPPRODUCTICON" Value="project.ico" />
    <Property Id="ARPHELPLINK" Value="https://datadoghq.com/" />
    <!--
    <Property Id="WIXUI_INSTALLDIR" Value="<%= wix_install_dir %>" /> -->

    <UIRef Id="ProjectUI_InstallDir"/>
    <UI Id="ProjectUI_InstallDir">
      <UIRef Id="WixUI_Common"/>
      <UIRef Id="WixUI_ErrorProgressText" />
      <Property Id="DefaultUIFont">DlgFont8</Property>
      <TextStyle Id="WixUI_Font_Normal_White" FaceName="Tahoma" Size="8" Red="255" Green="255" Blue="255" />
      <TextStyle Id="WixUI_Font_Bigger_White" FaceName="Tahoma" Size="12" Red="255" Green="255" Blue="255" />
      <TextStyle Id="WixUI_Font_Title_White" FaceName="Tahoma" Size="9" Bold="yes" Red="255" Green="255" Blue="255" />

      <TextStyle Id="TahomaHeader" FaceName="Tahoma" Size="18" Bold="yes" />
      <TextStyle Id="TahomaNormal" FaceName="Tahoma" Size="8" />

      <TextStyle Id="DlgFont8" FaceName="Tahoma" Size="8" />
      <TextStyle Id="DlgFontBold8" FaceName="Tahoma" Size="8" Bold="yes" />
      <TextStyle Id="Verdana13Bold" FaceName="Verdana" Size="13" Bold="yes" />

      <TextStyle Id="WixUI_Font_Normal" FaceName="Tahoma" Size="8" />
      <TextStyle Id="WixUI_Font_Bigger" FaceName="Tahoma" Size="12" />
      <TextStyle Id="WixUI_Font_Title" FaceName="Tahoma" Size="9" Bold="yes" />


      <Publish Dialog="ExitDialog"
          Control="Finish"
          Event="DoAction"
          Value="LaunchApp">
          WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed
      </Publish>
      <?include Resources\assets\apikeydlg.wxi ?>
      <?include Resources\assets\sitedlg.wxi ?>
      <?include Resources\assets\ddagentuserdlg.wxi ?>
      <?include Resources\assets\closedsource.wxi ?>
      <DialogRef Id="ErrorDlg" />
      <DialogRef Id="FatalError" />
      <DialogRef Id="FilesInUse" />
      <DialogRef Id="MsiRMFilesInUse" />
      <DialogRef Id="PrepareDlg" />
      <DialogRef Id="ProgressDlg" />
      <DialogRef Id="ResumeDlg" />
      <DialogRef Id="UserExit" />
      <DialogRef Id="WelcomeDlg" />
      <DialogRef Id="ApiKeyDlg"/>
      <DialogRef Id="SiteDlg"/>
      <DialogRef Id="DDAgentUserDlg"/>
      <DialogRef Id="DDAgentUserInvalidDlg"/>
      <DialogRef Id="LicenseAgreementDlg"/>
      <DialogRef Id="AllowClosedSourceDlg"/>
      <DialogRef Id="MaintenanceWelcomeDlg"/>
      <DialogRef Id="MaintenanceTypeDlg"/>
      <DialogRef Id="ResumeDlg"/>
      <!-- Order of dialogs should be
           WelcomeDlg
           License Agreement IF NOT UPGRADE
           Allow open source
           Apikey
           Site
           DDAgentUser
           VerifyReady

           -->
      <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="LicenseAgreementDlg">NOT PREVIOUSFOUND</Publish>

      <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="AllowClosedSourceDlg">PREVIOUSFOUND</Publish>

      <Publish Dialog="LicenseAgreementDlg" Control="Next" Event="NewDialog" Value="AllowClosedSourceDlg">NOT PREVIOUSFOUND</Publish>
      
      <Publish Dialog="AllowClosedSourceDlg" Control="Next" Event="NewDialog" Value="ApiKeyDlg">(NOT WixUI_InstallMode) AND (NOT PREVIOUSFOUND) AND (NOT DATADOGYAMLEXISTS)</Publish>
      <Publish Dialog="AllowClosedSourceDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg">WixUI_InstallMode OR PREVIOUSFOUND OR DATADOGYAMLEXISTS</Publish>

      <Publish Dialog="AllowClosedSourceDlg" Control="Back" Event="NewDialog" Value="LicenseAgreementDlg">(NOT WixUI_InstallMode) AND (NOT PREVIOUSFOUND)</Publish>
      <Publish Dialog="AllowClosedSourceDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg">(NOT WixUI_InstallMode) AND PREVIOUSFOUND</Publish>
      <Publish Dialog="AllowClosedSourceDlg" Control="Back" Event="NewDialog" Value="MaintenanceTypeDlg"> WixUI_InstallMode </Publish>
      

      <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="AllowClosedSourceDlg">(NOT WixUI_InstallMode) AND (PREVIOUSFOUND OR DATADOGYAMLEXISTS)</Publish>
      <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="AllowClosedSourceDlg">WixUI_InstallMode = "Change"</Publish>

      <Publish Dialog="MaintenanceTypeDlg" Control="ChangeButton" Event="NewDialog" Value="AllowClosedSourceDlg">1</Publish>



      <!-- if the dialog is displayed, there is only one back from here, which is the welcome -->
      <Publish Dialog="LicenseAgreementDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg"></Publish>

      <Publish Dialog="ExitDialog" Control="Finish" Event="EndDialog" Value="Return" Order="3">1</Publish>
      <Publish Dialog="SiteDlg" Control="Back" Event="NewDialog" Value="ApiKeyDlg">NOT PREVIOUSFOUND</Publish>

      <!-- if the previous installation or the datadog.yaml file exists, implying the API key and Site are known, go back to the AllowClosedSourceDlg or LicenseAgreementDlg -->
      <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="DDAgentUserDlg">(NOT PREVIOUSFOUND) AND (NOT DATADOGYAMLEXISTS)</Publish>

      <Publish Dialog="MaintenanceWelcomeDlg" Control="Next" Event="NewDialog" Value="MaintenanceTypeDlg">1</Publish>

      <Publish Dialog="MaintenanceTypeDlg" Control="Back" Event="NewDialog" Value="MaintenanceWelcomeDlg">1</Publish>

      <Publish Dialog="MaintenanceTypeDlg" Control="RepairButton" Event="NewDialog" Value="ApiKeyDlg">NOT APIKEY</Publish>
      <Publish Dialog="MaintenanceTypeDlg" Control="RepairButton" Event="NewDialog" Value="SiteDlg">APIKEY AND (NOT SITE)</Publish>
      <Publish Dialog="MaintenanceTypeDlg" Control="RepairButton" Event="NewDialog" Value="VerifyReadyDlg">APIKEY AND SITE</Publish>

      <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="MaintenanceTypeDlg">WixUI_InstallMode = "Repair" OR WixUI_InstallMode = "Remove"</Publish>

      <Publish Dialog="MaintenanceTypeDlg" Control="RemoveButton" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>

      <AdminUISequence>
        <Show Dialog="FatalError" OnExit="error" />
        <Show Dialog="UserExit" OnExit="cancel" />
        <Show Dialog="ExitDialog" OnExit="success" />
        <Show Dialog="MaintenanceWelcomeDlg" After="CostFinalize" />
        <Show Dialog ="ProgressDlg" After="MaintenanceWelcomeDlg" />
      </AdminUISequence>
      <InstallUISequence>
        <Show Dialog="FatalError" OnExit="error" />
        <Show Dialog="UserExit" OnExit="cancel" />
        <Show Dialog="ExitDialog" OnExit="success" />

        <Show Dialog="WelcomeDlg" After="MigrateFeatureStates"><![CDATA[NOT Installed]]></Show>
        <Show Dialog="MaintenanceWelcomeDlg" Before="ProgressDlg" >Installed AND NOT RESUME AND NOT Preselected AND NOT PATCH</Show>

        <!--
        <Show Dialog="ResumeDlg" After="WelcomeDlg"><![CDATA[Installed AND (RESUME OR Preselected)]]></Show>
        -->
        <!--
        <Show Dialog="MaintenanceWelcomeDlg" After="ResumeDlg"><![CDATA[Installed AND NOT RESUME AND NOT Preselected]]></Show>
        <Show Dialog="ProgressDlg" After="MaintenanceWelcomeDlg" />
        -->
      </InstallUISequence>
    </UI>
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT"
                  Value="!(loc.LaunchAgentManager)" />


    <WixVariable Id="WixUILicenseRtf" Value="Resources\assets\LICENSE.rtf" />
    <WixVariable Id="WixUIDialogBmp" Value="Resources\assets\dialog_background.bmp" />
    <WixVariable Id="WixUIBannerBmp" Value="Resources\assets\banner_background.bmp" />

    <!-- Properties must each be on their own line
      NOTE: This property will cause the build time warning
      "warning LGHT1076 : ICE03: String overflow (greater than length permitted in column);"
      This does not affect the final artefact, as it seems to affects only the base string, not the expanded one.
      At runtime this limitation doesn\'t seem to apply.
    -->

    <CustomAction Id='SetFinalizeProperty' Return='check' Property='FinalizeInstall'
        Value='
            UILevel=[UILevel]
            PROJECTLOCATION=[PROJECTLOCATION]
            APPLICATIONDATADIRECTORY=[APPLICATIONDATADIRECTORY]
            DDAGENTUSER_NAME=[DDAGENTUSER_NAME]
            DDAGENTUSER_PASSWORD=[DDAGENTUSER_PASSWORD]
            SYSPROBE_PRESENT=[SYSPROBE_PRESENT]
            NPMFEATURE=[NPMFEATURESTATE]
            CLOSEDSOURCE=[ALLOWCLOSEDSOURCE]
            DDNPM_INSTALLED=[DD_FILTER_INSTALLED]
            ADDLOCAL=[ADDLOCAL]
            APIKEY=[APIKEY]
            TAGS=[TAGS]
            HOSTNAME=[HOSTNAME]
            PROXY_HOST=[PROXY_HOST]
            PROXY_PORT=[PROXY_PORT]
            PROXY_USER=[PROXY_USER]
            PROXY_PASSWORD=[PROXY_PASSWORD]
            LOGS_ENABLED=[LOGS_ENABLED]
            APM_ENABLED=[APM_ENABLED]
            PROCESS_ENABLED=[PROCESS_ENABLED]
            PROCESS_DISCOVERY_ENABLED=[PROCESS_DISCOVERY_ENABLED]
            CMD_PORT=[CMD_PORT]
            SITE=[SITE]
            DD_URL=[DD_URL]
            LOGS_DD_URL=[LOGS_DD_URL]
            PROCESS_DD_URL=[PROCESS_DD_URL]
            TRACE_DD_URL=[TRACE_DD_URL]
            PYVER=[PYVER]
            HOSTNAME_FQDN_ENABLED=[HOSTNAME_FQDN_ENABLED]
            NPM=[NPM]
            EC2_USE_WINDOWS_PREFIX_DETECTION=[EC2_USE_WINDOWS_PREFIX_DETECTION]
            OVERRIDE_INSTALLATION_METHOD=[OVERRIDE_INSTALLATION_METHOD]
            ' HideTarget='yes' />
    <CustomAction Id='FinalizeInstall' BinaryKey='wixcadll' DllEntry='FinalizeInstall' Execute='deferred' Return='check' HideTarget='yes' Impersonate='no'/>
    <CustomAction Id='StopDDServices' BinaryKey='wixcadll' DllEntry='PreStopServices' Execute='deferred' Return='check' Impersonate='no'/>
    <CustomAction Id='StartDDServices' BinaryKey='wixcadll' DllEntry='PostStartServices' Execute='deferred' Return='ignore' Impersonate='no'/>
    <CustomAction Id='DoUninstall' BinaryKey='wixcadll' DllEntry='DoUninstall' Execute='deferred' Return='check' Impersonate='no'/>
    <CustomAction Id='DoRollback' BinaryKey='wixcadll' DllEntry='DoRollback' Execute='rollback' Impersonate='no' />

    <CustomAction Id='ValidateDDAgentUserDlgInput' BinaryKey='wixcadll' DllEntry='ValidateDDAgentUserDlgInput' Execute='immediate' Return='check' />

    <!--
    <CustomAction Id='adddduser' BinaryKey='wixcadll' DllEntry='CreateOrUpdateDDUser' Execute='immediate' Return='check'/>
    <CustomAction Id='adjustrights' BinaryKey='wixcadll' DllEntry='AdjustDDRights' Execute='immediate' Return='check'/>
    <CustomAction Id='deldduser' BinaryKey='wixcadll' DllEntry='RemoveDDUser' Execute='immediate' Return='check'/>
    <CustomAction Id='verifyregperms' BinaryKey='wixcadll' DllEntry='VerifyDatadogRegistryPerms' Execute='immediate' Return='check'/>
    <CustomAction Id='InstallationRollback' BinaryKey='wixcadll' DllEntry='RollbackInstallation' Execute='rollback' />
    -->
    <!-- the following custom action is a testing custom action.  Set WIXFAILWHENDEFERRED=1 on the command line, and it will FirstFailureActionType
         the install at the end, to allow for testing of rollback -->
    <CustomActionRef Id="WixFailWhenDeferred" />

    <Binary Id='wixcadll' SourceFile='$(var.BinFiles)\customaction.dll'/>

    <Binary Id="BannerBmp" SourceFile="Resources\assets\banner_background.bmp" />
    <Binary Id="BackgroundBmp" SourceFile="Resources\assets\dialog_background.bmp" />
    <Binary Id="PrepBackgroundBmp" SourceFile="Resources\assets\dialog_background.bmp" />

    <Property Id="ShortCompanyName" Value="!(loc.CompanyNameShort)" />

  </Product>
</Wix>
<!-- check
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\ddnpm

-->
