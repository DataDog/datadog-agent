<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" 
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
  <!-- This is how we include wxi files -->
  <?include "parameters.wxi" ?>

  <!--
    Id="*" is to enable upgrading. * means that the product ID will be autogenerated on each build.
    Name is made of localized product name and version number.
  -->
  <Product Id="*"
           Name="Datadog Agent"
           Language="1033"
           Version="$(var.VersionNumber)"
           Manufacturer="!(loc.ManufacturerName)"
           UpgradeCode="$(var.UpgradeCode)"
           Codepage="1252">

    <!--
      Define the minimum supported installer version (2.0).
      The install should be done for the whole machine not just the current user
    -->
    <Package Id="*"
             Keywords="Installer"
             Comments="Copyright 2015 Datadog, Inc."
             Description="Datadog Agent v$(var.DisplayVersionNumber)"
             Manufacturer="!(loc.ManufacturerName)"
             InstallScope="perMachine"
             InstallerVersion="400"
             Languages="1033"
             InstallPrivileges="elevated"
             Compressed="yes" />

    <!-- This removes entirely the previous version -->
    <Upgrade Id="$(var.UpgradeCode)">
        <UpgradeVersion OnlyDetect='no'
                        Property='PREVIOUSFOUND'
                        Minimum='1.0.0' IncludeMinimum='yes'
                        Maximum="99.99.99.99" IncludeMaximum='no'/>
    </Upgrade>
    <!-- This removes entirely the previous version -->
    <Upgrade Id="$(var.PerUserUpgradeCode)">
        <UpgradeVersion OnlyDetect='no'
                        Property='PREVIOUSFOUND'
                        Minimum='1.0.0' IncludeMinimum='yes'
                        Maximum="99.99.99.99" IncludeMaximum='no'/>
    </Upgrade>

    <!-- Close application when uninstalling -->
    <util:CloseApplication Id="CloseTrayApp" 
                          CloseMessage="yes" 
                          Target="agent-manager.exe" 
                          ElevatedCloseMessage="yes"
                          TerminateProcess="1"
                          Timeout="1"
                          RebootPrompt="no"/>

    <!-- No need to restart Windows after the installation -->
    <Property Id="MSIRESTARTMANAGERCONTROL" Value="Disable" />

        <!-- This allows downgrades, and same-version reinstalls.  Otherwise,
      same version gets installed "side by side" -->

    <MajorUpgrade
      AllowDowngrades="yes"
     />

    <Media Id="1" Cabinet="agent.cab" EmbedCab="yes" />

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="APPLICATIONROOTDIRECTORY" Name="Datadog">
          <Directory Id="PROJECTLOCATION" Name="Datadog Agent"/>
        </Directory>
      </Directory>
      <Directory Id="CommonAppDataFolder" SourceName="CommonAppData">
        <Directory Id="APPLICATIONDATADIRECTORY" Name="Datadog"/>
      </Directory>
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="Datadog"/>
      </Directory>
    </Directory>

    <CustomAction
        Id="LaunchApp"
        Directory="DIST"
        Execute="immediate"
        Return="check"
        ExeCommand="[SystemFolder]cmd.exe /C start agent-manager.exe" />

    <Binary Id="UpgradeHelper" SourceFile="$(var.HelperDir)\upgrade-helper.exe" />
    <CustomAction
        Id="CheckForOldVersion"
        BinaryKey="UpgradeHelper"
        ExeCommand="-oldcode={$(var.PerUserUpgradeCode)} -newcode={$(var.UpgradeCode)} -checkonly=true"
        Execute="deferred"
        Return="check"
        Impersonate="no" />

    <!-- Delete application when uninstalling -->
    <!--
      RemoveFolderEx requires that we "remember" the path for uninstall.
      Read the path value and set the PROJECTLOCATION property with the value.
    -->
    <Property Id="PROJECTLOCATION">
      <RegistrySearch Key="SOFTWARE\Datadog\Datadog Agent"
                      Root="HKLM"
                      Type="raw"
                      Id="APPLICATIONROOTDIRECTORY_REGSEARCH"
                      Name="InstallPath" />
    </Property>

    <DirectoryRef Id="PROJECTLOCATION">
      <Component Id="CleanupMainApplicationFolder" Guid="096249cf-3fe7-4342-a80f-77101ceed5fe">
        <!-- We need to use APPLICATIONROOTDIRECTORY variable here or RemoveFolderEx
             will not remove on "uninstall". -->
        <RegistryValue Root="HKLM"
                       Key="SOFTWARE\Datadog\Datadog Agent"
                       Name="InstallPath"
                       Type="string"
                       Value="[PROJECTLOCATION]"/>
        <util:RemoveFolderEx On="uninstall" Property="PROJECTLOCATION"/>
      </Component>
      <!-- Register variables that will be used by the agent at startup -->
      <Component Id="RegisterConfVariables" Guid="e2423815-704d-4f29-af3b-9baf23ef03d6">
        <RegistryKey Root="HKLM"
                     Key="SOFTWARE\Datadog\Datadog Agent">
          <RegistryValue Name="api_key"
                         Type="string"
                         Value="[APIKEY]"/>
          <RegistryValue Name="tags"
                         Type="string"
                         Value="[TAGS]" />
          <RegistryValue Name="hostname"
                         Type="string"
                         Value="[HOSTNAME]" />
        </RegistryKey>
        
      </Component>
    </DirectoryRef>

    <!-- Let's ship our dist folder with the service and gui executables -->
    <DirectoryRef Id="PROJECTLOCATION">
      <!-- put the agent in the embedded folder so that it can find the python DLLS -->
      <Directory Id="DIST" Name="embedded">
        <!-- Windows service declaration for Datadog Agent -->
        <Component Id="DATADOGAGENTSERVICE" Guid="BCFAD885-5C69-49D3-99CB-494D14E87AAE">
          <File Id="agent.exe"
                Name="agent.exe"
                Vital="yes"
                KeyPath="yes"
                DiskId="1"
                Source="$(var.BinFiles)/agent.exe"/>
          <ServiceInstall Id="DatadogServiceInstaller"
                          DisplayName="Datadog Agent"
                          Description="Send metrics to Datadog"
                          Name="DatadogAgent"
                          ErrorControl="ignore"
                          Start="auto"
                          Type="ownProcess"
                          Vital="yes"
                          Interactive="no"
                          Account="LocalSystem">
              <ServiceDependency Id="winmgmt" />
          </ServiceInstall>
          <ServiceControl Id="DatadogStartService"
                          Name="DatadogAgent"
                          Start="install"
                          Stop="both"
                          Remove="uninstall"
                          Wait="yes" />
          <RemoveFolder Id="APPLICATIONROOTDIRECTORY" On="uninstall" />
          
        </Component>
      </Directory>
    </DirectoryRef>

    <!-- Datadog Agent specific directory definitions -->
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcut" Guid="05206095-f4a0-4bb7-9ebd-80c7488dd7f9">
        <Shortcut Id="ApplicationStartMenuShortcut"
                  Name="Datadog Agent Manager"
                  Description="Manage your Datadog Agent"
                  Target="[DIST]agent-manager.exe"
                  WorkingDirectory="DIST"/>
        <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall"/>
        <RegistryValue Root="HKCU"
                       Key="Software\Microsoft\Datadog"
                       Name="installed"
                       Type="integer"
                       Value="1"
                       KeyPath="yes"/>
      </Component>
    </DirectoryRef>
    
    <DirectoryRef Id="APPLICATIONDATADIRECTORY">
      <Component Id="datadog.yaml.example"
                 Guid="83461594-01AC-11E2-BE35-37EC6088709B"
                 NeverOverwrite="yes"
                 Permanent="yes">
        <File Id="datadog.yaml.example"
              Name="datadog.yaml.example"
              Source="$(var.EtcFiles)\datadog.yaml.example"/>
      </Component>
      <Component Id="trace_agent.conf"
        Guid="CE6515EE-3103-417E-8810-0B465545EB0B"
        NeverOverwrite="yes"
        Permanent="yes">
        <File Id="trace_agent.conf"
          Name="trace-agent.conf"
          Source="$(var.EtcFiles)\trace-agent.conf"/>
      </Component>

      <Directory Id="checks.d" Name="checks.d">
        <Component Id="checks.d"
                   Guid="92cbe7e0-e72c-42c4-9353-741d94b63495"
                   Location="either">
          <CreateFolder/>
        </Component>
      </Directory>

      <Directory Id="EXAMPLECONFSLOCATION" Name= "conf.d">
        <Component Id="conf.d"
                   Guid="54fcfacb-726b-46e3-a699-ec19258a24be"
                   Permanent="yes"
                   Location="either"
                   NeverOverwrite="yes">
          <CreateFolder/>
        </Component>
      </Directory>

      <Directory Id="logs" Name="logs">
        <Component Id="logs"
                   Guid="e194d05a-6dc7-40be-a626-6a15b43c456b"
                   Permanent="yes"
                   Location="either"
                   NeverOverwrite="yes">
          <CreateFolder/>
        </Component>
      </Directory>
   </DirectoryRef>

    <!-- Set the components defined in our fragment files that will be used for our feature  -->
    <Feature Id="MainApplication" Title="Datadog Agent" Level="1" ConfigurableDirectory="APPLICATIONROOTDIRECTORY">
      <ComponentGroupRef Id="ProjectDir" />
      <ComponentRef Id="datadog.yaml.example" />
      <ComponentRef Id="trace_agent.conf" />
      <ComponentRef Id="logs" />
      <ComponentRef Id="conf.d" />
      <ComponentRef Id="checks.d" />
      <ComponentRef Id="ApplicationShortcut" />
      <ComponentRef Id="DATADOGAGENTSERVICE" />
      <ComponentGroupRef Id="ExtraEXAMPLECONFSLOCATION" />
      <ComponentRef Id="CleanupMainApplicationFolder" />
      <ComponentRef Id="RegisterConfVariables" />
    </Feature>

    <InstallExecuteSequence>
      <Custom Action="WixCloseApplications"
          After="InstallInitialize"><![CDATA[REMOVE="ALL" OR REINSTALL]]></Custom>
      <Custom Action="CheckForOldVersion"
          After="InstallInitialize"><![CDATA[NOT Installed AND NOT REMOVE]]></Custom>
    </InstallExecuteSequence>
    <!-- UI Stuff: 100% Omnibus Generated -->
    <Icon Id="project.ico" SourceFile="Resources\assets\project_16x16.ico"/>
    <Property Id="ARPPRODUCTICON" Value="project.ico" />
    <Property Id="ARPHELPLINK" Value="https://datadoghq.com/" />
    <Property Id="WIXUI_INSTALLDIR" Value="<%= wix_install_dir %>" />

    <UIRef Id="ProjectUI_InstallDir"/>
    <UI Id="ProjectUI_InstallDir">
      <UIRef Id="WixUI_Minimal"/>
      <TextStyle Id="WixUI_Font_Normal_White" FaceName="Tahoma" Size="8" Red="255" Green="255" Blue="255" />
      <TextStyle Id="WixUI_Font_Bigger_White" FaceName="Tahoma" Size="12" Red="255" Green="255" Blue="255" />
      <TextStyle Id="WixUI_Font_Title_White" FaceName="Tahoma" Size="9" Bold="yes" Red="255" Green="255" Blue="255" />
      <Publish Dialog="ExitDialog"
          Control="Finish"
          Event="DoAction"
          Value="LaunchApp">
          WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed
      </Publish>
    </UI>
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT"
                  Value="!(loc.LaunchAgentManager)" />
    

    <WixVariable Id="WixUILicenseRtf" Value="Resources\assets\LICENSE.rtf" />
    <WixVariable Id="WixUIDialogBmp" Value="Resources\assets\dialog_background.bmp" />
    <WixVariable Id="WixUIBannerBmp" Value="Resources\assets\banner_background.bmp" />
  </Product>
</Wix>
