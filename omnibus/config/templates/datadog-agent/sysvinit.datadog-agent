#!/bin/sh

### BEGIN INIT INFO
# Provides: datadog-agent
# Short-Description: Start and stop datadog agent
# Description: Datadog Agent
# Required-Start: $remote_fs
# Required-Stop: $remote_fs
# Should-Start: datadog-process datadog-trace
# Should-Stop: datadog-process datadog-trace
# Default-Start: 2 3 4 5
# Default-Stop: 0 1 6
### END INIT INFO

. /lib/lsb/init-functions

INSTALL_DIR="/opt/datadog-agent"
AGENTPATH="$INSTALL_DIR/bin/agent/agent"
PIDFILE="$INSTALL_DIR/run/agent.pid"
AGENT_ARGS="run -p $PIDFILE"
AGENT_USER="dd-agent"
NAME="datadog-agent"
DESC="Datadog Agent"



if [ ! -x $AGENTPATH ]; then
    echo "$AGENTPATH not found. Exiting."
    exit 0
fi

if [ -r "/etc/default/${NAME}" ]; then
    . "/etc/default/${NAME}"
fi


#
# Function that starts the daemon/service
#
do_start()
{
	# Return
	#   0 if daemon has been started
	#   1 if daemon was already running
	#   2 if daemon could not be started
	start-stop-daemon --start --quiet --pidfile $PIDFILE --exec $AGENTPATH --test > /dev/null \
		|| return 1
	start-stop-daemon --start --background --chuid $AGENT_USER --quiet --pidfile $PIDFILE --exec $AGENTPATH -- \
		$AGENT_ARGS \
		|| return 2
	# Add code here, if necessary, that waits for the process to be ready
	# to handle requests from services started subsequently which depend
	# on this one.  As a last resort, sleep for some time.
}

#
# Function that stops the daemon/service
#
do_stop()
{
	# Return
	#   0 if daemon has been stopped
	#   1 if daemon was already stopped
	#   2 if daemon could not be stopped
	#   other if a failure occurred
	start-stop-daemon --stop --quiet --retry=30 --pidfile $PIDFILE --exec $AGENTPATH
    RETVAL="$?"
    rm -f $PIDFILE
    return $RETVAL
}

# Action to take
case "$1" in
    start)
        if [ "$DATADOG_ENABLED" = "no" ]; then
            echo "Disabled via /etc/default/$NAME. Exiting."
            exit 0
        fi

	    log_daemon_msg "Starting $DESC" "$NAME"
        do_start
        case "$?" in
            1) log_end_msg 0 ;;
            2) log_end_msg 1 ;;
            *)
                # check if the agent is running once per second for 5 seconds
                retries=5
                while [ $retries -gt 1 ]; do
                    start-stop-daemon --start --quiet --pidfile $PIDFILE --exec $AGENTPATH --test
                    if [ "$?" -eq "1" ]; then
                        # We've started up successfully. Exit cleanly
                        log_end_msg 0
                        service datadog-agent-process start
                        service datadog-agent-trace start
                        exit 0
                    else
                        retries=$(($retries - 1))
                        sleep 1
                    fi
                done
                # After 10 tries the agent didn't start. Report an error
                log_end_msg 1

            ;;
	    esac
        ;;

    stop)
        log_daemon_msg "Stopping $DESC" "$NAME"
        do_stop
        case "$?" in
            0|1)
                log_end_msg 0
                service datadog-agent-process stop
                service datadog-agent-trace stop
                ;;
            2) log_end_msg 1 ;;
	    esac
        ;;

    status)
        $AGENTPATH status
        exit $?
        ;;

    restart|force-reload)
        log_daemon_msg "Restarting $DESC" "$NAME"
        do_stop
        case "$?" in
        0|1)
            do_start
            case "$?" in
                0) log_end_msg 0 ;;
                1) log_end_msg 1 ;; # Old process is still running
                *) log_end_msg 1 ;; # Failed to start
            esac
            ;;
        *)
            # Failed to stop
            log_end_msg 1
            ;;
        esac
        ;;

    *)
        N=/etc/init.d/$NAME
        echo "Usage: $N {start|stop|restart|status}"
        exit 1
        ;;
esac

exit $?