description "Datadog Agent"

start on started networking
stop on runlevel [!2345]

respawn

console none

pre-start script
  lines=$(sed -n '$=' <%= log_dir %>/agent.stderr.log)
  if test $lines -ge 100; then
   mv <%= log_dir %>/agent.stderr.log <%= log_dir %>/agent.stderr.log.1;
  end
end script

script
  # setuid is not available in versions of upstart before 1.4. CentOS/RHEL6 use an earlier version of upstart.
  # This is the best way to set the user in the absence of setuid.
  exec su -s /bin/sh -c 'exec "$0" "$@"' dd-agent -- <%= install_dir %>/bin/agent/agent start -p <%= install_dir %>/run/agent.pid 2>> <%= log_dir %>/agent.stderr.log
end script

post-stop script
 rm -f <%= install_dir %>/run/agent.pid
 rm -f /tmp/agent.sock
end script
