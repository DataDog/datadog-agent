ARG AGENT_DOCKER_REPO=datadog/agent
ARG AGENT_VERSION=7.72.2
ARG UBUNTU_VERSION=24.04
ARG AGENT_DOCKER_TAG=${AGENT_VERSION}-full
ARG AGENT_GIT_REF=${AGENT_VERSION}
ARG BASE_IMAGE_REGISTRY=docker.io

# Use the Ubuntu Slim AMD64 base image
FROM ${BASE_IMAGE_REGISTRY}/ubuntu:$UBUNTU_VERSION AS builder

# Set environment variables
ARG AGENT_VERSION
ARG AGENT_GIT_REF
ARG CI
ARG DDA_VERSION=v0.29.0
ARG PACKAGE_TYPE
ENV DEBIAN_FRONTEND=noninteractive

# Set the working directory
WORKDIR /workspace

# Update and install necessary packages
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    curl \
    ca-certificates \
    software-properties-common \
    build-essential \
    git \
    rpm \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install Windows cross-compilation tools if building for Windows
RUN if [ "$PACKAGE_TYPE" = "windows" ]; then \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        g++-mingw-w64-x86-64-posix \
        gcc-mingw-w64 \
        binutils-mingw-w64-x86-64 \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* \
    && update-alternatives --set x86_64-w64-mingw32-g++ /usr/bin/x86_64-w64-mingw32-g++-posix \
    && update-alternatives --set x86_64-w64-mingw32-gcc /usr/bin/x86_64-w64-mingw32-gcc-posix; \
    fi

# We can't get tarballs for dev branches, so we can't just pull the tarball from github.
# Instead we make a treeless clone at the reference provided, and build from the repo.
# We also have to use the repo clone because some invoke tasks rely on git coommands unavailable
# in repo tarball archives. For the same reason a shallow clone will also not work.
RUN git clone --branch ${AGENT_GIT_REF} --filter=tree:0 https://github.com/DataDog/datadog-agent.git datadog-agent

# Set the working directory to the source code
WORKDIR /workspace/datadog-agent

# Install Go based on architecture
RUN GO_VERSION=$(cat .go-version) && \
    ARCH=$(dpkg --print-architecture) && \
    if [ "$ARCH" = "amd64" ]; then \
    GO_ARCH="linux-amd64"; \
    elif [ "$ARCH" = "arm64" ]; then \
    GO_ARCH="linux-arm64"; \
    else \
    echo "Unsupported architecture: $ARCH" && exit 1; \
    fi && \
    curl -fsSLO --retry 4 https://golang.org/dl/go${GO_VERSION}.$GO_ARCH.tar.gz && \
    tar -C /usr/local -xzf go${GO_VERSION}.$GO_ARCH.tar.gz && \
    rm go${GO_VERSION}.$GO_ARCH.tar.gz

# Set up Go environment
ENV PATH="/usr/local/go/bin:${PATH}"
RUN mkdir /go
ENV GOPATH=/go

# Verify installations
RUN go version && \
    curl --version

ENV DDA_INTERACTIVE=false
# Install prebuilt dda and sync tasks
RUN ARCH=$(dpkg --print-architecture) && \
    DDA_VERSION=${DDA_VERSION} && \
    if [ "$ARCH" = "amd64" ]; then DDA_ARCH="x86_64"; \
    elif [ "$ARCH" = "arm64" ]; then DDA_ARCH="aarch64"; fi && \
    curl -fsSL --retry 4 "https://github.com/DataDog/datadog-agent-dev/releases/download/${DDA_VERSION}/dda-${DDA_ARCH}-unknown-linux-gnu.tar.gz" \
    | tar -xzf - -C /usr/local/bin && \
    chmod +x /usr/local/bin/dda && \
    dda self dep sync -f legacy-tasks


# Copy the manifest file
COPY manifest.yaml /workspace/datadog-agent/comp/otelcol/collector-contrib/impl/manifest.yaml

# Generate the files and clean up go cache to free space
RUN dda inv collector.generate && \
    go clean -cache -modcache

# Build the OTel agent with cleanup
RUN if [ "$PACKAGE_TYPE" = "windows" ]; then \
    GOOS=windows GOARCH=amd64 CGO_ENABLED=1 CXX=x86_64-w64-mingw32-g++ CC=x86_64-w64-mingw32-gcc dda inv otel-agent.build --byoc && \
    go clean -cache; \
    else \
    dda inv otel-agent.build --byoc && \
    go clean -cache; \
    fi

# Install nfpm if package type is specified (not needed for windows)
RUN if [ -n "$PACKAGE_TYPE" ] && [ "$PACKAGE_TYPE" != "windows" ]; then \
    ARCH=$(dpkg --print-architecture) && \
    if [ "$ARCH" = "amd64" ]; then ARCH="x86_64"; fi && \
    curl -fsSL --retry 4 "https://github.com/goreleaser/nfpm/releases/download/v2.43.0/nfpm_2.43.0_linux_${ARCH}.tar.gz" | tar -xzf - -C /usr/local/bin/ && \
    chmod +x /usr/local/bin/nfpm; \
    fi

# Build packages if PACKAGE_TYPE is specified, otherwise just output the binary
RUN <<'RUNSCRIPT'
ARCH=$(dpkg --print-architecture)
mkdir -p /dist
if [ "$PACKAGE_TYPE" = "windows" ]; then
  cp /workspace/datadog-agent/bin/otel-agent/otel-agent.exe /dist/
elif [ -n "$PACKAGE_TYPE" ]; then
  if [ "$PACKAGE_TYPE" != "deb" ] && [ "$PACKAGE_TYPE" != "rpm" ]; then
    echo "PACKAGE_TYPE must be 'deb', 'rpm', or 'windows', got: $PACKAGE_TYPE" >&2
    exit 1
  fi
  cd /workspace/datadog-agent
  cat > nfpm.yaml <<EOF
name: datadog-agent-ddot-byoc
version: "${AGENT_VERSION}"
arch: "${ARCH}"
description: "Datadog Distribution of OpenTelemetry Collector (Custom)"
contents:
  - src: bin/otel-agent/otel-agent
    dst: /opt/datadog-agent/embedded/bin/otel-agent
    file_info:
      mode: 0755
  - src: bin/otel-agent/dist/otel-config.yaml
    dst: /etc/datadog-agent/otel-config.yaml.example
conflicts:
  - datadog-agent-ddot
overrides:
  deb:
    depends:
      - "datadog-agent (= 1:${AGENT_VERSION}-1)"
  rpm:
    depends:
      - "datadog-agent = 1:${AGENT_VERSION}-1"
EOF
  nfpm package --config nfpm.yaml --target /dist --packager "${PACKAGE_TYPE}"
else
  cp /workspace/datadog-agent/bin/otel-agent/otel-agent /dist/
fi
RUNSCRIPT

# Create a stage for extracting the built artifact (binary or packages)
FROM scratch AS artifact
COPY --from=builder /dist/* /ddot-byoc/

# Use the final Datadog agent image
FROM ${AGENT_DOCKER_REPO}:${AGENT_DOCKER_TAG} AS result
# Copy the built OTel agent from the builder stage
COPY --from=builder /workspace/datadog-agent/bin/otel-agent/otel-agent /opt/datadog-agent/embedded/bin/otel-agent
